{% extends 'base.html' %}
{% block title %}Cold Differential Pressure Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cold Differential Pressure Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
       /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            {% comment %} max-width: 700px; {% endcomment %}
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            {% comment %} overflow-y: auto; {% endcomment %}
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }

        .result-details {
            text-align: left;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .result-details p {
            margin: 8px 0;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Cold Differential Pressure Calculator</h1>
            <p>Calculate the cold differential set pressure for pressure relief valve calibration</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                
                <div class="form-group">
                    <label for="risp">Required Installed Set Pressure (RISP) (Pa)</label>
                    <input type="number" id="risp" class="form-input" min="0" placeholder="e.g., 100000">
                </div>
                
                <div class="form-group">
                    <label for="cbp">Constant Backpressure (CBP) (Pa)</label>
                    <input type="number" id="cbp" class="form-input" min="0" placeholder="e.g., 25000">
                </div>
                
                <button class="calculate-btn" onclick="calculateCDSP()">Calculate CDSP</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Cold Differential Set Pressure (CDSP)</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Cold Differential Set Pressure</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Pa</div>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Calculation Details</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    The <strong>Cold Differential Set Pressure (CDSP)</strong> is a critical parameter for setting pressure relief valves correctly before the system reaches full operational conditions. It ensures that safety valves will function properly when needed to prevent over-pressurization incidents.
                </p>
            </div>

            <div class="note-card">
                <h3>‚öôÔ∏è Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>RISP (Required Installed Set Pressure):</strong> The pressure at which the relief valve is designed to open under operating conditions (Pa).</li>
                    <li><strong>CBP (Constant Backpressure):</strong> The pressure exerted on the outlet of the valve from the discharge system (Pa).</li>
                    <li><strong>CDSP (Cold Differential Set Pressure):</strong> The pressure setting required before normal operating conditions (Pa).</li>
                </ul>
            </div>

    

           

            <div class="note-card">
    <h3>‚úÖ Input Validation Rules (CDSP Calculator)</h3>
    <ul class="note-list">
        <li><strong>RISP (Required Installed Set Pressure):</strong> Must be > 0 Pa, typically 10,000 ‚Äì 10,000,000 Pa (0.1‚Äì100 bar).</li>
<li><strong>CBP (Constant Backpressure):</strong> Must be ‚â• 0 Pa and always less than the Required Installed Set Pressure (RISP). To ensure safe valve operation, the backpressure should not be too high ‚Äî it should generally stay below about 70% of RISP. For example, if RISP is 100,000 Pa, CBP should ideally be less than 70,000 Pa. This limit is based on API guidelines to make sure the relief valve can open properly.</li>
        <li><strong>No negative values:</strong> Both RISP and CBP must be non-negative.</li>
        <li><strong>Cross-validation:</strong> RISP must always be greater than CBP.</li>
        <li><strong>Output (CDSP):</strong> Must be > 0 and at least 1000 Pa (0.01 bar) for practical calibration.</li>
    </ul>
    <p><b>Note:</b> These validations are aligned with <b>ASME Boiler and Pressure Vessel Code</b> and <b>API 520/521</b> for pressure relief devices.</p>
</div>


       <div class="note-card">
    <h3>üìä Output Validations</h3>
   <p>If the Cold Differential Set Pressure (CDSP) value is:</p>

    <ul class="note-list">
        <li>Less than 1000 Pa: ‚ö†Ô∏è CDSP is very low . Valve may not provide sufficient hydrostatic pressure for proper operation.</li>
        <li>Between 1000 ‚Äì 500,000 Pa: ‚úÖ CDSP is within normal range. The relief valve can be safely calibrated for proper operation.</li>
        <li>Greater than 500,000 Pa: ‚ö†Ô∏è CDSP is unusually high. Verify input values; ensure calibration is possible at this pressure.</li>
    </ul>
</div>
    

            <div class="note-card">
    <h3>üìè Governance Principle</h3>
    <p>
        A "Cold Differential Pressure Calculator" itself isn't tied to a single standard but is a tool used to apply the principles of Cold Differential Test Pressure (CDTP), a concept defined and standardized by industry bodies such as ASME, API, and ISO for pressure relief valves. These standards provide the methodology for calculating CDTP to ensure relief valves are correctly set for their service conditions, considering factors like back pressure and temperature.
    </p>
    <p>
        <h3>Key Standards and Concepts:</h3>
        <ul class="note-list">
            <li><strong>Cold Differential Test Pressure (CDTP):</strong> This is the core concept. It's the pressure at which a pressure relief valve is adjusted on a test stand using cold fluid, with corrections made for the actual service conditions (like temperature and backpressure) to ensure the valve opens at the correct pressure in its installed service.</li>
            <li><strong>ASME PTC 25:</strong> This standard defines CDTP and provides the basis for correcting set pressure based on service conditions for pressure relief devices.</li>
            <li><strong>API 520/API 20:</strong> These standards also define and provide guidance on the application of CDTP in relief valve testing, specifying the corrections for service conditions.</li>
            <li><strong>ISO 4126-1:</strong> This is an international standard that defines CDTP and related concepts within the context of safety relief valves.</li>
        </ul>
    </p>
    <p>
        <h3>How it Works:</h3><br>
        A "Cold Differential Pressure Calculator" or formula applies the equations and principles from these standards to: 
        <ul class="note-list">
            <li><strong>Determine Cold Set Pressure:</strong> The initial setting of the relief valve in a test facility using cold fluid.</li>
            <li><strong>Apply Corrections:</strong> Account for the difference between the test conditions and the actual service conditions.</li>
            <li><strong>Calculate Cold Differential Set Pressure (CDSP):</strong> This is the ultimate goal of the calculation, which is the pressure the valve should be set to at the bench test to achieve the desired set pressure in service.</li>
        </ul>
    </p>
    <p>
        In essence, the calculator is a practical implementation of the theoretical standards set forth by these organizations.
    </p>
</div>
<div class="note-card">
    <h3>üèÅ Conclusion</h3>
    <p>
        The Cold Differential Pressure Calculator provides a practical way to determine the Cold Differential Set Pressure (CDSP) for pressure relief valves, ensuring accurate valve calibration, operational safety, and compliance with standards such as ASME PTC 25, API 520/521, and ISO 4126-1.
    </p>
</div>

        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        
function calculateCDSP() {
    const risp = document.getElementById('risp').value.trim();
    const cbp = document.getElementById('cbp').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');
    const feedbackContent = document.getElementById('feedbackContent');

    let errors = [];

    // === Validate RISP ===
    if (risp === "") {
        errors.push("üëâ Please enter Required Installed Set Pressure (RISP).");
    } else {
        const rispVal = parseFloat(risp);
        if (isNaN(rispVal)) {
            errors.push("üëâ RISP must be a valid number.");
        } else if (rispVal <= 0) {
            errors.push("üëâ RISP must be greater than 0 Pa.");
        } else if (rispVal < 10000 || rispVal > 10000000) {
            errors.push("üëâ RISP should typically range from 10,000 Pa (0.1 bar) to 10,000,000 Pa (100 bar).");
        }
    }

    // === Validate CBP ===
    if (cbp === "") {
        errors.push("üëâ Please enter Constant Backpressure (CBP).");
    } else {
        const cbpVal = parseFloat(cbp);
        if (isNaN(cbpVal)) {
            errors.push("üëâ CBP must be a valid number.");
        } else if (cbpVal < 0) {
            errors.push("üëâ CBP cannot be negative.");
        }
    }

    // === Cross-validation ===
    if (errors.length === 0) {
        const rispVal = parseFloat(risp);
        const cbpVal = parseFloat(cbp);

        if (rispVal <= cbpVal) {
            errors.push("üëâ RISP must always be greater than CBP.");
        }

        if (cbpVal > 0.7 * rispVal) {
         errors.push("üëâ The Constant Backpressure should not exceed 70% of the Required Installed Set Pressure. Exceeding this may make valve calibration unsafe (API 520 guideline).");
        }
    }

    // === Show errors ===
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // === Perform Calculation ===
    const rispVal = parseFloat(risp);
    const cbpVal = parseFloat(cbp);
    const cdsp = rispVal - cbpVal;

    // === Output validation ===
    if (cdsp <= 0) {
        errorMessage.innerHTML = "‚ùå CDSP result is invalid (‚â§ 0). Check inputs.";
        errorBox.classList.remove("hidden");
        resultValue.classList.add("hidden");
        return;
    }
    if (cdsp < 1000) {
        errorMessage.innerHTML = "‚ö†Ô∏è CDSP is very low (< 1000 Pa). This may not be practical.";
        errorBox.classList.remove("hidden");
        resultValue.classList.add("hidden");
        return;
    }

   // === Display result with interpretation ===
document.getElementById('rateValue').textContent = cdsp.toFixed(2);

let interpretation = "";
if (cdsp < 1000) {
    interpretation = `<p class="bad">‚ö†Ô∏è CDSP is very low . Valve may not provide sufficient hydrostatic pressure for proper operation.</p>`;
} else if (cdsp >= 1000 && cdsp <= 500000) { // typical practical range
    interpretation = `<p class="good">‚úÖ CDSP is within normal range. The relief valve can be safely calibrated for proper operation.</p>`;
} else {
    interpretation = `<p class="average">‚ö†Ô∏è CDSP is unusually high. Verify input values; ensure calibration is possible at this pressure.</p>`;
}

feedbackContent.innerHTML = `
    <p>CDSP = <strong>${cdsp.toFixed(2)} Pa</strong></p>
    <p>This is the pressure setting required for the relief valve before normal operating conditions.</p>
    ${interpretation}
`;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}



{% comment %} 
1. Input Validation Rules (Industrial QEHS Perspective)

For Cold Differential Set Pressure (CDSP) = RISP ‚Äì CBP:

RISP (Required Installed Set Pressure, Pa)

Must be > 0 (safety valves cannot be calibrated at 0).

Practical industrial range: 10,000 Pa (0.1 bar) to 10,000,000 Pa (100 bar) depending on service.

Too small ‚Üí valve won‚Äôt function properly.

Too large ‚Üí safety valves may not exist at those pressures or calibration is outside standard practice.

Max decimals allowed: 2‚Äì3 decimals (Pa precision).

CBP (Constant Backpressure, Pa)

Must be ‚â• 0.

Must always be less than RISP (otherwise valve would never lift).

Typical limit: up to 70% of RISP per API 520/521 guidance.

Allowed decimals: 2‚Äì3 max.

Cross-field rules

RISP > CBP mandatory.

CDSP must always be positive.

2. Output Validation and Thresholds

Formula:

CDSP = RISP ‚Äì CBP


Output must:

Be strictly positive.

Be at least > 1000 Pa (0.01 bar) to ensure meaningful calibration value.

Be within reasonable operating envelope (not > RISP, not negative).

If outside ‚Üí show warning, not just result.

3. Corrected JavaScript Code (with detailed comments)

Here‚Äôs the improved validation logic (you can directly replace your calculateCDSP()):

/*
=========================================================
Cold Differential Set Pressure (CDSP) Formula:
    CDSP = RISP - CBP

Where:
- RISP (Required Installed Set Pressure), Pa
- CBP (Constant Backpressure), Pa

Validation Rules (Based on ASME Boiler & Pressure Vessel Code, API 520/521):
1. RISP must be > 0 Pa, typical industrial range 10,000 ‚Äì 10,000,000 Pa.
2. CBP must be >= 0 Pa and less than RISP.
3. CBP should not exceed 70% of RISP (API recommended limit).
4. Both inputs must be numeric, no negative values, max 3 decimals.
5. CDSP result must be > 0 and at least 1000 Pa (0.01 bar) to be meaningful.
=========================================================
*/ {% endcomment %}