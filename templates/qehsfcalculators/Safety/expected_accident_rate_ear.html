{% extends 'base.html' %}
{% block title %}Expected Accident Rate (EAR) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expected Accident Rate (EAR) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 480px;
            overflow-y:auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        {% comment %} /* Input rows for side-by-side fields */
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        } {% endcomment %}

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .rate-display {
            {% comment %} display: flex; {% endcomment %}
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
       
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Expected Accident Rate (EAR) Calculator</h1>
            <p>Predict post-improvement safety performance by accounting for planned accident reductions relative to traffic exposure</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="input-row">
                    <div class="form-group">
                        <label for="totalAccidents">Total Accidents (B)</label>
                        <input type="number" id="totalAccidents" class="form-input" min="0" step="any" placeholder="Annual accident count">
                    </div>
                    <div class="form-group">
                        <label for="reductionFactor">Reduction Factor (%)</label>
                        <input type="number" id="reductionFactor" class="form-input" min="0" max="99.99" step="any" placeholder="Expected reduction percentage">
                    </div>
                </div>
                <div class="input-row">
                    <div class="form-group">
                        <label for="adt">Average Daily Traffic (ADT)</label>
                        <input type="number" id="adt" class="form-input" min="0" step="any" placeholder="Vehicles per day in 1000s">
                    </div>
                    <div class="form-group">
                        <label for="locations">Number of Locations/Miles (N)</label>
                        <input type="number" id="locations" class="form-input" min="0" step="any" placeholder="Count or mile length">
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateEAR()">Calculate Expected Accident Rate</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                   <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Expected Accident Rate (EAR)</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Expected Accident Rate</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.0000</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">accidents per million vehicle-miles</div>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Accident Reduction Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
<!-- Notes Section -->
<div class="note-section">

  <!-- 📘 About This Calculator -->
  <div class="note-card">
    <h3>📘 About This Calculator</h3>
    <p>
      The <strong>Expected Accident Rate (EAR) Calculator</strong> predicts post-improvement safety performance by accounting for planned accident reductions relative to traffic exposure. 
      It helps transportation engineers and planners evaluate the expected impact of proposed safety measures before implementation. 
      EAR is expressed as the number of accidents per million vehicle-miles, allowing comparison across locations and projects.
    </p>
  </div>

  <!-- ⚙ Parameters Used -->
  <div class="note-card">
    <h3>⚙ Parameters Used</h3>
    <ul class="note-list">
      <li><strong>Total Accidents (B):</strong> Annual count of all reported accidents on the road segment or intersection under analysis.</li>
      <li><strong>Reduction Factor (%):</strong> Expected percentage decrease in accidents due to safety countermeasures or design improvements.</li>
      <li><strong>Average Daily Traffic (ADT):</strong> Number of vehicles passing through a segment daily (in thousands).</li>
      <li><strong>Number of Locations/Miles (N):</strong> Total length of road (miles) or number of intersections analyzed.</li>
    </ul>
  </div>

  <!-- ✅ Input Validation Rules -->
  <div class="note-card">
    <h3>✅ Input Validation Rules</h3>
    <ul class="note-list">
      <li><strong>Total Accidents (B):</strong> Integer between 1 and 1000 (accidents cannot be fractional).</li>
      <li><strong>Reduction Factor (RF):</strong> Between 0 and 99.99%. 100% is not realistic since total elimination is impossible.</li>
      <li><strong>Average Daily Traffic (ADT):</strong> Between 1 and 200 (in thousands of vehicles per day).</li>
      <li><strong>Number of Locations/Miles (N):</strong> Integer between 1 and 500 (segments or sites studied).</li>
      <li><strong>Division by Zero:</strong> ADT and N must be greater than zero.</li>
      <li><strong>Output EAR Typical Range:</strong> 0.1 – 10 accidents per million vehicle-miles. Values outside this range trigger verification warnings.</li>
    </ul>
  </div>

  <!-- 📊 Output Validations -->
  <div class="note-card">
    <h3>📊 Output Validations</h3>
    <ul class="note-list">
      <li><strong>Unit:</strong> Accidents per million vehicle-miles.</li>
      <li><strong>Range Check:</strong> EAR below 0.1 → unrealistically low; above 10 → high-risk area or data error.</li>
    </ul>

    <p><strong>Assessment / Feedback:</strong></p>
    <ul class="note-list">
      <li>⚠️ Very ambitious reduction – ensure realistic expectations (if RF > 70%)</li>
      <li>🔵 Substantial reduction expected – verify with similar projects (if RF > 40%)</li>
      <li>✅ Moderate reduction target – typical for many safety projects (if RF ≤ 40%)</li>
      <li>⚠️ High baseline rate – consider stronger countermeasures (if baseline rate > 5 and RF < 30%)</li>
    </ul>

    <p>
      These same assessment sentences appear alongside the calculated result for clarity and validation consistency.
    </p>
  </div>

  <!-- 📜 Governing Principle -->
  <div class="note-card">
    <h3>📜 Governing Principle</h3>
    <p>
      The "Expected Accident Rate (EAR) Calculator" is not a single, universally defined standard but is more likely a tool or methodology developed under various standards to predict or benchmark accident potential. The specific standards that apply would depend on the industry or application.
    </p>
    <p>Here are some of the international and national standards and bodies that govern the calculation of accident rates:</p>
    <ul class="note-list">
      <li><strong>Occupational Safety and Health Administration (OSHA):</strong> Provides the basis for calculating workplace incident rates, such as the Total Recordable Incident Rate (TRIR), based on 200,000 labor hours.</li>
      <li><strong>Bureau of Labor Statistics (BLS):</strong> Works with OSHA to compile and analyze occupational safety and health data, providing industry benchmarks for comparison.</li>
      <li><strong>Indian Standard (IS) 3786:1983:</strong> Defines methods for computing frequency and severity rates for industrial injuries and accident classifications in India.</li>
      <li><strong>International Civil Aviation Organization (ICAO):</strong> Establishes methodologies for calculating and trending accident rates in aviation using adaptive moving averages.</li>
      <li><strong>World Health Organization (WHO):</strong> Provides global guidance on road safety data collection and analysis influencing many national methods.</li>
      <li><strong>Other Industry-Specific Standards:</strong> Various transportation, manufacturing, and power sectors have unique accident calculation methodologies.</li>
    </ul>

    <p><strong>Determining the Right Standard:</strong></p>
    <ul class="note-list">
      <li>Identify the industry — standards differ between aviation, industrial, and transportation sectors.</li>
      <li>Identify the region — e.g., Indian IS standards differ from U.S. OSHA methods.</li>
      <li>Review documentation — every EAR calculator should reference the underlying standard or manual it follows.</li>
    </ul>

 
  </div>

  <!-- 🏁 Conclusion -->
  <div class="note-card">
    <h3>🏁 Conclusion</h3>
    <ul class="note-list">
      <li>The EAR Calculator quantifies expected safety performance improvements for roads or intersections.</li>
      <li>Helps prioritize interventions, justify funding, and measure progress in accident reduction programs.</li>
      <li>Validation and range checks ensure data reliability and comparability across locations.</li>
      <li>Complies conceptually with FHWA, AASHTO, ISO 45001, and OSHA methodologies for predictive safety performance analysis.</li>
    </ul>
  </div>

</div>


    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateEAR() {
    const totalAccidents = document.getElementById('totalAccidents').value.trim();
    const reductionFactor = document.getElementById('reductionFactor').value.trim();
    const adt = document.getElementById('adt').value.trim();
    const locations = document.getElementById('locations').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];
    let warnings = [];

    // --- Validation Rules ---
    // Total Accidents (B): integer, 1–1000
    if (totalAccidents === "" || isNaN(totalAccidents) || parseInt(totalAccidents) <= 0) {
        errors.push("👉 Total Accidents must be a positive integer (1–1000).");
    } else if (parseInt(totalAccidents) > 1000) {
        warnings.push("⚠️ Total Accidents above 1000 is unusual – verify inputs.");
    }

    // Reduction Factor (RF): 0–99.99
    if (reductionFactor === "" || isNaN(reductionFactor)) {
        errors.push("👉 Reduction Factor is required.");
    } else if (parseFloat(reductionFactor) < 0 || parseFloat(reductionFactor) >= 100) {
        errors.push("👉 Reduction Factor must be between 0 and 99.99%.");
    }

    // Average Daily Traffic (ADT): 1–200
    if (adt === "" || isNaN(adt) || parseFloat(adt) <= 0) {
        errors.push("👉 Average Daily Traffic must be a positive number (1–200, in thousands).");
    } else if (parseFloat(adt) > 200) {
        warnings.push("⚠️ ADT above 200 (200,000 vehicles/day) is unusual – verify inputs.");
    }

    // Locations/Miles (N): integer, 1–500
    if (locations === "" || isNaN(locations) || parseFloat(locations) <= 0) {
        errors.push("👉 Number of Locations/Miles must be a positive integer (1–500).");
    } else if (parseFloat(locations) > 500) {
        warnings.push("⚠️ Locations/Miles above 500 is unusual – verify inputs.");
    }

    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // --- Calculation ---
    const B = parseInt(totalAccidents);
    const RF = parseFloat(reductionFactor);
    const ADT = parseFloat(adt);
    const N = parseInt(locations);

    const reducedAccidents = B * (RF / 100);
    const EAR = (B - reducedAccidents) / (ADT * 0.365 * N);

    if (!isFinite(EAR) || isNaN(EAR)) {
        errorMessage.innerHTML = "👉 Calculation error: check inputs.";
        errorBox.classList.remove("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // --- Output Validation ---
    if (EAR < 0.1 || EAR > 10) {
        warnings.push("⚠️ EAR outside typical range (0.1–10 accidents per million vehicle-miles).");
    }

    document.getElementById('rateValue').textContent = EAR.toFixed(4);

    // Feedback
    let feedback = `Accident Reduction: ${reducedAccidents.toFixed(1)} fewer accidents (${RF}% reduction). `;

    if (RF > 70) {
        feedback += "⚠️ Very ambitious reduction – ensure realistic expectations.";
    } else if (RF > 40) {
        feedback += "🔵 Substantial reduction expected – verify with similar projects.";
    } else {
        feedback += "✅ Moderate reduction target – typical for many safety projects.";
    }

    const baselineRate = B / (ADT * 0.365 * N);
    if (baselineRate > 5 && RF < 30) {
        feedback += " ⚠️ High baseline rate – consider stronger countermeasures.";
    }

    if (warnings.length > 0) {
        feedback += " " + warnings.join(" ");
    }

    document.getElementById('feedbackContent').textContent = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}


        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}

{% comment %} 

1. Formula Used
// EAR Formula:
// EAR = (B - (B * RF/100)) / (ADT * 0.365 * N)
//
// Where:
// B  = Total Accidents (annual count)
// RF = Reduction Factor (%) expected from interventions
// ADT = Average Daily Traffic (in thousands of vehicles/day)
// N  = Number of Locations or Miles analyzed
//
// Output: Accidents per million vehicle-miles

2. Detailed Input Validation Rules

From real-world QEHS, NFPA, OSHA, ISO 45001, and FHWA/AASHTO practices:

Total Accidents (B)

Range: 1 – 1000 (typical annual accident counts for a location or segment)

Decimals: Integer only (accidents cannot be fractional)

Validation: Must be > 0.

Reduction Factor (RF, %)

Range: 0 – 99.99 (cannot be 100% because that implies eliminating all accidents, which is unrealistic)

Decimals: Up to 2 decimal places allowed.

Validation: Logical consistency with B → If B = 1, then RF > 90% is unrealistic.

Average Daily Traffic (ADT)

Range: 1 – 200 (thousand vehicles/day; i.e., 1,000 to 200,000 vehicles/day)

Decimals: Up to 3 decimals allowed for precision.

Validation: Must be > 0.

Number of Locations / Miles (N)

Range: 1 – 500 (segments/miles typically studied)

Decimals: Integer only (either number of sites or integer miles).

Validation: Must be > 0.

3. Output Validation

Normal Range: 0.1 – 10 accidents per million vehicle-miles.

Below 0.1: Unrealistically low → likely input error.

Above 10: Very high risk → flag as requiring review.

Audit Meaning: EAR is compared to FHWA safety performance functions; out-of-range values usually indicate misreported traffic or segment length. {% endcomment %}