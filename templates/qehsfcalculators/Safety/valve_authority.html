{% extends 'base.html' %}
{% block title %}Valve Authority Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valve Authority Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }


        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
            min-height: 420px; /* Match calc-card */
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0 10px;
            overflow: hidden;
        }
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out, background-color 1s ease-in-out;
            border-radius: 6px;
        }
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon { font-size: 76px; flex-shrink: 0; text-align: center; }
        .error-message { font-size: 24px; line-height: 1.6; }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Valve Authority Calculator</h1>
            <p>Determine the effectiveness of a control valve in regulating flow within a system.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Pressure Drop Data</h2>
                <div class="form-group">
                    <label for="dp1">Pressure Drop Across Control Valve (ŒîP‚ÇÅ)</label>
                    <input type="number" id="dp1" class="form-input" placeholder="Enter pressure drop of valve">
                </div>
                <div class="form-group">
                    <label for="dp2">Pressure Drop Across Remaining Circuit (ŒîP‚ÇÇ)</label>
                    <input type="number" id="dp2" class="form-input" placeholder="Enter pressure drop of circuit">
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Engineering illustration">
                    <p>Enter the pressure drop values to calculate the valve authority.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>Valve Authority (N)</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                    </div>
                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Poor Control</span>
                        <span>Optimal</span>
                        <span>Inefficient</span>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Interpretation</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                       <div class="btn-wrapper">
                            <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                        </div>
                </div>
            </div>
        </div>

        <div class="note-section">
        
            <!-- üìò ABOUT THIS CALCULATOR -->
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    The <strong>Valve Authority Calculator</strong> is a key engineering tool used to evaluate how effectively a
                    control valve can regulate
                    flow within a process system. It determines the ratio between the pressure drop across the valve and the
                    total
                    pressure drop in the entire circuit, helping engineers select appropriately sized valves for optimal
                    performance.
                </p>
                <p>
                    A correct valve authority ensures efficient energy use, stable flow regulation, and prevents operational
                    issues such as
                    cavitation or instability.
                </p>
            </div>
        
            <!-- ‚öô PARAMETERS USED -->
            <div class="note-card">
                <h3>‚öô Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Pressure Drop Across Control Valve (ŒîP‚ÇÅ):</strong> Represents the portion of system pressure
                        lost as the fluid passes through the control valve.</li>
                    <li><strong>Pressure Drop Across Remaining Circuit (ŒîP‚ÇÇ):</strong> Indicates pressure loss through all other
                        components in the system (pipes, fittings, exchangers, etc.).</li>
                </ul>
                <p><em>These parameters define how dominant the valve is in controlling total system pressure.</em></p>
            </div>
        
            <!-- ‚úÖ INPUT VALIDATION RULES -->
            <div class="note-card">
                <h3>‚úÖ Input Validation Rules</h3>
                <ul class="note-list">
                    <li><strong>ŒîP‚ÇÅ (Across Valve):</strong> Must be a positive number &gt; 0.</li>
                    <li><strong>ŒîP‚ÇÇ (Across Circuit):</strong> Must be a number ‚â• 0.</li>
                    <li><strong>All Inputs Required:</strong> Missing or invalid values prevent calculation.</li>
                </ul>
                <p><em>Validation ensures realistic values for accurate ISA/IEC-compliant sizing.</em></p>
            </div>
        
            <!-- üìä OUTPUT VALIDATIONS -->
            <div class="note-card">
                <h3>üìä Output Validations</h3>
                <p>The computed valve authority is categorized for quick interpretation:</p>
                <ul class="note-list">
                    <li><strong>Poor Control (Authority &lt; 0.25):</strong> ‚ùå The valve authority is too low ‚Äî consider
                        resizing or modifying circuit resistance.</li>
                    <li><strong>Optimal Control (0.25 ‚â§ Authority ‚â§ 0.5):</strong> ‚úÖ Ideal range ensuring stable and efficient
                        operation.</li>
                    <li><strong>High Authority (Authority &gt; 0.5):</strong> ‚ö†Ô∏è The valve may be oversized ‚Äî may lead to
                        inefficiency or excessive energy usage.</li>
                </ul>
                <p><em>The same assessment text is dynamically displayed beside the result after calculation.</em></p>
            </div>
        
            <!-- üìê GOVERNING PRINCIPLE -->
            <div class="note-card">
                <h3>üìê Governing Principle</h3>
                <p>
                    Valve authority calculations and control valve sizing follow the standards developed by the
                    <strong>International Society of Automation (ISA)</strong> and the
                    <strong>International Electrotechnical Commission (IEC)</strong>, specifically
                    <strong>ISA-75.01.01</strong> and <strong>IEC 60534-2-1</strong>, which have been harmonized.
                    These standards establish the basis for control valve sizing and define the procedures for determining valve
                    authority.
                </p>
        
                <p><strong>Key Standards:</strong></p>
                <ul class="note-list">
                    <li><strong>ISA-75.01.01:</strong> Provides the fundamental sizing equations for control valves handling
                        liquids, gases, and vapors.</li>
                    <li><strong>IEC 60534-2-1:</strong> An international equivalent to ISA-75.01.01, harmonized for global
                        applicability ‚Äî either standard can be used interchangeably.</li>
                </ul>
        
                <p><strong>What These Standards Address:</strong></p>
                <ul class="note-list">
                    <li><strong>Valve Authority:</strong> Defines the ratio of pressure drop across the valve to total system
                        pressure drop at operating conditions.</li>
                    <li><strong>Standardized Equations:</strong> Ensures consistency and comparability across designs and
                        manufacturers.</li>
                    <li><strong>Accurate Sizing:</strong> Prevents operational issues such as cavitation, noise, or wear through
                        proper sizing methodology.</li>
                </ul>
        
                <p><em>In summary, valve authority and control valve sizing operate under the ISA-75.01.01 and IEC 60534-2-1
                        framework.</em></p>
            </div>
        
            <!-- üß© CONCLUSION -->
            <div class="note-card">
                <h3>üß© Conclusion</h3>
                <p>
                    The Valve Authority Calculator ensures compliance with ISA and IEC standards, enabling engineers to
                    evaluate control stability, energy efficiency, and actuator performance accurately. Maintaining
                    an authority between <strong>0.25 and 0.5</strong> achieves a balance between system responsiveness
                    and energy economy. Following standardized sizing principles leads to reliable, long-term system operation
                    and prevents failures related to poor control dynamics.
                </p>
            </div>
        
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('printDate')) {
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            }
        });

        function calculateAndDisplay() {
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');

            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');

            let errors = [];
            function getVal(id, label, opts = {}) {
                const el = document.getElementById(id);
                const raw = el.value?.toString().trim();
                if (!raw) {
                    errors.push(`üëâ ${label} is required.`);
                    return null;
                }
                const num = parseFloat(raw);
                if (isNaN(num)) {
                    errors.push(`üëâ Enter a valid number for ${label}.`);
                    return null;
                }
                if (opts.allowZero) {
                    if (num < 0) {
                         errors.push(`üëâ ${label} cannot be negative.`);
                         return null;
                    }
                } else {
                    if (num <= 0) {
                        errors.push(`üëâ ${label} must be a positive number greater than 0.`);
                        return null;
                    }
                }
                return num;
            }

            const dp1 = getVal('dp1', 'Pressure Drop Across Control Valve');
            const dp2 = getVal('dp2', 'Pressure Drop Across Remaining Circuit', { allowZero: true });

            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }
            
            const valveAuthority = dp1 / (dp1 + dp2);

            placeholder.classList.add('hidden');
            resultValueBox.classList.remove('hidden');

            document.getElementById('rateValue').textContent = valveAuthority.toFixed(3);
            
            const meterFill = document.getElementById('meterFill');
            meterFill.style.width = Math.min(100, valveAuthority * 100) + '%';
            
            let interpretation;
            if (valveAuthority < 0.25) {
                meterFill.style.backgroundColor = '#e74c3c'; // Red
                interpretation = "<span class='bad'><strong>Poor Control:</strong> The valve authority is too low. Consider resizing the valve or re-evaluating system components.</span>";
            } else if (valveAuthority <= 0.5) {
                meterFill.style.backgroundColor = '#2ecc71'; // Green
                interpretation = "<span class='good'><strong>Optimal Control:</strong> The valve authority is within the ideal range for stable and efficient flow regulation.</span>";
            } else {
                meterFill.style.backgroundColor = '#f39c12'; // Yellow
                interpretation = "<span class='average'><strong>High Authority:</strong> The valve has strong control, but this may lead to inefficient energy use. The system may be oversized for the valve.</span>";
            }
            
            document.getElementById('feedbackContent').innerHTML = interpretation;
        }
        
        function printReport() {
            if (document.getElementById('printDate')) {
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            }
            window.print();
        }
    </script>
</body>
</html>
{% endblock %}