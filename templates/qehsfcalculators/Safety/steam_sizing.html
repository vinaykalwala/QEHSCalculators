{% extends 'base.html' %}
{% block title %}Steam Sizing Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam Sizing Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px; /* Fixed Height */
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
            justify-content: center;
            align-items: center;
            min-height: 420px; /* Fixed Height */
            text-align: center;
        }
        
        .input-pair {
            display: flex;
            gap: 15px;
            width: 100%;
        }

        @media (max-width: 500px) {
            .input-pair {
                flex-direction: column;
                gap: 0;
            }
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
            width: 100%;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background:linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }
        
        /* Result Card */
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }
        
        .sub-results {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eaeaea;
        }

        .sub-result-item {
            text-align: center;
        }
        
        .sub-result-value {
            font-size: 20px;
            font-weight: 600;
            color: #34495e;
        }

        .sub-result-label {
            font-size: 14px;
            color: #7f8c8d;
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback & Warnings */
        .result-feedback, .result-warning {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: left;
            margin-top: 15px;
        }
        .result-feedback {
             border-left: 4px solid #3498db;
        }
        .result-warning {
            border-left: 4px solid #f1c40f;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        /* Note Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .info-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
            font-size: 14px;
        }
        .info-table thead {
            background-color: #e3f2fd;
            color: #0d47a1;
            font-weight: 600;
        }
        .info-table th, .info-table td {
            padding: 10px 12px;
            border: 1px solid #bbdefb;
            text-align: left;
        }
        .info-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        /* Error Box */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }

        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">

        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Steam Sizing Calculator</h1>
            <p>Calculate the required orifice area for a steam pressure relief valve according to ASME-approved methods to ensure system safety.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Enter Relief Parameters</h2>
                <div class="input-pair">
                    <div class="form-group">
                        <label for="massFlow">Mass Flow Rate (W) [kg/hr]</label>
                        <input type="number" id="massFlow" class="form-input" placeholder="e.g., 5000">
                    </div>
                    <div class="form-group">
                        <label for="pressure">Relief Pressure (P) [kPa]</label>
                        <input type="number" id="pressure" class="form-input" placeholder="e.g., 1100">
                    </div>
                </div>
                 <div class="input-pair">
                    <div class="form-group">
                        <label for="kd">Discharge Coefficient (Kd)</label>
                        <input type="number" id="kd" class="form-input" placeholder="e.g., 0.975">
                    </div>
                    <div class="form-group">
                        <label for="kn">Napier Correction (Kn)</label>
                        <input type="number" id="kn" class="form-input" value="1.0">
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateSteamSizing()">Calculate Area</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Pressure relief valve icon">
                    <p>Enter your system's relief requirements to calculate the necessary valve orifice area for overpressure protection.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                    
                <div class="result-value hidden" id="resultValue">
                    <div class="rate-value" id="rateValue">0.00</div>
                    <div class="rate-label" id="rateLabel">Required Orifice Area (mm¬≤)</div>
                    
                    <div class="sub-results">
                        <div class="sub-result-item">
                            <div class="sub-result-value" id="areaM2">0</div>
                            <div class="sub-result-label">Area (m¬≤)</div>
                        </div>
                        <div class="sub-result-item">
                            <div class="sub-result-value" id="massFlowDisplay">0 kg/hr</div>
                            <div class="sub-result-label">Mass Flow Rate</div>
                        </div>
                    </div>

                     <div class="result-warning hidden" id="resultWarning">
                        <div class="feedback-title">‚ö†Ô∏è Input Warning</div>
                        <div class="feedback-content" id="warningMessage"></div>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Orifice Size Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>

                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    This calculator determines the required **steam relief area or flow capacity** for industrial systems.
                    Proper sizing prevents overpressure, ensures safe boiler operation, and avoids instability due to
                    oversizing. It is based on ASME-approved formulas for steam service.
                </p>
            </div>
            <div class="note-card">
                <h3>‚öôÔ∏è Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Mass Flow Rate (W):</strong> Relief capacity required (kg/hr)</li>
                    <li><strong>Pressure (P):</strong> Set pressure plus overpressure (kPa)</li>
                    <li><strong>Discharge Coefficient (Kd):</strong> Valve efficiency (0.85‚Äì0.975)</li>
                    <li><strong>Napier Correction (Kn):</strong> Accounts for superheat (1.0 for saturated steam)</li>
                    <li><strong>Constant (51.5):</strong> Derived from gas flow equations to normalize units</li>
                </ul>
            </div>
            <div class="note-card">
        <h3>‚ö†Ô∏è Input Validation Rules</h3>
                <ul class="note-list">
                    <li><strong>Mass Flow Rate (W) [kg/hr]:</strong> Must be a positive number. Typical range: 100 ‚Äì 100,000 kg/hr.
                    </li>
                    <li><strong>Relief Pressure (P) [kPa]:</strong> Must be a positive number (absolute pressure).</li>
                    <li><strong>Discharge Coefficient (Kd):</strong> Must be between 0 and 1. Typical valves have Kd ‚âà 0.85 ‚Äì 0.97.
                    </li>
                    <li><strong>Napier Correction (Kn):</strong> Must be positive. Typical range: 0.9 ‚Äì 1.1 (1.0 for saturated
                        steam).</li>
                    <li>Empty fields, negative numbers, or non-numeric values will trigger an error message and prevent calculation.
                    </li>
                </ul>
            </div>
            
          <div class="note-card">
   <h3>üìä Output Validations</h3>
<p>If calculated orifice area is for reference, see the ranges below:</p>
<ul class="note-list">
    <li>&lt; 50 mm¬≤: üî¥ Very small orifice. Ensure valve stability at low flows and check manufacturer minimum size limits.</li>
    <li>&gt; 5000 mm¬≤: üü† Large orifice required. Consider using multiple smaller relief valves in parallel.</li>
    <li>50 ‚Äì 5000 mm¬≤: ‚úÖ Orifice size is standard. Choose the next largest standard valve size available from manufacturer charts.</li>
    <li>Invalid number (NaN or infinite): ‚ùå Calculation resulted in an invalid number. Please check your inputs.</li>
</ul>

    <h3>üí° Tips & Recommendations</h3>
    <ul class="note-list">
        <li>Check valve manufacturer datasheets to match the calculated orifice area to standard sizes.</li>
        <li>Use the warning messages to verify unusual discharge coefficient (Kd) or compressibility factor (Z) values.</li>
        <li>Always confirm that the selected valve can handle your system‚Äôs mass flow and pressure conditions.</li>
        <li>Follow safety standards (OSHA, NFPA, ISO) when designing relief systems.</li>
    </ul>
</div>


            <div class="note-card">
    <h3>üìè Governing Principle</h3>
    <p>Steam sizing calculations do not follow a single universal standard. Different components and applications adhere to specific standards depending on the purpose and type of steam system.</p>

    <h3> Common Standards and References</h3>
    <ul class="note-list">
        <li><strong>Valve Sizing:</strong> British Standard BS EN 60534-2-1 and IEC 60534-2-1 are used for sizing valves, especially for saturated steam.</li>
        <li><strong>Safety Valve Sizing:</strong> EN ISO 4126 is applied for overpressure relief valve calculations.</li>
        <li><strong>Steam Pipe Sizing:</strong> Methods like the velocity method or pressure drop method are commonly used. Pipe dimensions are often defined according to the EN pipe grade system, e.g., DIN 2448.</li>
    </ul>

    <h3>Why Multiple Standards Exist</h3>
    <ul class="note-list">
        <li><strong>Different Applications:</strong> Valve, pipe, and safety valve sizing requirements differ, necessitating multiple standards.</li>
        <li><strong>Steam Types:</strong> Dry saturated steam and superheated steam have different densities and flow properties, affecting sizing.</li>
        <li><strong>Methodology:</strong> Calculations may follow the velocity method or pressure drop method, aligned with the appropriate standard.</li>
    </ul>
</div>

            <div class="note-card">
  <h3>‚úÖ Conclusion</h3>
                  <p>
                    Accurate steam relief sizing is essential for industrial safety. This calculator helps ensure valves
                    function correctly under overpressure conditions, preventing catastrophic failures while optimizing system
                    design.
                </p>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateSteamSizing() {
            // --- Get input values ---
            const W_val = document.getElementById('massFlow').value.trim();
            const P_val = document.getElementById('pressure').value.trim();
            const Kd_val = document.getElementById('kd').value.trim();
            const Kn_val = document.getElementById('kn').value.trim();

            // --- Get UI elements ---
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const warningBox = document.getElementById('resultWarning');
            const warningMessage = document.getElementById('warningMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValue = document.getElementById('resultValue');
            const feedbackContent = document.getElementById('feedbackContent');

            let errors = [];
            let warnings = [];

            // --- Parse input values ---
            const W = parseFloat(W_val);
            const P = parseFloat(P_val);
            const Kd = parseFloat(Kd_val);
            const Kn = parseFloat(Kn_val);

            // --- Input Validations ---
            if (W_val === '' || isNaN(W) || W <= 0) errors.push("üëâ Mass Flow Rate must be a positive number (typical 100‚Äì100,000 kg/hr).");
            if (P_val === '' || isNaN(P) || P <= 0) errors.push("üëâ Relief Pressure must be a positive number (kPa).");
            if (Kd_val === '' || isNaN(Kd) || Kd <= 0 || Kd > 1) errors.push("üëâ Discharge Coefficient (Kd) must be between 0 and 1 (typical 0.85‚Äì0.97).");
            if (Kn_val === '' || isNaN(Kn) || Kn <= 0) errors.push("üëâ Napier Correction (Kn) must be a positive number (typical 0.9‚Äì1.1).");

            // --- Error Handling ---
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValue.classList.add("hidden");
                warningBox.classList.add("hidden");
                return;
            } else {
                errorBox.classList.add("hidden");
            }

            // --- Warnings (non-critical but informative) ---
            if (Kd < 0.85) warnings.push("‚ö†Ô∏è Discharge Coefficient (Kd) is unusually low. Verify valve specifications.");
            if (Kn < 0.9 || Kn > 1.1) warnings.push("‚ö†Ô∏è Napier Correction (Kn) is outside typical range 0.9‚Äì1.1. Confirm steam condition.");

            if (warnings.length > 0) {
                warningMessage.innerHTML = warnings.join("<br>");
                warningBox.classList.remove("hidden");
            } else {
                warningBox.classList.add("hidden");
            }

            // --- Calculation ---
            const areaM2 = W / (51.5 * P * Kd * Kn);
            const areaMM2 = areaM2 * 1e6;

            if (!isFinite(areaMM2) || areaMM2 <= 0) {
                errorMessage.innerHTML = "‚ùå Calculation resulted in an invalid number. Please check your inputs.";
                errorBox.classList.remove("hidden");
                resultValue.classList.add("hidden");
                return;
            }

            // --- Display Results ---
            document.getElementById('rateValue').textContent = areaMM2.toFixed(2);
            document.getElementById('areaM2').textContent = areaM2.toExponential(4) + ' m¬≤';
            document.getElementById('massFlowDisplay').textContent = W.toLocaleString() + ' kg/hr';

            // --- Orifice Assessment ---
            let feedback;
            if (areaMM2 < 50) {
                feedback = 'üî¥ Very small orifice. Ensure valve stability at low flows and check manufacturer minimum size limits.';
            } else if (areaMM2 > 5000) {
                feedback = 'üü† Large orifice required. Consider using multiple smaller relief valves in parallel.';
            } else {
                feedback = '‚úÖ Orifice size is standard. Choose next largest standard valve size available from manufacturer charts.';
            }
            feedbackContent.textContent = feedback;

            placeholder.classList.add("hidden");
            resultValue.classList.remove("hidden");
        }

        // --- Print report ---
        function printReport() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            window.print();
        }
    </script>

    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}

<!-- 
1Ô∏è‚É£ Input Validation Rules (QEHS & Safety Perspective)
Input	Units	Acceptable Range	Validation Rationale	Notes / Edge Cases
Mass Flow Rate (W)	kg/hr	> 0, typical 100‚Äì100,000	Steam mass flow must be positive. Extremely low flows (<10 kg/hr) may indicate instrumentation errors or impractical relief sizing.	Reject zero, negative, NaN, or unrealistic extreme values (>1,000,000)
Relief Pressure (P)	kPa (absolute)	> 0, typical 100‚Äì3000 kPa	Pressure must be positive. Low pressure (<50 kPa) may not be feasible, high pressure (>5000 kPa) could exceed design limits.	Prevent division by zero or negative values
Discharge Coefficient (Kd)	dimensionless	0 < Kd ‚â§ 1 (recommended 0.85‚Äì0.97)	Represents valve efficiency. Kd >1 invalid. Kd ‚â§0 impossible physically.	Warn for unusual values outside typical range
Napier Correction (Kn)	dimensionless	0.9 ‚â§ Kn ‚â§ 1.1 (1.0 typical for saturated steam)	Accounts for compressibility. Values outside range indicate wrong fluid state or calculation error	Warn if outside range

Edge Case Validations:

Mass flow = 0 ‚Üí division by zero / invalid area

Pressure = 0 ‚Üí division by zero

Kd ‚â§0 or >1 ‚Üí non-physical coefficient

Kn <0.9 or >1.1 ‚Üí unrealistic steam conditions

Extremely high flows ‚Üí may require multiple relief valves

2Ô∏è‚É£ Output Validation Logic & Thresholds
Output	Thresholds / Logic	QEHS Interpretation
Orifice Area (A)	<50 mm¬≤ ‚Üí small orifice warning	Practically too small; risk of high velocity / choked flow. May require minimum recommended size.
50‚Äì5000 mm¬≤ ‚Üí standard	Manufacturer chart validation recommended	Typical operational sizing; acceptable for single valve installation
>5000 mm¬≤ ‚Üí large orifice warning	Consider multiple valves; ensures safety margin	Avoid oversized single valve causing turbulence / installation issues
Feedback messages	‚úÖ Standard, ‚ö†Ô∏è Warning	Provides operator with actionable insight aligned with regulatory requirements
-->