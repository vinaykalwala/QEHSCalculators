{% extends 'base.html' %}
{% block title %}Safety Risk Assessment Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Risk Assessment Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: transform 0.3s ease;
            height: 420px; /* Fixed Height */
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
            justify-content: center;
            align-items: center;
            min-height: 420px; /* Fixed Height */
            text-align: center;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background:linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }
        
        /* Result Card */
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }
        
        .sub-results {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eaeaea;
        }

        .sub-result-item {
            text-align: center;
        }
        
        .sub-result-value {
            font-size: 20px;
            font-weight: 600;
            color: #34495e;
        }

        .sub-result-label {
            font-size: 14px;
            color: #7f8c8d;
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        /* Note Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }

        /* Error Box */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }

        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">

        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Safety Risk Assessment Calculator</h1>
            <p>Quantify and prioritize safety risks by calculating the monetary risk based on the probability and consequence of an incident.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Enter Risk Parameters</h2>
                <div class="form-group">
                    <label for="probability">Probability of Incident (0.0 to 1.0)</label>
                    <input type="number" id="probability" class="form-input" placeholder="e.g., 0.05 for a 5% chance">
                </div>
                <div class="form-group">
                    <label for="consequence">Consequence Severity ($)</label>
                    <input type="number" id="consequence" class="form-input" placeholder="e.g., 50000">
                </div>
                <button class="calculate-btn" onclick="calculateRisk()">Calculate Risk</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Risk assessment icon">
                    <p>Enter the probability and potential cost of an incident to calculate the quantifiable financial risk.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                    
                <div class="result-value hidden" id="resultValue">
                    <div class="rate-value" id="rateValue">$0.00</div>
                    <div class="rate-label" id="rateLabel">Calculated Monetary Risk</div>
                    
                    <div class="sub-results">
                        <div class="sub-result-item">
                            <div class="sub-result-value" id="probabilityDisplay">0.0</div>
                            <div class="sub-result-label">Probability</div>
                        </div>
                        <div class="sub-result-item">
                            <div class="sub-result-value" id="consequenceDisplay">$0</div>
                            <div class="sub-result-label">Consequence</div>
                        </div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low</span><span>Moderate</span><span>High</span><span>Extreme</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Risk Level Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>📘 About This Calculator</h3>
                <p>
                    <strong>ISO 2002 Risk Formula</strong> is a key tool in safety management for quantifying potential losses
                    by considering both the likelihood and impact of adverse events. It helps organizations prioritize risks,
                    allocate resources effectively, and align with international best practices for proactive risk mitigation.
                </p>
            </div>
            <div class="note-card">
                <h3>⚙️ Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Probability (p):</strong> Likelihood of an accident occurring (0 = impossible, 1 = certain)</li>
                    <li><strong>Consequence (C):</strong> Severity of impact if the accident occurs, measured in monetary terms,
                        injuries, or other quantifiable units</li>
                </ul>
            </div>
            <div class="note-card">
                <h3>📝 Input Validation Rules</h3>
                <ul class="note-list">
                    <li><strong>Probability of Incident:</strong> Must be a <strong>number between 0.0 and 1.0</strong>.
                        Example: 0.05 ✅, 0 ❌, 1.2 ❌, -0.1 ❌</li>
                    <li><strong>Consequence Severity ($):</strong> Must be a <strong>non-negative number</strong>.
                        Example: 5000 ✅, 0 ✅, -1000 ❌</li>
                    <li><strong>General Checks:</strong> All fields must be filled with valid numeric values.</li>
                    <li><strong>Edge Cases:</strong>
                        <ul class="note-list">
                            <li>Probability = 0 or Consequence = 0 → risk is zero, feedback shows <em>No Risk</em>.</li>
                            <li>Non-numeric input → error message.</li>
                            <li>Extremely high consequence → may trigger Extreme Risk feedback.</li>
                        </ul>
                    </li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>📊 Output Validations</h3>
                <ul class="note-list">
                    <li><strong>Calculated Risk:</strong> Computed as <code>Probability × Consequence</code> and displayed in
                        <strong>USD currency format</strong>.
                        Example: Probability 0.05 × Consequence 5000 → $250.00
                    </li>
                    <li><strong>Probability Display:</strong> Shown with three decimal places.
                        Example: 0.050</li>
                    <li><strong>Consequence Display:</strong> Shown as formatted currency.
                        Example: $5000.00</li>
                   
    <strong>Feedback Messages:</strong>
    <ul class="note-list">
        <li>Risk = 0: “ℹ️ No Risk. Because either the probability or the consequence is zero, the calculated risk is zero.”</li>
        <li>Risk < 100: “✅ Low Risk. The calculated financial risk is relatively low. This is generally considered acceptable but should be monitored periodically.”</li>
        <li>Risk 100 – 999: “🟡 Moderate Risk. This level of risk may be acceptable but warrants review of control measures.”</li>
        <li>Risk 1000 – 9999: “⚠️ High Risk. This level of risk is typically not acceptable. Additional risk reduction measures are recommended.”</li>
        <li>Risk ≥ 10000: “🚨 Extreme Risk. This risk level is unacceptable and requires immediate mitigation.”</li>
    </ul>

                    </li>
                    <li><strong>Invalid Calculations:</strong> If risk is <em>not finite</em>, show:
                        ❌ Calculation resulted in an invalid number. Please check your inputs.</li>
                </ul>
            </div>

           <div class="note-card">
    <h3>📘 Governing Principles – Safety Risk Assessment Calculator</h3>
    <p>
        A Safety Risk Assessment Calculator helps evaluate potential hazards in the workplace or specific processes. It is guided by recognized standards and methodologies but is not bound to a single standard.
    </p>
    <ul class="note-list">
        <li>
            <h3>Standards & Frameworks:</h3>
            <ul class="note-list">
                <li><strong>ISO 45001:</strong> Provides guidelines for occupational health and safety management systems; risk calculators assist in meeting assessment requirements.</li>
                <li><strong>IEC 31010:</strong> Offers guidance on risk assessment techniques, such as risk matrices, which can be implemented in calculators.</li>
                <li><strong>ISO 31000:</strong> Establishes principles and guidelines for risk management applicable to all industries.</li>
                <li><strong>IS 15656 (2006):</strong> Indian standard for hazard identification and risk analysis, particularly for process plants.</li>
                <li><strong>Industry-Specific Methodologies:</strong> Examples include PRISM in the UK or other regulatory-specific risk assessment approaches.</li>
            </ul>
        </li>
        <li><br>
            <h3>Key Considerations:</h3>
            <ul class="note-list">
                <li><strong>Purpose of the Calculator:</strong> Define what type of risks are being assessed, e.g., occupational, product safety, or process plant hazards.</li>
                <li><strong>Methodology Used:</strong> Understand the calculation technique, like 5x5 risk matrices, severity-likelihood scoring, or other risk ranking methods.</li>
                <li><strong>Target Audience & Region:</strong> Consider whether the calculator is designed for international standards (ISO) or national/local regulations (IS, PRISM).</li>
            </ul>
        </li>
    </ul>
</div>

            <div class="note-card">
        <h3>✅ Conclusion</h3>
                <p>
                    The ISO 2002 risk formula provides a simple yet powerful quantitative tool to assess potential hazards,
                    prioritize safety risks, and ensure focused allocation of resources for effective risk mitigation,
                    ultimately enhancing workplace safety and reducing financial losses.
                </p>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const now = new Date();
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        });

        function calculateRisk() {
            const prob_val = document.getElementById('probability').value.trim();
            const cons_val = document.getElementById('consequence').value.trim();

            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValue = document.getElementById('resultValue');
            const meterFill = document.getElementById('meterFill');
            const feedbackContent = document.getElementById('feedbackContent');

            let errors = [];

            // --- INPUT VALIDATION ---
            const probability = parseFloat(prob_val);
            if (prob_val === '' || isNaN(probability) || probability < 0 || probability > 1) {
                errors.push("👉 Probability must be a number between 0.0 and 1.0.");
            }

            const consequence = parseFloat(cons_val);
            if (cons_val === '' || isNaN(consequence) || consequence < 0) {
                errors.push("👉 Consequence must be a non-negative number.");
            }

            // --- ERROR HANDLING ---
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValue.classList.add("hidden");
                return;
            } else {
                errorBox.classList.add("hidden");
            }

            // --- CALCULATION ---
            const risk = probability * consequence;

            if (!isFinite(risk)) {
                errorMessage.innerHTML = "❌ Calculation resulted in an invalid number. Please check your inputs.";
                errorBox.classList.remove("hidden");
                resultValue.classList.add("hidden");
                return;
            }

            // --- DISPLAY FORMATTED OUTPUT ---
            const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
            document.getElementById('rateValue').textContent = formatter.format(risk);
            document.getElementById('probabilityDisplay').textContent = probability.toFixed(3);
            document.getElementById('consequenceDisplay').textContent = formatter.format(consequence);

            // --- RISK ASSESSMENT AND FEEDBACK ---
            let meterWidth, meterColor, feedback;

            if (probability === 0 || consequence === 0) {
                meterWidth = '0%';
                meterColor = '#2ecc71'; // Green
                feedback = `ℹ️ <strong>No Risk.</strong> Because either the probability or the consequence is zero, the calculated risk is zero.`;
            } else if (risk < 100) {
                meterWidth = '20%';
                meterColor = '#2ecc71'; // Green
                feedback = `✅ <strong>Low Risk.</strong> The calculated financial risk is relatively low. This is generally considered acceptable but should be monitored periodically.`;
            } else if (risk < 1000) {
                meterWidth = '45%';
                meterColor = '#f1c40f'; // Yellow
                feedback = `🟡 <strong>Moderate Risk.</strong> This level of risk may be acceptable but warrants review of control measures.`;
            } else if (risk < 10000) {
                meterWidth = '70%';
                meterColor = '#e67e22'; // Orange
                feedback = `⚠️ <strong>High Risk.</strong> This level of risk is typically not acceptable. Additional risk reduction measures are recommended.`;
            } else { // >= 10000
                meterWidth = '95%';
                meterColor = '#e74c3c'; // Red
                feedback = `🚨 <strong>Extreme Risk.</strong> This risk level is unacceptable and requires immediate mitigation.`;
            }

            meterFill.style.width = meterWidth;
            meterFill.style.backgroundColor = meterColor;
            feedbackContent.innerHTML = feedback;

            placeholder.classList.add("hidden");
            resultValue.classList.remove("hidden");
        }

        // --- PRINT FUNCTION ---
        function printReport() {
            const now = new Date();
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            window.print();
        }
    </script>

    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}

<!-- 
1️⃣ Input Validation Rules (QEHS Perspective)
Input	Valid Range	Unit	Decimal Allowed	QEHS Justification / Notes
Probability of Incident	0.0 – 1.0	None (fraction)	Up to 2–4 decimals	Represents likelihood. Must be ≤1. Cannot be negative. Probabilities >1 are meaningless in risk calculations.
Consequence Severity	0 – any positive number	$ / ₹ / €	Yes, decimals allowed	Represents potential financial or impact cost. Negative values are non-physical. Extremely high values should be flagged for review.

Additional Validation Rules:

All fields are required. Empty inputs → error.

Ensure numeric type only. Text, symbols → error.

Cross-field check: If either probability or consequence = 0 → risk = 0 → feedback explains this.

Decimal precision: 2 decimal places recommended for output; inputs can allow up to 4 decimals.

Extreme outliers (>1,000,000) may require a warning for unusual data entry.

2️⃣ Edge Case Validations
Edge Case	Handling / Feedback
Probability <0 or >1	Show error: "Probability must be between 0 and 1."
Consequence <0	Show error: "Consequence must be zero or positive."
Probability = 0	Risk = 0 → feedback: "Risk is zero regardless of consequence."
Consequence = 0	Risk = 0 → feedback: "Risk is zero regardless of probability."
Risk > 10,000	Highlight in red → “Extreme Risk: Requires immediate attention.”
Non-numeric input	Show error message and stop calculation.
3️⃣ Output Validation Logic
Output	Thresholds	Color / Feedback	QEHS Explanation
Risk ($)	0 – 100	Low	✅ Green – generally acceptable; monitor periodically.
Risk ($)	100 – 1,000	Moderate	⚠️ Orange – control measures recommended.
Risk ($)	1,000 – 10,000	High	⚠️ Orange – review and implement control promptly.
Risk ($)	>10,000	Extreme	🚨 Red – immediate mitigation required.

Risk = Probability × Consequence.

Feedback is both quantitative (dollar risk) and qualitative (color-coded for severity).

Ensures risk assessment aligns with standard QEHS risk matrix principles.
-->