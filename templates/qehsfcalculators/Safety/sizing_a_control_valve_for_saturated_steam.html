{% extends 'base.html' %}
{% block title %}Sizing A Control Valve For Saturated Steam Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accident Rate Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
     
            @media screen and (max-width: 768px) {
    .calculator-header h1 {
        font-size: 1.5rem; /* smaller font for mobile */
        margin-bottom: 8px;
        text-align: center; /* optional: center the heading on mobile */
    }
}
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: scroll;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 250px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
       
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
          @media (max-width: 768px) {
    .rate-value {
        font-size: 28px; /* smaller font for tablets/mobiles */
    }
}

@media (max-width: 480px) {
    .rate-value {
        font-size: 24px; /* even smaller for phones */
    }
}
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
<div class="calculator-container printable" id="printArea">
    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

    <div class="calculator-header">
        <h1>Sizing A Control Valve For Saturated Steam Calculator</h1>
        <p>
            Estimate the mass flow rate of saturated steam through a control valve based on 
            upstream pressure, downstream pressure, and valve coefficient.
        </p>
    </div>

    <div class="calc-content">
        <!-- Calculator -->
        <div class="calc-card">
            <h2>Enter Data</h2>

            <div class="form-group">
                <label for="kv">Valve Flow Coefficient (K<sub>v</sub>) in cubic meters per hour (m¬≥/h)</label>
                <input type="number" id="kv" class="form-input" min="0" placeholder="e.g., 10">
            </div>

            <div class="form-group">
                <label for="p1">Upstream Absolute Pressure (P<sub>1</sub>) in bar absolute (bar a)</label>
                <input type="number" id="p1" class="form-input" min="0" placeholder="e.g., 12">
            </div>

            <div class="form-group">
                <label for="p2">Downstream Absolute Pressure (P<sub>2</sub>) in bar absolute (bar a)</label>
                <input type="number" id="p2" class="form-input" min="0" placeholder="e.g., 8">
            </div>

            <button class="calculate-btn" onclick="calculateSteamFlow()">Calculate Steam Flow</button>
        </div>

        <!-- Result Section -->
        <div class="result-card">
            <div class="result-placeholder" id="placeholder">
                <img src="{% static 'images/resultimage.png' %}" alt="Steam Valve Illustration">
                <p>
                    This tool will calculate <strong>Steam Mass Flow Rate</strong>. 
                    Enter your data to see results and insights here.
                </p>
            </div>

            <div class="result-error hidden" id="resultError">
                <div class="error-icon">‚ùå</div>
                <div class="error-message" id="errorMessage"></div>
            </div>

            <div class="result-value hidden" id="resultValue">
                <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                    <h2>Steam Flow Result</h2>
                </div>
                <div class="rate-value" id="steamFlowValue">0</div>
                <div class="rate-label" style="color:#2980b9; font-size:16px; font-weight:bold;">
                    Mass Flow Rate (kg/h)
                </div>

                <div class="result-feedback">
                    <div class="feedback-title">Assessment</div>
                    <div class="feedback-content" id="feedbackContent"></div>
                </div>

                <div class="btn-wrapper">
                    <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Section -->
    <div class="note-section">
        <div class="note-card">
            <h3>üìò About This Calculator</h3>
            <p>
                The <strong>Sizing A Control Valve Sizing Calculator for Saturated Steam</strong> 
                estimates the mass flow rate of steam through a valve. 
                It assists engineers in choosing the correct valve size to ensure 
                safe pressure control, efficient energy usage, and compliance 
                with industrial safety standards.
            </p>
        </div>

      <div class="note-card">
    <h3>‚öôÔ∏è Parameters Used</h3>
    <ul class="note-list">
        <li><strong>Valve Flow Coefficient (K<sub>v</sub>):</strong> A measure of the valve‚Äôs capacity to pass fluid. It represents the flow rate in cubic meters per hour (m¬≥/h) of water at 20 ¬∞C that will flow through the valve with a pressure drop of 1 bar.</li>
        
        <li><strong>Upstream Absolute Pressure (P<sub>1</sub>):</strong> The pressure before the valve, expressed in bar absolute (bar a). This value represents the energy available in the steam supply.</li>
        
        <li><strong>Downstream Absolute Pressure (P<sub>2</sub>):</strong> The pressure after the valve, expressed in bar absolute (bar a). It reflects the reduced pressure at the valve outlet and must always be lower than the upstream pressure.</li>
        
<li><strong>Pressure Drop Ratio (x):</strong> 
    A dimensionless factor that represents the relative loss of pressure across the valve. 
    It is calculated as: 
    <br><br>
    <code>x = (P<sub>1</sub> ‚àí P<sub>2</sub>) √∑ P<sub>1</sub></code> 
    <br><br>
    where P<sub>1</sub> is the upstream absolute pressure and P<sub>2</sub> is the downstream absolute pressure. 
    This ratio indicates how much of the available upstream pressure is consumed as the steam expands through the valve.
</li>
        
        <li><strong>Mass Flow Rate of Steam (·πÅ):</strong> The amount of steam flowing through the valve per unit of time, expressed in kilograms per hour (kg/h). This is the key result used to size the valve correctly.</li>
    </ul>
</div>


       <div class="note-card">
    <h3>‚úÖ Input Validation Rules</h3>
    <ul class="note-list">

        <li>
            <strong>Valve Flow Coefficient (K<sub>v</sub>):</strong>  
            <ul>
                <li>Must be numeric and strictly greater than <code>0</code>.</li>
                <li>Recommended minimum: <code>0.1 m¬≥/h</code> (practically measurable flow).</li>
                <li>Reasonable upper limit: <code>0 ‚Äì 10,000 m¬≥/h</code> (typical industrial valves rarely exceed this).</li>
                <li>Allowed decimals: up to 2 places (e.g., <code>15.25</code>).</li>
                <li>Unit of Measure: cubic meters per hour (<code>m¬≥/h</code>).</li>
                <li>Validation Rationale: A zero or negative K<sub>v</sub> is physically impossible and unsafe to use in design; extreme values could indicate a wrong unit or data entry error.</li>
            </ul>
        </li>

        <li>
            <strong>Upstream Absolute Pressure (P<sub>1</sub>):</strong>  
            <ul>
                <li>Must be numeric and strictly greater than <code>0 bar a</code>.</li>
                <li>Practical operating range: <code>1 bar a ‚Äì 100 bar a</code> (steam boilers typically operate between 5 ‚Äì 80 bar a).</li>
                <li>Allowed decimals: up to 2 places (e.g., <code>12.50 bar a</code>).</li>
                <li>Unit of Measure: bar absolute (<code>bar a</code>), not gauge pressure.</li>
                <li>Validation Rationale: Zero or negative absolute pressure is non-physical; pressures above 100 bar a require special design codes (ASME Section I).</li>
            </ul>
        </li>

        <li>
            <strong>Downstream Absolute Pressure (P<sub>2</sub>):</strong>  
            <ul>
                <li>Must be numeric and strictly greater than <code>0 bar a</code>.</li>
                <li>Must always be less than <code>P‚ÇÅ</code> (otherwise, no flow will occur or backflow risk arises).</li>
                <li>Reasonable lower limit: atmospheric pressure (‚âà1 bar a).</li>
                <li>Allowed decimals: up to 2 places.</li>
                <li>Validation Rationale: Ensures a pressure drop exists across the valve. If P‚ÇÇ ‚â• P‚ÇÅ, the valve sizing formula is invalid, and operation could lead to backpressure hazards.</li>
            </ul>
        </li>

        <li>
            <strong>Pressure Drop Ratio (x):</strong>  
            <ul>
                <li>Defined as <code>x = (P‚ÇÅ ‚àí P‚ÇÇ) √∑ P‚ÇÅ</code>.</li>
                <li>Valid range: <code>0 ‚â§ x ‚â§ 0.42</code>.</li>
                <li>If <code>x = 0</code>, there is no flow (P‚ÇÅ = P‚ÇÇ) ‚Üí invalid.</li>
                <li>If <code>x &gt; 0.42</code>, the formula is invalid because the valve would choke (critical flow condition).</li>
                <li>Validation Rationale: Prevents use of the formula outside its defined limits (ISA/IEC 60534 standards for valve sizing).</li>
            </ul>
        </li>

        <li>
            <strong>Cross-Field Validations:</strong>  
            <ul>
                <li>P‚ÇÅ must always be greater than P‚ÇÇ.</li>
                <li>All inputs must be consistent in units (no mixing gauge vs. absolute pressure).</li>
                <li>Unrealistic combinations (e.g., very small Kv with extremely high P‚ÇÅ, or very large Kv with tiny pressure drop) should trigger warnings.</li>
                <li>Validation Rationale: Prevents human error in data entry that could produce misleading results in safety audits.</li>
            </ul>
        </li>

        <li>
            <strong>Missing or Invalid Inputs:</strong>  
            <ul>
                <li>Empty, zero, negative, or non-numeric values are rejected.</li>
                <li>User must be prompted with a clear message showing the correct format and range.</li>
                <li>Validation Rationale: Eliminates calculation errors, ensures reliability of audit-ready KPIs.</li>
            </ul>
        </li>

    </ul>
</div>

       <div class="note-card">
    <h3>üìä Output Validations</h3>
    <ul class="note-list">
        <li><span class="good">Steam Flow &lt; 10,000 kg/h:</span> ‚úÖ Within safe and typical industrial range; aligns with ISA valve sizing and ASME boiler operation standards.</li>
        <li><span class="average">Steam Flow 10,000 ‚Äì 50,000 kg/h:</span> ‚ö†Ô∏è High load; verify valve capacity and pipeline sizing to comply with ISO 4126 and process safety guidelines.</li>
        <li><span class="bad">Steam Flow &gt; 50,000 kg/h:</span> ‚ùå Unusually high; check input values and system design for safety, in line with OSHA, NFPA, and ASME recommendations.</li>
       <li><span class="warn">Critical Mass Flow &gt; 50,000 kg/h:</span> ‚ö†Ô∏è Critical mass flow {ms} kg/h exceeds 50,000 kg/h.</li>
        <li><span class="warn">Extreme Mass Flow &gt; 100,000 kg/h:</span> ‚ö†Ô∏è Mass flow exceeds 100,000 kg/h ‚Äî results may indicate incorrect inputs or special high-capacity systems.</li>
        <li><span class="warn">Pressure Drop Ratio (x) &lt; 0 or &gt; 0.42:</span> ‚ö†Ô∏è The pressure drop ratio is outside the valid range for the formula; verify P1 and P2 values, and consult engineering if needed.</li>
        <li><span class="warn">Extremely small Pressure Drop Ratio (x &lt; 1e-6):</span> ‚ö†Ô∏è Pressure difference between upstream and downstream is very small; calculated flow may be negligible or inaccurate.</li>
    </ul>
</div>



       <div class="note-card">
    <h3>üìã Standards & Compliance</h3>
    <ul class="note-list">
        <li>The calculation logic and thresholds are aligned with ISA standards for control valve sizing in industrial steam systems, ensuring safe and reliable operation.</li>
        <li>Pressure limits and flow validation follow ISO 4126 and ASME Boiler & Pressure Vessel Code requirements to prevent overpressure and maintain structural integrity.</li>
        <li>Audit and reporting guidance ensures compliance with OSHA, ISO 45001, and NFPA standards for process safety, occupational safety, and fire hazard prevention.</li>
    </ul>
</div>


        <div class="note-card">
            <h3>üèÅ Conclusion</h3>
            <p>
                The <strong>Steam Control Valve Sizing Calculator</strong> 
                helps engineers select valves that ensure 
                <strong>safe, efficient, and reliable steam regulation</strong>. 
                By validating input conditions and analyzing realistic flow ranges, 
                it supports better design decisions and prevents operational risks.
            </p>
        </div>
    </div>
</div>

<script>
function calculateSteamFlow() {
    // Read inputs (raw)
    const kvRaw = document.getElementById('kv').value;
    const p1Raw = document.getElementById('p1').value;
    const p2Raw = document.getElementById('p2').value;

    // UI elements
    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');
    const feedbackContent = document.getElementById('feedbackContent');
    const steamFlowValue = document.getElementById('steamFlowValue');

    // Reset UI
    errorBox.classList.add('hidden');
    placeholder.classList.remove('hidden');
    resultValue.classList.add('hidden');
    errorMessage.innerHTML = '';

    // Helper: parse numeric input
    function parseNumeric(str) {
        if (typeof str !== 'string') return NaN;
        const s = str.trim().replace(',', '.'); 
        const numericMatch = s.match(/[-+]?[0-9]*\.?[0-9]+(?:[eE][-+]?\d+)?/);
        return numericMatch ? parseFloat(numericMatch[0]) : NaN;
    }

    const kv = parseNumeric(kvRaw);
    const p1 = parseNumeric(p1Raw);
    const p2 = parseNumeric(p2Raw);

    // Validation constants (engineering policy)
    const KV_MIN = 0.001;
    const KV_MAX = 5000;      
    const P_MIN = 0.001;      
    const P_MAX = 350;        
    const X_MIN = 0.0;
    const X_MAX = 0.42;
    const MS_OVERFLOW_WARN = 100000; 
    const MS_ENGINEERING_WARN = 10000;
    const MS_CRITICAL = 50000;

    let errors = [];
    let warnings = [];

    // --- Mandatory & numeric checks ---
    if (isNaN(kv)) errors.push("Valve Flow Coefficient (Kv) must be a number (m¬≥/h).");
    if (isNaN(p1)) errors.push("Upstream Absolute Pressure (P1) must be a number (bar a).");
    if (isNaN(p2)) errors.push("Downstream Absolute Pressure (P2) must be a number (bar a).");

    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // --- Range checks ---
    if (!(kv >= KV_MIN && kv <= KV_MAX)) {
        errors.push(
            `Valve Flow Coefficient (Kv) must be between ${KV_MIN} and ${KV_MAX} m¬≥/h. ` +
            `If your Kv is outside this range, attach engineering justification.`
        );
    }
    if (!(p1 >= P_MIN && p1 <= P_MAX)) {
        errors.push(
            `Upstream Absolute Pressure (P1) must be between ${P_MIN} and ${P_MAX} bar absolute. ` +
            `Enter absolute pressure (bar a), not gauge pressure.`
        );
    }
    if (!(p2 >= P_MIN && p2 < p1)) {
        errors.push(
            `Downstream Absolute Pressure (P2) must be >= ${P_MIN} bar a and strictly less than Upstream Pressure (P1).`
        );
    }

    // Stop early on range errors
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // --- Cross-field logical checks ---
    if (p1 <= p2) {
        errors.push("Upstream Pressure (P1) must be greater than Downstream Pressure (P2).");
    }

    // Pressure drop ratio
    const x = (p1 - p2) / p1; 
    if (!isFinite(x)) {
        errors.push("Computed pressure drop ratio is not finite. Check P1 value.");
    } else {
        if (x < X_MIN) errors.push(`Pressure Drop Ratio (x) is negative (${x.toFixed(6)}). Must be ‚â• ${X_MIN}.`);
        if (x > X_MAX) errors.push(`Pressure Drop Ratio (x) = ${x.toFixed(6)} exceeds model validity (max ${X_MAX}).`);
        if (x > 0 && x < 1e-6) warnings.push("Pressure drop (P1 - P2) is extremely small ‚Äî flow may be negligible or measurement resolution inadequate.");
    }

    // Stop on errors
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // --- Compute sqrt term ---
    const sqrtTerm = 1 - 5.67 * Math.pow((0.42 - x), 2);
    if (!isFinite(sqrtTerm)) {
        errors.push("Internal calculation error: non-finite intermediate value (sqrtTerm).");
    } else if (sqrtTerm < 0) {
        errors.push(
            `Internal calculation invalid: computed intermediate term is negative (${sqrtTerm.toFixed(6)}). ` +
            "This formula is not valid for the supplied pressure ratio. Reduce pressure drop or consult engineering."
        );
    }

    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // --- Final mass flow calculation ---
    const ms = 12 * kv * p1 * Math.sqrt(sqrtTerm);

    if (!isFinite(ms)) {
        errorMessage.innerHTML = "Calculated mass flow is not finite. Check inputs for numerical issues.";
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // --- Output validity & warnings ---
    let assessmentText = "";
    let assessmentColor = "green";

    if (ms < MS_ENGINEERING_WARN) {
        assessmentText = "‚úÖ Steam Flow : Within safe and typical industrial range; aligns with ISA valve sizing and ASME boiler operation standards.";
        assessmentColor = "green";
    } else if (ms >= MS_ENGINEERING_WARN && ms <= MS_CRITICAL) {
        assessmentText = "‚ö†Ô∏è Steam Flow : High load; verify valve capacity and pipeline sizing to comply with ISO 4126 and process safety guidelines.";
        assessmentColor = "orange";
        warnings.push(`Mass flow ${ms.toFixed(2)} kg/h falls into high range; engineering review recommended.`);
    } else {
        assessmentText = "‚ùå Steam Flow : Unusually high; check input values and system design for safety, in line with OSHA, NFPA, and ASME recommendations.";
        assessmentColor = "red";
        warnings.push(`Critical mass flow ${ms.toFixed(2)} kg/h exceeds ${MS_CRITICAL} kg/h.`);
    }

    if (ms > MS_OVERFLOW_WARN) {
        warnings.push(`Mass flow exceeds ${MS_OVERFLOW_WARN} kg/h ‚Äî results may indicate incorrect inputs or special high-capacity systems.`);
    }

    // --- Display result ---
    steamFlowValue.textContent = ms.toFixed(2);

    // Build feedback content
    let feedbackHTML = `<strong style="color:${assessmentColor}">${assessmentText}</strong><br>`;
    feedbackHTML += `Pressure Drop Ratio x = ${x.toFixed(6)} (valid range 0 to ${X_MAX})<br>`;
    feedbackHTML += `Intermediate term (sqrtTerm) = ${sqrtTerm.toFixed(6)}<br>`;

    if (warnings.length > 0) {
        feedbackHTML += `<div style="margin-top:6px;"><strong>Warnings:</strong><ul>`;
        warnings.forEach(w => feedbackHTML += `<li>${w}</li>`);
        feedbackHTML += `</ul></div>`;
    }

    feedbackContent.innerHTML = feedbackHTML;

    // Show result, hide placeholder & errors
    placeholder.classList.add('hidden');
    errorBox.classList.add('hidden');
    resultValue.classList.remove('hidden');

    // Optional audit log
    // console.info({kv, p1, p2, x, sqrtTerm, ms, warnings});
}
</script>



    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


<!-- 1) High-level QEHS analysis (inputs, outputs, formula ‚Äî safety perspective)

What the tool does (QEHS view):

It estimates mass flow rate of saturated steam (kg/h) through a control valve using valve capacity (K‚Çô), upstream absolute pressure and downstream absolute pressure.

That mass flow result is used to select valve size and verify piping/pressure relief systems; it may influence fire safety (steam used for heating/sterilization), overpressure risk, and emergency isolation decisions.

QEHS concerns to address:

Input integrity: wrong units or typos can produce dangerously misleading results (oversized valve, under/over-pressurized system).

Physical realism: pressures and Kv must be within realistic bounds for saturated steam. Calculation must not produce NaN or imaginary numbers (e.g., because of negative sqrt argument).

Auditability: validations and warnings must be explicit for audit logs and incident investigations.

Safety thresholds: flag flows that indicate possible over-capacity, relief valve mismatch, or unrealistic system conditions (prompt engineering review).

2) Comprehensive validation rules (industry-oriented)

Below are practical rules you should enforce in the UI/validation function. For each field I give: units, allowed decimals, recommended min/max, and cross-field logic.

A ‚Äî Valve Flow Coefficient ‚Äî Valve Flow Coefficient (Kv)

Label (use exactly): Valve Flow Coefficient (Kv) in cubic meters per hour (m¬≥/h)

Type / unit: numeric, m¬≥/h

Allowed decimals: up to 3 decimal places (e.g., 12.345) ‚Äî engineers often use 0.001 resolution for Kv.

Acceptable (recommended) range: 0.001 ‚â§ Kv ‚â§ 5000

Lower bound 0.001 prevents meaningless zero/near-zero valves.

Upper bound 5000 prevents unrealistic industrial Kv values (very large valves). You can extend to 10000 for unusual industrial systems, but require justification.

Why: Kv outside these ranges usually indicates an entry error or a valve size that requires special engineering review.

B ‚Äî Upstream Absolute Pressure ‚Äî Upstream Absolute Pressure (P1)

Label (use exactly): Upstream Absolute Pressure (P1) in bar absolute (bar a)

Type / unit: numeric, bar absolute

Allowed decimals: up to 3 decimals (e.g., 12.345 bar a)

Acceptable (recommended) range: 0.01 ‚â§ P1 ‚â§ 350 bar a

Lower bound 0.01 bar a to avoid dividing by zero and unrealistic vacuum entries.

Upper bound 350 bar a covers extreme industrial boilers; raise only with written engineering justification.

Why: Saturated steam pressures outside this range either are physically improbable for saturated steam or require special technical justification.

C ‚Äî Downstream Absolute Pressure ‚Äî Downstream Absolute Pressure (P2)

Label (use exactly): Downstream Absolute Pressure (P2) in bar absolute (bar a)

Type / unit: numeric, bar absolute

Allowed decimals: up to 3 decimals

Acceptable (recommended) range: 0.001 ‚â§ P2 < P1 (strictly less than P1)

Lower bound 0.001 avoids zero/near-zero arithmetic problems for vacuum conditions.

Why: Downstream pressure must be lower than upstream for flow. Values >= P1 indicate no pressure drop and invalid conditions for this formula.

D ‚Äî Pressure Drop Ratio ‚Äî x

Definition (displayed in parameters): x = (P1 ‚àí P2) √∑ P1

Allowed range: 0 ‚â§ x ‚â§ 0.42 (inclusive) ‚Äî this is the formula constraint for the chosen empirical model.

Why: Model derived constants are valid only within this range; outside it the physical assumptions break down and the formula yields invalid/imaginary values.

E ‚Äî Decimal / formatting rule (global)

Input sanitization: trim whitespace, reject inputs containing commas or non-numeric characters. Convert unit suffixes to base units before computing. If user pastes 12 bar, strip bar. Provide inline helper text.

3) Edge-case validations (special checks)

Division by zero / near zero: P1 must not be zero. If P1 < 0.001 ‚Äî show error. (Prevents x = division by zero or near-zero instability.)

x out of valid model range: If x < 0 or x > 0.42, do not calculate ‚Äî show a clear error describing the valid range and ask for engineering review if values are operationally required.

Negative sqrt argument: compute sqrtTerm = 1 ‚àí 5.67*(0.42 - x)¬≤. If sqrtTerm < 0 then the mass flow formula returns NaN; treat as invalid and warn user.

Extreme Kv and pressure combinations: e.g., very large Kv combined with high P1 produces enormous mass flow (possible > 1,000,000 kg/h). Cap final result or force engineering review when ms > 100,000 kg/h (or your plant-specific threshold). Provide warning but allow override with comment.

P2 extremely close to P1: If P1 - P2 is very small (for example less than 0.0001 bar), numerical precision may produce x ‚âà 0; warn user that pressure drop is negligible ‚Äî calculation might be meaningless.

Non-finite results: If ms is Infinity or NaN, stop and show an error.

Units mismatch: If user tries to enter gauge pressure inadvertently, remind them to enter absolute pressure (bar a). Show detected likely unit errors if P1 < 1 and P2 value suspiciously high/low.

Missing inputs: any missing must block calculation ‚Äî no defaulting to 0.

4) Output validation logic and thresholds explained (audit & KPI mapping)

Outputs must be labeled with compliance-friendly language and thresholds tied to engineering action levels.

Mass Flow (·πÅ) ‚Äî KPI: Mass Flow Rate (kg/h)

Green (Acceptable): ·πÅ < 10,000 kg/h

Action: Normal usage. Include in routine reports.

Amber (Engineering review): 10,000 kg/h ‚â§ ·πÅ ‚â§ 50,000 kg/h

Action: Verify valve body rating, seat leakage specs, piping, and relief valve set points. Document in audit logs and require engineering sign-off.

Red (Critical / Safety Review): ·πÅ > 50,000 kg/h

Action: Immediate engineering review required. Cross-check relief valve sizing, piping, and structural limits. Generate an incident/exception record if this was unexpected.

Validation for Compliance Reports (what to record):

Input values with units and timestamps.

Any warnings shown and justification if user overrides (override must be logged).

Calculated x and sqrtTerm values (for traceability).

Final mass flow with rounding, and assessment level (Green/Amber/Red).

Link to the valve datasheet or RFI if results cause mismatch.

5) Corrected JavaScript validation function

Below is a corrected and hardened calculateSteamFlow() function. It preserves your UI flow and messages (error box, placeholder/result visibility) but adds the recommended validations, explicit messages, warnings, and audit-friendly outputs.

Notes about the code:

Uses strict numeric checks, precision control, and clear messages.

Shows warnings (non-fatal) vs errors (blocks calculation).

Adds checks for finite values, sqrtTerm >= 0, and extreme flow flags.

Keeps the existing DOM IDs and classes you used.
8) Why each validation is essential (compliance rationale)

Numeric & range checks: Prevent bad data entering the safety/engineering chain. Wrong inputs cause wrong valve sizing, which can lead to leaks, overpressure, or uncontrolled steam release ‚Äî direct safety hazard.

Absolute pressure requirement: Using gauge vs absolute pressure is a common mistake. Safety calculations and relief sizing require absolute pressures to be meaningful.

x range & sqrtTerm non-negativity: The underlying empirical formula is valid only in a limited domain; using it outside that domain yields meaningless/unsafe results. Ensures integrity of engineering decisions.

Warnings for high mass flows: Huge flows can indicate a mismatch with safety devices (e.g., relief valves may not be sized correctly). Auditors expect escalation paths when thresholds exceed typical operating ranges.

Input precision & parsing: Ensures consistent record-keeping in audits, reduces transcription mistakes, and helps reproducibility in incident investigation.

Audit logging & explicit messaging: For QEHS, every automated calculation that affects safety decisions must be traceable (inputs, outputs, warnings, and user overrides). -->