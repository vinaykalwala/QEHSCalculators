{% extends 'base.html' %}
{% block title %}Fluid Loss for Drilling Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluid Loss for Drilling Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
                .btn-container {
    display: flex;
    justify-content: center; /* Horizontally center */
    margin: 30px 0;
}

.back-btn {
    background:linear-gradient(#1560bd,#000040); /* Dark navy background */
    color: #ffffff; /* White text */
    border: 2px solid #1560bd; /* Highlight border */
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none; /* Remove underline for link */
    transition: all 0.3s ease;
    cursor: pointer;
}

.back-btn:hover {
    background-color: #1560bd; /* Highlight on hover */
    color: #ffffff;
    border-color: #000040;
    transform: scale(1.05); /* Subtle hover effect */
}

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            {% comment %} max-width: 700px; {% endcomment %}
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (min-width: 901px) {
            .calc-content { 
                flex-direction: row; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
            order: 2;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            min-height: 320px;
            {% comment %} order: 1; {% endcomment %}
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Input rows for side-by-side fields */
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            {% comment %} margin-top: 20px; {% endcomment %}
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }

        /* Mobile-specific adjustments */
        @media (max-width: 320px) {
            .calculator-container {
                padding: 10px;
            }
            
            .calculator-header h1 {
                font-size: 1.8rem;
            }
            
            .calculator-header p {
                font-size: 16px;
            }
            
            .calc-card, .result-card {
                padding: 20px 15px;
                border-radius: 12px;
            }
            
            .calc-card h2 {
                font-size: 1.4rem;
            }
            
            .form-input {
                padding: 12px 14px;
                font-size: 14px;
            }
            
            .calculate-btn {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .result-placeholder img {
                max-width: 180px;
            }
            
            .rate-value {
                font-size: 36px;
            }
            
            .meter-labels span {
                font-size: 10px;
            }
            
            .note-card {
                padding: 15px 18px;
            }
            
            .note-card h3 {
                font-size: 16px;
            }
            
            .note-card p, .note-card li {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="btn-container">
    <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
</div>
   <div class="calculator-container printable" id="printArea">

    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Fluid Loss for Drilling Calculator</h1>
            <p>Calculate the rate of fluid loss during drilling operations to maintain wellbore stability</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                
                <div class="form-group">
                    <label for="initialFluidVolume">Initial Fluid Volume (L)</label>
                    <input type="number" id="initialFluidVolume" class="form-input" min="0" placeholder="e.g., 1000">
                </div>
                
                <div class="form-group">
                    <label for="finalFluidVolume">Final Fluid Volume (L)</label>
                    <input type="number" id="finalFluidVolume" class="form-input" min="0" placeholder="e.g., 850">
                </div>
                
                <div class="form-group">
                    <label for="time">Time (hours)</label>
                    <input type="number" id="time" class="form-input" min="0.1" step="0.1" placeholder="e.g., 5">
                </div>
                
                <button class="calculate-btn" onclick="calculateFluidLoss()">Calculate Fluid Loss Rate</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">

                    <p>This tool will calculate the <strong>Fluid Loss Rate</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Fluid Loss Rate</h2>
                    </div>
                    <div class="rate-display">
                    <div class="rate-value" id="rateValue">0.00</div>
                    <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Liters per hour</div></div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Good</span><span>Moderate</span><span>Warning</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Drilling Fluid Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
<!-- Notes Section -->
<div class="note-section">

    <!-- About -->
    <div class="note-card">
        <h3>📘 About This Calculator</h3>
        <p>
            The <strong>Fluid Loss for Drilling Calculator</strong> estimates the rate of drilling fluid loss over time — 
            a crucial factor in maintaining <strong>wellbore stability</strong> and optimizing <strong>drilling efficiency</strong>. 
            By comparing initial and final fluid volumes over a given period, it helps monitor the condition and performance 
            of drilling fluids under operational conditions.
        </p>
    </div>

    <!-- Parameters Used -->
    <div class="note-card">
        <h3>⚙ Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Initial Fluid Volume (L):</strong> The starting volume of drilling fluid in the system.</li>
            <li><strong>Final Fluid Volume (L):</strong> The remaining fluid volume after a certain period.</li>
            <li><strong>Time (h):</strong> Duration over which fluid loss is measured.</li>
            <li><strong>Fluid Loss Rate (L/h):</strong> The calculated rate at which drilling fluid is lost per hour.</li>
        </ul>
    </div>

    <!-- Input Validation Rules -->
    <div class="note-card">
        <h3>✅ Input Validation Rules</h3>
        <ul class="note-list">
            <li><strong>Initial Fluid Volume:</strong> 0.1 – 10,000 L (max 2 decimals)</li>
            <li><strong>Final Fluid Volume:</strong> 0 – Initial Fluid Volume (max 2 decimals)</li>
            <li><strong>Time:</strong> 0.1 – 100 h (max 1 decimal)</li>
            <li><strong>No Negative Values:</strong> All inputs must be non-negative and realistic.</li>
            <li><strong>Cross-Check:</strong> Final ≤ Initial (fluid cannot increase).</li>
            <li><strong>Logical Consistency:</strong> Avoid extremely short times that can distort loss rates.</li>
        </ul>
    </div>

    <!-- Output Validations -->
    <div class="note-card">
        <h3>📊 Output Validations & Fluid Assessment</h3>
        <p><b>Interpretation:</b> The calculator provides automatic classification based on fluid loss rate:</p>
        <ul class="note-list">
            <li><span class="good">Below 0.5 L/h</span> → 🟢 <strong>Good:</strong> Low fluid loss, stable wellbore.</li>
            <li><span class="average">0.5 – 1.5 L/h</span> → 🟠 <strong>Moderate:</strong> Acceptable but monitor fluid properties closely.</li>
            <li><span class="bad">Above 1.5 L/h</span> → 🔴 <strong>Warning:</strong> High fluid loss, take corrective actions.</li>
        </ul>
        <p>
            <strong>Output Feedback:</strong> These same assessments are dynamically displayed in the result section 
            for quick decision-making and operational awareness.
        </p>
        <p><em>These thresholds align with API RP 13B-1 (Drilling Fluid Testing) guidelines for acceptable mud loss ranges.</em></p>
    </div>

    <!-- Governing Principle -->
    <div class="note-card">
        <h3>⚖ Governing Principle</h3>
        <p>
            Fluid loss in drilling is standardized by procedures outlined in 
            <strong>ANSI/API 13B-1</strong> for water-based fluids and 
            <strong>ANSI/API 13B-2</strong> for oil-based fluids. 
            These standards define methods for testing the fluid loss properties of drilling fluids under simulated downhole conditions, 
            using specific equipment and test media.
        </p>

        <h3>Key Aspects of API Fluid Loss Standards:</h3>
        <ul class="note-list">
            <li><strong>API Standard 13B:</strong> The overarching standard for testing drilling fluids.</li>
            <li><strong>ANSI/API 13B-1:</strong> Covers recommended practices for testing <b>water-based drilling fluids</b>, including 
                procedures for measuring fluid loss under <b>High-Temperature High-Pressure (HTHP)</b> conditions.</li>
            <li><strong>ANSI/API 13B-2:</strong> Defines procedures for testing <b>oil-based drilling fluids</b>.</li>
            <li><strong>Testing Methodology:</strong> Describes using filter paper and permeable discs to measure the volume of 
                filtrate collected under a pressurized and heated environment.</li>
            <li><strong>Purpose of the Test:</strong> Fluid loss tests help engineers understand fluid performance in the wellbore 
                and identify issues such as <b>formation damage</b> or <b>differential sticking</b>.</li>
            <li><strong>HTHP Testing:</strong> High-Temperature High-Pressure testing simulates real downhole conditions, offering 
                more accurate predictions of fluid behavior under operational stress.</li>
        </ul>
        <p>
            These standards ensure that the measured fluid loss rate accurately represents field performance, 
            supporting safe and efficient drilling practices.
        </p>
    </div>

    <!-- Conclusion -->
    <div class="note-card">
        <h3>🧩 Conclusion</h3>
        <p>
            The <strong>Fluid Loss for Drilling Calculator</strong> provides a quick, reliable way to estimate fluid loss rates 
            and assess the stability of drilling operations. 
            By adhering to API 13B standards, it enables engineers to detect excessive fluid losses early, 
            maintain wellbore stability, and minimize operational costs.
        </p>
        <p>
            Always validate results with actual <b>mud testing data</b> and follow <b>API and OSHA</b> safety procedures 
            when interpreting fluid loss rates in live operations.
        </p>
    </div>

</div>


    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateFluidLoss() {
    const initialFluidVolume = document.getElementById('initialFluidVolume').value.trim();
    const finalFluidVolume = document.getElementById('finalFluidVolume').value.trim();
    const time = document.getElementById('time').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];

    /* Validation Rules (based on API/OSHA/ISO practices):
       - Initial Fluid Volume: 0.1 – 10000 L
       - Final Fluid Volume: 0 – Initial Fluid Volume
       - Time: 0.1 – 100 h
       - Decimals: allowed up to 2 places
    */
    function checkDecimalPlaces(value, maxDecimals) {
        if (value.includes('.')) {
            const decimals = value.split('.')[1].length;
            return decimals <= maxDecimals;
        }
        return true;
    }

    // Validate initial volume
    if (initialFluidVolume === "") {
        errors.push("👉 Please enter Initial Fluid Volume.");
    } else {
        const val = parseFloat(initialFluidVolume);
        if (isNaN(val)) errors.push("👉 Initial Fluid Volume must be a number.");
        else if (val < 0.1 || val > 10000) errors.push("👉 Initial Fluid Volume must be between 0.1 and 10,000 L.");
        else if (!checkDecimalPlaces(initialFluidVolume, 2)) errors.push("👉 Initial Fluid Volume can have max 2 decimals.");
    }

    // Validate final volume
    if (finalFluidVolume === "") {
        errors.push("👉 Please enter Final Fluid Volume.");
    } else {
        const val = parseFloat(finalFluidVolume);
        const init = parseFloat(initialFluidVolume);
        if (isNaN(val)) errors.push("👉 Final Fluid Volume must be a number.");
        else if (val < 0 || val > 10000) errors.push("👉 Final Fluid Volume must be between 0 and 10,000 L.");
        else if (!isNaN(init) && val > init) errors.push("👉 Final Fluid Volume cannot exceed Initial Fluid Volume.");
        else if (!checkDecimalPlaces(finalFluidVolume, 2)) errors.push("👉 Final Fluid Volume can have max 2 decimals.");
    }

    // Validate time
    if (time === "") {
        errors.push("👉 Please enter Time.");
    } else {
        const val = parseFloat(time);
        if (isNaN(val)) errors.push("👉 Time must be a number.");
        else if (val < 0.1 || val > 100) errors.push("👉 Time must be between 0.1 and 100 hours.");
        else if (!checkDecimalPlaces(time, 1)) errors.push("👉 Time can have max 1 decimal place.");
    }

    // Show errors if any
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // Perform calculation
    const initialVol = parseFloat(initialFluidVolume);
    const finalVol = parseFloat(finalFluidVolume);
    const timeVal = parseFloat(time);

    // Avoid divide by zero (already caught by validation)
    const fluidLossRate = (initialVol - finalVol) / timeVal;
    document.getElementById('rateValue').textContent = fluidLossRate.toFixed(2);

    // Assessment logic
    const meterFill = document.getElementById('meterFill');
    let meterWidth, meterColor, feedback;

    if (fluidLossRate < 0.5) {
        meterWidth = '25%';
        meterColor = '#27ae60';
        feedback = 'Good: Low fluid loss, stable wellbore.';
    } else if (fluidLossRate <= 1.5) {
        meterWidth = '60%';
        meterColor = '#f39c12';
        feedback = 'Moderate: Acceptable but monitor fluid properties closely.';
    } else {
        meterWidth = '95%';
        meterColor = '#e74c3c';
        feedback = 'Warning: High fluid loss, take corrective actions.';
    }

    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;
    document.getElementById('feedbackContent').textContent = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}


        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


{% comment %} 
1. Formula (keep this as code comment)
/* 
Formula: Fluid Loss Rate = (Initial Fluid Volume − Final Fluid Volume) ÷ Time

Where:
- Initial Fluid Volume (L): Volume of drilling fluid at start
- Final Fluid Volume (L): Volume of drilling fluid after test duration
- Time (h): Duration of monitoring

Unit: Liters per hour (L/h)

Validation Rationale:
- Initial ≥ Final (cannot gain fluid unless measurement error)
- Volumes must be realistic: 0.1 – 10,000 L (common mud pit / system ranges)
- Time must be realistic: 0.1 – 100 h (short lab to long field monitoring)
- Prevents divide-by-zero and negative loss rates
*/

2. Input Validation Rules
✅ Initial Fluid Volume (L)

Range: 0.1 – 10,000 L

Decimals: Up to 2 decimals allowed

Unit: Liters (L)

Reason: Too low (<0.1 L) = measurement error; too high (>10,000 L) unrealistic for rig tank samples.

✅ Final Fluid Volume (L)

Range: 0 – Initial Fluid Volume

Decimals: Up to 2 decimals

Reason: Must not exceed initial volume (fluid cannot appear). Zero is acceptable (total loss).

✅ Time (h)

Range: 0.1 – 100 h

Decimals: Up to 1 decimal recommended

Reason: <0.1 h unrealistic; >100 h unlikely for a single monitoring event.

✅ Cross-Field Rules

Final ≤ Initial

If Initial = Final → Fluid Loss Rate = 0 (acceptable case)

If Time very small (<0.1 h) → reject to avoid inflated loss rates

3. Output Validation Logic & Thresholds

<0.5 L/h → “Good”
→ Minimal loss, wellbore stable.

0.5 – 1.5 L/h → “Moderate”
→ Requires observation; might indicate early mud property deterioration.

>1.5 L/h → “Warning”
→ High fluid loss, increased risk of wellbore instability, costs, environmental discharge.

⚖️ These thresholds align with API RP 13B-1 (Drilling Fluid Testing) standards used in mud-loss reporting. {% endcomment %}
