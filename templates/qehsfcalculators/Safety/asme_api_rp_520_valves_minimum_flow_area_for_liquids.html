{% extends 'base.html' %}
{% block title %}ASME (API RP 520) Valves - Minimum Flow Area For Liquids{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASME (API RP 520) Valves - Minimum Flow Area For Liquids</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
                .btn-container {
    display: flex;
    justify-content: center; /* Horizontally center */
    margin: 30px 0;
}

.back-btn {
    background:linear-gradient(#1560bd,#000040); /* Dark navy background */
    color: #ffffff; /* White text */
    border: 2px solid #1560bd; /* Highlight border */
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none; /* Remove underline for link */
    transition: all 0.3s ease;
    cursor: pointer;
}

.back-btn:hover {
    background-color: #1560bd; /* Highlight on hover */
    color: #ffffff;
    border-color: #000040;
    transform: scale(1.05); /* Subtle hover effect */
}

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            {% comment %} max-width: 700px; {% endcomment %}
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            {% comment %} display: flex; {% endcomment %}
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
            {% comment %} overflow-y: auto; {% endcomment %}
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Input rows for side-by-side fields */
         .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            {% comment %} margin-bottom: 15px; {% endcomment %}
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }
        
        .error {
            color: #ff6b6b;
            font-size: 14px;
            {% comment %} margin-top: 5px; {% endcomment %}
            {% comment %} min-height: 20px; {% endcomment %}
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
        
        
    </style>
</head>
<body>
    <div class="btn-container">
    <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
</div>
   <div class="calculator-container printable" id="printArea">

    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>ASME (API RP 520) Valves - Minimum Flow Area For Liquids</h1>
            <p>Calculate the minimum required discharge area for liquid relief valves according to ASME standards</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                
                <div class="input-row">
                    <div class="form-group">
                        <label for="Vt">Required Volume Flow (VÃá<sub>t</sub>) (US gal/min)</label>
                        <input type="number" id="Vt" class="form-input" min="0.0001" step="0.0001" placeholder="e.g., 100">
                        <div class="error" id="Vt-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="Kd">Effective Discharge Coefficient (K<sub>d</sub>)</label>
                        <input type="number" id="Kd" class="form-input" min="0.0001" step="0.0001" placeholder="e.g., 0.65">
                        <div class="error" id="Kd-error"></div>
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="form-group">
                        <label for="Kv">Viscosity Factor (K<sub>v</sub>)</label>
                        <input type="number" id="Kv" class="form-input" min="0.0001" step="0.0001" placeholder="e.g., 1.0">
                        <div class="error" id="Kv-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="Kw">Backpressure Correction Factor (K<sub>w</sub>)</label>
                        <input type="number" id="Kw" class="form-input" min="0.0001" step="0.0001" placeholder="e.g., 1.0">
                        <div class="error" id="Kw-error"></div>
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="form-group">
                        <label for="G">Specific Gravity (G)</label>
                        <input type="number" id="G" class="form-input" min="0.0001" step="0.0001" placeholder="e.g., 0.9">
                        <div class="error" id="G-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="PR">Upstream Pressure (P<sub>R</sub>) (bar a)</label>
                        <input type="number" id="PR" class="form-input" min="0.0001" step="0.0001" placeholder="e.g., 10">
                        <div class="error" id="PR-error"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="PB">Backpressure (P<sub>B</sub>) (psi a)</label>
                    <input type="number" id="PB" class="form-input" min="0" step="0.0001" placeholder="e.g., 5">
                    <div class="error" id="PB-error"></div>
                </div>
                
                <button class="calculate-btn" onclick="calculateFlowArea()">Calculate Flow Area</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                   <img src="{% static 'images/resultimage.png' %}" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Minimum Flow Area</strong> for ASME valves. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Minimum Flow Area</h2>
                    </div>
                    <div class="rate-display">
                    <div class="rate-value" id="rateValue">0.00</div>
                    <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">mm¬≤</div></div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Small</span><span>Moderate</span><span>Medium</span><span>Large</span><span>Very Large</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

<!-- Notes Section -->
<!-- Notes Section -->
<div class="note-section">

    <!-- About This Calculator -->
    <div class="note-card">
        <h3>üìò About This Calculator</h3>
        <p>
            The <strong>ASME (API RP 520) Minimum Flow Area Calculator</strong> determines the minimum required discharge area (A‚ÇÄ) for liquid relief valves. 
            Proper valve sizing is critical to prevent overpressure, ensure safe fluid discharge, and maintain compliance with international safety standards.
        </p>
    </div>

    <!-- Parameters Used -->
    <div class="note-card">
        <h3>‚öôÔ∏è Parameters Used</h3>
        <ul class="note-list">
            <li><strong>VÃá<sub>t</sub></strong> ‚Äì Flow rate through the valve </li>
            <li><strong>K<sub>d</sub></strong> ‚Äì Coefficient of discharge </li>
            <li><strong>K<sub>v</sub></strong> ‚Äì Viscosity factor </li>
            <li><strong>K<sub>w</sub></strong> ‚Äì Backpressure correction factor </li>
            <li><strong>G</strong> ‚Äì Specific gravity of the liquid</li>
            <li><strong>P<sub>R</sub></strong> ‚Äì Relieving pressure at valve inlet </li>
            <li><strong>P<sub>B</sub></strong> ‚Äì Backpressure </li>
        </ul>
    </div>

<!-- Input Validation Rules -->
<div class="note-card">
    <h3>‚úÖ Input Validation Rules</h3>
    <ul class="note-list">
        <li><b>VÃá<sub>t</sub> (Required Volume Flow):</b> 1‚Äì1,000,000 gpm</li>
        <li><b>Kd!(Discharge coefficient):</b> 0.62‚Äì0.98 (API 520 limits)</li>
        <li><b>Kv (Viscosity factor):</b> 0.9‚Äì1.1</li>
        <li><b>Kw(Backpressure correction factor):</b> 0.9‚Äì1.0</li>
        <li><b>G (Specific gravity):</b> 0.2‚Äì2.0</li>
        <li><b>PR (Upstream relieving pressure):</b> 0 and ‚â§1000 bar a</li>
        <li><b>PB (Backpressure):</b> ‚â•0 psi and &lt; PR (converted to psi)</li>
        <li><b>Cross-check:</b> PR must always be greater than PB</li>
    </ul>
</div>


    <!-- Output Validations -->
    <div class="note-card">
        <h3>üìä Output Validations</h3>
        <p>
            The minimum flow area (<b>A‚ÇÄ</b>) determines valve size category. 
            The same assessment feedback shown in the results will also apply here:
        </p>
        <ul class="note-list">
            <li><b>&lt; 50 mm¬≤</b> ‚Üí ‚úÖ Small valve required (low-flow applications)</li>
            <li><b>50‚Äì200 mm¬≤</b> ‚Üí üëç Moderate valve size (general industrial)</li>
            <li><b>200‚Äì500 mm¬≤</b> ‚Üí ‚ö†Ô∏è Medium valve size (process industry)</li>
            <li><b>500‚Äì1000 mm¬≤</b> ‚Üí üìè Large valve required (critical systems)</li>
            <li><b>&gt; 1000 mm¬≤</b> ‚Üí üö® Very large valve needed ‚Äî review inputs</li>
        </ul>
        <p>
            Edge case: If <b>(PR ‚Äì PB) ‚â§ 0</b>, calculation is invalid ‚Äî backpressure too high relative to relieving pressure.
        </p>
    </div>

    <!-- Governing Principle -->
    <div class="note-card">
        <h3>üìè Governing Principle</h3>
        <p>
            In AD-Merkblatt valves, the minimum flow area for dry gases and air is determined by the AD 2000-Merkblatt A2 standard. 
            This German standard provides guidelines for the sizing and installation of safety valves for pressure vessels. 
            Key details about the AD 2000-Merkblatt A2 standard:
            <ul>
                <li>It outlines the calculations for determining the required minimum flow cross-section of safety valves for gases, vapors, and liquids.</li>
                <li>The standard is often used in conjunction with or as an alternative to other international standards, such as ISO 4126.</li>
                <li>It is considered to satisfy the essential safety requirements of the European Pressure Equipment Directive (PED).</li>
                <li>For the general case, AD 2000-Merkblatt A2 specifies a minimum flow diameter of at least 6 mm. Larger minimum diameters are required for certain media.</li>
            </ul>
        </p>
    </div>

    <!-- Conclusion -->
    <div class="note-card">
        <h3>üìù Conclusion</h3>
        <p>
            Proper calculation and validation of <b>A‚ÇÄ</b> ensures safe operation of liquid relief valves according to ASME/API RP 520 standards. 
            Always cross-check input parameters and verify that valve size feedback matches the intended process application.
        </p>
    </div>

</div>



    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });
function calculateFlowArea() {
    const Vt = parseFloat(document.getElementById('Vt').value.trim());
    const Kd = parseFloat(document.getElementById('Kd').value.trim());
    const Kv = parseFloat(document.getElementById('Kv').value.trim());
    const Kw = parseFloat(document.getElementById('Kw').value.trim());
    const G = parseFloat(document.getElementById('G').value.trim());
    const PR = parseFloat(document.getElementById('PR').value.trim()); // bar a
    const PB = parseFloat(document.getElementById('PB').value.trim()); // psi a

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];

    // Clear error texts
    ['Vt','Kd','Kv','Kw','G','PR','PB'].forEach(id => document.getElementById(id+'-error').textContent = '');

    // Validation ranges
    if (!(Vt > 0 && Vt <= 1_000_000)) {
        errors.push("Flow rate must be between 1 and 1,000,000 gpm");
        document.getElementById('Vt-error').textContent = "Increase/decrease flow rate to realistic value.";
    }
    if (!(Kd >= 0.62 && Kd <= 0.98)) {
        errors.push("Discharge coefficient (Kd) must be 0.62‚Äì0.98 per API 520");
        document.getElementById('Kd-error').textContent = "Adjust to valve test-certified range.";
    }
    if (!(Kv >= 0.9 && Kv <= 1.1)) {
        errors.push("Viscosity factor (Kv) should be 0.9‚Äì1.1");
        document.getElementById('Kv-error').textContent = "Check fluid property correction.";
    }
    if (!(Kw >= 0.9 && Kw <= 1.0)) {
        errors.push("Backpressure factor (Kw) must be 0.9‚Äì1.0");
        document.getElementById('Kw-error').textContent = "Revise Kw value.";
    }
    if (!(G >= 0.2 && G <= 2.0)) {
        errors.push("Specific gravity must be 0.2‚Äì2.0 for valid liquids");
        document.getElementById('G-error').textContent = "Correct density or check unit.";
    }
    if (!(PR > 0 && PR <= 1000)) {
        errors.push("Upstream pressure (PR) must be >0 and ‚â§1000 bar a");
        document.getElementById('PR-error').textContent = "Increase/decrease PR to realistic operating pressure.";
    }
    if (!(PB >= 0)) {
        errors.push("Backpressure (PB) must be ‚â•0 psi");
        document.getElementById('PB-error').textContent = "PB cannot be negative.";
    }

    // Cross-field dependency
    const PR_psi = PR * 14.5038; // convert bar ‚Üí psi
    if (PB >= PR_psi) {
        errors.push("Backpressure (PB) must be less than upstream relieving pressure (PR)");
        document.getElementById('PB-error').textContent = "Reduce PB or increase PR.";
    }

    // Stop if errors
    if (errors.length > 0) {
        errorMessage.innerHTML = "Please fix the following:<br>" + errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // Calculation
    const A0 = (Vt / (38 * Kd * Kv * Kw)) * Math.sqrt(G / (PR - (PB / 14.5038))); // PB back to bar
    if (A0 <= 0 || isNaN(A0)) {
        errorMessage.innerHTML = "Calculation error: Check input values.";
        errorBox.classList.remove("hidden");
        return;
    }

    document.getElementById('rateValue').textContent = A0.toFixed(4);

    // Feedback meter
    const meterFill = document.getElementById('meterFill');
    let meterWidth, meterColor, feedback;
    if (A0 < 50) { meterWidth = '15%'; meterColor = '#27ae60'; feedback = '‚úÖ Small valve required.'; }
    else if (A0 < 200) { meterWidth = '35%'; meterColor = '#2ecc71'; feedback = 'üëç Moderate valve size.'; }
    else if (A0 < 500) { meterWidth = '55%'; meterColor = '#f39c12'; feedback = '‚ö†Ô∏è Medium valve size.'; }
    else if (A0 < 1000) { meterWidth = '75%'; meterColor = '#e67e22'; feedback = 'üìè Large valve required.'; }
    else { meterWidth = '95%'; meterColor = '#e74c3c'; feedback = 'üö® Very large valve needed ‚Äî review inputs.'; }

    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;
    document.getElementById('feedbackContent').textContent = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}


        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>

</body>
</html>
{% endblock %}


/*
Formula per ASME / API RP 520 for required minimum flow area for liquids:

A‚ÇÄ = ( VÃát / (38 √ó Kd √ó Kv √ó Kw) ) √ó ‚àö( G / (PR ‚Äì PB) )

Where:
    VÃát = Required volume flow (US gal/min)
    Kd = Effective discharge coefficient (typically 0.62‚Äì0.98)
    Kv = Viscosity correction factor (typically 0.9‚Äì1.1)
    Kw = Backpressure correction factor (0.9‚Äì1.0 if significant backpressure)
    G = Specific gravity of liquid (0.2‚Äì2.0 for most industrial liquids)
    PR = Relieving pressure at valve inlet (bar abs)
    PB = Backpressure (psi abs)

Unit consistency: PR must be converted to same absolute pressure units as PB. 
*/

{% comment %} 
1. Formula Used (for future reference in your code as comments)
/*
Formula per ASME / API RP 520 for required minimum flow area for liquids:

A‚ÇÄ = ( VÃát / (38 √ó Kd √ó Kv √ó Kw) ) √ó ‚àö( G / (PR ‚Äì PB) )

Where:
    VÃát = Required volume flow (US gal/min)
    Kd = Effective discharge coefficient (typically 0.62‚Äì0.98)
    Kv = Viscosity correction factor (typically 0.9‚Äì1.1)
    Kw = Backpressure correction factor (0.9‚Äì1.0 if significant backpressure)
    G = Specific gravity of liquid (0.2‚Äì2.0 for most industrial liquids)
    PR = Relieving pressure at valve inlet (bar abs)
    PB = Backpressure (psi abs)

Unit consistency: PR must be converted to same absolute pressure units as PB. 
*/

2. Detailed Input Validation Rules

Here are practical, industry-based ranges for each parameter:

Parameter	Typical Range / Validation	Reason (Compliance / Safety Justification)
Vt (Flow rate, US gpm)	>0, ‚â§1,000,000 gpm	Zero/negative flow unrealistic. Upper bound prevents typos (e.g., extra zeros).
Kd (Discharge coefficient)	0.62 ‚â§ Kd ‚â§ 0.98	ASME/API defined values. If <0.62, valve is not compliant. If >1, physically impossible.
Kv (Viscosity factor)	0.9 ‚â§ Kv ‚â§ 1.1	Viscosity correction rarely deviates much. Ensures user input is realistic.
Kw (Backpressure factor)	0.9 ‚â§ Kw ‚â§ 1.0	Correction always ‚â§1. If >1, indicates error.
G (Specific gravity)	0.2 ‚â§ G ‚â§ 2.0	Most industrial liquids fall within this. <0.2 (like hydrogen gas) or >2.0 (mercury, molten metals) not valid here.
PR (Upstream relieving pressure, bar a)	>0, ‚â§1,000 bar a	Must be positive absolute pressure. 1,000 bar is a physical extreme cut-off.
PB (Backpressure, psi a)	‚â•0, ‚â§PR (converted to psi)	Backpressure can‚Äôt exceed upstream relieving pressure. Zero allowed.
Cross-field rule	PR (bar) must be converted to psi before comparing with PB. Formula requires consistent units.	
3. Edge Case Validations

Division by zero: If PR ‚Äì PB ‚â§ 0, stop calculation, show error: ‚ÄúBackpressure too high relative to relieving pressure ‚Äì check system inputs.‚Äù

Unrealistic ratios: If (PR ‚Äì PB) is extremely small (<0.01 bar difference), result will be unrealistically large. Warn: ‚ÄúPressure differential too small ‚Äì valve sizing impractical.‚Äù

Negative outputs: A‚ÇÄ < 0 should be impossible; trap and block.

Outliers: If A‚ÇÄ > 1,000,000 mm¬≤, warn user of possible input mistake.

4. Output Validation Logic

Suggested feedback thresholds (based on API 520 application classes):

A‚ÇÄ < 50 mm¬≤ ‚Üí Small valve, low-flow applications.

50‚Äì200 mm¬≤ ‚Üí Moderate, general industrial.

200‚Äì500 mm¬≤ ‚Üí Medium, process industry.

500‚Äì1,000 mm¬≤ ‚Üí Large, critical systems.

>1,000 mm¬≤ ‚Üí Very large, high-capacity, possible input error ‚Äî advise review.
 {% endcomment %}