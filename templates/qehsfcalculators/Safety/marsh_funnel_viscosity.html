{% extends 'base.html' %}
{% block title %}Marsh Funnel Viscosity Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marsh Funnel Viscosity Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
            font-size: 18px;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
      
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Marsh Funnel Viscosity Calculator</h1>
            <p>Calculate the viscosity of drilling mud using the Marsh Funnel method</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="flowTime">Flow Time (T) in seconds</label>
                    <input type="number" id="flowTime" class="form-input" min="1" step="0.1" placeholder="e.g., 35.5">
                </div>
                <div class="form-group">
                    <label for="standardTime">Standard Time (seconds)</label>
                    <input type="number" id="standardTime" class="form-input" min="1" step="0.1" value="26" placeholder="e.g., 26">
                </div>
                
                <button class="calculate-btn" onclick="calculateViscosity()">Calculate Viscosity</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Viscosity illustration">
                    <p>This tool will calculate the <strong>Marsh Funnel Viscosity</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Marsh Funnel Viscosity</h2>
                    </div>
                    <div class="rate-value" id="viscosityValue">0.00</div>
                    <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Dimensionless value (relative to water)</div>

                    <div class="result-feedback">
                        <div class="feedback-title">Viscosity Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    The <strong>Marsh Funnel Viscosity Calculator</strong> measures the consistency of drilling mud by comparing 
                    the flow time of the mud to a standard time (typically 26 seconds for water). This is a critical parameter 
                    in drilling operations, as it helps ensure proper mud properties for effective drilling and wellbore stability.
                </p>
            </div>

            <div class="note-card">
                <h3>‚ùì What is Marsh Funnel Viscosity?</h3>
                <p>
                    Marsh Funnel Viscosity is a measure of the relative viscosity of drilling fluid compared to water. 
                    It's determined by timing how long it takes for a specific volume of fluid to flow through a standardized funnel.
                </p>
            </div>

            <div class="note-card">
                <h3>‚öôÔ∏è Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Flow Time (T):</strong> The time taken for 1 quart (946 ml) of drilling mud to flow through the Marsh Funnel, measured in seconds.</li>
                    <li><strong>Standard Time:</strong> The reference flow time for water, typically 26 seconds, used as a baseline for comparison.</li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>üìä Interpretation</h3>
                <p>
                    <b>Viscosity Values:</b>
                </p>
                <ul class="note-list">
                    <li><span class="good">Below 1.0</span> ‚Üí Less viscous than water (may indicate poor hole cleaning)</li>
                    <li><span class="average">Around 1.0</span> ‚Üí Same viscosity as water (ideal for balanced flow)</li>
                    <li><span class="bad">Above 1.0</span> ‚Üí More viscous than water (may enhance hole cleaning but increase torque)</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>üåç Real-Life Applications</h3>
                <ul class="note-list">
                    <li><strong>Oil and Gas Exploration:</strong> Monitoring mud consistency to ensure efficient drilling and minimize downtime.</li>
                    <li><strong>Environmental Protection:</strong> Controlling viscosity to prevent excessive mud loss into formations.</li>
                    <li><strong>Geotechnical Drilling:</strong> Maintaining proper viscosity for soil sampling and borehole stability.</li>
                    <li><strong>Offshore Drilling:</strong> Ensuring safe operations in challenging deepwater conditions.</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>üìã Industry Standards</h3>
                <p>
                    API Recommended Practice 13B-1 for Field Testing Water-based Drilling Fluids, 
                    and ISO 10414-1:2008 Petroleum and natural gas industries ‚Äî Field testing of drilling fluids.
                </p>
            </div>
            
            <div class="note-card">
    <h3>‚úÖ Validation Rules Applied</h3>
    <ul class="note-list">
        <li><b>Flow Time (T):</b> Must be between 10‚Äì300 seconds (API/ISO practical limits). Decimals allowed up to 1 decimal place.</li>
        <li><b>Standard Time (Ts):</b> Must be between 20‚Äì30 seconds (26s typical for water calibration).</li>
        <li><b>No Negative or Zero Values:</b> Both Flow and Standard Times must be > 0.</li>
        <li><b>Division by Zero Prevention:</b> Standard Time cannot be 0.</li>
        <li><b>Unrealistic Inputs:</b> Values outside limits are rejected with error message.</li>
        <li><b>Output Thresholds:</b> Viscosity <0.8 too thin; 1.0 ideal; >2.0 too viscous for safe drilling.</li>
    </ul>
</div>

        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

       function calculateViscosity() {
    const flowTime = document.getElementById('flowTime').value.trim();
    const standardTime = document.getElementById('standardTime').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];

    // ----------------------------
    // Validation Rules (API/ISO)
    // ----------------------------
    // Flow Time (T) must be between 10 - 300 seconds
    if (flowTime === "" || isNaN(flowTime)) {
        errors.push("üëâ Please enter the Flow Time in seconds.");
    } else if (parseFloat(flowTime) <= 0) {
        errors.push("üëâ Flow Time must be greater than 0.");
    } else if (parseFloat(flowTime) < 10) {
        errors.push("üëâ Flow Time below 10 seconds is invalid (check funnel/test).");
    } else if (parseFloat(flowTime) > 300) {
        errors.push("üëâ Flow Time cannot exceed 300 seconds (unrealistic value).");
    }

    // Standard Time (Ts) must be between 20 - 30 seconds (26s typical for water)
    if (standardTime === "" || isNaN(standardTime)) {
        errors.push("üëâ Please enter the Standard Time in seconds.");
    } else if (parseFloat(standardTime) <= 0) {
        errors.push("üëâ Standard Time must be greater than 0.");
    } else if (parseFloat(standardTime) < 20 || parseFloat(standardTime) > 30) {
        errors.push("üëâ Standard Time should be between 20 and 30 seconds (26 typical for water).");
    }

    // Error Handling
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // ----------------------------
    // Safe Calculation
    // ----------------------------
    const flow = parseFloat(flowTime);
    const standard = parseFloat(standardTime);

    // Prevent division by zero
    if (standard === 0) {
        errorMessage.innerHTML = "‚ùå Standard Time cannot be zero.";
        errorBox.classList.remove("hidden");
        return;
    }

    // Formula: Marsh Funnel Viscosity (dimensionless)
    const viscosity = flow / standard;

    // ----------------------------
    // Output & Feedback
    // ----------------------------
    document.getElementById('viscosityValue').textContent = viscosity.toFixed(2);

    let feedback = "";
    if (viscosity < 0.8) {
        feedback = "‚ùó The drilling mud is significantly less viscous than water. Poor hole cleaning likely. Add viscosifiers.";
    } else if (viscosity >= 0.8 && viscosity < 1.0) {
        feedback = "‚ÑπÔ∏è Slightly less viscous than water. Acceptable in limited cases but may need adjustments.";
    } else if (viscosity >= 1.0 && viscosity < 1.2) {
        feedback = "‚úÖ Near water viscosity. Ideal for balanced drilling and safe hole cleaning.";
    } else if (viscosity >= 1.2 && viscosity < 1.5) {
        feedback = "‚ö†Ô∏è Moderately more viscous than water. Good cleaning, but monitor torque/drag.";
    } else if (viscosity >= 1.5 && viscosity < 2.0) {
        feedback = "‚ö†Ô∏è High viscosity. Effective cleaning but may increase mechanical risks. Monitor closely.";
    } else {
        feedback = "‚ùå Excessive viscosity (>2.0). Unsafe for drilling. Dilution or treatment recommended.";
    }

    document.getElementById('feedbackContent').textContent = feedback;

    // Show Results
    placeholder.classList.add("hidden");
    resultValue.classList.remove("hidden");
}


        function printReport() {
            window.print();
        }
    </script>
</body>
</html>
{% endblock %}

{% comment %} 
1Ô∏è‚É£ Formula Used
// Formula Reference (API RP 13B-1 / ISO 10414-1):
// Marsh Funnel Viscosity (dimensionless) = Flow Time (T) / Standard Time (Ts)
// T  = measured flow time of 1 quart (946 mL) drilling mud (seconds)
// Ts = standard reference time for water (typically 26 seconds)


This formula is dimensionless because it is a ratio.

2Ô∏è‚É£ Input Validation Rules (QEHS & Industry Standards)
Flow Time (T)

Unit: seconds

Allowed range: 10 ‚Äì 300 s

Below 10 ‚Üí instrument error or invalid test

Above 300 ‚Üí unrealistic for field conditions (mud too thick or measurement error)

Decimals: allowed up to 1 decimal place (precision of manual stopwatch)

Mandatory: cannot be blank, cannot be zero

Standard Time (Ts)

Unit: seconds

Default: 26 s for water (per API RP 13B-1 & ISO 10414-1)

Allowed range: 20 ‚Äì 30 s

Outside ‚Üí check equipment calibration

Decimals: allowed up to 1 decimal place

Mandatory: cannot be blank, cannot be zero

3Ô∏è‚É£ Output Validation Rules (Thresholds & Feedback)

Formula result: viscosity = T / Ts

Thresholds for drilling mud assessment:

< 0.8 ‚Üí much thinner than water ‚Üí unsafe, poor hole cleaning

0.8 ‚Äì 1.0 ‚Üí slightly thinner than water ‚Üí marginally acceptable

1.0 ‚Äì 1.2 ‚Üí similar to water ‚Üí ideal

1.2 ‚Äì 1.5 ‚Üí moderately higher ‚Üí acceptable but torque risk

1.5 ‚Äì 2.0 ‚Üí very viscous ‚Üí hole cleaning OK but drag risk

> 2.0 ‚Üí excessively viscous ‚Üí unsafe, requires adjustment {% endcomment %}