{% extends 'base.html' %}
{% block title %}Sizing a control valve for liquid Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accident Rate Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
     
            @media screen and (max-width: 768px) {
    .calculator-header h1 {
        font-size: 1.5rem; /* smaller font for mobile */
        margin-bottom: 8px;
        text-align: center; /* optional: center the heading on mobile */
    }
}
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 480px;
            overflow-y: scroll;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 250px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
       
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
          @media (max-width: 768px) {
    .rate-value {
        font-size: 28px; /* smaller font for tablets/mobiles */
    }
}

@media (max-width: 480px) {
    .rate-value {
        font-size: 24px; /* even smaller for phones */
    }
}
.result-warning {
    background: #fff8e1; /* light orange */
    border: 1px solid #f9a825; /* amber border */
    color: #b36b00; /* dark orange text */
    border-radius: 8px;
    padding: 10px 14px;
    margin-bottom: 15px;
    font-size: 14px;
    text-align: left;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.result-warning strong {
    color: #e65100; /* stronger orange for icons/titles */
}

    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
<div class="calculator-container printable" id="printArea">
    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

    <div class="calculator-header">
        <h1>Sizing A Control Valve For Liquid Calculator</h1>
        <p>Estimate the volumetric flow rate of a liquid through a control valve using valve coefficient, pressure drop, and relative density.</p>
    </div>

    <div class="calc-content">
        <!-- Calculator -->
        <div class="calc-card">
            <h2>Enter Data</h2>
            <div class="form-group">
                <label for="kv">Valve Coefficient (Kv)</label>
                <input type="number" id="kv" class="form-input" min="0" step="0.1" placeholder="e.g., 50">
            </div>
            <div class="form-group">
                <label for="dp">Pressure Drop (ΔP) in bar</label>
                <input type="number" id="dp" class="form-input" min="0" step="0.01" placeholder="e.g., 2.5">
            </div>
            <div class="form-group">
                <label for="g">Relative Density (e.g., water = 1)</label>
                <input type="number" id="g" class="form-input" min="0" step="0.01" placeholder="e.g., 1.2">
            </div>
            <button class="calculate-btn" onclick="calculateFlowRate()">Calculate Flow Rate</button>
        </div>

        <!-- Result Section -->
        <div class="result-card">
            <div class="result-placeholder" id="placeholder">
                <img src="{% static 'images/resultimage.png' %}" alt="Valve illustration">
                <p>This tool will calculate <strong>Volumetric Flow Rate</strong>. Enter your data to see results and insights here.</p>
            </div>
              <div class="result-warning hidden" id="resultWarning">
    <div class="warning-message" id="warningMessage"></div>
</div>

            <div class="result-error hidden" id="resultError">
                <div class="error-icon">❌</div>
                <div class="error-message" id="errorMessage"></div>
            </div>
            
            <div class="result-value hidden" id="resultValue">
                <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                    <h2>Flow Rate Result</h2>
                </div>
                <div class="rate-value" id="flowRateValue">0</div>
                <div class="rate-label" style="color:#2980b9; font-size:14px; font-weight:bold;">
                    Cubic Meters per Hour (m³/h)
                </div>

                <div class="result-feedback">
                    <div class="feedback-title">Assessment</div>
                    <div class="feedback-content" id="feedbackContent"></div>
                </div>
                <div class="btn-wrapper">
                    <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Section -->
<!-- Notes Section -->
<div class="note-section">

    <!-- 1. About This Calculator -->
    <div class="note-card">
        <h3>📘 About This Calculator</h3>
        <p>
            The <strong>Sizing a control valve for liquid Calculator</strong> determines the volumetric flow rate of a liquid through a valve. 
            It uses the valve coefficient, pressure drop across the valve, and the liquid’s relative density. 
            This calculation is essential in process engineering to ensure proper valve selection for efficiency, safety, and performance.
        </p>
    </div>

    <!-- 2. Parameters Used -->
    <div class="note-card">
        <h3>⚙️ Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Valve Coefficient (Kv):</strong> A measure of the valve’s capacity, indicating how much liquid it allows under a defined pressure drop.</li>
            <li><strong>Pressure Drop (ΔP):</strong> The pressure difference between the valve inlet and outlet, measured in bar. It drives the liquid flow.</li>
            <li><strong>Relative Density:</strong> The ratio of the liquid’s density to the density of water (where water = 1). Heavier liquids reduce flow for the same valve conditions.</li>
            <li><strong>Volumetric Flow Rate (Q):</strong> The amount of liquid flowing through the valve per hour, expressed in cubic meters per hour (m³/h).</li>
        </ul>
    </div>

    <!-- 3. Input Validation Rules -->
    <div class="note-card">
        <h3>✅ Input Validation Rules</h3>
        <ul class="note-list">
            <li><strong>Valve Coefficient (Kv):</strong> Must be a positive number >0. Warnings if <0.1 or >1000.</li>
            <li><strong>Pressure Drop (ΔP):</strong> Must be ≥0. Warnings if >10 bar or >25 bar.</li>
            <li><strong>Relative Density (g):</strong> Must be >0. Warnings if <0.5 or >2.0. Values ≤0.0001 not allowed.</li>
            <li><strong>Decimal Precision:</strong> Kv & ΔP ≤ 2 decimals, Relative Density ≤ 3 decimals.</li>
            <li><strong>Flow Rate Plausibility:</strong> Flow >10,000 m³/h → check inputs. ΔP=0 → Flow=0 (expected).</li>
            <li><strong>Invalid/Missing Inputs:</strong> Empty, zero, negative, or non-numeric values not allowed.</li>
        </ul>
    </div>

    <!-- 4. Output Validations -->
    <div class="note-card">
        <h3>📊 Output Validations</h3>
        <ul class="note-list">
            <li><span class="good">Low Flow (&lt; 100 m³/h):</span> ✅ Indicates safe operating conditions. Typically suitable for laboratory setups, pilot plants, or precision-controlled processes.</li>
            <li><span class="average">Moderate Flow (100–1000 m³/h):</span> ⚠️ Falls within the common industrial operating range. Verify that the selected valve can handle continuous duty without excessive wear or pressure loss.</li>
            <li><span class="bad">High Flow (&gt; 1000 m³/h):</span> ❌ Represents large-scale flow conditions. Requires robust, heavy-duty valves, enhanced monitoring, and additional safety measures to prevent system failures.</li>
            <li>⚠️ High ΔP advisory: perform cavitation/flashing assessment using fluid temperature & vapor pressure.</li>
        </ul>
    </div>
<!-- 5. Governing Principle -->
<div class="note-card">
    <h3>📋 Governing Principle</h3>
    <p>
        Sizing a control valve for liquid flow is based on the standards defined by the <strong>International Society of Automation (ISA) 75.01</strong> 
        ("Flow Equations for Sizing Control Valves") and the <strong>International Electrotechnical Commission (IEC) 60534</strong> series of standards, particularly IEC 60534-2-1. 
        These standards provide standardized sizing equations and guidelines for calculating a valve's flow coefficient (Cv), ensuring consistency across industries.
    </p>
    <p><strong style="color: #1976d2;">Key Standards:</strong></p>
    <ul class="note-list">
        <li><strong>ISA 75.01:</strong> This standard provides the fundamental equations and guidelines for sizing control valves for various fluids, including liquids.</li>
        <li><strong>IEC 60534-2-1:</strong> This standard, which is identical to the international standard, details the sizing equations for fluid flow under installed conditions.</li>
    </ul>
    <p><strong style="color: #1976d2;">Why these Standards Matter:</strong></p>
    <ul class="note-list">
        <li><strong>Standardization:</strong> They offer a consistent, universal method for calculating the valve's flow coefficient (Cv), which is crucial for comparing and selecting valves.</li>
        <li><strong>Accuracy:</strong> Using these standards ensures that the control valve is sized correctly to achieve stable control within the desired operating range.</li>
        <li><strong>Performance:</strong> Proper sizing, guided by these standards, minimizes energy losses from excessive pressure drops and prevents issues like poor control or hunting from oversized valves.</li>
    </ul>
</div>


    <!-- 6. Conclusion -->
    <div class="note-card">
        <h3>🏁 Conclusion</h3>
        <p>
            The <strong>Sizing a control valve for liquid Calculator</strong> is a practical tool for engineers to analyze and select the correct valve size. 
            Correct sizing minimizes pressure losses, ensures safety, prevents cavitation, and optimizes system performance. 
            Always confirm calculated results with actual valve specifications and standards.
        </p>
    </div>

</div>

<script>
function calculateFlowRate() {
    // read inputs
    const kvRaw = document.getElementById('kv').value;
    const dpRaw = document.getElementById('dp').value;
    const gRaw = document.getElementById('g').value;

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const warningBox = document.getElementById('resultWarning');
    const warningMessage = document.getElementById('warningMessage');

    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');
    const feedbackContent = document.getElementById('feedbackContent');
    const flowRateDisplay = document.getElementById('flowRateValue');

    // helpers
    function isFiniteNumber(v) {
        return typeof v === 'number' && isFinite(v);
    }
    function countDecimalPlaces(n) {
        if (!isFiniteNumber(n)) return 0;
        const s = n.toString();
        if (s.indexOf('e-') >= 0) return 6; // scientific notation
        if (s.indexOf('.') >= 0) return s.split('.')[1].length;
        return 0;
    }

    // parse as floats
    const kv = parseFloat(kvRaw);
    const dp = parseFloat(dpRaw);
    const g = parseFloat(gRaw);

    // prepare messages
    const errors = [];
    const warnings = [];

    // --- Basic numeric checks ---
    if (!isFiniteNumber(kv)) errors.push("👉 Valve Coefficient (Kv) must be a valid number.");
    if (!isFiniteNumber(dp)) errors.push("👉 Pressure Drop (ΔP) must be a valid number (in bar).");
    if (!isFiniteNumber(g)) errors.push("👉 Relative Density must be a valid number (water = 1).");

    // stop early if non-numeric
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        warningBox.classList.add("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // --- Value range checks ---
    if (!(kv > 0)) errors.push("👉 Valve Coefficient (Kv) must be greater than 0.");
    if (!(dp >= 0)) errors.push("👉 Pressure Drop (ΔP) cannot be negative.");
    if (!(g > 0)) errors.push("👉 Relative Density must be greater than 0.");

    // decimal precision checks
    if (countDecimalPlaces(kv) > 2) warnings.push("⚠️ Valve Coefficient: more than 2 decimal places — round to 2 decimals for reporting.");
    if (countDecimalPlaces(dp) > 2) warnings.push("⚠️ Pressure Drop: more than 2 decimal places — round to 2 decimals.");
    if (countDecimalPlaces(g) > 3) warnings.push("⚠️ Relative Density: more than 3 decimal places — round to 3 decimals.");

    // realistic thresholds - warnings (not hard errors)
    if (kv > 1000) warnings.push("⚠️ Valve Coefficient unusually high (>1000). Verify units and vendor Kv definition.");
    if (kv < 0.1) warnings.push("⚠️ Valve Coefficient unusually small (<0.1). Confirm units and application.");
    if (dp > 25) warnings.push("⚠️ Pressure Drop unusually high (>25 bar). Confirm this is correct for a single valve.");
    if (dp > 10 && dp <= 25) warnings.push("⚠️ High Pressure Drop (>10 bar). Check for cavitation/flashing and vendor limits.");
    if (g < 0.5) warnings.push("⚠️ Relative Density low (<0.5). Verify fluid identity (e.g., light hydrocarbons).");
    if (g > 2.0) warnings.push("⚠️ Relative Density high (>2.0). Verify fluid identity (heavy liquids).");

    // division by zero / extremely small density
    if (g <= 0.0001) errors.push("👉 Relative Density is too small or zero; this will cause division errors. Enter a realistic density.");

    // If hard errors present, show and stop
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        warningBox.classList.add("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
        errorMessage.innerHTML = "";
    }

    // compute flow; guard sqrt argument
    const sqrtArg = dp / g;
    if (!isFiniteNumber(sqrtArg) || sqrtArg < 0) {
        errorMessage.innerHTML = "👉 Computation error: invalid pressure/density combination. Verify ΔP (bar) and Relative Density.";
        errorBox.classList.remove("hidden");
        warningBox.classList.add("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    const flowRateRaw = kv * Math.sqrt(sqrtArg);
    const flowRate = Number.isFinite(flowRateRaw) ? flowRateRaw : NaN;

    if (!isFiniteNumber(flowRate)) {
        errorMessage.innerHTML = "👉 Computation resulted in invalid flow. Check inputs.";
        errorBox.classList.remove("hidden");
        warningBox.classList.add("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // Additional checks on computed flow
    if (flowRate > 10000) warnings.push("⚠️ Calculated flow rate is very high (>10,000 m³/h). Verify inputs and consult valve vendor.");
    if (flowRate === 0 && dp === 0) warnings.push("ℹ️ Zero pressure drop -> zero theoretical flow. Ensure this matches expected process condition.");

    // --- Show warnings if any ---
    if (warnings.length > 0) {
        warningMessage.innerHTML = warnings.join("<br>");
        warningBox.classList.remove("hidden");
    } else {
        warningBox.classList.add("hidden");
        warningMessage.innerHTML = "";
    }

    // Format & display result with 2 decimals
    flowRateDisplay.textContent = flowRate.toFixed(2);

    // Provide classification and safety guidance
    let feedback = "";
    let color = "";

    if (flowRate < 100) {
        feedback = "✅ Low Flow (<100 m³/h): Indicates safe operating conditions. Typically suitable for laboratory setups, pilot plants, or precision-controlled processes.";
        color = "green";
    } else if (flowRate >= 100 && flowRate <= 1000) {
        feedback = "⚠️ Moderate Flow (100–1000 m³/h): Falls within the common industrial operating range. Verify that the selected valve can handle continuous duty without excessive wear or pressure loss.";
        color = "orange";
    } else {
        feedback = "❌ High Flow (>1000 m³/h): Represents large-scale flow conditions. Requires robust, heavy-duty valves, enhanced monitoring, and additional safety measures to prevent system failures.";
        color = "red";
    }

    // Cavitation advisory
    if (dp > 10) {
        feedback += " ⚠️ High ΔP advisory: perform cavitation/flashing assessment using fluid temperature & vapor pressure.";
    }

    feedbackContent.innerHTML = `<strong style="color:${color}">${feedback}</strong>`;

    // show result area & hide placeholder
    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');

    // audit log
    console.log("Valve Sizing - inputs:", {kv, dp, g}, "flow(m3/h):", flowRate.toFixed(2), "warnings:", warnings);
}

</script>



    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


