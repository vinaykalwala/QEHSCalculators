{% extends 'base.html' %}
{% block title %}Relief Vent Rate Formula (All-Liquid Venting) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Required Opening Force For A Balanced Safety Valve  Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
            height: 420px;
            overflow-y: scroll;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 70px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 18px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
          @media (max-width: 768px) {
    .rate-value {
        font-size: 28px; /* smaller font for tablets/mobiles */
    }
}

@media (max-width: 480px) {
    .rate-value {
        font-size: 24px; /* even smaller for phones */
    }
}
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
  <div class="calculator-container printable" id="printArea">
    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

    <!-- Header -->
    <div class="calculator-header">
        <h1>Relief Vent Rate Calculator (All-Liquid Venting)</h1>
        <p>Calculate the required relief vent rate (kg/s) for liquids under constant external heating to ensure vessel safety and prevent overpressure.</p>
    </div>

    <div class="calc-content">
        <!-- Calculator -->
        <div class="calc-card">
            <h2>Enter Data</h2>

            <div class="form-group">
                <label for="QT">Constant External Heat Input (Q‚Çú) [W]</label>
                <input type="number" id="QT" class="form-input" placeholder="e.g., 50000">
            </div>

            <div class="form-group">
                <label for="hfa">Latent Heat of Vaporization (h‚Çì‚Çê) [J/kg]</label>
                <input type="number" id="hfa" class="form-input" placeholder="e.g., 2256000">
            </div>

            <div class="form-group">
                <label for="vf">Specific Volume of Vapor (v‚Çì) [m¬≥/kg]</label>
                <input type="number" id="vf" class="form-input" placeholder="e.g., 0.0012">
            </div>

            <div class="form-group">
                <label for="Cv">Specific Heat at Constant Volume (C·µ•) [J/kg¬∑K]</label>
                <input type="number" id="Cv" class="form-input" placeholder="e.g., 4180">
            </div>

            <div class="form-group">
                <label for="deltaT">Temperature Rise (ŒîT) [K]</label>
                <input type="number" id="deltaT" class="form-input" placeholder="e.g., 50">
            </div>

            <button class="calculate-btn" onclick="calculateReliefVentRate()">Calculate Relief Vent Rate</button>
        </div>

        <!-- Result Section -->
        <div class="result-card">
            <div class="result-placeholder" id="placeholder">
                <img src="{% static 'images/resultimage.png' %}" alt="Relief Vent illustration">
                <p>This tool will calculate the <strong>Relief Vent Rate (W)</strong>. Enter your data to see results and engineering feedback here.</p>
            </div>
            <div class="result-error hidden" id="resultError">
                <div class="error-icon">‚ùå</div>
                <div class="error-message" id="errorMessage"></div>
            </div>
           <br>
            <div class="result-value hidden" id="resultValue">
                <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                    <h2>Relief Vent Rate Result</h2>
                </div>
                <div class="rate-value" id="ventRateValue">0.0000</div>
                <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">kg/s</div>

                <div class="result-feedback">
                    <div class="feedback-title">Assessment</div>
                    <div class="feedback-content" id="feedbackContent"></div>
                </div>
                <div class="btn-wrapper">
                    <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Section -->
    <div class="note-section">
       <div class="note-card">
    <h3>üìò About This Calculator</h3>
    <p>
        The <strong>Relief Vent Rate Calculator</strong> helps estimate the venting capacity required 
        when a liquid-filled vessel is exposed to external heating. It uses heat input, vaporization 
        properties, and temperature rise to determine how much vapor must be released. 
        This ensures that vessels can safely relieve pressure and avoid overpressure failures.
    </p>
</div>


        <div class="note-card">
            <h3>‚öôÔ∏è Parameters Used</h3>
            <ul class="note-list">
                <li><strong>W (Relief Vent Rate):</strong> The required venting capacity, measured in kg/s.</li>
                <li><strong>Q‚Çú (Constant External Heat Input):</strong> Heat energy supplied to the liquid (W).</li>
                <li><strong>h‚Çì‚Çê (Latent Heat of Vaporization):</strong> Energy required for phase change (J/kg).</li>
                <li><strong>v‚Çì (Specific Volume of Vapor):</strong> Volume occupied per unit mass of vapor (m¬≥/kg).</li>
                <li><strong>C·µ• (Specific Heat at Constant Volume):</strong> Heat required to raise the liquid temperature at constant volume (J/kg¬∑K).</li>
                <li><strong>ŒîT (Temperature Rise):</strong> Increase in liquid temperature during heating (K).</li>
                <li><strong>2.303:</strong> Conversion factor between natural and common logarithms used in thermodynamic calculations.</li>
            </ul>
        </div>

       
        <div class="note-card">
    <h3>‚úÖ Detailed Input Validation Rules</h3>
    <p>
        <strong>General principle:</strong> All inputs must be positive, numeric, and in the correct units.  
        If a value falls outside ‚Äútypical‚Äù engineering ranges, the calculator issues a 
        <span style="color:orange;font-weight:bold;">warning</span> (but still allows calculation if physically valid).  
        If a value is clearly implausible or non-physical, the calculation is blocked.
    </p>
    <ul class="note-list">
        <li>
            <strong>Constant External Heat Input (Q‚Çú) [W]:</strong>  
            Required, > 0. Typical range: <code>1√ó10¬≤ ‚Äì 1√ó10‚Å∏ W</code>.  
            ‚ö†Ô∏è Warning if > <code>2√ó10‚Å∑ W</code> (unusually high).  
            ‚ùå Reject if > <code>1√ó10‚Å∏ W</code> (likely input error).  
            Allowed decimals: up to 2.
        </li>
        <li>
            <strong>Latent Heat of Vaporization (h‚Çì‚Çê) [J/kg]:</strong>  
            Required, > 0. Typical range: <code>5√ó10‚Å¥ ‚Äì 6√ó10‚Å∂ J/kg</code>.  
            ‚ö†Ô∏è Warning if < <code>1√ó10‚Åµ</code> or > <code>3√ó10‚Å∂</code>.  
            Allowed decimals: up to 2.
        </li>
        <li>
            <strong>Specific Volume of Vapor (v‚Çì) [m¬≥/kg]:</strong>  
            Required, > 0. Typical vapor range: <code>0.01 ‚Äì 10 m¬≥/kg</code>.  
            ‚ùå Reject if < <code>1√ó10‚Åª‚Å∂</code>.  
            ‚ö†Ô∏è Warning if < <code>0.01</code> (dense vapor) or > <code>100</code> (extremely light vapor).  
            Allowed decimals: up to 6.
        </li>
        <li>
            <strong>Specific Heat at Constant Volume (C·µ•) [J/kg¬∑K]:</strong>  
            Required, > 0. Typical range: <code>100 ‚Äì 1√ó10‚Å¥ J/kg¬∑K</code>.  
            ‚ö†Ô∏è Warning if < 50 or > <code>2√ó10‚Å¥</code>.  
            Allowed decimals: up to 2.
        </li>
        <li>
            <strong>Temperature Rise (ŒîT) [K]:</strong>  
            Required, > 0. Typical range: <code>0.1 ‚Äì 500 K</code>.  
            ‚ö†Ô∏è Warning if < 0.1 K or > 300 K.  
            Allowed decimals: up to 2.
        </li>
        <li>
            <strong>Cross-field consistency:</strong>  
            Input combinations must make sense physically.  
            Examples: if vapor volume is very small but latent heat is also low, flag for unit mismatch.  
            Denominators that would cause unrealistic vent rates are blocked.
        </li>
    </ul>
</div>


      <div class="note-card">
    <h3>üìä Output Validations</h3>
    <ul class="note-list">
        <li>&lt; 0.05 kg/s</span> ‚Üí ‚ùå <strong>Critical risk.</strong> Venting may be insufficient; vessel overpressure possible. Immediate review required.</li>
        <li>0.05 ‚Äì 0.1 kg/s</span> ‚Üí üö® <strong>Low venting rate.</strong> Ensure vessel design and safety factors are verified before accepting this vent rate.</li>
        <li>0.1 ‚Äì 0.5 kg/s</span> ‚Üí ‚ö†Ô∏è <strong>Moderate venting rate.</strong> Suitable for small vessels; verify device characteristics and arrangement.</li>
        <li>‚â• 0.5 kg/s</span> ‚Üí ‚úÖ <strong>Adequate relief capacity.</strong> Venting rate appears sufficient for many applications; still confirm against relief device datasheet.</li>
    </ul>
</div>

<div class="note-card">
    <h3>‚öñÔ∏è Governing Principle</h3>
    <p>
        The formula used in all-liquid venting calculators for pressure relief devices is most commonly based on the 
        <strong>American Petroleum Institute (API)</strong> standard 
        <strong>API Recommended Practice 520, Part 1</strong>. 
        This standard provides a method for sizing and selecting pressure-relieving devices for equipment in the chemical process industries, 
        including liquid-only scenarios.
    </p>

    <h5>Key Points About This Standard for All-Liquid Relief Sizing</h5>
    <ul class="note-list">
        <li><strong>Widespread use:</strong> API 520 is the most widely used manual for sizing relief devices in the chemical and petroleum industries.</li>
        <li><strong>Calculation inputs:</strong> The calculations require information on the fluid properties (such as specific gravity and viscosity), the flow rate to be relieved, and the pressures involved (set pressure and backpressure).</li>
        <li><strong>Discharge coefficient:</strong> The API standard provides the discharge coefficient (<em>K<sub>d</sub></em>) value to use in the sizing equation. For liquid service, a value of 0.65 is typically considered.</li>
        <li><strong>Required orifice area:</strong> The primary objective of the calculation is to determine the minimum required flow area (<em>A</em>) for the relief device.</li>
        <li><strong>Viscosity considerations:</strong> For viscous liquids, the calculation first determines the required area for a non-viscous fluid and then applies a viscosity correction factor (<em>K<sub>v</sub></em>).</li>
    </ul>

    <h5>The ASME Code</h5>
    <p>
        The <strong>American Society of Mechanical Engineers (ASME)</strong> 
        <strong>Boiler and Pressure Vessel Code, Section VIII</strong>, is the construction code for pressure vessels and specifies 
        requirements for the pressure-relief devices protecting them. While ASME sets the overpressure protection requirements, 
        it relies on standards like API 520 for the actual sizing calculations.
    </p>
</div>


      <div class="note-card">
    <h3>Conclusion</h3>
    <p>
        Correct calculation of relief vent rates is essential to maintain vessel safety and prevent 
        dangerous pressure buildup. Accurate vent sizing ensures reliable pressure relief during 
        heating conditions and helps protect both equipment and personnel.
    </p>
</div>

    </div>
</div>

<script>
function calculateReliefVentRate() {
    // Read raw input strings
    const QTraw = document.getElementById('QT').value.trim();
    const hfaraw = document.getElementById('hfa').value.trim();
    const vfraw = document.getElementById('vf').value.trim();
    const Cvraw = document.getElementById('Cv').value.trim();
    const DTraw = document.getElementById('deltaT').value.trim();

    // UI elements
    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');
    const ventRateValue = document.getElementById('ventRateValue');
    const feedbackContent = document.getElementById('feedbackContent');

    // clear previous
    errorMessage.innerHTML = "";
    if (errorBox) errorBox.classList.add('hidden');

    const errors = [];
    const warnings = [];

    // Helper: decimal precision validators (string-based)
    function checkPrecision(raw, fieldName, maxDecimals) {
        if (raw.includes('.')) {
            const decimals = raw.split('.')[1].length;
            if (decimals > maxDecimals) {
                errors.push(`üëâ ${fieldName} must have at most ${maxDecimals} decimal place(s).`);
            }
        }
    }

    // --- Basic presence + numeric checks ---
    if (QTraw === "") errors.push("üëâ Please enter Constant External Heat Input (Q‚Çú) in W.");
    if (hfaraw === "") errors.push("üëâ Please enter Latent Heat of Vaporization (h‚Çì‚Çê) in J/kg.");
    if (vfraw === "") errors.push("üëâ Please enter Specific Volume of Vapor (v‚Çì) in m¬≥/kg.");
    if (Cvraw === "") errors.push("üëâ Please enter Specific Heat at Constant Volume (C·µ•) in J/kg¬∑K.");
    if (DTraw === "") errors.push("üëâ Please enter Temperature Rise (ŒîT) in K.");

    // Quick numeric parse
    const Q = parseFloat(QTraw);
    const H = parseFloat(hfaraw);
    const V = parseFloat(vfraw);
    const C = parseFloat(Cvraw);
    const DT = parseFloat(DTraw);

    if (QTraw !== "" && isNaN(Q)) errors.push("üëâ Constant External Heat Input (Q‚Çú) must be a number.");
    if (hfaraw !== "" && isNaN(H)) errors.push("üëâ Latent Heat of Vaporization (h‚Çì‚Çê) must be a number.");
    if (vfraw !== "" && isNaN(V)) errors.push("üëâ Specific Volume of Vapor (v‚Çì) must be a number.");
    if (Cvraw !== "" && isNaN(C)) errors.push("üëâ Specific Heat at Constant Volume (C·µ•) must be a number.");
    if (DTraw !== "" && isNaN(DT)) errors.push("üëâ Temperature Rise (ŒîT) must be a number.");

    // Precision checks
    if (QTraw !== "") checkPrecision(QTraw, "Constant External Heat Input (Q‚Çú)", 2);
    if (hfaraw !== "") checkPrecision(hfaraw, "Latent Heat of Vaporization (h‚Çì‚Çê)", 2);
    if (vfraw !== "") checkPrecision(vfraw, "Specific Volume of Vapor (v‚Çì)", 6);
    if (Cvraw !== "") checkPrecision(Cvraw, "Specific Heat at Constant Volume (C·µ•)", 2);
    if (DTraw !== "") checkPrecision(DTraw, "Temperature Rise (ŒîT)", 2);

    // If any parse errors, show and return
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove('hidden');
        if (placeholder) placeholder.classList.add('hidden');
        if (resultValue) resultValue.classList.add('hidden');
        return;
    }

    // --- Value-specific range checks ---
    // Q: 1e2 to 1e8 (soft/hard)
    if (!(Q > 0)) errors.push("üëâ Constant External Heat Input (Q‚Çú) must be greater than zero.");
    else {
        if (Q < 1e2) warnings.push("‚ö†Ô∏è Q‚Çú is very small (< 100 W). Confirm this is the total external heat input.");
        if (Q > 2e7) warnings.push("‚ö†Ô∏è Q‚Çú is large (> 20 MW). Confirm this heat input is intended for the evaluated vessel.");
        if (Q > 1e8) errors.push("üëâ Constant External Heat Input (Q‚Çú) exceeds 100 MW ‚Äî likely entry error.");
    }

    // hfa: 5e4 to 6e6
    if (!(H > 0)) errors.push("üëâ Latent Heat of Vaporization (h‚Çì‚Çê) must be greater than zero.");
    else {
        if (H < 5e4) warnings.push("‚ö†Ô∏è h‚Çì‚Çê is unusually small (< 50 kJ/kg) ‚Äî verify substance and units.");
        if (H > 6e6) warnings.push("‚ö†Ô∏è h‚Çì‚Çê is unusually large (> 6 MJ/kg) ‚Äî verify substance and units.");
    }

    // v: 1e-6 to 1e3 (but realistic vapour: 0.01 to 100)
    if (!(V > 0)) errors.push("üëâ Specific Volume of Vapor (v‚Çì) must be greater than zero.");
    else {
        if (V < 1e-6) errors.push("üëâ Specific Volume (v‚Çì) is extremely small ‚Äî likely incorrect units (liquid-specific volume?)");
        if (V < 0.01) warnings.push("‚ö†Ô∏è v‚Çì is small (< 0.01 m¬≥/kg). Ensure v‚Çì is the vapor specific volume at relieving conditions, not liquid specific volume.");
        if (V > 100) warnings.push("‚ö†Ô∏è v‚Çì is unusually large (> 100 m¬≥/kg). Verify units and relieving pressure.");
    }

    // C: 50 to 2e4
    if (!(C > 0)) errors.push("üëâ Specific Heat at Constant Volume (C·µ•) must be greater than zero.");
    else {
        if (C < 50) warnings.push("‚ö†Ô∏è C·µ• is unusually small (< 50 J/kg¬∑K). Verify units.");
        if (C > 20000) warnings.push("‚ö†Ô∏è C·µ• is unusually large (> 20,000 J/kg¬∑K). Verify units.");
    }

    // DT: 0.001 to 1000 (practical)
    if (!(DT > 0)) errors.push("üëâ Temperature Rise (ŒîT) must be greater than zero.");
    else {
        if (DT < 0.1) warnings.push("‚ö†Ô∏è ŒîT is very small (< 0.1 K) ‚Äî confirm this small temperature rise is intended.");
        if (DT > 500) warnings.push("‚ö†Ô∏è ŒîT is very large (> 500 K) ‚Äî verify scenario.");
    }

    // If any hard errors found
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove('hidden');
        if (placeholder) placeholder.classList.add('hidden');
        if (resultValue) resultValue.classList.add('hidden');
        return;
    }

    // --- Cross-field & denominator checks ---
    const denominator = (H / V) + (C * DT / 2.303);

    if (!isFinite(denominator) || isNaN(denominator)) {
        errorMessage.innerHTML = "‚ùå Denominator calculation failed (non-finite). Check inputs for unit consistency.";
        errorBox.classList.remove('hidden');
        if (placeholder) placeholder.classList.add('hidden');
        if (resultValue) resultValue.classList.add('hidden');
        return;
    }

    // Protect against tiny denominator
    const DENOM_EPS = 1e-6;
    if (Math.abs(denominator) < DENOM_EPS) {
        errorMessage.innerHTML = "‚ùå Denominator is too small ‚Äî check Specific Volume (v‚Çì) and Latent Heat (h‚Çì‚Çê). Small denominator leads to unrealistic vent rates.";
        errorBox.classList.remove('hidden');
        if (placeholder) placeholder.classList.add('hidden');
        if (resultValue) resultValue.classList.add('hidden');
        return;
    }

    // Compute W
    const W = Q / denominator;

    if (!isFinite(W) || isNaN(W)) {
        errorMessage.innerHTML = "‚ùå Computed vent rate is not finite. Check inputs.";
        errorBox.classList.remove('hidden');
        if (placeholder) placeholder.classList.add('hidden');
        if (resultValue) resultValue.classList.add('hidden');
        return;
    }

    // W plausibility checks
    if (W <= 0) {
        errorMessage.innerHTML = "‚ùå Computed vent rate is non-positive. Check inputs.";
        errorBox.classList.remove('hidden');
        if (placeholder) placeholder.classList.add('hidden');
        if (resultValue) resultValue.classList.add('hidden');
        return;
    }

    if (W > 1000) {
        errorMessage.innerHTML = "‚ùå Calculated vent rate exceeds 1000 kg/s. This is unrealistic for typical vessels. Recheck inputs.";
        errorBox.classList.remove('hidden');
        if (placeholder) placeholder.classList.add('hidden');
        if (resultValue) resultValue.classList.add('hidden');
        return;
    }

    // Display any warnings (non-blocking)
    let messageHtml = "";
    if (warnings.length > 0) {
        messageHtml += warnings.map(w => `<div style="color: #b87300;">${w}</div>`).join("");
    }

    // Render result
    ventRateValue.textContent = W.toFixed(4);
    feedbackContent.innerHTML = generateFeedback(W);

    if (messageHtml) {
        // Append warnings above result
        if (errorBox) {
            errorMessage.innerHTML = messageHtml;
            errorBox.classList.remove('hidden');
        }
    } else {
        if (errorBox) errorBox.classList.add('hidden');
    }

    if (placeholder) placeholder.classList.add('hidden');
    if (resultValue) resultValue.classList.remove('hidden');
}

/** Helper: generate textual engineering feedback on W (same thresholds as spec) */
function generateFeedback(W) {
    if (W < 0.05) {
        return "‚ùå <strong>Critical risk.</strong> Venting may be insufficient; vessel overpressure possible. Immediate review required.";
    } else if (W >= 0.05 && W < 0.1) {
        return "üö® <strong>Low venting rate.</strong> Ensure vessel design and safety factors are verified before accepting this vent rate.";
    } else if (W >= 0.1 && W < 0.5) {
        return "‚ö†Ô∏è <strong>Moderate venting rate.</strong> Suitable for small vessels; verify device characteristics and arrangement.";
    } else {
        return "‚úÖ <strong>Adequate relief capacity.</strong> Venting rate appears sufficient for many applications; still confirm against relief device datasheet.";
    }
}
</script>

    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}

<!-- Analysis & recommendations (QEHS / Fire Safety expert ‚Äî 50+ years)

Short version: your formula and UI are fine as a starting point, but to be safe and audit-ready we must (A) enforce strict input ranges/units and decimal precision, (B) check cross-field consistency (units and realistic combinations), (C) protect the calculation from division-by-zero / tiny-denominator problems, and (D) make the output meaningful with clear thresholds and flags. Below I provide (1) validated input rules, (2) output validation logic + threshold rationale, (3) edge-case handling, (4) corrected JavaScript validation + calculation code you can drop into your page (keeps your UI and flow intact), (5) test cases, and (6) brief compliance rationale for each rule.

1) Detailed input validation rules (real-world QEHS / fire-safety perspective)

General rule: All inputs must be positive, numeric, and in correct units. If a value falls outside ‚Äútypical‚Äù engineering bounds show a warning (orange) but allow calculation only if the combination is physically valid; if a value is implausible (very likely an input error), block calculation.

Constant External Heat Input (Q‚Çú) ‚Äî units: W

Required, numeric, > 0.

Typical acceptable range: 1e2 W (100 W) to 1e8 W (100 MW) depending on tank size/fire scenario.

Soft warning if Q‚Çú > 2√ó10‚Å∑ W (20 MW) ‚Äî flag as unusually large for routine vessels.

Hard reject if Q‚Çú > 1e8 W (100 MW) as likely entry error.

Allowed decimals: up to 2 decimal places (W usually integer but allow decimals).

Latent Heat of Vaporization (h‚Çì‚Çê) ‚Äî units: J/kg

Required, numeric, > 0.

Typical: liquids vary ‚Äî water ‚âà 2.256√ó10‚Å∂ J/kg, hydrocarbons lower (e.g., 3√ó10‚Åµ ‚Äì 2.5√ó10‚Å∂).

Suggested acceptable range: 5√ó10‚Å¥ J/kg (50 kJ/kg) to 6√ó10‚Å∂ J/kg (6 MJ/kg).

Soft warning if outside typical substance reference ranges (e.g., h‚Çì‚Çê < 1e5 or > 3e6).

Allowed decimals: up to 1‚Äì2 (integers are fine).

Specific Volume of Vapor (v‚Çì) ‚Äî units: m¬≥/kg

Required, numeric, > 0.

IMPORTANT: This must be the specific volume of the vapor (gas phase) at relieving conditions ‚Äî not the liquid specific volume. Typical ranges depend on the fluid and relieving pressure:

Typical engineering guideline for many vapours: 0.01 ‚Äî 10 m¬≥/kg (steam ~1‚Äì2 m¬≥/kg at moderate conditions; light hydrocarbons can be several m¬≥/kg).

Reject values < 1e-6 (obvious unit/magnitude error ‚Äî e.g., liquid-specific volume ~0.001 m¬≥/kg will often be wrong if used as vapor specific volume).

Soft warning if v‚Çì < 0.01 (very dense vapor ‚Äî verify units) or v‚Çì > 100 (extremely light vapor ‚Äî verify).

Allowed decimals: up to 6 (vapour volumes can be fractional).

Specific Heat at Constant Volume (C·µ•) ‚Äî units: J/kg¬∑K

Required, numeric, > 0.

Typical range for liquids and vapours: 100 ‚Äî 1e4 J/kg¬∑K. For liquids (water ~4.18e3 J/kg¬∑K); gases may differ.

Soft warning if < 50 or > 2e4.

Allowed decimals: up to 2.

Temperature Rise (ŒîT) ‚Äî units: K (or ¬∞C)

Required, numeric, > 0.

Engineering typical: 0.1 ‚Äî 500 K depending on scenario.

Soft warning if ŒîT > 300 K (very large heating) or ŒîT < 0.1 K (negligible ‚Äî might be input error).

Allowed decimals: up to 2.

Decimal precision / format checks

Use regex per field:

Q‚Çú: ^\d+(\.\d{1,2})?$

h‚Çì‚Çê: ^\d+(\.\d{1,2})?$

v‚Çì: ^\d+(\.\d{1,6})?$

C·µ•: ^\d+(\.\d{1,2})?$

ŒîT: ^\d+(\.\d{1,2})?$

Cross-field consistency

Denominator D = (h‚Çì‚Çê / v‚Çì) + (C·µ• * ŒîT / 2.303) must be positive and above a small engineering epsilon (e.g., D >= 1e-6) to avoid huge W and meaningless results.

If h‚Çì‚Çê / v‚Çì >> C·µ• * ŒîT / 2.303, it's acceptable ‚Äî just document the dominant term.

If v‚Çì is suspiciously small (<0.01) but h‚Çì‚Çê is also small, flag for review ‚Äî unit mismatch likely (e.g., entered liquid specific volume instead of vapour).

Output limits (W)

If W <= 0 ‚Üí block (non-physical).

If 0 < W < 0.05 kg/s ‚Üí flag critical/insufficient (very small vents).

If W > 1000 kg/s ‚Üí block or show hard warning ‚Äî likely input error or unrealistic scenario.

Acceptable design-level guidance shown to users (see thresholds in Output section).

2) Output validation logic & threshold explanations (why these thresholds)

W < 0.05 kg/s ‚Äî Critical/insufficient: normally indicates the vent will be too small for fire-size heating. In audits, such low values require confirmation of heat flux, vessel size, and calculation method.

0.05 ‚â§ W < 0.1 kg/s ‚Äî Low ‚Äî may be acceptable for small vessels but must be audited with safety factors and relief device characteristics.

0.1 ‚â§ W < 0.5 kg/s ‚Äî Moderate ‚Äî typical for small/medium vessels.

W ‚â• 0.5 kg/s ‚Äî Adequate ‚Äî generally acceptable for many designs; still compare with relief device minimum flows and vessel geometry.

W > 1000 kg/s ‚Äî Unrealistic / Danger of input error ‚Äî block calculation or require confirmation and documentation.

Rationale: These thresholds map to how relief devices are selected and how inspection/audit teams review vent sizing. Very small computed rates often point to incorrect input units or missing heat loads; very large computed rates often indicate a tiny denominator (division by near-zero) or an incorrect specific volume/latent heat.

3) Edge-case validations (and handling)

Division by zero / tiny denominator

If denominator < 1e-6, block and show a clear message: "Denominator is too small ‚Äî check specific volume (v‚Çì) and latent heat (h‚Çì‚Çê). Small denominator leads to unrealistic vent rates."

Liquid specific volume used for v‚Çì

If v‚Çì < 0.01 m¬≥/kg and h‚Çì‚Çê is typical of vapour-phase numbers, warn: "Specific volume appears to be liquid-phase magnitude ‚Äî ensure v‚Çì is vapor specific volume at relieving conditions." If user confirms, allow but show strong audit note.

Inconsistent units / magnitude mismatch

If h‚Çì‚Çê < 1e4 and v‚Çì > 1.0 (rare combination), flag for review ‚Äî unusual physical combination that could produce unrealistic W.

Extremely high Q with small denominator

If Q > 2e7 and denominator < 1e2, produce hard warning: "Very large heat input + small denominator => computed W may be dangerously large; verify all input units and relief device feasibility."

Non-finite results

If W is NaN, Infinity, or !isFinite(W), block and show error.

Negative W

Block and show: "Negative vent rate ‚Äî non-physical. Check inputs."

Precision/rounding

Display W to 4 decimal places (as you already do). For audit logs include raw inputs and computed unrounded W too (for traceability).

4) Why each validation matters (compliance & safety rationale)

Positive-only checks: Negative heat, negative latent heat, negative volumes are non-physical and indicate data entry mistakes. Allowing them can produce misleading 'safe' outputs and dangerous design decisions.

Magnitude limits (soft/hard): Protects designers and auditors from acting on extreme results due to unit errors. Safety decisions rely on credible inputs; the calculator must enforce plausibility.

Decimal/precision limits: Keeps user entries consistent with reporting standards; excessive decimals can indicate unit confusion.

Cross-field checks: Many calculation errors arise from unit mixing (e.g., using liquid specific volume instead of vapour). Cross-field validations catch these.

Denominator checks: Avoids division-by-zero and runaway outputs that would otherwise lead to oversizing/undersizing relief devices.

Output thresholds: Provide engineering context and flag results needing further verification, consistent with prudent QEHS practice. -->