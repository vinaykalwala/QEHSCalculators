{% extends 'base.html' %}
{% block title %}Stem Force Required To Close A Control Valve Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stem Force Required To Close a Control Valve Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
                .btn-container {
    display: flex;
    justify-content: center; /* Horizontally center */
    margin: 30px 0;
}

.back-btn {
    background:linear-gradient(#1560bd,#000040); /* Dark navy background */
    color: #ffffff; /* White text */
    border: 2px solid #1560bd; /* Highlight border */
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none; /* Remove underline for link */
    transition: all 0.3s ease;
    cursor: pointer;
}

.back-btn:hover {
    background-color: #1560bd; /* Highlight on hover */
    color: #ffffff;
    border-color: #000040;
    transform: scale(1.05); /* Subtle hover effect */
}

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            {% comment %} max-width: 700px; {% endcomment %}
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            height: 420px;
            overflow-y: auto;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            {% comment %} display: flex; {% endcomment %}
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
      
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
    <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
</div>
   <div class="calculator-container printable" id="printArea">

    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Stem Force Required To Close A Control Valve Calculator</h1>
            <p>Calculate the force needed to close a control valve based on orifice diameter and differential pressure</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="diameter">Valve Orifice Diameter (d) in mm</label>
                    <input type="number" id="diameter" class="form-input" min="0" step="0.01" placeholder="e.g., 50">
                </div>
                <div class="form-group">
                    <label for="pressure">Differential Pressure (ΔP) in bar</label>
                    <input type="number" id="pressure" class="form-input" min="0" step="0.01" placeholder="e.g., 10">
                </div>
                
                <button class="calculate-btn" onclick="calculateForce()">Calculate Force</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="{% static 'images/resultimage.png' %}" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Stem Force Required To Close a Control Valve</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd; margin-top:30px;">
                        <h2>Stem Force Required</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Newtons (N)</div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low</span><span>Moderate</span><span>High</span><span>Very High</span><span>Extreme</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title"> Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

<!-- Notes Section -->
<div class="note-section">

    <!-- About -->
    <div class="note-card">
        <h3>📘 About This Calculator</h3>
        <p>
            The <strong>Stem Force Required To Close a Control Valve Calculator</strong> determines the force needed to close a control valve based on the valve orifice diameter and the differential pressure across it. This calculation is essential for designing and selecting appropriate actuators and ensuring safe operation in pressurized systems.
        </p>
    </div>

    <!-- Parameters Used -->
    <div class="note-card">
        <h3>⚙ Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Valve Orifice Diameter (d):</strong> The opening size of the valve in millimeters (mm). Larger diameters require more force to close.</li>
            <li><strong>Differential Pressure (ΔP):</strong> The pressure difference across the valve in bar. A higher ΔP means a greater force is needed to close the valve.</li>
            <li><strong>Constant 40:</strong> A scaling factor used to keep force values in a practical range, based on industry standards.</li>
        </ul>
    </div>

    <!-- Input Validation Rules -->
    <div class="note-card">
        <h3>✅ Input Validations</h3>
        <ul class="note-list">
            <li><b>Diameter:</b> Must be greater than 0 mm. A zero or negative diameter is physically impossible.</li>
            <li><b>Differential Pressure:</b> Must be greater than 0 bar. A pressure difference is necessary for the valve to operate.</li>
            <li><b>Data Type:</b> Both values must be numerical (decimal values allowed).</li>
            <li><b>Realistic Ranges:</b> Diameter typically 10-500 mm, pressure 0.1-100 bar for most industrial applications.</li>
        </ul>
    </div>

    <!-- Output Validations -->
    <div class="note-card">
        <h3>📊 Output Validations</h3>
        <p>
            The <strong>Stem Force Required</strong> is interpreted using the following thresholds:
        </p>
        <ul class="note-list">
            <li><strong>F &lt; 10 N:</strong> ⚠️ Low force - valve may not close properly under pressure</li>
            <li><strong>10 N ≤ F &lt; 100 N:</strong> ✅ Normal operating range - adequate force for most applications</li>
            <li><strong>100 N ≤ F &lt; 1000 N:</strong> 🔵 High force - may require mechanical advantage or powered actuator</li>
            <li><strong>1000 N ≤ F &lt; 5000 N:</strong> ⚠️ Very high force - specialized equipment needed</li>
            <li><strong>F ≥ 5000 N:</strong> ❌ Extreme force - check valve durability and system design</li>
        </ul>
    </div>
<div class="note-card">
    <h3>📐 Governing Principle</h3>
    <p>
        The calculations for the required stem force to close a control valve are governed by the harmonized international standards of the International Society of Automation (ISA) and the International Electroteychical Commission (IEC). The relevant standards are:
    </p>
    <ul class="note-list">
        <li><b>ISA-75.01.01</b></li>
        <li><b>IEC 60534-2-1</b></li>
    </ul>
    <p>
        These two standards are functionally equivalent and may be used interchangeably.
    </p>

    <h3 style="margin-top:12px; color:#1976d2;">Key Factors in Stem Force Calculation</h3>
    <p>
        A calculator for determining stem force considers several critical factors outlined in the ISA/IEC standards:
    </p>
    <ul class="note-list">
        <li><b>Differential pressure:</b> The force exerted by the fluid pressure on the valve plug, which acts against the closing force.</li>
        <li><b>Fluid properties:</b> The standards provide sizing equations for different fluid types, such as incompressible fluids (liquids) and compressible fluids (gases, vapors, and steam).</li>
        <li><b>Valve characteristics:</b> Valve-specific factors, such as the flow coefficient (C<sub>v</sub> or K<sub>v</sub>), valve trim, and pressure recovery factor, are used in the sizing equations to determine the force required.</li>
        <li><b>Frictional forces:</b> The force required to overcome friction from the packing and other valve components must be included.</li>
        <li><b>Seat loading:</b> The force required to create a tight seal between the valve plug and the seat, which is determined by the valve's shut-off classification.</li>
    </ul>

    <h3 style="margin-top:12px; color:#1976d2;">Supporting Standards and Practices</h3>
    <p>
        Beyond the core sizing equations, other related standards provide additional context for control valve design and performance, including aspects that influence stem force. These include:
    </p>
    <ul class="note-list">
        <li><b>ISA-75.04 (Technical Report):</b> Provides guidance on valve position stability, which is influenced by frictional forces and actuator performance.</li>
        <li><b>ISA-96.02.01 (Electric Actuators) and ISA-96.03.02 (Pneumatic Actuators):</b> These standards detail sizing criteria and specifications for actuators, which are the components that provide the force to move the valve stem.</li>
        <li><b>ISA-75.23 (Recommended Practice):</b> Addresses cavitation, a phenomenon that can create hydrodynamic forces that affect stem force in liquid applications.</li>
    </ul>
</div>
<div class="note-card">
  <h3>💡 Conclusion</h3>
  <p>
    The <strong>Stem Force Required To Close a Control Valve Calculator</strong> helps determine the closing force needed based on the <strong>valve orifice diameter</strong> and <strong>differential pressure</strong>. 
    This ensures accurate actuator sizing and safe valve operation under pressurized conditions. 
    By validating inputs and interpreting results through standardized ranges, engineers can ensure <strong>reliable control performance</strong>, <strong>system safety</strong>, and <strong>mechanical integrity</strong> across industrial applications.
  </p>
</div>

</div>


    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateForce() {
    const diameter = document.getElementById('diameter').value.trim();
    const pressure = document.getElementById('pressure').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];

    // --- Input Validations (based on QEHS, NFPA, API, ISO standards) ---

    // Diameter (Valve Orifice Diameter, d in mm)
    if (diameter === "" || isNaN(diameter)) {
        errors.push("👉 Please enter the valve orifice diameter (mm).");
    } else if (parseFloat(diameter) <= 0) {
        errors.push("👉 Diameter must be greater than 0 mm. Zero or negative is impossible.");
    } else if (parseFloat(diameter) < 10) {
        errors.push("👉 Diameter is too small (<10 mm). Outside typical industrial design range.");
    } else if (parseFloat(diameter) > 1000) {
        errors.push("👉 Diameter exceeds 1000 mm. Special design engineering is required.");
    }

    // Pressure (Differential Pressure, ΔP in bar)
    if (pressure === "" || isNaN(pressure)) {
        errors.push("👉 Please enter the differential pressure (bar).");
    } else if (parseFloat(pressure) <= 0) {
        errors.push("👉 Differential pressure must be greater than 0 bar.");
    } else if (parseFloat(pressure) < 0.1) {
        errors.push("👉 Differential pressure too low (<0.1 bar). May not provide meaningful closure force.");
    } else if (parseFloat(pressure) > 1000) {
        errors.push("👉 Differential pressure cannot exceed 1000 bar. Outside valve safety standards.");
    }

    // --- Error Handling ---
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // --- Safe Calculations ---
    const d = parseFloat(diameter);
    const deltaP = parseFloat(pressure);

    // Formula used:
    // F = (π * d² / 40) * ΔP
    // d in mm, ΔP in bar
    const force = (Math.PI * Math.pow(d, 2) / 40) * deltaP;

    // Display result
    document.getElementById('rateValue').textContent = force.toFixed(2);

    // --- Output Thresholds (Force Assessment) ---
    const meterFill = document.getElementById('meterFill');
    let meterWidth, meterColor, feedback;

    if (force < 10) {
        meterWidth = '10%'; 
        meterColor = '#e74c3c';
        feedback = '⚠️ Low force - valve may not close properly under pressure.';
    } else if (force < 100) {
        meterWidth = '30%'; 
        meterColor = '#2ecc71';
        feedback = '✅ Normal operating range - adequate force for most applications.';
    } else if (force < 1000) {
        meterWidth = '60%'; 
        meterColor = '#f1c40f';
        feedback = '🔵 High force - may require mechanical advantage or powered actuator.';
    } else if (force < 5000) {
        meterWidth = '80%'; 
        meterColor = '#e67e22';
        feedback = '⚠️ Very high force - specialized equipment needed.';
    } else {
        meterWidth = '95%'; 
        meterColor = '#c0392b';
        feedback = '❌ Extreme force - check valve durability and system design.';
    }

    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;
    document.getElementById('feedbackContent').innerHTML = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>

</body>
</html>
{% endblock %}