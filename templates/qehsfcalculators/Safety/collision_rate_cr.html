{% extends 'base.html' %}
{% block title %}Collision Rate Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collision Rate Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
             /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (min-width: 901px) {
            .calc-content { 
                flex-direction: row; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
            order: 2;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Input rows for side-by-side fields */
        .input-row {
            {% comment %} display: flex; {% endcomment %}
            flex-direction: column;
            gap: 15px;
            {% comment %} margin-bottom: 15px; {% endcomment %}
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }

        /* Mobile-specific adjustments */
        @media (max-width: 320px) {
            .calculator-container {
                padding: 10px;
            }
            
            .calculator-header h1 {
                font-size: 1.8rem;
            }
            
            .calculator-header p {
                font-size: 16px;
            }
            
            .calc-card, .result-card {
                padding: 20px 15px;
                border-radius: 12px;
            }
            
            .calc-card h2 {
                font-size: 1.4rem;
            }
            
            .form-input {
                padding: 12px 14px;
                font-size: 14px;
            }
            
            .calculate-btn {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .result-placeholder img {
                max-width: 180px;
            }
            
            .rate-value {
                font-size: 36px;
            }
            
            .meter-labels span {
                font-size: 10px;
            }
            
            .note-card {
                padding: 15px 18px;
            }
            
            .note-card h3 {
                font-size: 16px;
            }
            
            .note-card p, .note-card li {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Collision Rate (CR) Calculator</h1>
            <p>Calculate the frequency of crashes at intersections or road segments per million vehicles</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Enter Data</h2>
        
                    <div class="form-group">
                        <label for="crashes">Number of Crashes (A)</label>
                        <input type="number" id="crashes" class="form-input" min="0" placeholder="e.g., 15">
                        <span class="error" id="crashesError"></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="AADT">Annual Average Daily Traffic (V)</label>
                        <input type="number" id="AADT" class="form-input" min="0" placeholder="e.g., 12000">
                        <span class="error" id="AADTError"></span>
                    </div>
            
                    <div class="form-group">
                        <label for="days">Number of Days in Analysis Period (D)</label>
                        <input type="number" id="days" class="form-input" min="0" placeholder="e.g., 365">
                        <span class="error" id="daysError"></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="years">Time in Years (T)</label>
                        <input type="number" id="years" class="form-input" min="0" step="0.1" placeholder="e.g., 1">
                        <span class="error" id="yearsError"></span>
                    </div>
            
                
                <button class="calculate-btn" onclick="calculateCR()">Calculate Collision Rate (CR)</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                   <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">

                    <p>This tool will calculate the <strong>Collision Rate (CR)</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                    
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Collision Rate</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold; ">CR Value</div>
                    </div>
                    <div class="rate-label">crashes per million vehicles</div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low Risk</span>
                        <span>Moderate</span>
                        <span>High Risk</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Road Safety Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    The <strong>Collision Rate (CR) Calculator</strong> is a tool used in transportation safety to measure the frequency of vehicle crashes at a specific location, such as an intersection or a stretch of road. It standardizes the crash data by considering the traffic volume, allowing for a fair comparison between different locations. The result is typically expressed as the number of crashes per million entering vehicles, providing a clear indicator of potential safety issues.
                </p>
            </div>

            <div class="note-card">
                <h3>‚öôÔ∏è Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Number of Crashes (A):</strong> The total count of crashes that occurred at the location during the specified analysis period.</li>
                    <li><strong>Annual Average Daily Traffic (V):</strong> The average number of vehicles that pass through the location each day.</li>
                    <li><strong>Number of Days in Analysis Period (D):</strong> The duration of the study period in days.</li>
                    <li><strong>Time in Years (T):</strong> The total duration of the analysis period, expressed in years.</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>‚úÖ Input Validation Rules</h3>
                <ul class="note-list">
                    <li><strong>Number of Crashes:</strong> Must be zero or a positive integer.</li>
                    <li><strong>AADT, Days, and Years:</strong> Must be positive numbers. Division by zero is not permitted, so these values cannot be zero.</li>
                    <li><strong>Data Consistency:</strong> The number of days and years should reflect a realistic timeframe for the collected crash data. The tool flags unusually high values for review.</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>Output Validations</h3>
                <p>The road safety assessment provides a qualitative interpretation of the calculated CR value:</p>
                <ul class="note-list">
                    <li> (CR < 50) ‚úÖ Low risk: Area is relatively safe.</li>
                    <li> (CR 50 - 150) ‚ö†Ô∏è Moderate risk: Periodic monitoring recommended.</li>
                    <li> (CR > 150) ‚ùå High risk: Safety improvements required.</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>Governing Principle</h3>
                <p>While the term "Collision Rate (CR) Calculator" isn't tied to a single, specific standard, its application and calculation depend heavily on the industry and field of study. For analyzing vehicle collisions, the calculation is based on formulas using specific crash data from sources like the <strong>National Highway Traffic Safety Administration (NHTSA)</strong> in the United States. Safety consultants often calculate their own collision rates to benchmark performance. For industrial accidents, the calculation is defined by standards from the <strong>Occupational Safety and Health Administration (OSHA)</strong>. In India, the <strong>Bureau of Indian Standards (BIS)</strong> sets the relevant standards.</p>
            </div>

            <div class="note-card">
                <h3>Conclusion</h3>
                <p>
                    The Collision Rate is a fundamental metric in road safety management, providing an objective basis for identifying hazardous locations, evaluating the effectiveness of safety interventions, and prioritizing resources to reduce traffic-related injuries and fatalities. This calculator offers a straightforward method for this analysis, but the results should always be considered in the context of other factors, such as crash severity and road design, in line with guidelines from authorities like the FHWA and ISO 39001.
                </p>
            </div>

        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateCR() {
            const crashes = document.getElementById('crashes').value.trim();
            const AADT = document.getElementById('AADT').value.trim();
            const days = document.getElementById('days').value.trim();
            const years = document.getElementById('years').value.trim();

            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValue = document.getElementById('resultValue');

            let errors = [];

            // Validate Crashes (A)
            if (crashes === "") {
                errors.push("üëâ Please enter Number of Crashes (A).");
                document.getElementById('crashesError').textContent = 'Required';
            } else {
                const A = parseFloat(crashes);
                if (isNaN(A) || A < 0) {
                    errors.push("üëâ Crashes must be ‚â• 0.");
                    document.getElementById('crashesError').textContent = 'Must be ‚â• 0';
                } else if (A > 1000) {
                    errors.push("üëâ Crashes unusually high (>1000). Verify input.");
                } else {
                    document.getElementById('crashesError').textContent = '';
                }
            }

            // Validate AADT (V)
            if (AADT === "") {
                errors.push("üëâ Please enter AADT (V).");
                 document.getElementById('AADTError').textContent = 'Required';
            } else {
                const V = parseFloat(AADT);
                if (isNaN(V) || V <= 0) {
                    errors.push("üëâ AADT must be > 0.");
                     document.getElementById('AADTError').textContent = 'Must be > 0';
                } else if (V < 100 || V > 100000) {
                    errors.push("üëâ AADT should typically be between 100‚Äì100,000 vehicles/day.");
                } else {
                    document.getElementById('AADTError').textContent = '';
                }
            }

            // Validate Days (D)
            if (days === "") {
                errors.push("üëâ Please enter Number of Days (D).");
                 document.getElementById('daysError').textContent = 'Required';
            } else {
                const D = parseFloat(days);
                if (isNaN(D) || D <= 0) {
                    errors.push("üëâ Days must be > 0.");
                    document.getElementById('daysError').textContent = 'Must be > 0';
                } else if (D > 3650) {
                    errors.push("üëâ Days unusually high (>3650). Verify input.");
                } else {
                    document.getElementById('daysError').textContent = '';
                }
            }

            // Validate Years (T)
            if (years === "") {
                errors.push("üëâ Please enter Time in Years (T).");
                document.getElementById('yearsError').textContent = 'Required';
            } else {
                const T = parseFloat(years);
                if (isNaN(T) || T <= 0) {
                    errors.push("üëâ Time in Years must be > 0.");
                    document.getElementById('yearsError').textContent = 'Must be > 0';
                } else if (T > 10) {
                    errors.push("üëâ Years unusually high (>10). Verify input.");
                } else {
                    document.getElementById('yearsError').textContent = '';
                }
            }

            // Show Errors
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValue.classList.add("hidden");
                return;
            } else {
                errorBox.classList.add("hidden");
            }

            // Perform Calculation
            const A = parseFloat(crashes);
            const V = parseFloat(AADT);
            const D = parseFloat(days);
            const T = parseFloat(years);

            const CR = (A * 1e6) / (V * D * T);

            if (isNaN(CR) || !isFinite(CR)) {
                errorMessage.innerHTML = "‚ùå Invalid calculation result. Please check inputs.";
                errorBox.classList.remove("hidden");
                resultValue.classList.add("hidden");
                return;
            }

            // Display Result
            document.getElementById('rateValue').textContent = CR.toFixed(2);

            // Road Safety Assessment
            const meterFill = document.getElementById('meterFill');
            let feedback, meterWidth, meterColor;

            if (CR < 50) {
                feedback = "<span class='good'>‚úÖ Low risk: Area is relatively safe.</span>";
                meterWidth = "20%"; meterColor = "#2ecc71";
            } else if (CR < 150) {
                feedback = "<span class='average'>‚ö†Ô∏è Moderate risk: Periodic monitoring recommended.</span>";
                meterWidth = "50%"; meterColor = "#f39c12";
            } else {
                feedback = "<span class='bad'>‚ùå High risk: Safety improvements required.</span>";
                meterWidth = "90%"; meterColor = "#e74c3c";
            }

            meterFill.style.width = meterWidth;
            meterFill.style.backgroundColor = meterColor;
            document.getElementById('feedbackContent').innerHTML = feedback;

            placeholder.classList.add("hidden");
            resultValue.classList.remove("hidden");
        }


        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}



{% comment %} 
1. üìò Formula Used

The standard formula in traffic safety studies is:

ùê∂
ùëÖ
=
ùê¥
√ó
10
6
ùëâ
√ó
ùê∑
√ó
ùëá
CR=
V√óD√óT
A√ó10
6
	‚Äã


Where:

A = Number of crashes

V = Annual Average Daily Traffic (AADT, vehicles/day)

D = Number of days in the analysis period

T = Analysis period in years

üîé This gives CR in ‚Äúcollisions per million entering vehicles‚Äù ‚Äî a globally recognized KPI for road safety engineering.

2. ‚úÖ Input Validation Rules (QEHS/Traffic Safety Standards)

Number of Crashes (A):

Must be ‚â• 0 (no negative crashes).

Typical range: 0‚Äì1000 for most intersections.

If >1000 ‚Üí flag as abnormal.

Annual Average Daily Traffic (V):

Must be > 0.

Typical range: 100‚Äì100,000 vehicles/day.

If <100 or >100,000 ‚Üí flag for verification (too low or too high).

Number of Days (D):

Must be > 0.

Maximum = 3650 (10 years of data).

If >3650 ‚Üí flag as unrealistic.

Time in Years (T):

Must be > 0.

Typical range: 0.1‚Äì10 years.

If >10 ‚Üí unusual ‚Üí flag for review.

3. ‚ö†Ô∏è Edge Case Validations

Division by zero: If any of V, D, or T = 0 ‚Üí block calculation.

A = 0 ‚Üí Valid, result CR = 0 (safe).

Very small inputs: e.g., V < 100 ‚Üí CR will be abnormally inflated. Warn user.

Extremely high CR (>1000) ‚Üí outlier, suggest data review.

4. üìä Output Validation & Thresholds

Based on traffic engineering & road safety audits:

CR < 50 ‚Üí ‚úÖ Low risk ‚Üí Area is relatively safe.

50 ‚â§ CR < 150 ‚Üí ‚ö†Ô∏è Moderate ‚Üí Monitor, consider minor safety interventions.

CR ‚â• 150 ‚Üí ‚ùå High risk ‚Üí Needs immediate safety improvements.

These thresholds are consistent with FHWA (Federal Highway Administration, USA) & global road safety guidelines.

5. üîß Corrected JavaScript Code (with Compliance Comments)
/*
üìò Formula:
CR = (A √ó 10^6) / (V √ó D √ó T)

‚úÖ Validation Rules (Real-World Standards):
- A (Number of Crashes): ‚â•0, typically ‚â§1000
- V (AADT): >0, typically 100‚Äì100,000 vehicles/day
- D (Days): >0, typically ‚â§3650 (10 years)
- T (Years): >0, typically 0.1‚Äì10 years
- No division by zero

‚ö†Ô∏è Edge Cases:
- A=0 ‚Üí CR=0 (valid, safe condition)
- V, D, or T=0 ‚Üí invalid
- Extreme CR (>1000) ‚Üí flag as unrealistic
*/ {% endcomment %}