{% extends 'base.html' %}
{% block title %}ASME (API RP 520) Valves - Bellows Balanced Valves{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASME (API RP 520) Valves - Bellows Balanced Valves</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 12px;
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            {% comment %} max-width: 700px; {% endcomment %}
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            {% comment %} display: flex; {% endcomment %}
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
       
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Error messages */
        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: block;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
   <div class="calculator-container printable" id="printArea">

    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>ASME (API RP 520) Valves - Bellows Balanced Valves</h1>
            <p>Calculate the percentage of gauge backpressure in pressure relief valves</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="pb"><strong>Backpressure (Pb) in psig:</strong></label>
                    <input type="number" id="pb" class="form-input" min="0" step="0.01" placeholder="e.g., 150.5">
                    <span class="error" id="pbError"></span>
                </div>
                <div class="form-group">
                    <label for="ps"><strong>Set Pressure (Ps) in psig:</strong></label>
                    <input type="number" id="ps" class="form-input" min="0" step="0.01" placeholder="e.g., 300.0">
                    <span class="error" id="psError"></span>
                </div>
                
                <button class="calculate-btn" onclick="calculateBackpressure()">Calculate Backpressure Percentage</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/9110/9110939.png" 
     alt="Bellows balanced valve illustration">
                    <p>This tool calculates the <strong>percentage of gauge backpressure</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Backpressure Percentage</h2>
                    </div>
                    <div class="rate-display">
                    <div class="rate-value" id="rateValue">0.00</div>
                    <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Percentage of Gauge Backpressure</div></div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Optimal</span><span>Acceptable</span><span>Caution</span><span>High</span><span>Critical</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">System Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>📘 About This Calculator</h3>
                <p>
                    The <strong>ASME (API RP 520) Bellows Balanced Valves Calculator</strong> helps determine the 
                    percentage of gauge backpressure in pressure relief valves. This calculation is essential 
                    for ensuring proper valve functioning and system safety.
                </p>
            </div>

            <div class="note-card">
                <h3>❓ What is Backpressure Percentage?</h3>
                <p>Backpressure percentage is the ratio of backpressure (Pb) to set pressure (Ps), multiplied by 100. 
                It indicates how much pressure exists on the discharge side of the relief valve relative to its opening pressure.</p>
            </div>

            <div class="note-card">
                <h3>⚙️ Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Pb (Backpressure):</strong> The pressure that exists on the discharge side of the relief valve (measured in psig).</li>
                    <li><strong>Ps (Set Pressure):</strong> The pressure at which the relief valve is designed to open (measured in psig).</li>
                </ul>
            </div>
            
            
            <div class="note-card">
                <h3>📊 Interpretation</h3>
                <p>
                    <b>Lower percentages</b> indicate safer operating conditions. Generally:
                </p>
                <ul class="note-list">
                    <li><span class="good">Below 10%</span> → Optimal performance</li>
                    <li><span class="average">10% – 30%</span> → Acceptable but monitor regularly</li>
                    <li><span class="bad">Above 30%</span> → Requires attention and possible adjustment</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>🏭 ASME (API RP 520) Standards</h3>
                <p>
                    <strong>ASME (API RP 520)</strong> stands for American Society of Mechanical Engineers (American Petroleum Institute Recommended Practice 520). 
                    It provides guidelines for designing and installing pressure relief systems to protect equipment from excessive pressure 
                    in industries like oil & gas and chemical processing.
                </p>
            </div>

            <div class="note-card">
                <h3>🌐 Real-Life Applications</h3>
                <ul class="note-list">
                    <li><strong>Industrial Safety:</strong> Ensures relief valves open correctly to prevent overpressure failures.</li>
                    <li><strong>Fire Protection Systems:</strong> Helps maintain proper pressure in emergency venting systems.</li>
                    <li><strong>HVAC & Gas Pipelines:</strong> Used in ventilation and gas distribution networks for safety compliance.</li>
                    <li><strong>Oil & Gas Industry:</strong> Monitors and controls backpressure in refinery and storage units.</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>✅ Input Validation & Feedback</h3>
                <ul class="note-list">
                    <li><strong>Pb cannot be negative:</strong> Backpressure cannot be a negative value in real-world applications.</li>
                    <li><strong>Ps must be greater than zero:</strong> A zero set pressure means the valve has no threshold to open.</li>
                    <li><strong>Pb should not exceed Ps:</strong> If Pb > Ps, the system might fail to relieve pressure, causing safety issues.</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>📝 Conclusion</h3>
                <p>
                    Maintaining an optimal <strong>backpressure-to-set-pressure ratio</strong> is essential for the safety and efficiency 
                    of pressure relief systems. If <strong>backpressure is too high</strong>, it may cause valve malfunction, leading to 
                    hazardous conditions. Regular monitoring and compliance with <strong>ASME/API RP 520 standards</strong> ensure system reliability.
                </p>
            </div>
        </div>

    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateBackpressure() {
            const pb = document.getElementById('pb').value.trim();
            const ps = document.getElementById('ps').value.trim();

            const pbError = document.getElementById('pbError');
            const psError = document.getElementById('psError');
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValue = document.getElementById('resultValue');

            // Reset errors
            pbError.innerText = "";
            psError.innerText = "";
            errorBox.classList.add("hidden");
            
            let errors = [];

            if (pb === "") {
                errors.push("👉 Please enter the backpressure value.");
                pbError.innerText = "Backpressure is required.";
            } else if (parseFloat(pb) < 0) {
                errors.push("👉 Backpressure must be a positive number.");
                pbError.innerText = "Backpressure must be positive.";
            }
            
            if (ps === "") {
                errors.push("👉 Please enter the set pressure value.");
                psError.innerText = "Set pressure is required.";
            } else if (parseFloat(ps) <= 0) {
                errors.push("👉 Set pressure must be greater than zero.");
                psError.innerText = "Set pressure must be greater than zero.";
            }

            if (errors.length > 0) {
                // Show error box
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValue.classList.add("hidden");
                return;
            }

            const pbVal = parseFloat(pb);
            const psVal = parseFloat(ps);
            
            if (pbVal > psVal) {
                errorMessage.innerHTML = "⚠️ Warning: Backpressure is greater than set pressure. This may indicate a system problem.";
                errorBox.classList.remove("hidden");
            }

            const percentage = (pbVal / psVal) * 100;
            document.getElementById('rateValue').textContent = percentage.toFixed(2) + "%";

            const meterFill = document.getElementById('meterFill');
            let meterWidth, meterColor, feedback;
            
            if (percentage < 10) {
                meterWidth = '20%'; meterColor = '#27ae60';
                feedback = '✅ Optimal backpressure percentage. Your system is operating within safe parameters.';
            } else if (percentage < 20) {
                meterWidth = '40%'; meterColor = '#2ecc71';
                feedback = '👍 Acceptable backpressure percentage. Continue monitoring system performance.';
            } else if (percentage < 30) {
                meterWidth = '60%'; meterColor = '#f39c12';
                feedback = '⚠️ Moderate backpressure percentage. Consider monitoring more frequently and planning for adjustments.';
            } else if (percentage < 50) {
                meterWidth = '80%'; meterColor = '#e67e22';
                feedback = '🚨 High backpressure percentage. Review system configuration and consider corrective actions.';
            } else {
                meterWidth = '95%'; meterColor = '#e74c3c';
                feedback = '❌ Critical backpressure percentage. Immediate system review and corrective measures required.';
            }

            meterFill.style.width = meterWidth;
            meterFill.style.backgroundColor = meterColor;
            document.getElementById('feedbackContent').textContent = feedback;

            placeholder.classList.add('hidden');
            resultValue.classList.remove('hidden');
            errorBox.classList.add('hidden');
        }

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>

</body>
</html>
{% endblock %}