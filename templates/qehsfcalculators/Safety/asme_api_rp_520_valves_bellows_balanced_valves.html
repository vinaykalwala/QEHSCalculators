{% extends 'base.html' %}
{% block title %}ASME (API RP 520) Valves - Bellows Balanced Valves{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASME (API RP 520) Valves - Bellows Balanced Valves</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 12px;
        }
                .btn-container {
    display: flex;
    justify-content: center; /* Horizontally center */
    margin: 30px 0;
}

.back-btn {
    background:linear-gradient(#1560bd,#000040); /* Dark navy background */
    color: #ffffff; /* White text */
    border: 2px solid #1560bd; /* Highlight border */
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none; /* Remove underline for link */
    transition: all 0.3s ease;
    cursor: pointer;
}

.back-btn:hover {
    background-color: #1560bd; /* Highlight on hover */
    color: #ffffff;
    border-color: #000040;
    transform: scale(1.05); /* Subtle hover effect */
}

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            {% comment %} max-width: 700px; {% endcomment %}
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            height: 420px;
            overflow-y: auto;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            {% comment %} display: flex; {% endcomment %}
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
       
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Error messages */
        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: block;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
    <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
</div>
   <div class="calculator-container printable" id="printArea">

    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>ASME (API RP 520) Valves - Bellows Balanced Valves</h1>
            <p>Calculate the percentage of gauge backpressure in pressure relief valves</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="pb"><strong>Backpressure (Pb) in psig:</strong></label>
                    <input type="number" id="pb" class="form-input" min="0" step="0.01" placeholder="e.g., 150.5">
                    <span class="error" id="pbError"></span>
                </div>
                <div class="form-group">
                    <label for="ps"><strong>Set Pressure (Ps) in psig:</strong></label>
                    <input type="number" id="ps" class="form-input" min="0" step="0.01" placeholder="e.g., 300.0">
                    <span class="error" id="psError"></span>
                </div>
                
                <button class="calculate-btn" onclick="calculateBackpressure()">Calculate Backpressure Percentage</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>This tool calculates the <strong>percentage of gauge backpressure</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Backpressure Percentage</h2>
                    </div>
                    <div class="rate-display">
                    <div class="rate-value" id="rateValue">0.00</div>
                    <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Percentage of Gauge Backpressure</div></div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Optimal</span><span>Acceptable</span><span>Caution</span><span>High</span><span>Critical</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">System Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

<!-- Notes Section -->
<!-- Notes Section -->
<div class="note-section">

    <!-- About -->
    <div class="note-card">
        <h3>📘 About This Calculator</h3>
        <p>
            The <strong>ASME (API RP 520) Bellows Balanced Valves Calculator</strong> 
            calculates the <strong>percentage of gauge backpressure</strong> in 
            pressure relief valves. This ensures that valves function correctly 
            under backpressure and maintain safe system operation.
        </p>
    </div>

    <!-- Parameters Used -->
    <div class="note-card">
        <h3>⚙ Parameters Used</h3>
        <ul class="note-list">
            <li><b>P<sub>b</sub> (Backpressure):</b> Pressure on the discharge side of the valve (psig).</li>
            <li><b>P<sub>s</sub> (Set Pressure):</b> Pressure at which the valve is designed to open (psig).</li>
        </ul>
    </div>

    <!-- Input Validation Rules -->
    <div class="note-card">
        <h3>✅ Input Validation Rules</h3>
        <ul class="note-list">
            <li><strong>P<sub>b</sub> (Backpressure)</strong> ≥ 0 and ≤ 10,000 psig (backpressure cannot be negative).</li>
            <li><strong>P<sub>s</sub> (Set Pressure)</strong> > 0 and ≤ 10,000 psig (set pressure must be positive).</li>
            <li><strong>P<sub>b</sub> (Backpressure) < P<sub>s</sub> (Set Pressure) recommended; if P<sub>b</sub> (Backpressure) ≥ P<sub>s</sub> (Set Pressure)</strong>, valve may not relieve pressure effectively.</li>
            <li>Decimals accepted up to 2 places for realistic safety reporting.</li>
        </ul>
    </div>

    <!-- Output Validations -->
    <div class="note-card">
        <h3>📊 Output Validations</h3>
        <p>The calculated <strong>Backpressure Percentage</strong> is interpreted as follows:</p>
        <ul class="note-list">
            <li><b>Backpressure Percentage &lt; 10%</b> → ✅ Optimal. Backpressure well within safe limits.</li>
            <li><b>Backpressure Percentage 10% – 20%</b> → 👍 Acceptable. Keep monitoring system conditions.</li>
            <li><b>Backpressure Percentage 20% – 30%</b> → ⚠️ Caution. Approaching API 520 design limits.</li>
            <li><b>Backpressure Percentage 30% – 50%</b> → 🚨 High. Relief valve performance may be impaired.</li>
            <li><b>Backpressure Percentage &gt; 50%</b> → ❌ Critical. Immediate system review required.</li>
        </ul>
        <p>
            ⚠ Industry guideline: For <b>bellows balanced valves</b>, acceptable backpressure is typically ≤ 30% (API RP 520 Part I, Sec. 3.3.3.2).  
            <strong>Assessment/Feedback:</strong> Displayed along with result, e.g., "Caution. Approaching API 520 design limits."
        </p>
    </div>

    <!-- Governing Principle -->
    <div class="note-card">
        <h3>📖 Governing Principle</h3>
        <p>
            An <strong>ASME (API RP 520) valve calculator for bellows balanced valves</strong> is based on ASME Code Section VIII and API Standard 520. These standards provide the principles and formulas for the design and sizing of safety valves, including the use of bellows to mitigate the effects of backpressure.  
            Key Aspects:  
            <ul class="note-list">
                <li><b>ASME Section VIII:</b> Provides requirements for the design of pressure vessels and safety devices, including valves.</li>
                <li><b>API Standard 520:</b> Details sizing, selection, and installation of pressure-relieving devices.</li>
                <li><b>Bellows Balanced Valves:</b> Counteract the impact of backpressure on valve performance.</li>
                <li><b>Sizing Calculations:</b> Uses established formulas for orifice area, discharge coefficient, and media properties.</li>
            </ul>
            <strong style="color: #1976d2;">Assessment/Feedback:</strong> Same interpretation rules as Output Validations apply here and are displayed along with result.
        </p>
    </div>

    <!-- Conclusion -->
    <div class="note-card">
        <h3>✅ Conclusion</h3>
        <p>
            This calculator ensures proper evaluation of bellows balanced valves by calculating backpressure percentage according to industry standards. 
            Following input validation rules and interpreting the output using defined thresholds ensures safe operation and compliance with ASME Section VIII and API RP 520. 
            Users should always verify critical or unusually high backpressure percentages to avoid unsafe designs.
        </p>
    </div>

</div>



    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateBackpressure() {
            // Get input values as strings first
            const pbValue = document.getElementById('pb').value.trim();
            const psValue = document.getElementById('ps').value.trim();
            
            // Convert to numbers
            const pb = parseFloat(pbValue);
            const ps = parseFloat(psValue);

            const pbError = document.getElementById('pbError');
            const psError = document.getElementById('psError');
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValue = document.getElementById('resultValue');

            // Reset errors and hide all sections
            pbError.innerText = "";
            psError.innerText = "";
            errorBox.classList.add("hidden");
            resultValue.classList.add("hidden");
            placeholder.classList.add("hidden");

            let errors = [];

            // Check if inputs are empty
            if (pbValue === "" || isNaN(pb)) {
                errors.push("Backpressure (Pb) is required and must be a valid number.");
                pbError.innerText = "Enter valid backpressure ≥ 0.";
            } else if (pb < 0 || pb > 10000) {
                errors.push("Backpressure (Pb) must be between 0 and 10,000 psig.");
                pbError.innerText = "Enter valid backpressure between 0 and 10,000.";
            }
            
            if (psValue === "" || isNaN(ps)) {
                errors.push("Set pressure (Ps) is required and must be a valid number.");
                psError.innerText = "Enter valid set pressure > 0.";
            } else if (ps <= 0 || ps > 10000) {
                errors.push("Set pressure (Ps) must be greater than 0 and ≤ 10,000 psig.");
                psError.innerText = "Enter valid set pressure between 0 and 10,000.";
            }

            // Show errors if any
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                return;
            }

            // Cross-field validation - critical condition
            if (pb >= ps) {
                errorMessage.innerHTML = "❌ Critical: Backpressure (Pb) is greater than or equal to Set Pressure (Ps). " +
                                        "The valve may not open or relieve pressure effectively. " +
                                        "This is a dangerous condition that requires immediate attention.";
                errorBox.classList.remove("hidden");
                return; // Exit function - don't show results
            }

            // Calculation - only executed if Pb < Ps
            const percentage = (pb / ps) * 100;
            document.getElementById('rateValue').textContent = percentage.toFixed(2) + "%";

            // Output classification
            const meterFill = document.getElementById('meterFill');
            let meterWidth, meterColor, feedback;
            
            if (percentage < 10) {
                meterWidth = '20%'; meterColor = '#27ae60';
                feedback = '✅ Optimal. Backpressure well within safe limits.';
            } else if (percentage < 20) {
                meterWidth = '40%'; meterColor = '#2ecc71';
                feedback = '👍 Acceptable. Keep monitoring system conditions.';
            } else if (percentage < 30) {
                meterWidth = '60%'; meterColor = '#f39c12';
                feedback = '⚠️ Caution. Approaching API 520 design limits.';
            } else if (percentage < 50) {
                meterWidth = '80%'; meterColor = '#e67e22';
                feedback = '🚨 High. Relief valve performance may be impaired.';
            } else {
                meterWidth = '95%'; meterColor = '#e74c3c';
                feedback = '❌ Critical. Immediate system review required.';
            }

            meterFill.style.width = meterWidth;
            meterFill.style.backgroundColor = meterColor;
            document.getElementById('feedbackContent').textContent = feedback;

            // Show results
            resultValue.classList.remove('hidden');
        }

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
        
        // Add event listeners for Enter key
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to inputs
            document.getElementById('pb').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    calculateBackpressure();
                }
            });
            
            document.getElementById('ps').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    calculateBackpressure();
                }
            });
        });
    </script>
    <script src="{% static 'js/print.js' %}"></script>

</body>
</html>
{% endblock %}
{% comment %} 

1. Formula (comment for your code)
/*
Formula for Bellows Balanced Valves (API RP 520, ASME Sec. VIII):

Backpressure Percentage (%) = ( Pb / Ps ) × 100

Where:
  Pb = Backpressure (psig) → pressure at valve outlet (superimposed + built-up)
  Ps = Set Pressure (psig) → pressure at which valve starts to lift

Important Compliance Notes:
- Pb ≥ 0 (cannot be negative, absolute physical requirement)
- Ps > 0 (valve cannot function at zero set pressure)
- Pb should not exceed Ps (if Pb ≥ Ps, the valve may not open properly)
- Acceptable backpressure % for bellows balanced valves is typically ≤ 30%
  (API RP 520 Part I, Section 3.3.3.2)
*/

2. Input Validation Rules (industry-based)
Input	Valid Range	Compliance Justification
Pb (Backpressure, psig)	≥ 0 and ≤ 10,000 psig	Backpressure cannot be negative. Extreme upper bound avoids entry errors (10,000 psig is beyond typical API design).
Ps (Set Pressure, psig)	> 0 and ≤ 10,000 psig	Set pressure must be positive. Valves are not designed for 0 psig. Limit prevents unrealistic inputs.
Cross-field dependency	Pb < Ps (recommended)	If Pb ≥ Ps → the valve cannot relieve pressure effectively → dangerous condition. Must warn user.
Decimal precision	Allow 2 decimals	API-calculated pressures are usually reported to one or two decimals in safety reports.
3. Edge Case Validations

Pb = 0, Ps > 0 → Valid, gives 0% backpressure (ideal).

Ps = 0 → Block, error: “Set pressure must be >0 psig.”

Pb > Ps → Show critical warning, as this indicates unsafe design.

Pb and Ps extremely close (e.g., Ps = 1 psig, Pb = 0.9 psig) → Valid, but warn about high backpressure %.

Extreme outliers (Pb or Ps > 10,000 psig) → Block, considered unrealistic for process safety applications.

4. Output Validation Logic & Thresholds

Following API 520 guidance (and fire safety best practice):

< 10% → ✅ Optimal → valve works efficiently, minimal outlet resistance.

10–20% → 👍 Acceptable → requires monitoring.

20–30% → ⚠️ Caution → still within bellows balanced valve capability, but approaching limit.

30–50% → 🚨 High → may impair relief capacity, corrective action recommended.

> 50% → ❌ Critical → system unsafe, immediate redesign/review required. {% endcomment %}