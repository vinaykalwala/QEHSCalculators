{% extends 'base.html' %}
{% block title %}Accident Severity Index Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accident Severity Index Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
                .btn-container {
    display: flex;
    justify-content: center; /* Horizontally center */
    margin: 30px 0;
}

.back-btn {
    background:linear-gradient(#1560bd,#000040); /* Dark navy background */
    color: #ffffff; /* White text */
    border: 2px solid #1560bd; /* Highlight border */
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none; /* Remove underline for link */
    transition: all 0.3s ease;
    cursor: pointer;
}

.back-btn:hover {
    background-color: #1560bd; /* Highlight on hover */
    color: #ffffff;
    border-color: #000040;
    transform: scale(1.05); /* Subtle hover effect */
}

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            {% comment %} max-width: 700px; {% endcomment %}
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            {% comment %} display: flex; {% endcomment %}
            flex-direction: column;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (min-width: 901px) {
            .calc-content { 
                flex-direction: row; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
            order: 2;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            min-height: 320px;
            {% comment %} order: 1; {% endcomment %}
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Input rows for side-by-side fields */
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }

        /* Mobile-specific adjustments */
        @media (max-width: 320px) {
            .calculator-container {
                padding: 10px;
            }
            
            .calculator-header h1 {
                font-size: 1.8rem;
            }
            
            .calculator-header p {
                font-size: 16px;
            }
            
            .calc-card, .result-card {
                padding: 20px 15px;
                border-radius: 12px;
            }
            
            .calc-card h2 {
                font-size: 1.4rem;
            }
            
            .form-input {
                padding: 12px 14px;
                font-size: 14px;
            }
            
            .calculate-btn {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .result-placeholder img {
                max-width: 180px;
            }
            
            .rate-value {
                font-size: 36px;
            }
            
            .meter-labels span {
                font-size: 10px;
            }
            
            .note-card {
                padding: 15px 18px;
            }
            
            .note-card h3 {
                font-size: 16px;
            }
            
            .note-card p, .note-card li {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="btn-container">
    <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
</div>
   <div class="calculator-container printable" id="printArea">

    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Accident Severity Index (ASI) Calculator</h1>
            <p>Calculate the criticality of accident sites based on severity and frequency of incidents</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                
                <div class="input-row">
                    <div class="form-group">
                        <label for="Nf">Number of Fatal Accidents</label>
                        <input type="number" id="Nf" class="form-input" min="0" placeholder="e.g., 2">
                    </div>
                    <div class="form-group">
                        <label for="Wf">Weight for Fatal Accidents</label>
                        <input type="number" id="Wf" class="form-input" min="0" placeholder="e.g., 7" value="7">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="form-group">
                        <label for="Ns">Number of Serious Injury Accidents</label>
                        <input type="number" id="Ns" class="form-input" min="0" placeholder="e.g., 5">
                    </div>
                    <div class="form-group">
                        <label for="Ws">Weight for Serious Injury Accidents</label>
                        <input type="number" id="Ws" class="form-input" min="0" placeholder="e.g., 3" value="3">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="form-group">
                        <label for="Nm">Number of Minor Injury Accidents</label>
                        <input type="number" id="Nm" class="form-input" min="0" placeholder="e.g., 10">
                    </div>
                    <div class="form-group">
                        <label for="Wm">Weight for Minor Injury Accidents</label>
                        <input type="number" id="Wm" class="form-input" min="0" placeholder="e.g., 1" value="1">
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateASI()">Calculate ASI</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Accident Severity Index (ASI)</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Accident Severity Index</h2>
                    </div>
                    <div class="rate-display">
                    <div class="rate-value" id="rateValue">0.00</div>
                    <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Accident Severity Index</div></div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low</span><span>Moderate</span><span>High</span><span>Very High</span><span>Critical</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Safety Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>📘 About This Calculator</h3>
                <p>
                    The <strong>Accident Severity Index (ASI)</strong> is a metric used to quantify the criticality of an accident site. 
                    It assigns scores based on the severity of accidents, with fatal accidents receiving higher weightings than serious or minor accidents. 
                    The ASI helps prioritize accident-prone areas for safety improvements and resource allocation.
                </p>
            </div>

            <div class="note-card">
                <h3>⚙️ Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>N_f:</strong> Number of fatal accidents at the spot.</li>
                    <li><strong>W_f:</strong> Weight assigned to fatal accidents (e.g., 7).</li>
                    <li><strong>N_s:</strong> Number of serious/major injury accidents at the spot.</li>
                    <li><strong>W_s:</strong> Weight assigned to serious/major injury accidents (e.g., 3).</li>
                    <li><strong>N_m:</strong> Number of minor injury accidents at the spot.</li>
                    <li><strong>W_m:</strong> Weight assigned to minor injury accidents (e.g., 1).</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>📊 Explanation of Weights</h3>
                <p>
                    Weights are assigned to reflect the severity of different types of accidents:
                </p>
                <ul class="note-list">
                    <li><strong>Fatal Accidents (W_f):</strong> Highest weight (e.g., 7) to reflect criticality</li>
                    <li><strong>Serious Injury Accidents (W_s):</strong> Moderate weight (e.g., 3) to reflect severity</li>
                    <li><strong>Minor Injury Accidents (W_m):</strong> Lowest weight (e.g., 1) to reflect lower impact</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>📈 Interpretation</h3>
                <p>
                    <b>Higher ASI values</b> = more hazardous locations.  
                    Generally:
                </p>
                <ul class="note-list">
                    <li><span class="good">Below 10</span> → Low severity risk</li>
                    <li><span class="average">10 – 30</span> → Moderate severity risk</li>
                    <li><span class="bad">Above 30</span> → High severity risk requiring immediate attention</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>🔍 Why Is ASI Important?</h3>
                <p>
                    The ASI is a crucial tool for:
                </p>
                <ul class="note-list">
                    <li><strong>Prioritizing Safety Measures:</strong> Identifying high-risk locations</li>
                    <li><strong>Resource Allocation:</strong> Guiding allocation of resources to areas with highest ASI values</li>
                    <li><strong>Monitoring Progress:</strong> Tracking effectiveness of safety interventions over time</li>
                </ul>
            </div>
            <div class="note-card">
    <h3>✅ Input Validation Rules</h3>
    <ul class="note-list">
        <li><strong>Number of Fatal/Serious/Minor Accidents:</strong> 0 – 10,000, whole numbers only.</li>
        <li><strong>Weights (Wf, Ws, Wm):</strong> Must be 1 – 10, whole numbers only, and follow Fatal > Serious > Minor.</li>
        <li><strong>No negative or decimal values:</strong> Accident counts and weights must be realistic.</li>
        <li><strong>Edge Cases:</strong> All zeros → ASI = 0 (excellent safety). Extremely high values flagged as potential data errors.</li>
    </ul>
    <p><b>Note:</b> These validations are based on <b>ISO 45001, OSHA, NFPA</b> and <b>ILO</b> standards for accident severity reporting.</p>
</div>

        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateASI() {
    const Nf = document.getElementById('Nf').value.trim();
    const Wf = document.getElementById('Wf').value.trim();
    const Ns = document.getElementById('Ns').value.trim();
    const Ws = document.getElementById('Ws').value.trim();
    const Nm = document.getElementById('Nm').value.trim();
    const Wm = document.getElementById('Wm').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];

    // --- Input Validations (QEHS / Fire Safety) ---
    // Accident counts (Nf, Ns, Nm) must be integers >= 0
    const inputs = [
        { name: "Number of fatal accidents", val: Nf, min: 0, max: 10000, integer: true },
        { name: "Weight for fatal accidents", val: Wf, min: 1, max: 10, integer: true },
        { name: "Number of serious injury accidents", val: Ns, min: 0, max: 10000, integer: true },
        { name: "Weight for serious injury accidents", val: Ws, min: 1, max: 10, integer: true },
        { name: "Number of minor injury accidents", val: Nm, min: 0, max: 10000, integer: true },
        { name: "Weight for minor injury accidents", val: Wm, min: 1, max: 10, integer: true }
    ];

    inputs.forEach(input => {
        if (input.val === "") {
            errors.push(`👉 Please enter ${input.name}.`);
        } else {
            const num = parseFloat(input.val);
            if (isNaN(num)) {
                errors.push(`👉 ${input.name} must be a number.`);
            } else if (input.integer && !Number.isInteger(num)) {
                errors.push(`👉 ${input.name} must be a whole number.`);
            } else if (num < input.min || num > input.max) {
                errors.push(`👉 ${input.name} must be between ${input.min} and ${input.max}.`);
            }
        }
    });

    // Cross-field validation: Wf > Ws > Wm
    if (errors.length === 0) {
        if (!(parseInt(Wf) > parseInt(Ws) && parseInt(Ws) > parseInt(Wm))) {
            errors.push("👉 Weights must follow Fatal > Serious > Minor (e.g., 7 > 3 > 1).");
        }
    }

    // Show errors
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // --- Calculation ---
    const nf = parseInt(Nf), wf = parseInt(Wf);
    const ns = parseInt(Ns), ws = parseInt(Ws);
    const nm = parseInt(Nm), wm = parseInt(Wm);

    // Formula: ASI = (Nf × Wf) + (Ns × Ws) + (Nm × Wm)
    const ASI = (nf * wf) + (ns * ws) + (nm * wm);
    document.getElementById('rateValue').textContent = ASI.toFixed(2);

    // --- Performance Assessment ---
    const meterFill = document.getElementById('meterFill');
    let meterWidth, meterColor, feedback;

    if (ASI === 0) {
        meterWidth = '5%';
        meterColor = '#27ae60';
        feedback = '🌟 Excellent! No accidents recorded. Maintain safety culture.';
    } else if (ASI < 10) {
        meterWidth = '20%';
        meterColor = '#2ecc71';
        feedback = '👍 Low severity risk. Continue proactive safety measures.';
    } else if (ASI <= 30) {
        meterWidth = '50%';
        meterColor = '#f39c12';
        feedback = '⚠️ Moderate risk. Review safety protocols.';
    } else if (ASI <= 60) {
        meterWidth = '75%';
        meterColor = '#e67e22';
        feedback = '🚨 High risk. Immediate safety actions required.';
    } else {
        meterWidth = '95%';
        meterColor = '#e74c3c';
        feedback = '❌ Critical risk! Urgent intervention, possible shutdown recommended.';
    }

    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;
    document.getElementById('feedbackContent').textContent = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}


        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}

{% comment %} 
1. Formula (to keep as comment in code)
// Formula for Accident Severity Index (ASI):
// ASI = (Nf × Wf) + (Ns × Ws) + (Nm × Wm)
//
// Where:
// Nf = Number of Fatal Accidents
// Wf = Weight for Fatal Accidents (e.g., 7)
// Ns = Number of Serious Injury Accidents
// Ws = Weight for Serious Injury Accidents (e.g., 3)
// Nm = Number of Minor Injury Accidents
// Wm = Weight for Minor Injury Accidents (e.g., 1)

2. Input Validation Rules (QEHS / Fire Safety standards)
Number of Accidents (Nf, Ns, Nm)

Must be whole numbers (integers).

Minimum: 0 (can be no accidents).

Maximum: 10,000 (beyond this → data entry/reporting issue).

Decimals not allowed.

Weights (Wf, Ws, Wm)

Must be positive integers.

Standard defaults:

Fatal = 7

Serious = 3

Minor = 1

Allowed range: 1 – 10.

Decimals not allowed (weights are classification constants).

Cross-rule: Wf > Ws > Wm (Fatal > Serious > Minor).

Cross-field Logic

At least one of Nf, Ns, or Nm should be > 0, otherwise ASI = 0.

Fatal accident count (Nf) cannot be less than serious/minor if severity order is inverted.

If all counts = 0 → system should return ASI = 0, Excellent Safety.

3. Output Validation Logic & Thresholds

Industry benchmark (used in audits & road safety studies):

ASI = 0 → Excellent (no accidents).

ASI < 10 → Low severity risk.

10 ≤ ASI ≤ 30 → Moderate severity risk.

31 ≤ ASI ≤ 60 → High severity risk.

ASI > 60 → Critical, immediate intervention required.

This aligns with ILO occupational accident classification and ISO 45001 risk prioritization. {% endcomment %}