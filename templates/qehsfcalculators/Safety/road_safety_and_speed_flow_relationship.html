{% extends 'base.html' %}
{% block title %}Road Safety & Speed-Flow Relationship Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accident Rate Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 350px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        @media (max-width: 768px) {
    .result-placeholder img {
        max-width: 80%;    /* Slightly smaller on tablets */
    }
}

@media (max-width: 480px) {
    .result-placeholder img {
        max-width: 100%;   /* Full width on small screens */
        margin-bottom: 15px;
    }
}
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
          @media (max-width: 768px) {
    .rate-value {
        font-size: 28px; /* smaller font for tablets/mobiles */
    }
}

@media (max-width: 480px) {
    .rate-value {
        font-size: 24px; /* even smaller for phones */
    }
}
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
  <div class="calculator-container printable" id="printArea">
    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

    <div class="calculator-header">
        <h1>Road Safety & Speed-Flow Relationship Calculator</h1>
        <p>Estimate traffic flow and assess road safety based on vehicle speed and density.</p>
    </div>

    <div class="calc-content">
        <!-- Calculator -->
        <div class="calc-card">
            <h2>Enter Data</h2>
            <div class="form-group">
                <label for="speed">Speed (km/h)</label>
                <input type="number" id="speed" class="form-input" min="0" placeholder="e.g., 60">
            </div>
            <div class="form-group">
                <label for="density">Density (vehicles/km)</label>
                <input type="number" id="density" class="form-input" min="0" placeholder="e.g., 20">
            </div>
            <button class="calculate-btn" onclick="calculateSpeedFlow()">Calculate Traffic Flow</button>
        </div>

        <!-- Result Section -->
        <div class="result-card">
            <div class="result-placeholder" id="placeholder">
                <img src="{% static 'images/roadsafety.png' %}" alt="Traffic illustration">
                <p>This tool will calculate <strong>Traffic Flow</strong>. Enter your data to see results and insights here.</p>
            </div>
            
            <div class="result-error hidden" id="resultError">
                <div class="error-icon">❌</div>
                <div class="error-message" id="errorMessage"></div>
            </div>
            
            <div class="result-value hidden" id="resultValue">
                <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                    <h2>Traffic Flow Result</h2>
                </div>
                <div class="rate-value" id="trafficFlowValue">0</div>
                <div class="rate-label" style="color:#2980b9; font-size:16px; font-weight:bold;">
                    Vehicles per Hour (vehicles/h)
                </div>

                <div class="result-feedback">
                    <div class="feedback-title">Assessment</div>
                    <div class="feedback-content" id="feedbackContent"></div>
                </div>
                <div class="btn-wrapper">
                    <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Section -->
    <div class="note-section">
       <div class="note-card">
    <h3>📘 About This Calculator</h3>
    <p>
        The <strong>Speed-Flow Calculator</strong> helps traffic engineers and planners estimate traffic flow based on vehicle speed and density. It provides quick insights into congestion levels, road safety, and overall traffic efficiency, assisting in better traffic management, accident prevention, and efficient road design.
    </p>
</div>

        <div class="note-card">
            <h3>⚙️ Parameters Used</h3>
            <ul class="note-list">
                <li><strong>Speed (km/h):</strong> Vehicle speed affects flow; higher speeds usually mean higher flow until congestion occurs.</li>
                <li><strong>Density (vehicles/km):</strong> Number of vehicles per kilometer. Higher density can reduce speeds and increase accident risk.</li>
            </ul>
        </div>

     


       <div class="note-card">
    <h3>✅ Input Validation Rules</h3>
    <ul class="note-list">
        <li><strong>Speed:</strong> Must be numeric and greater than 0 km/h. Realistic range: 0–200 km/h; values above 200 km/h are flagged as unusually high.</li>
        <li><strong>Density:</strong> Must be numeric and greater than 0 vehicles/km. Realistic range: 0–300 vehicles/km; values above 300 vehicles/km are flagged as unusually high.</li>
        <li><strong>Decimals Allowed:</strong> Speed up to 1 decimal place; density up to 1 decimal place for accuracy.</li>
        <li><strong>Logical Combination:</strong> Speed × Density (Traffic Flow) must produce a plausible value. Extremely high traffic flow (&gt;10,000 vehicles/h) triggers a warning to verify inputs.</li>
        <li><strong>Missing or Invalid Inputs:</strong> Empty, zero, or non-numeric values are invalid and must be corrected before calculation.</li>
    </ul>
</div>

          <div class="note-card">
    <h3>📊 Output Validations</h3>
    <ul class="note-list">
        <li>Low Flow (&lt;500 vehicles/h):</span> ✅ Safe driving conditions with minimal congestion.</li>
        <li>Moderate Flow (500–2000 vehicles/h):</span> ⚠️ Normal traffic conditions; monitor speed and density for safety.</li>
        <li>High Flow (&gt;2000 vehicles/h):</span> ❌ Congestion likely; increased risk of accidents. Consider traffic management measures.</li>
    </ul>
</div>

<div class="note-card">
    <h5>⚖️ Governing Principle</h5>
    <p>
        A "Road Safety & Speed-Flow Relationship Calculator" is not a single, universally standardized tool, 
        but rather a model that is based on principles from traffic engineering and road safety research. 
        The methods and models used to build such calculators are often based on well-established research and handbooks, 
        but can also be specific to a region or particular study.
    </p>

    <h5>Key Standards and Resources That Inform These Calculators</h5>
    <ul class="note-list">
        <li><strong>Highway Capacity Manual (HCM):</strong> The HCM, published by the Transportation Research Board, is a foundational text in traffic engineering. It provides methodologies for analyzing road performance based on traffic flow, speed, and density. While it doesn't directly calculate "road safety," it informs the speed-flow components that are critical for safety analysis.</li>
        <li><strong>Global Road Safety Facility (GRSF) Road Safety Calculator:</strong> The GRSF, supported by the World Bank, offers a specific online tool for policymakers. This calculator uses crash data and Crash Modification Factors (CMFs) to help plan road safety investments and estimate the safety benefits of various interventions.</li>
        <li><strong>Greenshields' Model:</strong> One of the earliest and most fundamental models for the speed-flow relationship was developed by Bruce D. Greenshields. Though it's a theoretical model, it laid the groundwork for many subsequent empirical and mathematical models used in traffic engineering.</li>
        <li><strong>National and Regional Standards:</strong> Many countries or regions have their own versions of highway capacity manuals or standards, such as India's Indian Roads Congress (IRC) or Malaysia's Highway Capacity Manual (MHCM). These apply speed-flow models to local conditions, including traffic composition and road geometry.</li>
        <li><strong>Academic and Industry Studies:</strong> Researchers and firms frequently develop specific models based on real-world data to establish precise relationships for particular types of roads or traffic patterns. These models and studies are not universal standards, but are part of the broader body of work that informs road safety and traffic calculators.</li>
    </ul>

    <p>
        Therefore, when evaluating a calculator for speed-flow and safety, it's important to know which specific standard, model, or research it is based on, 
        as there is no single international standard that governs all such tools.
    </p>
</div>


        <div class="note-card">
    <h3>🏁 Conclusion</h3>
    <p>
        The <strong>Speed-Flow Calculator</strong> is a practical tool for analyzing traffic conditions and understanding the relationship between vehicle speed, density, and flow. By using this calculator, planners and engineers can make informed decisions to enhance road safety, reduce congestion, and improve overall traffic efficiency. Always ensure input values reflect realistic traffic conditions for accurate results.
    </p>
</div>

    </div>
</div>

<script>
function calculateSpeedFlow() {
    const speed = parseFloat(document.getElementById('speed').value);
    const density = parseFloat(document.getElementById('density').value);
    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');
    const feedbackContent = document.getElementById('feedbackContent');

    let errors = [];

    // --- Mandatory & Numeric Check ---
    if (isNaN(speed)) errors.push("👉 Speed must be a number.");
    if (isNaN(density)) errors.push("👉 Density must be a number.");
    
    // --- Positive & Realistic Check ---
    if (speed <= 0) errors.push("👉 Speed must be greater than 0 km/h.");
    if (density <= 0) errors.push("👉 Density must be greater than 0 vehicles/km.");

    // --- Extreme Value Check (Outliers) ---
    if (speed > 200) errors.push("⚠️ Speed unusually high (>200 km/h). Verify input.");
    if (density > 300) errors.push("⚠️ Density unusually high (>300 vehicles/km). Verify input.");

    // --- Logical Combination Check ---
    const trafficFlow = speed * density;
    if (trafficFlow > 10000) errors.push("⚠️ Calculated traffic flow unusually high (>10,000 vehicles/h). Check speed and density inputs.");

    // --- Stop and display errors ---
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // --- Display Result ---
    document.getElementById('trafficFlowValue').textContent = trafficFlow.toFixed(2);

    // --- Feedback based on traffic flow ---
    let feedback = "";
    let color = "";

    if (trafficFlow < 500) {
        feedback = "✅ Low Flow: Safe driving conditions with minimal congestion.";
        color = "green";
    } else if (trafficFlow >= 500 && trafficFlow <= 2000) {
        feedback = "⚠️ Moderate Flow: Normal traffic conditions; monitor speed and density for safety.";
        color = "orange";
    } else {
        feedback = "❌ High Flow: Congestion likely; increased risk of accidents. Consider traffic management measures.";
        color = "red";
    }

    feedbackContent.innerHTML = `<strong style="color:${color}">${feedback}</strong>`;
    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}

</script>

    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


<!-- 1. Input Validation Rules (QEHS Perspective)
Input	Unit	Acceptable Range	Allowed Decimals	Realistic Thresholds	Notes / Cross-field checks
Speed	km/h	0.1 – 200	1 decimal	>200 km/h flagged as extreme/outlier	Speed ≤ 0 is invalid. Ensure speed × density does not produce unrealistic traffic flow (>10,000 vehicles/h typical max).
Density	vehicles/km	0.1 – 300	1 decimal	Density >300 flagged as extreme	Density ≤ 0 is invalid. Cross-check: very high density with high speed is unlikely, should warn user.

Rationale:

Safety Compliance: Excessive speeds/densities correlate with increased accident risk; OSHA and ISO 45001 require identification of unsafe conditions.

Logical Consistency: Speed × density must produce plausible traffic flows; unrealistic combinations indicate user input errors.

Units & Precision: Enforcing decimals prevents rounding errors in reports.

2. Output Validation Logic & Thresholds

Traffic Flow Calculation:

𝑞
=
𝑣
×
𝑘
q=v×k

Where:

𝑣
v = speed (km/h)

𝑘
k = density (vehicles/km)

𝑞
q = traffic flow (vehicles/hour)

Interpretation Thresholds (QEHS & Road Safety Perspective):

Traffic Flow (vehicles/h)	Interpretation	Safety Guidance
< 500	Low Flow	Minimal congestion, safe driving.
500 – 2000	Moderate Flow	Normal traffic; monitor for safety, especially in intersections or urban zones.
> 2000	High Flow	Congestion likely; increased collision risk; implement traffic control or safety measures.

Rationale: These thresholds align with traffic engineering guidelines and road safety KPIs used in audits.

3. Edge Cases & Handling

Zero or Negative Values:

Speed ≤ 0 → invalid

Density ≤ 0 → invalid

Compliance: OSHA requires reporting invalid/unsafe conditions.

Extreme Outliers:

Speed > 200 km/h → warning

Density > 300 vehicles/km → warning

Unrealistic Combinations:

High speed + high density → alert: physically improbable, possible data entry error.

Missing Inputs:

Null or empty → prompt user to enter data.

Large Traffic Flow (>10,000 vehicles/h):

Trigger alert: likely input error, flag for verification

5. Why Each Validation Is Essential
Validation	QEHS / Compliance Reason
Numeric & mandatory check	Prevents calculation errors; ensures data integrity for safety audits.
Positive values	Negative speeds/densities are physically impossible; protects logical consistency.
Extreme values (speed/density)	Identifies unsafe or unrealistic scenarios; aligns with ISO 45001 and road safety standards.
Logical combination (traffic flow)	Prevents overestimation; ensures reported KPIs reflect real-world conditions.
Decimal precision	Reduces rounding errors in reports; ensures compliance with engineering data recording standards. -->