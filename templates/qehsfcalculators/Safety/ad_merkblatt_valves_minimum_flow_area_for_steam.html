{% extends 'base.html' %}
{% block title %}AD-Merkblatt Valves - Minimum Flow Area for Steam{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AD-Merkblatt Valves - Minimum Flow Area for Steam</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
                .btn-container {
    display: flex;
    justify-content: center; /* Horizontally center */
    margin: 30px 0;
}

.back-btn {
    background:linear-gradient(#1560bd,#000040); /* Dark navy background */
    color: #ffffff; /* White text */
    border: 2px solid #1560bd; /* Highlight border */
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none; /* Remove underline for link */
    transition: all 0.3s ease;
    cursor: pointer;
}

.back-btn:hover {
    background-color: #1560bd; /* Highlight on hover */
    color: #ffffff;
    border-color: #000040;
    transform: scale(1.05); /* Subtle hover effect */
}

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            {% comment %} max-width: 700px; {% endcomment %}
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 520px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
     
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
    <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
</div>
   <div class="calculator-container printable" id="printArea">

    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>AD-Merkblatt Valves - Minimum Flow Area for Steam</h1>
            <p>Calculate the minimum cross-sectional flow area needed for steam discharge in AD-Merkblatt valves</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="chi">Pressure Medium Coefficient (œá)</label>
                    <input type="number" id="chi" class="form-input" step="0.01" min="0.01" placeholder="e.g., 0.5">
                </div>
                <div class="form-group">
                    <label for="m_dot">Mass Flow Rate (·πÅ in kg/h)</label>
                    <input type="number" id="m_dot" class="form-input" step="0.1" min="0.1" placeholder="e.g., 1000">
                </div>
                <div class="form-group">
                    <label for="alpha_w">Outflow Coefficient (Œ±w)</label>
                    <input type="number" id="alpha_w" class="form-input" step="0.01" min="0.01" placeholder="e.g., 0.8">
                </div>
                <div class="form-group">
                    <label for="p_r">Absolute Relieving Pressure (PR in bar a)</label>
                    <input type="number" id="p_r" class="form-input" step="0.1" min="0.1" placeholder="e.g., 10.0">
                </div>
                
                <button class="calculate-btn" onclick="calculateFlowArea()">Calculate Minimum Flow Area</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Minimum Flow Area</strong> for steam discharge. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Minimum Flow Area</h2>
                    </div>
                    <div class="rate-display">
                    <div class="rate-value" id="rateValue">0.00</div>
                    <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Minimum Flow Area (A‚ÇÄ in mm¬≤)</div></div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Small</span><span>Medium</span><span>Large</span><span>Very Large</span><span>Critical</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Valve Size Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

<!-- Notes Section -->
<div class="note-section">

    <!-- About -->
    <div class="note-card">
        <h3>üìò About This Calculator</h3>
        <p>
            The <strong>Minimum Flow Area Calculator</strong> determines the required 
            valve opening size for safe steam discharge according to 
            <strong>AD-Merkblatt</strong> standards. It ensures sufficient 
            discharge capacity to prevent overpressure in boilers and 
            steam systems.
        </p>
    </div>

    <!-- Parameters -->
    <div class="note-card">
        <h3>‚öôÔ∏è Parameters Used</h3>
        <ul class="note-list">
            <li><b>œá (Pressure Medium Coefficient):</b> Dimensionless factor based on steam properties (‚âà0.3‚Äì1.0).</li>
            <li><b>·πÅ (Mass Flow Rate):</b> Steam flow per hour [kg/h].</li>
            <li><b>Œ±w (Outflow Coefficient):</b> Efficiency of valve discharge (typically 0.7‚Äì1.0).</li>
            <li><b>PR (Absolute Relieving Pressure):</b> System pressure at which valve releases [bar a].</li>
        </ul>
    </div>

    <!-- Input Validation Rules -->
    <div class="note-card">
        <h3>‚úÖ Input Validation Rules</h3>
        <ul class="note-list">
            <li><b>œá:</b> 0.3‚Äì1.0 typical (reject &lt;0.1 or &gt;1.5). Two decimals allowed.</li>
            <li><b>·πÅ:</b> 10‚Äì1,000,000 kg/h typical (reject &lt;1 or &gt;10,000,000). One decimal allowed.</li>
            <li><b>Œ±w:</b> 0.7‚Äì1.0 typical (reject &lt;0.1 or &gt;1.2). Two decimals allowed.</li>
            <li><b>PR:</b> 1‚Äì320 bar a typical (reject &lt;0.5 or &gt;400). One decimal allowed.</li>
            <li><b>Cross-checks:</b> Œ±w √ó PR ‚â† 0. Warn if A‚ÇÄ &gt; 50,000 mm¬≤ (possible unit error).</li>
            <li><b>No Negatives / Blanks:</b> All inputs must be positive numeric values.</li>
        </ul>
    </div>

    <!-- Output Validations -->
    <div class="note-card">
        <h3>üìä Output Validations</h3>
        <ul class="note-list">
            <li><b>A‚ÇÄ &lt; 10 mm¬≤:</b> ‚úÖ Small valve size sufficient.</li>
            <li><b>10 ‚â§ A‚ÇÄ &lt; 50 mm¬≤:</b> ‚ÑπÔ∏è Medium valve required. Verify conditions.</li>
            <li><b>50 ‚â§ A‚ÇÄ &lt; 100 mm¬≤:</b> ‚ö†Ô∏è Large valve required. Consider design review.</li>
            <li><b>100 ‚â§ A‚ÇÄ &lt; 200 mm¬≤:</b> üö® Very large valve. Multiple relief paths may be required.</li>
            <li><b>A‚ÇÄ ‚â• 200 mm¬≤:</b> ‚ùå Critical valve size. Engineering redesign required.</li>
        </ul>
    </div>

    <!-- Standards -->
    <div class="note-card">
        <h3>üìè Standards</h3>
        <p>
            This calculation follows <strong>AD-Merkblatt</strong>, 
            <strong>ISO 4126</strong>, and <strong>EN pressure relief standards</strong>, 
            ensuring valves meet regulatory safety requirements for 
            pressure vessel and boiler protection.
        </p>
    </div>
</div>


    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateFlowArea() {
    const chi = parseFloat(document.getElementById('chi').value.trim());
    const m_dot = parseFloat(document.getElementById('m_dot').value.trim());
    const alpha_w = parseFloat(document.getElementById('alpha_w').value.trim());
    const p_r = parseFloat(document.getElementById('p_r').value.trim());

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];

    // œá validation
    if (isNaN(chi) || chi <= 0) {
        errors.push("üëâ Enter œá > 0 (Pressure Medium Coefficient).");
    } else if (chi < 0.1 || chi > 1.5) {
        errors.push("‚ö†Ô∏è œá is unrealistic (expected range: 0.3‚Äì1.0 for steam).");
    }

    // ·πÅ validation
    if (isNaN(m_dot) || m_dot <= 0) {
        errors.push("üëâ Enter Mass Flow Rate (·πÅ) > 0 kg/h.");
    } else if (m_dot < 1 || m_dot > 1e7) {
        errors.push("‚ö†Ô∏è ·πÅ seems unrealistic (expected 10‚Äì1,000,000 kg/h).");
    }

    // Œ±w validation
    if (isNaN(alpha_w) || alpha_w <= 0) {
        errors.push("üëâ Enter Outflow Coefficient (Œ±w) > 0.");
    } else if (alpha_w < 0.1 || alpha_w > 1.2) {
        errors.push("‚ö†Ô∏è Œ±w seems unrealistic (expected 0.7‚Äì1.0).");
    }

    // PR validation
    if (isNaN(p_r) || p_r <= 0) {
        errors.push("üëâ Enter Absolute Relieving Pressure (PR) > 0 bar a.");
    } else if (p_r < 0.5 || p_r > 400) {
        errors.push("‚ö†Ô∏è PR seems unrealistic (expected 1‚Äì320 bar a).");
    }

    // Cross-field
    if (alpha_w && p_r && (alpha_w * p_r === 0)) {
        errors.push("‚ùå Division by zero detected (Œ±w √ó PR).");
    }

    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // ‚úÖ Safe calculation
    const A0 = (chi * m_dot) / (alpha_w * p_r);

    document.getElementById('rateValue').textContent = A0.toFixed(4);

    const meterFill = document.getElementById('meterFill');
    let meterWidth, meterColor, feedback;

    if (A0 < 10) {
        meterWidth = '20%';
        meterColor = '#27ae60';
        feedback = '‚úÖ Small valve size sufficient.';
    } else if (A0 < 50) {
        meterWidth = '40%';
        meterColor = '#2ecc71';
        feedback = '‚ÑπÔ∏è Medium valve required. Verify conditions.';
    } else if (A0 < 100) {
        meterWidth = '60%';
        meterColor = '#f39c12';
        feedback = '‚ö†Ô∏è Large valve required. Consider design review.';
    } else if (A0 < 200) {
        meterWidth = '80%';
        meterColor = '#e67e22';
        feedback = 'üö® Very large valve. Multiple relief paths may be required.';
    } else {
        meterWidth = '95%';
        meterColor = '#e74c3c';
        feedback = '‚ùå Critical valve size. Engineering redesign required.';
    }

    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;
    document.getElementById('feedbackContent').textContent = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}


        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}

{% comment %} 
1. Formula (comment for your code)
/*
AD-Merkblatt Minimum Flow Area for Steam:

   A‚ÇÄ = ( œá √ó ·πÅ ) / ( Œ±w √ó PR )

Where:
- A‚ÇÄ  = Minimum flow area [mm¬≤]
- œá   = Pressure Medium Coefficient (dimensionless, ~0.3‚Äì1.0 for steam)
- ·πÅ   = Mass flow rate [kg/h]
- Œ±w  = Outflow coefficient (dimensionless, typically 0.7‚Äì1.0)
- PR  = Absolute relieving pressure [bar a]

Purpose:
- Used in safety valve design and selection to ensure sufficient discharge area
- Prevents overpressure in boilers/steam systems
- Compliance with AD-Merkblatt, ISO 4126, EN standards for pressure relief
*/

2. Input Validation Rules (Real-World QEHS / Fire Safety Standards)
œá (Pressure Medium Coefficient)

Must be > 0.

Typical range: 0.3 ‚Äì 1.0 (steam under AD-Merkblatt).

Reject < 0.1 or > 1.5 (unrealistic).

Allow 2 decimals.

·πÅ (Mass Flow Rate, kg/h)

Must be > 0.

Common industrial safety valves: 10 ‚Äì 1,000,000 kg/h.

Reject < 1 (too small) or > 10,000,000 (unit error likely).

Allow 1 decimal.

Œ±w (Outflow Coefficient)

Must be > 0.

Typical engineering values: 0.7 ‚Äì 1.0.

Reject < 0.1 or > 1.2.

Allow 2 decimals.

PR (Absolute Relieving Pressure, bar a)

Must be > 0.

Common safety valve pressures: 1 ‚Äì 320 bar a (boilers, steam drums, nuclear).

Reject < 0.5 or > 400 bar a (unrealistic for AD-Merkblatt).

Allow 1 decimal.

3. Cross-Field & Logical Validations

Denominator check ‚Üí ensure (Œ±w √ó PR) ‚â† 0.

Scaling consistency ‚Üí if A‚ÇÄ > 50,000 mm¬≤, warn ‚Äúextreme valve size ‚Üí review input units.‚Äù

œá must be ‚â§ 1.0 for saturated steam cases (warn if > 1).

·πÅ too high + PR too low ‚Üí likely input error (e.g., wrong units kg/s vs. kg/h).

4. Output Validation Logic (Valve Size Categories)
Flow Area (mm¬≤)	Category	Safety interpretation
< 10	Small	Standard valve size sufficient
10 ‚Äì 50	Medium	Larger valve but common
50 ‚Äì 100	Large	Careful design check required
100 ‚Äì 200	Very Large	Unusual, multiple valves may be needed
> 200	Critical	Engineering review required, design modification {% endcomment %}