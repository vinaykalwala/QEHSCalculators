{% extends 'base.html' %}
{% block title %}Fatal Accident Rate Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatal Accident Rate (FAR) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        /* Input rows for side-by-side fields */
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            height: 420px;
            overflow-y: auto;
            text-align: center;
            {% comment %} margin-top: 20px; {% endcomment %}
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .rate-display {
            {% comment %} display: flex; {% endcomment %}
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
        
        .error {
            color: #e74c3c;
            font-size: 14px;
            {% comment %} margin-top: 5px; {% endcomment %}
            display: block;
        }
        
        .success {
            color: #27ae60;
            font-size: 16px;
            margin-top: 15px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Fatal Accident Rate (FAR) Calculator</h1>
            <p>Calculate the number of fatal accidents per million man-hours worked</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                
                <div class="form-group">
                    <label for="fatalities">Number of Fatalities</label>
                    <input type="number" id="fatalities" class="form-input" min="0" placeholder="e.g., 2">
                </div>
                
                <div class="form-group">
                    <label for="manHours">Total Man-Hours Worked</label>
                    <input type="number" id="manHours" class="form-input" min="0" placeholder="e.g., 500,000">
                </div>
                
                <button class="calculate-btn" onclick="calculateFAR()">Calculate FAR</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                   <img src="{% static 'images/resultimage.png' %}" alt="Safety illustration">

                    <p>This tool will calculate the <strong>Fatal Accident Rate (FAR)</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd; margin-top:10px;">
                        <h2>Fatal Accident Rate</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Fatalities per million man-hours</div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Excellent</span><span>Moderate</span><span>High Risk</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title"> Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

<!-- Notes Section -->
<div class="note-section">
    <div class="note-card">
        <h3>üìò About This Calculator</h3>
        <p>
            The <strong>Fatal Accident Rate (FAR)</strong> is a crucial metric used in occupational health and safety to measure the number of fatal incidents per million man-hours worked. 
            It provides a standardized way to compare safety performance across different industries and workplaces.
        </p>
    </div>

    <div class="note-card">
        <h3>‚öôÔ∏è Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Number of Fatalities:</strong> The total number of fatal incidents reported within a given period.</li>
            <li><strong>Total Man-Hours Worked:</strong> The cumulative number of hours worked by all employees within the same period.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>‚úÖ Input Validation Rules</h3>
        <ul class="note-list">
            <li><strong>Number of Fatalities:</strong> Whole number, 0‚Äì10,000. No decimals or negatives.</li>
            <li><strong>Total Man-Hours Worked:</strong> Must be >0 and ‚â§1,000,000,000. Up to 2 decimals allowed.</li>
            <li><strong>No negative values:</strong> Both inputs must be positive (fatalities may be 0).</li>
            <li><strong>Cross-field check:</strong> Fatalities cannot exceed total man-hours (unrealistic).</li>
            <li><strong>Edge cases:</strong> Zero fatalities ‚Üí FAR = 0.00 (Excellent).</li>
            <li><b>Compliance Note:</b> These rules align with <b>OSHA, ILO, NFPA, ISO 45001</b> occupational safety standards.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>üìä Output Validation Rules</h3>
        <ul class="note-list">
            <li><strong>Fatal Accident Rate (FAR) = 0.00</strong> ‚Üí Excellent (üåü No fatalities recorded). Feedback: Maintain safety culture.</li>
            <li><strong>Fatal Accident Rate (FAR) &lt; 1.0</strong> ‚Üí Excellent safety record (üëç Maintain proactive safety measures).</li>
            <li><strong>Fatal Accident Rate (FAR) 1.0 ‚Äì 5.0</strong> ‚Üí Moderate risk (‚ö†Ô∏è Review safety protocols and implement improvements).</li>
            <li><strong>Fatal Accident Rate (FAR) &gt; 5.0</strong> ‚Üí High-risk workplace (‚ùå Urgent safety measures and comprehensive review needed).</li>
            <li>Feedback/assessment is displayed alongside result in the calculator output.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>üìä Governing Principle</h3>
        <p>
            A Fatal Accident Rate (FAR) is not tied to a single specific standard but is a safety metric used across various industries and organizations for measuring the number of fatal incidents per a set number of man-hours, often compared to ISO 45001 for Occupational Health and Safety management systems and used in conjunction with national regulations like the Factories Act in India or the OSHA standard in the US. While the Bureau of Indian Standards provides IS:3786:1983 for similar frequency and severity rates, different organizations, such as the International Civil Aviation Organization (ICAO) for aviation, have their own methodologies for accident rate calculation.
        </p>
        <p><b style="color: #1976d2;">Key Aspects of FAR:</b></p>
        <ul class="note-list">
            <li><strong>Definition:</strong> FAR is the number of fatalities per a specific volume of work, such as 100 million or 100,000 man-hours, to standardize safety performance.</li>
            <li><strong>Purpose:</strong> Workplace safety monitoring, regulatory compliance, safety improvement, and benchmarking.</li>
            <li><strong>Industry-Specific & General Standards:</strong> IS 3786:1983 (India), OSHA (US), ISO 45001, ICAO methodologies.</li>
        </ul>
    </div>


    <div class="note-card">
        <h3>‚úÖ Conclusion</h3>
        <p>
            The FAR is a universal safety metric used to assess and benchmark occupational safety. By monitoring FAR and applying the proper preventive measures based on the output feedback (Excellent, Moderate, High Risk), organizations can reduce fatalities, comply with safety standards, and improve workplace safety culture.
        </p>
    </div>
</div>


    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateFAR() {
    const fatalities = document.getElementById('fatalities').value.trim();
    const manHours = document.getElementById('manHours').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];

    // Validate Fatalities
    if (fatalities === "") {
        errors.push("üëâ Please enter the number of fatalities.");
    } else {
        const fatalitiesNum = Number(fatalities);
        if (isNaN(fatalitiesNum)) {
            errors.push("üëâ Number of fatalities must be a valid number.");
        } else if (!Number.isInteger(fatalitiesNum)) {
            errors.push("üëâ Number of fatalities must be a whole number.");
        } else if (fatalitiesNum < 0 || fatalitiesNum > 10000) {
            errors.push("üëâ Number of fatalities must be between 0 and 10,000.");
        }
    }

    // Validate Man-Hours
    if (manHours === "") {
        errors.push("üëâ Please enter total man-hours worked.");
    } else {
        const manHoursNum = Number(manHours);
        if (isNaN(manHoursNum)) {
            errors.push("üëâ Total man-hours must be a valid number.");
        } else if (manHoursNum <= 0) {
            errors.push("üëâ Total man-hours must be greater than 0.");
        } else if (manHoursNum > 1000000000) {
            errors.push("üëâ Total man-hours cannot exceed 1,000,000,000.");
        } else if (!/^\d+(\.\d{1,2})?$/.test(manHours)) {
            errors.push("üëâ Total man-hours can have max 2 decimal places.");
        }
    }

    // Cross-field validation
    const fatalitiesNum = Number(fatalities);
    const manHoursNum = Number(manHours);
    if (!isNaN(fatalitiesNum) && !isNaN(manHoursNum)) {
        if (fatalitiesNum > 0 && manHoursNum < fatalitiesNum) {
            errors.push("üëâ Total man-hours cannot be less than fatalities ‚Äî unrealistic input.");
        }
    }

    // Show errors
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // Calculation
    /*
    Formula Reference:  
    FAR = (Fatalities √ó 1,000,000) / Man-Hours
    */
    const FAR = (fatalitiesNum * 1000000) / manHoursNum;
    document.getElementById('rateValue').textContent = FAR.toFixed(2);

    // Performance Assessment
    const meterFill = document.getElementById('meterFill');
    let meterWidth, meterColor, feedback;

    if (FAR === 0) {
        meterWidth = '5%';
        meterColor = '#27ae60';
        feedback = 'üåü Excellent! No fatalities recorded. Maintain safety culture.';
    } else if (FAR < 1.0) {
        meterWidth = '20%';
        meterColor = '#2ecc71';
        feedback = 'üëç Excellent safety record. Continue proactive safety measures.';
    } else if (FAR <= 5.0) {
        meterWidth = '50%';
        meterColor = '#f39c12';
        feedback = '‚ö†Ô∏è Moderate risk. Review safety protocols and implement improvements.';
    } else {
        meterWidth = '95%';
        meterColor = '#e74c3c';
        feedback = '‚ùå High-risk workplace! Urgent safety measures and comprehensive review needed.';
    }

    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;
    document.getElementById('feedbackContent').textContent = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}


        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}

{% comment %} 
‚úÖ Step 1: Formula (for code comments)
/*
Formula:  
FAR = (Number of Fatalities √ó 1,000,000) / Total Man-Hours Worked  

Explanation:  
- Numerator scales fatalities to a ‚Äúper million hours‚Äù basis.  
- Denominator normalizes against exposure hours (man-hours worked).  
- Unit: "Fatalities per 1,000,000 man-hours"  

References:  
- ILO Guidelines on Occupational Injury Statistics  
- OSHA Recordkeeping Standards  
- ISO 45001 & OHSAS 18001 reporting KPIs
*/

‚úÖ Step 2: Input Validation Rules (Industry-Backed)
Number of Fatalities (fatalities)

Must be a whole number (no decimals).

Allowed range: 0 ‚Äì 10,000
(ILO & OSHA consider higher values as improbable for a single workplace report).

Negative values not allowed.

Zero (0) is valid and results in FAR = 0.

Total Man-Hours Worked (manHours)

Must be greater than 0.

Allowed range: 1 ‚Äì 1,000,000,000 (OSHA & industry reporting use caps to avoid inflated/unrealistic entries).

Decimal values allowed, but capped at 2 decimal places.

No scientific notation inputs.

Cross-Field Validations

If fatalities > 0 ‚Üí man-hours must also be > 0.

If man-hours < fatalities ‚Üí likely erroneous (flag as unrealistic).

‚úÖ Step 3: Output Validation & Thresholds

0.00 FAR ‚Üí Excellent (benchmark = no fatalities).

< 1.0 FAR ‚Üí World-class safety (often used in oil & gas sector KPIs).

1.0 ‚Äì 5.0 FAR ‚Üí Moderate risk (requires review).

> 5.0 FAR ‚Üí High-risk workplace (immediate intervention needed).

These thresholds align with NFPA, OSHA benchmarking, and global construction safety norms. {% endcomment %}