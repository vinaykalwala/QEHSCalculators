{% extends 'base.html' %}
{% block title %}ASME (API RP 520) Valves - Minimum Flow Area For Steam Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASME (API RP 520) Valves - Minimum Flow Area For Steam Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
                .btn-container {
    display: flex;
    justify-content: center; /* Horizontally center */
    margin: 30px 0;
}

.back-btn {
    background:linear-gradient(#1560bd,#000040); /* Dark navy background */
    color: #ffffff; /* White text */
    border: 2px solid #1560bd; /* Highlight border */
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none; /* Remove underline for link */
    transition: all 0.3s ease;
    cursor: pointer;
}

.back-btn:hover {
    background-color: #1560bd; /* Highlight on hover */
    color: #ffffff;
    border-color: #000040;
    transform: scale(1.05); /* Subtle hover effect */
}

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            {% comment %} max-width: 700px; {% endcomment %}
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
   
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
    <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
</div>
   <div class="calculator-container printable" id="printArea">

    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>ASME (API RP 520) Valves - Minimum Flow Area For Steam</h1>
            <p>Calculate the required effective discharge area for steam relief valves based on API RP 520 standards</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="massFlow">Mass Flow Rate (·πÅ) (lb/h)</label>
                    <input type="number" id="massFlow" class="form-input" min="0" placeholder="e.g., 5000">
                </div>
                <div class="form-group">
                    <label for="pressure">Upstream Relieving Pressure (PR) (psia)</label>
                    <input type="number" id="pressure" class="form-input" min="0" placeholder="e.g., 150">
                </div>
                <div class="form-group">
                    <label for="Kd">Discharge Coefficient (Kd)</label>
                    <input type="number" id="Kd" class="form-input" min="0" max="1" step="0.01" placeholder="e.g., 0.85">
                </div>
                <div class="form-group">
                    <label for="Ksh">Superheat Correction Factor (KSH)</label>
                    <input type="number" id="Ksh" class="form-input" min="0" step="0.01" placeholder="e.g., 1.0">
                </div>
                
                <button class="calculate-btn" onclick="calculateDischargeArea()">Calculate Required Discharge Area</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Required Effective Discharge Area (A‚ÇÄ)</strong> for steam relief valves. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Required Effective Discharge Area</h2>
                    </div>
                    <div class='rate-display'>
                    <div class="rate-value" id="rateValue">0.0000</div>
                    <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">in¬≤</div></div>

                    <div class="result-feedback">
                        <div class="feedback-title">Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    The <strong>ASME (API RP 520) Valves - Minimum Flow Area For Steam Calculator</strong> helps engineers determine the required effective discharge area for safety valves handling steam. This calculation follows API RP 520 standards to ensure proper valve sizing for overpressure protection.
                </p>
            </div>
            <div class="note-card">
                <h3>‚ùì What is Required Effective Discharge Area?</h3>
                <p>The Required Effective Discharge Area (A‚ÇÄ) is the minimum flow area needed for a safety valve to discharge the required amount of steam at the specified relieving conditions.</p>
            </div>
            <div class="note-card">
                <h3>‚öôÔ∏è Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Mass Flow Rate (·πÅ):</strong> The required mass flow rate that needs to be discharged through the safety valve (lb/h).</li>
                    <li><strong>Upstream Relieving Pressure (P<sub>R</sub>):</strong> The absolute pressure upstream of the valve at relieving conditions (psia).</li>
                    <li><strong>Discharge Coefficient (K<sub>d</sub>):</strong> The effective coefficient of discharge, typically ranging between 0 and 1.</li>
                    <li><strong>Superheat Correction Factor (K<sub>SH</sub>):</strong> A correction factor applied when handling superheated steam.</li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>üìä Interpretation</h3>
                <p>
                    <b>Discharge Area Sizing Guidelines:</b>
                </p>
                <ul class="note-list">
                    <li><span class="good">Below 0.1 in¬≤</span> ‚Üí Small valve suitable for low-flow conditions</li>
                    <li><span class="average">0.1 ‚Äì 2.0 in¬≤</span> ‚Üí Standard valve size for normal applications</li>
                    <li><span class="bad">Above 2.0 in¬≤</span> ‚Üí Large valve required, consider system design review</li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>üöÄ Applications</h3>
                <ul class="note-list">
                    <li><strong>Steam Safety Valve Sizing:</strong> Ensures proper valve selection to prevent excessive pressure buildup.</li>
                    <li><strong>Boiler & Pressure Vessel Protection:</strong> Critical for designing relief systems in industrial steam boilers.</li>
                    <li><strong>Process Safety Management:</strong> Prevents hazardous overpressure situations in steam pipelines and reactors.</li>
                    <li><strong>Industrial Steam Handling:</strong> Used in power plants, refineries, and chemical processing facilities.</li>
                </ul>
            </div>
            
            <div class="note-card">
    <h3>üõ°Ô∏è Input Validation Rules</h3>
    <ul class="note-list">
        <li><strong>Mass Flow Rate (·πÅ):</strong> Must be > 0. Recommended range 100 ‚Äì 10,000,000 lb/h.</li>
        <li><strong>Upstream Relieving Pressure (P<sub>R</sub>):</strong> Must be > 14.7 psia. Typical design max ~5000 psia.</li>
        <li><strong>Discharge Coefficient (K<sub>d</sub>):</strong> Must be between 0 and 1. Typical API RP 520 range 0.62 ‚Äì 0.975.</li>
        <li><strong>Superheat Correction Factor (K<sub>SH</sub>):</strong> Must be > 0. Usually ‚â• 1.0 for superheated steam.</li>
        <li><strong>Edge Cases:</strong> Division by zero, negative values, or unrealistic inputs will trigger error/warning.</li>
    </ul>
</div>

             <div class="note-card">
                <h3>üè≠ ASME (API RP 520) Standard</h3>
                <p>
                    <strong>ASME (API RP 520)</strong> stands for American Society of Mechanical Engineers (American Petroleum Institute Recommended Practice 520). 
                    It provides guidelines for designing and installing pressure relief systems to protect equipment from excessive pressure 
                    in industries like oil & gas, chemical processing, and power generation.
                </p>
            </div>
             <div class="note-card">
                <h3>üìå Conclusion</h3>
                    <p>This tool helps engineers and safety professionals determine the **minimum required discharge area (A‚ÇÄ)** for steam relief valves using the API RP 520 standard. Properly sized valves protect equipment from overpressure, ensuring safe and efficient system operation.</p>
            </div>
        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateDischargeArea() {
    const massFlow = parseFloat(document.getElementById('massFlow').value.trim());
    const pressure = parseFloat(document.getElementById('pressure').value.trim());
    const Kd = parseFloat(document.getElementById('Kd').value.trim());
    const Ksh = parseFloat(document.getElementById('Ksh').value.trim());

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');
    const rateValue = document.getElementById('rateValue');
    const feedbackContent = document.getElementById('feedbackContent');

    let errors = [];
    let warnings = [];

    // === Hard Validations ===
    if (isNaN(massFlow) || massFlow <= 0) {
        errors.push("üëâ Mass flow rate must be greater than 0 lb/h.");
    } else if (massFlow < 100 || massFlow > 10000000) {
        warnings.push("‚ö†Ô∏è Mass flow is outside typical industrial range (100 ‚Äì 10,000,000 lb/h). Please verify.");
    }

    if (isNaN(pressure) || pressure <= 0) {
        errors.push("üëâ Upstream relieving pressure must be greater than 0 psia.");
    } else if (pressure < 14.7) {
        errors.push("üëâ Pressure must be at least atmospheric (14.7 psia).");
    } else if (pressure > 5000) {
        warnings.push("‚ö†Ô∏è Pressure exceeds typical API RP 520 design range (> 5000 psia). Verify inputs.");
    }

    if (isNaN(Kd) || Kd <= 0 || Kd > 1) {
        errors.push("üëâ Discharge coefficient (Kd) must be between 0 and 1.");
    } else if (Kd < 0.62 || Kd > 0.975) {
        warnings.push("‚ö†Ô∏è Kd is outside API RP 520 recommended range (0.62 ‚Äì 0.975).");
    }

    if (isNaN(Ksh) || Ksh <= 0) {
        errors.push("üëâ Superheat correction factor (Ksh) must be greater than 0.");
    } else if (Ksh < 1.0) {
        warnings.push("‚ö†Ô∏è Ksh is typically ‚â• 1.0 for superheated steam. Please check inputs.");
    }

    // === Handle Errors ===
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // === Perform Calculation ===
    const A0 = massFlow / (51.5 * pressure * Kd * Ksh);
    rateValue.textContent = A0.toFixed(4);

    // === Output Feedback ===
    let feedback = "";
    if (A0 < 0.1) {
        feedback = "‚úÖ <strong>Small Valve Size:</strong> Suitable for very low-flow conditions.";
    } else if (A0 >= 0.1 && A0 <= 2.0) {
        feedback = "‚úÖ <strong>Standard Valve Size:</strong> Acceptable for normal safety valve applications.";
    } else if (A0 > 2.0 && A0 <= 10) {
        feedback = "‚ö†Ô∏è <strong>Large Valve Size:</strong> System review recommended for excessive flow.";
    } else {
        feedback = "‚ùå <strong>Unusually Large Valve:</strong> A‚ÇÄ > 10 in¬≤ indicates possible input error or abnormal system.";
    }

    // Append warnings
    if (warnings.length > 0) {
        feedback += "<br><br>" + warnings.join("<br>");
    }

    feedbackContent.innerHTML = feedback;

    placeholder.classList.add("hidden");
    resultValue.classList.remove("hidden");
}

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


{% comment %} 
1. Formula Reference (for code comments)

The formula currently implemented in your calculator:

A‚ÇÄ = ·πÅ / (51.5 √ó P √ó Kd √ó Ksh)


Where:

A‚ÇÄ = Required effective discharge area (in¬≤)

·πÅ = Mass flow rate (lb/h)

P = Upstream relieving pressure (psia)

Kd = Effective discharge coefficient (dimensionless, 0 < Kd ‚â§ 1)

Ksh = Superheat correction factor (dimensionless, ‚â• 1 for superheated steam)

This is consistent with API RP 520 Part I (steam relief sizing).

2. Input Validation Rules (Real-World QEHS/Fire Safety)

‚úÖ Mass Flow Rate (·πÅ, lb/h)

Must be > 0 (cannot be zero/negative).

Recommended range in practice: 100 ‚Äì 10,000,000 lb/h.

Allow up to 2 decimal places for precision.

Too small (< 100 lb/h) or too high (> 10,000,000 lb/h) should trigger a warning, not hard error.

‚úÖ Upstream Relieving Pressure (PR, psia)

Must be > 0 psia.

Commonly ranges 15 psia ‚Äì 5000 psia for industrial systems.

Values below atmospheric (14.7 psia) are illogical unless vacuum design is intended ‚Üí should throw validation error.

Too high (> 5000 psia) ‚Üí warn user to double-check inputs.

‚úÖ Discharge Coefficient (Kd)

Must be between 0.62 and 0.975 in practice (API RP 520 values).

Validation: enforce 0 < Kd ‚â§ 1 hard limit.

Add warning if outside 0.62 ‚Äì 0.975 (may be unrealistic).

‚úÖ Superheat Correction Factor (Ksh)

Must be ‚â• 1.0 (since for saturated steam it‚Äôs 1.0, higher for superheated).

Hard limit: Ksh > 0.

Warn if Ksh < 1.0 (physically non-sensical).

3. Output Validation & Thresholds

Your result interpretation already makes sense, but we‚Äôll refine:

A‚ÇÄ < 0.1 in¬≤ ‚Üí Small valve, verify design adequacy (good for lab or pilot systems).

0.1 ‚Äì 2.0 in¬≤ ‚Üí Typical valve sizing, most compliant.

2.0 ‚Äì 10 in¬≤ ‚Üí Large valve, system review required (warn user).

> 10 in¬≤ ‚Üí Extremely large ‚Üí trigger red warning (possible input error or unusual industrial scenario like very high boilers).

4. Edge Case Validations

Division by zero ‚Üí Prevent if P=0, Kd=0, or Ksh=0.

Unrealistic combinations ‚Üí e.g., very high flow with very low pressure ‚Üí gives unreasonably large A‚ÇÄ. Should show warning.

Negative or null values ‚Üí reject input.

Extreme outliers ‚Üí warn user to double-check system design.

5. Corrected JavaScript Validation Code

Here‚Äôs the updated version with commented formula + validations:

/*
Formula Reference (API RP 520 - Steam Relief Valves):
A‚ÇÄ = ·πÅ / (51.5 √ó P √ó Kd √ó Ksh)

Where:
- A‚ÇÄ  = Required effective discharge area (in¬≤)
- ·πÅ   = Mass Flow Rate (lb/h) ‚Üí must be > 0
- P   = Upstream Relieving Pressure (psia) ‚Üí must be > 14.7 (atmospheric)
- Kd  = Discharge Coefficient (0 < Kd ‚â§ 1, API RP 520 typical: 0.62‚Äì0.975)
- Ksh = Superheat Correction Factor (‚â• 1.0, =1 for saturated steam)

Validation Rules:
- Mass Flow: > 0, recommended 100 ‚Äì 10,000,000 lb/h
- Pressure: > 14.7 psia, recommended max ~5000 psia
- Kd: 0 < Kd ‚â§ 1, warning if outside 0.62 ‚Äì 0.975
- Ksh: > 0, must be ‚â• 1.0 for superheated steam
*/ {% endcomment %}