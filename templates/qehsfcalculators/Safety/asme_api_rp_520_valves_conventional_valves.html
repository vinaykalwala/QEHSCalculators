{% extends 'base.html' %}
{% block title %}ASME (API RP 520) Valves - Conventional Valves Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASME (API RP 520) Valves - Conventional Valves Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
                .btn-container {
    display: flex;
    justify-content: center; /* Horizontally center */
    margin: 30px 0;
}

.back-btn {
    background:linear-gradient(#1560bd,#000040); /* Dark navy background */
    color: #ffffff; /* White text */
    border: 2px solid #1560bd; /* Highlight border */
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none; /* Remove underline for link */
    transition: all 0.3s ease;
    cursor: pointer;
}

.back-btn:hover {
    background-color: #1560bd; /* Highlight on hover */
    color: #ffffff;
    border-color: #000040;
    transform: scale(1.05); /* Subtle hover effect */
}

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            {% comment %} max-width: 700px; {% endcomment %}
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (min-width: 901px) {
            .calc-content { 
                flex-direction: row; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
            order: 2;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            min-height: 320px;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Input rows for side-by-side fields */
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }

        /* Mobile-specific adjustments */
        @media (max-width: 320px) {
            .calculator-container {
                padding: 10px;
            }
            
            .calculator-header h1 {
                font-size: 1.8rem;
            }
            
            .calculator-header p {
                font-size: 16px;
            }
            
            .calc-card, .result-card {
                padding: 20px 15px;
                border-radius: 12px;
            }
            
            .calc-card h2 {
                font-size: 1.4rem;
            }
            
            .form-input {
                padding: 12px 14px;
                font-size: 14px;
            }
            
            .calculate-btn {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .result-placeholder img {
                max-width: 180px;
            }
            
            .rate-value {
                font-size: 36px;
            }
            
            .note-card {
                padding: 15px 18px;
            }
            
            .note-card h3 {
                font-size: 16px;
            }
            
            .note-card p, .note-card li {
                font-size: 14px;
            }
        }
        
        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: block;
        }
    </style>
</head>
<body>
    <div class="btn-container">
    <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
</div>
   <div class="calculator-container printable" id="printArea">

    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>ASME (API RP 520) Valves - Conventional Valves Calculator</h1>
            <p>Calculate the percentage of gauge backpressure in a relief valve system</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                
                <div class="form-group">
                    <label for="Pb"><strong>Backpressure (Pb) in psi g:</strong></label>
                    <input type="number" id="Pb" class="form-input" min="0" placeholder="e.g., 50">
                    <span class="error" id="pbError"></span>
                </div>

                <div class="form-group">
                    <label for="Pr"><strong>Relieving Pressure (Pr) in psi g:</strong></label>
                    <input type="number" id="Pr" class="form-input" min="0" placeholder="e.g., 100">
                    <span class="error" id="prError"></span>
                </div>
                
                <button class="calculate-btn" onclick="calculateBackpressure()">Calculate Backpressure Percentage</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2313/2313916.png" alt="Pressure valve illustration">
                    <p>This tool will calculate the <strong>Gauge Backpressure Percentage</strong> for conventional valves. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Backpressure Percentage</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">%</div>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">System Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    This calculator determines the <strong>percentage of gauge backpressure</strong> in a relief valve system according to ASME (API RP 520) standards. 
                    It helps determine how much backpressure exists relative to the relieving pressure, which is critical for safety system design and operation.
                </p>
            </div>

            <div class="note-card">
                <h3>‚öôÔ∏è Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Pb (Backpressure):</strong> The pressure that remains in the discharge system after the valve releases (in psi g).</li>
                    <li><strong>Pr (Relieving Pressure):</strong> The pressure at which the relief valve is designed to open (in psi g).</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>üìà Interpretation</h3>
                <p>
                    <b>Higher backpressure percentages</b> indicate potential system issues. Generally:
                </p>
                <ul class="note-list">
                    <li><span class="good">Below 10%</span> ‚Üí Normal operating conditions</li>
                    <li><span class="average">10% ‚Äì 30%</span> ‚Üí Requires monitoring</li>
                    <li><span class="bad">Above 30%</span> ‚Üí May cause valve performance issues</li>
                    <li><span class="bad">Above 50%</span> ‚Üí Critical condition requiring immediate attention</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>üîç Why Is This Important?</h3>
                <p>
                    Monitoring backpressure percentage is crucial for:
                </p>
                <ul class="note-list">
                    <li><strong>System Safety:</strong> Ensuring relief valves function properly during overpressure events</li>
                    <li><strong>Regulatory Compliance:</strong> Meeting ASME and API standards for pressure relief systems</li>
                    <li><strong>Equipment Protection:</strong> Preventing damage to vessels, pipes, and other components</li>
                    <li><strong>Process Reliability:</strong> Maintaining consistent operation of industrial processes</li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>üè≠ Real-Life Applications</h3>
                <p>
                    This calculation is used in various industries:
                </p>
                <ul class="note-list">
                    <li><strong>Oil & Gas:</strong> Prevents overpressure hazards in pipelines and storage units</li>
                    <li><strong>Chemical Processing:</strong> Protects reactors and vessels from dangerous pressure buildup</li>
                    <li><strong>Power Generation:</strong> Ensures boiler and steam system safety</li>
                    <li><strong>HVAC Systems:</strong> Maintains safe pressure limits in refrigeration systems</li>
                </ul>
            </div>
          
             <div class="note-card">
                <h3>üè≠ ASME (API RP 520) Standard</h3>
                <p>
                    <strong>ASME (API RP 520)</strong> stands for American Society of Mechanical Engineers (American Petroleum Institute Recommended Practice 520). 
                    It provides guidelines for designing and installing pressure relief systems to protect equipment from excessive pressure 
                    in industries like oil & gas, chemical processing, and power generation.
                </p>
            </div>
            <div class="note-card">
    <h3>‚úÖ Input Validation Rules</h3>
    <ul class="note-list">
        <li><strong>Pb (Backpressure):</strong> Must be ‚â• 0 psi g and ‚â§ 5000 psi g.</li>
        <li><strong>Pr (Relieving Pressure):</strong> Must be > 0 psi g and ‚â§ 10,000 psi g.</li>
        <li><strong>Pb ‚â§ Pr:</strong> Backpressure cannot exceed relieving pressure.</li>
        <li><strong>Units:</strong> Both Pb and Pr must be in psi g (gage pressure).</li>
        <li><strong>Precision:</strong> Results rounded to 4 decimal places for reporting.</li>
        <li><strong>Cross-check:</strong> If Backpressure % > 50% ‚Üí Flag as <b>Critical</b> condition.</li>
    </ul>
</div>

             <div class="note-card">
                <h3>üìå Conclusion</h3>
                <ul>
                   <li>Monitoring the <strong>backpressure-to-relieving-pressure ratio</strong> is vital for <strong>safety compliance</strong>.</li>
                   <li>If <strong>Pb is too high</strong>, the valve may not relieve pressure properly, leading to <strong>dangerous conditions</strong>.</li>
                   <li>Regular <strong>maintenance and checks</strong> ensure proper system performance.</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateBackpressure() {
    const Pb = document.getElementById('Pb').value.trim();
    const Pr = document.getElementById('Pr').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');
    const pbError = document.getElementById('pbError');
    const prError = document.getElementById('prError');

    // Reset previous errors
    pbError.textContent = "";
    prError.textContent = "";
    errorBox.classList.add("hidden");

    let errors = [];

    // Empty checks
    if (Pb === "") errors.push("üëâ Please enter the backpressure (Pb) value.");
    if (Pr === "") errors.push("üëâ Please enter the relieving pressure (Pr) value.");

    // Numeric checks only if not empty
    if (errors.length === 0) {
        const pb = parseFloat(Pb);
        const pr = parseFloat(Pr);

        // ---- Validation Rules ----
        // Pb cannot be negative
        if (pb < 0) {
            pbError.textContent = "Backpressure (Pb) cannot be negative.";
            errors.push("üëâ Backpressure (Pb) cannot be negative.");
        }

        // Pr must be > 0
        if (pr <= 0) {
            prError.textContent = "Relieving pressure (Pr) must be greater than zero.";
            errors.push("üëâ Relieving pressure (Pr) must be greater than zero.");
        }

        // Pb should not exceed Pr
        if (pb > pr) {
            errors.push("üëâ Backpressure (Pb) should not exceed relieving pressure (Pr).");
        }

        // Practical engineering ranges (ASME/API typical)
        if (pb > 5000) {
            errors.push("üëâ Backpressure (Pb) value too high for typical relief valve applications.");
        }
        if (pr > 10000) {
            errors.push("üëâ Relieving pressure (Pr) value exceeds typical equipment design range.");
        }
    }

    if (errors.length > 0) {
        // Show error box
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    const pb = parseFloat(Pb);
    const pr = parseFloat(Pr);

    // ---- Formula ----
    // Backpressure % = (Pb / Pr) * 100
    const backpressurePercentage = (pb / pr) * 100;
    document.getElementById('rateValue').textContent = backpressurePercentage.toFixed(4);

    // ---- Feedback Logic ----
    let feedback;
    if (backpressurePercentage === 0) {
        feedback = '‚úÖ Excellent! No backpressure detected. System is operating optimally.';
    } else if (backpressurePercentage < 10) {
        feedback = 'üëç Normal operating conditions. Backpressure is within acceptable limits.';
    } else if (backpressurePercentage <= 30) {
        feedback = '‚ö†Ô∏è Moderate backpressure. Monitor system performance and consider inspection.';
    } else if (backpressurePercentage <= 50) {
        feedback = 'üö® High backpressure. System performance may be affected. Inspection recommended.';
    } else {
        feedback = '‚ùå Critical backpressure level! Immediate attention required. Valve may not function properly.';
    }

    document.getElementById('feedbackContent').textContent = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}


        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


{% comment %} 
1Ô∏è‚É£ Real-world Formula

üìå Formula used in your calculator (per ASME / API RP 520):

// Formula: Backpressure Percentage (%) = (Pb / Pr) * 100
// Pb = Backpressure (psi g)
// Pr = Relieving Pressure (psi g)

2Ô∏è‚É£ Input Validation Rules (Industry-aligned)

These validations ensure safety-critical data is logical, realistic, and standard-compliant:

Input	Rule	Acceptable Range	Reason (QEHS/Fire Safety)
Pb (Backpressure)	Must be ‚â• 0	0 ‚Äì 5000 psi (typical upper bound, configurable)	Negative values impossible in gage pressure. Backpressure above ~5000 psi unrealistic in most relief systems.
Pr (Relieving Pressure)	Must be > 0	1 ‚Äì 10,000 psi (as per ASME/API equipment design ranges)	A relief valve must have positive set pressure. Zero or negative = meaningless.
Pb ‚â§ Pr	Always true	Logical dependency	Backpressure cannot exceed relieving pressure (would cause valve failure).
Decimal Precision	Max 4 decimals	Avoid false precision	Safety reports typically round to 2‚Äì4 decimals.
Unit Consistency	Both Pb and Pr in psi g	No mixing absolute/atmospheric	Prevents reporting/engineering errors.
Cross-field Dependency	If Pb/Pr > 50% ‚Üí highlight critical	Aligns with ASME/API recommended limits	Ensures compliance-based warning output.
3Ô∏è‚É£ Edge Case Validations

Division by zero ‚Üí If Pr = 0, block calculation.

Pb = 0, Pr > 0 ‚Üí Return 0% (valid, safe).

Pb = Pr ‚Üí Return 100% ‚Üí Always critical condition.

Pb >> Pr (e.g., Pb = 2000, Pr = 100) ‚Üí Reject as illogical.

Extremely small Pr (e.g., 0.001 psi) ‚Üí Reject as non-physical.

4Ô∏è‚É£ Output Validation & Thresholds

‚úÖ Output must align with ASME/API practice:

Backpressure %	System Assessment
0% ‚Üí	Excellent, no backpressure.
< 10% ‚Üí	Normal operating range.
10 ‚Äì 30% ‚Üí	Monitor condition, possible issues.
30 ‚Äì 50% ‚Üí	High, performance degradation likely.
> 50% ‚Üí	Critical ‚Üí Non-compliance with API RP 520. Immediate corrective action. {% endcomment %}