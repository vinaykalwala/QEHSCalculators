{% extends 'base.html' %}
{% block title %}Tension Per Leg Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tension Per Leg Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 12px;
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px; /* Fixed Height */
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
            justify-content: center;
            align-items: center;
            min-height: 420px; /* Fixed Height */
            text-align: center;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background:linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }
        
        /* Result Card */
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }
        
        .sub-results {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eaeaea;
        }

        .sub-result-item {
            text-align: center;
        }
        
        .sub-result-value {
            font-size: 20px;
            font-weight: 600;
            color: #34495e;
        }

        .sub-result-label {
            font-size: 14px;
            color: #7f8c8d;
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        /* Note Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }

        /* Error Box */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">

        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Tension Per Leg Calculator</h1>
            <p>Calculate the true tension on each sling leg to ensure safe lifting operations and proper equipment selection.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Enter Rigging Parameters</h2>
                <div class="form-group">
                    <label for="totalLoad">Total Load (W) [kg]</label>
                    <input type="number" id="totalLoad" class="form-input" placeholder="e.g., 10000">
                </div>
                <div class="form-group">
                    <label for="numLegs">Number of Legs (N)</label>
                    <input type="number" id="numLegs" class="form-input" placeholder="e.g., 4">
                </div>
                <div class="form-group">
                    <label for="slingLength">Sling Length (L) [m]</label>
                    <input type="number" id="slingLength" class="form-input" placeholder="e.g., 5">
                </div>
                <div class="form-group">
                    <label for="verticalHeight">Vertical Height (H) [m]</label>
                    <input type="number" id="verticalHeight" class="form-input" placeholder="e.g., 4">
                </div>
                <button class="calculate-btn" onclick="calculateTension()">Calculate Tension</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Crane lifting illustration">
                    <p>Enter your load and rigging geometry to calculate the tension per leg and assess the safety of the lift angle.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                    
                <div class="result-value hidden" id="resultValue">
                    <div class="rate-value" id="rateValue">0.00</div>
                    <div class="rate-label" id="rateLabel">Tension Per Leg (kg)</div>
                    
                    <div class="sub-results">
                        <div class="sub-result-item">
                            <div class="sub-result-value" id="tensionFactor">0.00</div>
                            <div class="sub-result-label">Tension Factor (L/H)</div>
                        </div>
                        <div class="sub-result-item">
                            <div class="sub-result-value" id="weightPerLeg">0 kg</div>
                            <div class="sub-result-label">Weight per Leg</div>
                        </div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Safe</span><span>Good</span><span>Caution</span><span>Danger</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Lift Safety Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>📘 About Sling Tension</h3>
                <p>
                    When lifting a load with a multi-legged sling at an angle, the tension in each leg is significantly higher than the simple divided weight. This is due to the horizontal forces created by the angle. This calculator determines this true tension, which is essential for selecting a sling with an adequate Working Load Limit (WLL) and preventing catastrophic failure.
                </p>
            </div>
            <div class="note-card">
                <h3>⚙️ Formula Used</h3>
                <p>The tension (T) in each sling leg is calculated by multiplying the weight per leg by the Tension Factor.</p>
                <p>$$ T = \left( \frac{W}{N} \right) \times \left( \frac{L}{H} \right) $$</p>
                <ul class="note-list">
                    <li>$W$ = Total Load (kg)</li>
                    <li>$N$ = Number of Legs</li>
                    <li>$L$ = Sling Length (m)</li>
                    <li>$H$ = Vertical Height (m)</li>
                </ul>
            </div>
             <div class="note-card">
                <h3>⚠️ Safety First: The Sling Angle</h3>
                <p>
                    The ratio of Length to Height (L/H), or the **Tension Factor**, is the most critical indicator of a safe lift. A low vertical height (H) compared to the sling length (L) creates a shallow angle and dangerously high tension. Industry best practice recommends keeping sling angles greater than 45 degrees, and angles below 30 degrees should be avoided entirely.
                </p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateTension() {
            const W_val = document.getElementById('totalLoad').value.trim();
            const N_val = document.getElementById('numLegs').value.trim();
            const L_val = document.getElementById('slingLength').value.trim();
            const H_val = document.getElementById('verticalHeight').value.trim();

            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValue = document.getElementById('resultValue');

            let errors = [];

            // --- VALIDATION RULES ---
            if (W_val === '' || isNaN(W_val) || parseFloat(W_val) <= 0) errors.push("👉 Total Load must be a number > 0.");
            if (L_val === '' || isNaN(L_val) || parseFloat(L_val) <= 0) errors.push("👉 Sling Length must be a number > 0.");
            if (H_val === '' || isNaN(H_val) || parseFloat(H_val) <= 0) errors.push("👉 Vertical Height must be a number > 0.");
            
            const N = parseFloat(N_val);
            if (N_val === '' || isNaN(N) || N <= 0) {
                errors.push("👉 Number of Legs must be a number > 0.");
            } else if (!Number.isInteger(N)) {
                errors.push("👉 Number of Legs must be a whole number.");
            }

            if (parseFloat(H_val) > parseFloat(L_val)) {
                errors.push("👉 Height (H) cannot be greater than Length (L). This is a physical impossibility for a sling in tension.");
            }
            
            // --- ERROR HANDLING ---
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValue.classList.add("hidden");
                return;
            } else {
                errorBox.classList.add("hidden");
            }

            // --- CALCULATION ---
            const W = parseFloat(W_val);
            const L = parseFloat(L_val);
            const H = parseFloat(H_val);

            const weightPerLeg = W / N;
            const tensionFactor = L / H;
            const tensionPerLeg = weightPerLeg * tensionFactor;

            if (!isFinite(tensionPerLeg)) {
                errorMessage.innerHTML = "❌ Calculation resulted in an invalid number. Please check your inputs.";
                errorBox.classList.remove("hidden");
                resultValue.classList.add("hidden");
                return;
            }

            document.getElementById('rateValue').textContent = tensionPerLeg.toFixed(2);
            document.getElementById('tensionFactor').textContent = tensionFactor.toFixed(3);
            document.getElementById('weightPerLeg').textContent = weightPerLeg.toFixed(2) + ' kg';
            
            // --- ASSESSMENT ---
            const meterFill = document.getElementById('meterFill');
            const requiredWLL = Math.ceil(tensionPerLeg);
            let meterWidth, meterColor, feedback;

            if (tensionFactor <= 1.155) { // Angle >= 60 deg
                meterWidth = '20%';
                meterColor = '#2ecc71'; // Green
                feedback = `✅ <strong>Safe Angle.</strong> The sling angle is optimal (>60°). Each leg requires a Working Load Limit (WLL) of at least <strong>${requiredWLL} kg</strong>.`;
            } else if (tensionFactor <= 1.414) { // Angle >= 45 deg
                meterWidth = '45%';
                meterColor = '#f1c40f'; // Yellow
                feedback = `👍 <strong>Good Angle.</strong> The sling angle is acceptable (45°-60°). Each leg requires a WLL of at least <strong>${requiredWLL} kg</strong>.`;
            } else if (tensionFactor <= 2.0) { // Angle >= 30 deg
                meterWidth = '70%';
                meterColor = '#e67e22'; // Orange
                feedback = `🟡 <strong>Caution.</strong> Sling angle is low (30°-45°), increasing tension significantly. Each leg requires a WLL of at least <strong>${requiredWLL} kg</strong>.`;
            } else { // Angle < 30 deg
                meterWidth = '95%';
                meterColor = '#e74c3c'; // Red
                feedback = `❌ <strong>Danger!</strong> Sling angle is below 30°. Tension is dangerously high. **Do not attempt this lift.** Increase the vertical height (H).`;
            }

            meterFill.style.width = meterWidth;
            meterFill.style.backgroundColor = meterColor;
            document.getElementById('feedbackContent').innerHTML = feedback;

            placeholder.classList.add("hidden");
            resultValue.classList.remove("hidden");
        }

        function printReport() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}