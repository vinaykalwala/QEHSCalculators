{% extends 'base.html' %}
{% block title %}Pipe Fittings Pressure Loss Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipe Fittings Pressure Loss Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 430px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 5px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }
        
        .hint {
            font-size: 12px;
            color: #d0e6ff;
            margin-top: 5px;
            font-style: italic;
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .rate-display {
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
            font-size: 18px;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Note Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Pipe Fittings Pressure Loss Calculator</h1>
            <p>Calculate the pressure loss caused by pipe fittings, valves, and other components in fluid systems</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="kFactor">Resistance Coefficient (K)</label>
                    <input type="number" id="kFactor" class="form-input" step="0.1" min="0.1" max="10" placeholder="e.g., 0.9">
                    <p class="hint">Typical values: 90° elbow (0.3), Tee (1.8), Gate valve (0.2)</p>
                </div>
                <div class="form-group">
                    <label for="density">Fluid Density (ρ)</label>
                    <input type="number" id="density" class="form-input" step="0.1" min="0.1" placeholder="e.g., 1000 kg/m³">
                </div>
                <div class="form-group">
                    <label for="velocity">Fluid Velocity (V)</label>
                    <input type="number" id="velocity" class="form-input" step="0.1" min="0.1" placeholder="e.g., 2.5 m/s">
                </div>
                
                <button class="calculate-btn" onclick="calculateMinorLoss()">Calculate Pressure Loss</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Pressure Loss</strong> caused by pipe fittings. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Pressure Loss Result</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label" id="rateLabel" style="color:#2980b9; font-size:20px; font-weight:bold;">Pascals (Pa)</div>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">System Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

<!-- Notes Section -->
<div class="note-section">

    <!-- 1. About -->
    <div class="note-card">
        <h3>📘 About This Calculator</h3>
        <p>
            The <strong>Pipe Fittings Pressure Loss Calculator</strong> computes the pressure drop caused 
            by fittings, valves, and bends in fluid systems. These localized (minor) losses occur due to 
            turbulence from sudden changes in velocity and direction, and they are critical in hydraulic 
            and safety system design.
        </p>
    </div>

    <!-- 2. Parameters -->
    <div class="note-card">
        <h3>⚙️ Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Resistance Coefficient (K):</strong> Dimensionless factor based on fitting type (e.g., elbow, tee, valve).</li>
            <li><strong>Fluid Density (ρ):</strong> Mass per unit volume of fluid (kg/m³).</li>
            <li><strong>Fluid Velocity (V):</strong> Flow velocity of the fluid (m/s).</li>
           
        </ul>
    </div>

    <!-- 3. Input Validation Rules -->
    <div class="note-card">
        <h3>✅ Input Validation Rules</h3>
        <ul class="note-list">
            <li><b>Resistance Coefficient (K):</b> 0.1 ≤ K ≤ 10.0</li>
            <li><b>Fluid Density (ρ):</b> 1 ≤ ρ ≤ 2000 kg/m³ (warn if >2000)</li>
            <li><b>Fluid Velocity (V):</b> 0.1 ≤ V ≤ 20 m/s (warn if >20)</li>
            <li><b>Cross-checks:</b> unrealistic combinations trigger safety warnings</li>
            <li><b>Units:</b> Inputs must be in SI (kg/m³, m/s, Pa)</li>
        </ul>
    </div>

    <!-- 4. Output Validations -->
    <div class="note-card">
        <h3>📊 Output Validations</h3>
        <p>The calculator classifies results into safety levels. These feedback messages are displayed in the results:</p>
        <ul class="note-list">
            <li><b>&lt; 500 Pa:</b> ✅ Minimal pressure loss – negligible impact.</li>
            <li><b>500 – 5000 Pa:</b> 🔵 Moderate pressure loss – acceptable but consider in design.</li>
            <li><b>5000 – 20000 Pa:</b> ⚠️ Significant pressure loss – review design.</li>
            <li><b>&gt; 20000 Pa:</b> ❌ Excessive pressure loss – redesign required.</li>
            <li><b>Extra Note:</b> ⚠️ If K &gt; 5 → “High K-factor detected, confirm correct fitting type.”</li>
        </ul>
    </div>

    <!-- 5. Standards -->
    <div class="note-card">
        <h3>📋 Standards</h3>
        <p>
            This calculator follows recognized engineering references:  
            <b>Crane Technical Paper 410</b> (flow of fluids, K-factors),  
            <b>ASHRAE Fundamentals</b> (HVAC system losses), and  
            <b>NFPA 13</b> (fire sprinkler hydraulic calculations).  
            Thresholds are aligned with industry best practices for fluid system safety and efficiency.
        </p>
    </div>

</div>


    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateMinorLoss() {
    const kFactor = document.getElementById('kFactor').value.trim();
    const density = document.getElementById('density').value.trim();
    const velocity = document.getElementById('velocity').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');
    const rateValue = document.getElementById('rateValue');
    const rateLabel = document.getElementById('rateLabel');
    const feedbackContent = document.getElementById('feedbackContent');

    let errors = [];

    // --- Resistance Coefficient Validation ---
    if (kFactor === "" || isNaN(kFactor)) {
        errors.push("👉 Please enter the resistance coefficient (K).");
    } else if (parseFloat(kFactor) < 0.1) {
        errors.push("👉 Resistance coefficient (K) must be at least 0.1.");
    } else if (parseFloat(kFactor) > 10) {
        errors.push("👉 Resistance coefficient (K) cannot exceed 10.0 (check fitting type).");
    }

    // --- Fluid Density Validation ---
    if (density === "" || isNaN(density)) {
        errors.push("👉 Please enter the fluid density (ρ).");
    } else if (parseFloat(density) < 1) {
        errors.push("👉 Fluid density must be ≥ 1 kg/m³.");
    } else if (parseFloat(density) > 2000) {
        errors.push("👉 Fluid density seems too high (>2000 kg/m³). Check your units.");
    }

    // --- Fluid Velocity Validation ---
    if (velocity === "" || isNaN(velocity)) {
        errors.push("👉 Please enter the fluid velocity (V).");
    } else if (parseFloat(velocity) < 0.1) {
        errors.push("👉 Fluid velocity must be ≥ 0.1 m/s.");
    } else if (parseFloat(velocity) > 20) {
        errors.push("👉 Fluid velocity is unusually high (>20 m/s). Check for safety/design issues.");
    }

    // --- Error Handling ---
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // --- Safe Calculations ---
    const K = parseFloat(kFactor);
    const rho = parseFloat(density);
    const V = parseFloat(velocity);

    const deltaP = K * (rho * Math.pow(V, 2)) / 2;
    if (!isFinite(deltaP) || deltaP <= 0) {
        errorMessage.innerHTML = "❌ Calculation error: invalid input combination.";
        errorBox.classList.remove("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    const deltaP_psi = deltaP * 0.000145038; // Pa → psi

    // --- Display Results ---
    rateValue.textContent = deltaP.toFixed(2);
    rateLabel.textContent = `Pascals (Pa) | ${deltaP_psi.toFixed(6)} psi`;

    let feedback = '';
    if (deltaP < 500) {
        feedback = '✅ Minimal pressure loss - negligible impact.';
    } else if (deltaP < 5000) {
        feedback = '🔵 Moderate pressure loss - acceptable but consider in design.';
    } else if (deltaP < 20000) {
        feedback = '⚠️ Significant pressure loss - review design.';
    } else {
        feedback = '❌ Excessive pressure loss - redesign required.';
    }

    // Extra K-factor check
    if (K > 5) {
        feedback += `<br><br>⚠️ Note: High K-factor (${K}). Confirm correct fitting type.`;
    }

    feedbackContent.innerHTML = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}

{% comment %} 

/* 
---------------------------------------------
Pipe Fittings Pressure Loss Calculator
Formula: ΔP = K * (ρ * V²) / 2
- K = Resistance Coefficient (dimensionless)
- ρ = Fluid Density (kg/m³)
- V = Fluid Velocity (m/s)
Validation Ranges (per Crane TP-410, NFPA 13, ASHRAE):
- K: 0.1 ≤ K ≤ 10.0
- ρ: 1 ≤ ρ ≤ 2000 kg/m³ (warn if > 2000)
- V: 0.1 ≤ V ≤ 20 m/s (warn if > 20)
Safety Thresholds (Pa):
- < 500 → Minimal
- 500–5000 → Moderate
- 5000–20000 → Significant
- > 20000 → Excessive (redesign required)
---------------------------------------------
*/


1️⃣ Formula Review (for code comments)

The formula you are using:

Δ
𝑃
=
𝐾
⋅
𝜌
⋅
𝑉
2
2
ΔP=K⋅
2
ρ⋅V
2
	​


Where:

ΔP = Pressure loss due to fitting (Pa)

K = Resistance coefficient (dimensionless, fitting dependent)

ρ (rho) = Fluid density (kg/m³)

V = Fluid velocity (m/s)

This is the standard minor losses equation per Crane TP-410, ASHRAE Fundamentals, and referenced in NFPA 13 for fire sprinkler design.

✅ Formula is correct and industry-accepted.

2️⃣ Input Validation Rules (with QEHS/Fire Safety justification)
Resistance Coefficient (K)

Range: 0.1 ≤ K ≤ 10.0

Decimals: up to 2 decimals allowed (fitting tables usually don’t exceed 1–2 precision).

Justification: Published K values (Crane TP-410, ASHRAE) for fittings range from 0.2 (gate valve) up to ~8–10 (sudden contraction). Higher values are not realistic.

Fluid Density (ρ)

Range: 1 ≤ ρ ≤ 2000 kg/m³

Edge: Warn if ρ > 2000 (possible unit confusion, e.g., lb/ft³ entered as SI).

Justification:

Water = 1000 kg/m³

Gases ~1–10 kg/m³

Slurries or heavy liquids can go to ~1500–1800.

Above 2000 is physically unrealistic.

Fluid Velocity (V)

Range: 0.1 ≤ V ≤ 20 m/s

Edge: Warn if V > 20 (erosion risk, noise, cavitation hazard).

Justification:

NFPA 13 recommends velocities < 6–7 m/s for sprinkler piping.

ASHRAE duct systems < 20 m/s.

Higher velocities = turbulent flow, safety risk, and unrealistic designs.

Cross-field dependencies

If ρ < 5 kg/m³ and V < 0.5 m/s → system may not sustain flow (practical warning).

If ΔP > 20000 Pa (20 kPa) → raise safety alert: excessive losses, pump sizing must be rechecked (NFPA/OSHA compliance risk).

Ensure all values are entered in consistent units (no mixing of Imperial/SI).

3️⃣ Output Validation & Thresholds

< 500 Pa → ✅ Minimal impact (efficient system).

500 – 5000 Pa → 🔵 Moderate, acceptable in most designs.

5000 – 20000 Pa → ⚠️ Significant; redesign or pump adjustment may be needed.

> 20000 Pa → ❌ Unsafe, redesign mandatory.

👉 These thresholds align with NFPA 13 (sprinkler hydraulic calculations) and Crane TP-410 guidelines for system safety. {% endcomment %}