{% extends 'base.html' %}
{% block title %}Flow Area of Safety Valve Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Area of Safety Valve Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
/* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        /* Input rows for side-by-side fields */
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            height: 420px;
            overflow-y: auto;
            text-align: center;
            {% comment %} margin-top: 20px; {% endcomment %}
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
        
        .error {
            color: #e74c3c;
            font-size: 14px;
            {% comment %} margin-top: 5px; {% endcomment %}
            display: block;
        }
        
        .success {
            color: #27ae60;
            font-size: 16px;
            margin-top: 15px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Flow Area of Safety Valve Calculator</h1>
            <p>Calculate the flow area of a safety valve based on inlet diameter for proper pressure relief sizing</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                
                <div class="form-group">
                    <label for="diameter">Inlet Diameter (mm)</label>
                    <input type="number" id="diameter" class="form-input" min="0" step="any" placeholder="e.g., 50">
                </div>
                
                <div class="form-group">
                    <label for="piValue">Pi (π)</label>
                    <input type="text" id="piValue" class="form-input" value="3.1416" readonly>
                </div>
                
                <button class="calculate-btn" onclick="calculateFlowArea()">Calculate Flow Area</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                  <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">

                    <p>This tool will calculate the <strong>Flow Area of a Safety Valve</strong>. Enter the inlet diameter to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd; margin-top:10px;">
                        <h2>Flow Area Calculation Results</h2>
                    </div>
                    <div class='rate-display'>
                    <div class="rate-value" id="sqUnitsValue">0.00</div>
                    <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">mm²</div></div>
                    <div class='rate-display'>
                    <div class="rate-value" id="sqMetersValue">0.00</div>
                    <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">mm²</div></div>

                    <div class="result-feedback">
                        <div class="feedback-title">Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

<!-- Notes Section -->
<div class="note-section">

    <div class="note-card">
        <h3>📘 About This Calculator</h3>
        <p>
            The <strong>Flow Area of a Safety Valve</strong> is a critical parameter in pressure relief system design. 
            It represents the cross-sectional area available for fluid or gas flow through the valve, which directly impacts 
            the valve's capacity to relieve pressure and prevent system overpressure conditions.
        </p>
    </div>

    <div class="note-card">
        <h3>⚙️ Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Inlet Diameter (mm):</strong> The diameter of the safety valve's inlet port at its narrowest point.</li>
            <li><strong>Pi (π):</strong> Mathematical constant approximately equal to 3.1416.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>✅ Input Validation Rules</h3>
        <ul class="note-list">
            <li><strong>Inlet Diameter:</strong> Must be a positive number greater than 0.</li>
            <li><strong>Practical Range:</strong> Typically between 5 mm and 500 mm (per API 520 / ISO 4126).</li>
            <li><strong>Unrealistically Small:</strong> Values below 1 mm are flagged.</li>
            <li><strong>Large Inputs:</strong> 500–1000 mm flagged for verification; >1000 mm rejected.</li>
            <li><strong>Decimals:</strong> Up to 2 decimals allowed (e.g., 50.25 mm).</li>
            <li><strong>No Negative / Zero:</strong> Invalid input.</li>
        </ul>
        <p><b>Note:</b> These rules ensure compliance with <b>ASME BPVC, API 520/521, ISO 4126</b> standards for safety valves.</p>
    </div>

    <div class="note-card">
        <h3>📊 Output Validations & Assessment</h3>
        <ul class="note-list">
            <li><strong>Flow Area &lt; 100 mm²:</strong> ⚠️ Small Flow Area: Suitable only for low-flow safety applications. Confirm adequacy.</li>
            <li><strong>Flow Area 100–10,000 mm²:</strong> ✅ Standard Flow Area: Within the common industrial range.</li>
            <li><strong>Flow Area &gt; 10,000 mm²:</strong> 🚨 Large Flow Area: Designed for high-capacity systems. Ensure compatibility with process requirements.</li>
        </ul>
        <p><b>Feedback displayed in results:</b> The same text above is shown dynamically in the calculator after calculation.</p>
    </div>

    <div class="note-card">
        <h3>📚 Governing Principle</h3>
        <p>
            The flow area of a safety valve is calculated according to standards such as ISO 4126-1 (for general use) and 
            the ASME Boiler and Pressure Vessel Code (Section VIII) or API 520/521 (for ASME region applications). 
            The specific standard to use depends on the region and the system's application, as different standards provide 
            specific guidelines for sizing safety valves for gases, liquids, and steam. 
        </p>
        <ul class="note-list">
            <li><strong>ISO 4126-1:</strong> Provides general requirements for safety valves, including minimum flow area sizing and incorporates values for the isentropic exponent (k) for steam, air, and gas.</li>
            <li><strong>ASME Code:</strong> Section VIII offers detailed rules for sizing and selecting pressure relief devices and often references API 520 for specific sizing procedures in North America.</li>
            <li><strong>Key Factors:</strong> Fluid properties (density, viscosity, k), system parameters (set/back pressure, superheat), and discharge coefficient (K_d or α) are considered in calculations.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>📝 Conclusion</h3>
        <p>
            Proper flow area calculation ensures that safety valves operate efficiently, preventing overpressure while complying 
            with international standards. Using the validated input ranges and understanding the assessment feedback helps 
            engineers select and verify appropriate safety valves for industrial applications.
        </p>
    </div>

</div>


    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateFlowArea() {
    const diameterInput = document.getElementById('diameter').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];

    // Input validation
    if (diameterInput === "") {
        errors.push("👉 Please enter the inlet diameter.");
    } else {
        const diameter = parseFloat(diameterInput);

        if (isNaN(diameter)) {
            errors.push("👉 Inlet diameter must be a valid number.");
        } else if (diameter <= 0) {
            errors.push("👉 Inlet diameter must be greater than zero.");
        } else if (diameter < 1) {
            errors.push("👉 Diameter value is unrealistically small (<1 mm). Please verify.");
        } else if (diameter < 5) {
            errors.push("⚠️ Diameter below typical industrial range (<5 mm). Check input.");
        } else if (diameter > 500 && diameter <= 1000) {
            errors.push("⚠️ Diameter is larger than typical range (>500 mm). Verify if correct.");
        } else if (diameter > 1000) {
            errors.push("👉 Diameter value is not realistic (>1000 mm). Please recheck.");
        }
    }

    // Show errors
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // Calculation
    const diameter = parseFloat(diameterInput);
    const pi = 3.1416;

    const flowAreaSqUnits = (pi * Math.pow(diameter, 2)) / 4;  // mm²
    const flowAreaMSquare = flowAreaSqUnits / 1000000;         // m²

    // Update results
    document.getElementById('sqUnitsValue').textContent = flowAreaSqUnits.toFixed(2) + " mm²";
    document.getElementById('sqMetersValue').textContent = flowAreaMSquare.toFixed(6) + " m²";

    // Output assessment
    let feedback = "";
    if (flowAreaSqUnits < 100) {
        feedback = "⚠️ <strong>Small Flow Area:</strong> Suitable only for low-flow safety applications. Confirm adequacy.";
    } else if (flowAreaSqUnits >= 100 && flowAreaSqUnits <= 10000) {
        feedback = "✅ <strong>Standard Flow Area:</strong> Within the common industrial range.";
    } else {
        feedback = "🚨 <strong>Large Flow Area:</strong> Designed for high-capacity systems. Ensure compatibility with process requirements.";
    }

    document.getElementById('feedbackContent').innerHTML = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


{% comment %} 

1. Formula (to keep in your code as comment)

/**

Formula Used:

Flow Area (mm²) = (π × Diameter²) ÷ 4

Flow Area (m²) = Flow Area (mm²) ÷ 1,000,000

Reference Standards:

ASME Boiler & Pressure Vessel Code (BPVC) Section VIII

API 520/521: Pressure-relieving systems

ISO 4126: Safety devices for protection against excessive pressure
*/

2. Input Validation Rules (Industry-based)

Inlet Diameter (mm):

Allowed type: Numeric only (no text/letters).

Min Threshold: > 0 (no zero or negative values allowed).

Realistic Industry Range: 5 mm ≤ Diameter ≤ 500 mm (typical for safety valve inlets per API 520 / ISO 4126).

Hard Limit: ≤ 1000 mm (anything above should be flagged for verification — unrealistic).

Decimals: Up to 2 decimals allowed (e.g., 50.25 mm).

Cross-field consistency: Not applicable here (only one input).

3. Output Validation Rules

Flow Area (mm²): Must be ≥ 20 mm² (below this → physically too small to be practical).

Flow Area (m²): Always non-negative, and max realistic ~0.2 m² for typical safety valves.

Threshold Feedback:

< 100 mm² → Small flow area (low-flow valves).

100–10,000 mm² → Standard range (common industrial applications).

10,000 mm² → High-capacity valves (must be justified in design).

4. Edge Case Validations

Empty input → Show error: "Please enter the inlet diameter."

Non-numeric → Error: "Diameter must be a valid number."

Zero or negative → Error: "Diameter must be greater than zero."

Extremely large (>1000 mm) → Warn user for verification.

Unrealistically small (<1 mm) → Warn user (manufacturing impractical).

Division by zero: Not applicable (formula safe).

5. Corrected JavaScript Code with Validations

Here’s a corrected version of your calculateFlowArea() with embedded QEHS validation comments:

/**
 * Flow Area of Safety Valve Calculator
 * Formula: Flow Area (mm²) = (π × D²) / 4
 * Formula: Flow Area (m²) = Flow Area (mm²) / 1,000,000
 * 
 * Validation Rules (per ASME BPVC, API 520/521, ISO 4126):
 * - Diameter > 0 mm
 * - Typical range: 5 mm to 500 mm (realistic industrial values)
 * - Hard limit: ≤ 1000 mm (above is flagged as abnormal)
 * - Allow up to 2 decimals
 * - No negative, zero, or non-numeric values
 */ {% endcomment %}