{% extends 'base.html' %}
{% block title %}Risk Priority Number (RPN) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Priority Number (RPN) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 480px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
      
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Risk Priority Number (RPN) Calculator</h1>
            <p>Calculate the Risk Priority Number to prioritize risks in Failure Mode and Effects Analysis (FMEA)</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="severity">Severity (1-10)</label>
                    <input type="number" id="severity" class="form-input" min="1" max="10" placeholder="Enter Severity (1-10)">
                </div>
                <div class="form-group">
                    <label for="occurrence">Occurrence (1-10)</label>
                    <input type="number" id="occurrence" class="form-input" min="1" max="10" placeholder="Enter Occurrence (1-10)">
                </div>
                <div class="form-group">
                    <label for="detection">Detection (1-10)</label>
                    <input type="number" id="detection" class="form-input" min="1" max="10" placeholder="Enter Detection (1-10)">
                </div>
                
                <button class="calculate-btn" onclick="calculateRPN()">Calculate RPN</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Risk Priority Number (RPN)</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Risk Priority Number (RPN)</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">RPN Score</div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low</span><span>Moderate</span><span>High</span><span>Very High</span><span>Critical</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Risk Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

<!-- Notes Section -->
<div class="note-section">

    <!-- About -->
    <div class="note-card">
        <h3>üìò About This Calculator</h3>
        <p>
            The <strong>Risk Priority Number (RPN) Calculator</strong> is used in Failure Mode and Effects Analysis (FMEA) 
            to quantify and prioritize risks. It combines <b>Severity</b>, <b>Occurrence</b>, and <b>Detection</b> 
            ratings to highlight which risks need urgent attention.
        </p>
    </div>

    <!-- Parameters -->
    <div class="note-card">
        <h3>‚öôÔ∏è Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Severity (1‚Äì10):</strong> How serious the effect of the potential failure is.</li>
            <li><strong>Occurrence (1‚Äì10):</strong> How frequently the failure is likely to occur.</li>
            <li><strong>Detection (1‚Äì10):</strong> How easy it is to detect the failure before it happens.</li>
        </ul>
    </div>

    <!-- Input Validation Rules -->
    <div class="note-card">
        <h3>‚úÖ Input Validation Rules</h3>
        <ul class="note-list">
            <li>All inputs must be <b>whole numbers</b> (no decimals).</li>
            <li>Acceptable range: <b>1‚Äì10</b> for Severity, Occurrence, and Detection.</li>
            <li>No blank, zero, or negative values are allowed.</li>
            <li><b>Severity = 10</b> ‚Üí Critical risk regardless of other values.</li>
            <li><b>Occurrence ‚â• 8</b> and <b>Detection = 10</b> ‚Üí Very High risk flagged.</li>
            <li>Valid RPN range: <b>1‚Äì1000</b>.</li>
        </ul>
    </div>

    <!-- Output Validations -->
    <div class="note-card">
        <h3>üìä Output Validations</h3>
        <p>
            The calculator provides a <b>Risk Assessment</b> based on RPN value. 
            The same feedback is shown in the results:
        </p>
        <ul class="note-list">
            <li><span class="good">1‚Äì50</span> ‚Üí ‚úÖ Low risk ‚Äì Continue monitoring but no immediate action needed.</li>
            <li><span class="average">51‚Äì150</span> ‚Üí üîµ Moderate risk ‚Äì Consider preventive actions to reduce risk.</li>
            <li><span class="average">151‚Äì250</span> ‚Üí ‚ö†Ô∏è High risk ‚Äì Immediate corrective actions should be taken.</li>
            <li><span class="bad">251‚Äì1000</span> ‚Üí ‚ùå Critical risk ‚Äì Urgent intervention is required to prevent failure.</li>
        </ul>
    </div>

    <!-- Industry Standards -->
    <div class="note-card">
        <h3>üìã Industry Standards</h3>
        <p>
            These rules align with <b>AIAG-VDA FMEA guidelines</b>, <b>ISO 14971 (Medical Devices)</b>, 
            and other industry-specific quality and safety frameworks used in 
            <b>manufacturing, healthcare, aerospace, and automotive</b>.
        </p>
    </div>

</div>


    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateRPN() {
    const severity = document.getElementById('severity').value.trim();
    const occurrence = document.getElementById('occurrence').value.trim();
    const detection = document.getElementById('detection').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];

    // Helper validation function
    function validateInput(value, fieldName) {
        if (value === "" || isNaN(value)) {
            return `üëâ Please enter a ${fieldName} value (1‚Äì10).`;
        }
        if (!Number.isInteger(Number(value))) {
            return `üëâ ${fieldName} must be a whole number (no decimals).`;
        }
        const num = parseInt(value);
        if (num < 1 || num > 10) {
            return `üëâ ${fieldName} must be between 1 and 10.`;
        }
        return null;
    }

    // Validate fields
    const sevErr = validateInput(severity, "Severity");
    if (sevErr) errors.push(sevErr);

    const occErr = validateInput(occurrence, "Occurrence");
    if (occErr) errors.push(occErr);

    const detErr = validateInput(detection, "Detection");
    if (detErr) errors.push(detErr);

    // Error handling
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // Calculation
    const sev = parseInt(severity);
    const occ = parseInt(occurrence);
    const det = parseInt(detection);
    const rpn = sev * occ * det;

    // Display result
    document.getElementById('rateValue').textContent = rpn;

    const meterFill = document.getElementById('meterFill');
    let meterWidth, meterColor, feedback;

    // Cross-field override rules (safety-critical)
    if (sev === 10) {
        meterWidth = '95%';
        meterColor = '#e74c3c';
        feedback = '‚ùå Critical risk! Severity is maximum. Urgent intervention required.';
    } else if (occ >= 8 && det === 10) {
        meterWidth = '95%';
        meterColor = '#e74c3c';
        feedback = '‚ùå Very High risk! Failure is frequent and undetectable.';
    } else {
        // Standard thresholds
        if (rpn <= 50) {
            meterWidth = '10%'; 
            meterColor = '#27ae60';
            feedback = '‚úÖ Low risk - Continue monitoring but no immediate action needed.';
        } else if (rpn <= 150) {
            meterWidth = '30%'; 
            meterColor = '#f1c40f';
            feedback = 'üîµ Moderate risk - Consider preventive actions to reduce risk.';
        } else if (rpn <= 250) {
            meterWidth = '60%'; 
            meterColor = '#e67e22';
            feedback = '‚ö†Ô∏è High risk - Immediate corrective actions should be taken.';
        } else {
            meterWidth = '95%'; 
            meterColor = '#e74c3c';
            feedback = '‚ùå Critical risk! Urgent intervention is required to prevent failure.';
        }
    }

    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;

    document.getElementById('feedbackContent').innerHTML = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}
{% comment %} 
1. Input Validation Rules (based on FMEA standards & QEHS best practices)

General Principles (from AIAG-VDA FMEA, ISO 14971, OSHA, ILO):

All inputs must be whole numbers (no decimals) ‚Äì Severity, Occurrence, Detection are discrete rating scales.

Acceptable range: 1‚Äì10 for all three inputs.

Values outside this range are invalid.

Zero or negative values are not allowed.

Large unrealistic numbers (e.g., >10) are invalid.

No blank entries.

Field-specific:

Severity (S):
‚Äì Must be integer 1‚Äì10.
‚Äì 1 = No effect, 10 = Hazardous with/without warning.
‚Äì Regulatory expectation: do not allow 0, since in FMEA 0 = ‚Äúnon-existent failure mode‚Äù which is not assessable.

Occurrence (O):
‚Äì Must be integer 1‚Äì10.
‚Äì 1 = Remote (<1 in 1,500,000), 10 = Very high (>1 in 2).

Detection (D):
‚Äì Must be integer 1‚Äì10.
‚Äì 1 = Almost certain detection, 10 = Impossible to detect.

Cross-field logic:

No additional cross-field dependency in RPN (multiplication only), but:
‚Äì If Severity = 10 (hazardous), system should highlight ‚ÄúCritical‚Äù regardless of low O or D (good practice in safety-critical industries like aerospace/medical).
‚Äì If Detection = 10 and Occurrence ‚â• 8, system should flag as ‚ÄúVery High‚Äù risk even if Severity is moderate.

2. Output Validation & Thresholds

Formula:

// RPN Formula (per FMEA standard):
// RPN = Severity √ó Occurrence √ó Detection


Valid RPN Range:

Minimum: 1 √ó 1 √ó 1 = 1

Maximum: 10 √ó 10 √ó 10 = 1000

Interpretation bands (as per your notes, aligned with industry use):

1‚Äì50 ‚Üí Low risk ‚Üí Monitor only.

51‚Äì150 ‚Üí Moderate risk ‚Üí Preventive actions considered.

151‚Äì250 ‚Üí High risk ‚Üí Immediate corrective actions needed.

251‚Äì1000 ‚Üí Critical risk ‚Üí Urgent intervention.

These match AIAG & ISO guidelines and real-world QEHS risk acceptance thresholds.

3. Corrected JavaScript Code (with full validation & comments)
/*
=========================================
 Risk Priority Number (RPN) Calculator
 Formula:
   RPN = Severity √ó Occurrence √ó Detection

 Validation Rules:
   - All inputs required
   - Must be integers only (no decimals)
   - Allowed range: 1‚Äì10 inclusive
   - Minimum RPN = 1, Maximum RPN = 1000
   - Cross-field rule: 
       * If Severity = 10 ‚Üí force Critical risk feedback
       * If Occurrence ‚â• 8 AND Detection = 10 ‚Üí force Very High risk
   - No zero, negative, blank, or non-numeric values
=========================================
*/ {% endcomment %}