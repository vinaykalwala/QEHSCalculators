{% extends 'base.html' %}
{% block title %}Equivalent Skin Factor Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equivalent Skin Factor Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
                .btn-container {
    display: flex;
    justify-content: center; /* Horizontally center */
    margin: 30px 0;
}

.back-btn {
    background:linear-gradient(#1560bd,#000040); /* Dark navy background */
    color: #ffffff; /* White text */
    border: 2px solid #1560bd; /* Highlight border */
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none; /* Remove underline for link */
    transition: all 0.3s ease;
    cursor: pointer;
}

.back-btn:hover {
    background-color: #1560bd; /* Highlight on hover */
    color: #ffffff;
    border-color: #000040;
    transform: scale(1.05); /* Subtle hover effect */
}

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            {% comment %} max-width: 700px; {% endcomment %}
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex; 
            flex-direction: column;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (min-width: 901px) {
            .calc-content { 
                flex-direction: row; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
            order: 2;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            min-height: 320px;
            {% comment %} order: 1; {% endcomment %}
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Input rows for side-by-side fields */
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            {% comment %} margin-bottom: 15px; {% endcomment %}
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }

        /* Mobile-specific adjustments */
        @media (max-width: 320px) {
            .calculator-container {
                padding: 10px;
            }
            
            .calculator-header h1 {
                font-size: 1.8rem;
            }
            
            .calculator-header p {
                font-size: 16px;
            }
            
            .calc-card, .result-card {
                padding: 20px 15px;
                border-radius: 12px;
            }
            
            .calc-card h2 {
                font-size: 1.4rem;
            }
            
            .form-input {
                padding: 12px 14px;
                font-size: 14px;
            }
            
            .calculate-btn {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .result-placeholder img {
                max-width: 180px;
            }
            
            .rate-value {
                font-size: 36px;
            }
            
            .meter-labels span {
                font-size: 10px;
            }
            
            .note-card {
                padding: 15px 18px;
            }
            
            .note-card h3 {
                font-size: 16px;
            }
            
            .note-card p, .note-card li {
                font-size: 14px;
            }
        }
        
        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: block;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Equivalent Skin Factor Calculator</h1>
            <p>Calculate the flow resistance in fractured wells based on fracture geometry and conductivity</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                
                <div class="form-group">
                    <label for="xf"><strong>Fracture Half-Length (x_f) in meters:</strong></label>
                    <input type="number" id="xf" class="form-input" min="0" step="any" placeholder="e.g., 100">
                    <span class="error" id="xfError"></span>
                </div>

                <div class="form-group">    
                    <label for="rw"><strong>Wellbore Radius (r_w) in meters:</strong></label>
                    <input type="number" id="rw" class="form-input" min="0" step="any" placeholder="e.g., 0.1">
                    <span class="error" id="rwError"></span>
                </div>
                
                <div class="form-group">
                    <label for="fcd"><strong>Fracture Conductivity (F_CD):</strong></label>
                    <input type="number" id="fcd" class="form-input" min="0" step="any" placeholder="e.g., 10">
                    <span class="error" id="fcdError"></span>
                </div>
                
                <button class="calculate-btn" onclick="calculateSkinFactor()">Calculate Skin Factor</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Equivalent Skin Factor (S_f)</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Equivalent Skin Factor</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                    </div>
                    
                    <div class="result-feedback">
                        <div class="feedback-title">Well Performance Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>📘 About This Calculator</h3>
                <p>
                    The <strong>Equivalent Skin Factor (S_f)</strong> quantifies how a fracture affects fluid flow in a well. 
                    A lower skin factor means less resistance to flow and better well performance. 
                    This calculation helps optimize wellbore stimulation treatments in oil, gas, and geothermal applications.
                </p>
            </div>

            <div class="note-card">
                <h3>⚙️ Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>x_f:</strong> Fracture half-length in meters - defines the effective reach of the fracture.</li>
                    <li><strong>r_w:</strong> Wellbore radius in meters - a critical well dimension.</li>
                    <li><strong>F_CD:</strong> Fracture conductivity - indicates the ability of fluid to flow through the fracture.</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>📊 Interpretation</h3>
                <p>
                    The skin factor indicates flow efficiency:
                </p>
                <ul class="note-list">
                    <li><span class="good">Negative values</span> → Efficient well with enhanced flow</li>
                    <li><span class="average">0 to 5</span> → Minimal damage, good flow conditions</li>
                    <li><span class="average">5 to 10</span> → Moderate damage, some flow restrictions</li>
                    <li><span class="bad">Above 10</span> → Significant damage, requires optimization</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>🔍 Real-Life Applications</h3>
                <p>
                    The Equivalent Skin Factor is crucial for:
                </p>
                <ul class="note-list">
                    <li><strong>Oil and Gas Well Evaluations:</strong> Assessing fracturing efficiency and production potential</li>
                    <li><strong>Hydraulic Fracturing Design:</strong> Optimizing fracture parameters to maximize production</li>
                    <li><strong>Geothermal Energy:</strong> Understanding flow in fractured rock formations</li>
                    <li><strong>Well Performance Analysis:</strong> Identifying opportunities for well stimulation</li>
                </ul>
            </div>
            
            <div class="note-card">
    <h3>✅ Input Validation Rules</h3>
    <ul class="note-list">
        <li><strong>Fracture Half-Length (x_f):</strong> Must be > 0, typical range 10–500 m, max 2000 m.</li>
        <li><strong>Wellbore Radius (r_w):</strong> Must be > 0, typical 0.05–0.20 m, always less than x_f.</li>
        <li><strong>Fracture Conductivity (F_CD):</strong> Must be > 0, typical 1–100, max recommended 500.</li>
        <li><strong>No division by zero:</strong> Ensure x_f > r_w to avoid invalid logarithm.</li>
        <li><strong>Outliers:</strong> Values outside recommended ranges will trigger warnings.</li>
        <li><strong>No negative values:</strong> All inputs must be positive numbers.</li>
    </ul>
</div>

        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateSkinFactor() {
    let xf = document.getElementById("xf").value.trim();
    let rw = document.getElementById("rw").value.trim();
    let fcd = document.getElementById("fcd").value.trim();

    let xfError = document.getElementById("xfError");
    let rwError = document.getElementById("rwError");
    let fcdError = document.getElementById("fcdError");
    const errorBox = document.getElementById("resultError");
    const errorMessage = document.getElementById("errorMessage");
    const placeholder = document.getElementById("placeholder");
    const resultValue = document.getElementById("resultValue");

    xfError.innerText = "";
    rwError.innerText = "";
    fcdError.innerText = "";
    errorBox.classList.add("hidden");

    let errors = [];
    let warnings = [];

    // Validate xf
    if (xf === "" || isNaN(parseFloat(xf))) {
        errors.push("👉 Fracture half-length must be a valid number.");
        xfError.innerText = "Fracture half-length must be a valid number.";
    } else if (parseFloat(xf) <= 0) {
        errors.push("👉 Fracture half-length must be greater than zero.");
        xfError.innerText = "Fracture half-length must be greater than zero.";
    } else if (parseFloat(xf) < 10 || parseFloat(xf) > 2000) {
        warnings.push("⚠️ Fracture half-length is outside typical range (10–500 m).");
    }

    // Validate rw
    if (rw === "" || isNaN(parseFloat(rw))) {
        errors.push("👉 Wellbore radius must be a valid number.");
        rwError.innerText = "Wellbore radius must be a valid number.";
    } else if (parseFloat(rw) <= 0) {
        errors.push("👉 Wellbore radius must be greater than zero.");
        rwError.innerText = "Wellbore radius must be greater than zero.";
    } else if (parseFloat(rw) < 0.05 || parseFloat(rw) > 1) {
        warnings.push("⚠️ Wellbore radius is outside typical range (0.05–0.20 m).");
    }

    // Validate fcd
    if (fcd === "" || isNaN(parseFloat(fcd))) {
        errors.push("👉 Fracture conductivity must be a valid number.");
        fcdError.innerText = "Fracture conductivity must be a valid number.";
    } else if (parseFloat(fcd) <= 0) {
        errors.push("👉 Fracture conductivity must be greater than zero.");
        fcdError.innerText = "Fracture conductivity must be greater than zero.";
    } else if (parseFloat(fcd) > 500) {
        warnings.push("⚠️ Fracture conductivity exceeds typical engineering limits (>500).");
    }

    // Cross-field validation
    if (errors.length === 0 && parseFloat(rw) >= parseFloat(xf)) {
        errors.push("👉 Wellbore radius must be smaller than fracture half-length.");
        rwError.innerText = "Wellbore radius must be smaller than fracture half-length.";
    }

    // Show errors
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // Convert to numbers
    xf = parseFloat(xf);
    rw = parseFloat(rw);
    fcd = parseFloat(fcd);

    // Calculate skin factor
    let u = Math.log(fcd);
    let numerator = 1.65 - (0.328 * u) + (0.116 * Math.pow(u, 2));
    let denominator = 1 + (0.18 * u) + (0.064 * Math.pow(u, 2)) + (0.05 * Math.pow(u, 3));
    let sf = (numerator / denominator) - Math.log(xf / rw);

    document.getElementById('rateValue').textContent = sf.toFixed(4);

    // Feedback
    let feedback;
    if (sf < 0) {
        feedback = '🌟 Excellent! Negative skin factor indicates an efficient well with enhanced flow.';
    } else if (sf <= 5) {
        feedback = '👍 Good performance. Minimal damage with good flow conditions.';
    } else if (sf <= 10) {
        feedback = '⚠️ Moderate damage. Some flow restrictions present. Consider optimization.';
    } else {
        feedback = '❌ Significant damage. High flow restrictions requiring immediate optimization.';
    }

    // Append warnings if any
    if (warnings.length > 0) {
        feedback += " " + warnings.join(" ");
    }

    document.getElementById('feedbackContent').textContent = feedback;
    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}



{% comment %} 

1. Real-World QEHS/Fire Safety Perspective

The Equivalent Skin Factor (S_f) is an engineering parameter, but in QEHS terms it has strong relevance:

Incorrect inputs → misleading well performance assessment → potential overproduction, casing failures, unsafe pressures.

Validation ensures integrity of technical safety barriers (API RP 14C, OSHA PSM, ISO 14224 well integrity guidelines).

The output (skin factor ranges) must align with recognized industry interpretations to avoid misreporting in safety audits and incident investigations.

2. Input Validation Rules (with acceptable ranges)
✅ Fracture Half-Length (x_f, meters)

Must be > 0.

Typical realistic range: 10 – 500 m (API & petroleum engineering handbooks).

Decimal precision: up to 2 decimals.

Unrealistic values (e.g., > 2000 m) should trigger a warning.

✅ Wellbore Radius (r_w, meters)

Must be > 0.

Typical range: 0.05 – 0.20 m (well casing diameters).

Decimal precision: up to 3 decimals (important for small wellbores).

Should never exceed x_f, otherwise geometry is invalid.

✅ Fracture Conductivity (F_CD, dimensionless)

Must be > 0.

Typical range: 1 – 100.

Very low (< 0.1) or very high (> 500) values should trigger warnings as outliers.

No negative values allowed.

3. Output Validation (Skin Factor Ranges)

S_f < 0 → Good stimulation, enhanced flow.

0 ≤ S_f ≤ 5 → Minimal damage, acceptable.

5 < S_f ≤ 10 → Moderate formation damage, corrective action may be required.

S_f > 10 → Significant damage, unsafe/unproductive conditions.

⚠️ If rw >= xf, result is invalid (logarithm negative or undefined) → must block and return error.

4. Edge Case Validations

Division by Zero / Log Errors:

If xf ≤ rw, then log(xf/rw) ≤ 0 → invalid input.

Extreme Outliers:

xf > 2000 m or rw > 1 m should trigger a warning.

Negative or Zero Inputs:

Already covered, but must block calculation.

Scientific Notation / Invalid Characters:

Only finite numbers allowed. Reject Infinity, NaN, e.

5. Corrected JavaScript Code (with comments for compliance)
/*
Formula Used:
Equivalent Skin Factor (S_f) = [ (1.65 – 0.328u + 0.116u²) / (1 + 0.18u + 0.064u² + 0.05u³) ] – ln(x_f / r_w)
where:
    u = ln(F_CD)

Validation Rules:
- x_f (Fracture Half-Length): > 0, typically 10–500 m, max recommended 2000 m
- r_w (Wellbore Radius): > 0, typically 0.05–0.20 m, must be < x_f
- F_CD (Fracture Conductivity): > 0, typically 1–100, warn if > 500
- Prevent division by zero and log of invalid values


/*
Formula Used:
Equivalent Skin Factor (S_f) = [ (1.65 – 0.328u + 0.116u²) / (1 + 0.18u + 0.064u² + 0.05u³) ] – ln(x_f / r_w)
where:
    u = ln(F_CD)

Validation Rules:
- x_f (Fracture Half-Length): > 0, typically 10–500 m, max recommended 2000 m
- r_w (Wellbore Radius): > 0, typically 0.05–0.20 m, must be < x_f
- F_CD (Fracture Conductivity): > 0, typically 1–100, warn if > 500
- Prevent division by zero and log of invalid values
*/


*/ {% endcomment %}