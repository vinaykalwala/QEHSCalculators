{% extends 'base.html' %}
{% block title %}ASME (API RP 520) Valves - Minimum Flow Area for Dry Gases and Air{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASME (API RP 520) Valves - Minimum Flow Area for Dry Gases and Air</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 12px;
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            {% comment %} max-width: 700px; {% endcomment %}
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            {% comment %} display: flex; {% endcomment %}
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
            {% comment %} overflow-y: auto; {% endcomment %}
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Input rows for side-by-side fields */
         .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value { 
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
       
    </style>
</head>
<body>
   <div class="calculator-container printable" id="printArea">

    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>ASME (API RP 520) Valves - Minimum Flow Area for Dry Gases and Air</h1>
            <p>Calculate the minimum flow area required for gas discharge in safety valves</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="input-row">
                    <div class="form-group">
                        <label for="volumeFlow">Required Volume Flow (V̇) (ft³/min)</label>
                        <input type="number" id="volumeFlow" class="form-input" min="0" placeholder="e.g., 5000">
                    </div>
                    <div class="form-group">
                        <label for="temperature">Relieving Temperature (T) (°R)</label>
                        <input type="number" id="temperature" class="form-input" min="0" placeholder="e.g., 520">
                    </div>
                </div>
                <div class="input-row">
                    <div class="form-group">
                        <label for="compressibility">Compressibility Factor (Z)</label>
                        <input type="number" id="compressibility" class="form-input" min="0" max="1.5" step="0.01" placeholder="e.g., 0.95">
                    </div>
                    <div class="form-group">
                        <label for="specificGravity">Specific Gravity of Gas (G)</label>
                        <input type="number" id="specificGravity" class="form-input" min="0" step="0.01" placeholder="e.g., 1.0">
                    </div>
                </div>
                <div class="input-row">
                    <div class="form-group">
                        <label for="Cg">Nozzle Gas Constant (C<sub>g</sub>)</label>
                        <input type="number" id="Cg" class="form-input" min="0" placeholder="e.g., 315">
                    </div>
                    <div class="form-group">
                        <label for="Kd">Effective Coefficient of Discharge (K<sub>d</sub>)</label>
                        <input type="number" id="Kd" class="form-input" min="0.1" max="1" step="0.01" placeholder="e.g., 0.8">
                    </div>
                </div>
                <div class="input-row">
                    <div class="form-group">
                        <label for="Pr">Upstream Relieving Pressure (P<sub>R</sub>) (bar a)</label>
                        <input type="number" id="Pr" class="form-input" min="0" placeholder="e.g., 10">
                    </div>
                    <div class="form-group">
                        <label for="Kb">Backpressure Correction Factor (K<sub>b</sub>)</label>
                        <input type="number" id="Kb" class="form-input" min="0" step="0.01" placeholder="e.g., 1.0">
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateDischargeArea()">Calculate Minimum Flow Area</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Minimum Flow Area</strong> for dry gases and air. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Minimum Flow Area</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">in²</div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Small</span><span>Optimal</span><span>Moderate</span><span>Large</span><span>Very Large</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Flow Area Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>📘 About This Calculator</h3>
                <p>
                    This tool calculates the <strong>Minimum Flow Area for Dry Gases and Air</strong> required for a safety valve, 
                    ensuring proper discharge of excess gas under specified operating conditions according to ASME (API RP 520) standards.
                </p>
            </div>

            <div class="note-card">
                <h3>⚙️ Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Required Volume Flow (V̇):</strong> The volumetric flow rate of gas to be discharged (ft³/min).</li>
                    <li><strong>Relieving Temperature (T):</strong> The absolute temperature of gas at relieving conditions in Rankine (°R).</li>
                    <li><strong>Compressibility Factor (Z):</strong> A correction factor for non-ideal gas behavior (typically 0-1.5).</li>
                    <li><strong>Specific Gravity of Gas (G):</strong> The density of gas relative to air at standard conditions.</li>
                    <li><strong>Nozzle Gas Constant (C<sub>g</sub>):</strong> A coefficient related to gas expansion characteristics.</li>
                    <li><strong>Effective Coefficient of Discharge (K<sub>d</sub>):</strong> Represents flow efficiency through the valve (0-1).</li>
                    <li><strong>Upstream Relieving Pressure (P<sub>R</sub>):</strong> The absolute pressure upstream of the valve at relieving conditions (bar a).</li>
                    <li><strong>Backpressure Correction Factor (K<sub>b</sub>):</strong> Accounts for the effect of downstream pressure on valve performance.</li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>📊 Interpretation</h3>
                <p>
                    <b>Flow Area Size Guidelines:</b>
                </p>
                <ul class="note-list">
                    <li><span class="good">Below 0.1 in²</span> → Small flow area, suitable for low-flow conditions</li>
                    <li><span class="average">0.1-1.0 in²</span> → Optimal range for most industrial applications</li>
                    <li><span class="bad">Above 1.0 in²</span> → Large flow area, may indicate an oversized valve</li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>🔑 Key Applications</h3>
                <ul class="note-list">
                    <li><strong>Gas and Air Safety Valve Sizing:</strong> Ensures proper valve selection to prevent excessive pressure buildup.</li>
                    <li><strong>Process & Industrial Gas Systems:</strong> Critical for pressure relief in compressed air and gas-handling systems.</li>
                    <li><strong>Chemical & Petrochemical Processing:</strong> Used to protect equipment from overpressure in gas reactors and pipelines.</li>
                    <li><strong>Power Generation:</strong> Ensures proper gas venting in turbines, compressors, and steam plants.</li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>✅ Validations & Input Constraints</h3>
                <ul class="note-list">
                    <li><strong>Volume Flow must be positive</strong></li>
                    <li><strong>Temperature must be greater than 0 °R</strong></li>
                    <li><strong>Compressibility Factor (Z) must be between 0 and 1.5</strong></li>
                    <li><strong>Specific Gravity must be positive</strong></li>
                    <li><strong>Nozzle Gas Constant (C<sub>g</sub>) must be greater than 0</strong></li>
                    <li><strong>Discharge Coefficient (K<sub>d</sub>) must be between 0 and 1</strong></li>
                    <li><strong>Relieving Pressure (P<sub>R</sub>) must be positive</strong></li>
                    <li><strong>Backpressure Correction Factor (K<sub>b</sub>) must be greater than 0</strong></li>
                </ul>
            </div>
             <div class="note-card">
                <h3>🏭 ASME (API RP 520) Standard</h3>
                <p>
                    <strong>ASME (API RP 520)</strong> stands for American Society of Mechanical Engineers (American Petroleum Institute Recommended Practice 520). 
                    It provides guidelines for designing and installing pressure relief systems to protect equipment from excessive pressure 
                    in industries like oil & gas, chemical processing, and power generation.
                </p>
            </div>
             <div class="note-card">
                <h3>📌 Conclusion</h3>
                  <p>This tool helps engineers and safety professionals determine the **minimum required discharge area (A₀)** for gas and air relief valves using the API RP 520 standard. Properly sized valves protect equipment from overpressure, ensuring safe and efficient system operation.</p>
            </div>
        </div>

    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateDischargeArea() {
            const volumeFlow = document.getElementById('volumeFlow').value.trim();
            const temperature = document.getElementById('temperature').value.trim();
            const compressibility = document.getElementById('compressibility').value.trim();
            const specificGravity = document.getElementById('specificGravity').value.trim();
            const Cg = document.getElementById('Cg').value.trim();
            const Kd = document.getElementById('Kd').value.trim();
            const Pr = document.getElementById('Pr').value.trim();
            const Kb = document.getElementById('Kb').value.trim();

            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValue = document.getElementById('resultValue');

            let errors = [];

            if (volumeFlow === "") {
                errors.push("👉 Please enter the Volume Flow.");
            } else if (parseFloat(volumeFlow) <= 0) {
                errors.push("👉 Volume Flow must be greater than 0.");
            }
            
            if (temperature === "") {
                errors.push("👉 Please enter the Temperature.");
            } else if (parseFloat(temperature) <= 0) {
                errors.push("👉 Temperature must be greater than 0.");
            }
            
            if (compressibility === "") {
                errors.push("👉 Please enter the Compressibility Factor.");
            } else if (parseFloat(compressibility) <= 0 || parseFloat(compressibility) > 1.5) {
                errors.push("👉 Compressibility Factor must be between 0 and 1.5.");
            }
            
            if (specificGravity === "") {
                errors.push("👉 Please enter the Specific Gravity.");
            } else if (parseFloat(specificGravity) <= 0) {
                errors.push("👉 Specific Gravity must be greater than 0.");
            }
            
            if (Cg === "") {
                errors.push("👉 Please enter the Nozzle Gas Constant.");
            } else if (parseFloat(Cg) <= 0) {
                errors.push("👉 Nozzle Gas Constant must be greater than 0.");
            }
            
            if (Kd === "") {
                errors.push("👉 Please enter the Discharge Coefficient.");
            } else if (parseFloat(Kd) <= 0 || parseFloat(Kd) > 1) {
                errors.push("👉 Discharge Coefficient must be between 0 and 1.");
            }
            
            if (Pr === "") {
                errors.push("👉 Please enter the Relieving Pressure.");
            } else if (parseFloat(Pr) <= 0) {
                errors.push("👉 Relieving Pressure must be greater than 0.");
            }
            
            if (Kb === "") {
                errors.push("👉 Please enter the Backpressure Correction Factor.");
            } else if (parseFloat(Kb) <= 0) {
                errors.push("👉 Backpressure Correction Factor must be greater than 0.");
            }

            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValue.classList.add("hidden");
                return;
            } else {
                errorBox.classList.add("hidden");
            }

            // Calculate the minimum flow area
            const V_dot = parseFloat(volumeFlow);
            const T = parseFloat(temperature);
            const Z = parseFloat(compressibility);
            const G = parseFloat(specificGravity);
            const C_g = parseFloat(Cg);
            const K_d = parseFloat(Kd);
            const P_R = parseFloat(Pr);
            const K_b = parseFloat(Kb);
            
            // API RP 520 formula for gas discharge area
            const A_O = (V_dot * Math.sqrt(T * Z * G)) / (1.175 * C_g * K_d * P_R * K_b);
            
            document.getElementById('rateValue').textContent = A_O.toFixed(4);

            const meterFill = document.getElementById('meterFill');
            let meterWidth, meterColor, feedback;
            
            if (A_O < 0.1) {
                meterWidth = '20%'; 
                meterColor = '#2ecc71';
                feedback = 'Small flow area. Suitable for very low-flow conditions.';
            } else if (A_O <= 0.5) {
                meterWidth = '40%'; 
                meterColor = '#27ae60';
                feedback = 'Optimal flow area. The calculated value is within a typical range for industrial applications.';
            } else if (A_O <= 1.0) {
                meterWidth = '60%'; 
                meterColor = '#f39c12';
                feedback = 'Moderate flow area. Suitable for many industrial applications.';
            } else if (A_O <= 3.0) {
                meterWidth = '80%'; 
                meterColor = '#e67e22';
                feedback = 'Large flow area. Ensure the system is designed for higher flow.';
            } else {
                meterWidth = '95%'; 
                meterColor = '#e74c3c';
                feedback = 'Very large flow area. Check the system design to avoid over-sizing.';
            }

            meterFill.style.width = meterWidth;
            meterFill.style.backgroundColor = meterColor;
            document.getElementById('feedbackContent').textContent = feedback;

            placeholder.classList.add('hidden');
            resultValue.classList.remove('hidden');
        }

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>

</body>
</html>
{% endblock %}