{% extends 'base.html' %}
{% block title %}Well Control Kill Mud Weight Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Well Control Kill Mud Weight Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        .rate-label {
            color: #2980b9;
            font-weight: bold;
            font-size: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon { font-size: 76px; flex-shrink: 0; text-align: center; }
        .error-message { font-size: 24px; line-height: 1.6; }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Kill Mud Weight Calculator</h1>
            <p>Calculate the required mud density to control a well during a kick event.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Well Control Data</h2>
                <div class="form-group">
                    <label for="currentMW">Current Mud Weight (MW)</label>
                    <input type="number" id="currentMW" class="form-input" placeholder="Enter weight in ppg">
                </div>
                <div class="form-group">
                    <label for="holeDepth">Hole Depth (H)</label>
                    <input type="number" id="holeDepth" class="form-input" placeholder="Enter depth in feet">
                </div>
                <div class="form-group">
                    <label for="kickPressure">Kick Pressure (Pk)</label>
                    <input type="number" id="kickPressure" class="form-input" placeholder="Enter pressure in psi">
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>Enter well data to calculate the required Kill Mud Weight (KMW) to prevent a blowout.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>Kill Mud Weight</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label">ppg</div>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Summary</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                     <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <!-- About Kill Mud Weight -->
            <div class="note-card">
                <h3>About Kill Mud Weight</h3>
                <p>
                    The <strong>Kill Mud Weight (MWk)</strong> formula is used in well control to prevent blowouts.
                    It calculates the necessary mud weight required to balance formation pressure.
                    Determining the correct MWk is essential for drilling safety and effective well control.
                </p>
                <p>
                    This calculation ensures that the influx of formation fluids ("kick") can be safely circulated out of the
                    wellbore, minimizing the risk of a blowout.
                </p>
            </div>
        
            <!-- Parameters Explained -->
            <div class="note-card">
                <h3>Parameters Explained</h3>
                <ul class="note-list">
                    <li><strong>MWk (Kill Mud Weight) (ppg):</strong> The mud weight required to control the well.</li>
                    <li><strong>MW (Current Mud Weight) (ppg):</strong> The existing density of drilling fluid.</li>
                    <li><strong>H (Hole Depth) (feet):</strong> Depth of the wellbore.</li>
                    <li><strong>Pk (Kick Pressure) (psi):</strong> Additional pressure from formation fluids (SIDPP).</li>
                </ul>
                <ul class="note-list">
                    <li>The formula ensures proper mud weight adjustment using hole depth and kick pressure.</li>
                    <li>Hole depth appears twice in the formula for accurate pressure balancing.</li>
                </ul>
            </div>
        
            <!-- Validation Rules -->
             <div class="note-card">
                <h3>‚úÖ Input Validations</h3>
                    <p><strong>1. Current Mud Weight (MW) [ppg]</strong></p>
                    <ul>
                        <li>Acceptable Range: <strong>4 ‚Äì 22 ppg</strong></li>
                        <li>Positive numbers only</li>
                        <li>Maximum <strong>2 decimal places</strong> allowed</li>
                        <li>Example: 12.5</li>
                    </ul>
                    <p><strong>2. Hole Depth (H) [ft]</strong></p>
                    <ul>
                        <li>Acceptable Range: <strong>100 ‚Äì 30,000 ft</strong></li>
                        <li>Positive numbers only</li>
                        <li>Maximum <strong>1 decimal place</strong> allowed</li>
                        <li>Cannot be zero (division by zero is not allowed)</li>
                        <li>Example: 8500.0</li>
                    </ul>
                    <p><strong>3. Kick Pressure (Pk) [psi]</strong></p>
                    <ul>
                        <li>Acceptable Range: <strong>0 ‚Äì 5000 psi</strong></li>
                        <li>Zero allowed if there is no kick pressure</li>
                        <li>Maximum <strong>1 decimal place</strong> allowed</li>
                        <li>Example: 150.5</li>
                    </ul>
                    <p><strong>4. Logical Checks / Cross-Field Validations</strong></p>
                    <ul>
                        <li>KMW = MW + (Pk / H) should be ‚â• MW</li>
                        <li>KMW should not exceed safe operational limits (~22 ppg)</li>
                        <li>Helps avoid unsafe mud densities or blowouts</li>
                    </ul>
                    <p><strong>5. Edge Case Handling</strong></p>
                    <ul>
                        <li>H = 0 ‚Üí Error (division by zero)</li>
                        <li>Negative inputs ‚Üí Error</li>
                        <li>Extremely high values ‚Üí Safety alert</li>
                        <li>Incorrect decimals ‚Üí Error</li>
                    </ul>
                    <p><strong>‚úÖ Tip:</strong> Always double-check your MW, H, and Pk inputs before calculating to ensure safe and
                        realistic results.</p>
            </div>
        
            <!-- Real-Life Applications -->
            <div class="note-card">
                <h3>Real-Life Applications</h3>
                <ul class="note-list">
                    <li>Used in <strong>oil and gas drilling operations</strong> to prevent uncontrolled well flow.</li>
                    <li>Ensures <strong>safety</strong> for drilling personnel by avoiding blowouts.</li>
                    <li>Applied in <strong>well planning and emergency control procedures</strong>.</li>
                </ul>
            </div>
        
            <!-- Conclusion -->
            <div class="note-card">
                <h3>Conclusion</h3>
                <p>
                    This calculator is crucial for well control safety. It helps drillers determine the required mud weight to
                    handle unexpected formation pressures, minimizing the risk of blowouts and ensuring safe drilling
                    operations.
                </p>
            </div>
        </div>

    </div>

    <script>
        function calculateAndDisplay() {
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');

            // Reset UI
            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');

            let errors = [];

            // Helper function for input validation
            function getVal(id, label, opts = {}) {
                const el = document.getElementById(id);
                const raw = el.value?.toString().trim();

                if (!raw) {
                    errors.push(`üëâ ${label} is required.`);
                    return null;
                }

                const num = parseFloat(raw);

                if (isNaN(num)) {
                    errors.push(`üëâ Enter a valid number for ${label}.`);
                    return null;
                }

                if (opts.allowZero ? num < 0 : num <= 0) {
                    errors.push(`üëâ ${label} must be a positive number.`);
                    return null;
                }

                if (opts.min !== undefined && num < opts.min) {
                    errors.push(`üëâ ${label} must be ‚â• ${opts.min}.`);
                }

                if (opts.max !== undefined && num > opts.max) {
                    errors.push(`üëâ ${label} must be ‚â§ ${opts.max}.`);
                }

                // Decimal precision check
                if (opts.decimals !== undefined) {
                    const regex = new RegExp(`^\\d+(\\.\\d{0,${opts.decimals}})?$`);
                    if (!regex.test(raw)) {
                        errors.push(`üëâ ${label} must have at most ${opts.decimals} decimal place(s).`);
                    }
                }

                return num;
            }

            // Validate Inputs
            const mw = getVal('currentMW', 'Current Mud Weight (MW)', { min: 4, max: 22, decimals: 2 });
            const h = getVal('holeDepth', 'Hole Depth (H)', { min: 100, max: 30000, decimals: 1 });
            const pk = getVal('kickPressure', 'Kick Pressure (Pk)', { min: 0, max: 5000, decimals: 1, allowZero: true });

            if (h === 0) {
                errors.push('üëâ Hole Depth (H) cannot be zero.');
            }

            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join('<br>');
                errorBox.classList.remove('hidden');
                placeholder.classList.add('hidden');
                return;
            }

            // Kill Mud Weight calculation
            const kmw = mw + (pk / h);

            // Display Result
            placeholder.classList.add('hidden');
            resultValueBox.classList.remove('hidden');

            document.getElementById('rateValue').textContent = kmw.toFixed(2);

            // Feedback with operational guidance
            let feedback = `Calculation based on:<br>
                        - MW = <strong>${mw} ppg</strong><br>
                        - H = <strong>${h} ft</strong><br>
                        - Pk = <strong>${pk} psi</strong><br>`;

            if (kmw < mw) {
                feedback += `‚ö†Ô∏è Calculated KMW <strong>${kmw.toFixed(2)} ppg</strong> is less than the current MW. Recheck inputs.`;
            } else if (kmw > 22) {
                feedback += `üö® Calculated KMW <strong>${kmw.toFixed(2)} ppg</strong> exceeds safe operational limits. Exercise extreme caution.`;
            } else {
                feedback += `‚úÖ Required Kill Mud Weight: <strong>${kmw.toFixed(2)} ppg</strong>. Safe for well control.`;
            }

            document.getElementById('feedbackContent').innerHTML = feedback;
        }

        function printReport() {
            window.print();
        }
    </script>

</body>
</html>
{% endblock %}

<!-- 
1. Input Analysis and Real-World Considerations

The Kill Mud Weight formula is used in drilling operations to prevent well blowouts by increasing the drilling fluid density.

Inputs:

Input	Unit	Typical Range	QEHS Notes
Current Mud Weight (MW)	ppg	8 ‚Äì 20 ppg	Must be positive; excessively high MW can damage formation or cause lost circulation.
Hole Depth (H)	ft	500 ‚Äì 30,000 ft	Cannot be zero; must be positive. Extremely shallow or deep values need caution.
Kick Pressure (Pk)	psi	50 ‚Äì 5000 psi	Must be positive; must not exceed equipment limits.

Cross-field dependency:

MWk = (MW * H + Pk) / H

H cannot be zero ‚Üí division by zero must be prevented.

MWk should be greater than MW for it to make sense physically.

2. Input Validation Rules

Mandatory Fields: All inputs are required. Empty or null values trigger an error.

Numeric Positive Values: Only positive numbers allowed.

Acceptable Ranges:

MW: 8 ‚Äì 20 ppg

H: 500 ‚Äì 30,000 ft

Pk: 50 ‚Äì 5000 psi

Decimals:

MW: max 2 decimal places

H: max 1 decimal place

Pk: max 1 decimal place

Logical Checks:

H ‚â† 0 (avoid division by zero)

MWk ‚â• MW (kill mud weight must make physical sense)

Edge Cases:

Extremely high MWk (e.g., >25 ppg) ‚Üí warn user that drilling risks increase.

Negative or zero Pk ‚Üí invalid input.

3. Output Validation Logic

Calculate Kill Mud Weight (MWk):

ùëÄ
ùëä
ùëò
=
ùëÄ
ùëä
‚ãÖ
ùêª
+
ùëÉ
ùëò
ùêª
MWk=
H
MW‚ãÖH+Pk
	‚Äã


Thresholds:

MWk < 12 ‚Üí Low risk, safe drilling

MWk 12‚Äì20 ‚Üí Normal operational range

MWk > 20 ‚Üí High risk, caution advised

Display interpretable summary:

Show input values used

Show calculated MWk

Warn if MWk exceeds safe operational range
-->