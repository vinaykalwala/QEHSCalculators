{% extends 'base.html' %}
{% block title %}Well Control Kill Mud Weight Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Well Control Kill Mud Weight Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        .rate-label {
            color: #2980b9;
            font-weight: bold;
            font-size: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon { font-size: 76px; flex-shrink: 0; text-align: center; }
        .error-message { font-size: 24px; line-height: 1.6; }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Kill Mud Weight Calculator</h1>
            <p>Calculate the required mud density to control a well during a kick event.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Well Control Data</h2>
                <div class="form-group">
                    <label for="currentMW">Current Mud Weight (MW)</label>
                    <input type="number" id="currentMW" class="form-input" placeholder="Enter weight in ppg">
                </div>
                <div class="form-group">
                    <label for="holeDepth">Hole Depth (H)</label>
                    <input type="number" id="holeDepth" class="form-input" placeholder="Enter depth in feet">
                </div>
                <div class="form-group">
                    <label for="kickPressure">Kick Pressure (Pk)</label>
                    <input type="number" id="kickPressure" class="form-input" placeholder="Enter pressure in psi">
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>Enter well data to calculate the required Kill Mud Weight (KMW) to prevent a blowout.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>Kill Mud Weight</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label">ppg</div>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Summary</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                       <div class="btn-wrapper">
                            <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                        </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    The <strong>Kill Mud Weight (KMW) Calculator</strong> is a critical safety tool used in the oil and gas industry during well control operations. When a "kick" (an unwanted influx of formation fluids) occurs, this calculation determines the precise density of drilling fluid (mud) required to regain control of the well and prevent a blowout.
                </p>
            </div>
            <div class="note-card">
                <h3>‚öôÔ∏è Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Current Mud Weight (MW):</strong> The density of the drilling mud currently in the well, measured in pounds per gallon (ppg).</li>
                    <li><strong>Hole Depth (H):</strong> The true vertical depth of the well in feet (ft).</li>
                    <li><strong>Kick Pressure (Pk):</strong> The Shut-In Drill Pipe Pressure (SIDPP) in pounds per square inch (psi), which represents the excess formation pressure.</li>
                </ul>
            </div>
            <div class="note-card">
                <h3>‚úÖ Input Validation Rules</h3>
                <ul class="note-list">
                    <li><strong>Current Mud Weight (MW):</strong> Must be a positive number within a realistic range (e.g., 4-22 ppg).</li>
                    <li><strong>Hole Depth (H):</strong> Must be a positive number greater than zero to prevent division by zero.</li>
                    <li><strong>Kick Pressure (Pk):</strong> Must be a non-negative number (can be zero if no kick is present).</li>
                    <li>All inputs must be valid numbers within specified decimal limits.</li>
                </ul>
            </div>
             <div class="note-card">
                <h3>Output Validations</h3>
                 <p>The calculator provides a summary and safety assessment of the result:</p>
                <ul class="note-list">
                    <li><span class="good">‚úÖ Required Kill Mud Weight: <strong>[Value] ppg</strong>. Safe for well control.</span></li>
                    <li><span class="average">‚ö†Ô∏è Calculated KMW <strong>[Value] ppg</strong> is less than the current MW. Recheck inputs.</span></li>
                    <li><span class="bad">üö® Calculated KMW <strong>[Value] ppg</strong> exceeds safe operational limits. Exercise extreme caution.</span></li>
                </ul>
            </div>
            <div class="note-card">
                <h3>Governing Principle</h3>
                <p>
                    A well control kill mud weight calculator follows standards set by organizations like the <strong>International Well Control Forum (IWCF)</strong>, which provides standardized formulas and procedures for well control operations. The data is organized and recorded on industry-standard <strong>Kill Sheets</strong>.
                </p>
                <p><strong>Key Standards and Practices:</strong></p>
                <ul class="note-list">
                    <li><strong>International Well Control Forum (IWCF):</strong> Sets global standards for well control education and competency, providing standardized well control formulas.</li>
                    <li><strong>Kill Sheets:</strong> Standardized forms used to record all necessary data for a well control operation, including original mud weight and shut-in drill pipe pressure (SIDPP).</li>
                </ul>
                <p>The kill sheet data, such as SIDPP and depth, serves as the foundation for the calculator, which then applies standardized formulas to ensure that well control operations are performed consistently and safely across the industry.</p>
            </div>
            <div class="note-card">
                <h3>Conclusion</h3>
                <p>
                    This calculator is an indispensable tool for drilling personnel, providing a quick and accurate determination of the required kill mud weight. Using it correctly is fundamental to maintaining primary well control, safely managing kicks, and preventing blowouts, thereby protecting personnel, the environment, and drilling assets.
                </p>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('printDate')) {
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            }
        });

        function calculateAndDisplay() {
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');

            // Reset UI
            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');

            let errors = [];

            // Helper function for input validation
            function getVal(id, label, opts = {}) {
                const el = document.getElementById(id);
                const raw = el.value?.toString().trim();

                if (!raw) {
                    errors.push(`üëâ ${label} is required.`);
                    return null;
                }

                const num = parseFloat(raw);

                if (isNaN(num)) {
                    errors.push(`üëâ Enter a valid number for ${label}.`);
                    return null;
                }

                if (opts.allowZero ? num < 0 : num <= 0) {
                    errors.push(`üëâ ${label} must be a positive number.`);
                    return null;
                }

                if (opts.min !== undefined && num < opts.min) {
                    errors.push(`üëâ ${label} must be ‚â• ${opts.min}.`);
                }

                if (opts.max !== undefined && num > opts.max) {
                    errors.push(`üëâ ${label} must be ‚â§ ${opts.max}.`);
                }

                // Decimal precision check
                if (opts.decimals !== undefined) {
                    const decimalPart = raw.split('.')[1];
                    if (decimalPart && decimalPart.length > opts.decimals) {
                         errors.push(`üëâ ${label} must have at most ${opts.decimals} decimal place(s).`);
                    }
                }

                return num;
            }

            // Validate Inputs
            const mw = getVal('currentMW', 'Current Mud Weight (MW)', { min: 4, max: 22, decimals: 2 });
            const h = getVal('holeDepth', 'Hole Depth (H)', { min: 100, max: 30000, decimals: 1 });
            const pk = getVal('kickPressure', 'Kick Pressure (Pk)', { min: 0, max: 5000, decimals: 1, allowZero: true });

            if (h === 0) {
                errors.push('üëâ Hole Depth (H) cannot be zero.');
            }

            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join('<br>');
                errorBox.classList.remove('hidden');
                placeholder.classList.add('hidden');
                return;
            }

            // Kill Mud Weight calculation (Note: A constant 0.052 is needed for field units)
            const kmw = mw + (pk / (0.052 * h));

            // Display Result
            placeholder.classList.add('hidden');
            resultValueBox.classList.remove('hidden');

            document.getElementById('rateValue').textContent = kmw.toFixed(2);

            // Feedback with operational guidance
            let feedback = `Calculation based on:<br>
                            - MW = <strong>${mw} ppg</strong><br>
                            - H = <strong>${h} ft</strong><br>
                            - Pk = <strong>${pk} psi</strong><br>`;

            if (kmw < mw) {
                feedback += `<span class="average">‚ö†Ô∏è Calculated KMW <strong>${kmw.toFixed(2)} ppg</strong> is less than the current MW. Recheck inputs.</span>`;
            } else if (kmw > 22) {
                feedback += `<span class="bad">üö® Calculated KMW <strong>${kmw.toFixed(2)} ppg</strong> exceeds safe operational limits. Exercise extreme caution.</span>`;
            } else {
                feedback += `<span class="good">‚úÖ Required Kill Mud Weight: <strong>${kmw.toFixed(2)} ppg</strong>. Safe for well control.</span>`;
            }

            document.getElementById('feedbackContent').innerHTML = feedback;
        }

        function printReport() {
            if (document.getElementById('printDate')) {
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            }
            window.print();
        }
    </script>

</body>
</html>
{% endblock %}

<!-- 
1. Input Analysis and Real-World Considerations

The Kill Mud Weight formula is used in drilling operations to prevent well blowouts by increasing the drilling fluid density.

Inputs:

Input	Unit	Typical Range	QEHS Notes
Current Mud Weight (MW)	ppg	8 ‚Äì 20 ppg	Must be positive; excessively high MW can damage formation or cause lost circulation.
Hole Depth (H)	ft	500 ‚Äì 30,000 ft	Cannot be zero; must be positive. Extremely shallow or deep values need caution.
Kick Pressure (Pk)	psi	50 ‚Äì 5000 psi	Must be positive; must not exceed equipment limits.

Cross-field dependency:

MWk = (MW * H + Pk) / H

H cannot be zero ‚Üí division by zero must be prevented.

MWk should be greater than MW for it to make sense physically.

2. Input Validation Rules

Mandatory Fields: All inputs are required. Empty or null values trigger an error.

Numeric Positive Values: Only positive numbers allowed.

Acceptable Ranges:

MW: 8 ‚Äì 20 ppg

H: 500 ‚Äì 30,000 ft

Pk: 50 ‚Äì 5000 psi

Decimals:

MW: max 2 decimal places

H: max 1 decimal place

Pk: max 1 decimal place

Logical Checks:

H ‚â† 0 (avoid division by zero)

MWk ‚â• MW (kill mud weight must make physical sense)

Edge Cases:

Extremely high MWk (e.g., >25 ppg) ‚Üí warn user that drilling risks increase.

Negative or zero Pk ‚Üí invalid input.

3. Output Validation Logic

Calculate Kill Mud Weight (MWk):

ùëÄ
ùëä
ùëò
=
ùëÄ
ùëä
‚ãÖ
ùêª
+
ùëÉ
ùëò
ùêª
MWk=
H
MW‚ãÖH+Pk
	‚Äã


Thresholds:

MWk < 12 ‚Üí Low risk, safe drilling

MWk 12‚Äì20 ‚Üí Normal operational range

MWk > 20 ‚Üí High risk, caution advised

Display interpretable summary:

Show input values used

Show calculated MWk

Warn if MWk exceeds safe operational range
-->