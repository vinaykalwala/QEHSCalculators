{% extends 'base.html' %}
{% block title %}Total Recordable Case Frequency (TRCF) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Total Recordable Case Frequency (TRCF) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 12px;
        }
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background:linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }
        
        /* Result Card */
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }
        
        .sub-results {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eaeaea;
        }

        .sub-result-item {
            text-align: center;
        }
        
        .sub-result-value {
            font-size: 20px;
            font-weight: 600;
            color: #34495e;
        }

        .sub-result-label {
            font-size: 14px;
            color: #7f8c8d;
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        /* Note Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .benchmark-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
            font-size: 14px;
        }
        .benchmark-table thead {
            background-color: #e3f2fd;
            color: #0d47a1;
            font-weight: 600;
        }
        .benchmark-table th, .benchmark-table td {
            padding: 10px 12px;
            border: 1px solid #bbdefb;
            text-align: left;
        }
        .benchmark-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }


        /* Error Box */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    <div class="calculator-container printable" id="printArea">

        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Total Recordable Case Frequency (TRCF) Calculator</h1>
            <p>Measure your organization's safety performance by calculating the frequency of recordable incidents per 1,000,000 hours worked.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Enter Safety Data</h2>
                <div class="form-group">
                    <label for="recordableCases">Total Recordable Cases (TRC)</label>
                    <input type="number" id="recordableCases" class="form-input" placeholder="e.g., 3">
                </div>
                <div class="form-group">
                    <label for="totalHoursWorked">Total Hours Worked</label>
                    <input type="number" id="totalHoursWorked" class="form-input" placeholder="e.g., 500000">
                </div>
                <button class="calculate-btn" onclick="calculateTRCF()">Calculate TRCF</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety performance illustration">
                    <p>Enter your incident and work hour data to calculate your TRCF and benchmark your safety performance.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                    
                <div class="result-value hidden" id="resultValue">
                    <div class="rate-value" id="rateValue">0.00</div>
                    <div class="rate-label" id="rateLabel">TRCF (per 1,000,000 hours)</div>
                    
                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Excellent</span><span>Good</span><span>Moderate</span><span>High</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Safety Performance Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <!-- About TRCF -->
            <div class="note-card">
                <h3>📘 About TRCF</h3>
                <p>
                    The <strong>Total Recordable Case Frequency (TRCF)</strong> is a lagging indicator in occupational health
                    and safety.
                    It measures the number of recordable incidents (lost time injuries, restricted work, medical treatment
                    cases) relative
                    to total hours worked, standardizing safety performance for comparison across time periods and industries.
                </p>
            </div>
        
            <!-- Industry Benchmarks -->
            <div class="note-card">
                <h3>📊 Industry Benchmarks</h3>
                <p>TRCF rates vary by industry. Lower values indicate better safety performance. Here are general benchmarks:
                </p>
                <table class="benchmark-table">
                    <thead>
                        <tr>
                            <th>Industry</th>
                            <th>General TRCF Range</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Oil & Gas</td>
                            <td>0.5 - 1.0 (Top performers < 0.5)</td>
                        </tr>
                        <tr>
                            <td>Construction</td>
                            <td>2.5 - 3.5 (Top performers < 2.0)</td>
                        </tr>
                        <tr>
                            <td>Manufacturing</td>
                            <td>3.0 - 4.5</td>
                        </tr>
                        <tr>
                            <td>Healthcare</td>
                            <td>5.0 - 7.0</td>
                        </tr>
                        <tr>
                            <td>Warehousing & Logistics</td>
                            <td>4.0 - 6.0</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        
            <!-- Instructions -->
            <div class="note-card">
                <h3>📝 How to Use</h3>
                <p>Enter the <strong>Total Recordable Cases</strong> and <strong>Total Employee Work Hours</strong> for your
                    organization, then click <strong>"Calculate TRCF"</strong> to evaluate workplace safety performance.</p>
            </div>
        </div>

        <div class="note-card">
            <h3>📥 Input Validations</h3>
            <ul class="note-list">
                <li><strong>Total Recordable Cases (TRC):</strong> Must be a whole number ≥ 0. Fractional or negative numbers
                    are invalid.</li>
                <li><strong>Total Hours Worked:</strong> Must be a positive number > 0. Zero or negative numbers are invalid.
                </li>
                <li>Cross-field consistency check: Extremely high TRC relative to hours (e.g., TRC > hours/100) → ⚠️ Warning:
                    Verify data realism.</li>
                <li>Blank, non-numeric, negative, or fractional values for TRC → flagged as invalid.</li>
                <li>Blank, non-numeric, or ≤0 values for Total Hours Worked → flagged as invalid.</li>
            </ul>
        </div>
        
        <div class="note-card">
            <h3>📤 Output Validations</h3>
            <ul class="note-list">
                <li>TRCF is calculated as: <strong>TRCF = (Total Recordable Cases × 1,000,000) / Total Hours Worked</strong>
                </li>
                <li>Displayed with <strong>2 decimal places</strong>.</li>
                <li>If calculation produces NaN or infinite → <strong>❌ Calculation resulted in an invalid number. Please check
                        your inputs.</strong></li>
                <li>Performance Assessment:</li>
                <ul>
                    <li>✅ <strong>Excellent Performance:</strong> TRCF ≤ 1.0 – Strong safety culture, world-class performance.
                    </li>
                    <li>👍 <strong>Good Performance:</strong> TRCF ≤ 2.5 – Healthy range, maintain proactive safety measures.
                    </li>
                    <li>🟡 <strong>Moderate Performance:</strong> TRCF ≤ 4.0 – Room for improvement, review incident trends.
                    </li>
                    <li>❌ <strong>High Frequency:</strong> TRCF > 4.0 – Elevated incidents, immediate review of safety
                        management recommended.</li>
                </ul>
            </ul>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateTRCF() {
            const cases_val = document.getElementById('recordableCases').value.trim();
            const hours_val = document.getElementById('totalHoursWorked').value.trim();

            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValue = document.getElementById('resultValue');

            let errors = [];

            // --- VALIDATION RULES ---
            const cases = parseFloat(cases_val);
            if (cases_val === '' || isNaN(cases) || cases < 0) {
                errors.push("👉 Total Recordable Cases must be a number ≥ 0.");
            } else if (!Number.isInteger(cases)) {
                errors.push("👉 Total Recordable Cases must be a whole number.");
            }
            if (hours_val === '' || isNaN(hours_val) || parseFloat(hours_val) <= 0) {
                errors.push("👉 Total Hours Worked must be a number > 0.");
            }
            
            // --- ERROR HANDLING ---
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValue.classList.add("hidden");
                return;
            } else {
                errorBox.classList.add("hidden");
            }

            // --- CALCULATION ---
            const hours = parseFloat(hours_val);
            const trcf = (cases * 1000000) / hours;

            if (!isFinite(trcf)) {
                errorMessage.innerHTML = "❌ Calculation resulted in an invalid number. Please check your inputs.";
                errorBox.classList.remove("hidden");
                resultValue.classList.add("hidden");
                return;
            }

            document.getElementById('rateValue').textContent = trcf.toFixed(2);
            
            // --- PERFORMANCE ASSESSMENT ---
            const meterFill = document.getElementById('meterFill');
            let meterWidth, meterColor, feedback;

            if (trcf <= 1.0) {
                meterWidth = '20%';
                meterColor = '#2ecc71'; // Green
                feedback = '✅ <strong>Excellent Performance.</strong> Your TRCF is very low, indicating a strong safety culture and effective risk management. This is world-class performance.';
            } else if (trcf <= 2.5) {
                meterWidth = '45%';
                meterColor = '#f1c40f'; // Yellow
                feedback = '👍 <strong>Good Performance.</strong> Your TRCF is in a healthy range for many industries. Continue to focus on proactive safety measures.';
            } else if (trcf <= 4.0) {
                meterWidth = '70%';
                meterColor = '#e67e22'; // Orange
                feedback = '🟡 <strong>Moderate Performance.</strong> Your TRCF suggests there is room for improvement. It may be beneficial to review incident trends and enhance safety protocols.';
            } else { // > 4.0
                meterWidth = '95%';
                meterColor = '#e74c3c'; // Red
                feedback = '❌ <strong>High Frequency.</strong> Your TRCF is elevated, indicating a higher-than-average number of incidents. A thorough review of your safety management system is strongly recommended.';
            }

            meterFill.style.width = meterWidth;
            meterFill.style.backgroundColor = meterColor;
            document.getElementById('feedbackContent').innerHTML = feedback;

            placeholder.classList.add("hidden");
            resultValue.classList.remove("hidden");
        }

        function printReport() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}

<!-- 
1. Input Validation Rules (TRCF Calculator)
Input	Validation Rule	Acceptable Range	Comments / QEHS Rationale
Total Recordable Cases (TRC)	Must be a non-negative number (≥ 0)	0 – 10,000 (practical upper limit for large organizations)	Negative cases are impossible; extremely high numbers should trigger a warning for potential reporting errors.
Total Hours Worked	Must be a positive number (> 0)	≥ 1 – 100,000,000 hours	Zero or negative hours are invalid; extremely high numbers may indicate data entry mistakes.
Decimals	Accept up to 2 decimal places	n/a	Fractional cases may occur in averaged or adjusted reporting, but usually integers are preferred.
Cross-field consistency	TRC ≤ totalHoursWorked / 100	Ensures TRCF remains realistic	Prevents unrealistic TRCF values (e.g., 1 million TRC for 10,000 hours).

Edge Case Checks:

totalHoursWorked = 0 → Division by zero (error)

recordableCases = 0 → TRCF = 0 (valid, excellent performance)

Extremely high TRC relative to hours → flag for verification

Non-numeric or blank input → error message

2. Output Validation & Thresholds

The TRCF is calculated as:

TRCF
=
Total Recordable Cases
×
1
,
000
,
000
Total Hours Worked
TRCF=
Total Hours Worked
Total Recordable Cases×1,000,000
	​


Output Assessment Categories:

TRCF Value	Feedback	QEHS Meaning
0 – 0.5	✅ Excellent	Best-in-class safety; minimal risk incidents
0.51 – 1.5	🟢 Good	Safe, strong workplace safety performance
1.51 – 3.0	🟡 Average	Acceptable, but safety improvements recommended
>3.0	🔴 Needs Improvement	High risk, indicates safety deficiencies, requires immediate review

Notes:

Display TRCF rounded to 2 decimal places.

Flag calculations producing NaN or Infinity.

Provide feedback and color-coded meter to visualize safety performance.
-->