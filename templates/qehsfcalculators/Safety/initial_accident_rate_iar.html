{% extends 'base.html' %}
{% block title %}Initial Accident Rate Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Initial Accident Rate Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 520px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
      
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Initial Accident Rate (IAR) Calculator</h1>
            <p>Calculate accident frequency normalized by traffic volume and exposure</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="totalAccidents">Total Accidents (B)</label>
                    <input type="number" id="totalAccidents" class="form-input" min="0" step="any" placeholder="e.g., 25">
                </div>
                <div class="form-group">
                    <label for="adt">Average Daily Traffic (ADT)</label>
                    <input type="number" id="adt" class="form-input" min="0" step="any" placeholder="Vehicles per day in 1000s">
                </div>
                <div class="form-group">
                    <label for="locations">Number of Locations/Miles (N)</label>
                    <input type="number" id="locations" class="form-input" min="0" step="any" placeholder="Count or mile length">
                </div>
                
                <button class="calculate-btn" onclick="calculateIAR()">Calculate IAR</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Initial Accident Rate (IAR)</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Initial Accident Rate (IAR)</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">accidents per million vehicle-miles</div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low</span><span>Moderate</span><span>High</span><span>Very High</span><span>Extreme</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Safety Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    The <strong>Initial Accident Rate (IAR) Calculator</strong> measures accident frequency normalized by 
                    traffic volume and exposure, enabling fair comparison across different road segments.
                </p>
            </div>

            <div class="note-card">
                <h3>‚ùì What is Initial Accident Rate?</h3>
                <p>
                    Initial Accident Rate (IAR) is a key metric in traffic safety analysis that helps identify high-risk 
                    areas requiring intervention by considering factors like vehicle flow, road conditions, and accident history.
                </p>
            </div>

            <div class="note-card">
                <h3>‚öôÔ∏è Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Total Accidents (B):</strong> The total number of accidents recorded at a specific location or road segment over one year</li>
                    <li><strong>Average Daily Traffic (ADT):</strong> The average number of vehicles passing through the location each day, measured in thousands</li>
                    <li><strong>Number of Locations/Miles (N):</strong> The total number of locations or the length of the road segment being analyzed</li>
                    <li><strong>0.365:</strong> Conversion factor to scale daily traffic volume to annual traffic</li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>üìä Interpretation</h3>
                <p>
                    <b>Lower IAR Values</b> = safer road conditions. Generally:
                </p>
                <ul class="note-list">
                    <li><span class="good">Below 2.0</span> ‚Üí Low accident rate</li>
                    <li><span class="average">2.0 - 5.0</span> ‚Üí Moderate accident rate</li>
                    <li><span class="bad">Above 5.0</span> ‚Üí High accident rate</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>üåç Real-Life Applications</h3>
                <ul class="note-list">
                    <li><strong>Road Safety Audits</strong> - Identifying hazardous locations</li>
                    <li><strong>Transportation Planning</strong> - Prioritizing improvement projects</li>
                    <li><strong>Insurance Risk Assessment</strong> - Evaluating road segment risks</li>
                    <li><strong>Public Health Studies</strong> - Analyzing traffic injury patterns</li>
                    <li><strong>Environmental Impact Studies</strong> - Assessing traffic safety in sensitive areas</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>üìã Industry Standards</h3>
                <p>
                    FHWA's Highway Safety Manual (HSM) provides standard calculation methods. 
                    ISO 39001 covers road traffic safety management.
                </p>
            </div>
            
            <div class="note-card">
    <h3>‚úÖ Validation Rules (IAR Calculator)</h3>
    <ul class="note-list">
        <li><b>Total Accidents (B):</b> Must be a whole number ‚â• 0, not exceeding 10,000/year.</li>
        <li><b>Average Daily Traffic (ADT):</b> Must be > 0, measured in thousands of vehicles/day. Acceptable range: 1 ‚Äì 3000. Max 2 decimals allowed.</li>
        <li><b>Number of Locations/Miles (N):</b> Must be > 0. Range: 0.1 ‚Äì 500 miles or whole number if location count.</li>
        <li><b>No Negative Values:</b> Negative inputs are not permitted.</li>
        <li><b>Division by Zero:</b> ADT and N cannot be zero.</li>
        <li><b>Unrealistic Outliers:</b> Extremely high values trigger warnings.</li>
    </ul>
</div>

            
            <div class="note-card">
                <h3>üìà Historical Context</h3>
                <ul class="note-list">
                    <li><strong>Vision Zero Programs</strong> use such metrics to reduce traffic fatalities</li>
                    <li><strong>Underestimated rates</strong> led to delayed improvements at known crash corridors</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateIAR() {
    const totalAccidents = document.getElementById('totalAccidents').value.trim();
    const adt = document.getElementById('adt').value.trim();
    const locations = document.getElementById('locations').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];

    /**
     * Validation Rules:
     * B (Accidents)  ‚Üí integer ‚â• 0, max 10,000
     * ADT (Traffic)  ‚Üí > 0, range 1‚Äì3000 (thousands of vehicles/day), max 2 decimals
     * N (Locations)  ‚Üí > 0, integer if count / decimal allowed if miles (0.1‚Äì500)
     */

    // Validate Total Accidents (B)
    if (totalAccidents === "" || isNaN(totalAccidents)) {
        errors.push("üëâ Please enter the total number of accidents.");
    } else if (!Number.isInteger(Number(totalAccidents))) {
        errors.push("üëâ Total accidents must be a whole number.");
    } else if (parseInt(totalAccidents) < 0) {
        errors.push("üëâ Total accidents cannot be negative.");
    } else if (parseInt(totalAccidents) > 10000) {
        errors.push("üëâ Total accidents seems unrealistically high (>10,000/year).");
    }

    // Validate ADT
    if (adt === "" || isNaN(adt)) {
        errors.push("üëâ Please enter the Average Daily Traffic (ADT).");
    } else if (parseFloat(adt) <= 0) {
        errors.push("üëâ ADT must be greater than 0.");
    } else if (parseFloat(adt) > 3000) {
        errors.push("üëâ ADT value is unusually high (>3,000,000 vehicles/day).");
    } else if (!/^(\d+(\.\d{1,2})?)$/.test(adt)) {
        errors.push("üëâ ADT can only have up to 2 decimal places.");
    }

    // Validate Locations / Miles (N)
    if (locations === "" || isNaN(locations)) {
        errors.push("üëâ Please enter the number of locations/miles.");
    } else if (parseFloat(locations) <= 0) {
        errors.push("üëâ Number of locations/miles must be greater than 0.");
    } else if (parseFloat(locations) > 500) {
        errors.push("üëâ Number of miles/locations seems unrealistically high (>500).");
    }

    // Error Handling
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // Safe Calculations
    const B = parseInt(totalAccidents);
    const ADT_val = parseFloat(adt);
    const N = parseFloat(locations);

    // Formula: IAR = B / (ADT √ó 0.365 √ó N)
    const IAR = B / (ADT_val * 0.365 * N);

    document.getElementById('rateValue').textContent = IAR.toFixed(4);

    const meterFill = document.getElementById('meterFill');
    let meterWidth, meterColor, feedback;

    // Output thresholds
    if (IAR === 0) {
        meterWidth = '5%';
        meterColor = '#27ae60';
        feedback = '‚úÖ Zero accidents reported - excellent safety record.';
    } else if (IAR < 2.0) {
        meterWidth = '20%';
        meterColor = '#2ecc71';
        feedback = '‚úÖ Low accident rate - within typical safety thresholds.';
    } else if (IAR < 5.0) {
        meterWidth = '40%';
        meterColor = '#f1c40f';
        feedback = 'üîµ Moderate accident rate - consider safety improvements.';
    } else if (IAR < 10.0) {
        meterWidth = '65%';
        meterColor = '#e67e22';
        feedback = '‚ö†Ô∏è High accident rate - significant safety improvements needed.';
    } else {
        meterWidth = '95%';
        meterColor = '#e74c3c';
        feedback = '‚ùå Extremely high accident rate - immediate intervention required.';
    }

    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;

 

    document.getElementById('feedbackContent').innerHTML = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}


        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}



{% comment %} 
1Ô∏è‚É£ Formula Clarification (keep this in your code as a comment)

/**

Formula Used:

Initial Accident Rate (IAR) = B / (ADT √ó 0.365 √ó N)

Where:

B = Total Accidents (count in 1 year)

ADT = Average Daily Traffic (vehicles per day, in 1000s)

0.365 = Conversion factor (converts ADT √ó 1000 vehicles/day ‚Üí million vehicle-miles/year)

N = Number of locations or segment length in miles

Unit: Accidents per million vehicle-miles

Compliance Reference:

FHWA Highway Safety Manual (HSM)

ISO 39001: Road Traffic Safety Management

OSHA/ILO reporting principles for accident normalization
*/

2Ô∏è‚É£ Input Validation Rules (based on real-world practice)
(a) Total Accidents (B)

Must be an integer ‚â• 0

Cannot exceed realistic historical range ‚Üí typically < 10,000/year for a location

Decimal not allowed (accidents are whole numbers)

(b) Average Daily Traffic (ADT)

Must be > 0

Unit = in thousands of vehicles/day

Acceptable range: 1 to 3000 (i.e., 1,000 to 3,000,000 vehicles/day)

Max 2 decimals allowed for precision

(c) Number of Locations / Miles (N)

Must be > 0

If road length ‚Üí range = 0.1 to 500 miles

If location count ‚Üí must be an integer (no decimals)

Ensure not 0 (to prevent division by zero)

3Ô∏è‚É£ Output Validation Logic

IAR = 0 ‚Üí ‚ÄúExcellent safety record ‚Äì zero accidents‚Äù

0 < IAR < 2.0 ‚Üí Low accident rate (within international norms)

2.0 ‚Äì 5.0 ‚Üí Moderate accident rate ‚Üí safety improvements recommended

5.0 ‚Äì 10.0 ‚Üí High accident rate ‚Üí corrective action required

‚â• 10.0 ‚Üí Extremely high accident rate ‚Üí immediate intervention

‚úÖ Thresholds aligned with FHWA crash frequency norms and Vision Zero safety benchmarking. {% endcomment %}