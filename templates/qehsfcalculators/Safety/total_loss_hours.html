{% extends 'base.html' %}
{% block title %}Total Loss Hours Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Total Loss Hours Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: transform 0.3s ease;
            height: 420px; /* Fixed Height */
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
            justify-content: center;
            align-items: center;
            min-height: 420px; /* Fixed Height */
            text-align: center;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background:linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }
        
        /* Result Card */
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }
        
        .sub-results {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eaeaea;
        }

        .sub-result-item {
            text-align: center;
        }
        
        .sub-result-value {
            font-size: 20px;
            font-weight: 600;
            color: #34495e;
        }

        .sub-result-label {
            font-size: 14px;
            color: #7f8c8d;
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        /* Note Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }

        /* Error Box */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">

        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Total Loss Hours Calculator</h1>
            <p>Quantify the impact of safety incidents on productivity by calculating the total hours of lost production time.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Enter Incident Data</h2>
                <div class="form-group">
                    <label for="incidents">Number of Safety Incidents</label>
                    <input type="number" id="incidents" class="form-input" placeholder="e.g., 5">
                </div>
                <div class="form-group">
                    <label for="lostHours">Avg. Production Hours Lost per Incident</label>
                    <input type="number" id="lostHours" class="form-input" placeholder="e.g., 16">
                </div>
                <button class="calculate-btn" onclick="calculateTotalLossHours()">Calculate Total Loss</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Productivity and safety icon">
                    <p>Enter your incident data to calculate the total loss hours, a key metric for understanding the true cost of workplace incidents.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                    
                <div class="result-value hidden" id="resultValue">
                    <div class="rate-value" id="rateValue">0.00</div>
                    <div class="rate-label" id="rateLabel">Total Production Hours Lost</div>
                    
                    <div class="sub-results">
                        <div class="sub-result-item">
                            <div class="sub-result-value" id="incidentCount">0</div>
                            <div class="sub-result-label">Incidents</div>
                        </div>
                        <div class="sub-result-item">
                            <div class="sub-result-value" id="avgHours">0 hrs</div>
                            <div class="sub-result-label">Avg. Loss / Incident</div>
                        </div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low</span><span>Moderate</span><span>High</span><span>Critical</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Productivity Impact Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>📘 About This Calculator</h3>
                <p>
                    <strong>Total Loss Hours</strong> measure the total number of production hours lost due to workplace
                    injuries or safety-related incidents.
                    This helps assess the overall impact of safety incidents on productivity.
                </p>
            </div>
        
            <div class="note-card">
                <h3>⚙️ Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Number of Incidents:</strong> Total safety incidents that resulted in lost production time.</li>
                    <li><strong>Lost Hours per Incident:</strong> Average production hours lost per safety incident.</li>
                    <li><strong>Formula:</strong><br> Total Loss Hours = ∑(Production Hours Lost Due to Safety Incidents)</li>
                </ul>
            </div>
        
            <div class="note-card">
                <h3>✅ Input Validations:</h3>
                <p>The calculator enforces strict input rules to ensure accurate results:</p>
                <ul class="note-list">
                    <li>If <strong>Number of Incidents</strong> is empty, not a number, or less than 0:<br>
                        <code>👉 Number of Incidents must be a number ≥ 0.</code>
                    </li>
                    <li>If <strong>Number of Incidents</strong> is not a whole number:<br>
                        <code>👉 Number of Incidents must be a whole number.</code>
                    </li>
                    <li>If <strong>Lost Hours per Incident</strong> is empty, not a number, or less than 0:<br>
                        <code>👉 Lost Hours per Incident must be a number ≥ 0.</code>
                    </li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>📊 Output Validations:</h3>
                <p>Once inputs are valid, the calculator ensures results are meaningful:</p>
                <ul class="card-list">
                    <li>If the final result is not a valid number:<br>
                        <code>❌ Calculation resulted in an invalid number. Please check your inputs.</code>
                    </li>
                    <li>When valid, the <strong>Total Loss Hours</strong> is displayed with two decimal places, along with input
                        recap values.</li>
                    <li>Based on the result, feedback is shown with impact levels:
                        <ul class="note-list">
                            <li><strong>≤ 40:</strong> ✅ Low Impact – minimal effect on productivity.</li>
                            <li><strong>41 – 160:</strong> 🟡 Moderate Impact – review causes to avoid further loss.</li>
                            <li><strong>161 – 500:</strong> ⚠️ High Impact – substantial productivity drain.</li>
                            <li><strong>> 500:</strong> ❌ Critical Impact – severe safety/operational issues needing immediate
                                attention.</li>
                        </ul>
                    </li>
                </ul>
            </div>
    
            <div class="note-card">
                <h3>📏 Standards & Compliance</h3>
                <p>
                    This metric is commonly used in occupational health and safety reporting to monitor efficiency loss due to
                    incidents.
                    Tracking it helps organizations align with workplace safety standards and continuous improvement practices.
                </p>
            </div>

            <div class="note-card">
                <h3>✅ Conclusion</h3>
                <p>
                    Monitoring and reducing <strong>Total Loss Hours</strong> helps improve workplace safety and maintain higher
                    operational efficiency.
                    <strong>Lower values are better</strong>, as they indicate fewer disruptions due to incidents.
                </p>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            if (document.getElementById('printDate')) {
                document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            }
        });

        function calculateTotalLossHours() {
            const incidents_val = document.getElementById('incidents').value.trim();
            const lostHours_val = document.getElementById('lostHours').value.trim();

            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValue = document.getElementById('resultValue');

            let errors = [];

            // --- VALIDATION RULES ---
            const incidents = parseFloat(incidents_val);
            if (incidents_val === '' || isNaN(incidents)) {
                errors.push("👉 Number of Incidents is required.");
            } else if (incidents < 0) {
                errors.push("👉 Number of Incidents must be ≥ 0.");
            } else if (!Number.isInteger(incidents)) {
                errors.push("👉 Number of Incidents must be a whole number.");
            } else if (incidents > 500) {
                errors.push("👉 Number of Incidents cannot exceed 500 (annual realistic threshold).");
            }

            const lostHours = parseFloat(lostHours_val);
            if (lostHours_val === '' || isNaN(lostHours)) {
                errors.push("👉 Lost Hours per Incident is required.");
            } else if (lostHours < 0.1) {
                errors.push("👉 Lost Hours per Incident must be at least 0.1 hr.");
            } else if (lostHours > 720) {
                errors.push("👉 Lost Hours per Incident cannot exceed 720 hrs (30 days).");
            }

            // --- ERROR HANDLING ---
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValue.classList.add("hidden");
                return;
            } else {
                errorBox.classList.add("hidden");
            }

            // --- CALCULATION ---
            const totalLossHours = incidents * lostHours;

            if (!isFinite(totalLossHours)) {
                errorMessage.innerHTML = "❌ Calculation resulted in an invalid number. Please check your inputs.";
                errorBox.classList.remove("hidden");
                resultValue.classList.add("hidden");
                return;
            }

            // --- CROSS-FIELD VALIDATION ---
            if (totalLossHours > 8760) { // 1 year of working hours
                errorMessage.innerHTML = "👉 Total Loss Hours exceed 8,760 hrs/year (unrealistic input). Please check values.";
                errorBox.classList.remove("hidden");
                resultValue.classList.add("hidden");
                placeholder.classList.add("hidden");
                return;
            }

            // --- DISPLAY RESULTS ---
            document.getElementById('rateValue').textContent = totalLossHours.toFixed(2);
            document.getElementById('incidentCount').textContent = incidents;
            document.getElementById('avgHours').textContent = lostHours.toFixed(2) + ' hrs';

            // --- ASSESSMENT ---
            const meterFill = document.getElementById('meterFill');
            let meterWidth, meterColor, feedback;

            if (totalLossHours === 0) {
                meterWidth = '10%';
                meterColor = '#2ecc71';
                feedback = '✅ <strong>No Loss Hours.</strong> Excellent performance – no productivity lost due to incidents.';
            } else if (totalLossHours <= 100) {
                meterWidth = '25%';
                meterColor = '#2ecc71'; // Green
                feedback = '✅ <strong>Low Impact.</strong> Minimal productivity loss. Continue with routine monitoring.';
            } else if (totalLossHours <= 500) {
                meterWidth = '50%';
                meterColor = '#f1c40f'; // Yellow
                feedback = '🟡 <strong>Moderate Impact.</strong> Review safety controls and implement preventive measures.';
            } else if (totalLossHours <= 1000) {
                meterWidth = '75%';
                meterColor = '#e67e22'; // Orange
                feedback = '⚠️ <strong>High Impact.</strong> Substantial productivity loss. Immediate safety interventions required.';
            } else {
                meterWidth = '95%';
                meterColor = '#e74c3c'; // Red
                feedback = '❌ <strong>Critical Impact.</strong> Severe productivity loss. Urgent corrective and preventive action required.';
            }

            meterFill.style.width = meterWidth;
            meterFill.style.backgroundColor = meterColor;
            document.getElementById('feedbackContent').innerHTML = feedback;

            placeholder.classList.add("hidden");
            resultValue.classList.remove("hidden");
        }

        function printReport() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            window.print();
        }
    </script>

    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}

<!-- 
✅ 1. Input Validation Rules (QEHS & Fire Safety Perspective)
A. Number of Safety Incidents (incidents)

Mandatory field: Cannot be left blank.

Type: Must be an integer (no decimals).

Range: 0 – 500 incidents/year (more than 500 incidents in a year indicates either poor safety culture or data entry error).

Decimals: Not allowed.

Units: Count of incidents (unitless).

Cross-field logic: If incidents = 0, then totalLossHours must also be 0.

B. Average Production Hours Lost per Incident (lostHours)

Mandatory field: Cannot be left blank.

Type: Must be numeric.

Range: 0.1 – 720 hrs (cannot exceed 30 days of downtime per incident).

Decimals: Allowed up to 2 decimal places.

Units: Hours.

Cross-field logic: If lostHours = 0, output must remain 0 regardless of incidents.

C. Cross-Field Dependencies

totalLossHours = incidents × lostHours.

Maximum cap: totalLossHours should not exceed 365 × 24 = 8,760 hrs/year (since one worker can’t lose more hours than a full year).

If it exceeds → flag as unrealistic input combination.

✅ 2. Output Validation Logic & Thresholds

Total Loss Hours (TLH) is a KPI used in audits (ILO, OSHA, ISO 45001). Suggested classification:

Low Impact (< 100 hrs):
Minimal productivity disruption. Continue routine monitoring.

Moderate Impact (100 – 500 hrs):
Noticeable safety issues. Review preventive measures.

High Impact (500 – 1,000 hrs):
Significant productivity loss. Requires immediate safety intervention.

Critical (> 1,000 hrs):
Severe safety breakdown. Regulatory reporting, management review, and urgent corrective action mandatory.

This ensures results align with OSHA & ISO 45001 safety KPIs.
-->