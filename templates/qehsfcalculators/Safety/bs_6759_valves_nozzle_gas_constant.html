{% extends 'base.html' %}
{% block title %}BS 6759 Valves - Nozzle Gas Constant Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BS 6759 Valves - Nozzle Gas Constant Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
                .btn-container {
    display: flex;
    justify-content: center; /* Horizontally center */
    margin: 30px 0;
}

.back-btn {
    background:linear-gradient(#1560bd,#000040); /* Dark navy background */
    color: #ffffff; /* White text */
    border: 2px solid #1560bd; /* Highlight border */
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none; /* Remove underline for link */
    transition: all 0.3s ease;
    cursor: pointer;
}

.back-btn:hover {
    background-color: #1560bd; /* Highlight on hover */
    color: #ffffff;
    border-color: #000040;
    transform: scale(1.05); /* Subtle hover effect */
}

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            justify-content: center;

        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Error styling */
        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: block;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
    <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
</div>
   <div class="calculator-container printable" id="printArea">

    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>BS 6759 Valves - Nozzle Gas Constant Calculator</h1>
            <p>Calculate the Nozzle Gas Constant (C‚Çô) based on the isentropic coefficient (k)</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="k"><strong>Enter Isentropic Coefficient (k):</strong></label>
                    <input type="number" id="k" class="form-input" step="0.01" min="1.01" placeholder="e.g., 1.4" oninput="validateInput()">
                    <span class="error" id="error-k"></span>
                </div>
                
                <button class="calculate-btn" onclick="calculateCn()">Calculate Nozzle Gas Constant</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="{% static 'images/resultimage.png' %}" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Nozzle Gas Constant (C‚Çô)</strong>. Enter your data to see results here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Nozzle Gas Constant (C‚Çô)</h2>
                    </div>
                    <div class="rate-value" id="rateValue">0.0000</div>
                    <div class="rate-label">Dimensionless factor</div>

                    <div class="result-feedback">
                        <div class="feedback-title">Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

     <!-- Notes Section -->
<div class="note-section">
    <div class="note-card">
        <h3>üìò About This Calculator</h3>
        <p>
            The <strong>Nozzle Gas Constant Calculator</strong> helps determine the C‚Çô value based on the isentropic coefficient (k) 
            according to BS 6759 standards for valve design and safety calculations.
        </p>
    </div>

    <div class="note-card">
        <h3>‚öôÔ∏è Parameters Used</h3>
        <ul class="note-list">
            <li><strong>C‚Çô (Nozzle Gas Constant):</strong> A dimensionless factor used in gas expansion calculations.</li>
            <li><strong>k (Isentropic Coefficient):</strong> The ratio of specific heats (Cp/Cv) of the gas or vapor.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>üìù Input Validation Rules</h3>
        <ul class="note-list">
            <li><strong>k:</strong> Must be numeric and greater than 1.0. Decimal precision up to 2 places. Reject extreme values ‚â•10 or negative.</li>
            <li><strong>Valid range:</strong> 1.01 ‚â§ k ‚â§ 1.67 for real gases (air ~1.4, steam ~1.3, helium ~1.67).</li>
            <li><strong>Cross-field / Edge checks:</strong> Empty, NaN, or division by zero handled with clear error messages.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>üìä Output Validations</h3>
        <ul class="note-list">
            <li>C‚Çô must be finite, positive, and within the expected BS 6759 range (~0.6 ‚Äì 1.0).</li>
            <li>C‚Çô &lt; 0.6 or &gt; 1.2: ‚ö†Ô∏è Warning ‚Äì verify input and units.</li>
            <li>C‚Çô within 0.6 ‚Äì 1.0: ‚úÖ C‚Çô is within the expected engineering range for nozzle gas constants.</li>
            <li>Display output to 4 decimal places for engineering reporting.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>üìè Governing Principle</h3>
        <p>
            The Nozzle Gas Constant Calculator uses the isentropic coefficient (k) to estimate the dimensionless C‚Çô, which determines the flow efficiency of gases through safety valves. 
            It is based on BS 6759 guidelines for pressure relief systems.
        </p>
        <h3>How it Works</h3>
        <ul class="note-list">
            <li><strong>Calculation Formula:</strong> C‚Çô = 3.948 √ó ‚àö[ k √ó (2 / (k + 1))^((k + 1)/(k ‚Äì 1)) ]</li>
            <li><strong>Flow Estimation:</strong> Uses the C‚Çô to determine gas discharge capacity and nozzle performance under isentropic conditions.</li>
        </ul>
        <br>
        <h3>Relevant Standards & Guidelines</h3>
        <ul class="note-list">
            <li><strong>BS 6759:</strong> Specifies requirements for safety valves in pressurized systems.</li>
            <li><strong>ISO 4126:</strong> Provides guidance for safety valve discharge calculations for fluids.</li>
            <li><strong>Engineering Practice:</strong> Typical C‚Çô values range from 0.6‚Äì1.0, depending on gas type and nozzle design.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>‚úÖ Conclusion</h3>
        <p>
            By using this calculator, engineers can safely design gas discharge systems to prevent overpressure and hazards in industrial applications. 
            Correct calculation of C‚Çô improves energy efficiency, reduces material stress, and ensures compliance with safety regulations.
        </p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
});

function validateInput() {
    let k = document.getElementById("k").value.trim();
    let errorK = document.getElementById("error-k");
    errorK.innerHTML = "";

    if (k === "") {
        errorK.innerHTML = "Please enter a value for k.";
        return false;
    }

    let kValue = parseFloat(k);

    if (isNaN(kValue)) {
        errorK.innerHTML = "Isentropic coefficient (k) must be numeric.";
        return false;
    }

    if (kValue <= 1) {
        errorK.innerHTML = "k must be greater than 1 (Cp/Cv ratio).";
        return false;
    }

    if (kValue > 10) {
        errorK.innerHTML = "Unrealistic input: k is too high for real gases.";
        return false;
    }

    if (!/^\d+(\.\d{1,2})?$/.test(k)) {
        errorK.innerHTML = "Limit k to 2 decimal places.";
        return false;
    }

    return true;
}

function calculateCn() {
    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    if (!validateInput()) {
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        errorMessage.innerHTML = "üëâ Invalid input. Please correct errors above.";
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    const kValue = parseFloat(document.getElementById("k").value);
    const exponent = (kValue + 1) / (kValue - 1);
    let Cn = 3.948 * Math.sqrt(kValue * Math.pow(2 / (kValue + 1), exponent));

    if (!isFinite(Cn) || isNaN(Cn)) {
        errorBox.classList.remove("hidden");
        errorMessage.innerHTML = "üëâ Calculation failed. Please check your input.";
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    let feedback = "";
    if (Cn < 0.6 || Cn > 1.2) {
        feedback = "‚ö†Ô∏è Warning: Calculated Cn is outside the typical BS 6759 range. Verify input and units.";
    } else {
        feedback = "‚úÖ Cn is within the expected engineering range for nozzle gas constants.";
    }

    document.getElementById('rateValue').textContent = Cn.toFixed(4);
    document.getElementById('feedbackContent').innerHTML = `
        <p>For isentropic coefficient k = ${kValue.toFixed(2)}, the nozzle gas constant is:</p>
        <p><b>Cn = ${Cn.toFixed(4)}</b></p>
        <p>${feedback}</p>
    `;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}

function printReport() {
    const now = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
    window.print();
}
</script>
<script src="{% static 'js/print.js' %}"></script>

</body>
</html>
{% endblock %}




{% comment %} 
üîπ 1. Formula (BS 6759 Nozzle Gas Constant)
// Formula used for Nozzle Gas Constant (Cn)
// Cn = 3.948 √ó ‚àö[ k √ó (2 / (k + 1))^((k + 1) / (k ‚Äì 1)) ]
// where:
// k = isentropic coefficient (Cp/Cv)
// Cn = nozzle gas constant (dimensionless)

üîπ 2. Input Validation Rules (Real-world QEHS/Fire Safety Standards)
Input	Rule	Reasoning (Compliance / Safety)
Isentropic coefficient (k)	Must be > 1.0 (real gases have Cp/Cv > 1).	Required by thermodynamics. Prevents division by zero in denominator.
	Typical gases: 1.01 ‚â§ k ‚â§ 1.67 (steam ~1.3, air ~1.4, monatomic gases like He ~1.67).	Out-of-range values are not physically meaningful.
	Accept up to 2 decimal places (precision sufficient for valve sizing).	Avoid false accuracy in audits/reports.
	Reject k ‚â• 10 or negative values as invalid.	Prevents extreme/unrealistic inputs.
üîπ 3. Output Validation Rules
Output	Rule	Reason
Cn (Nozzle Gas Constant)	Must be positive finite number. If NaN, division by zero, or Infinity ‚Üí show error.	Ensures safe/usable values in design reports.
	Typical Cn range (from BS 6759 practice): ~0.60 ‚Äì 1.0.	Any Cn far outside should trigger a caution warning.
	Display 4 decimal places.	Matches industry reporting precision.
üîπ 4. Edge Case Handling

Empty input ‚Üí Show ‚ÄúPlease enter k.‚Äù

k ‚â§ 1 ‚Üí Reject (violates thermodynamic definition).

k = 1.0 exactly ‚Üí Division by zero ‚Üí block calculation.

Extremely high k (‚â•10) ‚Üí Warn ‚ÄúUnrealistic input.‚Äù

Output NaN/Infinity ‚Üí Show safe error message instead of broken UI.

Decimal precision check ‚Üí Restrict to 2 decimals on input.

üîπ 5. Corrected JavaScript Code (with Comments)

Here‚Äôs a drop-in replacement for your validation/calculation logic:

// =======================
// BS 6759 Nozzle Gas Constant Calculator
// Formula: Cn = 3.948 √ó ‚àö[ k √ó (2 / (k + 1))^((k + 1) / (k ‚Äì 1)) ]
// Validation rules:
// - k must be numeric
// - k > 1.0 (thermodynamic requirement, Cp/Cv > 1)
// - acceptable engineering range: 1.01 ‚â§ k ‚â§ 1.67 (most real gases)
// - reject k ‚â• 10 or negative values
// - restrict to 2 decimals max
// =======================

*/ {% endcomment %}