{% extends 'base.html' %}
{% block title %}Steam Valve Flow Coefficient (Cv) For Sub-Sonic Flow Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam Valve Flow Coefficient (Cv) For Sub-Sonic Flow Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
     
            @media screen and (max-width: 768px) {
    .calculator-header h1 {
        font-size: 1.5rem; /* smaller font for mobile */
        margin-bottom: 8px;
        text-align: center; /* optional: center the heading on mobile */
    }
}
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: scroll;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 250px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
       
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
          @media (max-width: 768px) {
    .rate-value {
        font-size: 28px; /* smaller font for tablets/mobiles */
    }
}

@media (max-width: 480px) {
    .rate-value {
        font-size: 24px; /* even smaller for phones */
    }
}
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}

    <div class="calculator-header">
        <h1>Steam Valve Flow Coefficient (Cv) For Sub-Sonic Flow Calculator</h1>
        <p>Determine the required steam valve capacity (Kvr) based on steam mass flow and pressure conditions.</p>
    </div>

    <div class="calc-content">
        <!-- Calculator -->
        <div class="calc-card">
            <h2>Enter Data</h2>
            <div class="form-group">
                <label for="ms">Steam mass flowrate (·πÅs) (kg/h)</label>
                <input type="number" id="ms" class="form-input" min="0" placeholder="e.g., 5000">
            </div>
            <div class="form-group">
                <label for="p1">Upstream Pressure (P1) (bar a)</label>
                <input type="number" id="p1" class="form-input" min="0" placeholder="e.g., 10">
            </div>
            <div class="form-group">
                <label for="p2">Downstream Pressure (P2) (bar a)</label>
                <input type="number" id="p2" class="form-input" min="0" placeholder="e.g., 5">
            </div>
            <button class="calculate-btn" onclick="calculateKvr()">Calculate Kvr</button>
        </div>

        <!-- Result Section -->
        <div class="result-card">
            <div class="result-placeholder" id="placeholder">
                <img src="{% static 'images/resultimage.png' %}" alt="Steam Valve illustration">
                <p>This tool will calculate <strong>Required Valve Capacity (Kvr)</strong>. Enter your data to see results and insights here.</p>
            </div>
            
            <div class="result-error hidden" id="resultError">
                <div class="error-icon">‚ùå</div>
                <div class="error-message" id="errorMessage"></div>
            </div>
            
            <div class="result-value hidden" id="resultValue">
                <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                    <h2>Required Valve Capacity (Kvr)</h2>
                </div>
                <div class="rate-value" id="kvrValue">0</div>
                <div class="rate-label" style="color:#2980b9; font-size:16px; font-weight:bold;">
                    m¬≥/h bar
                </div>

                <div class="result-feedback">
                    <div class="feedback-title">Assessment</div>
                    <div class="feedback-content" id="feedbackContent"></div>
                </div>
                <div class="btn-wrapper">
                    <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Section -->
    <div class="note-section">
<div class="note-card">
  <h3>üìò About This Calculator</h3>
  <p>
    The <strong>Steam Valve Flow Coefficient (Cv) Calculator</strong> helps engineers determine the required <strong>valve flow coefficient (Kvr)</strong> for sub-sonic steam flow using <strong>mass flow rate (·πÅs)</strong>, <strong>upstream (P1)</strong>, and <strong>downstream pressure (P2)</strong>. It ensures proper valve sizing for efficient, safe, and cost-effective operation in power, chemical, refinery, and HVAC systems.
  </p>
</div>


        <div class="note-card">
            <h3>‚öôÔ∏è Parameters Used</h3>
            <ul class="note-list">
        <li><strong>·πÅs (Steam mass flow rate):</strong> The amount of steam flowing through the valve per unit time, measured in kilograms per hour (kg/h).</li>
        <li><strong>P1 (Upstream pressure):</strong> The pressure of the steam before it enters the valve, measured in bar absolute (bar a).</li>
        <li><strong>P2 (Downstream pressure):</strong> The pressure of the steam after it passes through the valve, measured in bar absolute (bar a).</li>
            </ul>
        </div>
<div class="note-card">
  <h3>‚úÖ Input Validation Rules</h3>
  <ul class="note-list">
    <li><strong>·πÅs (kg/h):</strong> Must be numeric &gt; 0 (0‚Äì50,000). Warn if &gt;50,000.</li>
    <li><strong>P1 (bar a):</strong> Numeric &gt; 0 (0.1‚Äì100), must be &gt; P2. Warn if &gt;100.</li>
    <li><strong>P2 (bar a):</strong> Numeric ‚â• 0 (0‚Äì100), cannot exceed P1.</li>
    <li><strong>Pressure Drop:</strong> P1 &gt; P2 required for valid flow.</li>
  </ul>
</div>

        <div class="note-card">
            <h3>üìä Output Validations</h3>
            <ul class="note-list">
                <li>Required Valve Capacity < 50:</span> ‚úÖ Low Capacity: Suitable for small steam systems.</li>
                <li>Required Valve Capacity 50‚Äì200:</span> ‚ö†Ô∏è Medium Capacity: Suitable for moderate systems.</li>
                <li>Required Valve Capacity > 200:</span> ‚ùå High Capacity: Verify valve and system can handle flow safely.</li>
            </ul>
        </div>

      <div class="note-card">
    <h3>üìê Governing Principle</h3>
    <p>
        Steam valve flow coefficient (Cv) and Kv calculations for subsonic flow are primarily based on ISA-75.01.01 (and its IEC equivalent, IEC 60534-2-1) standards, which define the sizing equations for control valves and establish the experimental basis for determining Cv and Kv values. While Cv is an imperial unit (US gpm/psi), Kv is a metric unit (m¬≥/h/bar), and both are derived from experimental data and established through these industrial standards to ensure proper valve selection and performance.
    </p>

    <h3 style="margin-top:12px; color:#1976d2;">Key Aspects of the Standards</h3>
    <ul class="note-list">
        <li><b>Experimental Basis:</b> Valve flow coefficients (Cv) are determined experimentally. These standards provide the framework for how these tests are conducted and how the data is used to derive the flow coefficients.</li>
        <li><b>Sizing Equations:</b> ISA-75.01.01 and IEC 60534-2-1 provide the fundamental equations and relationships used to calculate the required valve capacity (Cv or Kv) for a specific fluid and flow condition.</li>
        <li><b>Reference Fluid:</b> Both Cv and Kv standards use water at a specific temperature (60¬∞F for Cv) as the reference fluid for consistent testing and comparison of different valves.</li>
        <li><b>Unit Systems:</b> Cv is an imperial system measure (US gallons per minute at 60¬∞F for a 1 psi pressure drop), while Kv is a metric system measure (cubic meters per hour at a 1 bar pressure drop).</li>
        <li><b>Application:</b> These standards help engineers and manufacturers select the correct valve size by providing a standardized way to compare the flow capacities of different valves.</li>
    </ul>

    <h3 style="margin-top:12px; color:#1976d2;">Why These Standards Matter</h3>
    <ul class="note-list">
        <li><b>Consistency:</b> They ensure that Cv and Kv values provided by different manufacturers can be compared directly, promoting consistency in valve sizing across the industry.</li>
        <li><b>Performance:</b> Adhering to these standards leads to accurate valve sizing, which is crucial for optimal system performance and efficiency.</li>
        <li><b>Interoperability:</b> They facilitate the selection of appropriate valves for various applications and different fluid types, including steam, by providing a universal framework for flow capacity.</li>
    </ul>
</div>



        <div class="note-card">
            <h3>üèÅ Conclusion</h3>
            <p>
                This calculator provides engineers with an easy way to determine the required steam valve capacity for safe and efficient operation. Always verify inputs and ensure P1 > P2 for valid results.
            </p>
        </div>
    </div>
</div>

<script>
function calculateKvr() {
    const ms = parseFloat(document.getElementById('ms').value);
    const p1 = parseFloat(document.getElementById('p1').value);
    const p2 = parseFloat(document.getElementById('p2').value);

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');
    const feedbackContent = document.getElementById('feedbackContent');
    const kvrValue = document.getElementById('kvrValue');

    let errors = [];

    // --- Mandatory & Numeric Check ---
    if (isNaN(ms)) errors.push("üëâ Steam mass flowrate (·πÅs) must be a number.");
    if (isNaN(p1)) errors.push("üëâ Upstream pressure (P1) must be a number.");
    if (isNaN(p2)) errors.push("üëâ Downstream pressure (P2) must be a number.");

    // --- Positive & Realistic Check ---
    if (!isNaN(ms) && ms <= 0) errors.push("üëâ Steam mass flowrate (·πÅs) must be greater than 0 kg/h.");
    if (!isNaN(ms) && ms > 50000) errors.push("‚ö†Ô∏è Steam mass flowrate unusually high (>50,000 kg/h). Verify inputs.");

    if (!isNaN(p1) && p1 <= 0) errors.push("üëâ Upstream pressure (P1) must be greater than 0 bar.");
    if (!isNaN(p1) && p1 > 100) errors.push("‚ö†Ô∏è Upstream pressure unusually high (>100 bar). Verify inputs.");

    if (!isNaN(p2) && p2 < 0) errors.push("üëâ Downstream pressure (P2) must be ‚â• 0 bar.");
    if (!isNaN(p2) && p2 > 100) errors.push("‚ö†Ô∏è Downstream pressure unusually high (>100 bar). Verify inputs.");

    // --- Logical Check ---
    if (!isNaN(p1) && !isNaN(p2) && p1 <= p2) {
        errors.push("‚ö†Ô∏è Upstream pressure (P1) must be greater than downstream pressure (P2).");
    }

    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // --- Calculation ---
    const x = (p1 - p2) / p1;
    const sqrtTerm = 1 - 5.67 * Math.pow(0.42 - x, 2);

    if (sqrtTerm <= 0) {
        errorMessage.innerHTML = "‚ö†Ô∏è Calculation invalid: check P1 and P2 values for physical consistency.";
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    const kvr = ms / (12 * p1 * Math.sqrt(sqrtTerm));

    if (isNaN(kvr) || !isFinite(kvr)) {
        errorMessage.innerHTML = "‚ö†Ô∏è Result invalid: check input values.";
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    kvrValue.textContent = kvr.toFixed(2);

    // --- Feedback ---
    let feedback = "";
    let color = "";
    if (kvr < 50) { feedback = "‚úÖ Low Capacity: Suitable for small steam systems."; color="green"; }
    else if (kvr >= 50 && kvr <= 200) { feedback = "‚ö†Ô∏è Medium Capacity: Suitable for moderate systems."; color="orange"; }
    else { feedback = "‚ùå High Capacity: Verify valve and system can handle flow safely."; color="red"; }

    feedbackContent.innerHTML = `<strong style="color:${color}">${feedback}</strong>`;
    placeholder.classList.add("hidden");
    resultValue.classList.remove("hidden");
}

</script>




    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


<!-- 1. Detailed Input Validation Rules (QEHS / Fire Safety Perspective)
Input	Unit	Acceptable Range	Decimals	Logical Dependencies	Rationale / Compliance
Steam Mass Flowrate (·πÅs)	kg/h	0 < ms ‚â§ 50,000	1 decimal allowed	Must be positive	Steam flow cannot be negative; extremely high flows (>50,000 kg/h) likely indicate mis-entry or industrial-scale systems needing verification. Ensures OSHA / ISO 45001 compliance for process control.
Upstream Pressure (P1)	bar a	0 < P1 ‚â§ 100	2 decimals allowed	Must be > P2	Pressure must be positive; upstream must exceed downstream for flow. Avoids unrealistic / hazardous inputs. Critical for ASME/OSHA safety compliance.
Downstream Pressure (P2)	bar a	0 ‚â§ P2 < P1	2 decimals allowed	Cannot exceed P1	Allows zero (vacuum or low-pressure return) but cannot exceed P1. Prevents illogical flow calculations.
Pressure Drop Ratio (x = (P1 - P2)/P1)	dimensionless	0 < x < 1	3 decimals	Derived from P1 & P2	Ensures calculation remains physically valid. Negative or ‚â•1 would indicate impossible conditions (reverse or choked flow).

Additional Rules / Fire Safety Considerations:

Units consistency: All values must be in kg/h and bar a. Avoid confusion with gauge/bar g units.

Decimal precision: Overly precise decimals (>3 places) may create negligible but confusing output.

Missing fields: Any empty input triggers an error. OSHA & ISO require accurate documentation of process parameters.

Extreme Flow/Pressure Warning: Values beyond typical industrial ranges should generate an audit warning for verification.

2. Output Validation Logic & Thresholds
Kvr (m¬≥/h bar)	Assessment	Color	Explanation / Compliance
< 50	‚úÖ Low Capacity	Green	Suitable for small steam systems. Minimal operational risk. Safe per ISO 45001 / NFPA standards.
50 ‚Äì 200	‚ö†Ô∏è Medium Capacity	Orange	Moderate system flow. Ensure proper valve specification and installation. Standard engineering verification recommended.
> 200	‚ùå High Capacity	Red	High flow, potentially high risk. May indicate need for reinforced piping, safety valves, or manual verification. Crucial for OSHA / fire safety audits.

Edge Case / Safety Warnings:

NaN or Infinity output ‚Üí indicates division by zero or invalid inputs ‚Üí trigger audit alert.

P1 ‚â§ P2 ‚Üí physically impossible; triggers immediate error.

Negative kvr ‚Üí non-physical; must be flagged.

3. Recommended Edge Case Validations
Case	Handling	QEHS Rationale
P1 ‚â§ P2	Error message: "Upstream pressure must be greater than downstream pressure."	Prevents reverse flow, ensures safety valves are sized correctly.
·πÅs ‚â§ 0	Error message: "Mass flow must be > 0"	Steam flow cannot be negative; avoids unrealistic calculations.
P1 = 0 or negative	Error	Avoids undefined square root in formula; prevents hazardous misconfiguration.
P2 < 0	Error	Negative pressures not allowed; may indicate instrumentation failure.
Extreme Kvr (>2000)	Warning: "Check inputs ‚Äì unusually high capacity"	Prevents overpressure, pipe failure, or audit non-compliance.
Non-numeric / blank fields	Error	Ensures data integrity for audits and risk assessments.
Division by zero in calculation	Prevent calculation; show error	Prevents software crash and misleading results.

6. Compliance / Safety Justification for Each Validation

ms > 0 ‚Üí Prevents calculation with zero/negative flow, ensuring operational safety.

P1 > 0 and P2 ‚â• 0 ‚Üí Physical consistency; avoids reverse flow or vacuum hazards.

P1 > P2 ‚Üí Mandatory pressure drop for flow; prevents mis-sized valves.

Upper limits for ms and P1/P2 ‚Üí Protect against industrial errors; aligns with NFPA, OSHA, ISO 45001 risk management principles.

Check sqrtTerm > 0 ‚Üí Prevents mathematically invalid results; ensures calculation reflects physical reality.

Feedback thresholds ‚Üí Provide meaningful operational guidance consistent with audit KPIs. -->