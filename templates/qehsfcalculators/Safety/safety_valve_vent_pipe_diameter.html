{% extends 'base.html' %}
{% block title %}Safety Valve Vent Pipe Diameter Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Valve Vent Pipe Diameter Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        /* Input rows for side-by-side fields */
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Safety Valve Vent Pipe Diameter Calculator</h1>
            <p>Calculate the required vent pipe diameter for safety valves in steam applications</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="input-row">
                    <div class="form-group">
                        <label for="Lc">Equivalent Length of Pipe (L<sub>c</sub>) (m)</label>
                        <input type="number" id="Lc" class="form-input" min="0" step="any" placeholder="e.g., 10">
                    </div>
                    <div class="form-group">
                        <label for="ith">Discharge Capacity (·πÅ) (kg/h)</label>
                        <input type="number" id="ith" class="form-input" min="0" step="any" placeholder="e.g., 5000">
                    </div>
                </div>
                <div class="input-row">
                    <div class="form-group">
                        <label for="setPressure">Safety Valve Set Pressure (P) (bar g)</label>
                        <input type="number" id="setPressure" class="form-input" min="0" step="any" placeholder="e.g., 10">
                    </div>
                    <div class="form-group">
                        <label for="pressureDrop">Required Percentage Pressure Drop (%)</label>
                        <input type="number" id="pressureDrop" class="form-input" min="0" step="any" placeholder="e.g., 10">
                    </div>
                </div>
                <div class="form-group">
                    <label for="vB">Specific Volume of Steam (v<sub>B</sub>) (m¬≥/kg)</label>
                    <input type="number" id="vB" class="form-input" min="0" step="any" placeholder="e.g., 0.1">
                </div>
                
                <button class="calculate-btn" onclick="calculatePipeDiameter()">Calculate Pipe Diameter</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Vent Pipe Diameter</strong> for safety valves. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Vent Pipe Diameter</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Diameter (mm)</div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Small</span><span>Optimal</span><span>Moderate</span><span>Large</span><span>Very Large</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Pipe Diameter Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <!-- About -->
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    The <strong>Safety Valve Vent Pipe Diameter Calculator</strong> determines the appropriate pipe diameter 
                    required for safely venting steam from safety valves. This ensures that discharged steam is safely 
                    released without causing excessive back pressure or structural damage to the vent system, protecting 
                    equipment and personnel.
                </p>
            </div>

            <!-- Parameters Used -->
            <div class="note-card">
                <h3>‚öô Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>L<sub>c</sub> (Equivalent Length of Pipe):</strong> Total equivalent length including fittings and bends (m).</li>
                    <li><strong>·πÅ (Discharge Capacity):</strong> Mass flow rate of steam (kg/h).</li>
                    <li><strong>P (Safety Valve Set Pressure):</strong> Absolute pressure at which the safety valve relieves excess steam (bar g).</li>
                    <li><strong>Required Percentage Pressure Drop:</strong> Acceptable pressure loss across the vent system (%).</li>
                    <li><strong>v<sub>B</sub> (Specific Volume of Steam):</strong> Volume occupied by 1 kg of steam at the given pressure (m¬≥/kg).</li>
                </ul>
            </div>

            <!-- Input Validation Rules -->
            <div class="note-card">
                <h3>‚úÖ Input Validation Rules</h3>
                <ul class="note-list">
                    <li><strong>L<sub>c</sub> (Pipe Length):</strong> >0 and ‚â§200 m (typical 1‚Äì200 m).</li>
        <li><strong>·πÅ (Discharge Capacity):</strong> >0 and ‚â§1,000,000 kg/h (typical 100‚Äì10‚Å∂).</li>
        <li><strong>P (Set Pressure):</strong> >0 and ‚â§200 bar g (typical 1‚Äì200).</li>
        <li><strong>ŒîP (Pressure Drop %):</strong> >0 and ‚â§20% (ASME/API limit).</li>
        <li><strong>v<sub>B</sub> (Specific Volume):</strong> >0 and ‚â§1.7 m¬≥/kg (steam table values).</li>
        <li><strong>Decimals:</strong> Up to 3 places allowed for accuracy.</li>
        <li><strong>Outputs:</strong> Diameter must be within 25‚Äì500 mm. Outside range ‚Üí engineering review required.</li>
    </ul>
            </div>

            <!-- Output Validations -->
            <div class="note-card">
    <h3>‚úÖ Output Validations</h3>
    <ul class="note-list">
        <li><strong>d &lt; 50 mm</strong> ‚Üí Small pipe diameter. Ensure it can handle required discharge capacity.</li>
        <li><strong>50 ‚â§ d ‚â§ 300 mm</strong> ‚Üí Optimal pipe diameter. Suitable for most venting applications.</li>
        <li><strong>d &gt; 300 mm</strong> ‚Üí Large pipe diameter. Check for overestimation in input values.</li>
    </ul>
    <p><i><strong>Normal design range:</strong> 25 ‚Äì 500 mm. Results outside this range should trigger engineering review.</i></p>
</div>


            <!-- Standards -->
            <div class="note-card">
                <h3>üìè Standards</h3>
                <p>
                    This calculator follows industry best practices for safety valve vent pipe sizing as referenced in 
                    <strong>ASME BPVC Section VIII</strong>, <strong>API Standard 520</strong>, and <strong>ISO 4126</strong>. 
                    It aligns with <strong>OSHA</strong> and <strong>QEHS</strong> safety practices to ensure proper system design, 
                    overpressure protection, and operational safety.
                </p>
            </div>

            <!-- Conclusion -->
            <div class="note-card">
                <h3>üí° Conclusion</h3>
                <p>
                    The correct calculation of safety valve vent pipe diameter is <strong>critical for system safety and efficiency</strong>. 
                    A properly sized vent pipe prevents <strong>back pressure issues, pressure vessel damage,</strong> and 
                    <strong>potential hazards</strong>. By following this calculation, engineers and safety professionals ensure 
                    that steam discharge systems operate reliably within safe limits, protecting equipment and personnel.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculatePipeDiameter() {
    const Lc = document.getElementById('Lc').value.trim();
    const ith = document.getElementById('ith').value.trim();
    const setPressure = document.getElementById('setPressure').value.trim();
    const pressureDrop = document.getElementById('pressureDrop').value.trim();
    const vB = document.getElementById('vB').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];
    let warnings = [];

    // --- INPUT VALIDATIONS (ASME/API/ISO ranges) ---
    // Equivalent Length of Pipe
    if (Lc === "" || isNaN(Lc) || parseFloat(Lc) <= 0) {
        errors.push("üëâ Equivalent Length of Pipe (Lc) must be a positive number (>0).");
    } else if (parseFloat(Lc) > 200) {
        warnings.push("‚ö†Ô∏è Lc > 200 m is unusually long. Verify layout.");
    }

    // Discharge Capacity
    if (ith === "" || isNaN(ith) || parseFloat(ith) <= 0) {
        errors.push("üëâ Discharge Capacity (·πÅ) must be a positive number (>0).");
    } else if (parseFloat(ith) > 1e6) {
        warnings.push("‚ö†Ô∏è ·πÅ > 1,000,000 kg/h is outside normal PSV design. Check input.");
    }

    // Set Pressure
    if (setPressure === "" || isNaN(setPressure) || parseFloat(setPressure) <= 0) {
        errors.push("üëâ Set Pressure (P) must be a positive number (>0 bar g).");
    } else if (parseFloat(setPressure) > 200) {
        warnings.push("‚ö†Ô∏è P > 200 bar g exceeds most PSV ratings. Verify input.");
    }

    // Pressure Drop (%)
    if (pressureDrop === "" || isNaN(pressureDrop) || parseFloat(pressureDrop) <= 0) {
        errors.push("üëâ Pressure Drop must be a positive percentage (>0%).");
    } else if (parseFloat(pressureDrop) > 20) {
        errors.push("‚ùå Pressure Drop cannot exceed 20% (per API/ASME guidelines).");
    }

    // Specific Volume of Steam
    if (vB === "" || isNaN(vB) || parseFloat(vB) <= 0) {
        errors.push("üëâ Specific Volume (vB) must be a positive number (>0).");
    } else if (parseFloat(vB) > 1.7) {
        warnings.push("‚ö†Ô∏è vB > 1.7 m¬≥/kg exceeds steam table limits. Check conditions.");
    }

    // --- HANDLE ERRORS ---
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // --- CALCULATION ---
    const Lc_val = parseFloat(Lc);
    const ith_val = parseFloat(ith);
    const setPressure_val = parseFloat(setPressure);
    const pressureDrop_val = parseFloat(pressureDrop);
    const vB_val = parseFloat(vB);

    // Pressure term (bar abs approx)
    const P = setPressure_val * (pressureDrop_val / 100);

    // Prevent division by zero
    if (P <= 0) {
        errorMessage.innerHTML = "‚ùå Calculation error: Effective pressure <= 0. Check inputs.";
        errorBox.classList.remove("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // Pipe diameter formula
    const numerator = Lc_val * ith_val * ith_val * vB_val;
    const denominator = 0.08 * P;
    const pipeDiameter = 5 * Math.sqrt(numerator / denominator);

    if (!isFinite(pipeDiameter) || isNaN(pipeDiameter)) {
        errorMessage.innerHTML = "üëâ Calculation error: check inputs.";
        errorBox.classList.remove("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // --- OUTPUT VALIDATION ---
    if (pipeDiameter < 25) {
        errors.push("‚ùå Diameter < 25 mm is below safe vent pipe standards.");
    } else if (pipeDiameter > 500) {
        warnings.push("‚ö†Ô∏è Diameter > 500 mm is outside normal design. Engineering review needed.");
    }

    // Show results
    document.getElementById('rateValue').textContent = pipeDiameter.toFixed(2);

    // Feedback meter
    const meterFill = document.getElementById('meterFill');
    let meterWidth, meterColor, feedback;

    if (pipeDiameter < 50) {
        meterWidth = '20%'; meterColor = '#f39c12';
        feedback = 'Small pipe diameter. Ensure it can handle discharge capacity.';
    } else if (pipeDiameter <= 300) {
        meterWidth = '60%'; meterColor = '#27ae60';
        feedback = 'Optimal pipe diameter. Suitable for most venting applications.';
    } else {
        meterWidth = '95%'; meterColor = '#e74c3c';
        feedback = 'Large pipe diameter. Verify discharge data and piping assumptions.';
    }

    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;
    document.getElementById('feedbackContent').textContent = feedback + (warnings.length ? " " + warnings.join(" ") : "");

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}


        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}