{% extends 'base.html' %}
{% block title %}Incidence Rate Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incidence Rate Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            height: 420px;
            overflow-y: auto;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
      
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Incidence Rate Calculator</h1>
            <p>Calculate the number of workplace injuries per 1,000 employees</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="injuries">Total Number of Workplace Injuries</label>
                    <input type="number" id="injuries" class="form-input" min="0" placeholder="e.g., 15">
                </div>
                <div class="form-group">
                    <label for="employees">Average Number of Workers Employed</label>
                    <input type="number" id="employees" class="form-input" min="1" placeholder="e.g., 500">
                </div>
                
                <button class="calculate-btn" onclick="calculateIncidenceRate()">Calculate Incidence Rate</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                   <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">

                    <p>This tool will calculate the <strong>Incidence Rate</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd; margin-top:90px;">
                        <h2>Incidence Rate</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Injuries per 1,000 employees</div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Excellent</span><span>Good</span><span>Average</span><span>Poor</span><span>Critical</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Safety Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
        
            <!-- üìò ABOUT THIS CALCULATOR -->
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    The <strong>Incidence Rate Calculator</strong> provides a standardized way to measure the frequency of
                    injuries,
                    illnesses, or other workplace events relative to the total workforce size. It helps organizations benchmark
                    safety performance across departments, industries, or time periods by normalizing event counts per
                    1,000 employees or per standard hours worked.
                </p>
            </div>
        
            <!-- ‚öô PARAMETERS USED -->
            <div class="note-card">
                <h3>‚öô Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Number of Injuries:</strong> Total number of reported workplace injuries or incidents in a
                        defined period.</li>
                    <li><strong>Average Employees:</strong> Average number of employees during that period, representing
                        workforce exposure.</li>
                </ul>
                <p><em>Both values must represent the same time period (usually one calendar year) to ensure accuracy.</em></p>
            </div>
        
            <!-- ‚úÖ INPUT VALIDATION RULES -->
            <div class="note-card">
                <h3>‚úÖ Input Validation Rules</h3>
                <ul class="note-list">
                    <li><strong>Injuries:</strong> Integer only (0‚Äì10,000); cannot exceed 10√ó the employee count.</li>
                    <li><strong>Employees:</strong> Integer only (1‚Äì1,000,000); cannot be zero or negative.</li>
                    <li><strong>Units:</strong> Both inputs are whole numbers (no decimals).</li>
                    <li><strong>Cross-check:</strong> If injuries exceed employees, flagged for review (rare but possible in
                        small teams).</li>
                    <li><strong>Output:</strong> IR = (Injuries √∑ Employees) √ó 1,000; rounded to 2 decimals.</li>
                </ul>
                <p><em>These validation standards align with OSHA, NSC, and Bureau of Labor Statistics (BLS) methodologies.</em>
                </p>
            </div>
        
            <!-- üìä OUTPUT VALIDATIONS -->
            <div class="note-card">
                <h3>üìä Output Validations</h3>
                <ul class="note-list">
                    <li><strong>0:</strong> ‚úÖ Perfect ‚Äî No injuries reported; ideal safety performance.</li>
                    <li><strong>&lt; 3:</strong> ‚úÖ Excellent ‚Äî Well below industry average.</li>
                    <li><strong>3 ‚Äì 5:</strong> üü¢ Good ‚Äî Slightly better than average industry standards.</li>
                    <li><strong>5 ‚Äì 7:</strong> üü° Average ‚Äî Acceptable performance; continue monitoring.</li>
                    <li><strong>7 ‚Äì 10:</strong> üü† Poor ‚Äî Above average incident rate; requires intervention.</li>
                    <li><strong>&gt; 10:</strong> üî¥ Critical ‚Äî Immediate safety review and corrective measures required.</li>
                </ul>
                <p><em>The feedback displayed beside results uses these same threshold messages dynamically based on computed
                        values.</em></p>
            </div>
        
            <!-- üìê GOVERNING PRINCIPLE -->
            <div class="note-card">
                <h3>üìê Governing Principle</h3>
                <p>
                    An Incidence Rate Calculator isn‚Äôt based on one single standard but draws from several international and
                    national
                    frameworks. It helps quantify the rate of new incidents or injuries per a defined population or number of
                    hours worked,
                    providing comparability across workplaces, industries, or regions.
                </p>
                <p>
                    <strong>Common Standards and Methodologies:</strong><br><br>
        
                    <b>Occupational Safety & Health (OSHA, NSC):</b>
                    In the U.S., the standard formula involves calculating:
                    (Number of injuries and illnesses √ó 200,000) √∑ Total employee hours worked.
                    The 200,000 figure represents the hours worked by 100 employees in one year (100 √ó 40 hours/week √ó 50
                    weeks/year).<br><br>
        
                    <b>Public Health:</b>
                    In epidemiology, incidence rates are expressed as:
                    (Number of new cases of a disease) √∑ (Total person-time at risk during a given period),
                    then multiplied by a standard population base (1,000 or 100,000) for comparability.<br><br>
        
                    <b>International Standards:</b>
                    Organizations such as the <strong>European Commission</strong> provide unified calculation
                    methods to compare incidence rates across economic sectors, helping standardize reporting globally.<br><br>
        
                    <b>How It Works:</b><br>
                    Regardless of context, incidence rate calculations determine how frequently new cases (injuries, illnesses,
                    or events)
                    occur within a defined group and timeframe. Using consistent formulas allows comparison across industries,
                    helping identify trends, prioritize safety initiatives, and measure the effectiveness of preventive actions.
                </p>
            </div>
        
            <!-- üß© CONCLUSION -->
            <div class="note-card">
                <h3>üß© Conclusion</h3>
                <p>
                    The Incidence Rate Calculator is a key occupational safety metric that standardizes injury data for
                    meaningful benchmarking.
                    By relating injury counts to workforce size, it enables organizations to evaluate performance objectively,
                    identify
                    improvement areas, and comply with OSHA, NSC, and international reporting standards. Lower incidence rates
                    reflect
                    effective safety management systems and proactive hazard prevention.
                </p>
            </div>
        
        </div>

    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateIncidenceRate() {
    const injuriesInput = document.getElementById('injuries').value.trim();
    const employeesInput = document.getElementById('employees').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];

    // ------------------------------
    // üìå VALIDATION RULES
    // ------------------------------

    // Injuries validation
    if (injuriesInput === "" || isNaN(injuriesInput)) {
        errors.push("üëâ Please enter the number of workplace injuries.");
    } else if (!Number.isInteger(parseFloat(injuriesInput))) {
        errors.push("üëâ Injuries must be a whole number (no decimals).");
    } else if (parseInt(injuriesInput) < 0) {
        errors.push("üëâ Injuries cannot be negative.");
    } else if (parseInt(injuriesInput) > 10000) {
        errors.push("üëâ Injuries cannot exceed 10,000 (out of range).");
    }

    // Employees validation
    if (employeesInput === "" || isNaN(employeesInput)) {
        errors.push("üëâ Please enter the average number of employees.");
    } else if (!Number.isInteger(parseFloat(employeesInput))) {
        errors.push("üëâ Employees must be a whole number (no decimals).");
    } else if (parseInt(employeesInput) <= 0) {
        errors.push("üëâ Number of employees must be greater than 0.");
    } else if (parseInt(employeesInput) > 1000000) {
        errors.push("üëâ Employees cannot exceed 1,000,000 (out of range).");
    }

    // Cross-field validation
    if (injuriesInput !== "" && employeesInput !== "") {
        const injuries = parseInt(injuriesInput);
        const employees = parseInt(employeesInput);

        if (injuries > (10 * employees)) {
            errors.push("üëâ Injuries cannot logically exceed 10 times the number of employees.");
        }
        if (injuries > employees && employees < 50) {
            errors.push("üëâ Check inputs: injuries higher than employees is unlikely in small organizations.");
        }
    }

    // ------------------------------
    // üìå ERROR HANDLING
    // ------------------------------
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // ------------------------------
    // üìå SAFE CALCULATION
    // ------------------------------
    const numInjuries = parseInt(injuriesInput);
    const numEmployees = parseInt(employeesInput);

    const incidenceRate = (numInjuries / numEmployees) * 1000;

    document.getElementById('rateValue').textContent = incidenceRate.toFixed(2);

    const meterFill = document.getElementById('meterFill');
    let meterWidth, meterColor, feedback;

    // ------------------------------
    // üìå OUTPUT THRESHOLDS
    // ------------------------------
    if (incidenceRate === 0) {
        meterWidth = '5%'; 
        meterColor = '#27ae60';
        feedback = '‚úÖ Perfect safety record - no injuries reported.';
    } else if (incidenceRate < 3.0) {
        meterWidth = '20%'; 
        meterColor = '#2ecc71';
        feedback = '‚úÖ Excellent safety performance - well below industry average.';
    } else if (incidenceRate < 5.0) {
        meterWidth = '40%'; 
        meterColor = '#2ecc71';
        feedback = '‚úÖ Good safety performance - better than industry average.';
    } else if (incidenceRate < 7.0) {
        meterWidth = '60%'; 
        meterColor = '#f1c40f';
        feedback = 'üîµ Average safety performance - in line with industry standards.';
    } else if (incidenceRate < 10.0) {
        meterWidth = '80%'; 
        meterColor = '#e67e22';
        feedback = '‚ö†Ô∏è Poor safety performance - above industry average.';
    } else {
        meterWidth = '95%'; 
        meterColor = '#e74c3c';
        feedback = '‚ùå Critical - immediate safety intervention required.';
    }

    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;

    feedback += `<br><br>This means there were ${incidenceRate.toFixed(2)} injuries for every 1,000 employees.`;

    document.getElementById('feedbackContent').innerHTML = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}


        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


{% comment %} 
1. Formula (to keep in your code as comment)
/*
üìå Formula:
Incidence Rate (IR) = (Total Number of Injuries √∑ Average Number of Employees) √ó 1000

üîé Purpose:
- Standardized KPI for workplace safety performance.
- Used by OSHA, ISO 45001 auditors, and insurance providers for benchmarking.

Example:
- Injuries = 15
- Employees = 500
IR = (15 √∑ 500) √ó 1000 = 30.00 injuries per 1000 employees
*/

2. Input Validation Rules (Industry-Compliant)

A. Workplace Injuries (injuries):

Must be a whole number (no decimals).

Range: 0 ‚Äì 10,000 (realistic, OSHA dataset rarely >5,000).

Cannot be negative.

Cross-check: cannot exceed 10 √ó employees (e.g., 500 employees cannot report 10,000 injuries in one year).

B. Average Employees (employees):

Must be a whole number.

Range: 1 ‚Äì 1,000,000 (covers small firms to mega-corporations).

Cannot be negative or zero.

C. Cross-Field Dependency:

If injuries = 0 ‚Üí IR must return 0.00 (special case: perfect safety).

If employees < injuries ‚Üí flag possible reporting error (rare in reality).

D. Units of Measure:

Both values represent counts ‚Üí no decimals allowed.

3. Output Validation & Threshold Logic

Incidence Rate (IR) thresholds (aligned with industry benchmarking, e.g., OSHA BLS average ‚âà 2.7):

Range (IR)	Category	Compliance Meaning
= 0.0	Perfect	No injuries (rare, strong safety program)
< 3.0	Excellent	Well below OSHA average, best-in-class
3.0 ‚Äì 5.0	Good	Better than average
5.0 ‚Äì 7.0	Average	Acceptable, but needs monitoring
7.0 ‚Äì 10.0	Poor	Higher than OSHA average, safety gaps
> 10.0	Critical	Unsafe workplace, needs immediate intervention {% endcomment %}