{% extends 'base.html' %}
{% block title %}Incidence Rate Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incidence Rate Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            height: 420px;
            overflow-y: auto;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
      
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Incidence Rate Calculator</h1>
            <p>Calculate the number of workplace injuries per 1,000 employees</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="injuries">Total Number of Workplace Injuries</label>
                    <input type="number" id="injuries" class="form-input" min="0" placeholder="e.g., 15">
                </div>
                <div class="form-group">
                    <label for="employees">Average Number of Workers Employed</label>
                    <input type="number" id="employees" class="form-input" min="1" placeholder="e.g., 500">
                </div>
                
                <button class="calculate-btn" onclick="calculateIncidenceRate()">Calculate Incidence Rate</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                   <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">

                    <p>This tool will calculate the <strong>Incidence Rate</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd; margin-top:90px;">
                        <h2>Incidence Rate</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Injuries per 1,000 employees</div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Excellent</span><span>Good</span><span>Average</span><span>Poor</span><span>Critical</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Safety Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>📘 About This Calculator</h3>
                <p>
                    The <strong>Incidence Rate Calculator</strong> measures workplace safety by calculating the number of injuries per 1,000 employees, providing a standardized way to compare safety performance across different organizations and industries.
                </p>
            </div>

            <div class="note-card">
                <h3>❓ What is Incidence Rate?</h3>
                <p>
                    Incidence Rate is a safety metric that quantifies the number of workplace injuries relative to the number of employees, standardized to a base of 1,000 workers. This allows for meaningful comparisons between organizations of different sizes.
                </p>
            </div>

            <div class="note-card">
                <h3>⚙️ Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Number of Injuries:</strong> Total workplace injuries occurring during a specific period</li>
                    <li><strong>Average Employees:</strong> Average number of workers employed during that period</li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>📊 Interpretation</h3>
                <p>
                    <b>Lower Incidence Rates</b> = better safety performance.  
                    General benchmarks:
                </p>
                <ul class="note-list">
                    <li><span class="good">Below 3.0</span> → Excellent safety performance</li>
                    <li><span class="good">3.0 - 5.0</span> → Good safety performance</li>
                    <li><span class="average">5.0 - 7.0</span> → Average safety performance</li>
                    <li><span class="bad">7.0 - 10.0</span> → Poor safety performance</li>
                    <li><span class="bad">Above 10.0</span> → Critical safety concerns</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>🌍 Real-Life Applications</h3>
                <ul class="note-list">
                    <li><strong>Workplace Safety Benchmarking</strong> - Comparing safety performance across departments or companies</li>
                    <li><strong>Regulatory Compliance</strong> - Meeting OSHA and other regulatory requirements</li>
                    <li><strong>Safety Program Evaluation</strong> - Measuring the effectiveness of safety initiatives</li>
                    <li><strong>Insurance Risk Assessment</strong> - Determining workers' compensation premiums</li>
                    <li><strong>Industry Comparisons</strong> - Benchmarking against industry averages</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>📋 Industry Standards</h3>
                <p>
                    OSHA uses incidence rates to compare injury and illness experience among different industries and companies. The Bureau of Labor Statistics publishes annual incidence rates by industry, which serve as benchmarks for safety performance.
                </p>
            </div>
            
            <div class="note-card">
    <h3>✅ Validation Rules</h3>
    <ul class="note-list">
        <li><b>Injuries:</b> Integer only, range 0 – 10,000. Cannot exceed 10× employees.</li>
        <li><b>Employees:</b> Integer only, range 1 – 1,000,000. Cannot be zero or negative.</li>
        <li><b>Units:</b> Both inputs are counts (no decimals allowed).</li>
        <li><b>Cross-check:</b> Injuries > employees is allowed, but flagged if unrealistic (e.g., very small workforce).</li>
        <li><b>Output:</b> IR = (Injuries ÷ Employees) × 1000, rounded to 2 decimals.</li>
        <li><b>Thresholds:</b> 0 = Perfect, &lt;3 = Excellent, 3–5 = Good, 5–7 = Average, 7–10 = Poor, >10 = Critical.</li>
    </ul>
</div>

        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateIncidenceRate() {
    const injuriesInput = document.getElementById('injuries').value.trim();
    const employeesInput = document.getElementById('employees').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];

    // ------------------------------
    // 📌 VALIDATION RULES
    // ------------------------------

    // Injuries validation
    if (injuriesInput === "" || isNaN(injuriesInput)) {
        errors.push("👉 Please enter the number of workplace injuries.");
    } else if (!Number.isInteger(parseFloat(injuriesInput))) {
        errors.push("👉 Injuries must be a whole number (no decimals).");
    } else if (parseInt(injuriesInput) < 0) {
        errors.push("👉 Injuries cannot be negative.");
    } else if (parseInt(injuriesInput) > 10000) {
        errors.push("👉 Injuries cannot exceed 10,000 (out of range).");
    }

    // Employees validation
    if (employeesInput === "" || isNaN(employeesInput)) {
        errors.push("👉 Please enter the average number of employees.");
    } else if (!Number.isInteger(parseFloat(employeesInput))) {
        errors.push("👉 Employees must be a whole number (no decimals).");
    } else if (parseInt(employeesInput) <= 0) {
        errors.push("👉 Number of employees must be greater than 0.");
    } else if (parseInt(employeesInput) > 1000000) {
        errors.push("👉 Employees cannot exceed 1,000,000 (out of range).");
    }

    // Cross-field validation
    if (injuriesInput !== "" && employeesInput !== "") {
        const injuries = parseInt(injuriesInput);
        const employees = parseInt(employeesInput);

        if (injuries > (10 * employees)) {
            errors.push("👉 Injuries cannot logically exceed 10 times the number of employees.");
        }
        if (injuries > employees && employees < 50) {
            errors.push("👉 Check inputs: injuries higher than employees is unlikely in small organizations.");
        }
    }

    // ------------------------------
    // 📌 ERROR HANDLING
    // ------------------------------
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // ------------------------------
    // 📌 SAFE CALCULATION
    // ------------------------------
    const numInjuries = parseInt(injuriesInput);
    const numEmployees = parseInt(employeesInput);

    const incidenceRate = (numInjuries / numEmployees) * 1000;

    document.getElementById('rateValue').textContent = incidenceRate.toFixed(2);

    const meterFill = document.getElementById('meterFill');
    let meterWidth, meterColor, feedback;

    // ------------------------------
    // 📌 OUTPUT THRESHOLDS
    // ------------------------------
    if (incidenceRate === 0) {
        meterWidth = '5%'; 
        meterColor = '#27ae60';
        feedback = '✅ Perfect safety record - no injuries reported.';
    } else if (incidenceRate < 3.0) {
        meterWidth = '20%'; 
        meterColor = '#2ecc71';
        feedback = '✅ Excellent safety performance - well below industry average.';
    } else if (incidenceRate < 5.0) {
        meterWidth = '40%'; 
        meterColor = '#2ecc71';
        feedback = '✅ Good safety performance - better than industry average.';
    } else if (incidenceRate < 7.0) {
        meterWidth = '60%'; 
        meterColor = '#f1c40f';
        feedback = '🔵 Average safety performance - in line with industry standards.';
    } else if (incidenceRate < 10.0) {
        meterWidth = '80%'; 
        meterColor = '#e67e22';
        feedback = '⚠️ Poor safety performance - above industry average.';
    } else {
        meterWidth = '95%'; 
        meterColor = '#e74c3c';
        feedback = '❌ Critical - immediate safety intervention required.';
    }

    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;

    feedback += `<br><br>This means there were ${incidenceRate.toFixed(2)} injuries for every 1,000 employees.`;

    document.getElementById('feedbackContent').innerHTML = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}


        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


{% comment %} 
1. Formula (to keep in your code as comment)
/*
📌 Formula:
Incidence Rate (IR) = (Total Number of Injuries ÷ Average Number of Employees) × 1000

🔎 Purpose:
- Standardized KPI for workplace safety performance.
- Used by OSHA, ISO 45001 auditors, and insurance providers for benchmarking.

Example:
- Injuries = 15
- Employees = 500
IR = (15 ÷ 500) × 1000 = 30.00 injuries per 1000 employees
*/

2. Input Validation Rules (Industry-Compliant)

A. Workplace Injuries (injuries):

Must be a whole number (no decimals).

Range: 0 – 10,000 (realistic, OSHA dataset rarely >5,000).

Cannot be negative.

Cross-check: cannot exceed 10 × employees (e.g., 500 employees cannot report 10,000 injuries in one year).

B. Average Employees (employees):

Must be a whole number.

Range: 1 – 1,000,000 (covers small firms to mega-corporations).

Cannot be negative or zero.

C. Cross-Field Dependency:

If injuries = 0 → IR must return 0.00 (special case: perfect safety).

If employees < injuries → flag possible reporting error (rare in reality).

D. Units of Measure:

Both values represent counts → no decimals allowed.

3. Output Validation & Threshold Logic

Incidence Rate (IR) thresholds (aligned with industry benchmarking, e.g., OSHA BLS average ≈ 2.7):

Range (IR)	Category	Compliance Meaning
= 0.0	Perfect	No injuries (rare, strong safety program)
< 3.0	Excellent	Well below OSHA average, best-in-class
3.0 – 5.0	Good	Better than average
5.0 – 7.0	Average	Acceptable, but needs monitoring
7.0 – 10.0	Poor	Higher than OSHA average, safety gaps
> 10.0	Critical	Unsafe workplace, needs immediate intervention {% endcomment %}