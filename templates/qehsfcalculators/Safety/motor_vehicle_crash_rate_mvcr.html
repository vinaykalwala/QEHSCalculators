{% extends 'base.html' %}
{% block title %}Motor Vehicle Crash Rate (MVCR) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor Vehicle Crash Rate (MVCR) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            height: 420px;
            overflow-y: auto;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
      
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Motor Vehicle Crash Rate (MVCR) Calculator</h1>
            <p>Calculate the frequency of vehicle crashes relative to the total distance driven</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="vehicleCrashes">Number of Motor Vehicle Crashes</label>
                    <input type="number" id="vehicleCrashes" class="form-input" min="0" placeholder="e.g., 5">
                </div>
                <div class="form-group">
                    <label for="distanceDriven">Total Distance Driven (Miles or KM)</label>
                    <input type="number" id="distanceDriven" class="form-input" min="1" placeholder="e.g., 1000000">
                </div>
                
                <button class="calculate-btn" onclick="calculateMVCR()">Calculate MVCR</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Motor Vehicle Crash Rate (MVCR)</strong>. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd; margin-top:20px;">
                        <h2>Motor Vehicle Crash Rate (MVCR)</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Crashes per 1,000,000 miles/km</div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Excellent</span><span>Good</span><span>Average</span><span>High Risk</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Risk Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>📘 About This Calculator</h3>
                <p>
                    The <strong>Motor Vehicle Crash Rate (MVCR) Calculator</strong> measures the frequency of vehicle crashes 
                    relative to the total distance driven, providing a standardized way to compare safety performance 
                    across different fleets and time periods.
                </p>
            </div>

            <div class="note-card">
                <h3>❓ What is Motor Vehicle Crash Rate (MVCR)?</h3>
                <p>
                    MVCR is a safety metric that quantifies the number of motor vehicle crashes per unit of distance traveled, 
                    typically expressed per 1,000,000 miles or kilometers.
                </p>
            </div>

            <div class="note-card">
                <h3>⚙️ Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Number of Motor Vehicle Crashes:</strong> Total crashes involving company or employee vehicles</li>
                    <li><strong>Total Distance Driven:</strong> Total miles or kilometers traveled by the fleet during the reporting period</li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>📊 Interpretation</h3>
                <p>
                    <b>Lower MVCR Values</b> = safer driving conditions. Generally:
                </p>
                <ul class="note-list">
                    <li><span class="good">Below 1.0</span> → Excellent safety performance</li>
                    <li><span class="good">1.0 - 2.0</span> → Good safety performance</li>
                    <li><span class="average">2.0 - 3.5</span> → Average, needs improvement</li>
                    <li><span class="bad">Above 3.5</span> → High risk, immediate action needed</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>🌍 Real-Life Applications</h3>
                <ul class="note-list">
                    <li><strong>Fleet Management</strong> - Monitoring and improving vehicle safety</li>
                    <li><strong>Insurance Assessment</strong> - Determining risk levels and premiums</li>
                    <li><strong>Regulatory Compliance</strong> - Meeting safety standards and reporting requirements</li>
                    <li><strong>Safety Benchmarking</strong> - Comparing performance across divisions or companies</li>
                    <li><strong>Driver Training</strong> - Identifying needs for additional training programs</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>📋 Industry Standards</h3>
                <p>
                    MVCR is widely used in transportation safety management, with benchmarks varying by industry. 
                    The U.S. Department of Transportation and other regulatory bodies often use this metric for 
                    compliance reporting and safety assessments.
                </p>
            </div>
            
            <div class="note-card">
    <h3>✅ Validation Rules</h3>
    <ul class="note-list">
        <li><b>Vehicle Crashes:</b> Integer only, range 0 – 10,000 (no decimals).</li>
        <li><b>Distance Driven:</b> Positive number, 1 – 100,000,000 (miles/km).</li>
        <li><b>Cross-Check:</b> Distance must be ≥ crashes (realistic data check).</li>
        <li><b>Zero Crashes:</b> MVCR = 0.0, marked as “Excellent”.</li>
        <li><b>Units:</b> All values must use consistent units (miles OR km).</li>
        <li><b>Standards:</b> Based on OSHA, DOT, NFPA fleet safety reporting practices.</li>
    </ul>
</div>

        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateMVCR() {
    const vehicleCrashes = document.getElementById('vehicleCrashes').value.trim();
    const distanceDriven = document.getElementById('distanceDriven').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];

    // --- Vehicle Crashes Validation ---
    if (vehicleCrashes === "" || isNaN(vehicleCrashes)) {
        errors.push("👉 Please enter the number of motor vehicle crashes.");
    } else if (!Number.isInteger(Number(vehicleCrashes))) {
        errors.push("👉 Number of crashes must be a whole number (no decimals).");
    } else if (parseInt(vehicleCrashes) < 0) {
        errors.push("👉 Number of crashes cannot be negative.");
    } else if (parseInt(vehicleCrashes) > 10000) {
        errors.push("👉 Number of crashes exceeds maximum allowed value (10,000).");
    }

    // --- Distance Driven Validation ---
    if (distanceDriven === "" || isNaN(distanceDriven)) {
        errors.push("👉 Please enter the total distance driven.");
    } else if (parseFloat(distanceDriven) <= 0) {
        errors.push("👉 Distance driven must be greater than zero.");
    } else if (parseFloat(distanceDriven) > 100000000) {
        errors.push("👉 Distance driven exceeds maximum allowed value (100,000,000).");
    }

    // --- Logical Consistency Checks ---
    if (parseInt(vehicleCrashes) > 0 && parseFloat(distanceDriven) < parseInt(vehicleCrashes)) {
        errors.push("👉 Distance driven cannot be less than the number of crashes (unrealistic data).");
    }

    // Show errors if any
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join('<br>');
        errorBox.classList.remove('hidden');
        placeholder.classList.add('hidden');
        resultValue.classList.add('hidden');
        return;
    }

    // Clear any previous errors
    errorBox.classList.add('hidden');
    
    // Parse values
    const crashes = parseInt(vehicleCrashes);
    const distance = parseFloat(distanceDriven);

    // --- Edge Case: No crashes ---
    if (crashes === 0) {
        document.getElementById('rateValue').textContent = "0.00";
        document.getElementById('feedbackContent').innerHTML =
            "✅ No crashes reported. Your MVCR is 0.0, indicating excellent fleet safety.";
        placeholder.classList.add('hidden');
        resultValue.classList.remove('hidden');
        return;
    }

    // --- Calculate MVCR ---
    const mvcr = (crashes * 1000000) / distance;
    document.getElementById('rateValue').textContent = mvcr.toFixed(2);

    // --- Risk Thresholds ---
    const meterFill = document.getElementById('meterFill');
    let fillPercentage = 0;
    let fillColor = '';

    if (mvcr < 1.0) {
        fillPercentage = 15; fillColor = '#2ecc71'; 
        document.getElementById('feedbackContent').innerHTML =
            "✅ Excellent! MVCR below 1.0 indicates top-tier vehicle safety performance.";
    } else if (mvcr >= 1.0 && mvcr <= 2.0) {
        fillPercentage = 45; fillColor = '#3498db';
        document.getElementById('feedbackContent').innerHTML =
            "🟢 Good. MVCR within safe range. Consider aiming for below 1.0.";
    } else if (mvcr > 2.0 && mvcr <= 3.5) {
        fillPercentage = 70; fillColor = '#f39c12';
        document.getElementById('feedbackContent').innerHTML =
            "🟡 Average. MVCR indicates moderate safety risks. Review training and monitoring.";
    } else {
        fillPercentage = 95; fillColor = '#e74c3c';
        document.getElementById('feedbackContent').innerHTML =
            "🔴 High Risk! MVCR above 3.5 requires immediate safety interventions.";
    }

    // Update meter
    meterFill.style.width = fillPercentage + '%';
    meterFill.style.background = fillColor;

    // Show results
    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}

        function printReport() {
            window.print();
        }
    </script>
</body>
</html>
{% endblock %}


{% comment %} 
1. Formula (for code comments)

/**

Formula (based on DOT / OSHA / Fleet Safety Management):

MVCR = (Number of Crashes × 1,000,000) ÷ Total Distance Driven

Units: Miles or Kilometers (must be consistent).

Purpose: Normalizes crash frequency to a standard rate per 1,000,000 miles/km.
*/

2. Input Validation Rules (Real-World QEHS / Fire Safety Perspective)

A. Vehicle Crashes (integer only)

Unit: Count of incidents.

Range: 0 – 10,000 (reasonable for fleet reporting).

Decimals: Not allowed (must be integer).

Min threshold: 0 (no negative values).

Logic: Must not exceed fleet crash records for the reporting period.

B. Distance Driven (fleet mileage)

Unit: Miles or kilometers (must be consistent).

Range: 1 – 100,000,000 (DOT and OSHA fleet data norms).

Decimals: Allowed up to 2 (odometer accuracy).

Min threshold: >0 (to avoid divide by zero).

Logic: Must exceed realistic crash distance (e.g., if 5 crashes are reported, distance cannot be 5 km).

C. Cross-field Consistency

If crashes = 0, MVCR should always = 0, regardless of distance.

If distance < crashes, flag as illogical (e.g., 10 crashes in 5 km).

Ensure unit consistency (either all miles or all km for a reporting period).

3. Output Validation (MVCR Interpretation)

Below 1.0 → Excellent (rare crashes, safe driving).

1.0 – 2.0 → Good (acceptable fleet safety).

2.0 – 3.5 → Average (needs improvement, audit recommended).

Above 3.5 → High Risk (non-compliant with fleet safety best practice).

➡ This aligns with OSHA fleet safety guidelines & DOT crash benchmarking.

4. Corrected JavaScript with Validations
/**
 * Formula:
 * MVCR = (Crashes × 1,000,000) ÷ Distance
 * Units must be consistent (Miles or KM)
 */ {% endcomment %}