{% extends 'base.html' %}
{% block title %}Equivalent Circulating Density (ECD) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equivalent Circulating Density (ECD) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background: linear-gradient(#1560bd, #000040);
            /* Dark navy background */
            color: #ffffff;
            /* White text */
            border: 2px solid #1560bd;
            /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
            /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;

                {
                % comment %
            }

            max-width: 700px;

                {
                % endcomment %
            }

            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }

        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }

        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 480px;
            overflow-y: auto;
        }

        .calc-card:hover {
            transform: translateY(-5px);
        }

        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }

        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }

        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }

        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }

        .result-value {
            width: 100%;
        }

        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }

        .rate-label {
            color: #7f8c8d;
        }

        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }

        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }

        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }

        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .feedback-content {
            color: #34495e;
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .note-card:hover {
            transform: translateY(-2px);
        }

        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }

        .note-card p,
        .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }

        .note-list {
            margin: 0;
            padding-left: 18px;
        }

        .formula-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 6px solid #0d47a1;
        }

        .formula-card code {
            display: inline-block;
            background: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #0d47a1;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .good {
            color: #2e7d32;
            font-weight: 600;
        }

        .average {
            color: #f9a825;
            font-weight: 600;
        }

        .bad {
            color: #c62828;
            font-weight: 600;
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }

        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }

        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    <div class="calculator-container printable" id="printArea">

        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Equivalent Circulating Density (ECD) Calculator</h1>
            <p>Calculate the Equivalent Circulating Density (ECD) for drilling operations</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="mudWeight">Mud Weight (ppg)</label>
                    <input type="number" id="mudWeight" class="form-input" min="0" step="0.1" placeholder="e.g., 12.5">
                </div>
                <div class="form-group">
                    <label for="pressure">Annular Pressure Loss (psi)</label>
                    <input type="number" id="pressure" class="form-input" min="0" step="0.1" placeholder="e.g., 250">
                </div>
                <div class="form-group">
                    <label for="depth">True Vertical Depth (feet)</label>
                    <input type="number" id="depth" class="form-input" min="1" step="0.1" placeholder="e.g., 10000">
                </div>

                <button class="calculate-btn" onclick="calculateECD()">Calculate ECD</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="{% static 'images/resultimage.png' %}" alt="Safety illustration">

                    <p>This tool will calculate the <strong>Equivalent Circulating Density (ECD)</strong>. Enter your
                        data to see results and insights here.</p>
                </div>

                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>

                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type"
                        style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Equivalent Circulating Density</h2>
                    </div>
                    <div class="rate-value" id="rateValue">0.00</div>
                    <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Pounds per Gallon
                        (ppg)</div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Optimal</span><span>Good</span><span>Moderate</span><span>High</span><span>Critical</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    The <strong>Equivalent Circulating Density (ECD) Calculator</strong> helps evaluate the effective
                    density exerted by circulating drilling fluid on the formation during drilling operations.
                </p>
                <p>
                <h3>‚ùì What is Equivalent Circulating Density?</h3>
                </p>
                <p>ECD is the effective density that accounts for both the static mud weight and the annular pressure
                    losses during circulation. It's a critical parameter in maintaining wellbore stability and
                    preventing formation damage.</p>

            </div>

            <div class="note-card">
                <h3>‚öôÔ∏è Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Mud Weight (ppg):</strong> The density of the drilling fluid in pounds per gallon.</li>
                    <li><strong>Annular Pressure Loss (psi):</strong> The pressure loss in the annulus due to fluid
                        friction.</li>
                    <li><strong>True Vertical Depth (feet):</strong> The vertical depth of the well at the point of
                        measurement.</li>
                </ul>
            </div>
            <div class="note-card">
                <h3>‚úÖ Input Validation Rules</h3>
                <ul class="note-list">
                    <li><strong>Mud Weight (ppg):</strong> Must be between 8.0 and 22.0 ppg. Only numeric values allowed
                        (1 decimal place).</li>
                    <li><strong>Annular Pressure Loss (psi):</strong> Must be between 0 and 1000 psi. Negative values
                        not allowed.</li>
                    <li><strong>True Vertical Depth (ft):</strong> Must be > 0. Typical range is 1000 ‚Äì 25,000 ft. Depth
                        = 0 is invalid (division by zero).</li>
                    <li><strong>Cross-check:</strong> All inputs must be numeric. Extreme outliers will trigger safety
                        warnings.</li>
                </ul>
                <p><b>Note:</b> These validations are aligned with drilling engineering practices and well control
                    safety standards (API, NFPA, OSHA).</p>
            </div>
            <div class="note-card">
                <h3>üìä Output Validations</h3>
                <p>The Equivalent Circulating Density (ECD) increase is assessed as a percentage over the mud weight.
                    The ranges below indicate the level of ECD increase and corresponding safety/operational guidance:
                </p>
                <ul class="note-list">
                    <li>&lt; 2% ‚Äî ‚úÖ Excellent: Minimal ECD increase. Optimal drilling conditions.</li>
                    <li>2% ‚Äì &lt; 5% ‚Äî ‚ö†Ô∏è Good. Moderate ECD increase. Monitor annular pressures.</li>
                    <li>5% ‚Äì &lt; 8% ‚Äî ‚ö†Ô∏è Moderate ECD increase. Review hydraulics and mud properties.</li>
                    <li>8% ‚Äì &lt; 12% ‚Äî üö® High ECD increase. Risk of formation fracture. Adjust drilling parameters.
                    </li>
                    <li>&gt;= 12% ‚Äî ‚ùå Critical ECD increase. Immediate action required.</li>
                </ul>
            </div>

        </div>




        <div class="note-card">
            <h3>üìè Governing Principle</h3>
            <p>
                There is no single, official standard for an <strong>Equivalent Circulating Density (ECD)
                    Calculator</strong>.
                The calculation is based on fundamental fluid mechanics principles and is a routine engineering task in
                the drilling industry.
                The methods and formulas used depend on multiple factors rather than a single prescriptive standard.
            </p>
            <ul class="note-list">
                <li><strong>Calculation Method:</strong> The complexity depends on required accuracy and data
                    availability:
                    <ul>
                        <li>Simple calculators use basic inputs like mud weight, annular pressure, and depth.</li>
                        <li>Complex engineering models account for mud rheology, wellbore geometry, cuttings
                            concentration, flow rate, and temperature.</li>
                        <li>Advanced software may integrate real-time drilling sensor data for highly accurate ECD
                            estimates.</li>
                    </ul>
                </li>
                <li><strong>Industry Best Practices:</strong> While no official standard exists, industry bodies like
                    the International Association of Drilling Contractors (IADC) and Society of Petroleum Engineers
                    (SPE) provide guidelines and technical papers. Engineers typically follow these practices for safety
                    and consistency.</li>
                <li><strong>Commercial vs Academic Tools:</strong>
                    <ul>
                        <li><strong>Proprietary Software:</strong> Advanced calculators by companies like SLB
                            (Schlumberger) are industry benchmarks for accuracy.</li>
                        <li><strong>Educational/Open-Source Tools:</strong> Online ECD calculators for training purposes
                            follow the same fundamental formulas but may lack advanced features or precision.</li>
                    </ul>
                </li>
            </ul>
            <p>
                This principle ensures that ECD calculators provide realistic and consistent density estimates while
                remaining flexible to incorporate site-specific conditions and real-time drilling data.
            </p>
        </div>
        <div class="note-card">
            <h3>üìù Conclusion</h3>
            <p>
                The <strong>Equivalent Circulating Density (ECD) Calculator</strong> is a key tool for maintaining safe
                and efficient drilling operations.
                By monitoring ECD, engineers can balance formation pressures, prevent wellbore instability, avoid lost
                circulation, and optimize drilling performance.
            </p>
            <p>
                Proper input data and adherence to best practices ensure accurate results and help mitigate drilling
                risks.
            </p>
        </div>


    </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function () {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateECD() {
            const mudWeight = document.getElementById('mudWeight').value.trim();
            const pressure = document.getElementById('pressure').value.trim();
            const depth = document.getElementById('depth').value.trim();

            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValue = document.getElementById('resultValue');

            let errors = [];

            /*
            =============================
            INPUT VALIDATION RULES
            Based on drilling safety standards
            =============================
            */

            // Mud Weight Validation (typical safe range: 8‚Äì22 ppg)
            if (mudWeight === "") {
                errors.push("üëâ Please enter the mud weight.");
            } else {
                const mw = parseFloat(mudWeight);
                if (isNaN(mw)) {
                    errors.push("üëâ Mud weight must be numeric.");
                } else if (mw < 8) {
                    errors.push("üëâ Mud weight must be ‚â• 8.0 ppg (minimum for safe well control).");
                } else if (mw > 22) {
                    errors.push("üëâ Mud weight > 22 ppg is unusual. Verify HPHT scenario.");
                }
            }

            // Annular Pressure Loss Validation (0‚Äì1000 psi typical)
            if (pressure === "") {
                errors.push("üëâ Please enter the annular pressure loss.");
            } else {
                const p = parseFloat(pressure);
                if (isNaN(p)) {
                    errors.push("üëâ Annular Pressure Loss  must be numeric.");
                } else if (p < 0) {
                    errors.push("üëâ Annular Pressure Loss  cannot be negative.");
                } else if (p > 1000) {
                    errors.push("üëâ Annular Pressure Loss  > 1000 psi is abnormal. Please verify.");
                }
            }

            // True Vertical Depth Validation (1000‚Äì25,000 ft typical)
            if (depth === "") {
                errors.push("üëâ Please enter the true vertical depth.");
            } else {
                const d = parseFloat(depth);
                if (isNaN(d)) {
                    errors.push("üëâ True Vertical Depth must be numeric.");
                } else if (d <= 0) {
                    errors.push("üëâ True Vertical Depth must be > 0 ft.");
                } else if (d < 1000) {
                    errors.push("üëâ True Vertical Depth < 1000 ft is unusual for ECD calculation. Depth must be > 1000");
                } else if (d > 25000) {
                    errors.push("üëâ True Vertical Depth > 25,000 ft exceeds typical drilling ranges.");
                }
            }

            // ============================
            // ERROR HANDLING
            // ============================
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValue.classList.add("hidden");
                return;
            } else {
                errorBox.classList.add("hidden");
            }

            // ============================
            // CALCULATION
            // ============================
            const MW = parseFloat(mudWeight);
            const AP = parseFloat(pressure);
            const TVD = parseFloat(depth);

            const denominator = 0.052 * TVD;
            if (denominator === 0) {
                errorMessage.innerHTML = "‚ùå Invalid depth (division by zero).";
                errorBox.classList.remove("hidden");
                resultValue.classList.add("hidden");
                return;
            }

            const ECD = MW + (AP / denominator);

            if (!isFinite(ECD) || ECD < 0) {
                errorMessage.innerHTML = "‚ùå Invalid calculation result. Please check inputs.";
                errorBox.classList.remove("hidden");
                resultValue.classList.add("hidden");
                return;
            }

            document.getElementById('rateValue').textContent = ECD.toFixed(2);

            // ============================
            // OUTPUT ASSESSMENT
            // ============================
            const meterFill = document.getElementById('meterFill');
            let meterWidth, meterColor, feedback;

            const ecdIncrease = ECD - MW;
            const percentIncrease = (ecdIncrease / MW) * 100;

            if (percentIncrease < 2) {
                meterWidth = '20%';
                meterColor = '#27ae60';
                feedback = '‚úÖ Excellent: Minimal ECD increase. Optimal drilling conditions.';
            } else if (percentIncrease < 5) {
                meterWidth = '40%';
                meterColor = '#2ecc71';
                feedback = '‚ö†Ô∏è Good. Moderate ECD increase. Monitor annular pressures.';
            } else if (percentIncrease < 8) {
                meterWidth = '60%';
                meterColor = '#f1c40f';
                feedback = '‚ö†Ô∏è Moderate ECD increase. Review hydraulics and mud properties.';
            } else if (percentIncrease < 12) {
                meterWidth = '80%';
                meterColor = '#e67e22';
                feedback = 'üö® High ECD increase. Risk of formation fracture. Adjust drilling parameters.';
            } else {
                meterWidth = '95%';
                meterColor = '#e74c3c';
                feedback = '‚ùå Critical ECD increase. Immediate action required.';
            }

            meterFill.style.width = meterWidth;
            meterFill.style.backgroundColor = meterColor;
            document.getElementById('feedbackContent').textContent = feedback;

            placeholder.classList.add("hidden");
            resultValue.classList.remove("hidden");
        }


        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);

            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>

</html>
{% endblock %}


{% comment %}
1. ECD Formula (for comment/documentation in your code)
/*
üìò Formula Used for Equivalent Circulating Density (ECD):
ECD (ppg) = MW + (AP / (0.052 √ó TVD))

Where:
- MW = Mud Weight (ppg)
- AP = Annular Pressure Loss (psi)
- TVD = True Vertical Depth (ft)
- 0.052 = Unit conversion constant (psi/ft to ppg)

Purpose:
ECD accounts for static mud weight plus the additional effective pressure exerted by circulating mud in the annulus.
Maintaining ECD within safe limits prevents:
‚úî Wellbore collapse (too low ECD)
‚úî Formation fracture & lost circulation (too high ECD)
‚úî Blowouts (ECD too low vs formation pressure)
*/

2. Detailed Input Validation Rules (with compliance rationale)
Input Validation Rule Reason (Compliance / Safety)
Mud Weight (ppg) ‚Ä¢ Must be numeric
‚Ä¢ ‚â• 8.0 ppg (lower bound for water-based mud)
‚Ä¢ ‚â§ 22.0 ppg (practical upper bound in drilling engineering, >22 requires special HPHT fluids)
‚Ä¢ Allow up to 1 decimal place (industry practice) Ensures mud density is realistic; too low causes influx risk, too high
risks fracturing.
Annular Pressure Loss (psi) ‚Ä¢ Must be numeric
‚Ä¢ ‚â• 0 psi (cannot be negative)
‚Ä¢ ‚â§ 1000 psi (typical max range; >1000 indicates extreme hydraulics)
‚Ä¢ Allow up to 1 decimal place High AP beyond 1000 psi indicates poor hydraulics, hole cleaning issues, or unrealistic
input.
True Vertical Depth (ft) ‚Ä¢ Must be numeric
‚Ä¢ > 0 (no zero/negative values)
‚Ä¢ Recommended range: 1,000 ‚Äì 25,000 ft
‚Ä¢ Allow up to 0 decimal places (depths are typically integers) Depth below 1,000 ft is unusual for ECD; above 25,000 ft
only in ultra-deep wells.
Cross-field dependency ‚Ä¢ Denominator check: 0.052 √ó TVD ‚â† 0
‚Ä¢ Ensure AP / (0.052 √ó TVD) does not produce infinite or undefined values. Prevents division by zero, ensures stable
calculation.
3. Output Validation & Thresholds (ECD assessment)

ECD compared to Mud Weight (% increase):

% Increase Over Mud Weight Category Safety Interpretation
< 2% ‚úÖ Optimal Excellent hydraulics; safe drilling margin 2% ‚Äì <5% ‚ö†Ô∏è Good Acceptable but requires monitoring 5% ‚Äì <8%
    ‚ö†Ô∏è Moderate Review hydraulics; caution required 8% ‚Äì <12% üö® High Risk of formation fracture ‚â• 12% ‚ùå Critical
    Immediate corrective action needed {% endcomment %}