{% extends 'base.html' %}
{% block title %}Safety Valve Opening Force Calculator - Spring Housing Vented to Atmosphere{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Valve Opening Force Calculator - Spring Housing Vented to Atmosphere</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        /* Input rows for side-by-side fields */
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Safety Valve Opening Force Calculator - Spring Housing Vented to Atmosphere</h1>
            <p>Calculate the required opening force for safety valves with spring housing vented to atmosphere</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="input-row">
                    <div class="form-group">
                        <label for="fluidPressure">Fluid Inlet Pressure (P<sub>V</sub>) (Pa)</label>
                        <input type="number" id="fluidPressure" class="form-input" min="0" placeholder="e.g., 1000000">
                    </div>
                    <div class="form-group">
                        <label for="nozzleArea">Nozzle Area (A<sub>N</sub>) (m²)</label>
                        <input type="number" id="nozzleArea" class="form-input" min="0" step="0.0001" placeholder="e.g., 0.001">
                    </div>
                </div>
                <div class="input-row">
                    <div class="form-group">
                        <label for="springForce">Spring Force (F<sub>S</sub>) (N)</label>
                        <input type="number" id="springForce" class="form-input" min="0" placeholder="e.g., 500">
                    </div>
                    <div class="form-group">
                        <label for="backPressure">Backpressure (P<sub>B</sub>) (Pa)</label>
                        <input type="number" id="backPressure" class="form-input" min="0" placeholder="e.g., 100000">
                    </div>
                </div>
                <div class="form-group">
                    <label for="discArea">Disc Area (A<sub>D</sub>) (m²)</label>
                    <input type="number" id="discArea" class="form-input" min="0" step="0.0001" placeholder="e.g., 0.0015">
                </div>
                
                <button class="calculate-btn" onclick="calculateOpeningForce()">Calculate Opening Force</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Safety illustration">
                    <p>This tool will calculate the <strong>Required Opening Force</strong> for safety valves with spring housing vented to atmosphere. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Required Opening Force</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Force (N)</div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low</span><span>Optimal</span><span>Moderate</span><span>High</span><span>Very High</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Force Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <!-- About -->
            <div class="note-card">
                <h3>📘 About This Calculator</h3>
                <p>
                    The <strong>Safety Valve Opening Force Calculator</strong> determines the required force to open a safety valve when the spring housing is vented to atmosphere. This calculation ensures that safety valves operate correctly under specified pressure conditions, preventing system overpressure and enhancing safety.
                </p>
            </div>

            <!-- Parameters Used -->
            <div class="note-card">
                <h3>⚙ Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>P<sub>V</sub> (Fluid Inlet Pressure):</strong> The pressure exerted by the fluid at the inlet of the safety valve (Pa).</li>
                    <li><strong>A<sub>N</sub> (Nozzle Area):</strong> The effective cross-sectional area of the valve nozzle through which fluid flows (m²).</li>
                    <li><strong>F<sub>S</sub> (Spring Force):</strong> The force exerted by the valve spring, which opposes the opening of the valve (N).</li>
                    <li><strong>P<sub>B</sub> (Backpressure):</strong> The pressure present at the outlet of the valve, which affects the opening force (Pa).</li>
                    <li><strong>A<sub>D</sub> (Disc Area):</strong> The area of the valve disc that is exposed to pressure (m²).</li>
                </ul>
            </div>

            <!-- Input Validation Rules -->
<div class="note-card">
    <h3>✅ <strong>Input Validation Rules</strong></h3>
    <ul class="note-list">
        <li><strong>Fluid Inlet Pressure (P<sub>V</sub>)</strong> must be <strong>> 0 Pa</strong>.</li>
        <li><strong>Nozzle Area (A<sub>N</sub>)</strong> must be <strong>> 0 m²</strong>.</li>
        <li><strong>Spring Force (F<sub>S</sub>)</strong> must be <strong>≥ 0 N</strong>.</li>
        <li><strong>Backpressure (P<sub>B</sub>)</strong> must be <strong>≥ 0 Pa</strong>.</li>
        <li><strong>Disc Area (A<sub>D</sub>)</strong> must be <strong>> Nozzle Area (A<sub>N</sub>)</strong>.</li>
        <li><strong>All inputs</strong> must be valid <strong>numerical values</strong>.</li>
    </ul>
</div>

<!-- Output Validations -->
<div class="note-card">
    <h3>✅ <strong>Output Validations</strong></h3>
    <ul class="note-list">
        <li><strong>F<sub>O</sub> &lt; 50 N</strong> → <strong>Low Opening Force</strong>. Valve may not function correctly under required pressure.</li>
        <li><strong>50 ≤ F<sub>O</sub> ≤ 5000 N</strong> → <strong>Optimal Opening Force</strong>. The calculated force is within an acceptable range.</li>
        <li><strong>F<sub>O</sub> &gt; 5000 N</strong> → <strong>Excessive Opening Force</strong>. Verify system parameters to ensure proper valve operation.</li>
    </ul>
</div>

            <!-- Standards -->
            <div class="note-card">
                <h3>📏 Standards</h3>
                <p>
                    This calculator follows industry standards for safety valve design and operation, including ASME Boiler and Pressure Vessel Code Section VIII, API Standard 520, and ISO 4126. Proper force determination ensures efficient valve operation, prevents system overpressure, and enhances safety in industrial applications.
                </p>
            </div>

            <!-- Conclusion -->
            <div class="note-card">
                <h3>📝 Conclusion</h3>
                <p>
                    Accurate calculation of the opening force is crucial for ensuring the reliable functioning of pressure relief systems. This tool assists engineers and technicians in determining the required opening force for a safety valve, ensuring proper functionality and compliance with industrial safety standards.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

       function calculateOpeningForce() {
    const fluidPressure = parseFloat(document.getElementById('fluidPressure').value.trim());
    const nozzleArea = parseFloat(document.getElementById('nozzleArea').value.trim());
    const springForce = parseFloat(document.getElementById('springForce').value.trim());
    const backPressure = parseFloat(document.getElementById('backPressure').value.trim());
    const discArea = parseFloat(document.getElementById('discArea').value.trim());

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];
    let warnings = [];

    // ----------------- VALIDATION RULES -----------------
    // Fluid Inlet Pressure (PV) > 0 Pa, practical max 1e8 Pa
    if (isNaN(fluidPressure) || fluidPressure <= 0 || fluidPressure > 1e8) {
        errors.push("👉 Fluid Inlet Pressure must be between 1 and 1e8 Pa.");
    }

    // Nozzle Area (AN) > 0, typical range 1e-6 to 0.1 m²
    if (isNaN(nozzleArea) || nozzleArea <= 0 || nozzleArea < 1e-6 || nozzleArea > 0.1) {
        errors.push("👉 Nozzle Area must be between 1e-6 and 0.1 m².");
    }

    // Spring Force (FS) ≥ 0, reasonable max 1e5 N
    if (isNaN(springForce) || springForce < 0 || springForce > 1e5) {
        errors.push("👉 Spring Force must be between 0 and 1e5 N.");
    }

    // Backpressure (PB) ≥ 0 and ≤ 0.8*PV
    if (isNaN(backPressure) || backPressure < 0) {
        errors.push("👉 Backpressure must be ≥ 0 Pa.");
    } else if (fluidPressure > 0 && backPressure > 0.8 * fluidPressure) {
        errors.push("👉 Backpressure cannot exceed 80% of inlet pressure (per API 520).");
    }

    // Disc Area (AD) > 0, must be greater than Nozzle Area, max 0.5 m²
    if (isNaN(discArea) || discArea <= 0 || discArea > 0.5) {
        errors.push("👉 Disc Area must be > 0 and ≤ 0.5 m².");
    } else if (discArea <= nozzleArea) {
        errors.push("👉 Disc Area must be greater than Nozzle Area.");
    }

    // If any errors, show and return
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // ----------------- CALCULATION -----------------
    const F_O = (fluidPressure * nozzleArea) - springForce - (backPressure * (discArea - nozzleArea));

    if (!isFinite(F_O) || isNaN(F_O)) {
        errorMessage.innerHTML = "👉 Calculation error: check inputs.";
        errorBox.classList.remove("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // ----------------- OUTPUT VALIDATION -----------------
    if (F_O < 0) {
        warnings.push("⚠️ Opening force is negative → Valve will not open under these conditions.");
    }

    document.getElementById('rateValue').textContent = F_O.toFixed(2);

    const meterFill = document.getElementById('meterFill');
    let meterWidth, meterColor, feedback;

    if (F_O < 50) {
        meterWidth = '20%'; meterColor = '#f39c12';
        feedback = 'Low Opening Force: Valve may chatter or fail to open reliably.';
    } else if (F_O <= 5000) {
        meterWidth = '60%'; meterColor = '#27ae60';
        feedback = 'Optimal Opening Force: Within acceptable range.';
    } else {
        meterWidth = '95%'; meterColor = '#e74c3c';
        feedback = 'Excessive Opening Force: Recheck design/system parameters.';
    }

    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;
    document.getElementById('feedbackContent').textContent = feedback + (warnings.length ? " " + warnings.join(" ") : "");

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}

/* 
------------------- FORMULA -------------------
F_O = (P_V * A_N) - F_S - (P_B * (A_D - A_N))

Where:
P_V = Fluid Inlet Pressure (Pa), 1 → 1e8
A_N = Nozzle Area (m²), 1e-6 → 0.1
F_S = Spring Force (N), 0 → 1e5
P_B = Backpressure (Pa), 0 → 0.8 * P_V
A_D = Disc Area (m²), > A_N, ≤ 0.5

Output Thresholds:
F_O < 0 → Invalid, valve will not open
0 ≤ F_O < 50 N → Low
50 ≤ F_O ≤ 5000 N → Optimal
F_O > 5000 N → Excessive
*/


        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}