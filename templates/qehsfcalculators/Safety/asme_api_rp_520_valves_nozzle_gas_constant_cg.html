{% extends 'base.html' %}
{% block title %}ASME (API RP 520) Nozzle Gas Constant Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASME (API RP 520) Nozzle Gas Constant Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
                .btn-container {
    display: flex;
    justify-content: center; /* Horizontally center */
    margin: 30px 0;
}

.back-btn {
    background:linear-gradient(#1560bd,#000040); /* Dark navy background */
    color: #ffffff; /* White text */
    border: 2px solid #1560bd; /* Highlight border */
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none; /* Remove underline for link */
    transition: all 0.3s ease;
    cursor: pointer;
}

.back-btn:hover {
    background-color: #1560bd; /* Highlight on hover */
    color: #ffffff;
    border-color: #000040;
    transform: scale(1.05); /* Subtle hover effect */
}

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            {% comment %} max-width: 700px; {% endcomment %}
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 320px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
       
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div class="btn-container">
    <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
</div>
   <div class="calculator-container printable" id="printArea">

    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>ASME (API RP 520) Nozzle Gas Constant (Cg) Calculator</h1>
            <p>Calculate the nozzle gas constant (Cg) for pressure relief valve sizing</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="k">Isentropic Coefficient (k)</label>
                    <input type="number" id="k" class="form-input" min="0.01" step="0.01" placeholder="e.g., 1.4">
                </div>
                
                <button class="calculate-btn" onclick="calculateCg()">Calculate Cg</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2721/2721299.png" alt="Calculator illustration">

                    <p>This tool will calculate the <strong>Nozzle Gas Constant (Cg)</strong>. Enter the isentropic coefficient (k) to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Nozzle Gas Constant (Cg)</h2>
                    </div>
                    <div class="rate-display">
                    <div class="rate-value" id="cgValue">0.00</div>
                    <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Nozzle Gas Constant (Cg)</div></div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low</span><span>Moderate</span><span>Standard</span><span>High</span><span>Very High</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Interpretation</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    The <strong>Nozzle Gas Constant (Cg) Calculator</strong> helps determine the gas discharge coefficient 
                    through a nozzle in safety valves according to ASME (API RP 520) standards. It's essential for 
                    calculating gas flow rate and pressure relief requirements in industrial applications.
                </p>
            </div>

            <div class="note-card">
                <h3>‚ùì What is the Nozzle Gas Constant (Cg)?</h3>
                <p>Cg represents how efficiently a gas flows through a nozzle. It's a critical parameter in sizing 
                    pressure relief valves for gas service applications.</p>
            </div>

            <div class="note-card">
                <h3>‚öôÔ∏è Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Isentropic Coefficient (k):</strong> The ratio of specific heats (Cp/Cv) that determines gas expansion and compression behavior.</li>
                    <li><strong>520:</strong> A standard conversion factor used in API safety calculations.</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>üè≠ Real-Life Applications</h3>
                <ul class="note-list">
                    <li><strong>Safety Valves in Industries:</strong> Used for proper sizing of pressure relief valves in oil, gas, and chemical industries.</li>
                    <li><strong>Fire Safety Engineering:</strong> Helps in gas dispersion modeling during fire hazards.</li>
                    <li><strong>HVAC and Industrial Airflow:</strong> Regulates airflow and gas emission control in ventilation systems.</li>
                    <li><strong>Gas Pipeline Pressure Control:</strong> Used in natural gas and petroleum processing for leak detection.</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>üìä Interpretation</h3>
                <p>
                    <b>Higher Cg Values</b> indicate a higher gas discharge rate, meaning the nozzle allows more gas to pass through efficiently.
                </p>
                <p>
                    <b>Lower Cg Values</b> indicate restricted gas flow, which may cause pressure buildup.
                </p>
            </div>

            <div class="note-card">
                <h3>üè¢ About ASME (API RP 520)</h3>
                <p>
                    <strong>ASME (API RP 520)</strong> stands for American Society of Mechanical Engineers (American Petroleum Institute Recommended Practice 520). 
                    It provides guidelines for designing and installing pressure relief systems to protect equipment from excessive pressure 
                    in industries like oil & gas and chemical processing.
                </p>
            </div>

            <div class="note-card">
                <h3>‚ùå Why Can't k be Zero?</h3>
                <p>
                    <strong>k cannot be zero</strong> because division by zero is undefined in mathematics, and it would make the formula invalid. 
                    The isentropic coefficient must be greater than 0, with typical values ranging from 1.0 to 1.7 for common gases.
                </p>
            </div>
            <div class="note-card">
    <h3>‚úÖ Validation Rules for This Calculator</h3>
    <ul class="note-list">
        <li><strong>k must be entered:</strong> Cannot be blank.</li>
        <li><strong>Valid range:</strong> 1.0 ‚â§ k ‚â§ 1.67 (typical gases).</li>
        <li><strong>Numeric only:</strong> Text or symbols not allowed.</li>
        <li><strong>Decimals:</strong> Up to 3 decimal places supported.</li>
        <li><strong>k < 1:</strong> Invalid (thermodynamically impossible).</li>
        <li><strong>k = 1:</strong> Special case, fixed Cg = 315.</li>
        <li><strong>k > 2:</strong> Warning ‚Äì outside normal range.</li>
        <li><strong>Output check:</strong> Typical Cg = 250‚Äì400, if outside 200‚Äì600 ‚Üí verify inputs.</li>
    </ul>
</div>

        </div>

    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateCg() {
    const kInput = document.getElementById('k').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];
    let warnings = [];

    // Validation 1: Required
    if (kInput === "") {
        errors.push("üëâ Please enter the isentropic coefficient (k).");
    }

    // Validation 2: Numeric
    if (isNaN(kInput)) {
        errors.push("üëâ k must be a numeric value.");
    }

    const k = parseFloat(kInput);

    if (!isNaN(k)) {
        // Validation 3: Range check
        if (k <= 0) {
            errors.push("üëâ k must be greater than 0.");
        } else if (k < 1) {
            errors.push("üëâ k cannot be less than 1 (thermodynamically invalid).");
        } else if (k > 2) {
            warnings.push("‚ö†Ô∏è k value is outside typical range (1.0‚Äì1.67). Please verify input.");
        }
    }

    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // Calculation
    let Cg;
    if (k === 1) {
        Cg = 315;
    } else {
        Cg = 520 * Math.sqrt(k * Math.pow((2 / (k + 1)), (k + 1) / (k - 1)));
    }

    // Output validation
    if (Cg < 200 || Cg > 600) {
        warnings.push("‚ö†Ô∏è Calculated Cg is outside typical industry range (200‚Äì600). Please verify inputs.");
    }

    document.getElementById('cgValue').textContent = Cg.toFixed(3);

    // Meter/feedback display
    const meterFill = document.getElementById('meterFill');
    let meterWidth, meterColor, feedback;

    if (Cg < 300) {
        meterWidth = '10%'; meterColor = '#2ecc71';
        feedback = 'Low discharge efficiency ‚Äì nozzle restricts flow.';
    } else if (Cg < 330) {
        meterWidth = '30%'; meterColor = '#3498db';
        feedback = 'Moderate coefficient ‚Äì typical for many gases.';
    } else if (Cg < 360) {
        meterWidth = '50%'; meterColor = '#f39c12';
        feedback = 'Standard discharge coefficient ‚Äì safe and typical.';
    } else if (Cg < 400) {
        meterWidth = '70%'; meterColor = '#e67e22';
        feedback = 'High discharge coefficient ‚Äì efficient gas flow.';
    } else {
        meterWidth = '90%'; meterColor = '#e74c3c';
        feedback = 'Very high discharge coefficient ‚Äì recheck inputs.';
    }

    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;
    document.getElementById('feedbackContent').textContent = feedback + (warnings.length ? " " + warnings.join(" ") : "");

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>

</body>
</html>
{% endblock %}



/*
Formula Reference (ASME API RP 520):
------------------------------------
Cg = 520 * sqrt( k * (2 / (k + 1)) ^ ((k + 1) / (k - 1)) )
Special Case: if k = 1 ‚Üí Cg = 315

Validation Rules (QEHS / Fire Safety):
--------------------------------------
1. k is required (not blank).
2. k must be numeric (no text/invalid chars).
3. Acceptable range: 1.0 ‚â§ k ‚â§ 1.67 (typical gases).
4. Decimals: up to 3 allowed.
5. k < 1 ‚Üí invalid (thermodynamically impossible).
6. k > 2 ‚Üí warning (outside typical range, flag user).
7. Prevent division by zero (handled at k = 1).
8. Cg results should normally fall between 250‚Äì400. 
   If outside, display ‚ÄúUnusual value ‚Äì recheck inputs.‚Äù
*/

{% comment %} 
1. Formula Reference

For ASME (API RP 520) Cg (Nozzle Gas Constant):

ùê∂
ùëî
=
520
‚ãÖ
ùëò
‚ãÖ
(
2
ùëò
+
1
)
ùëò
+
1
ùëò
‚àí
1
Cg=520‚ãÖ
k‚ãÖ(
k+1
2
	‚Äã

)
k‚àí1
k+1
	‚Äã

	‚Äã


k = Cp/Cv (isentropic coefficient of gas).

For k = 1, API recommends a fixed Cg = 315.

2. Input Validation Rules (QEHS/Fire Safety)
Input	Rule	Rationale (OSHA/NFPA/API/ISO)
k (Isentropic Coefficient)	Required ‚Äì cannot be blank.	Safety-critical; missing data invalidates calculation.
	Range: 1.0 ‚â§ k ‚â§ 1.67	Most industrial gases fall here (air = 1.4, natural gas ‚âà 1.31, steam ‚âà 1.3, CO‚ÇÇ ‚âà 1.3). Outside range is unrealistic.
	Decimals: up to 3 allowed	Needed for accuracy in audits (ISO 5167).
	Must be numeric	Prevents injection/invalid entries.
	Logical rule: If k < 1 ‚Üí reject (not possible in thermodynamics).	Protects against invalid calculations.
3. Output Validation Rules

Expected Cg range:
Typical: 250 ‚â§ Cg ‚â§ 400 (industrial gases).
Outliers: 200‚Äì600 ‚Üí warn user as ‚ÄúUnusual value ‚Äì verify input.‚Äù

Threshold Bands for Interpretation (Audit-friendly):

< 300 ‚Üí Restricted flow (low discharge efficiency)

300‚Äì330 ‚Üí Moderate (common for light gases)

330‚Äì360 ‚Üí Standard (industrial benchmark range)

360‚Äì400 ‚Üí High (efficient nozzle flow)

> 400 ‚Üí Very High (rare; recheck k, possible data issue)

4. Edge Cases & Handling
Edge Case	Handling
Blank input	Error ‚Üí "Please enter k."
k ‚â§ 0	Error ‚Üí "k must be > 0."
k < 1	Error ‚Üí "k cannot be less than 1 (thermodynamically impossible)."
k > 2	Warning ‚Üí "Value outside normal gas range ‚Äì recheck."
Non-numeric input	Error ‚Üí "Enter numeric values only."
Division by zero (k=1 in denominator)	Already handled ‚Üí fixed Cg = 315. {% endcomment %}