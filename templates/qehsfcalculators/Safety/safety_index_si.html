{% extends 'base.html' %}
{% block title %}Safety Index (SI) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Index (SI) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px; /* Fixed Height */
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
            justify-content: center;
            align-items: center;
            min-height: 420px; /* Fixed Height */
            text-align: center;
        }
        
        .input-pair {
            display: flex;
            gap: 15px;
            width: 100%;
        }

        @media (max-width: 500px) {
            .input-pair {
                flex-direction: column;
                gap: 0;
            }
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
            width: 100%;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background:linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }
        
        /* Result Card */
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }
        
        .sub-results {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eaeaea;
        }

        .sub-result-item {
            text-align: center;
        }
        
        .sub-result-value {
            font-size: 20px;
            font-weight: 600;
            color: #34495e;
        }

        .sub-result-label {
            font-size: 14px;
            color: #7f8c8d;
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        /* Note Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }

        /* Error Box */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }

        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">

        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Safety Index (SI) Calculator</h1>
            <p>Evaluate the cost-effectiveness of a safety improvement project by calculating its Safety Index, a benefit-cost ratio.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Enter Project & Accident Data</h2>
                <div class="input-pair">
                    <div class="form-group">
                        <label for="reducedAccidents">Accidents Prevented (D)</label>
                        <input type="number" id="reducedAccidents" class="form-input" placeholder="e.g., 5">
                    </div>
                    <div class="form-group">
                        <label for="costPerAccident">Avg. Cost Per Accident ($) (E)</label>
                        <input type="number" id="costPerAccident" class="form-input" placeholder="e.g., 90000">
                    </div>
                </div>
                 <div class="input-pair">
                    <div class="form-group">
                        <label for="effectivenessFactor">Effectiveness Factor (%) (F)</label>
                        <input type="number" id="effectivenessFactor" class="form-input" placeholder="e.g., 75">
                    </div>
                    <div class="form-group">
                        <label for="totalCost">Total Project Cost ($1000s) (C)</label>
                        <input type="number" id="totalCost" class="form-input" placeholder="e.g., 150">
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateSI()">Calculate Safety Index</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Cost-benefit analysis icon">
                    <p>Enter project data to quantify the return on investment for your safety initiative.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                    
                <div class="result-value hidden" id="resultValue">
                    <div class="rate-value" id="rateValue">0.00</div>
                    <div class="rate-label" id="rateLabel">Safety Index (Benefit-Cost Ratio)</div>
                    
                    <div class="sub-results">
                        <div class="sub-result-item">
                            <div class="sub-result-value" id="projectCost"></div>
                            <div class="sub-result-label">Project Cost</div>
                        </div>
                        <div class="sub-result-item">
                            <div class="sub-result-value" id="totalSavings"></div>
                            <div class="sub-result-label">Projected Savings</div>
                        </div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low</span><span>Marginal</span><span>Good</span><span>Excellent</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Return on Investment (ROI) Analysis</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>📘 About This Calculator</h3>
                <p>
                    The **Safety Index (SI)** measures the cost-benefit ratio of safety improvements by comparing accident cost
                    savings to project implementation costs. It helps prioritize investments, ensuring maximum safety impact per
                    dollar spent.
                </p>
            </div>
            <div class="note-card">
                <h3>⚙️ Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Reduced Accidents (D):</strong> Expected number of accidents prevented</li>
                    <li><strong>Cost Per Accident (E):</strong> Comprehensive crash costs (property damage, injuries, etc.)</li>
                    <li><strong>Effectiveness Factor (F):</strong> Expected percentage of maximum possible reduction</li>
                    <li><strong>Total Project Cost:</strong> Implementation cost in thousands of dollars</li>
                </ul>
            </div>
            <div class="note-card">
        <h3>⚠️ Input Validation Rules</h3>
                <ul class="note-list">
                    <li><strong>Reduced Accidents (D):</strong> Must be a number ≥ 0.
                        Example: 5 ✅, 0 ✅, -2 ❌</li>
                    <li><strong>Cost Per Accident ($) (E):</strong> Must be a number > 0.
                        Example: 90000 ✅, 0 ❌, -5000 ❌</li>
                    <li><strong>Effectiveness Factor (%) (F):</strong> Must be a number between 1 and 100.
                        Example: 75 ✅, 0 ❌, 105 ❌</li>
                    <li><strong>Total Project Cost ($1000s) (C):</strong> Must be a number > 0.
                        Example: 150 ✅, 0 ❌, -50 ❌</li>
                    <li><strong>General Checks:</strong> All fields must be filled with numeric values only.</li>
                    <li><strong>Edge Cases:</strong>
                        <ul class="note-list">
                            <li>Zero Reduced Accidents → total savings = 0, Safety Index may be 0.</li>
                            <li>Extremely high Cost per Accident → triggers a warning in feedback.</li>
                            <li>Non-numeric input → error message.</li>
                            <li>Division by zero prevented automatically.</li>
                        </ul>
                    </li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>📊 Output Validations</h3>
                <ul class="note-list">
                    <li><strong>Safety Index (SI):</strong> Computed as <code>Total Savings ÷ Project Cost</code> and displayed to 2
                        decimal places.
                        Example: 2.45</li>
                    <li><strong>Project Cost:</strong> Displayed in USD currency format.
                        Example: $150,000.00</li>
                    <li><strong>Total Savings:</strong> Displayed in USD currency format.
                        Example: $337,500.00</li>
                   
                    <li><strong>Feedback Messages:</strong>
                       <ul class="note-list">
    <li>Safety Index &lt; 1: 
        ❌ <strong>Low Return.</strong> Costs ($PROJECT_COST) exceed projected savings ($TOTAL_SAVINGS).
    </li>
    <li>1 ≤ Safety Index &lt; 3: 
        🟡 <strong>Marginal Return.</strong> Every $1 spent saves $SI. Consider optimizing project design.
    </li>
    <li>3 ≤ Safety Index &lt; 10: 
        👍 <strong>Good Return.</strong> Every $1 spent saves $SI. Strong ROI.
    </li>
    <li>Safety Index ≥ 10: 
        ✅ <strong>Excellent Return.</strong> Highly cost-effective. Every $1 spent saves $SI.
    </li>
    <li>High Accident Cost Warning: 
        ⚠️ (High accident cost used) appears when E &gt; 500,000
    </li>
</ul>

                    </li>
                    <li><strong>Invalid Calculations:</strong> If Safety Index is not finite →
                        ❌ Calculation resulted in an invalid number. Please check your inputs.</li>
                </ul>
            </div>

            <div class="note-card">
    <h3>📏 Governing Principle: Safety Index (SI)</h3>
    <p>The  "Safety Index (SI)" does not refer to a single, universally defined standard. Instead, it is a calculation or metric that is specific to different industries, applications, or regions, and is based on a wide variety of standards. The specific standard depends on the context in which the Safety Index is being used.</p>
    
    <h3>Examples of Safety Indexes and Associated Standards</h3>
    <ul class="note-list">
        <li><strong>Industrial Safety:</strong> The National Safety Council of India (NSCI) uses a Safety Rating System (NSRS) modeled on Indian Standard IS 14489 and ISO 45001. Some industries use a Site Safety Index (SSI) developed by companies like exida to verify Safety Integrity Levels (SIL) as per standards like IEC 61508.</li>
        <li><strong>Engineering and Construction:</strong> Safety Index may be based on the "Factor of Safety" (FoS), comparing maximum stress to working stress. For earthquake-resistant design, Indian Standard IS 1893-1 (2002) outlines seismic force calculation, contributing to building safety assessment.</li>
        <li><strong>Transportation:</strong> The U.S. Wasatch Front Regional Council has a Safety Index methodology for roadway crash data analysis. ICAO recommends using the International System of Units (SI) for unifying measurements in aviation. Rail transport uses standards like EN 50129 and IEC 61508 for calculating safety indexes.</li>
        <li><strong>Maritime Safety:</strong> The International Maritime Organization (IMO) uses Formal Safety Assessment (FSA) for port risk evaluation and a subdivision index to ensure passenger ship stability.</li>
        <li><strong>Chemical Processes:</strong> Specific indexes such as the Inherent System Safety Index (ISSI) assess inherent safety in chemical plants, considering flammability, toxicity, and heat of reaction.</li>
        <li><strong>Public Health:</strong> Occupational health uses tools like the Revised NIOSH Lifting Equation to calculate back injury risks from manual lifting. OSHA uses standardized formulas for incident rates across industries.</li>
        <li><strong>Financial Investment:</strong> SIP calculators (Systematic Investment Plan) determine mutual fund returns. This is not a safety index related to physical safety standards.</li>
        <li><strong>Consumer Products:</strong> OEKO-TEX® STANDARD 100 certifies textiles for the absence of harmful substances.</li>
    </ul>
</div>

            <div class="note-card">
  <h3>✅ Conclusion</h3>
                  <p>
                    The Safety Index converts safety engineering into quantifiable economics, enabling transparent
                    decision-making and highlighting projects that deliver the greatest life-saving value per dollar invested.
                </p>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            if (document.getElementById('printDate')) {
                document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            }
        });

        function calculateSI() {
            // --- GET INPUTS ---
            const D_val = document.getElementById('reducedAccidents').value.trim();
            const E_val = document.getElementById('costPerAccident').value.trim();
            const F_val = document.getElementById('effectivenessFactor').value.trim();
            const C_val = document.getElementById('totalCost').value.trim();

            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValue = document.getElementById('resultValue');

            let errors = [];

            // --- INPUT VALIDATIONS ---
            const D = parseFloat(D_val);
            if (D_val === '' || isNaN(D) || D < 0) errors.push("👉  Accidents Prevented must be a number ≥ 0.");

            const E = parseFloat(E_val);
            if (E_val === '' || isNaN(E) || E <= 0) errors.push("👉 Cost Per Accident must be a number > 0.");

            const F = parseFloat(F_val);
            if (F_val === '' || isNaN(F) || F <= 0 || F > 100) errors.push("👉 Effectiveness Factor must be between 1 and 100.");

            const C = parseFloat(C_val);
            if (C_val === '' || isNaN(C) || C <= 0) errors.push("👉 Total Project Cost must be a number > 0.");

            // --- HANDLE ERRORS ---
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValue.classList.add("hidden");
                return;
            } else {
                errorBox.classList.add("hidden");
            }

            // --- CALCULATION ---
            const totalSavings = D * E * (F / 100);
            const projectCost = C * 1000; // convert from $1000s
            const safetyIndex = totalSavings / projectCost;

            // --- CHECK INVALID CALCULATION ---
            if (!isFinite(safetyIndex)) {
                errorMessage.innerHTML = "❌ Calculation resulted in an invalid number. Please check your inputs.";
                errorBox.classList.remove("hidden");
                resultValue.classList.add("hidden");
                return;
            }

            // --- DISPLAY RESULTS ---
            const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
            document.getElementById('rateValue').textContent = safetyIndex.toFixed(2);
            document.getElementById('projectCost').textContent = formatter.format(projectCost);
            document.getElementById('totalSavings').textContent = formatter.format(totalSavings);

            // --- ASSESSMENT & METER ---
            const meterFill = document.getElementById('meterFill');
            let meterWidth, meterColor, feedback;

            if (safetyIndex < 1) {
                meterWidth = '20%';
                meterColor = '#e74c3c'; // Red
                feedback = `❌ <strong>Low Return.</strong> Costs ($${projectCost.toLocaleString()}) exceed projected savings ($${totalSavings.toLocaleString()}).`;
            } else if (safetyIndex < 3) {
                meterWidth = '45%';
                meterColor = '#e67e22'; // Orange
                feedback = `🟡 <strong>Marginal Return.</strong> Every $1 spent saves $${safetyIndex.toFixed(2)}. Consider optimizing project design.`;
            } else if (safetyIndex < 10) {
                meterWidth = '70%';
                meterColor = '#f1c40f'; // Yellow
                feedback = `👍 <strong>Good Return.</strong> Every $1 spent saves $${safetyIndex.toFixed(2)}. Strong ROI.`;
            } else {
                meterWidth = '95%';
                meterColor = '#2ecc71'; // Green
                feedback = `✅ <strong>Excellent Return.</strong> Highly cost-effective. Every $1 spent saves $${safetyIndex.toFixed(2)}.`;
            }

            // Special warning for extremely high accident costs
            if (E > 500000) feedback += ' ⚠️ (High accident cost used)';

            meterFill.style.width = meterWidth;
            meterFill.style.backgroundColor = meterColor;
            document.getElementById('feedbackContent').innerHTML = feedback;

            placeholder.classList.add("hidden");
            resultValue.classList.remove("hidden");
        }

        function printReport() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            window.print();
        }
    </script>

    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}

<!-- 
1️⃣ Input Validation Rules (QEHS Perspective)
Field	Validation Rules	Example	Rationale
Accidents Prevented (D)	Must be numeric, ≥ 0. Whole numbers recommended.	5 ✅, 0 ✅, -3 ❌, 3.5 ⚠️	Cannot have negative reduction. Zero means no improvement. Fractions are unusual but may occur in aggregated statistics.
Avg. Cost Per Accident ($) (E)	Numeric, ≥ 0, reasonable maximum depending on company context.	90,000 ✅, 0 ❌, -5,000 ❌	Negative or zero cost is meaningless. Extreme outliers should trigger a warning.
Effectiveness Factor (%) (F)	Numeric, 0 < F ≤ 100	75 ✅, 0 ❌, 120 ❌	QEHS projects rarely reach >100% effectiveness; 0 means no safety improvement.
Total Project Cost ($1000s) (C)	Numeric, > 0	150 ✅, 0 ❌, -50 ❌	Zero cost implies no investment. Negative cost is invalid.
General Checks	All fields must be filled. Non-numeric inputs trigger errors.	Empty or letters ❌	Ensures calculations are meaningful.

Edge Cases:

D = 0 → SI = 0, project has no safety return.

E = 0 → SI = 0, no financial benefit.

F = 0 → SI = 0, zero effectiveness.

Extremely high values for E or D → may result in SI > 10 → flagged as “excellent” or warn of unrealistic assumptions.

Non-numeric or blank inputs → error message.

Total project cost = 0 → division by zero error → must trigger validation error.

2️⃣ Output Validation Logic & Thresholds
Output	Validation & Thresholds	Feedback
Safety Index (SI)	Computed as SI = (D × E × F/100) ÷ (C × 1000)	Ensures ratio represents $ return per $ invested.
Total Savings (G)	G = D × E × F/100	Displayed in USD currency format.
SI Interpretation	SI > 10 → Excellent
SI 3–10 → Good
SI 1–3 → Marginal
SI < 1 → Low	Matches real-world ROI assessment standards in QEHS projects.
Risk Meter	Optional visual bar: Low → Red, Marginal → Orange, Good → Blue, Excellent → Green	Intuitive safety ROI visualization.
Edge Warnings	Extremely high E → “⚠️ Using high-value accident costs”	Prevents misinterpretation of inflated SI values.
-->