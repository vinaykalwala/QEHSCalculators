{% extends 'base.html' %}
{% block title %}Time of Death Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time of Death Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
            justify-content: center;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .input-group {
            display: flex;
            gap: 10px;
        }
        .input-group .form-input {
            flex: 2;
        }
        .input-group .form-select {
            flex: 1;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        .rate-label {
            color: #2980b9;
            font-weight: bold;
            font-size: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li, .note-card ol {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        .custom-table {
            border-collapse: collapse; width: 100%;
            margin: 20px 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .custom-table thead { background-color: #1560bd; color: white; }
        .custom-table th, .custom-table td {
            padding: 12px 16px; border: 1px solid #ddd; text-align: left;
        }
        .custom-table tr:nth-child(even) { background-color: #f9f9f9; }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon { font-size: 76px; flex-shrink: 0; text-align: center; }
        .error-message { font-size: 24px; line-height: 1.6; }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Time Of Death Calculator</h1>
            <p>Estimate the postmortem interval based on algor mortis (body cooling).</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Forensic Data</h2>
                <div class="form-group">
                    <label for="bodyTemp">Rectal Body Temperature</label>
                    <div class="input-group">
                        <input type="number" id="bodyTemp" class="form-input" placeholder="e.g., 27.0" step="0.1">
                        <select id="bodyUnit" class="form-select">
                            <option value="C">°C</option>
                            <option value="F">°F</option>
                            <option value="K">K</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="ambientTemp">Ambient Temperature</label>
                    <div class="input-group">
                        <input type="number" id="ambientTemp" class="form-input" placeholder="e.g., 22.0" step="0.1">
                        <select id="ambientUnit" class="form-select">
                            <option value="C">°C</option>
                            <option value="F">°F</option>
                            <option value="K">K</option>
                        </select>
                    </div>
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Estimate Time Since Death</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Health illustration">
                    <p>Enter the body and ambient temperatures to estimate the time since death.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>Time Since Death</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.0</div>
                        <div class="rate-label">hours</div>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Details</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                     <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
        
            <!-- About Algor Mortis -->
            <div class="note-card">
        <h3>📘 About This Calculator</h3>
                <p>
                    This calculator estimates the time since death using the principle of <strong>algor mortis</strong>,
                    which is the postmortem cooling of the body. The cooling rate is influenced by the difference
                    between the body’s temperature at death (approx. 37°C) and the ambient temperature of the surroundings.
                </p>
            </div>
            <div class="note-card">
        <h3>📐 Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>Ambient Temperature:</strong> Temperature of the surroundings (°C, °F, or K; converted
                        internally to °C).</li>
                    <li><strong>Body Temperature:</strong> Rectal temperature of the deceased (°C, °F, or K; converted
                        internally to °C).</li>
                </ul>
                <p>Results are calculated in hours. Reverse calculations are supported for scenario analysis.</p>
            </div>
             <div class="note-card">
                <h3>📝 Input Validations</h3>
                <ul class="note-list">
                    <li><strong>Body Temperature:</strong> Required field. Must be a number. Acceptable range:
                        <ul style="list-style-type: circle; padding-left:20px;">
                            <li>Celsius: 15°C – 37°C</li>
                            <li>Fahrenheit: 59°F – 98.6°F</li>
                            <li>Kelvin: 288.15K – 310.15K</li>
                        </ul>
                        Must be below normal living temperature (37°C / 98.6°F / 310.15K) for postmortem estimation.
                    </li>
                    <li><strong>Ambient Temperature:</strong> Required field. Must be a number. Acceptable range:
                        <ul style="list-style-type: circle; padding-left:20px;">
                            <li>Celsius: -10°C – 50°C</li>
                            <li>Fahrenheit: 14°F – 122°F</li>
                            <li>Kelvin: 263.15K – 323.15K</li>
                        </ul>
                        Represents environmental temperature where the body was found.
                    </li>
                    <li><strong>Units:</strong> Select the correct unit for both body and ambient temperatures (°C, °F, or K).</li>
                    <li><strong>Logical Consistency:</strong> Body temperature must always be lower than normal body temp (37°C) to calculate time since death.</li>
                    <li><strong>Edge Cases:</strong>
                        <ul class="note-list">
                            <li>Non-numeric inputs → error</li>
                            <li>Empty fields → error</li>
                            <li>Unrealistic body temp (&gt;37°C) → error</li>
                            <li>Extreme ambient temp (&lt; -10°C or &gt; 50°C) → warning</li>
                        </ul>
                    </li>
                    <li><strong>Rationale:</strong> Ensures scientifically valid postmortem time estimations and avoids biologically impossible or misleading results.</li>
                </ul>
            </div>
            <div class="note-card">
    <h3>📊 Output Validations</h3>
    <ul class="note-list">
        <li>✅ <strong>0–12 hours:</strong> Recent death; postmortem interval is short.</li>
        <li>⏳ <strong>12–24 hours:</strong> Death occurred within the past day; standard accuracy applies.</li>
        <li>⚠️ <strong>>24 hours:</strong> Extended postmortem interval; accuracy may vary due to environmental or physiological factors such as body fat, clothing, humidity, and wind.</li>
        <li>❌ Negative values → Invalid. Body temperature higher than normal living temperature; likely input error.</li>
        <li>Extreme values (>72h) → Warn user of possible deviation due to environmental or physiological influences.</li>
        <li>Units must be correctly selected (°C, °F, K) for both body and ambient temperatures.</li>
        <li>Body temperature must be below normal living temperature (37°C / 98.6°F) for valid estimation.</li>
    </ul>
</div>
<div class="note-card">
    <h3>📏 Governing Principle</h3>
    <p>
        The estimation of <strong>time since death</strong> is based on internationally recognized forensic rules, regulations, 
        and standards, including ISO 17020, local medico-legal guidelines, and forensic pathology best practices.
        The principle primarily relies on <strong>algor mortis</strong>—postmortem cooling of the body—and considers environmental 
        influences such as ambient temperature, humidity, and clothing.
    </p>
    <p>
        Consistent measurement of rectal body temperature and ambient conditions, combined with standardized calculations, 
        ensures scientifically valid and comparable postmortem interval estimates. Investigators should always verify input 
        ranges and logical consistency to maintain reliability.
    </p>
</div>
            <!-- Estimating Time with Rigor Mortis -->
            <div class="note-card">
                <h3>Estimating Time with Rigor Mortis</h3>
                <p>
                    Forensic investigators also consider <strong>rigor mortis</strong> (postmortem muscle stiffening) as a
                    secondary indicator.
                    The following table provides a general timeline:
                </p>
                <div style="overflow-x:auto;">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Body Condition</th>
                                <th>Muscle Stiffness</th>
                                <th>Estimated Time Since Death</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Warm</td>
                                <td>Flexible</td>
                                <td>Less than 2 hours</td>
                            </tr>
                            <tr>
                                <td>Warm</td>
                                <td>Rigid</td>
                                <td>Between 2 and 8 hours</td>
                            </tr>
                            <tr>
                                <td>Cold</td>
                                <td>Rigid</td>
                                <td>Between 8 and 36 hours</td>
                            </tr>
                            <tr>
                                <td>Cold</td>
                                <td>Flexible</td>
                                <td>More than 36 hours</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p><strong>Note:</strong> If a hand is gripping something tightly (e.g., a weapon), it may suggest the item was
                    placed postmortem.</p>
            </div>
        
            <!-- Other Considerations & Methods -->
            <div class="note-card">
                <h3>Additional Methods and Considerations</h3>
                <ul class="note-list">
                    <li>Neuromuscular response to stimuli.</li>
                    <li>Tissue drying (e.g., lips, eyes).</li>
                    <li>Livor Mortis – skin discoloration due to blood pooling.</li>
                    <li>Odor and bloating during decomposition.</li>
                </ul>
                <ol class="note-list">
                    <li>Pallor Mortis – pale skin.</li>
                    <li>Algor Mortis – cooling of the body.</li>
                    <li>Rigor Mortis – muscle stiffening.</li>
                    <li>Livor Mortis – blood pooling.</li>
                    <li>Putrefaction – onset of decomposition.</li>
                    <li>Decomposition – breakdown of soft tissues.</li>
                    <li>Skeletonization – final stage.</li>
                </ol>
                <p><strong>CPR Window:</strong> May be effective within 4–6 minutes post-death; extended in hypothermia cases
                    until body warms to 32°C (89.6°F).</p>
            </div>
        
           
            <!-- Disclaimer -->
            <div class="note-card">
                <h3>⚠️ Disclaimer</h3>
                <p>
                    This tool is for educational and informational purposes only. The actual determination of time of death is a
                    complex forensic science
                    involving many factors beyond temperature and stiffness. This calculator provides a simplified estimate and
                    should not be used
                    for legal, official, or medical purposes.
                </p>
            </div>
        <div class="note-card">
    <h3>📌 Conclusion</h3>
    <p>
        This calculator provides a scientifically informed estimate of the postmortem interval using body cooling principles.
        The results serve as a guideline for forensic investigation but should not replace comprehensive medico-legal assessment.
        Always consider additional indicators such as <strong>rigor mortis</strong>, <strong>livor mortis</strong>, tissue condition, 
        and environmental factors to corroborate findings.
    </p>
    <p>
        Following standardized rules, regulations, and output validation criteria ensures reliability and supports effective 
        forensic decision-making.
    </p>
</div>
        </div>

    </div>

    <script>
        function calculateAndDisplay() {
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');

            // Reset UI
            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');

            let errors = [];

            // Input validation helper
            function getVal(id, label, min, max) {
                const el = document.getElementById(id);
                const raw = el.value?.trim();
                if (!raw) {
                    errors.push(`👉 ${label} is required.`);
                    return null;
                }
                const num = parseFloat(raw);
                if (isNaN(num)) {
                    errors.push(`👉 Enter a valid number for ${label}.`);
                    return null;
                }
                if (num < min || num > max) {
                    errors.push(`👉 ${label} must be between ${min} and ${max}.`);
                    return null;
                }
                return num;
            }

            // Temperature conversion helper
            function toCelsius(temp, unit) {
                if (unit === "F") return (temp - 32) * 5 / 9;
                if (unit === "K") return temp - 273.15;
                return temp; // already in Celsius
            }

            // Fetch and validate inputs
            const bodyTemp = getVal('bodyTemp', 'Body Temperature', 15, 37);
            const ambientTemp = getVal('ambientTemp', 'Ambient Temperature', -10, 50);
            const bodyUnit = document.getElementById('bodyUnit').value;
            const ambientUnit = document.getElementById('ambientUnit').value;

            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }

            // Convert inputs to Celsius
            const bodyTempC = toCelsius(bodyTemp, bodyUnit);
            const ambientTempC = toCelsius(ambientTemp, ambientUnit);
            const normalBodyTempC = 37.0;

            if (bodyTempC >= normalBodyTempC) {
                errorMessage.innerHTML = `❌Rectal Body Temperature must be below normal living temp (37°C / 98.6°F).`;
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }

            // Time of Death Calculation
            const tempDifference = normalBodyTempC - bodyTempC;
            const T_factor = ambientTempC < 0 ? 0.83 : 0.42;
            const hoursSinceDeath = tempDifference / T_factor;

            placeholder.classList.add('hidden');
            resultValueBox.classList.remove('hidden');

            document.getElementById('rateValue').textContent = hoursSinceDeath.toFixed(2);

            // Feedback with clear forensic context
            let interpretation = "";
            if (hoursSinceDeath <= 12) interpretation = "🕒 Recent death; postmortem interval is short.";
            else if (hoursSinceDeath <= 24) interpretation = "⏳ Death occurred within the past day; standard accuracy applies.";
            else interpretation = "⚠️  Extended postmortem interval; accuracy may vary due to environmental or physiological factors such as body fat, clothing, humidity, and wind.";

            document.getElementById('feedbackContent').innerHTML = `
            ${interpretation}<br>
            🔹 Calculated using body cooling factor <strong>${T_factor}</strong>, based on ambient temperature <strong>${ambientTempC.toFixed(1)}°C</strong>.
        `;
        }

        function printReport() {
            window.print();
        }
    </script>

</body>
</html>
{% endblock %}

<!-- 
Input Validation Rules (Based on QEHS / Forensic Standards)
Input	Allowed Range	Units	Notes / Reason
Body Temperature	15°C – 37°C
59°F – 98.6°F
288.15K – 310.15K	°C / °F / K	Postmortem body temperature must be below normal living temp. Higher values indicate invalid entry or live patient.
Ambient Temperature	-10°C – 50°C
14°F – 122°F
263.15K – 323.15K	°C / °F / K	Ensure realistic environmental temperatures. Extreme values can distort time-of-death estimates.
Decimal Precision	Up to 1-2 decimal places	°C / °F / K	Allows practical forensic readings.
Required Fields	Both inputs mandatory	—	Calculation cannot proceed with missing values.
Logical Consistency	Body Temp < Normal 37°C	—	Prevents negative postmortem temperature differences or biologically impossible scenarios.
2️⃣ Output Validation Logic & Threshold Explanation

Formula Used:

Time Since Death (hours)
=
Normal Body Temp (37°C) – Measured Body Temp
𝑇
Time Since Death (hours)=
T
Normal Body Temp (37°C) – Measured Body Temp
	​


Where T factor accounts for ambient temperature influence:

T = 0.83 if ambient < 0°C (slower cooling)

T = 0.42 if ambient ≥ 0°C (faster cooling)

Validation of Output:

Negative values → Invalid; indicates body warmer than normal (likely input error)

Extremely high (>72h) → Warn user of possible deviation due to environmental or physiological factors (clothing, humidity, body fat, wind, etc.)

Interpretation Ranges:

0–12h → Recent death

12–24h → Within a day

24h → Extended postmortem interval; caution for accuracy

3️⃣ Edge Case Validations
-->