{% extends 'base.html' %}
{% block title %}Shock Index (SI) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shock Index (SI) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0 10px;
            overflow: hidden;
        }
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out, background-color 1s ease-in-out;
            border-radius: 6px;
        }
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon { font-size: 76px; flex-shrink: 0; text-align: center; }
        .error-message { font-size: 24px; line-height: 1.6; }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Shock Index (SI) Calculator</h1>
            <p>Quickly assess a patient's cardiovascular stability and risk of shock.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Patient Vitals</h2>
                <div class="form-group">
                    <label for="heartRate">Heart Rate (HR)</label>
                    <input type="number" id="heartRate" class="form-input" placeholder="Enter beats per minute">
                </div>
                <div class="form-group">
                    <label for="systolicBP">Systolic Blood Pressure (SBP)</label>
                    <input type="number" id="systolicBP" class="form-input" placeholder="Enter mmHg">
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate Shock Index</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Health illustration">
                    <p>Enter Heart Rate and Systolic BP to calculate the Shock Index.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>Shock Index (SI)</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                    </div>
                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Normal</span>
                        <span>Warning</span>
                        <span>Critical</span>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Interpretation</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>About the Shock Index (SI)</h3>
                <p>
                    The <strong>Shock Index (SI)</strong> is a simple and effective indicator used in
                    emergency and critical care settings to quickly assess a patient‚Äôs cardiovascular condition.
                    It is calculated as <strong>Heart Rate (HR) √∑ Systolic Blood Pressure (SBP)</strong>.
                    A rising SI can be an early warning sign of hemodynamic instability,
                    often appearing before a significant drop in blood pressure.
                </p>
            </div>
        
            <div class="note-card">
                <h3>Explanation of Parameters</h3>
                <ul class="note-list">
                    <li><strong>Heart Rate (HR):</strong> Beats per minute. An elevated HR may indicate stress, dehydration,
                        blood loss, or underlying conditions.</li>
                    <li><strong>Systolic Blood Pressure (SBP):</strong> The peak arterial pressure during heart contraction. A
                        low SBP may suggest inadequate blood flow, critical in trauma or shock cases.</li>
                </ul>
            </div>
        
            <div class="note-card">
                <h3>Use of the Calculator</h3>
                <p>
                    This calculator allows users to input the patient‚Äôs HR and SBP to determine the Shock Index.
                    It helps medical professionals identify whether circulation is functioning normally or under distress.
                    It is especially valuable in <em>trauma, emergency, and pre-hospital settings</em>.
                </p>
            </div>
        
            <div class="note-card">
                <h3>Result Interpretation</h3>
                <ul class="note-list">
                    <li><strong>SI &lt; 0.7:</strong> Normal ‚Äî Stable circulation.</li>
                    <li><strong>SI 0.7 ‚Äì 1.0:</strong> Caution ‚Äî Early circulatory imbalance possible; monitoring advised.</li>
                    <li><strong>SI &gt; 1.0:</strong> Critical ‚Äî Suggests circulatory failure; urgent intervention required.
                    </li>
                </ul>
            </div>
        
            <div class="note-card">
                <h3>‚ÑπÔ∏è Input Validation Rules</h3>
                <div class="note-section">
                    <ul>
                        <li><strong>Heart Rate (HR):</strong> Must be between <b>30‚Äì220 bpm</b>. 
                            <br>üëâ Below 30 bpm = unlikely for a conscious patient. 
                            <br>üëâ Above 220 bpm = physiologically unrealistic.
                        </li>
                        <li><strong>Systolic Blood Pressure (SBP):</strong> Must be between <b>50‚Äì250 mmHg</b>. 
                            <br>üëâ Below 50 mmHg = shock/cardiac arrest zone. 
                            <br>üëâ Above 250 mmHg = extremely rare and usually erroneous.
                        </li>
                        <li><strong>Cross-field checks:</strong> 
                            <br>üëâ HR < 40 & SBP < 70 = near cardiac arrest ‚Äî double-check values.  
                            <br>üëâ HR > 180 & SBP < 60 = possible measurement error.
                        </li>
                        <li><strong>No zero or negative values:</strong> Both HR and SBP must be positive numbers.</li>
                        <li><strong>Decimals:</strong> Allowed up to 1 decimal place (e.g., 72.5 bpm), but values must remain within safe ranges.</li>
                        <li><strong>Units reminder:</strong> 
                            <br>HR = Beats per minute (bpm)  
                            <br>SBP = Millimeters of mercury (mmHg)
                        </li>
                    </ul>
                </div>
            </div>

            <div class="note-card">
                <h3>Clinical Importance</h3>
                <p>
                    The Shock Index is a valuable early-warning tool that helps detect cardiovascular compromise
                    before severe symptoms develop. By using this calculator, healthcare providers can make
                    quicker, more informed decisions, implement interventions sooner, and improve patient outcomes
                    in high-risk or emergency situations.
                </p>
            </div>
        </div>

    </div>

    <script>
        function calculateAndDisplay() {
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');

            // Reset UI
            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');

            let errors = [];

            // Generic value getter with validations
            function getVal(id, label, opts = {}) {
                const el = document.getElementById(id);
                const raw = el.value?.toString().trim();

                if (!raw) {
                    errors.push(`üëâ ${label} is required.`);
                    return null;
                }

                const num = parseFloat(raw);

                if (isNaN(num) || num <= 0) {
                    errors.push(`üëâ Enter a valid positive number for ${label}.`);
                    return null;
                }

                // Range validations
                if (opts.min !== undefined && num < opts.min) {
                    errors.push(`üëâ ${label} must be ‚â• ${opts.min} ${opts.unit || ''}.`);
                }
                if (opts.max !== undefined && num > opts.max) {
                    errors.push(`üëâ ${label} must be ‚â§ ${opts.max} ${opts.unit || ''}.`);
                }

                return num;
            }

            // Input validations with real-world ranges
            const hr = getVal('heartRate', 'Heart Rate (HR)', { min: 30, max: 220, unit: "bpm" });
            const sbp = getVal('systolicBP', 'Systolic Blood Pressure (SBP)', { min: 50, max: 250, unit: "mmHg" });

            // Cross-field validation
            if (sbp !== null && hr !== null) {
                if (sbp < 70 && hr < 40) {
                    errors.push("üëâ Inputs suggest near-cardiac arrest. Please verify values.");
                }
                if (sbp < 60 && hr > 180) {
                    errors.push("üëâ Inputs indicate possible measurement error (very high HR with extremely low BP).");
                }
            }

            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }

            // Prevent division by zero
            if (sbp === 0) {
                errorMessage.innerHTML = "üëâ Systolic BP cannot be zero (division by zero error).";
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }

            // Calculate Shock Index
            const si = hr / sbp;

            placeholder.classList.add('hidden');
            resultValueBox.classList.remove('hidden');

            document.getElementById('rateValue').textContent = si.toFixed(2);

            // Meter logic
            const meterFill = document.getElementById('meterFill');
            const minSI = 0.4;
            const maxSI = 1.4;
            let pct = ((si - minSI) / (maxSI - minSI)) * 100;
            pct = Math.max(0, Math.min(100, pct));
            meterFill.style.width = pct + '%';

            // Interpretation
            let interpretation;
            if (si < 0.7) {
                meterFill.style.backgroundColor = '#2ecc71'; // Green
                interpretation = "‚úÖ <strong>Normal:</strong> Circulatory status appears stable.";
            } else if (si <= 1.0) {
                meterFill.style.backgroundColor = '#f39c12'; // Yellow
                interpretation = "‚ö†Ô∏è <strong>Warning Zone:</strong> Monitor closely. May be an early sign of circulatory compromise.";
            } else {
                meterFill.style.backgroundColor = '#e74c3c'; // Red
                interpretation = "üö® <strong>Critical:</strong> Suggests possible circulatory failure. Immediate medical evaluation needed!";
            }

            document.getElementById('feedbackContent').innerHTML = interpretation;
        }

        function printReport() {
            window.print();
        }
    </script>

</body>
</html>
{% endblock %}

<!-- 
1. Input Validation Rules (Industry Standards)

For Shock Index (SI = HR / SBP) the input values must reflect medically realistic human physiology, occupational exposure conditions, and compliance with health & safety reporting norms:

Heart Rate (HR ‚Äì beats per minute, bpm)

Unit: bpm (beats per minute).

Range:

Minimum: 30 bpm (anything lower is extreme bradycardia or input error).

Maximum: 220 bpm (above this is physiologically incompatible with sustained life).

Decimals: Not allowed (HR is an integer).

Systolic Blood Pressure (SBP ‚Äì mmHg)

Unit: mmHg.

Range:

Minimum: 50 mmHg (below this ‚Üí shock/extreme hypotension, calculator should flag as critical).

Maximum: 250 mmHg (beyond this ‚Üí likely error or incorrect unit).

Decimals: Allowed but should be rounded to 1 decimal place.

Cross-field Dependencies

SI = HR / SBP.

SBP cannot be 0 (division by zero).

HR should not exceed SBP √ó 3 (to prevent unrealistic SI values > 3, which would indicate erroneous input).

2. Output Validation Logic & Thresholds

Standard clinical cut-offs adapted for workplace safety / emergency preparedness (OSHA, ILO, ISO 45001):

SI < 0.7 ‚Üí Normal
Circulatory status stable. Safe to continue work.

0.7 ‚â§ SI ‚â§ 1.0 ‚Üí Warning Zone
Potential circulatory compromise. Monitor, restrict strenuous work.

SI > 1.0 ‚Üí Critical
Strong indicator of hypovolemic or distributive shock. Immediate emergency response required.

Optional (edge handling):

SI ‚â• 2.0 ‚Üí Unrealistic/Extreme (flag as likely data entry error or life-threatening).

3. Edge Case Validations

SBP = 0 or negative ‚Üí Block and show error.

HR or SBP blank ‚Üí Block and show error.

HR < 30 or HR > 220 ‚Üí Warn user (outlier).

SBP < 50 or SBP > 250 ‚Üí Warn user (unrealistic).

SI < 0.3 or SI > 2.0 ‚Üí Flag as extreme/unrealistic; instruct verification.

4. Why Validations Are Essential

Compliance (OSHA/ISO 45001): Prevents wrong inputs from corrupting workplace medical records.

Emergency Readiness (NFPA): Ensures only medically plausible values are considered in fire/accident incidents.

Worker Safety (ILO standards): Avoids underestimating circulatory collapse risk in high-heat or confined-space jobs.
-->