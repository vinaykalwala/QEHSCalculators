{% extends 'base.html' %}
{% block title %}Winters' Formula Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winters' Formula Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            justify-content: center;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        .rate-label {
            color: #2980b9;
            font-weight: bold;
            font-size: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        .custom-table {
            border-collapse: collapse; width: 100%;
            margin: 20px 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .custom-table thead { background-color: #1560bd; color: white; }
        .custom-table th, .custom-table td {
            padding: 12px 16px; border: 1px solid #ddd; text-align: left;
        }
        .custom-table tr:nth-child(even) { background-color: #f9f9f9; }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon { font-size: 76px; flex-shrink: 0; text-align: center; }
        .error-message { font-size: 24px; line-height: 1.6; }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Winters' Formula Calculator</h1>
            <p>Assess respiratory compensation in metabolic acidosis.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Patient Data</h2>
                <div class="form-group">
                    <label for="hco3">HCO‚ÇÉ‚Åª (Bicarbonate) Concentration (mmol/L)</label>
                    <input type="number" id="hco3" class="form-input" placeholder="e.g., 18" step="0.1">
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate pCO‚ÇÇ Range</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Health illustration">
                    <p>Enter the patient's bicarbonate level to calculate the expected pCO‚ÇÇ.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>Expected pCO‚ÇÇ (Center)</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.0</div>
                        <div class="rate-label">mmHg</div>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                     <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <!-- About Winters' Formula -->
            <div class="note-card">
        <h3>üìò About This Calculator</h3>
                <p>
                    Winters' Formula is a clinical tool used to determine the expected respiratory compensation in patients with
                    <strong>metabolic acidosis</strong>. By calculating the expected partial pressure of carbon dioxide (pCO‚ÇÇ),
                    clinicians can assess whether the patient's respiratory system is responding appropriately to the metabolic
                    disturbance.
                </p>
            </div>
            <div class="note-card">
        <h3>üìê Parameters Used</h3>
    <p><strong>Bicarbonate (HCO‚ÇÉ‚Åª):</strong> Blood bicarbonate level in mmol/L. This value is used to calculate the expected pCO‚ÇÇ in metabolic acidosis using Winters' Formula.</p>
</div>

         <div class="note-card">
        <h3>‚ö†Ô∏è Input Validation Rules</h3>
                    <ul class="note-list">
                        <li><strong>Bicarbonate (HCO‚ÇÉ‚Åª) Concentration:</strong> Enter the patient's HCO‚ÇÉ‚Åª level in
                            <strong>mmol/L</strong>.</li>
                        <li>‚úÖ Must be a <strong>positive number</strong>.</li>
                        <li>‚ö†Ô∏è Physiological range for adults: <strong>12 ‚Äì 40 mmol/L</strong>. Values outside this range may give
                            inaccurate predictions.</li>
                        <li>üî¢ Maximum allowed: <strong>1 decimal place</strong> (e.g., 24.5).</li>
                        <li>‚ùå Cannot be left blank. Input is required for calculation.</li>
                        <li>‚öñÔ∏è Input must be numeric; letters or symbols are not allowed.</li>
                        <li>üìä Extreme outliers (e.g., HCO‚ÇÉ‚Åª < 5 or> 50 mmol/L) are flagged as unrealistic and should be
                                double-checked with lab results.</li>
                        <li>üí° Validation ensures accurate calculation of expected pCO‚ÇÇ range and prevents misleading outputs.</li>
                    </ul>
                    <p><em>Tip:</em> Use this guidance to ensure that the calculator gives reliable clinical insights for patient
                        safety assessment.</p>
            </div>
            <div class="note-card">
    <h3>üìä Output Validations</h3>
    <p>Physiological plausibility check for center pCO‚ÇÇ:</p>
    <ul class="note-list">
        <li>‚ö†Ô∏è Center pCO‚ÇÇ < 20 mmHg: Unusually low CO‚ÇÇ; may indicate overcompensation or severe metabolic acidosis. Review patient status and lab results.</li>
        <li>‚ö†Ô∏è Center pCO‚ÇÇ > 50 mmHg: Unusually high CO‚ÇÇ; may indicate undercompensation or mixed acid-base disorder. Further evaluation required.</li>
        <li>‚úÖ Center pCO‚ÇÇ is within the normal physiological range (20‚Äì50 mmHg), indicating appropriate respiratory compensation.</li>
    </ul>
</div>

<div class="note-card">
    <h3>üìè Governing Principle</h3>
    <p>
        Winters' Formula is based on established clinical and physiological standards for respiratory compensation in metabolic acidosis. 
        The calculation uses <strong>HCO‚ÇÉ‚Åª (bicarbonate) concentration</strong> to estimate the expected pCO‚ÇÇ, providing a reference range to 
        assess whether the respiratory response is adequate.
    </p>
    <ul class="note-list">
        <li>üìö <strong>Standard Reference:</strong> Clinical acid-base physiology as described in <em>Ganong's Review of Medical Physiology</em> and 
        <em>Bates' Guide to Physical Examination and History Taking</em>.</li>
        <li>‚öñÔ∏è <strong>Physiological Basis:</strong> Expected pCO‚ÇÇ = 1.5 √ó HCO‚ÇÉ‚Åª + 8 ¬± 2 mmHg. Ensures proper assessment of respiratory compensation.</li>
        <li>‚úÖ <strong>Adult HCO‚ÇÉ‚Åª Range:</strong> 22‚Äì26 mmol/L normal; validated range for calculation: 12‚Äì40 mmol/L.</li>
        <li>üîß <strong>Validation Rules:</strong>
            <ul>
                <li>Must be numeric and positive.</li>
                <li>Maximum 1 decimal place.</li>
                <li>Values outside physiological range are flagged as unrealistic.</li>
            </ul>
        </li>
        <li>üåê <strong>Regulatory / Clinical Guidance:</strong> Follow local hospital protocols, laboratory standards, and general clinical guidelines for acid-base assessment (e.g., CPOE validation rules, ISO 15189 for lab measurements, or national health authority recommendations).</li>
        <li>üí° <strong>Important:</strong> This calculator provides estimates; clinical judgment should guide diagnosis and management.</li>
    </ul>
</div>

            <!-- Why It‚Äôs Used -->
            <div class="note-card">
                <h3>Why Use Winters' Formula?</h3>
                <ul class="note-list">
                    <li><strong>Detect inadequate compensation:</strong> Indicates possible <em>respiratory acidosis</em>.</li>
                    <li><strong>Detect overcompensation:</strong> Suggests <em>respiratory alkalosis</em> or mixed acid-base
                        disorder.</li>
                    <li><strong>Evaluate patient stability:</strong> Helps guide further treatment or diagnostic decisions.</li>
                </ul>
            </div>
        
            <!-- How to Use -->
            <div class="note-card">
                <h3>How to Use the Calculator</h3>
                <p>To calculate the expected pCO‚ÇÇ range, simply enter:</p>
                <ul class="note-list">
                    <li><strong>Bicarbonate (HCO‚ÇÉ‚Åª) concentration:</strong> In mmol/L (normal: 22‚Äì26 mmol/L). HCO‚ÇÉ‚Åª is an
                        essential buffer that regulates the body‚Äôs acid-base balance and is measured via blood test.</li>
                </ul>
                <p>The result will provide an estimated pCO‚ÇÇ range in <strong>mmHg</strong> (default) or <strong>kPa</strong>,
                    depending on your selection.</p>
            </div>
        
            <!-- Parameter Breakdown -->
            <div class="note-card">
                <h3>Parameter Breakdown</h3>
                <div style="overflow-x:auto;">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Symbol</th>
                                <th>Normal Range</th>
                                <th>Units</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Bicarbonate</td>
                                <td>HCO‚ÇÉ‚Åª</td>
                                <td>22‚Äì26</td>
                                <td>mmol/L</td>
                                <td>Buffer that resists pH changes in blood.</td>
                            </tr>
                            <tr>
                                <td>Carbon Dioxide (Partial Pressure)</td>
                                <td>pCO‚ÇÇ</td>
                                <td>35‚Äì45</td>
                                <td>mmHg</td>
                                <td>Reflects respiratory function and acid load.</td>
                            </tr>
                            <tr>
                                <td>Hydrogen Ion Concentration</td>
                                <td>[H‚Å∫]</td>
                                <td>35‚Äì45</td>
                                <td>nmol/L</td>
                                <td>Determines blood acidity (pH).</td>
                            </tr>
                            <tr>
                                <td>Blood pH</td>
                                <td>pH</td>
                                <td>7.35‚Äì7.45</td>
                                <td>-</td>
                                <td>Measures overall acid-base status.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        
           
        
            <!-- Background Physiology -->
            <div class="note-card">
                <h3>Background Physiology</h3>
                <p>
                    The body maintains acid-base balance using buffers (mainly the bicarbonate buffer system), lungs, and
                    kidneys.
                    Disruptions lead to metabolic or respiratory acidosis/alkalosis.
                </p>
                <div style="overflow-x:auto;">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Disorder</th>
                                <th>Key Change</th>
                                <th>Effect on [H‚Å∫]</th>
                                <th>Effect on pH</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Respiratory Acidosis</td>
                                <td>‚Üë pCO‚ÇÇ</td>
                                <td>‚Üë [H‚Å∫]</td>
                                <td>‚Üì pH</td>
                            </tr>
                            <tr>
                                <td>Metabolic Acidosis</td>
                                <td>‚Üì HCO‚ÇÉ‚Åª</td>
                                <td>‚Üë [H‚Å∫]</td>
                                <td>‚Üì pH</td>
                            </tr>
                            <tr>
                                <td>Respiratory Alkalosis</td>
                                <td>‚Üì pCO‚ÇÇ</td>
                                <td>‚Üì [H‚Å∫]</td>
                                <td>‚Üë pH</td>
                            </tr>
                            <tr>
                                <td>Metabolic Alkalosis</td>
                                <td>‚Üë HCO‚ÇÉ‚Åª</td>
                                <td>‚Üì [H‚Å∫]</td>
                                <td>‚Üë pH</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        
            <!-- Additional Notes -->
            <div class="note-card">
                <h3>Additional Notes</h3>
                <ul class="note-list">
                    <li><strong>Important:</strong> This formula is only applicable in metabolic acidosis with normal
                        respiratory physiology.</li>
                    <li><strong>Mixed Disorders:</strong> Suspect when values fall outside the expected range.</li>
                    <li><strong>Use Alongside:</strong> Blood pH, anion gap, and clinical history for full interpretation.</li>
                </ul>
            </div>
        
           
            <!-- Disclaimer -->
            <div class="note-card">
                <h3>‚ö†Ô∏è Disclaimer</h3>
                <p>This tool provides clinical estimates only. It is intended for use by healthcare professionals and is not a
                    replacement for professional medical judgment or a complete acid-base analysis.</p>
            </div>
            <!-- Conclusion -->
<div class="note-card">
    <h3>üìå Conclusion</h3>
    <p>
        The expected pCO‚ÇÇ range calculated using Winters' Formula provides insight into whether the patient's respiratory system is compensating appropriately for metabolic acidosis. Compare the measured pCO‚ÇÇ with this range to assess adequacy of respiratory compensation.
    </p>
</div>

        </div>

    </div>

   <script>
    function calculateAndDisplay() {
        const errorBox = document.getElementById('resultError');
        const errorMessage = document.getElementById('errorMessage');
        const placeholder = document.getElementById('placeholder');
        const resultValueBox = document.getElementById('resultValue');
        const rateValue = document.getElementById('rateValue');
        const feedbackContent = document.getElementById('feedbackContent');

        // Reset UI
        errorBox.classList.add('hidden');
        resultValueBox.classList.add('hidden');
        placeholder.classList.remove('hidden');

        let errors = [];

        // Validation helper
        function getValidatedValue(id, label, min, max) {
            const el = document.getElementById(id);
            const raw = el.value?.toString().trim();

            if (!raw) {
                errors.push(`üëâ ${label} is required.`);
                return null;
            }

            const num = parseFloat(raw);

            if (isNaN(num) || num <= 0) {
                errors.push(`üëâ Enter a valid positive number for ${label}.`);
                return null;
            }

            if (num < min || num > max) {
                errors.push(`‚ö†Ô∏è ${label} should be between ${min} and ${max} mmol/L for adults.`);
            }

            // Restrict to max 1 decimal place
            if (!/^\d+(\.\d{1})?$/.test(raw)) {
                errors.push(`üëâ ${label} must have at most 1 decimal place.`);
            }

            // Extreme outliers check
            if (num < 5 || num > 50) {
                errors.push(`‚ùå ${label} is an extreme value. Please verify lab results.`);
            }

            return num;
        }

        // Validate HCO3 input
        const hco3 = getValidatedValue('hco3', 'Bicarbonate (HCO‚ÇÉ‚Åª)', 12, 40);

        if (errors.length > 0) {
            errorMessage.innerHTML = errors.join("<br>");
            errorBox.classList.remove('hidden');
            placeholder.classList.add('hidden');
            return;
        }

        // Calculate Winters' Formula
        const expectedPCO2 = 1.5 * hco3 + 8;
        const lowerLimit = expectedPCO2 - 2;
        const upperLimit = expectedPCO2 + 2;

        // Physiological plausibility check
        let clinicalWarning = '';
if (expectedPCO2 < 20) {
    clinicalWarning = '‚ö†Ô∏è Center pCO‚ÇÇ < 20 mmHg: Unusually low CO‚ÇÇ; may indicate overcompensation or severe metabolic acidosis. Review patient status and lab results.';
} else if (expectedPCO2 > 50) {
    clinicalWarning = '‚ö†Ô∏è Center pCO‚ÇÇ > 50 mmHg: Unusually high CO‚ÇÇ; may indicate undercompensation or mixed acid-base disorder. Further evaluation required.';
} else {
    clinicalWarning = '‚úÖ Center pCO‚ÇÇ is within the normal physiological range (20‚Äì50 mmHg), indicating appropriate respiratory compensation.';
}


        // Display results
        placeholder.classList.add('hidden');
        resultValueBox.classList.remove('hidden');
        rateValue.textContent = expectedPCO2.toFixed(1);

        feedbackContent.innerHTML = `
            üß™ <strong>Expected pCO‚ÇÇ Range:</strong> ${lowerLimit.toFixed(1)} ‚Äì ${upperLimit.toFixed(1)} mmHg
            <br><small>(Equivalent to ${(lowerLimit / 7.5).toFixed(2)} ‚Äì ${(upperLimit / 7.5).toFixed(2)} kPa)</small>
            <br><small>‚ö†Ô∏è Ensure the HCO‚ÇÉ‚Åª input is within physiological range (12‚Äì40 mmol/L) for accurate interpretation.</small>
            ${clinicalWarning ? '<br>' + clinicalWarning : ''}
        `;
    }

    function printReport() {
        window.print();
    }
</script>


</body>
</html>
{% endblock %}

<!-- 
Analysis of Inputs & Outputs

Input:

HCO‚ÇÉ‚Åª (Bicarbonate) Concentration (mmol/L)

Typical adult reference range: 22‚Äì28 mmol/L

Critical low: <12 mmol/L, Critical high: >40 mmol/L

Must be a numeric positive value with at most 1 decimal place.

Output:

Expected pCO‚ÇÇ (mmHg and kPa) calculated using Winters‚Äô formula:

Center = 1.5 √ó HCO‚ÇÉ‚Åª + 8

Expected range = ¬±2 mmHg

Output should be meaningful for clinical interpretation and physiologically plausible.

2Ô∏è‚É£ Input Validation Rules
Field	Type	Allowed Range	Decimal Precision	Additional Checks
HCO‚ÇÉ‚Åª	number	12 ‚Äì 40 mmol/L (adult)	1 decimal	Must be >0, realistic for human physiology

Cross-field / logical validation:

N/A for single input, but ensure numeric, non-zero, and plausible clinical range.

Edge Cases:

Blank input ‚Üí prompt ‚ÄúHCO‚ÇÉ‚Åª is required‚Äù

Negative values ‚Üí invalid

Extreme values outside physiological range ‚Üí warn user

Excess decimal places ‚Üí restrict to 1 decimal

3Ô∏è‚É£ Output Validation Logic

Center pCO‚ÇÇ: 1.5 * HCO3 + 8 (mmHg)

Range: ¬±2 mmHg

Convert to kPa: mmHg / 7.5

Ensure calculated pCO‚ÇÇ is physiologically plausible (roughly 20‚Äì50 mmHg for adults).

Clinical Interpretation Example:

If center pCO‚ÇÇ < 20 mmHg ‚Üí warn about possible overcompensation

If center pCO‚ÇÇ > 50 mmHg ‚Üí warn about possible undercompensation
-->