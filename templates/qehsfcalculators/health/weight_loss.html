{% extends 'base.html' %}
{% block title %}Weight Loss Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weight Loss Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        .rate-label {
            color: #2980b9;
            font-weight: bold;
            font-size: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        .feedback-content ul {
            padding-left: 20px;
            margin-top: 10px;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon { font-size: 76px; flex-shrink: 0; text-align: center; }
        .error-message { font-size: 24px; line-height: 1.6; }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Weight Loss Calculator</h1>
            <p>Estimate the time and daily calorie intake required to reach your weight loss goal.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Your Profile & Goals</h2>
                <div class="form-group">
                    <label for="gender">Gender</label>
                    <select id="gender" class="form-select">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="age">Age</label>
                    <input type="number" id="age" class="form-input" placeholder="Enter your age">
                </div>
                <div class="form-group">
                    <label for="weight">Current Weight (kg)</label>
                    <input type="number" id="weight" class="form-input" placeholder="Enter your current weight">
                </div>
                <div class="form-group">
                    <label for="height">Height (cm)</label>
                    <input type="number" id="height" class="form-input" placeholder="Enter your height">
                </div>
                <div class="form-group">
                    <label for="targetWeight">Target Weight (kg)</label>
                    <input type="number" id="targetWeight" class="form-input" placeholder="Enter your target weight">
                </div>
                <div class="form-group">
                    <label for="activityLevel">Activity Level</label>
                    <select id="activityLevel" class="form-select">
                        <option value="1.2">Sedentary (Little to no exercise)</option>
                        <option value="1.375">Light (Exercise 1-3 times/week)</option>
                        <option value="1.55">Moderate (Exercise 3-5 times/week)</option>
                        <option value="1.725">Active (Exercise 6-7 times/week)</option>
                        <option value="1.9">Very Active (Intense daily exercise)</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="weightLossGoal">Weekly Weight Loss Goal</label>
                    <select id="weightLossGoal" class="form-select">
                        <option value="0.5">0.5 kg/week</option>
                        <option value="1">1 kg/week</option>
                    </select>
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate Plan</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Health illustration">
                    <p>Enter your details and goals to generate your personalized weight loss plan.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>Daily Calorie Target</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0</div>
                        <div class="rate-label">Calories/day</div>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Your Weight Loss Plan</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                     <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>How This Calculator Works</h3>
                <p>This calculator uses the Mifflin-St Jeor equation to estimate your Basal Metabolic Rate (BMR)—the calories your body burns at rest. It then adjusts this value based on your activity level to find your Total Daily Energy Expenditure (TDEE), or maintenance calories. Finally, it subtracts the necessary calories to meet your weekly weight loss goal (approx. 500 calories/day for 0.5 kg/week).</p>
            </div>
            <div class="note-card">
                <h3>Sustainable Weight Loss</h3>
                <ul class="note-list">
                    <li><strong>Safe Rate:</strong> A weight loss of 0.5 to 1 kg per week is generally considered safe and sustainable. Faster weight loss can lead to muscle loss and nutrient deficiencies.</li>
                    <li><strong>Minimum Calories:</strong> It is generally not recommended for women to consume fewer than 1,200 calories per day, or for men to consume fewer than 1,500 calories per day, without medical supervision.</li>
                </ul>
            </div>
             <div class="note-card">
                <h3>⚠️ Disclaimer</h3>
                <p>This calculator provides an estimate for informational purposes. Actual results may vary based on individual metabolism, body composition, and adherence to the plan. Consult with a healthcare provider or registered dietitian before starting any significant weight loss program.</p>
            </div>
        </div>
    </div>

    <script>
        function calculateAndDisplay() {
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');

            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');

            let errors = [];
            function getVal(id, label, opts = {}) {
                const el = document.getElementById(id);
                const raw = el.value?.toString().trim();
                if (!raw) {
                    errors.push(`👉 ${label} is required.`);
                    return null;
                }
                const num = parseFloat(raw);
                if (isNaN(num) || num <= 0) {
                    errors.push(`👉 Enter a valid positive number for ${label}.`);
                    return null;
                }
                if (opts.min !== undefined && num < opts.min) errors.push(`👉 ${label} must be ≥ ${opts.min}.`);
                if (opts.max !== undefined && num > opts.max) errors.push(`👉 ${label} must be ≤ ${opts.max}.`);
                return num;
            }
            
            const gender = document.getElementById('gender').value;
            const activityLevel = parseFloat(document.getElementById('activityLevel').value);
            const weightLossGoal = parseFloat(document.getElementById('weightLossGoal').value);
            
            const age = getVal('age', 'Age', {min: 18, max: 100});
            const weight = getVal('weight', 'Current Weight');
            const height = getVal('height', 'Height');
            const targetWeight = getVal('targetWeight', 'Target Weight');
            
            if(weight && targetWeight && targetWeight >= weight) {
                errors.push('👉 Target Weight must be less than Current Weight.');
            }

            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }
            
            let bmr;
            if (gender === "male") {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else { // female
                bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }
            
            const tdee = bmr * activityLevel;
            const dailyDeficit = weightLossGoal * 1100; // Approx. 1100 kcal deficit per kg/week
            const caloriesForLoss = tdee - dailyDeficit;
            
            if(caloriesForLoss < 1200) {
                 errors.push(`👉 The calculated daily calorie intake (${caloriesForLoss.toFixed(0)}) is dangerously low for your selected goal. Please choose a slower weight loss rate.`);
                 errorMessage.innerHTML = errors.join("<br>");
                 errorBox.classList.remove("hidden");
                 placeholder.classList.add('hidden');
                 return;
            }

            const totalWeightLoss = weight - targetWeight;
            const daysToAchieve = (totalWeightLoss * 7700) / dailyDeficit;
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() + Math.ceil(daysToAchieve));

            placeholder.classList.add('hidden');
            resultValueBox.classList.remove('hidden');

            document.getElementById('rateValue').textContent = caloriesForLoss.toFixed(0);
            
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            
            document.getElementById('feedbackContent').innerHTML = `
                <ul>
                    <li>To maintain your current weight, you need ~<strong>${tdee.toFixed(0)} Calories/day</strong>.</li>
                    <li>To lose <strong>${weightLossGoal} kg/week</strong>, you need a daily deficit of ~${dailyDeficit.toFixed(0)} Calories.</li>
                    <li>Time to reach your goal of <strong>${targetWeight} kg</strong> is approximately <strong>${Math.ceil(daysToAchieve)} days</strong>.</li>
                    <li>Your estimated target date is <strong>${targetDate.toLocaleDateString('en-US', options)}</strong>.</li>
                </ul>
            `;
        }
        
        function printReport() {
            window.print();
        }
    </script>
</body>
</html>
{% endblock %}