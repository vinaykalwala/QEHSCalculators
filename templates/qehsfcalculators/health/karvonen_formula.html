{% extends 'base.html' %}
{% block title %}Karvonen Formula Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karvonen Formula Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 520px;
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        .print-btn:hover {
            background: #1560bd;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        .rate-label {
            color: #2980b9;
            font-weight: bold;
            font-size: 20px;
        }
        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0 10px;
            overflow: hidden;
        }
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
            background-color: #3498db;
        }
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        .note-card:hover {
            transform: translateY(-2px);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li, .note-card ol {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }
        /* Toggle helper */
        .hidden {
            display: none;
        }
        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }
        .back-btn {
            background: linear-gradient(#1560bd,#000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Karvonen Formula Calculator</h1>
            <p>Calculate your Target Heart Rate (THR) for optimal workout intensity.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Enter Your Details</h2>
                <div class="form-group">
                    <label for="restingHR">Resting Heart Rate (bpm)</label>
                    <input type="number" id="restingHR" class="form-input" placeholder="e.g., 65">
                </div>
                 <div class="form-group">
                    <label for="intensity">Desired Intensity (%)</label>
                    <input type="number" id="intensity" class="form-input" placeholder="e.g., 70">
                </div>
                <div class="form-group">
                    <label for="knowMaxHR">Do you know your Maximum HR?</label>
                    <select id="knowMaxHR" class="form-select" onchange="renderInputs()">
                        <option value="no">No (Estimate from my age)</option>
                        <option value="yes">Yes (I will enter it manually)</option>
                    </select>
                </div>
                <div id="conditionalInputs">
                    </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate Target Heart Rate</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Health illustration">
                    <p>Enter your details to calculate your personalized target heart rate zones.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>Target Heart Rate (THR)</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0</div>
                        <div class="rate-label">bpm</div>
                    </div>
                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span id="meterMin">Rest</span>
                        <span id="meterMax">Max</span>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Calculation Details</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
        
            <div class="note-card">
                <h3>üìñ Understanding the Karvonen Formula</h3>
                <p>
                    The Karvonen formula is a widely used method for calculating your
                    <strong>Target Heart Rate (THR)</strong> during physical activity.
                    It is more precise than basic methods because it considers both your
                    <strong>Resting Heart Rate (RHR)</strong> and <strong>Maximum Heart Rate (MHR)</strong>.
                    This personalized approach helps optimize your workouts by ensuring you train
                    at the right intensity to meet your fitness goals.
                </p>
            </div>
        
            <div class="note-card">
                <h3>‚öô Parameters Used</h3>
        
                <p><strong>1. Resting Heart Rate (RHR):</strong><br>
                    Your heartbeats per minute (bpm) at rest, best measured in the morning before activity.
                    A lower RHR generally indicates better cardiovascular fitness.
                    <em>Average RHR:</em> 60‚Äì100 bpm for adults (athletes may have ~40 bpm).
                </p>
        
                <p><strong>2. Maximum Heart Rate (MHR):</strong><br>
                    The highest bpm your heart can achieve during maximum effort.
                    If unknown, estimate with <em>MHR = 220 ‚àí Age</em>.
                    <em>Example:</em> If you are 30, MHR ‚âà 190 bpm.
                </p>
        
                <p><strong>3. Heart Rate Reserve (HRR):</strong><br>
                    The difference between MHR and RHR. Indicates your heart‚Äôs working capacity.
                    <em>HRR = MHR ‚àí RHR</em>.
                </p>
        
                <p><strong>4. Target Heart Rate (THR):</strong><br>
                    The bpm range you aim for during exercise, calculated as:
                    <em>THR = ((MHR ‚àí RHR) √ó Intensity) + RHR</em>.
                </p>
            </div>
        
            <div class="note-card">
                <h3>üìù How to Use the Karvonen Formula</h3>
                <ol>
                    <li><strong>Measure your Resting Heart Rate (RHR):</strong> Take your pulse for 60s after waking.</li>
                    <li><strong>Find your Maximum Heart Rate (MHR):</strong> Use <em>MHR = 220 ‚àí Age</em> or a fitness test.
                    </li>
                    <li><strong>Select your workout intensity:</strong>
                        <ul>
                            <li><strong>Light (50‚Äì60%)</strong> ‚Äì Warm-ups & active recovery</li>
                            <li><strong>Fat-Burning Zone (60‚Äì80%)</strong> ‚Äì Weight loss & general fitness</li>
                            <li><strong>High-Intensity (80‚Äì90%)</strong> ‚Äì Endurance & performance training</li>
                        </ul>
                    </li>
                    <li><strong>Apply the formula</strong> to calculate your personalized THR.</li>
                </ol>
            </div>
        
            <div class="note-card">
                <h3>‚ùì FAQs</h3>
                <p><strong>What is HRR?</strong><br>
                    It‚Äôs the difference between MHR and RHR, showing your heart‚Äôs capacity for work.
                </p>
        
                <p><strong>How do I find my fat-burning zone?</strong><br>
                    Use the Karvonen formula with <strong>60‚Äì80%</strong> intensity.
                </p>
        
                <p><strong>Can this be used for HIIT?</strong><br>
                    Yes, set intensity to <strong>80‚Äì90%</strong> for advanced training.
                </p>
        
                <p><strong>What if I know my exact MHR?</strong><br>
                    Input it directly for greater accuracy instead of using the formula.
                </p>
            </div>
        
    <!-- Input Validation Rules -->
    <div class="note-card">
        <h3>‚úÖ Input Validation Rules</h3>
        <ul>
            <li><strong>Resting Heart Rate (RHR):</strong> Integer between 40‚Äì100 bpm.</li>
            <li><strong>Age:</strong> Integer between 18‚Äì70 years (if MHR not known).</li>
            <li><strong>Maximum Heart Rate (MHR) (if known):</strong> 100‚Äì220 bpm and must be at least 30 bpm higher than RHR.</li>
            <li><strong>Intensity:</strong> 40‚Äì90 %, integer or 1 decimal place.</li>
            <li><strong>Cross-field check:</strong> MaxHR must be ‚â• RestingHR + 30.</li>
        </ul>
    </div>

<div class="note-card">
    <h3>üßÆ Output Validations</h3>
    <p>
        The calculator displays your <strong>Target Heart Rate (THR)</strong> using the Karvonen Formula.  
        The result is based on the <strong>Heart Rate Reserve (HRR)</strong> and intensity input. Feedback is provided according to the following zones, which match the calculation logic:
    </p>
    <ul>
        <li>THR is calculated as: <strong>THR = ((MHR ‚àí RHR) √ó Intensity) + RHR</strong></li>
        <li>Heart Rate Reserve (HRR) = MHR ‚àí RHR, must always be ‚â• 30 bpm</li>
        <li>THR output is rounded to 1 decimal place</li>
        <li><strong>Feedback Zones:</strong>
            <ul>
                <li>‚ö†Ô∏è Intensity &lt;50%: Low exertion zone ‚Äì may not meet occupational fitness standards</li>
                <li>‚úÖ Intensity 50‚Äì85%: Safe working zone for occupational fitness</li>
                <li>üö® Intensity &gt;85%: High exertion zone ‚Äì monitor worker safety closely</li>
            </ul>
        </li>
        <li>The meter display shows THR as a percentage of HRR for visual guidance</li>
    </ul>
    <p>
        This ensures users understand the intensity of their workout and maintain safety while exercising.
    </p>
</div>


<div class="note-card">
    <h3>üìú Governing Principle</h3>
    <p>
        The Karvonen Formula is not of a specific standard but is a widely accepted method, particularly by organizations like the American College of Sports Medicine (ACSM), for calculating exercise target heart rates using heart rate reserve (HRR). It's considered a gold standard by some for its accuracy compared to simpler methods, though individual results can vary.
    </p>
    <p><strong style="color: #1976d2;">Key Aspects of the Karvonen Formula:</strong></p>
    <ul>
        <li>Uses Heart Rate Reserve (HRR): This method calculates your heart rate reserve by subtracting your resting heart rate (HRrest) from your maximum heart rate (HRmax).</li>
        <li>Considers Resting Heart Rate: Unlike the simpler 220 minus age method, the Karvonen formula incorporates your resting heart rate, which adds another layer of personalization to the target heart rate calculation.</li>
        <li>Provides a More Accurate Intensity: By using the HRR, the formula gives you a more accurate target heart rate range based on the individual's fitness level, making it suitable for various exercise intensities.</li>
    </ul>
    <p><strong style="color: #1976d2;">How to Calculate Using the Karvonen Formula:</strong></p>
    <ol>
        <li>Calculate HRmax: The standard formula is 220 minus your age.</li>
        <li>Calculate HRrest: Measure your heart rate while at rest, ideally first thing in the morning before getting out of bed.</li>
        <li>Calculate HRR: HRmax - HRrest = HRR.</li>
        <li>Determine Target Heart Rate: HRtarget = (HRR x desired intensity percentage) + HRrest. For example, for moderate-intensity exercise, you would aim for 50-70% of your HRR, and for vigorous-intensity exercise, you would aim for above 70%.</li>
    </ol>
</div>

        <!-- Conclusion -->
    <div class="note-card">
        <h3>‚úÖ Conclusion</h3>
        <p>
            This calculator provides a safe, occupationally informed, and personalized way to determine your target heart rate for workouts.  
            By considering RHR, MHR, HRR, and intensity, and applying strict input and output validations, users can optimize exercise effectiveness while minimizing safety risks.
        </p>
    </div>
        
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', renderInputs);

        function renderInputs() {
            const knowMaxHR = document.getElementById('knowMaxHR').value;
            const container = document.getElementById('conditionalInputs');

            if (knowMaxHR === 'no') {
                container.innerHTML = `
                    <div class="form-group">
                        <label for="age">Age (years)</label>
                        <input type="number" id="age" class="form-input" placeholder="Enter your age">
                    </div>`;
            } else {
                container.innerHTML = `
                    <div class="form-group">
                        <label for="maxHR">Maximum Heart Rate (bpm)</label>
                        <input type="number" id="maxHR" class="form-input" placeholder="Enter your known max HR">
                    </div>`;
            }
        }

        function calculateAndDisplay() {
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');

            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');

            let errors = [];
            function getVal(id, label, opts = {}) {
                const el = document.getElementById(id);
                if (!el) return null;
                const raw = el.value?.toString().trim();
                if (!raw) {
                    errors.push(`üëâ ${label} is required.`);
                    return null;
                }
                const num = parseFloat(raw);
                if (isNaN(num)) {
                    errors.push(`üëâ Enter a valid number for ${label}.`);
                    return null;
                }
                if (opts.min !== undefined && num < opts.min) errors.push(`üëâ ${label} must be ‚â• ${opts.min}.`);
                if (opts.max !== undefined && num > opts.max) errors.push(`üëâ ${label} must be ‚â§ ${opts.max}.`);
                if (opts.integer && !Number.isInteger(num)) errors.push(`üëâ ${label} must be a whole number.`);
                return num;
            }

            // Apply stricter occupational-safe ranges
            const restingHR = getVal("restingHR", "Resting Heart Rate", { min: 40, max: 100, integer: true });
            const intensity = getVal("intensity", "Intensity (%)", { min: 40, max: 90 });
            const knowMaxHR = document.getElementById('knowMaxHR').value;

            let maxHR;
            let maxHRText = "";
            if (knowMaxHR === 'no') {
                const age = getVal("age", "Age", { min: 18, max: 70, integer: true });
                if (age) {
                    maxHR = 220 - age;
                    maxHRText = `Estimated Max HR: <strong>${maxHR} bpm</strong> (based on age)`;
                }
            } else {
                maxHR = getVal("maxHR", "Maximum Heart Rate", { min: 100, max: 220 });
                if (maxHR) maxHRText = `Your Max HR: <strong>${maxHR} bpm</strong>`;
            }

            // Cross-field dependency check
            if (maxHR && restingHR && maxHR <= restingHR + 30) {
                errors.push("üëâ Maximum HR must be at least 30 bpm higher than Resting HR.");
            }

            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }

            // Safe calculation
            const intensityDecimal = intensity / 100;
            const hrr = maxHR - restingHR;
            const thr = (hrr * intensityDecimal) + restingHR;

            placeholder.classList.add('hidden');
            resultValueBox.classList.remove('hidden');

            document.getElementById('rateValue').textContent = thr.toFixed(1);

            const meterFill = document.getElementById('meterFill');
            const meterMin = document.getElementById('meterMin');
            const meterMax = document.getElementById('meterMax');

            meterMin.textContent = `Rest: ${restingHR} bpm`;
            meterMax.textContent = `Max: ${maxHR} bpm`;

            let pct = ((thr - restingHR) / hrr) * 100;
            pct = Math.max(0, Math.min(100, pct));
            meterFill.style.width = pct + '%';

            // Feedback zone
            let feedbackNote = "";
            if (intensity < 50) {
                feedbackNote = "<br>‚ö†Ô∏è Low exertion zone ‚Äì may not meet occupational fitness standards.";
            } else if (intensity > 85) {
                feedbackNote = "<br>üö® High exertion zone ‚Äì monitor worker safety closely.";
            } else {
                feedbackNote = "<br>‚úÖ Safe working zone for occupational fitness.";
            }

            document.getElementById('feedbackContent').innerHTML = `
                ${maxHRText}<br>
                Heart Rate Reserve (HRR): <strong>${hrr.toFixed(1)} bpm</strong><br>
                Intensity: <strong>${intensity}%</strong>
                ${feedbackNote}
            `;
        }

        function printReport() {
            window.print();
        }
    </script>

</body>
</html>
{% endblock %}

<!-- 
1. Input Validation Rules (QEHS/Fire Safety perspective)
Field	Expected Range	Units	Validation Rules	Compliance Rationale
Resting Heart Rate (RHR)	40 ‚Äì 100 bpm (typical occupational range)	bpm	Must be an integer ‚â• 40 and ‚â§ 100.	Below 40 ‚Üí bradycardia (not fit for strenuous work); above 100 ‚Üí tachycardia (medical review needed). OSHA/ILO standards require fitness checks.
Age	18 ‚Äì 70 years (occupational population)	years	Must be an integer ‚â•18 and ‚â§70.	Below 18 ‚Üí not legally employable in hazardous industries. Above 70 ‚Üí beyond safe working norms in fire/emergency response.
Maximum Heart Rate (if known)	100 ‚Äì 220 bpm	bpm	Must be ‚â• RestingHR + 30, ‚â§ 220.	Ensures logical physiological limits. Prevents unrealistic entries like MaxHR = 80 with RestingHR = 75.
Intensity (%)	40 ‚Äì 90 %	%	Must be an integer or one decimal place. Acceptable range 40‚Äì90.	Training standards (NFPA/ILO fitness testing) typically require moderate-to-vigorous intensity. <40% not useful, >90% unsafe in occupational drills.
Cross-field Dependency	MaxHR > RestingHR by at least 30 bpm.	bpm	If not satisfied, block calculation.	Needed to avoid negative Heart Rate Reserve (HRR).
Decimals	Age: none. RHR: none. Intensity: 1 decimal max.	‚Äî	Avoid floating point abuse.	Keeps inputs clean and auditable in safety logs.
2. Output Validation Logic

Target Heart Rate (THR) must always be within:

Min: RestingHR + (HRR √ó 0.40)

Max: RestingHR + (HRR √ó 0.90)

Heart Rate Reserve (HRR) = MaxHR ‚àí RestingHR must always be ‚â• 30 bpm.

Output Rounding: Report THR and HRR to 1 decimal place, consistent with occupational audit standards.

Feedback Thresholds:

<50% HRR: Low exertion ‚Äì not sufficient for training.

50‚Äì70% HRR: Safe, recommended zone for occupational fitness.

70‚Äì85% HRR: Vigorous zone ‚Äì requires monitoring.

>85% HRR: Unsafe zone for most workers; red-flag output.
-->