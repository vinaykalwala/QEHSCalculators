{% extends 'base.html' %}
{% block title %}HOMA-IR Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOMA-IR Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
            min-height: 420px;
            justify-content: center;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        .print-btn:hover {
            background: #1560bd;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0 10px;
            overflow: hidden;
        }
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out, background-color 1s ease-in-out;
            border-radius: 6px;
        }
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        .note-card:hover {
            transform: translateY(-2px);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        /* Error Message ---FIXED SECTION--- */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }
        /* ---END OF FIX--- */
        .hidden {
            display: none;
        }
        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }
        .back-btn {
            background: linear-gradient(#1560bd,#000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>HOMA-IR Calculator</h1>
            <p>Assess insulin resistance and sensitivity using HOMA-IR and QUICKI scores.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Enter Fasting Values</h2>
                <div class="form-group">
                    <label for="glucose">Fasting Glucose (mg/dL)</label>
                    <input type="number" id="glucose" class="form-input" placeholder="e.g., 90" step="0.1">
                </div>
                <div class="form-group">
                    <label for="insulin">Fasting Insulin (µU/mL)</label>
                    <input type="number" id="insulin" class="form-input" placeholder="e.g., 5" step="0.1">
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate HOMA-IR</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Health illustration">
                    <p>Enter your fasting lab values to calculate your HOMA-IR and QUICKI scores.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>HOMA-IR Score</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.0</div>
                    </div>
                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Optimal</span>
                        <span>Borderline</span>
                        <span>High Resistance</span>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Analysis</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
           <div class="note-card">
                <h3>🧠 Understanding This Tool</h3>
                <p>The <strong>HOMA-IR (Homeostatic Model Assessment for Insulin Resistance)</strong> is a method used to estimate insulin resistance based on fasting glucose and insulin levels. This tool also provides the <strong>QUICKI (Quantitative Insulin Sensitivity Check Index)</strong>, offering additional insight into how sensitive your body is to insulin.</p>
            </div>
            <!-- 1. About This Calculator -->


    <!-- 2. Parameters Used -->
    <div class="note-card">
        <h3>⚙ Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Fasting Glucose (mg/dL or mmol/L):</strong> The glucose concentration in blood after at least 8 hours of fasting.</li>
            <li><strong>Fasting Insulin (µU/mL):</strong> The insulin concentration in blood after fasting.</li>
        </ul>
 
    </div>

    <!-- 3. Input Validation Rules -->
    <div class="note-card">
        <h3>✅ Input Validation Rules</h3>
        <ul class="note-list">
            <li><strong>Fasting Glucose:</strong> Must be a positive numeric value; enter in mg/dL or mmol/L as per your selection.</li>
            <li><strong>Fasting Insulin:</strong> Must be a positive numeric value (no symbols or text).</li>
            <li><strong>Fasting Requirement:</strong> Values should represent fasting samples (≥8 hours without eating).</li>
            <li><strong>Realistic Ranges:</strong> Glucose: 50–400 mg/dL; Insulin: 1–300 µU/mL.</li>
            <li><strong>Missing or Zero Inputs:</strong> Will trigger a warning and stop calculation.</li>
            <li><strong>Decimal Values:</strong> Allowed, but avoid unnecessary precision beyond two decimal places.</li>
        </ul>
        <p class="note-tip">✅ These rules ensure biologically valid entries and prevent incorrect or meaningless results.</p>
    </div>

    <!-- 4. Output Validations -->
    <div class="note-card">
        <h3>🧾 Output Validations</h3>
        <ul class="note-list">
            <li><strong>HOMA-IR (Homeostatic Model Assessment for Insulin Resistance) &lt; 1.9:</strong> Indicates normal insulin sensitivity.</li>
            <li><strong>HOMA-IR (Homeostatic Model Assessment for Insulin Resistance) 1.9 – 2.9:</strong> Suggests early or mild insulin resistance.</li>
            <li><strong>HOMA-IR (Homeostatic Model Assessment for Insulin Resistance) &gt; 2.9:</strong> Indicates significant insulin resistance — clinical follow-up recommended.</li>
            <li><strong>QUICKI (Quantitative Insulin Sensitivity Check Index) &gt; 0.339:</strong> Suggests healthy insulin sensitivity.</li>
            <li><strong>QUICKI (Quantitative Insulin Sensitivity Check Index) &lt; 0.339:</strong> Suggests possible insulin resistance.</li>
        </ul>
        <p>
            📊 <strong>Assessment/Feedback:</strong> The result section displays both HOMA-IR and QUICKI values along 
            with an interpretation (Normal, Early Resistance, or Significant Resistance) and a recommendation for 
            lifestyle modification or further medical evaluation based on your risk category.
        </p>
    </div>

<!-- 5. Governing Principle -->
<div class="note-card">
    <h3>⚖ Governing Principle</h3>
    <p>
        The <strong>HOMA-IR calculator</strong> for assessing insulin resistance uses a formula and a 
        non-universal standard rather than a single universally agreed-upon standard, as HOMA-IR values can vary 
        depending on the population, ethnicity, and other factors. The Homeostatic Model Assessment for Insulin Resistance (HOMA-IR) 
        uses fasting glucose and fasting insulin levels to provide a surrogate measure of insulin sensitivity, with the result being 
        interpreted against a reference range or cutoff value, which differs between studies and populations.
    </p>

    <p><strong style="color: #1976d2;">The HOMA-IR Formula:</strong></p>
    <p>HOMA-IR = (Fasting Insulin [µU/mL] × Fasting Glucose [mmol/L]) / 22.5</p>

    <p><strong style="color: #1976d2;">Understanding the "Standard":</strong></p>
    <ul>
        <li><strong>A Normal Individual:</strong> The constant "22.5" in the formula is derived from the fasting insulin and glucose levels of an "ideal" or "normal" individual, where HOMA-IR would be equal to 1.</li>
        <li><strong>No Universal Cut-Off:</strong> There isn't a single, universal standard or cutoff point for what constitutes "insulin resistance" using HOMA-IR.</li>
        <li><strong>Population-Specific Ranges:</strong> The range of normal HOMA-IR values and the cutoff for insulin resistance can differ between populations and ethnic groups. For instance, a study in a Hispanic population found a potentially different reference range than in Caucasian populations, notes ScienceDirect.</li>
        <li><strong>Common Cutoffs:</strong> Different studies may use various cutoff values based on the 85th percentile or other criteria, such as 3.8 or 2.4, to indicate insulin resistance in specific populations, reports Archives of Medical Science.</li>
    </ul>

    <p><strong style="color: #1976d2;">Why the Variation?</strong></p>
    <ul>
        <li><strong>Research Context:</strong> HOMA-IR is often used in research studies where direct measures like the glucose clamp are not feasible.</li>
        <li><strong>Factors Influencing HOMA-IR:</strong> Variables like BMI, waist-to-hip ratio, and triglyceride levels can influence HOMA-IR, leading to different reference values for different groups, according to the National Institutes of Health (NIH).</li>
    </ul>

    <p>
        Therefore, the HOMA-IR calculator’s standardization lies in its <strong>validated research use</strong> 
        and <strong>population-adjusted interpretation</strong> rather than a universal fixed cutoff.
    </p>
</div>


    <!-- 6. Conclusion -->
    <div class="note-card">
        <h3>🩺 Conclusion</h3>
        <p>
            The <strong>HOMA-IR Calculator</strong> provides a practical and non-invasive method for estimating 
            insulin resistance and insulin sensitivity. It is valuable for both clinical assessments and research 
            studies when advanced tests like the glucose clamp method are not feasible.
        </p>
        <p style="font-style: italic; color: #555;">
            ⚠️ Disclaimer: This calculator is intended for educational and informational use only and should not 
            replace professional medical advice. Always consult a healthcare provider for diagnosis and treatment decisions.
        </p>
    </div>

</div>
    <script>
        function calculateAndDisplay() {
            // --- UI Elements ---
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');

            // --- Reset UI ---
            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');

            // --- Validation ---
            let errors = [];
            function getVal(id, label, opts = {}) {
                const el = document.getElementById(id);
                const raw = el.value?.toString().trim();
                if (!raw) {
                    errors.push(`👉 ${label} is required.`);
                    return null;
                }
                const num = parseFloat(raw);
                if (isNaN(num) || num <= 0) {
                    errors.push(`👉 Enter a valid positive number for ${label}.`);
                    return null;
                }
                if (opts.min !== undefined && num < opts.min) errors.push(`👉 ${label} must be ≥ ${opts.min}.`);
                if (opts.max !== undefined && num > opts.max) errors.push(`👉 ${label} must be ≤ ${opts.max}.`);
                return num;
            }

            const glucose = getVal("glucose", "Fasting Glucose", { min: 40, max: 700 });
            const insulin = getVal("insulin", "Fasting Insulin", { min: 1, max: 300 });

            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }

            // --- Calculations ---
            const homaIR = (insulin * glucose) / 405;
            const quicki = 1 / (Math.log10(insulin) + Math.log10(glucose));

            // --- Display Results ---
            placeholder.classList.add('hidden');
            resultValueBox.classList.remove('hidden');
            
            document.getElementById('rateValue').textContent = homaIR.toFixed(2);

            // --- Update Meter (Scaled for HOMA-IR up to 5) ---
            const meterFill = document.getElementById('meterFill');
            const maxMeter = 5; // A HOMA-IR of 5 is quite high, good for a visual scale
            let pct = (homaIR / maxMeter) * 100;
            pct = Math.min(100, Math.max(0, pct));
            meterFill.style.width = pct + '%';
            
            let interpretation = "";
            if (homaIR < 1.9) {
                meterFill.style.backgroundColor = '#2ecc71'; // Green
                interpretation = "✅ Your HOMA-IR score suggests **normal insulin sensitivity**.";
            } else if (homaIR <= 2.9) {
                meterFill.style.backgroundColor = '#f39c12'; // Yellow
                interpretation = "⚠️ Your HOMA-IR score suggests **early insulin resistance**.";
            } else {
                meterFill.style.backgroundColor = '#e74c3c'; // Red
                interpretation = "🚨 Your HOMA-IR score indicates **significant insulin resistance**. Please consult a healthcare professional.";
            }
            
            const feedbackText = `Your QUICKI score is <strong>${quicki.toFixed(3)}</strong>. ${interpretation}`;
            document.getElementById('feedbackContent').innerHTML = feedbackText;
        }

        function printReport() {
            window.print();
        }
    </script>
</body>
</html>
{% endblock %}

<!-- 
1. Analysis of Inputs, Outputs, and Formula

For an Accident Rate Calculator, the standard OSHA formula is:

Accident Rate (AR)
=
Number of Recordable Cases
×
200
,
000
Total Hours Worked
Accident Rate (AR)=
Total Hours Worked
Number of Recordable Cases×200,000
	​


Number of Recordable Cases (NRC):
Count of OSHA/ILO recordable injuries or illnesses.
→ Must be a whole number ≥ 0.

Total Hours Worked (THW):
Sum of all employee hours in the reporting period.
→ Must be a positive number > 0.

Constant 200,000 = 100 employees × 40 hours/week × 50 weeks/year.
Used to normalize rates across companies of different sizes.

Output:

Accident Rate (AR): A normalized KPI for benchmarking.

Correct interpretation bands:

AR = 0 → Excellent (Zero recordables).

0 < AR ≤ 1 → Below industry average.

AR > 1 → Above average, needs review.

Extreme AR (>10) → Serious issues / reporting error suspected.

🛠 2. Comprehensive Validation Rules
✅ General Input Validation
Field	Validation Rule	Why (QEHS/Compliance Rationale)
Recordable Cases (NRC)	Must be integer ≥ 0 and ≤ 1000 (edge cap). No decimals.	Safety cases are discrete. Negative or fractional values are non-compliant.
Total Hours Worked (THW)	Must be > 0, ≤ 10,000,000 (10M)	OSHA/ILO require denominator > 0. Unrealistic caps prevent garbage data.
Decimals	Hours may allow 1 decimal (e.g., contractors). Cases never decimal.	Reflects actual reporting.
Cross-field logic	If NRC > 0 but THW < 100 → trigger warning (unrealistic).	Ensures reporting integrity.
Division check	Prevent divide-by-zero if THW = 0.	Required by all safety reporting standards.
⚠️ 3. Edge Case Validations

THW = 0 → Show error: "Total Hours Worked cannot be zero. OSHA/ILO metrics require positive exposure hours."

NRC > 0 and THW extremely small (<100) → Likely input mistake. Warn user.

AR > 20 → Extreme outlier. Warn user: "Rate exceeds typical industry benchmarks. Please verify inputs."

Blank inputs → Mandatory error prompts.

Negative numbers → Not allowed in regulated reporting.

📊 4. Output Validation Logic

Rate bands:

AR = 0 → ✅ "Excellent: Zero recordable injuries reported."

0 < AR ≤ 1 → ⚠️ "Good: Below or near benchmark, continue monitoring."

1 < AR ≤ 10 → 🔶 "High: Above benchmark. Investigate root causes, apply corrective actions."

AR > 10 → 🚨 "Critical: Unsafe trend. Mandatory management review, regulatory reporting may be required."

Compliance Context:

OSHA logs require accurate normalization.

ISO 45001 requires trend monitoring.

NFPA/ILO guidance: high AR → strong corrective measures.
-->