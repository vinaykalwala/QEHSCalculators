{% extends 'base.html' %}
{% block title %}Lille Score Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lille Score Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
            min-height: 420px;
            max-height: 700px;
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0 10px;
            overflow: hidden;
            position: relative;
        }
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out, background-color 1s ease-in-out;
            border-radius: 6px;
        }
        .meter-threshold {
            position: absolute;
            top: 0;
            left: 45%;
            width: 2px;
            height: 100%;
            background-color: #34495e;
        }
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li, .note-card ol {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon { font-size: 76px; flex-shrink: 0; text-align: center; }
        .error-message { font-size: 24px; line-height: 1.6; }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Lille Score Calculator</h1>
            <p>Assess steroid treatment response in patients with alcoholic hepatitis.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Patient Data</h2>
                <div class="form-group">
                    <label for="age">Age (years)</label>
                    <input type="number" id="age" class="form-input" placeholder="e.g., 55">
                </div>
                <div class="form-group">
                    <label for="albumin">Albumin (g/L)</label>
                    <input type="number" id="albumin" class="form-input" placeholder="e.g., 25">
                </div>
                 <div class="form-group">
                    <label for="creatinine">Creatinine (mg/dL)</label>
                    <input type="number" id="creatinine" step="0.1" class="form-input" placeholder="e.g., 1.1">
                </div>
                <div class="form-group">
                    <label for="pt">Prothrombin Time (PT) (seconds)</label>
                    <input type="number" id="pt" step="0.1" class="form-input" placeholder="e.g., 18.5">
                </div>
                <div class="form-group">
                    <label for="bilirubin0">Bilirubin Day 0 (μmol/L)</label>
                    <input type="number" id="bilirubin0" class="form-input" placeholder="Start of treatment">
                </div>
                 <div class="form-group">
                    <label for="bilirubin7">Bilirubin Day 7 (μmol/L)</label>
                    <input type="number" id="bilirubin7" class="form-input" placeholder="After 7 days of treatment">
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate Lille Score</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Health illustration">
                    <p>Enter patient data to calculate the Lille Score and predict 6-month survival.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>Lille Score</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                    </div>
                    <div class="safety-meter">
                        <div class="meter-threshold" title="Threshold = 0.45"></div>
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Good Response</span>
                        <span>Poor Response</span>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Interpretation</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>About the Lille Score</h3>
                <p>The Lille Score is a clinical tool used to identify patients with severe alcoholic hepatitis who are not responding to steroid therapy. It helps clinicians decide whether to continue steroids or consider alternative treatments, such as a liver transplant evaluation.</p>
            </div>
            <div class="note-card">
                <h3>Interpreting the Results</h3>
                <p>The score ranges from 0 to 1. The key threshold is <strong>0.45</strong>.</p>
                <ul class="note-list">
                    <li>A score of <strong>&lt; 0.45</strong> indicates a good response to steroid therapy. Patients in this group have a significantly higher 6-month survival rate (around 85%).</li>
                    <li>A score of <strong>≥ 0.45</strong> indicates a poor or no response to steroid therapy. These patients have a much lower 6-month survival rate (around 25%), and stopping steroids should be considered.</li>
                </ul>
            </div>
             <div class="note-card">
                <h3>Limitations</h3>
                <p>The Lille Score is a valuable predictive model but should not replace clinical judgment. It is specifically designed for patients with alcoholic hepatitis treated with corticosteroids and may not be applicable in other contexts.</p>
            </div>
            <div class="note-card">
                <h3>⚠️ Disclaimer</h3>
                <p>This calculator is intended for use by healthcare professionals and for educational purposes only. It is not a substitute for professional medical advice, diagnosis, or treatment.</p>
            </div>
        </div>
    </div>

    <script>
        function calculateAndDisplay() {
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');

            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');

            let errors = [];
            function getVal(id, label, opts = {}) {
                const el = document.getElementById(id);
                const raw = el.value?.toString().trim();
                if (!raw) {
                    errors.push(`👉 ${label} is required.`);
                    return null;
                }
                const num = parseFloat(raw);
                if (isNaN(num) || num <= 0) {
                    errors.push(`👉 Enter a valid positive number for ${label}.`);
                    return null;
                }
                if (opts.min !== undefined && num < opts.min) errors.push(`👉 ${label} must be ≥ ${opts.min}.`);
                if (opts.max !== undefined && num > opts.max) errors.push(`👉 ${label} must be ≤ ${opts.max}.`);
                return num;
            }

            const age = getVal('age', 'Age', { min: 18, max: 100 });
            const albumin = getVal('albumin', 'Albumin', { min: 10, max: 60 });
            const creatinine = getVal('creatinine', 'Creatinine', { min: 0.1, max: 20 });
            const pt = getVal('pt', 'Prothrombin Time', { min: 5, max: 100 });
            const bilirubin0 = getVal('bilirubin0', 'Bilirubin Day 0', { min: 1, max: 1000 });
            const bilirubin7 = getVal('bilirubin7', 'Bilirubin Day 7', { min: 1, max: 1000 });

            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }

            const renalInsufficiency = creatinine > 1.3 ? 1 : 0;
            const deltaBilirubin = bilirubin7 - bilirubin0;

            const R = (3.19) - (0.101 * age) + (0.147 * albumin) + (0.0165 * deltaBilirubin) - (0.206 * renalInsufficiency) - (0.0065 * bilirubin0) - (0.0096 * pt);
            const lilleScore = Math.exp(-R) / (1 + Math.exp(-R));
            
            placeholder.classList.add('hidden');
            resultValueBox.classList.remove('hidden');

            document.getElementById('rateValue').textContent = lilleScore.toFixed(2);
            
            const meterFill = document.getElementById('meterFill');
            meterFill.style.width = (lilleScore * 100) + '%';
            
            let survivalRate, interpretation;
            if (lilleScore < 0.45) {
                meterFill.style.backgroundColor = '#2ecc71'; // Green
                survivalRate = "approx. 85%";
                interpretation = "✅ <strong>Good Response:</strong> The patient is responding to steroid therapy. Continued treatment is advised.";
            } else {
                meterFill.style.backgroundColor = '#e74c3c'; // Red
                survivalRate = "approx. 25%";
                interpretation = "🚨 <strong>Poor Response:</strong> The patient is not responding to steroid therapy. Discontinuation of steroids and consideration of alternative treatments is recommended.";
            }

            document.getElementById('feedbackContent').innerHTML = `${interpretation}<br>Predicted 6-Month Survival: <strong>${survivalRate}</strong>`;
        }
    </script>
</body>
</html>
{% endblock %}