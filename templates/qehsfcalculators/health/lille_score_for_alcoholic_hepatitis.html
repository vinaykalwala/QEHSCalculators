{% extends 'base.html' %}
{% block title %}Lille Score Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lille Score Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0 10px;
            overflow: hidden;
            position: relative;
        }
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out, background-color 1s ease-in-out;
            border-radius: 6px;
        }
        .meter-threshold {
            position: absolute;
            top: 0;
            left: 45%;
            width: 2px;
            height: 100%;
            background-color: #34495e;
        }
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li, .note-card ol {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon { font-size: 76px; flex-shrink: 0; text-align: center; }
        .error-message { font-size: 24px; line-height: 1.6; }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Lille Score Calculator</h1>
            <p>Assess steroid treatment response in patients with alcoholic hepatitis.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Patient Data</h2>
                <div class="form-group">
                    <label for="age">Age (years)</label>
                    <input type="number" id="age" class="form-input" placeholder="e.g., 55">
                </div>
                <div class="form-group">
                    <label for="albumin">Albumin (g/L)</label>
                    <input type="number" id="albumin" class="form-input" placeholder="e.g., 25">
                </div>
                 <div class="form-group">
                    <label for="creatinine">Creatinine (mg/dL)</label>
                    <input type="number" id="creatinine" step="0.1" class="form-input" placeholder="e.g., 1.1">
                </div>
                <div class="form-group">
                    <label for="pt">Prothrombin Time (PT) (seconds)</label>
                    <input type="number" id="pt" step="0.1" class="form-input" placeholder="e.g., 18.5">
                </div>
                <div class="form-group">
                    <label for="bilirubin0">Bilirubin Day 0 (μmol/L)</label>
                    <input type="number" id="bilirubin0" class="form-input" placeholder="Start of treatment">
                </div>
                 <div class="form-group">
                    <label for="bilirubin7">Bilirubin Day 7 (μmol/L)</label>
                    <input type="number" id="bilirubin7" class="form-input" placeholder="After 7 days of treatment">
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate Lille Score</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Health illustration">
                    <p>Enter patient data to calculate the Lille Score and predict 6-month survival.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>Lille Score</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                    </div>
                    <div class="safety-meter">
                        <div class="meter-threshold" title="Threshold = 0.45"></div>
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Good Response</span>
                        <span>Poor Response</span>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Interpretation</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>What is the Lille Score?</h3>
                <p>
                    The Lille Score is a tool used to predict the 6-month survival rate in patients with alcoholic hepatitis who
                    are undergoing steroid treatment. It helps physicians assess the effectiveness of steroid therapy and
                    determine whether alternative treatments are needed.
                </p>
            </div>
        
            <div class="note-card">
                <h3>Why is the Lille Score Important?</h3>
                <ul class="note-list">
                    <li><strong>Evaluate Treatment Response:</strong> Determines if steroid therapy is improving liver function.
                    </li>
                    <li><strong>Predict Survival:</strong> Estimates the likelihood of survival within 6 months.</li>
                    <li><strong>Guide Clinical Decisions:</strong> Helps doctors decide whether to continue or change treatment
                        strategies.</li>
                </ul>
            </div>
        
            <div class="note-card">
                <h3>How to Use the Lille Score Calculator?</h3>
                <p>The calculator requires the following inputs:</p>
                <ol class="note-list">
                    <li><strong>Age:</strong> The patient's age in years.</li>
                    <li><strong>Prothrombin Time (PT):</strong> Blood clotting time in seconds.</li>
                    <li><strong>Creatinine:</strong> Kidney function in mg/dL.</li>
                    <li><strong>Albumin:</strong> Liver-produced protein in g/L.</li>
                    <li><strong>Bilirubin (Day 0):</strong> Liver function at start of treatment in μmol/L.</li>
                    <li><strong>Bilirubin (Day 7):</strong> Liver function after 7 days of steroid treatment in μmol/L.</li>
                </ol>
                <p>Once all inputs are entered, click "Calculate Lille Score" to get the results.</p>
            </div>
        
            <div class="note-card">
                <h3>Interpreting the Results</h3>
                <ul class="note-list">
                    <li><strong>Score &lt; 0.45:</strong> Indicates a good response to steroid therapy and a higher likelihood
                        of survival (≈85% 6-month survival).</li>
                    <li><strong>Score ≥ 0.45:</strong> Suggests a poor response to steroids; alternative treatments may be
                        needed (≈25% 6-month survival).</li>
                </ul>
            </div>
        
            <div class="note-card">
                <h3>Limitations of the Lille Score</h3>
                <ul class="note-list">
                    <li><strong>Specific to Steroid Treatment:</strong> Only applies to patients undergoing steroid therapy for
                        alcoholic hepatitis.</li>
                    <li><strong>Does Not Replace Clinical Judgment:</strong> Should be used alongside other clinical
                        assessments.</li>
                    <li><strong>Not a Diagnostic Tool:</strong> Predicts survival but does not diagnose the condition.</li>
                </ul>
            </div>
        
            <div class="note-card">
                    <h3>✅ Input Validations</h3>
                    <ul class="note-list">
                        <li><strong>Age:</strong> Enter age in years. Must be between <strong>18 and 120</strong>.</li>
                        <li><strong>Albumin:</strong> Enter albumin level in g/L. Acceptable range is <strong>10 – 60 g/L</strong>.</li>
                        <li><strong>Creatinine:</strong> Enter creatinine in mg/dL. Valid range is <strong>0.3 – 10 mg/dL</strong>.</li>
                        <li><strong>Prothrombin Time (PT):</strong> Enter PT in seconds. Must be <strong>8 – 120 seconds</strong>.</li>
                        <li><strong>Bilirubin Day 0:</strong> Enter baseline bilirubin in μmol/L. Valid range is <strong>5 – 1000 μmol/L</strong>.</li>
                        <li><strong>Bilirubin Day 7:</strong> Enter bilirubin after 7 days in μmol/L. Must be <strong>0 – 1000 μmol/L</strong> and logically consistent with Day 0.</li>
                        <li>All fields are <strong>required</strong>. Empty or invalid entries will trigger errors.</li>
                        <li>Decimal values are allowed where indicated (albumin, creatinine, PT).</li>
                        <li>Ensure bilirubin values are realistic: Day 7 cannot be negative, and large negative changes are unlikely.</li>
                    </ul>
                    <p style="color:#555;"><em>Following these guidelines helps the calculator provide accurate predictions and meaningful results.</em></p>
                </div>

            <div class="note-card">
                <h3>⚠️ Disclaimer</h3>
                <p>
                    This calculator provides estimates for educational purposes. It should not replace medical advice or
                    diagnosis. Always consult healthcare professionals for a comprehensive assessment of your health.
                </p>
            </div>
        </div>

    </div>

<script>
    function calculateAndDisplay() {
        const errorBox = document.getElementById('resultError');
        const errorMessage = document.getElementById('errorMessage');
        const placeholder = document.getElementById('placeholder');
        const resultValueBox = document.getElementById('resultValue');

        // Reset UI
        errorBox.classList.add('hidden');
        resultValueBox.classList.add('hidden');
        placeholder.classList.remove('hidden');

        const fields = ['age', 'albumin', 'creatinine', 'pt', 'bilirubin0', 'bilirubin7'];
        const limits = {
            age: [18, 120],
            albumin: [10, 60],
            creatinine: [0.3, 10],
            pt: [8, 120],
            bilirubin0: [5, 1000],
            bilirubin7: [0, 1000]
        };

        let errors = [];
        let values = {};

        // --- Input Validation ---
        fields.forEach(id => {
            const el = document.getElementById(id);
            const raw = el.value?.toString().trim();
            const label = document.querySelector(`label[for=${id}]`).textContent;

            if (!raw) {
                errors.push(`👉 ${label} is required.`);
            } else {
                const num = parseFloat(raw);
                if (isNaN(num)) {
                    errors.push(`👉 Enter a valid number for ${label}.`);
                } else if (num < limits[id][0] || num > limits[id][1]) {
                    errors.push(`👉 ${label} must be between ${limits[id][0]} and ${limits[id][1]}.`);
                } else {
                    values[id] = num;
                }
            }
        });

        // --- Cross-field validation ---
        if (values.bilirubin0 !== undefined && values.bilirubin7 !== undefined) {
            const deltaBilirubin = values.bilirubin7 - values.bilirubin0;
            if (values.bilirubin7 < 0) {
                errors.push("👉 Bilirubin Day 7 cannot be negative.");
            }
            if (deltaBilirubin < -values.bilirubin0) {
                errors.push("👉 Delta Bilirubin is unrealistic. Check Day 0 and Day 7 values.");
            }
        }

        if (errors.length > 0) {
            errorMessage.innerHTML = errors.join("<br>");
            errorBox.classList.remove("hidden");
            placeholder.classList.add('hidden');
            return;
        }

        // --- Calculate Lille Score ---
        const renalInsufficiency = values.creatinine > 1.3 ? 1 : 0;
        const deltaBilirubin = values.bilirubin7 - values.bilirubin0;

        const R = 3.19
            - (0.101 * values.age)
            + (0.147 * values.albumin)
            + (0.0165 * deltaBilirubin)
            - (0.206 * renalInsufficiency)
            - (0.0065 * values.bilirubin0)
            - (0.0096 * values.pt);

        let lilleScore = Math.exp(-R) / (1 + Math.exp(-R));

        if (isNaN(lilleScore) || !isFinite(lilleScore) || lilleScore < 0 || lilleScore > 1) {
            errorMessage.innerHTML = "❌ Calculation error due to unrealistic inputs. Please check values.";
            errorBox.classList.remove("hidden");
            placeholder.classList.add('hidden');
            return;
        }

        // --- Interpretation ---
        let survivalRate = lilleScore < 0.45 ? "approx. 85%" : "approx. 25%";
        let interpretation = lilleScore < 0.45
            ? "✅ <strong>Good Response:</strong> Patient is responding to therapy. Continued treatment is advised."
            : "🚨 <strong>Poor Response:</strong> Patient is not responding. Consider alternative treatment.";

        // --- Display Results ---
        placeholder.classList.add('hidden');
        resultValueBox.classList.remove('hidden');
        document.getElementById('rateValue').textContent = lilleScore.toFixed(2);

        const meterFill = document.getElementById('meterFill');
        meterFill.style.width = (lilleScore * 100) + '%';
        meterFill.style.backgroundColor = lilleScore < 0.45 ? '#2ecc71' : '#e74c3c';

        document.getElementById('feedbackContent').innerHTML = `
        ${interpretation}<br>
        Predicted 6-Month Survival: <strong>${survivalRate}</strong>
    `;
    }

    // --- Print Function ---
    function printReport() {
        window.print();
    }
</script>

</body>
</html>
{% endblock %}

<!-- 
1. Input Validation Rules (Real-world QEHS perspective)

For medical calculators like Lille Score, accuracy is critical. Improper inputs could lead to wrong predictions, which is analogous to unsafe practices in QEHS where wrong data could mislead safety decisions. Here’s a detailed validation guide:

Field	Unit	Acceptable Range	Decimals	Cross-field checks	Notes / QEHS Justification
Age	years	18 – 120	0	None	Patients younger than 18 or extremely old require separate clinical protocols.
Albumin	g/L	10 – 60	1	None	Normal albumin: 35–50 g/L; extreme outliers indicate lab error or critical condition.
Creatinine	mg/dL	0.3 – 10	2	None	Values above 10 are highly critical; below 0.3 is physiologically improbable.
Prothrombin Time (PT)	seconds	8 – 120	1	None	Normal PT: 11–14s; extremes indicate lab errors or life-threatening conditions.
Bilirubin Day 0	μmol/L	5 – 1000	1	Bilirubin0 < Bilirubin7 in most cases	Extreme low/high values likely lab errors.
Bilirubin Day 7	μmol/L	0 – 1000	1	Bilirubin7 ≥ 0; preferably logical consistency with Bilirubin0	Negative bilirubin is impossible; sudden drop >90% may indicate data error.

Additional rules:

All fields are required.

Decimal inputs must follow the step attribute in HTML.

Cross-field consistency: deltaBilirubin = bilirubin7 - bilirubin0 should not be unrealistically negative (e.g., bilirubin7 < 0 or delta < -bilirubin0).

Avoid division by zero in formula components (currently none, but safeguard in formula is recommended).

2. Output Validation Logic and Thresholds

From QEHS audit perspective, the output must be meaningful and within realistic ranges:

Lille Score: Must be between 0 and 1.

Threshold Interpretation:

<0.45: Good Response → continue therapy.

≥0.45: Poor Response → review therapy.

Survival Rates:

Good: approx. 85%

Poor: approx. 25%

Compliance reasoning: Out-of-bound outputs can mislead clinicians, analogous to KPI misreporting in safety audits.

3. Edge Case Handling
Edge Case	Handling
Empty inputs	Show user-friendly error and stop calculation
Negative numbers	Reject except delta bilirubin (handled in formula)
Extremely high numbers	Warn user (e.g., albumin > 60 g/L, PT > 120s)
Bilirubin7 < 0	Error: impossible physiologically
Creatinine > 10 mg/dL	Alert user: critical renal condition
Non-numeric input	Reject and prompt for numbers
Division by zero	Formula safe; still wrap in isFinite check
NaN / Infinity in Lille Score	Show “Check inputs” message
-->