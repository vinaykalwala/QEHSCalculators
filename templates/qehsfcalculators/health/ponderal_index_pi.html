{% extends 'base.html' %}
{% block title %}Ponderal Index (PI) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ponderal Index (PI) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px; /* Fixed height to match reference */
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0 10px;
            overflow: hidden;
        }
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out, background-color 1s ease-in-out;
            border-radius: 6px;
        }
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon { font-size: 76px; flex-shrink: 0; text-align: center; }
        .error-message { font-size: 24px; line-height: 1.6; }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Ponderal Index (PI) Calculator</h1>
            <p>Calculate your body composition using a three-dimensional measure of weight and height.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Your Details</h2>
                <div class="form-group">
                    <label for="age-group">Age Group</label>
                    <select id="age-group" class="form-select">
                        <option value="adult">Adult</option>
                        <option value="child">Child / Infant</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="height">Height (cm)</label>
                    <input type="number" id="height" class="form-input" placeholder="Enter height in cm">
                </div>
                <div class="form-group">
                    <label for="weight">Weight (kg)</label>
                    <input type="number" id="weight" class="form-input" placeholder="Enter weight in kg">
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate Ponderal Index</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Health illustration">
                    <p>Select an age group and enter your measurements to calculate the Ponderal Index.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>Ponderal Index (PI)</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.0</div>
                    </div>
                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span id="label-low">Underweight</span>
                        <span id="label-normal">Normal</span>
                        <span id="label-high">Overweight</span>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Interpretation</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>üìå What is the Ponderal Index (PI)?</h3>
                <p>
                    The Ponderal Index (PI) is an improved version of the Body Mass Index (BMI). While BMI uses height squared
                    (height¬≤),
                    PI uses height cubed (height¬≥), making it more accurate for assessing body composition in three-dimensional
                    terms.
                    PI is particularly useful for very tall or short individuals, as BMI tends to misclassify them.
                </p>
            </div>
        
            <div class="note-card">
                <h3>üìê Ponderal Index Formula</h3>
                <p>The formula depends on the age group:</p>
                <ul class="note-list">
                    <li><strong>For Adults:</strong> PI = weight (kg) / height (m)¬≥</li>
                    <li><strong>For Children/Infants:</strong> PI = weight (g) / height (cm)¬≥</li>
                </ul>
            </div>
        
            <div class="note-card">
                <h3>üìä Normal Ponderal Index Ranges</h3>
                <ul class="note-list">
                    <li><strong>Adults:</strong> 11‚Äì15 (normal range)</li>
                    <li><strong>Newborn Babies:</strong> 2.2‚Äì3.0 (normal range)</li>
                </ul>
            </div>
        
            <div class="note-card">
                <h3>üßæ Interpreting Your Results</h3>
                <ul class="note-list">
                    <li><strong>For Adults:</strong>
                        <ul>
                            <li><strong>PI &lt; 11:</strong> Underweight ‚Äì May suggest malnutrition or health issues.</li>
                            <li><strong>11 ‚â§ PI ‚â§ 15:</strong> Normal ‚Äì Healthy weight proportional to height.</li>
                            <li><strong>PI &gt; 15:</strong> Overweight ‚Äì Indicates excess body mass.</li>
                        </ul>
                    </li>
                    <li><strong>For Children/Infants:</strong>
                        <ul>
                            <li><strong>PI &lt; 2.2:</strong> Underweight ‚Äì Possible developmental or nutrition issues.</li>
                            <li><strong>2.2 ‚â§ PI ‚â§ 3.0:</strong> Normal ‚Äì Healthy, proportionate growth.</li>
                            <li><strong>PI &gt; 3.0:</strong> Overweight ‚Äì May indicate early obesity risk.</li>
                        </ul>
                    </li>
                </ul>
            </div>
        
            <div class="note-card">
                <h3>üí° What Can You Do?</h3>
                <ul class="note-list">
                    <li><strong>Consult a Doctor:</strong> Seek professional evaluation.</li>
                    <li><strong>Adopt a Healthy Lifestyle:</strong> Focus on diet, exercise, and stress management.</li>
                    <li><strong>Monitor Progress:</strong> Track weight, height, and health regularly.</li>
                </ul>
            </div>
        
            <!-- Note Section for Input Validations -->
            <div class="note-card">
                <h3>‚úÖ Input Validations</h3>
                <ul class="note-list">
                    <li><strong>Height:</strong> Must be a positive number in centimeters (valid range: <em>30 cm ‚Äì 250 cm</em>).
                    </li>
                    <li><strong>Weight:</strong> Must be a positive number in kilograms (valid range: <em>1 kg ‚Äì 250 kg</em>).</li>
                    <li><strong>Age Group:</strong> Choose either <em>Adult</em> or <em>Child</em> before calculating.</li>
                    <li>‚ö†Ô∏è Inputs that are <em>blank, zero, negative, or unrealistically high</em> will be flagged with an error
                        message.</li>
                    <li>‚úÖ Only valid inputs will allow the Ponderal Index (PI) to be calculated.</li>
                </ul>
                <p style="margin-top: 12px; color: #555; font-size: 0.95em;">
                    These rules ensure the calculator provides <strong>accurate and reliable PI results</strong> for both adults and
                    children.
                </p>
            </div>

            <div class="note-card">
                <h3>‚ö†Ô∏è Disclaimer</h3>
                <p>
                    This calculator provides estimates based on the Ponderal Index formula and is not a substitute for medical
                    advice.
                    Always consult a healthcare provider for personalized recommendations.
                </p>
            </div>
        </div>

    </div>

    <script>
        function calculateAndDisplay() {
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');

            // Reset UI
            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');

            let errors = [];

            // Helper: get and validate numeric inputs
            function getVal(id, label, maxLimit = 300) {
                const el = document.getElementById(id);
                const raw = el.value?.toString().trim();

                if (!raw) {
                    errors.push(`üëâ ${label} is required.`);
                    return null;
                }

                const num = parseFloat(raw);
                if (isNaN(num) || num <= 0) {
                    errors.push(`üëâ Enter a valid positive number for ${label}.`);
                    return null;
                }

                if (num > maxLimit) {
                    errors.push(`üëâ ${label} seems unrealistically high. Please check the input.`);
                }

                return num;
            }

            // Collect inputs
            const ageGroup = document.getElementById('age-group').value;
            const heightCm = getVal('height', 'Height (cm)', 250);
            const weightKg = getVal('weight', 'Weight (kg)', 250);

            // If validation failed, show errors
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }

            // Calculation variables
            let pi, interpretation, meterMin, meterMax, lowRange, highRange;

            if (ageGroup === 'adult') {
                // Adult PI Formula: kg / m¬≥
                const heightM = heightCm / 100;
                pi = weightKg / Math.pow(heightM, 3);

                // Adult PI reference range
                lowRange = 11;
                highRange = 15;
                meterMin = 8;
                meterMax = 18;

                if (pi < lowRange) {
                    interpretation = "‚ö†Ô∏è Underweight: Your PI is below the healthy adult range.";
                } else if (pi <= highRange) {
                    interpretation = "‚úÖ Normal: Your PI is within the healthy adult range.";
                } else {
                    interpretation = "‚ö†Ô∏è Overweight: Your PI is above the healthy adult range.";
                }
            } else {
                // Child PI Formula: (100 √ó g) / cm¬≥
                const weightG = weightKg * 1000;
                pi = (100 * weightG) / Math.pow(heightCm, 3);

                // Child PI reference range
                lowRange = 2.2;
                highRange = 3.0;
                meterMin = 1.5;
                meterMax = 3.5;

                if (pi < lowRange) {
                    interpretation = "‚ö†Ô∏è Underweight: The PI is below the typical range for children.";
                } else if (pi <= highRange) {
                    interpretation = "‚úÖ Normal: The PI is within the typical range for children.";
                } else {
                    interpretation = "‚ö†Ô∏è Overweight: The PI is above the typical range for children.";
                }
            }

            // Show result
            placeholder.classList.add('hidden');
            resultValueBox.classList.remove('hidden');

            document.getElementById('rateValue').textContent = pi.toFixed(2);
            document.getElementById('feedbackContent').textContent = interpretation;

            // Update meter dynamically
            const meterFill = document.getElementById('meterFill');
            let pct = ((pi - meterMin) / (meterMax - meterMin)) * 100;
            pct = Math.max(0, Math.min(100, pct));
            meterFill.style.width = pct + '%';

            if (pi < lowRange) {
                meterFill.style.backgroundColor = '#f39c12'; // Yellow - Underweight
            } else if (pi <= highRange) {
                meterFill.style.backgroundColor = '#2ecc71'; // Green - Normal
            } else {
                meterFill.style.backgroundColor = '#e74c3c'; // Red - Overweight
            }

            // Update meter labels for clarity
            document.getElementById('label-low').textContent = `Underweight (<${lowRange})`;
            document.getElementById('label-normal').textContent = `Normal (${lowRange}-${highRange})`;
            document.getElementById('label-high').textContent = `Overweight (>${highRange})`;
        }

        function printReport() {
            window.print();
        }
    </script>

</body>
</html>
{% endblock %}

<!-- 
1. Input Validation Rules (Real-World Perspective)

From a QEHS/Fire Safety + Occupational Health angle, data integrity is critical. Unsafe, unrealistic, or inconsistent inputs could lead to misleading health risk assessments.

Age Group Selection

Must be explicitly selected: Adult or Child/Infant.

Prevent default/blank selection.

Adults ‚Üí thresholds based on kg & meters.

Children/Infants ‚Üí thresholds based on grams & cm.

Height

Must be numeric.

Units: cm (always).

Range:

Adults: 50‚Äì272 cm (realistic human extremes).

Children/infants: 20‚Äì120 cm (newborn to toddler).

Decimals allowed: 1 decimal place for accuracy.

Weight

Must be numeric.

Units: kg for adults, kg for children (converted internally).

Range:

Adults: 2‚Äì500 kg (covers clinical edge cases).

Children/infants: 0.5‚Äì30 kg.

Decimals allowed: up to 1 decimal place.

Cross-Field Logic

Height cannot be too low or too high for age group.

Weight must be reasonable for height (e.g., 50 cm tall adult weighing 200 kg ‚Üí flag).

2. Output Validation Logic & Thresholds

Ponderal Index Formula

Adults: PI = weight(kg) / height(m)^3

Children: PI = weight(g) / height(cm)^3

Adult PI Ranges (clinical norms, adapted for occupational health screenings):

< 11 ‚Üí Underweight (possible malnutrition/health risk).

11‚Äì15 ‚Üí Normal.

15 ‚Üí Overweight (possible obesity-related risks).

Child PI Ranges:

< 2.2 ‚Üí Underweight.

2.2‚Äì3.0 ‚Üí Normal.

3.0 ‚Üí Overweight.

Error Guard: If PI returns NaN, Infinity, or negative, display error ‚Üí "Invalid input combination".
-->