{% extends 'base.html' %}
{% block title %}Noise Exposure Level Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noise Exposure Level Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px; /* Fixed height to match reference */
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        .rate-label {
            color: #2980b9;
            font-weight: bold;
            font-size: 20px;
        }
        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0 10px;
            overflow: hidden;
        }
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out, background-color 1s ease-in-out;
            border-radius: 6px;
        }
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon { font-size: 76px; flex-shrink: 0; text-align: center; }
        .error-message { font-size: 24px; line-height: 1.6; }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Noise Exposure Level Calculator</h1>
            <p>Calculate the time-averaged noise exposure (Leq) from multiple sound levels.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Sound Level Measurements</h2>
                <div class="form-group">
                    <label for="soundLevel1">Sound Level 1 (dB)</label>
                    <input type="number" id="soundLevel1" class="form-input" placeholder="Enter first measurement">
                </div>
                <div class="form-group">
                    <label for="soundLevel2">Sound Level 2 (dB)</label>
                    <input type="number" id="soundLevel2" class="form-input" placeholder="Enter second measurement">
                </div>
                <div class="form-group">
                    <label for="soundLevel3">Sound Level 3 (dB)</label>
                    <input type="number" id="soundLevel3" class="form-input" placeholder="Enter third measurement">
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate Leq</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Health illustration">
                    <p>Enter three sound level readings to calculate the equivalent continuous sound level.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>Equivalent Sound Level (Leq)</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0</div>
                        <div class="rate-label">dB</div>
                    </div>
                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Safe</span>
                        <span>Moderate</span>
                        <span>High Risk</span>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Interpretation</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>üìå About Equivalent Sound Level (Leq)</h3>
                <p>
                    This calculator helps determine the <strong>Equivalent Continuous Sound Level (Leq)</strong>, which is a
                    measure used to quantify noise exposure over a specific period.
                    It is particularly useful in occupational health and safety to assess the impact of noise on workers and
                    ensure compliance with regulatory standards.
                </p>
                <p>
                    Noise exposure is not always constant; it can vary over time. For example, a worker might be exposed to
                    different sound levels throughout the day, such as loud machinery noise, moderate background noise, and
                    quieter periods.
                    To evaluate the overall impact of these varying noise levels, we use a method that averages the noise
                    exposure into a single value. This value represents the continuous sound level that would deliver the same
                    total energy as the varying noise levels over the same period.
                </p>
            </div>
        
            <div class="note-card">
                <h3>‚ùó Why is Leq Important?</h3>
                <ul class="note-list">
                    <li><strong>Health and Safety:</strong> Prolonged exposure to high noise levels can lead to hearing loss,
                        stress, and other health issues. By calculating the equivalent continuous sound level, employers can
                        assess whether noise levels are within safe limits and take necessary precautions.</li>
                    <li><strong>Regulatory Compliance:</strong> Many occupational health regulations set limits on permissible
                        noise exposure. The Leq helps organizations ensure they are meeting these legal requirements.</li>
                    <li><strong>Risk Assessment:</strong> Understanding the average noise exposure helps identify high-risk
                        areas or tasks, allowing for targeted noise control measures.</li>
                </ul>
            </div>
        
            <div class="note-card">
                <h3>üìä Why do we divide by the number of measurements (n)?</h3>
                <p>
                    The formula for Leq includes dividing by the number of measurements (<strong>n</strong>) to account for the
                    <strong>time-averaging</strong> of sound levels.
                    This ensures that the result represents the <strong>average energy</strong> of the noise over the measured
                    period.
                    Without dividing by <strong>n</strong>, the calculation would simply sum the energy of all measurements,
                    which would not accurately reflect the average exposure over time.
                </p>
                <p>
                    This approach ensures that the Leq value is a true representation of the average noise exposure, taking into
                    account both the intensity and duration of the noise.
                </p>
            </div>

            <div class="note-card">
                <h3>‚ÑπÔ∏è Input Validations</h3>
                <p>
                    To ensure accurate and safe results, the calculator checks your input values before performing the calculation:
                </p>
                <ul class="note-list">
                    <li><strong>Required Fields:</strong> All three sound levels must be entered. Leaving a field blank will show an
                        error.</li>
                    <li><strong>Valid Numbers Only:</strong> Each sound level must be entered as a number (e.g., 75, 82.5). Text or
                        symbols are not accepted.</li>
                    <li><strong>No Negative Values:</strong> Sound levels cannot be less than 0 dB, since negative decibels are not
                        meaningful in this context.</li>
                    <li><strong>Realistic Range Check:</strong> Acceptable values are between <strong>30 dB</strong> (quiet room)
                        and <strong>200 dB</strong> (extremely loud).
                        Anything outside this range is flagged as unrealistic.</li>
                    <li><strong>Error Messages:</strong> If an invalid entry is made, a clear message will guide you to correct it.
                    </li>
                </ul>
                <p>
                    ‚úÖ Following these rules ensures the calculator works properly and gives results that reflect real-world
                    conditions.
                </p>
            </div>

            <div class="note-card">
                <h3>üõ†Ô∏è How to Use This Calculator</h3>
                <ul class="note-list">
                    <li><strong>Sound Level 1 (L1):</strong> Enter the first sound level measurement (in dB).</li>
                    <li><strong>Sound Level 2 (L2):</strong> Enter the second sound level measurement (in dB).</li>
                    <li><strong>Sound Level 3 (L3):</strong> Enter the third sound level measurement (in dB).</li>
                </ul>
                <p>
                    After entering the values, click the <strong>Calculate Noise Exposure Level</strong> button.
                    The result will show the equivalent continuous sound level (Leq), which represents the average noise
                    exposure over the measured period.
                </p>
            </div>
        </div>

    </div>

    <script>
        function calculateAndDisplay() {
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');

            // Reset UI
            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');

            let errors = [];

            // Helper function with validations
            function getVal(id, label, opts = {}) {
                const el = document.getElementById(id);
                const raw = el.value?.toString().trim();
                if (!raw) {
                    errors.push(`üëâ ${label} is required.`);
                    return null;
                }
                const num = parseFloat(raw);
                if (isNaN(num) || num < 0) {
                    errors.push(`üëâ Enter a valid non-negative number for ${label}.`);
                    return null;
                }
                if (opts.min !== undefined && num < opts.min) {
                    errors.push(`üëâ ${label} must be ‚â• ${opts.min} dB.`);
                }
                if (opts.max !== undefined && num > opts.max) {
                    errors.push(`üëâ ${label} must be ‚â§ ${opts.max} dB. Please re-check the value.`);
                }
                return num;
            }

            // Collect inputs with realistic bounds (30‚Äì200 dB)
            const l1 = getVal('soundLevel1', 'Sound Level 1', { min: 30, max: 200 });
            const l2 = getVal('soundLevel2', 'Sound Level 2', { min: 30, max: 200 });
            const l3 = getVal('soundLevel3', 'Sound Level 3', { min: 30, max: 200 });

            // If errors, display and exit
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }

            // Calculate Leq (Equivalent Continuous Sound Level)
            const n = 3;
            const leq = 10 * Math.log10(
                (Math.pow(10, l1 / 10) + Math.pow(10, l2 / 10) + Math.pow(10, l3 / 10)) / n
            );

            // Show results
            placeholder.classList.add('hidden');
            resultValueBox.classList.remove('hidden');

            document.getElementById('rateValue').textContent = leq.toFixed(1);

            // Fill meter (scale from 50‚Äì110 dB for workplace context)
            const meterFill = document.getElementById('meterFill');
            const minDb = 50;
            const maxDb = 110;
            let pct = ((leq - minDb) / (maxDb - minDb)) * 100;
            pct = Math.max(0, Math.min(100, pct));
            meterFill.style.width = pct + '%';

            // Interpretation (aligned with OSHA/NIOSH action levels)
            let interpretation = "";
            if (leq < 85) {
                meterFill.style.backgroundColor = '#2ecc71'; // Green
                interpretation = "‚úÖ <strong>Safe Level:</strong> Exposure is below the OSHA action level. Hearing protection is not typically required.";
            } else if (leq < 100) {
                meterFill.style.backgroundColor = '#f39c12'; // Yellow
                interpretation = "‚ö†Ô∏è <strong>High Level:</strong> Exceeds safe exposure. Hearing protection is strongly recommended and usually required by regulations.";
            } else {
                meterFill.style.backgroundColor = '#e74c3c'; // Red
                interpretation = "üö® <strong>Dangerously High:</strong> Hazardous noise level. Hearing protection is mandatory and exposure must be strictly limited.";
            }

            document.getElementById('feedbackContent').innerHTML = interpretation;
        }

        function printReport() {
            window.print();
        }
    </script>

</body>
</html>
{% endblock %}

<!-- 
1. Input Validation Rules (QEHS & Fire Safety Perspective)

Based on OSHA (29 CFR 1910.95), ISO 9612, NFPA guidelines, and industry norms:

Acceptable Ranges

Sound Level (dB):

Minimum: 30 dB (below this, it‚Äôs close to background noise or inaudible in workplace settings).

Maximum: 140 dB (above this is extreme/unrealistic for occupational exposure; anything higher is immediately hazardous).

‚ö†Ô∏è Although you used 200 dB in your code, real-world workplace readings rarely exceed 140 dB.

Allowed Decimals

Sound level meters typically measure to 1 decimal place (e.g., 85.3 dB).

Accept inputs up to 1 decimal place. Reject values like 85.345.

Logical Consistency

All three values must be entered; partial inputs are invalid.

No negative values allowed.

If all three readings are identical, the result should equal that value (sanity check).

Inputs cannot be zero (0 dB is complete silence, unrealistic in occupational environments).

2. Output Validation Logic & Threshold Explanations

Aligned with OSHA, ISO 1999, and NIOSH exposure limits:

Leq < 70 dB ‚Üí ‚úÖ Safe Zone

Normal conversation level, no risk.

70‚Äì84.9 dB ‚Üí ‚ö†Ô∏è Moderate

Long-term exposure may cause discomfort; monitoring recommended.

85‚Äì99.9 dB ‚Üí üö® High Risk

Above OSHA‚Äôs action level (85 dB). Hearing protection required.

‚â•100 dB ‚Üí ‚ùå Dangerously High

Risk of immediate hearing damage; strict controls & PPE mandatory.

3. Edge Case Validations

Division by zero: Ensure number of measurements (n) is never zero.

Outliers: Reject inputs <30 dB or >140 dB.

Unrealistic combos: If one reading is 30 dB and another 140 dB, highlight that it indicates either measurement error or extreme variation in the environment.

All blanks: Show a clear error message.

Decimals > 1 place: Round and warn user.
-->