{% extends 'base.html' %}
{% block title %}Relative Fat Mass (RFM) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relative Fat Mass (RFM) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        .rate-label {
            color: #2980b9;
            font-weight: bold;
            font-size: 20px;
        }
        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0 10px;
            overflow: hidden;
        }
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out, background-color 1s ease-in-out;
            border-radius: 6px;
        }
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        /* Table styles */
        .custom-table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .custom-table thead {
            background-color: #1560bd;
            color: white;
        }
        .custom-table th, .custom-table td {
            padding: 12px 16px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .custom-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon { font-size: 76px; flex-shrink: 0; text-align: center; }
        .error-message { font-size: 24px; line-height: 1.6; }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Relative Fat Mass (RFM) Calculator</h1>
            <p>Estimate your body fat percentage using the height-to-waist ratio method.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Your Measurements</h2>
                <div class="form-group">
                    <label for="gender">Gender</label>
                    <select id="gender" class="form-select">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="height">Height (cm)</label>
                    <input type="number" id="height" class="form-input" placeholder="e.g., 175 cm">
                </div>
                <div class="form-group">
                    <label for="waist">Waist Circumference (cm)</label>
                    <input type="number" id="waist" class="form-input" placeholder="e.g., 85 cm">
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate Body Fat %</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Health illustration">
                    <p>Enter your gender and measurements to calculate your Relative Fat Mass.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>Relative Fat Mass (RFM)</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.0</div>
                        <div class="rate-label">%</div>
                    </div>
                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Lean</span>
                        <span>Healthy</span>
                        <span>Overfat</span>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Interpretation</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                     <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <!-- About RFM -->
            <div class="note-card">
                <h3>üìå What Is Relative Fat Mass (RFM)?</h3>
                <p>
                    RFM is a scientifically validated method to estimate body fat percentage using only
                    <strong>height</strong> and <strong>waist circumference</strong>. Unlike BMI, which ignores body
                    composition,
                    RFM accounts for central fat distribution‚Äîa key indicator of metabolic health risks.
                </p>
            </div>
        
            <!-- How it Works -->
            <div class="note-card">
                <h3>üîç How Does It Work?</h3>
                <p>
                    RFM calculates body fat by comparing your waist size to your height. Since abdominal fat is closely linked
                    to health risks (e.g., heart disease, diabetes), this method is more accurate than BMI for identifying
                    obesity.
                </p>
                <ul class="note-list">
                    <li><strong>For Men:</strong> Uses a height-to-waist ratio adjusted for male physiology.</li>
                    <li><strong>For Women:</strong> Accounts for naturally higher essential fat levels.</li>
                </ul>
            </div>
        
            <!-- Parameters / Measurement Instructions -->
            <div class="note-card">
                <h3>üìè Parameters & Measurement Instructions</h3>
                <ul class="note-list">
                    <li><strong>Height:</strong> Stand straight against a wall without shoes, measure from floor to top of head.
                    </li>
                    <li><strong>Waist (Men):</strong> Measure horizontally at navel level, keeping tape parallel to the floor.
                    </li>
                    <li><strong>Waist (Women):</strong> Measure at the narrowest part of torso (usually above the navel).</li>
                    <li><strong>For All:</strong> Take measurements in the morning before eating, with relaxed abdomen.</li>
                </ul>
            </div>
        
            <!-- Interpretation Guide -->
            <div class="note-card">
                <h3>üìã RFM Interpretation Guide</h3>
                <div style="overflow-x:auto;">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Men (Body Fat %)</th>
                                <th>Women (Body Fat %)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="extreme-low">
                                <td><strong>Extremely Low Fat</strong></td>
                                <td>&lt; 2%</td>
                                <td>&lt; 10%</td>
                            </tr>
                            <tr class="essential-fat">
                                <td><strong>Essential Fat</strong> (Minimum for health)</td>
                                <td>2‚Äì5%</td>
                                <td>10‚Äì13%</td>
                            </tr>
                            <tr class="athletes">
                                <td><strong>Athletes</strong> (Lean, muscular)</td>
                                <td>6‚Äì13%</td>
                                <td>12‚Äì20%</td>
                            </tr>
                            <tr class="fitness">
                                <td><strong>Fitness</strong> (Healthy, active)</td>
                                <td>14‚Äì17%</td>
                                <td>21‚Äì24%</td>
                            </tr>
                            <tr class="average">
                                <td><strong>Average</strong> (Moderate fat)</td>
                                <td>18‚Äì24%</td>
                                <td>25‚Äì31%</td>
                            </tr>
                            <tr class="obese">
                                <td><strong>Obese</strong> (High health risk)</td>
                                <td>25%+</td>
                                <td>32%+</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="table-note">
                    <p><strong>Note:</strong> These ranges are general guidelines. Individual health assessments should consider
                        multiple factors.</p>
                </div>
            </div>
        
            <!-- Why RFM is better -->
            <div class="note-card">
                <h3>üìö Why RFM Beats BMI</h3>
                <p>
                    BMI only considers weight and height, lumping muscle and fat together.
                    RFM focuses on <strong>abdominal fat</strong>‚Äîthe dangerous kind linked to diabetes and heart disease.
                    Studies show RFM is <em>more accurate</em> for predicting health risks than BMI.
                </p>
            </div>
        
            <!-- Important Notes -->
            <div class="note-card">
                <h3>‚ö†Ô∏è Important Notes</h3>
                <ul class="note-list">
                    <li><strong>Waist Measurement Tips:</strong> Measure at the navel (men) or narrowest part (women). Keep tape
                        snug but not tight.</li>
                    <li><strong>Limitations:</strong> RFM may underestimate fat in very muscular individuals or overestimate in
                        older adults with muscle loss.</li>
                    <li><strong>Not for Children/Pregnant Women:</strong> Specialized tools are recommended for these groups.
                    </li>
                </ul>
            </div>
        
            <!-- When to Consult -->
            <div class="note-card">
                <h3>üö® When to Consult a Doctor</h3>
                <p>
                    If your RFM falls in the <strong>Obese</strong> range or you have concerns about metabolic health (e.g.,
                    high blood pressure, prediabetes),
                    seek professional assessment. Tools like DEXA scans or skinfold tests provide more precise measurements.
                </p>
            </div>
        
            <div class="note-card" style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 12px; background: #f9f9f9;">
                <h3>üìå Input Validations ‚Äì Please Read Before Using</h3>
                <ul style="line-height: 1.6; margin-left: 20px;">
                    <li><strong>Gender:</strong> Must be selected (Male or Female).</li>
                    <li><strong>Height (cm):</strong> Acceptable range is <b>120 ‚Äì 250 cm</b>. Values outside this range will be rejected.</li>
                    <li><strong>Waist Circumference (cm):</strong> Acceptable range is <b>40 ‚Äì 200 cm</b>. Values outside this range will be rejected.</li>
                    <li><strong>Logical Rule:</strong> Waist circumference <b>must always be smaller than height</b> (for realistic body proportions).</li>
                    <li><strong>Decimals:</strong> Up to 1 decimal place allowed (e.g., <code>172.5</code> cm).</li>
                    <li><strong>Output Safety:</strong> 
                        <ul>
                            <li>For Males ‚Üí Body fat % must be between <b>2% ‚Äì 45%</b>.</li>
                            <li>For Females ‚Üí Body fat % must be between <b>10% ‚Äì 55%</b>.</li>
                            <li>Values outside these ranges are flagged as <b>unrealistic</b>.</li>
                        </ul>
                    </li>
                    <li><strong>Edge Cases Handled:</strong> Division by zero, empty fields, negative numbers, or unrealistic waist/height combinations will show an error.</li>
                </ul>
                <p style="margin-top: 10px; font-size: 0.9em; color: #555;">
                    ‚ö†Ô∏è These validations follow occupational health, fitness, and compliance guidelines 
                    (OSHA, ISO 45001, WHO health safety ranges). Entering values outside the above ranges may lead 
                    to <b>inaccurate or unsafe interpretations</b>.
                </p>
            </div>

            <!-- Disclaimer -->
            <div class="note-card">
                <h3>‚ö†Ô∏è Disclaimer</h3>
                <p>
                    This calculator provides an <strong>estimate</strong> and is not a substitute for professional medical
                    assessment.
                    For precise body composition, gold-standard methods such as <strong>DEXA scans</strong> are recommended.
                    Always consult a healthcare provider for personalized advice.
                </p>
            </div>
        </div>

    </div>

    <script>
        function calculateAndDisplay() {
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');
            const rateValue = document.getElementById('rateValue');
            const feedbackContent = document.getElementById('feedbackContent');
            const meterFill = document.getElementById('meterFill');

            // Reset UI
            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');
            errorMessage.innerHTML = "";

            let errors = [];

            function getVal(id, label, opts = {}) {
                const el = document.getElementById(id);
                const raw = el.value?.toString().trim();
                if (!raw) {
                    errors.push(`üëâ ${label} is required.`);
                    return null;
                }
                const num = parseFloat(raw);
                if (isNaN(num) || num <= 0) {
                    errors.push(`üëâ Enter a valid positive number for ${label}.`);
                    return null;
                }
                if (opts.min !== undefined && num < opts.min) errors.push(`üëâ ${label} must be ‚â• ${opts.min}.`);
                if (opts.max !== undefined && num > opts.max) errors.push(`üëâ ${label} must be ‚â§ ${opts.max}.`);
                return num;
            }

            // Inputs
            const gender = document.getElementById('gender').value;
            const height = getVal('height', 'Height (cm)', { min: 120, max: 250 });
            const waist = getVal('waist', 'Waist Circumference (cm)', { min: 40, max: 200 });

            // Gender validation
            if (!gender || (gender !== "male" && gender !== "female")) {
                errors.push("üëâ Please select a valid gender.");
            }

            // Logical validation
            if (height && waist && waist >= height) {
                errors.push("üëâ Waist circumference must be smaller than height.");
            }

            // Show errors if any
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }

            // Calculate RFM
            let rfm = (gender === "male")
                ? 64 - (20 * (height / waist))
                : 76 - (20 * (height / waist));
            rfm = parseFloat(rfm.toFixed(1));

            // Output validation
            if ((gender === "male" && (rfm < 2 || rfm > 45)) ||
                (gender === "female" && (rfm < 10 || rfm > 55))) {
                errorMessage.innerHTML = "‚ùå Unrealistic body fat result. Please recheck inputs.";
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }

            // Show result
            placeholder.classList.add('hidden');
            resultValueBox.classList.remove('hidden');
            rateValue.textContent = rfm;

            // Meter fill scaling (max 50% for visual clarity)
            const maxPercent = 50;
            meterFill.style.width = Math.min(100, (rfm / maxPercent) * 100) + '%';

            // Interpretation
            let interpretation = "";
            if (gender === "male") {
                if (rfm < 2) interpretation = "‚ùÑÔ∏è Extremely low fat ‚Äî medical concern.";
                else if (rfm <= 5) interpretation = "üèãÔ∏è Essential fat (Athlete-level leanness).";
                else if (rfm <= 13) interpretation = "üí™ Athletic (Lean and muscular).";
                else if (rfm <= 17) interpretation = "üëç Fitness (Healthy range).";
                else if (rfm <= 24) interpretation = "üÜó Average (Moderate fat).";
                else interpretation = "‚ö†Ô∏è Obese (High health risk).";
            } else {
                if (rfm < 10) interpretation = "‚ùÑÔ∏è Extremely low fat ‚Äî medical concern.";
                else if (rfm <= 13) interpretation = "üèãÔ∏è Essential fat (Athlete-level leanness).";
                else if (rfm <= 20) interpretation = "üí™ Athletic (Lean and muscular).";
                else if (rfm <= 24) interpretation = "üëç Fitness (Healthy range).";
                else if (rfm <= 31) interpretation = "üÜó Average (Moderate fat).";
                else interpretation = "‚ö†Ô∏è Obese (High health risk).";
            }

            feedbackContent.textContent = interpretation;

            // Meter color logic
            if ((gender === "male" && rfm >= 25) || (gender === "female" && rfm >= 32)) {
                meterFill.style.backgroundColor = '#e74c3c'; // Red (obese risk)
            } else if ((gender === "male" && rfm > 17) || (gender === "female" && rfm > 24)) {
                meterFill.style.backgroundColor = '#f39c12'; // Orange (average to high)
            } else {
                meterFill.style.backgroundColor = '#2ecc71'; // Green (healthy)
            }
        }

        function printReport() {
            window.print();
        }
    </script>

</body>
</html>
{% endblock %}

<!-- 
1. Real-World QEHS/Fire Safety Input‚ÄìOutput Analysis

In occupational health & safety, anthropometric calculators (like RFM) are used for:

Health risk profiling ‚Üí Obesity/underweight workers may be at higher risk in heat stress, confined spaces, firefighting, chemical PPE use.

Ergonomics ‚Üí Too high or low fat % can affect lifting capacity, mobility, endurance.

Fire safety/emergency response ‚Üí Evacuation times, self-rescue, and PPE fit may depend on body composition.

So, input validation must prevent unrealistic or unsafe values that could bias safety reports.

2. Validation Rules (Based on Industry Standards & Medical Guidelines)
Inputs

Gender (Sex)

Must be male or female. No blank selection allowed.

Height (cm)

Unit: centimeters only.

Acceptable range: 120 cm ‚Äì 250 cm (below = dwarfism/extreme error, above = unrealistic).

Allowed decimals: up to 1 decimal place (e.g., 175.5 cm).

Waist Circumference (cm)

Unit: centimeters only.

Acceptable range: 40 cm ‚Äì 200 cm (below = impossible, above = severe obesity/extreme outlier).

Allowed decimals: up to 1 decimal place.

Cross-Field Validations

Waist must always be smaller than height. (Otherwise the ratio breaks down, producing negative/unrealistic RFM.)

If waist / height > 0.9 ‚Üí flag as "extreme obesity ‚Äî validate measurement".

3. Output Validation Logic

Formula:

Male: RFM = 64 ‚Äì (20 √ó (height / waist))

Female: RFM = 76 ‚Äì (20 √ó (height / waist))

Acceptable Output Range (based on WHO/NIH standards):

Males: 2% ‚Äì 45%

Females: 10% ‚Äì 55%
(Anything beyond ‚Üí unrealistic ‚Üí trigger error message ‚ÄúMeasurement error or outlier detected.‚Äù)

Thresholds for Interpretation (Aligned with ACSM & WHO):

Male

<2% ‚Üí ‚ùå Extremely low, medical concern

2‚Äì5% ‚Üí Essential fat (athletes)

6‚Äì13% ‚Üí Athletic

14‚Äì17% ‚Üí Fitness

18‚Äì24% ‚Üí Average

25% ‚Üí Obese

Female

<10% ‚Üí ‚ùå Extremely low

10‚Äì13% ‚Üí Essential fat

14‚Äì20% ‚Üí Athletic

21‚Äì24% ‚Üí Fitness

25‚Äì31% ‚Üí Average

32% ‚Üí Obese

4. Edge Case Validations

Division by zero: If waist = 0 ‚Üí stop, error message.

Negative inputs: Reject immediately.

Height < waist: Reject (produces negative RFM).

Extremely high values (outliers): Example 400 cm height, 300 cm waist ‚Üí reject.

Decimal overflow: Limit output to 2 decimal places.

Empty inputs: Must show error prompt, not calculation.
-->