{% extends 'base.html' %}
{% block title %}Kidney Failure Risk Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kidney Failure Risk Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        .rate-label {
            color: #2980b9;
            font-weight: bold;
            font-size: 20px;
        }
        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0 10px;
            overflow: hidden;
        }
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out, background-color 1s ease-in-out;
            border-radius: 6px;
        }
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section & Table */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        .custom-table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .custom-table thead {
            background-color: #1560bd;
            color: white;
        }
        .custom-table th, .custom-table td {
            padding: 12px 16px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .custom-table tr:nth-child(even):not(.section-row) {
            background-color: #f9f9f9;
        }
        .section-row td {
            background: linear-gradient(#1560bd,#000040);
            font-weight: bold;
            color: #fff;
            font-size: 1rem;
            text-align: left;
        }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon {
            font-size: 76px; flex-shrink: 0; text-align: center;
        }
        .error-message {
            font-size: 24px; line-height: 1.6;
        }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Kidney Failure Risk Calculator</h1>
            <p>Estimate the 5-year probability of progression to kidney failure for patients with CKD.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Clinical Parameters</h2>
                <div class="form-group">
                    <label for="age">Age (years)</label>
                    <input type="number" id="age" class="form-input" placeholder="Enter age">
                </div>
                <div class="form-group">
                    <label for="gender">Gender</label>
                    <select id="gender" class="form-select">
                        <option value="" disabled selected>Select gender...</option>
                        <option value="0">Female</option>
                        <option value="-2">Male</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="acr">Urine Albumin-to-Creatinine Ratio (ACR)</label>
                    <select id="acr" class="form-select">
                        <option value="" disabled selected>Select ACR...</option>
                        <option value="0">&lt; 30 mg/g</option>
                        <option value="-14">30-300 mg/g</option>
                        <option value="-22">&gt; 300 mg/g</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="egfr">eGFR (mL/min/1.73m¬≤)</label>
                    <input type="number" id="egfr" class="form-input" placeholder="Enter eGFR">
                </div>
                <div class="form-group">
                    <label for="albumin">Serum Albumin (g/dL)</label>
                    <input type="number" step="0.1" id="albumin" class="form-input" placeholder="Enter albumin">
                </div>
                <div class="form-group">
                    <label for="bicarbonate">Serum Bicarbonate (mEq/L)</label>
                    <input type="number" id="bicarbonate" class="form-input" placeholder="Enter bicarbonate">
                </div>
                <div class="form-group">
                    <label for="calcium">Serum Calcium (mg/dL)</label>
                    <input type="number" step="0.1" id="calcium" class="form-input" placeholder="Enter calcium">
                </div>
                <div class="form-group">
                    <label for="phosphorus">Serum Phosphorus (mg/dL)</label>
                    <input type="number" step="0.1" id="phosphorus" class="form-input" placeholder="Enter phosphorus">
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate Risk</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Health illustration">
                    <p>Enter all clinical parameters to estimate the 5-year kidney failure risk.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>5-Year Kidney Failure Risk</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0</div>
                        <div class="rate-label">%</div>
                    </div>
                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low Risk</span>
                        <span>High Risk</span>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Analysis</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
        
            <div class="note-card">
                <h3>About This Calculator</h3>
                <p>
                    This Kidney Failure Risk Calculator estimates a person's 5-year probability of progressing to kidney failure
                    based on several clinical parameters.
                    It is designed for individuals with existing chronic kidney disease (CKD) to assess risk and potentially
                    guide treatment planning.
                </p>
            </div>
        
            <div class="note-card">
                <h3>Parameters Explained</h3>
                <ul>
                    <li><strong>Gender:</strong> Biological sex is considered, as males may have different risk patterns
                        compared to females.</li>
                    <li><strong>Age:</strong> Older age can be associated with higher risk of progression.</li>
                    <li><strong>Albumin-to-Creatinine Ratio (ACR):</strong> A measure of how much albumin is in the urine. High
                        levels suggest kidney damage.</li>
                    <li><strong>eGFR:</strong> Estimated Glomerular Filtration Rate indicates how well your kidneys are
                        filtering blood.</li>
                    <li><strong>Serum Albumin:</strong> Low albumin levels in blood may suggest inflammation or poor nutrition,
                        affecting kidney outcomes.</li>
                    <li><strong>Bicarbonate:</strong> Reflects acid-base balance. Low bicarbonate can indicate metabolic
                        acidosis common in CKD.</li>
                    <li><strong>Calcium:</strong> Calcium levels are crucial in bone metabolism and kidney function regulation.
                    </li>
                    <li><strong>Phosphorus:</strong> High levels may indicate poor kidney function and can contribute to
                        cardiovascular complications.</li>
                </ul>
            </div>
        
            <div class="note-card">
                <h3>How It Works</h3>
                <p>
                    The calculator uses a point system based on your input. Each value you enter contributes positive or
                    negative points toward a total score.
                    That score is then mapped to a 5-year probability of developing kidney failure, using a clinically derived
                    scale.
                </p>
            </div>
        
            <div class="note-card">
                <h3>What is Renal Failure?</h3>
                <p>
                    Renal (kidney) failure is the final stage of kidney insufficiency ‚Äî when kidneys can no longer perform their
                    functions properly.
                    This condition may occur suddenly (acute) or progress over time (chronic).
                </p>
            </div>
        
            <div class="note-card">
                <h3>Symptoms of Kidney Failure</h3>
                <p>When the kidneys stop working, patients may experience:</p>
                <ul>
                    <li>Dark, dry, itchy skin</li>
                    <li>Swelling in different body parts</li>
                    <li>Shortness of breath due to fluid buildup</li>
                    <li>Muscle cramps or paralysis</li>
                    <li>Nausea and vomiting</li>
                    <li>Unintended weight loss</li>
                </ul>
            </div>
        
            <div class="note-card">
                <h3>Risks of Kidney Failure</h3>
                <p>Common risk factors include:</p>
                <ul>
                    <li>Hypertension</li>
                    <li>Diabetes mellitus</li>
                    <li>Obesity</li>
                    <li>Smoking</li>
                    <li>High-protein diets</li>
                    <li>Heart disease</li>
                    <li>Congenital kidney defects</li>
                    <li>Family history of kidney conditions</li>
                </ul>
            </div>
        
            <div class="note-card">
                <h3>What‚Äôs Next?</h3>
                <p>
                    Most patients with kidney failure need regular dialysis (3‚Äì4 times a week, for 4‚Äì5 hours) or a kidney
                    transplant.
                    Children may be prescribed peritoneal dialysis that can be done at home.
                </p>
            </div>
        
            <div class="note-card">
                <h3>How to Use the Kidney Failure Risk Calculator</h3>
                <p>
                    After entering required data, the calculator provides your probability (%) of developing kidney failure
                    within five years.
                </p>
            </div>
        
            <div class="note-card">
                <h3>What if My Probability is 50%?</h3>
                <p>
                    This means 1 out of 2 people with the same score will likely develop kidney failure within five years.
                    However, this is only an estimate ‚Äî other factors also influence the outcome.
                </p>
            </div>
        
            <div class="note-card">
                <h3>What Does the Tool Measure?</h3>
                <p>
                    Our tool considers several factors including age, sex, albumin creatinine ratio (ACR), glomerular filtration
                    rate (GFR),
                    serum albumin, bicarbonates, calcium, and phosphorus levels to estimate kidney health.
                </p>
            </div>
        
            <div class="note-card">
                <h3>Kidney Failure Risk Score Chart</h3>
                <div class="table-container">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Value</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Age -->
                            <tr class="section-row">
                                <td colspan="3">Age (years)</td>
                            </tr>
                            <tr>
                                <td>Age</td>
                                <td>&lt;30</td>
                                <td>-4</td>
                            </tr>
                            <tr>
                                <td>Age</td>
                                <td>30‚Äì39</td>
                                <td>-2</td>
                            </tr>
                            <tr>
                                <td>Age</td>
                                <td>40‚Äì49</td>
                                <td>0</td>
                            </tr>
                            <tr>
                                <td>Age</td>
                                <td>50‚Äì59</td>
                                <td>2</td>
                            </tr>
                            <tr>
                                <td>Age</td>
                                <td>60‚Äì69</td>
                                <td>4</td>
                            </tr>
                            <tr>
                                <td>Age</td>
                                <td>70‚Äì79</td>
                                <td>6</td>
                            </tr>
                            <tr>
                                <td>Age</td>
                                <td>80‚Äì89</td>
                                <td>8</td>
                            </tr>
                            <tr>
                                <td>Age</td>
                                <td>‚â•90</td>
                                <td>10</td>
                            </tr>
        
                            <!-- Gender -->
                            <tr class="section-row">
                                <td colspan="3">Gender</td>
                            </tr>
                            <tr>
                                <td>Gender</td>
                                <td>Female</td>
                                <td>0</td>
                            </tr>
                            <tr>
                                <td>Gender</td>
                                <td>Male</td>
                                <td>-2</td>
                            </tr>
        
                            <!-- Urine -->
                            <tr class="section-row">
                                <td colspan="3">Urine Albumin-to-Creatinine Ratio (mg/g)</td>
                            </tr>
                            <tr>
                                <td>Ratio</td>
                                <td>&lt;30</td>
                                <td>0</td>
                            </tr>
                            <tr>
                                <td>Ratio</td>
                                <td>30‚Äì300</td>
                                <td>-14</td>
                            </tr>
                            <tr>
                                <td>Ratio</td>
                                <td>&gt;300</td>
                                <td>-22</td>
                            </tr>
        
                            <!-- eGFR -->
                            <tr class="section-row">
                                <td colspan="3">eGFR (mL/min/1.73m¬≤)</td>
                            </tr>
                            <tr>
                                <td>eGFR</td>
                                <td>10‚Äì14</td>
                                <td>-35</td>
                            </tr>
                            <tr>
                                <td>eGFR</td>
                                <td>15‚Äì19</td>
                                <td>-30</td>
                            </tr>
                            <tr>
                                <td>eGFR</td>
                                <td>20‚Äì24</td>
                                <td>-25</td>
                            </tr>
                            <tr>
                                <td>eGFR</td>
                                <td>25‚Äì29</td>
                                <td>-20</td>
                            </tr>
                            <tr>
                                <td>eGFR</td>
                                <td>30‚Äì34</td>
                                <td>-15</td>
                            </tr>
                            <tr>
                                <td>eGFR</td>
                                <td>35‚Äì39</td>
                                <td>-10</td>
                            </tr>
                            <tr>
                                <td>eGFR</td>
                                <td>40‚Äì44</td>
                                <td>-5</td>
                            </tr>
                            <tr>
                                <td>eGFR</td>
                                <td>45‚Äì49</td>
                                <td>0</td>
                            </tr>
                            <tr>
                                <td>eGFR</td>
                                <td>50‚Äì54</td>
                                <td>5</td>
                            </tr>
                            <tr>
                                <td>eGFR</td>
                                <td>55‚Äì59</td>
                                <td>10</td>
                            </tr>
        
                            <!-- Albumin -->
                            <tr class="section-row">
                                <td colspan="3">Serum Albumin (g/dL)</td>
                            </tr>
                            <tr>
                                <td>Albumin</td>
                                <td>‚â§2.5</td>
                                <td>-5</td>
                            </tr>
                            <tr>
                                <td>Albumin</td>
                                <td>2.6‚Äì3.0</td>
                                <td>0</td>
                            </tr>
                            <tr>
                                <td>Albumin</td>
                                <td>3.1‚Äì3.5</td>
                                <td>2</td>
                            </tr>
                            <tr>
                                <td>Albumin</td>
                                <td>‚â•3.6</td>
                                <td>4</td>
                            </tr>
        
                            <!-- Bicarbonate -->
                            <tr class="section-row">
                                <td colspan="3">Serum Bicarbonate (mEq/L)</td>
                            </tr>
                            <tr>
                                <td>Bicarbonate</td>
                                <td>&lt;18</td>
                                <td>-7</td>
                            </tr>
                            <tr>
                                <td>Bicarbonate</td>
                                <td>18‚Äì22</td>
                                <td>-4</td>
                            </tr>
                            <tr>
                                <td>Bicarbonate</td>
                                <td>23‚Äì25</td>
                                <td>-1</td>
                            </tr>
                            <tr>
                                <td>Bicarbonate</td>
                                <td>&gt;25</td>
                                <td>0</td>
                            </tr>
        
                            <!-- Calcium -->
                            <tr class="section-row">
                                <td colspan="3">Serum Calcium (mg/dL)</td>
                            </tr>
                            <tr>
                                <td>Calcium</td>
                                <td>‚â§8.5</td>
                                <td>-3</td>
                            </tr>
                            <tr>
                                <td>Calcium</td>
                                <td>8.6‚Äì9.5</td>
                                <td>0</td>
                            </tr>
                            <tr>
                                <td>Calcium</td>
                                <td>‚â•9.6</td>
                                <td>2</td>
                            </tr>
        
                            <!-- Phosphorus -->
                            <tr class="section-row">
                                <td colspan="3">Serum Phosphorus (mg/dL)</td>
                            </tr>
                            <tr>
                                <td>Phosphorus</td>
                                <td>&lt;3.5</td>
                                <td>3</td>
                            </tr>
                            <tr>
                                <td>Phosphorus</td>
                                <td>3.5‚Äì4.5</td>
                                <td>0</td>
                            </tr>
                            <tr>
                                <td>Phosphorus</td>
                                <td>4.6‚Äì5.5</td>
                                <td>-3</td>
                            </tr>
                            <tr>
                                <td>Phosphorus</td>
                                <td>&gt;5.5</td>
                                <td>-5</td>
                            </tr>
        
                            <!-- Probability -->
                            <tr class="section-row">
                                <td colspan="3">Convert Points to 5-Year Kidney Failure Probability</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>&lt;-41</td>
                                <td>&gt;90.0%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-41</td>
                                <td>89.0%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-40</td>
                                <td>86.9%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-39</td>
                                <td>84.1%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-38</td>
                                <td>81.0%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-37</td>
                                <td>81.0%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-36</td>
                                <td>74.4%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-35</td>
                                <td>70.9%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-34</td>
                                <td>67.3%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-33</td>
                                <td>63.6%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-32</td>
                                <td>59.9%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-31</td>
                                <td>56.3%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-30</td>
                                <td>52.8%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-29</td>
                                <td>49.3%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-28</td>
                                <td>45.9%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-27</td>
                                <td>42.7%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-26</td>
                                <td>39.6%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-25</td>
                                <td>36.6%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-24</td>
                                <td>33.8%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-23</td>
                                <td>31.2%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-22</td>
                                <td>28.7%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-21</td>
                                <td>26.4%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-20</td>
                                <td>24.2%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-19</td>
                                <td>22.2%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-18</td>
                                <td>20.3%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-17</td>
                                <td>18.6%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-16</td>
                                <td>17.0%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-15</td>
                                <td>15.5%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-14</td>
                                <td>14.1%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-13</td>
                                <td>12.9%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-12</td>
                                <td>11.7%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-11</td>
                                <td>10.7%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-10</td>
                                <td>9.7%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-9</td>
                                <td>8.8%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-8</td>
                                <td>8.0%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-7</td>
                                <td>7.3%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-6</td>
                                <td>6.6%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-5</td>
                                <td>6.0%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-4</td>
                                <td>5.5%</td>
                            </tr>
                            <tr>
                                <td>Total Points</td>
                                <td>-3 or more</td>
                                <td>&lt;5.0%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        
            <div class="note-card">
                <h3>Conclusion</h3>
                <p>
                    This tool can provide insight into kidney health progression and help inform discussions with healthcare
                    providers.
                    However, it is not a substitute for medical diagnosis or personalized advice.
                    Always consult your doctor or a nephrology specialist to interpret the results in the context of your
                    overall health.
                </p>
            </div>
        
            <div class="note-card">
                <h3>‚ÑπÔ∏è Input Validations</h3>
                <div class="note-content">
                    <ul>
                        <li><strong>Age:</strong> Must be between <em>1 and 120 years</em>. Only whole numbers allowed.</li>
                        <li><strong>Gender:</strong> Required field. Select either <em>Male</em> or <em>Female</em>.</li>
                        <li><strong>Urine Albumin-to-Creatinine Ratio (ACR):</strong> Choose one category:
                            <ul>
                                <li>&lt; 30 mg/g ‚Üí Low</li>
                                <li>30 ‚Äì 300 mg/g ‚Üí Moderate</li>
                                <li>&gt; 300 mg/g ‚Üí High</li>
                            </ul>
                        </li>
                        <li><strong>eGFR:</strong> Accepts values <em>1 ‚Äì 200 mL/min/1.73m¬≤</em>. Must be greater than zero.
                        </li>
                        <li><strong>Serum Albumin:</strong> Range <em>1.0 ‚Äì 6.0 g/dL</em>. Decimals up to one place allowed.
                        </li>
                        <li><strong>Serum Bicarbonate:</strong> Range <em>10 ‚Äì 40 mEq/L</em>. Must be an integer.</li>
                        <li><strong>Serum Calcium:</strong> Range <em>6.0 ‚Äì 12.0 mg/dL</em>. Decimals up to one place allowed.
                        </li>
                        <li><strong>Serum Phosphorus:</strong> Range <em>1.0 ‚Äì 10.0 mg/dL</em>. Decimals up to one place
                            allowed.
                        </li>
                    </ul>
                    <p><strong>Cross-checks:</strong></p>
                    <ul>
                        <li>eGFR must always be higher than 0.</li>
                        <li>Albumin, Calcium, and Phosphorus cannot be negative or zero.</li>
                        <li>All required fields must be filled before calculation.</li>
                    </ul>
                    <p><em>‚ö†Ô∏è Entering values outside the valid range will trigger an error message.</em></p>
                </div>
            </div>
        
            <div class="note-card">
                <h3>‚ö†Ô∏è Disclaimer</h3>
                <p>
                    This calculator is a clinical support tool for informational purposes only.
                    It is not a substitute for professional medical advice, diagnosis, or treatment.
                    All medical decisions should be made in consultation with a qualified healthcare provider.
                </p>
            </div>
        
        </div>

    </div>

    <script>
        'use strict';

        /**
         * Full updated script for Kidney Failure Risk calculator
         * - Validates each input with friendly messages
         * - Computes total risk points and maps to probability
         * - Updates result card, meter, and feedback
         * - Includes print function that stamps current date
         */

        /* Set print date on load (if an element with id="printDate" exists) */
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const el = document.getElementById('printDate');
            if (el) el.textContent = now.toLocaleDateString('en-US', options);
        });

        /* Main calculate & display function */
        function calculateAndDisplay() {
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');

            // Reset UI to initial state
            if (errorBox) errorBox.classList.add('hidden');
            if (resultValueBox) resultValueBox.classList.add('hidden');
            if (placeholder) placeholder.classList.remove('hidden');

            const errors = [];

            // Helper to fetch and validate values
            function getVal(id, label, opts = {}) {
                const el = document.getElementById(id);
                if (!el) {
                    errors.push(`üëâ ${label} control not found.`);
                    return null;
                }
                const raw = (el.value ?? '').toString().trim();
                if (!raw && opts.required !== false) {
                    errors.push(`üëâ ${label} is required.`);
                    return null;
                }

                // For selects where numeric values are stored (like gender / acr) we still parse number
                if (opts.isSelect) {
                    // if empty string or placeholder remains, report required
                    if (raw === '') {
                        errors.push(`üëâ ${label} is required.`);
                        return null;
                    }
                    const n = parseFloat(raw);
                    if (isNaN(n)) {
                        errors.push(`üëâ ${label} selection is invalid.`);
                        return null;
                    }
                    return n;
                }

                // Numeric input
                const n = parseFloat(raw);
                if (isNaN(n)) {
                    errors.push(`üëâ Enter a valid numeric value for ${label}.`);
                    return null;
                }
                if (opts.min !== undefined && n < opts.min) {
                    errors.push(`üëâ ${label} must be ‚â• ${opts.min}${opts.unit ? ' ' + opts.unit : ''}.`);
                }
                if (opts.max !== undefined && n > opts.max) {
                    errors.push(`üëâ ${label} must be ‚â§ ${opts.max}${opts.unit ? ' ' + opts.unit : ''}.`);
                }
                return n;
            }

            // Collect + validate inputs (use realistic medical ranges)
            const age = getVal('age', 'Age', { min: 0, max: 120 });
            const gender = getVal('gender', 'Gender', { isSelect: true }); // expected values: 0 (Female) or -2 (Male)
            const acr = getVal('acr', 'ACR (albumin-to-creatinine category)', { isSelect: true }); // expected values: 0, -14, -22
            const egfr = getVal('egfr', 'eGFR', { min: 5, max: 200, unit: 'mL/min/1.73m¬≤' });
            const albumin = getVal('albumin', 'Serum Albumin', { min: 0.5, max: 6.0, unit: 'g/dL' });
            const bicarbonate = getVal('bicarbonate', 'Serum Bicarbonate', { min: 5, max: 40, unit: 'mEq/L' });
            const calcium = getVal('calcium', 'Serum Calcium', { min: 4.0, max: 14.0, unit: 'mg/dL' });
            const phosphorus = getVal('phosphorus', 'Serum Phosphorus', { min: 1.0, max: 12.0, unit: 'mg/dL' });

            // If any validation errors, show and exit (hide results)
            if (errors.length > 0) {
                if (errorMessage) errorMessage.innerHTML = errors.join('<br>');
                if (errorBox) errorBox.classList.remove('hidden');
                if (placeholder) placeholder.classList.add('hidden');
                return;
            }

            // Score accumulation
            let totalPoints = 0;

            // Gender and ACR are stored in select option values (points)
            totalPoints += gender; // e.g., 0 (female) or -2 (male) as provided by your select value mapping
            totalPoints += acr;    // e.g., 0, -14, -22 from select mapping

            // Age score mapping (per your earlier logic)
            if (age < 30) totalPoints += -4;
            else if (age <= 39) totalPoints += -2;
            else if (age <= 49) totalPoints += 0;
            else if (age <= 59) totalPoints += 2;
            else if (age <= 69) totalPoints += 4;
            else if (age <= 79) totalPoints += 6;
            else if (age <= 89) totalPoints += 8;
            else totalPoints += 10;

            // eGFR mapping (example detailed ranges; adjust if your score table differs)
            if (egfr <= 14) totalPoints += -35;
            else if (egfr <= 19) totalPoints += -30;
            else if (egfr <= 24) totalPoints += -25;
            else if (egfr <= 29) totalPoints += -20;
            else if (egfr <= 34) totalPoints += -15;
            else if (egfr <= 39) totalPoints += -10;
            else if (egfr <= 44) totalPoints += -5;
            else if (egfr <= 49) totalPoints += 0;
            else if (egfr <= 54) totalPoints += 5;
            else if (egfr <= 59) totalPoints += 10;
            // >59 => no added points in this table

            // Albumin
            if (albumin <= 2.5) totalPoints += -5;
            else if (albumin <= 3.0) totalPoints += 0;
            else if (albumin <= 3.5) totalPoints += 2;
            else totalPoints += 4;

            // Bicarbonate
            if (bicarbonate < 18) totalPoints += -7;
            else if (bicarbonate <= 22) totalPoints += -4;
            else if (bicarbonate <= 25) totalPoints += -1;
            // >25 adds 0 points

            // Calcium
            if (calcium <= 8.5) totalPoints += -3;
            else if (calcium <= 9.5) totalPoints += 0;
            else totalPoints += 2;

            // Phosphorus
            if (phosphorus < 3.5) totalPoints += 3;
            else if (phosphorus <= 4.5) totalPoints += 0;
            else if (phosphorus <= 5.5) totalPoints += -3;
            else totalPoints += -5;

            // Probability lookup map
            const probabilityMap = {
                "-41": 89.0, "-40": 86.9, "-39": 84.1, "-38": 81.0, "-37": 77.7, "-36": 74.4,
                "-35": 70.9, "-34": 67.3, "-33": 63.6, "-32": 59.9, "-31": 56.3, "-30": 52.8,
                "-29": 49.3, "-28": 45.9, "-27": 42.7, "-26": 39.6, "-25": 36.6, "-24": 33.8,
                "-23": 31.2, "-22": 28.7, "-21": 26.4, "-20": 24.2, "-19": 22.2, "-18": 20.3,
                "-17": 18.6, "-16": 17.0, "-15": 15.5, "-14": 14.1, "-13": 12.9, "-12": 11.7,
                "-11": 10.7, "-10": 9.7, "-9": 8.8, "-8": 8.0, "-7": 7.3, "-6": 6.6, "-5": 6.0, "-4": 5.5
            };

            let probability;
            if (totalPoints <= -41) probability = ">90.0";
            else if (totalPoints >= -3) probability = "<5.0";
            else {
                const v = probabilityMap[totalPoints.toString()];
                probability = (typeof v === 'number') ? v.toFixed(1) : "N/A";
            }

            // Show results
            if (placeholder) placeholder.classList.add('hidden');
            if (resultValueBox) resultValueBox.classList.remove('hidden');

            const rateValueEl = document.getElementById('rateValue');
            if (rateValueEl) rateValueEl.textContent = probability;

            // Meter update
            const meterFill = document.getElementById('meterFill');
            let numericProb = parseFloat(probability);
            if (isNaN(numericProb)) {
                // string like ">90.0" or "<5.0"
                if (typeof probability === 'string' && probability.startsWith('>')) numericProb = 95;
                else if (typeof probability === 'string' && probability.startsWith('<')) numericProb = 3;
                else numericProb = 0;
            }
            const pct = Math.max(0, Math.min(100, numericProb));
            if (meterFill) {
                meterFill.style.width = pct + '%';
                if (numericProb < 30 || probability.includes('<')) meterFill.style.backgroundColor = '#2ecc71';
                else if (numericProb < 70) meterFill.style.backgroundColor = '#f39c12';
                else meterFill.style.backgroundColor = '#e74c3c';
            }

            // Feedback text
            let interpretation = '';
            if (numericProb < 30 || probability.includes('<')) {
                interpretation = "‚úÖ Your risk is considered low. Maintain follow-ups with your care team.";
            } else if (numericProb < 70) {
                interpretation = "‚ö†Ô∏è Moderate risk ‚Äî close monitoring and medical review recommended.";
            } else {
                interpretation = "‚ùó High risk ‚Äî urgent discussion with a nephrologist or primary doctor is recommended.";
            }

            const feedbackContent = document.getElementById('feedbackContent');
            if (feedbackContent) {
                feedbackContent.innerHTML = `Your total risk score is <strong>${totalPoints} points</strong>. ${interpretation}`;
            }
        }

        /* print function: set printDate (if exists) then call window.print() */
        function printReport() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const el = document.getElementById('printDate');
            if (el) el.textContent = now.toLocaleDateString('en-US', options);
            window.print();
        }
    </script>

</body>
</html>
{% endblock %}

<!-- 
1. Input Validation Rules (based on real-world compliance)
Field	Expected Range	Units	Validation Rules	Compliance Rationale
Age	18 ‚Äì 120	years	Must be an integer ‚â•18 and ‚â§120.	Minors are excluded from most kidney risk models; >120 is unrealistic. Prevents nonsense inputs (negative, zero, or excessive).
Gender	Female / Male	categorical	Must select one; no default.	Needed for biological consistency (risk differs by sex). Prevents null values.
Urine ACR	<30, 30‚Äì300, >300	mg/g	Must select one category only. No empty.	Direct risk factor for kidney failure; missing values lead to misclassification.
eGFR	5 ‚Äì 120	mL/min/1.73m¬≤	Accept integers only. Reject <5 (dialysis stage) and >120 (unrealistic).	Validates physiologically possible kidney filtration rate.
Serum Albumin	1.0 ‚Äì 6.0	g/dL	Decimal up to 1 decimal place. Must be ‚â•1.0 and ‚â§6.0.	Outside this range means data entry error. Prevents misinterpretation.
Serum Bicarbonate	10 ‚Äì 40	mEq/L	Integer only. Reject values outside range.	<10 or >40 = critical lab error. Ensures credible clinical data.
Serum Calcium	6.0 ‚Äì 12.0	mg/dL	Decimal allowed (1 decimal place). Must be within safe clinical range.	<6 or >12 may mean lab/entry error or imminent risk.
Serum Phosphorus	2.0 ‚Äì 10.0	mg/dL	Decimal allowed (1 decimal place). Reject outside.	Prevents biologically impossible values.
2. Output Validation & Thresholds

From a compliance/safety reporting perspective:

<15% risk ‚Üí Low Risk (Green): Same as ‚Äúbelow occupational exposure limits‚Äù in safety. Routine monitoring only.

15‚Äì50% ‚Üí Moderate Risk (Yellow): Similar to ‚ÄúALARP‚Äù (as low as reasonably practicable) zone. Requires periodic intervention.

51‚Äì75% ‚Üí High Risk (Orange): Requires management plan and corrective measures (equivalent to OSHA corrective actions).

>75% ‚Üí Critical Risk (Red): Equivalent to ‚Äúemergency hazard‚Äù ‚Üí requires immediate intervention.

This classification matches how we‚Äôd flag hazards in QEHS risk registers.
-->