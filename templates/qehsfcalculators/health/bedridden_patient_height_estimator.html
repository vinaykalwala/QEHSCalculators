{% extends 'base.html' %}
{% block title %}Bedridden Patient Height Estimator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bedridden Patient Height Estimator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
            min-height: 420px;
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        .print-btn:hover {
            background: #1560bd;
        }
        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: center;
        }
        .result-value {
            width: 100%;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        .rate-label {
            color: #2980b9;
            font-weight: bold;
            font-size: 20px;
        }
        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        .note-card:hover {
            transform: translateY(-2px);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        /* Image CSS */
        .measurement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        .measurement-block {
            background: #f9f9f9;
            border-left: 4px solid #1560bd;
            border-radius: 8px;
            padding: 15px;
        }
        .measurement-block h4 {
          font-size: 16px;
          color: #1560bd;
          margin-bottom: 8px;
        }
        .measurement-block p {
            font-size: 14px;
            line-height: 1.5;
        }
        .measurement-block img {
             display: block;
             max-width: 100%;
             height: auto;
             border-radius: 8px;
             margin-top: 10px;
        }
        /* Table styles */
        .custom-table {
    border-collapse: collapse;
    width: 100%;
    margin: 20px 0;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.custom-table thead {
    background-color: #1560bd;
    color: white;
}
.custom-table th, .custom-table td {
    padding: 12px 16px;
    border: 1px solid #ddd;
    text-align: center;
}
.custom-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

/* Horizontal scrollbar only for mobile and tablet */
@media screen and (max-width: 1024px) {
    .custom-table {
        overflow-x: auto;
        display: block;
        white-space: nowrap;
    }
    
    /* Scrollbar styling */
    .custom-table::-webkit-scrollbar {
        height: 8px;
    }
    
    .custom-table::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .custom-table::-webkit-scrollbar-thumb {
        background: #1560bd;
        border-radius: 4px;
    }
    
    .custom-table::-webkit-scrollbar-thumb:hover {
        background: #0f4a9c;
    }
    
    /* Firefox scrollbar */
    .custom-table {
        scrollbar-width: thin;
        scrollbar-color: #1560bd #f1f1f1;
    }
}
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }
        /* Toggle helper */
        .hidden {
            display: none;
        }
        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }
        .back-btn {
            background: linear-gradient(#1560bd,#000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }
        .validation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 0.95rem;
            }

            .validation-table th,
            .validation-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            }

            .validation-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            }

            .validation-table tr:nth-child(even) {
            background-color: #fafafa;
            }

            /* Responsive design */
            @media (max-width: 768px) {
            .validation-table thead {
                display: none;
            }

            .validation-table,
            .validation-table tbody,
            .validation-table tr,
            .validation-table td {
                display: block;
                width: 100%;
            }

            .validation-table tr {
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 10px;
            }

            .validation-table td {
                text-align: right;
                position: relative;
                padding-left: 50%;
            }

            .validation-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%;
                font-weight: bold;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Bedridden Patient Height Estimator</h1>
            <p>Estimate height using various formulas for patients unable to stand.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Select Formula and Enter Data</h2>
                <div class="form-group">
                    <label for="formula">Select Formula</label>
                    <select id="formula" class="form-select" onchange="renderInputs()">
                        <option value="mitchell">Mitchell & Lipschitz</option>
                        <option value="who">WHO</option>
                        <option value="rabito1">Rabito et al. (Arm length + Semi-span)</option>
                        <option value="rabito2">Rabito et al. (Semi-span only)</option>
                        <option value="gray">Gray et al. (Recumbent height)</option>
                        <option value="chumlea">Chumlea et al.</option>
                        <option value="cereda">Cereda et al.</option>
                        <option value="knee">Knee Height formula</option>
                        <option value="demi">Demi-span formula</option>
                    </select>
                </div>
                <div id="inputFields"></div>
                <button class="calculate-btn" onclick="calculateHeight()">Estimate Height</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Health illustration">
                    <p>Select a formula and enter measurements to estimate the patient's height.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div class="result-value hidden" id="resultValue">
                    <h2>Estimated Height</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.0</div>
                        <div class="rate-label">cm</div>
                    </div>
                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Estimation</span>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Formula Used</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
        <div class="note-card">
        <h3>üìò About This Calculator</h3>
        <p>
            This calculator estimates the height of bedridden or immobile patients using alternative anthropometric methods such as demi-span, knee height, forearm length, and half arm span. 
            These estimates are valuable for clinical assessments, calculating medication dosages, nutritional requirements, and physiological volumes.
        </p>
        <p>
            It provides feedback on the estimated height, helping healthcare professionals assess whether measurements are within expected ranges for the patient's age, sex, and population group.
        </p>
    </div>

    <div class="note-card">
        <h3>‚öô Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Age:</strong> Patient's age in years.</li>
            <li><strong>Sex/Gender:</strong> Male or Female.</li>
            <li><strong>Race/Ethnic Group:</strong> If available, to improve population-specific accuracy.</li>
            <li><strong>Body Segment Measurements:</strong> Semi-span, demi-span, knee height, forearm/ulna length, recumbent length, arm length, calf circumference, abdominal circumference, subscapular skinfold.</li>
        </ul>
    </div>

        <div class="note-card">
            <h3>üìò Height Estimation in Bedridden Patients</h3>
            <p>
                Measuring height in bedridden or immobile patients can be challenging due to the inability to stand upright. 
                In such cases, alternative anthropometric methods are used to estimate height using body segment measurements. 
                These estimates are valuable in clinical care, especially for calculating medication dosages, 
                nutritional requirements, and physiological volumes.
            </p>
        </div>

        <div class="note-card">
            <h3>üìñ Why Estimate Height Without Standing?</h3>
            <ul class="note-list">
                <li>To calculate nutritional needs, body surface area, and physiological volumes.</li>
                <li>For dosing medications accurately in critical care or chronic illness.</li>
                <li>To monitor growth or body composition in patients unable to stand due to injury, surgery, or illness.</li>
            </ul>
        </div>

        <div class="note-card">
            <h3>üìè Common Methods for Estimating Height</h3>
            <ul class="note-list">
                <li><strong>Semi-span Method:</strong> Doubling the distance from the sternum to the fingertips on an outstretched arm.</li>
                <li><strong>Arm Span Method:</strong> Distance between the fingertips of both outstretched arms, usually close to height.</li>
                <li><strong>Demi-span Method:</strong> From the middle of the chest to the fingers, with sex-based adjustments.</li>
                <li><strong>Knee Height Method:</strong> Measures heel-to-knee distance, adjusted for age and sex.</li>
                <li><strong>Ulna / Forearm Length Charts:</strong> Uses standardized charts to estimate height.</li>
                <li><strong>Recumbent Length:</strong> Head-to-heel while lying down, direct but sometimes limited.</li>
                <li><strong>Composite Equations:</strong> Combine multiple anthropometric and demographic variables.</li>
                <li><strong>Forearm Length-Based:</strong> Use ulna length as reference, compare with table by sex and age.</li>
            </ul>
        </div>

        <div class="note-card">
            <h3>üìä Forearm Length-Based Height Estimation</h3>
            <div class="table-container">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Ulna Length (cm)</th>
                            <th>Men &lt;65 yrs (cm)</th>
                            <th>Men ‚â•65 yrs (cm)</th>
                            <th>Women &lt;65 yrs (cm)</th>
                            <th>Women ‚â•65 yrs (cm)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>18.5</td><td>146</td><td>145</td><td>147</td><td>140</td></tr>
                        <tr><td>19.0</td><td>148</td><td>146</td><td>148</td><td>142</td></tr>
                        <tr><td>19.5</td><td>149</td><td>148</td><td>150</td><td>144</td></tr>
                        <tr><td>20.0</td><td>151</td><td>149</td><td>151</td><td>145</td></tr>
                        <tr><td>20.5</td><td>153</td><td>151</td><td>152</td><td>147</td></tr>
                        <tr><td>21.0</td><td>155</td><td>152</td><td>154</td><td>148</td></tr>
                        <tr><td>21.5</td><td>157</td><td>154</td><td>155</td><td>150</td></tr>
                        <tr><td>22.0</td><td>158</td><td>156</td><td>156</td><td>152</td></tr>
                        <tr><td>22.5</td><td>160</td><td>157</td><td>158</td><td>153</td></tr>
                        <tr><td>23.0</td><td>162</td><td>159</td><td>159</td><td>155</td></tr>
                        <tr><td>23.5</td><td>164</td><td>160</td><td>161</td><td>156</td></tr>
                        <tr><td>24.0</td><td>166</td><td>162</td><td>162</td><td>158</td></tr>
                        <tr><td>24.5</td><td>167</td><td>163</td><td>163</td><td>160</td></tr>
                        <tr><td>25.0</td><td>169</td><td>165</td><td>165</td><td>161</td></tr>
                        <tr><td>25.5</td><td>171</td><td>167</td><td>166</td><td>163</td></tr>
                        <tr><td>26.0</td><td>173</td><td>168</td><td>168</td><td>165</td></tr>
                        <tr><td>26.5</td><td>175</td><td>170</td><td>169</td><td>166</td></tr>
                        <tr><td>27.0</td><td>176</td><td>171</td><td>170</td><td>168</td></tr>
                        <tr><td>27.5</td><td>178</td><td>173</td><td>172</td><td>170</td></tr>
                        <tr><td>28.0</td><td>180</td><td>175</td><td>173</td><td>171</td></tr>
                        <tr><td>28.5</td><td>182</td><td>176</td><td>175</td><td>173</td></tr>
                        <tr><td>29.0</td><td>184</td><td>178</td><td>176</td><td>175</td></tr>
                        <tr><td>29.5</td><td>185</td><td>179</td><td>177</td><td>176</td></tr>
                        <tr><td>30.0</td><td>187</td><td>181</td><td>179</td><td>178</td></tr>
                        <tr><td>30.5</td><td>189</td><td>182</td><td>180</td><td>179</td></tr>
                        <tr><td>31.0</td><td>191</td><td>184</td><td>181</td><td>181</td></tr>
                        <tr><td>31.5</td><td>193</td><td>186</td><td>183</td><td>183</td></tr>
                        <tr><td>32.0</td><td>194</td><td>187</td><td>184</td><td>184</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="note-card">
            <h3>‚ö†Ô∏è Important Considerations</h3>
            <ul class="note-list">
                <li>Choose a method based on the patient's mobility and accessibility of body parts.</li>
                <li>Use sex- and race-specific approaches when available for greater precision.</li>
                <li>All methods provide estimations, not exact measurements.</li>
            </ul>
        </div>

        <div class="note-card">
            <h3>üìê Measurement Guide for Bedridden Patients</h3>
            <div class="measurement-grid">
                <div class="measurement-block">
                    <h4>Semi-span (Demi-span)</h4>
                    <p>Measure from the middle of the sternal notch to the tip of the middle finger.</p>
                    <img src="{% static 'images/arm2.jpg' %}" alt="Semi-span measurement">
                </div>
                <div class="measurement-block">
                    <h4>Forearm Length</h4>
                    <p>Measure from the elbow tip to the midpoint of the wrist bone.</p>
                    <img src="{% static 'images/arm1.jpg' %}" alt="Forearm length measurement">
                </div>
                <div class="measurement-block">
                    <h4>Recumbent Height</h4>
                    <p>From head to heel while lying flat.</p>
                    <img src="{% static 'images/arm4.jpg' %}" alt="Recumbent height measurement">
                </div>
                <div class="measurement-block">
                    <h4>Knee Height</h4>
                    <p>Sliding caliper from heel to thigh top.</p>
                    <img src="{% static 'images/arm5.jpg' %}" alt="Knee height measurement">
                </div>
                <div class="measurement-block">
                    <h4>Calf Circumference</h4>
                    <p>Measure widest part of calf (non-dominant leg).</p>
                    <img src="{% static 'images/arm6.jpg' %}" alt="Calf circumference measurement">
                </div>
                <div class="measurement-block">
                    <h4>Arm Circumference</h4>
                    <p>Midpoint between shoulder and elbow.</p>
                    <img src="{% static 'images/arm7.jpg' %}" alt="Arm circumference measurement">
                </div>
                <div class="measurement-block">
                    <h4>Subscapular Skinfold</h4>
                    <p>Diagonal skinfold below shoulder blade.</p>
                    <img src="{% static 'images/arm8.gif' %}" alt="Subscapular skinfold measurement">
                </div>
                <div class="measurement-block">
                    <h4>Arm Length</h4>
                    <p>From acromion to elbow midpoint.</p>
                    <img src="{% static 'images/arm3.jpg' %}" alt="Arm length measurement">
                </div>
                <div class="measurement-block">
                    <h4>Abdominal Circumference</h4>
                    <p>Midpoint between last rib and hip bone.</p>
                    <img src="{% static 'images/arm9.webp' %}" alt="Abdominal circumference measurement">
                </div>
            </div>
        </div>

        <div class="note-card">
            <h3>‚ÑπÔ∏è Input Validation Guidelines</h3>
            <p>To ensure accurate height estimation, please follow these rules when entering values:</p>

            <table class="validation-table">
                <thead>
                <tr>
                    <th>Field</th>
                    <th>Expected Range</th>
                    <th>Units</th>
                    <th>Validation Rules</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td data-label="Field"><strong>Age</strong></td>
                    <td data-label="Expected Range">1 ‚Äì 120</td>
                    <td data-label="Units">Years</td>
                    <td data-label="Validation Rules">Must be an integer; no text or negative values.</td>
                </tr>
                <tr>
                    <td data-label="Field"><strong>Semi-span</strong></td>
                    <td data-label="Expected Range">20 ‚Äì 150</td>
                    <td data-label="Units">cm</td>
                    <td data-label="Validation Rules">Numeric value only; decimals allowed.</td>
                </tr>
                <tr>
                    <td data-label="Field"><strong>Arm Length</strong></td>
                    <td data-label="Expected Range">20 ‚Äì 150</td>
                    <td data-label="Units">cm</td>
                    <td data-label="Validation Rules">Numeric value only; decimals allowed.</td>
                </tr>
                <tr>
                    <td data-label="Field"><strong>Demi-span</strong></td>
                    <td data-label="Expected Range">20 ‚Äì 150</td>
                    <td data-label="Units">cm</td>
                    <td data-label="Validation Rules">Numeric value only; decimals allowed.</td>
                </tr>
                <tr>
                    <td data-label="Field"><strong>Knee Height</strong></td>
                    <td data-label="Expected Range">20 ‚Äì 80</td>
                    <td data-label="Units">cm</td>
                    <td data-label="Validation Rules">Numeric value only; decimals allowed.</td>
                </tr>
                <tr>
                    <td data-label="Field"><strong>Recumbent Height</strong></td>
                    <td data-label="Expected Range">50 ‚Äì 250</td>
                    <td data-label="Units">cm</td>
                    <td data-label="Validation Rules">Numeric value only; decimals allowed.</td>
                </tr>
                <tr>
                    <td data-label="Field"><strong>Gender / Race & Gender</strong></td>
                    <td data-label="Expected Range">Male/Female / White Male/Female / Black Male/Female</td>
                    <td data-label="Units">‚Äî</td>
                    <td data-label="Validation Rules">Must select one option from the dropdown.</td>
                </tr>
                </tbody>
            </table>
            </div>
         <div class="note-card">
            <h3>üßÆ Output Validations</h3>
            <p>The calculator provides feedback for the estimated height:</p>
            <ul class="note-list">
                <li><strong>Low Estimate:</strong> The calculated height is below typical values for the patient‚Äôs age, sex, and population ‚Äî consider re-measuring or checking input accuracy.</li>
                <li><strong>Normal Estimate:</strong> The estimated height aligns with expected ranges for the patient‚Äôs demographics, indicating reliable measurement input.</li>
                <li><strong>High Estimate:</strong> The estimated height exceeds expected ranges ‚Äî review measurements for errors or anomalies.</li>
            </ul>
            <p>
                These assessments act as <strong>feedback</strong> for healthcare professionals, ensuring clinical decisions are based on reasonable estimates.
            </p>
        </div>

        <div class="note-card">
            <h3>‚öñÔ∏è Governing Principle</h3>
            <p>
                There is no single standardized method for estimating a bedridden patient's height. Various established techniques, such as demi-span, knee height, forearm length, and half arm span, are used based on clinical context and population data. 
                The choice of method depends on the patient‚Äôs limitations, availability of accurate data for their age, sex, and ethnic group, and the tools/expertise available.
            </p>
            <ul class="note-list">
                <li><strong>Population-Specific Data:</strong> Formulas are validated for specific age, sex, and ethnic populations. Accuracy may vary across populations.</li>
                <li><strong>Patient Limitations:</strong> Choose methods suitable for patient mobility and condition (e.g., demi-span for limb dysfunction, forearm length for contractures).</li>
                <li><strong>No Universal Standard:</strong> Height estimation formulas are population-dependent; local validation is recommended for best accuracy.</li>
                <li><strong>Importance of Validation:</strong> Using validated methods ensures clinical reliability of the estimated height for treatment planning and assessments.</li>
            </ul>
        </div>


        <div class="note-card">
            <h3>‚úÖ Conclusion</h3>
            <p>
                Accurate height estimation in bedridden patients is crucial for clinical assessments and treatment planning. 
                By using validated anthropometric methods such as knee height, demi-span, or arm span, healthcare professionals 
                can derive reasonably accurate height estimates, even without upright measurements.
            </p>
        </div>
    </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            if (document.getElementById('printDate')) {
                document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            }
            renderInputs(); // Initial render
        });

        /**
         * Render input fields dynamically based on chosen formula.
         * Inputs are created with sensible attributes (min, step, placeholder).
         */
        function renderInputs() {
            const formula = document.getElementById("formula").value;
            const container = document.getElementById("inputFields");
            container.innerHTML = "";

            const addField = (id, label, opts = {}) => {
                const minAttr = opts.min !== undefined ? `min="${opts.min}"` : "";
                const maxAttr = opts.max !== undefined ? `max="${opts.max}"` : "";
                const stepAttr = opts.step !== undefined ? `step="${opts.step}"` : `step="0.1"`;
                const placeholder = opts.placeholder || "Enter value in cm";
                container.innerHTML += `
                <div class="form-group">
                    <label for="${id}">${label}</label>
                    <input type="number" id="${id}" class="form-input" ${minAttr} ${maxAttr} ${stepAttr} placeholder="${placeholder}">
                </div>`;
            };

            const addAgeField = () => {
                container.innerHTML += `
                <div class="form-group">
                    <label for="age">Age (years)</label>
                    <input type="number" id="age" class="form-input" min="1" max="120" step="1" placeholder="Enter age in whole years">
                </div>`;
            };

            const addSelect = (id, label, options) => {
                let optionsHTML = options.map(o => `<option value="${o.value}">${o.label}</option>`).join("");
                container.innerHTML += `
                <div class="form-group">
                    <label for="${id}">${label}</label>
                    <select id="${id}" class="form-select">${optionsHTML}</select>
                </div>`;
            };

            switch (formula) {
                case "mitchell":
                    addField("semispan", "Semi-span (cm)", { min: 20, max: 150 });
                    break;
                case "who":
                    addField("armspan", "Half Arm-span (cm)", { min: 20, max: 150 });
                    break;
                case "rabito1":
                    addSelect("sex", "Gender", [{ value: 1, label: "Male" }, { value: 2, label: "Female" }]);
                    addAgeField();
                    addField("armlength", "Arm Length (cm)", { min: 20, max: 100 });
                    addField("semispan", "Semi-span (cm)", { min: 20, max: 150 });
                    break;
                case "rabito2":
                    addSelect("sex", "Gender", [{ value: 1, label: "Male" }, { value: 2, label: "Female" }]);
                    addAgeField();
                    addField("semispan", "Semi-span (cm)", { min: 20, max: 150 });
                    break;
                case "gray":
                    addField("recumbent", "Recumbent Height (cm)", { min: 50, max: 250 });
                    break;
                case "chumlea":
                    addSelect("sex", "Race & Gender", [
                        { value: 1, label: "White Male" },
                        { value: 2, label: "White Female" },
                        { value: 3, label: "Black Male" },
                        { value: 4, label: "Black Female" }
                    ]);
                    addField("knee", "Knee Height (cm)", { min: 20, max: 80 });
                    addAgeField();
                    break;
                case "cereda":
                    addSelect("sex", "Gender", [{ value: 1, label: "Male" }, { value: 0, label: "Female" }]);
                    addField("knee", "Knee Height (cm)", { min: 20, max: 80 });
                    addAgeField();
                    break;
                case "knee":
                    addSelect("sex", "Gender", [{ value: 1, label: "Male" }, { value: 2, label: "Female" }]);
                    addField("knee", "Knee Height (cm)", { min: 20, max: 80 });
                    addAgeField();
                    break;
                case "demi":
                    addSelect("sex", "Gender", [{ value: 1, label: "Male" }, { value: 2, label: "Female" }]);
                    addField("demi", "Demi-span (cm)", { min: 20, max: 150 });
                    break;
                default:
                    break;
            }
        }

        /**
         * Core calculation + validation logic.
         * Validates each input with clear messages and shows/hides appropriate UI blocks.
         */
        function calculateHeight() {
            const formulaEl = document.getElementById("formula");
            const formula = formulaEl.value;
            const formulaText = formulaEl.options[formulaEl.selectedIndex].text;

            // UI refs
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');
            const rateValue = document.getElementById('rateValue');
            const feedbackContent = document.getElementById('feedbackContent');
            const meterFill = document.getElementById('meterFill');

            // reset UI
            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');

            let errors = [];

            // helper to fetch and validate a numeric input
            function getVal(id, opts = {}) {
                const el = document.getElementById(id);
                const label = el ? (document.querySelector(`label[for=${id}]`)?.textContent || id) : id;
                if (!el) {
                    errors.push(`üëâ Missing input: ${label}.`);
                    return null;
                }
                const raw = el.value?.toString().trim();
                if (!raw) {
                    errors.push(`üëâ ${label} is required.`);
                    return null;
                }
                const num = parseFloat(raw);
                if (isNaN(num) || num <= 0) {
                    errors.push(`üëâ Enter a valid positive number for ${label}.`);
                    return null;
                }
                if (opts.integer && !Number.isInteger(num)) {
                    errors.push(`üëâ ${label} must be a whole number.`);
                    return null;
                }
                if (opts.min !== undefined && num < opts.min) {
                    errors.push(`üëâ ${label} must be ‚â• ${opts.min}.`);
                    return null;
                }
                if (opts.max !== undefined && num > opts.max) {
                    errors.push(`üëâ ${label} must be ‚â§ ${opts.max}.`);
                    return null;
                }
                // limit decimals to 1 if requested
                if (opts.decimals === 1) {
                    const check = Math.round(num * 10) / 10;
                    return check;
                }
                return num;
            }

            // perform formula-specific validation + compute height
            let height = null;
            try {
                switch (formula) {
                    case "mitchell": {
                        const semi = getVal("semispan", { min: 20, max: 150, decimals: 1 });
                        if (semi !== null) height = semi * 2;
                        break;
                    }
                    case "who": {
                        // Note: the original used (0.73*2*armspan) + 0.43
                        const armspan = getVal("armspan", { min: 20, max: 150, decimals: 1 });
                        if (armspan !== null) height = (0.73 * 2 * armspan) + 0.43;
                        break;
                    }
                    case "rabito1": {
                        const sex = getVal("sex"); // integer coded select
                        const age = getVal("age", { min: 18, max: 90, integer: true });
                        const armlength = getVal("armlength", { min: 20, max: 100, decimals: 1 });
                        const semi = getVal("semispan", { min: 20, max: 150, decimals: 1 });
                        if (sex !== null && age !== null && armlength !== null && semi !== null) {
                            height = 58.694 - (2.974 * sex) - (0.0736 * age) + (0.4958 * armlength) + (1.132 * semi);
                        }
                        break;
                    }
                    case "rabito2": {
                        const sex = getVal("sex");
                        const age = getVal("age", { min: 18, max: 90, integer: true });
                        const semi = getVal("semispan", { min: 20, max: 150, decimals: 1 });
                        if (sex !== null && age !== null && semi !== null) {
                            height = 63.525 - (3.237 * sex) - (0.06904 * age) + (1.293 * semi);
                        }
                        break;
                    }
                    case "gray": {
                        const rec = getVal("recumbent", { min: 50, max: 250, decimals: 1 });
                        if (rec !== null) height = rec;
                        break;
                    }
                    case "chumlea": {
                        const sex = getVal("sex");
                        const knee = getVal("knee", { min: 20, max: 80, decimals: 1 });
                        const age = getVal("age", { min: 18, max: 90, integer: true });
                        if (sex !== null && knee !== null && age !== null) {
                            if (sex === 1) height = 71.85 + (1.88 * knee); // White Male
                            else if (sex === 2) height = 70.25 + (1.87 * knee) - (0.06 * age); // White Female
                            else if (sex === 3) height = 73.42 + (1.79 * knee); // Black Male
                            else if (sex === 4) height = 68.1 + (1.86 * knee) - (0.06 * age); // Black Female
                            else errors.push("üëâ Invalid selection for Race & Gender.");
                        }
                        break;
                    }
                    case "cereda": {
                        const sex = getVal("sex"); // 1 or 0 per your form
                        const knee = getVal("knee", { min: 20, max: 80, decimals: 1 });
                        const age = getVal("age", { min: 18, max: 90, integer: true });
                        if (sex !== null && knee !== null && age !== null) {
                            height = 60.76 + (2.16 * knee) - (0.06 * age) + (2.76 * sex);
                        }
                        break;
                    }
                    case "knee": {
                        const sex = getVal("sex");
                        const knee = getVal("knee", { min: 20, max: 80, decimals: 1 });
                        const age = getVal("age", { min: 18, max: 90, integer: true });
                        if (sex !== null && knee !== null && age !== null) {
                            if (sex === 1) height = 64.19 - (0.04 * age) + (2.02 * knee);
                            else height = 84.88 - (0.24 * age) + (1.83 * knee);
                        }
                        break;
                    }
                    case "demi": {
                        const sex = getVal("sex");
                        const demi = getVal("demi", { min: 20, max: 150, decimals: 1 });
                        if (sex !== null && demi !== null) {
                            height = sex === 1 ? (1.4 * demi) + 57.8 : (1.35 * demi) + 60.1;
                        }
                        break;
                    }
                    default:
                        errors.push("üëâ Unknown formula selected.");
                }
            } catch (ex) {
                // If anything unexpected happens, push a generic error.
                errors.push("üëâ Unexpected error while computing. Please recheck inputs.");
            }

            // If validation errors present -> show them
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValueBox.classList.add("hidden");
                return;
            }

            // final sanity check of computed height
            if (height === null || isNaN(height)) {
                errorMessage.innerHTML = "üëâ Unable to calculate height. Please ensure all fields are filled correctly.";
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValueBox.classList.add("hidden");
                return;
            }

            // acceptable adult human height bounds for this tool
            if (height < 50 || height > 250) {
                errorMessage.innerHTML = "üëâ Calculated height is out of realistic range (50‚Äì250 cm). Please check your inputs.";
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValueBox.classList.add("hidden");
                return;
            }

            // all good ‚Äî show result
            errorBox.classList.add("hidden");
            placeholder.classList.add("hidden");
            resultValueBox.classList.remove("hidden");

            // show value and feedback
            document.getElementById('rateValue').textContent = height.toFixed(1);
            feedbackContent.textContent = `Formula used: ${formulaText}`;

            // Update meter: percent relative to min/max (50-250) for visual cue
            const minH = 50, maxH = 250;
            let pct = ((height - minH) / (maxH - minH)) * 100;
            pct = Math.min(100, Math.max(0, pct));
            meterFill.style.width = pct.toFixed(1) + '%';

            // color coding: normal neutral blue; extreme low red; extreme high orange
            if (height < 140) {
                meterFill.style.backgroundColor = '#f39c12'; // orange for low-ish
            } else if (height > 200) {
                meterFill.style.backgroundColor = '#d35400'; // darker orange/red for high-ish
            } else {
                meterFill.style.backgroundColor = '#2980b9'; // neutral blue
            }
        }

        /**
         * Print helper (keeps date updated)
         */
        function printReport() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            if (document.getElementById('printDate')) {
                document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            }
            window.print();
        }
    </script>

</body>
</html>
{% endblock %}

<!-- 
1. Input Validation Rules (per field, by formula)

‚úÖ General Rules (apply to all formulas)

Age (years)

Allowed: 1 ‚Äì 120

No decimals (whole years only).

If <18, warn: ‚ÄúFormulas validated for adults; pediatric accuracy not guaranteed.‚Äù

Sex / Gender

Must be selected (no default to male).

Must match formula coding (male/female or race-specific as applicable).

Anthropometric measures (cm)

Semi-span: 30 ‚Äì 100 cm

Arm length: 30 ‚Äì 80 cm

Arm span (half): 40 ‚Äì 120 cm

Knee height: 20 ‚Äì 70 cm

Demi-span: 40 ‚Äì 120 cm

Recumbent height: 100 ‚Äì 220 cm

Decimals: max 1 decimal place

Must be positive, non-zero values

‚úÖ Formula-specific checks

Mitchell & Lipschitz: Semi-span must be within 30‚Äì100 cm.

WHO: Half arm-span 40‚Äì120 cm.

Rabito et al.:

Age: 18‚Äì90

Arm length + Semi-span together must not produce height <100 cm or >220 cm.

Gray et al.: Recumbent height must be 100‚Äì220 cm.

Chumlea & Cereda:

Age: 18‚Äì90

Knee height 20‚Äì70 cm.

Knee formula: Age and knee height both mandatory.

Demi-span formula: Demi-span 40‚Äì120 cm.

2. Output Validation Logic & Thresholds

Height Range:

Acceptable: 100‚Äì220 cm.

If <100 or >220 cm ‚Üí flag as implausible.

Decimal Formatting:

Round to 1 decimal place.

Feedback:

Display formula name used.

If height is out of range ‚Üí show:
‚ö†Ô∏è Result outside typical adult human height range. Please recheck inputs.
-->