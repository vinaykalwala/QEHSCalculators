{% extends 'base.html' %}
{% block title %}Sleep Cycle Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep Cycle Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
            margin-bottom: 15px;
        }
        .checkbox-group input { width: 20px; height: 20px; }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        /* Result Card */
        
.result-card::-webkit-scrollbar {
    width: 8px;
}

.result-card::-webkit-scrollbar-thumb {
    background: #1560bd;
    border-radius: 6px;
}

.result-card::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.result-card {
    justify-content: flex-start; /* align from top */
    align-items: stretch;
    min-height: 420px;
    text-align: center;
    overflow-y: auto;       /* Enable vertical scrolling */
    max-height: 450px;      /* Set max height to control output size */
    padding: 20px;          /* keep spacing */
}

        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
            font-size: 1rem;
            line-height: 1.8;
        }
        .feedback-content ul { padding-left: 20px; margin: 10px 0 0; }
        .feedback-content li { margin-bottom: 5px; }
        .feedback-content strong { color: #1560bd; }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li, .note-card ol {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon { font-size: 76px; flex-shrink: 0; text-align: center; }
        .error-message { font-size: 24px; line-height: 1.6; }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Sleep Cycle Calculator</h1>
            <p>Find the best time to go to bed based on your desired wake-up time.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Your Sleep Plan</h2>
                <div class="form-group">
                    <label for="wakeUpTime">I need to wake up at:</label>
                    <input type="time" id="wakeUpTime" class="form-input">
                </div>
                <div class="form-group">
                    <label for="fallAsleepTime">Time it takes me to fall asleep (minutes)</label>
                    <input type="number" id="fallAsleepTime" class="form-input" value="15">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="customCycle" onchange="renderInputs()">
                    <label for="customCycle">Use Custom Sleep Cycle Lengths</label>
                </div>
                <div id="conditionalInputs" class="hidden">
                     <div class="form-group">
                        <label for="firstCycle">First Sleep Cycle (minutes)</label>
                        <input type="number" id="firstCycle" class="form-input" value="90">
                    </div>
                     <div class="form-group">
                        <label for="succeedingCycles">Succeeding Cycles (minutes)</label>
                        <input type="number" id="succeedingCycles" class="form-input" value="90">
                    </div>
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Find My Bedtime</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="{% static 'images/resultimage.png' %}" alt="Health illustration">
                    <p>Enter your wake-up time to discover the best times to go to sleep for a refreshing morning.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden">
                    <div class="result-feedback">
                        <div class="feedback-title" id="feedbackTitle"></div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                     <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>üìòAbout This Calculator</h3>
                <p>
                    Sleep consists of <strong>90-minute-long cycles</strong>, repeated throughout the night. Each cycle includes
                    stages of <em>light sleep, deep sleep, and REM (rapid eye movement) sleep</em>.
                    Waking up at the end of a cycle helps you feel refreshed and alert.
                </p>
                <h3>Why Are Sleep Cycles Important?</h3>
                <p>
                    Waking up in the middle of a cycle can leave you feeling groggy and tired.
                    By aligning your wake-up time with the end of a cycle, you maximize the benefits of sleep
                    and improve your overall well-being.
                </p>
            </div>
            <div class="note-card">
    <h3>üìù Parameters</h3>
    <ul class="note-list">
        <li><strong>Wake-Up Time:</strong> Desired time to wake up (HH:MM format, 24-hour or AM/PM).</li>
        <li><strong>Time to Fall Asleep:</strong> Minutes it usually takes to fall asleep (1‚Äì120 minutes, whole number).</li>
        <li><strong>Custom Sleep Cycle (Optional):</strong> 
            <ul>
                <li>First Sleep Cycle: 30‚Äì180 minutes.</li>
                <li>Succeeding Cycles: 30‚Äì180 minutes.</li>
            </ul>
        </li>
    </ul>
</div>

            
            <div class="note-card">
                <h3>‚úÖ Input Validations</h3>
                <ul>
                    <li><strong>Wake-up Time:</strong> Must be a valid 24-hour or AM/PM time (e.g., 07:00 or 22:30). This is <em>mandatory</em>.</li>
                    <li><strong>Time to Fall Asleep:</strong> 
                       - Required field.  
                        - Must be between <strong>1 and 120 minutes</strong>.  
                        - Enter only whole numbers (no decimals).</li>
                    <li><strong>First Sleep Cycle (if custom cycles are used):</strong>  
                        - Required when "Use Custom Sleep Cycle Lengths" is checked.  
                        - Must be between <strong>30 and 180 minutes</strong>.  
                    </li>
                    <li><strong>Succeeding Sleep Cycles (if custom cycles are used):</strong>  
                        - Same rules as the First Cycle.  
                        - Ensures realistic and scientifically valid sleep cycle durations.</li>
                    <li><strong>Logical Consistency:</strong>  
                        - Wake-up time cannot be blank.  
                        - Negative or zero values are not allowed.  
                        - Extremely high or unrealistic values (e.g., 300 minutes to fall asleep) are blocked.</li>
                    <li><strong>Output Meaning:</strong>  
                        - Bedtimes are shown for 1‚Äì6 cycles.  
                        - <strong>6 cycles (‚âà9h)</strong> ‚Üí Recommended for long sleepers.  
                        - <strong>5 cycles (‚âà7.5h)</strong> ‚Üí Average sleepers, optimal rest.  
                        - <strong>4 cycles (‚âà6h)</strong> ‚Üí Minimum acceptable for safety-critical jobs.  
                    </li>
                </ul>
            </div>
            <div class="note-card">
    <h3>‚úÖ Output Validations</h3>
    <ul class="note-list">
        <li><strong>Bedtime Calculations:</strong> 1‚Äì6 sleep cycles recommended.</li>
        <li><strong>Total Sleep Duration:</strong> 
            <ul>
                <li>Below 3h ‚Üí ‚ùå Unsafe (high fatigue risk).</li>
                <li>3‚Äì5h ‚Üí ‚ö†Ô∏è Short sleep (alertness risk).</li>
                <li>6‚Äì9h ‚Üí ‚úÖ Optimal for adults.</li>
                <li>10h ‚Üí ‚ö†Ô∏è Excessive, may indicate abnormal sleep pattern.</li>
            </ul>
        </li>
        <li><strong>Logical Checks:</strong> No negative or zero values; wake-up time must be provided; fall asleep time cannot exceed unrealistic limits.</li>
        <li><strong>Time Wrapping:</strong> Bedtime correctly rolls back across midnight.</li>
    </ul>
</div>


            <div class="note-card">
    <h3>üìê Governing Principle</h3>
    <p>
        A sleep calculator is typically based on recommendations from reputable health organizations such as the American Academy of Sleep Medicine (AASM), the National Sleep Foundation (NSF), or the American Academy of Pediatrics (AAP) and the Centers for Disease Control and Prevention (CDC). These calculators use age-specific guidelines for ideal sleep durations to help individuals determine their bedtime and wake times to get the recommended amount of sleep for their age group.
    </p>

    <h3 style="margin-top:12px; color:#1976d2;">How Sleep Calculators Work</h3>
    <ul class="note-list">
        <li><b>Age-Based Guidelines:</b> The calculator first asks for your age to provide a starting point for how much sleep is needed.</li>
        <li><b>Wake-Up Time:</b> You then select your desired or typical wake-up time.</li>
        <li><b>Bedtime Calculation:</b> The calculator determines your ideal bedtime by counting backward from your wake-up time, based on the recommended sleep duration for your age.</li>
    </ul>

    <h3 style="margin-top:12px; color:#1976d2;">Example Recommendations from Organizations</h3>
    <ul class="note-list">
        <li><b>AASM/Everyday Health:</b> 7 or more hours for adults, 8-10 hours for teens (13-18), and 9-12 hours for school-aged children (6-12).</li>
        <li><b>AAP/CDC/Healthline:</b> 7-9 hours for adults, 8-10 hours for teens (13-18), and 9-12 hours for school-aged children (6-12).</li>
    </ul>

    <h3 style="margin-top:12px; color:#1976d2;">Important Considerations</h3>
    <ul class="note-list">
        <li><b>Individual Needs:</b> While these are general guidelines, individual sleep needs can vary.</li>
        <li><b>Sleep Cycles:</b> Some sleep calculators also incorporate sleep cycle timing to help you wake up at the end of a sleep cycle, leading to a more refreshed feeling.</li>
        <li><b>Holistic Approach:</b> For best results, combine the use of a sleep calculator with good sleep hygiene, such as a balanced diet, regular exercise, and a dark, quiet sleep environment.</li>
    </ul>
</div>
        
        
            <div class="note-card">
                <h3>Recommended Sleep Durations by Age</h3>
                <ul class="note-list">
                    <li><strong>Adults (18-64 years):</strong> 7-9 hours (approx. 5-6 cycles)</li>
                    <li><strong>Older Adults (65+ years):</strong> 7-8 hours (approx. 5 cycles)</li>
                    <li><strong>Teenagers (14-17 years):</strong> 8-10 hours (approx. 5-6 cycles)</li>
                    <li><strong>Children (6-13 years):</strong> 9-11 hours (approx. 6-7 cycles)</li>
                </ul>
            </div>
        

            <div class="note-card">
                <h3>‚ö†Ô∏è Disclaimer</h3>
                <p>
                    This calculator provides estimates for educational purposes only.
                    It should not replace medical advice or diagnosis.
                    Always consult healthcare professionals for a comprehensive assessment of your sleep health.
                </p>
            </div>
            <div class="note-card">
    <h3>üí° Conclusion</h3>
    <p>
        The Sleep Cycle Calculator provides a <strong>scientifically-based approach</strong> to optimize sleep timing. 
        By aligning bedtimes with natural 90-minute sleep cycles, it helps users wake up feeling refreshed, alert, and energized. 
        Regular use can improve sleep quality, reduce grogginess, and support overall well-being. 
        This tool is intended for educational purposes and should not replace medical advice.
    </p>
</div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Set default wake-up time to 7:00 AM
            document.getElementById('wakeUpTime').value = '07:00';
        });

        function renderInputs() {
            const customCycle = document.getElementById('customCycle').checked;
            document.getElementById('conditionalInputs').classList.toggle('hidden', !customCycle);
        }

        function calculateAndDisplay() {
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');

            // Reset UI
            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');

            let errors = [];

            // Validation helper
            function getVal(id, label, opts = {}) {
                const el = document.getElementById(id);
                const raw = el.value?.toString().trim();

                if (!raw) {
                    if (opts.required) errors.push(`üëâ ${label} is required.`);
                    return null;
                }

                const num = parseFloat(raw);

                if (isNaN(num) || num < 0) {
                    errors.push(`üëâ ${label} must be a valid non-negative number.`);
                    return null;
                }

                if (opts.min !== undefined && num < opts.min) {
                    errors.push(`üëâ ${label} must be ‚â• ${opts.min}.`);
                }
                if (opts.max !== undefined && num > opts.max) {
                    errors.push(`üëâ ${label} must be ‚â§ ${opts.max}.`);
                }

                return num;
            }

            // Collect values
            const wakeUpTime = document.getElementById('wakeUpTime').value;
            if (!wakeUpTime) {
                errors.push('üëâ A valid wake-up time is required.');
            }

            const fallAsleepTime = getVal('fallAsleepTime', 'Time to fall asleep (minutes)', {
                min: 1, max: 120, required: true
            });

            const customCycle = document.getElementById('customCycle').checked;
            let firstCycle = 90;
            let succeedingCycles = 90;

            if (customCycle) {
                firstCycle = getVal('firstCycle', 'First Sleep Cycle (minutes)', {
                    min: 30, max: 180, required: true
                });
                succeedingCycles = getVal('succeedingCycles', 'Succeeding Cycles (minutes)', {
                    min: 30, max: 180, required: true
                });
            }

            // Stop on errors
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }

            // Parse wake-up time
            const [hours, minutes] = wakeUpTime.split(':').map(Number);
            const wakeUpDate = new Date();
            wakeUpDate.setHours(hours, minutes, 0, 0);

            // Calculate bedtimes
            let bedtimes = '<ul>';
            for (let cycles = 6; cycles >= 1; cycles--) {
                const totalSleepMinutes = firstCycle + (succeedingCycles * (cycles - 1));
                const totalOffset = totalSleepMinutes + fallAsleepTime;

                let bedtime = new Date(wakeUpDate.getTime() - totalOffset * 60000);
                let hh = bedtime.getHours().toString().padStart(2, '0');
                let mm = bedtime.getMinutes().toString().padStart(2, '0');

                const sleepDurationHours = Math.floor(totalSleepMinutes / 60);
                const sleepDurationMins = totalSleepMinutes % 60;

                let recommendation = "";
                if (cycles === 6) recommendation = "(‚âà9h sleep, recommended for long sleepers)";
                if (cycles === 5) recommendation = "(‚âà7.5h sleep, recommended for average sleepers)";
                if (cycles === 4) recommendation = "(‚âà6h sleep, minimum acceptable for safety-critical roles)";

                bedtimes += `<li>Go to bed at <strong>${hh}:${mm}</strong> ‚Üí ${cycles} cycle${cycles > 1 ? 's' : ''} (${sleepDurationHours}h ${sleepDurationMins}m) ${recommendation}</li>`;
            }
            bedtimes += '</ul>';

            // Show results
            placeholder.classList.add('hidden');
            resultValueBox.classList.remove('hidden');
            document.getElementById('feedbackTitle').textContent =
                `To wake up refreshed at ${wakeUpTime}, go to bed at one of these times:`;
            document.getElementById('feedbackContent').innerHTML = bedtimes;
        }

        function printReport() {
            window.print();
        }
    </script>

</body>
</html>
{% endblock %}

<!-- 
1. Input Validation Rules (Real-world QEHS/Fatigue Standards)
Wake-up Time

Must be a valid time-of-day format (HH:MM 24-hour or 12-hour AM/PM).

Required input ‚Äî cannot be blank.

Must not exceed 24:00.

Time to Fall Asleep (minutes)

Minimum: 1 minute (people don‚Äôt fall asleep instantly).

Maximum: 120 minutes (sleep latency above 2 hours usually indicates a disorder).

Must be an integer (whole minutes).

Units: minutes only.

Sleep Cycle Lengths (minutes)

Default: 90 min (scientifically established average).

Custom Input:

First cycle: 70‚Äì110 minutes (normal range).

Subsequent cycles: 70‚Äì120 minutes.

Must be whole numbers, not decimals.

Must be logical: succeeding cycle ‚â• first cycle in most cases.

2. Output Validation Logic & Thresholds

Cycles Calculated: 1‚Äì6 cycles (standard for FRMS, since average sleep 4.5‚Äì9h).

Bedtimes: Must wrap correctly across midnight (use modular arithmetic).

Total Sleep Duration:

Below 3h = ‚ùå Flag as unsafe (severe fatigue risk).

3‚Äì5h = ‚ö†Ô∏è Short sleep (risk for alertness issues in audits).

6‚Äì9h = ‚úÖ Optimal range for most adults.

10h = ‚ö†Ô∏è Excessive, may indicate fatigue disorder.

3. Edge Case Validations

Division by zero: Avoided by enforcing min cycle length > 0.

Wake-up near midnight: Ensure bedtime rolls back into previous day properly.

Fall asleep > cycle length: Reject (nonsense input).

Negative bedtime minutes: Adjust using modulo 1440 (minutes/day).

4. Why These Validations Matter (QEHS/FRMS Compliance)

Fatigue management (ILO, OSHA, ISO 45001) requires valid, scientifically defensible sleep calculations.

Incorrect inputs ‚Üí false safety assessments in audits ‚Üí regulatory findings.

Outlier prevention ensures calculator aligns with fatigue risk management standards used in oil & gas, aviation, and fire safety operations.
-->