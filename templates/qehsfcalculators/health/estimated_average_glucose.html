{% extends 'base.html' %}
{% block title %}Estimated Average Glucose (eAG) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimated Average Glucose (eAG) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
            overflow-y: auto;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        .print-btn:hover {
            background: #1560bd;
        }
        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: center;
            justify-content: center;
        }
        .result-value {
            width: 100%;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 0;
        }
        .rate-label {
            color: #7f8c8d;
            font-size: 16px;
            font-weight: 500;
        }
        #hba1cValue {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-top: 10px;
        }
        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        .note-card:hover {
            transform: translateY(-2px);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        /* Table styles */
        .custom-table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .custom-table thead {
            background-color: #1560bd;
            color: white;
        }
        .custom-table th, .custom-table td {
            padding: 12px 16px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .custom-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }
        /* Toggle helper */
        .hidden {
            display: none;
        }
        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }
        .back-btn {
            background: linear-gradient(#1560bd,#000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Estimated Average Glucose (eAG) Calculator</h1>
            <p>Convert your HbA1c (%) lab result to an estimated average glucose level.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Enter Your HbA1c</h2>
                <div class="form-group">
                    <label for="diabetes">Do you have diabetes?</label>
                    <select id="diabetes" class="form-select">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="hba1c">HbA1c (%)</label>
                    <input type="number" id="hba1c" class="form-input" step="0.1" placeholder="e.g., 5.5">
                </div>
                <button class="calculate-btn" onclick="calculateEAG()">Calculate eAG</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Health illustration">
                    <p>Enter your HbA1c value to see your estimated average glucose and health category.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div class="result-value hidden" id="resultValue">
                    <h2>Estimated Average Glucose (eAG)</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0</div>
                        <div class="rate-label">mg/dL</div>
                    </div>
                    <p id="hba1cValue">From HbA1c: 0.0%</p>
                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Normal</span><span>Prediabetes</span><span>Diabetes</span>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Interpretation</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    This tool translates your <strong>HbA1c test result</strong>‚Äîa measure of your average blood sugar over 2-3 months‚Äîinto an <strong>Estimated Average Glucose (eAG)</strong> value. The eAG is presented in mg/dL, the same unit used by home glucose meters, making it easier to understand your long-term glucose control in a familiar format.
                </p>
            </div>

            <div class="note-card">
                <h3>‚öôÔ∏è Parameters Used</h3>
                <p>The calculator uses your HbA1c value to determine your eAG and classify it according to established health ranges.</p>
                 <ul class="note-list">
                    <li><strong>HbA1c below 5.7%:</strong> Normal</li>
                    <li><strong>HbA1c 5.7% ‚Äì 6.4%:</strong> Prediabetes</li>
                    <li><strong>HbA1c 6.5% and above:</strong> Diabetes</li>
                </ul>
                <h5 style="text-align: center;">HbA1c to Average Glucose Conversion Chart</h5>
                <div style="overflow-x:auto;">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>HbA1c (%)</th>
                                <th>HbA1c (mmol/mol)</th>
                                <th>eAG (mmol/L)</th>
                                <th>eAG (mg/dL)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>5</td><td>31</td><td>5.4 (4.2‚Äì6.7)</td><td>97 (76‚Äì120)</td></tr>
                            <tr><td>6</td><td>42</td><td>7.0 (5.5‚Äì8.5)</td><td>126 (100‚Äì152)</td></tr>
                            <tr><td>7</td><td>53</td><td>8.6 (6.8‚Äì10.3)</td><td>154 (123‚Äì185)</td></tr>
                            <tr><td>8</td><td>64</td><td>10.2 (8.1‚Äì12.1)</td><td>183 (147‚Äì217)</td></tr>
                            <tr><td>9</td><td>75</td><td>11.8 (9.4‚Äì13.9)</td><td>212 (170‚Äì249)</td></tr>
                            <tr><td>10</td><td>86</td><td>13.4 (10.7‚Äì15.7)</td><td>240 (193‚Äì282)</td></tr>
                            <tr><td>11</td><td>97</td><td>14.9 (12.0‚Äì17.5)</td><td>269 (217‚Äì314)</td></tr>
                            <tr><td>12</td><td>108</td><td>16.5 (13.3‚Äì19.3)</td><td>298 (240‚Äì347)</td></tr>
                            <tr><td>13</td><td>119</td><td>18.1 (15‚Äì21)</td><td>326 (260‚Äì380)</td></tr>
                            <tr><td>14</td><td>130</td><td>19.7 (16‚Äì23)</td><td>355 (290‚Äì410)</td></tr>
                            <tr><td>15</td><td>140</td><td>21.3 (17‚Äì25)</td><td>384 (310‚Äì440)</td></tr>
                            <tr><td>16</td><td>151</td><td>22.9 (19‚Äì26)</td><td>413 (330‚Äì480)</td></tr>
                            <tr><td>17</td><td>162</td><td>24.5 (20‚Äì28)</td><td>441 (460‚Äì510)</td></tr>
                            <tr><td>18</td><td>173</td><td>26.1 (21‚Äì30)</td><td>470 (380‚Äì540)</td></tr>
                            <tr><td>19</td><td>184</td><td>27.7 (23‚Äì32)</td><td>499 (410‚Äì570)</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="note-card">
                <h3>‚úÖ Input Validation Rules</h3>
                <p>To provide an accurate result, the calculator requires valid input:</p>
                <ul class="note-list">
                    <li><strong>Required Field:</strong> An HbA1c value must be entered.</li>
                    <li><strong>Numeric Only:</strong> The input must be a number.</li>
                    <li><strong>Valid Range:</strong> The HbA1c value must be between 2.5% and 20%.</li>
                    <li><strong>Logical Check:</strong> A warning is displayed if the HbA1c level indicates diabetes (‚â•6.5%) but "No" is selected for the diabetes status question.</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>‚úÖ Output Validations</h3>
                <p>The interpretation message is based on your HbA1c value and diabetes status:</p>
                <ul class="note-list">
                    <li><strong>HbA1c < 5.7%:</strong> "Normal Range: Your average blood glucose is within the healthy range. Keep up your lifestyle habits."</li>
                    <li><strong>HbA1c 5.7% - 6.4%:</strong> "Prediabetes Range: Your blood glucose is higher than normal. Consider lifestyle changes to prevent type 2 diabetes."</li>
                    <li><strong>HbA1c ‚â• 6.5%:</strong> "Diabetes Range: Your blood glucose is in the diabetic range. Consult a healthcare provider."</li>
                    <li>An additional warning, "‚ö†Ô∏è Inconsistency detected: HbA1c suggests diabetes, but 'No' was selected," will appear if applicable.</li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>‚öñÔ∏è Governing Principle</h3>
                <p>
                    The standard for the Estimated Average Glucose (eAG) calculator is based on the American Diabetes Association (ADA) recommendation and the ADAG study, which established the relationship between the HbA1c test and eAG. This standard allows healthcare providers to use the familiar units of mg/dL or mmol/L found on home blood glucose meters to report and interpret HbA1c results, making it easier for patients to understand their average blood glucose levels.
                </p>
                <p>Here‚Äôs a breakdown of the standard:</p>
                <ul class="note-list">
                    <li><strong>Standardizing Terminology:</strong> The ADA introduced the term eAG to bridge the gap between the HbA1c percentage and the familiar units of blood glucose seen on home meters.</li>
                    <li><strong>The ADAG Study:</strong> The relationship between A1C and eAG was defined by the ADAG Study.</li>
                    <li><strong>Purpose:</strong> The standard serves to improve communication between healthcare providers and patients by providing a more intuitive way to understand blood glucose control.</li>
                </ul>
                <p>
                    By adopting this standard, the eAG calculator allows for a more practical and understandable interpretation of A1C results in the context of daily blood sugar monitoring.
                </p>
            </div>

            <div class="note-card">
                <h3>üßæ Conclusion</h3>
                <p>
                    This eAG calculator is an educational tool to help you better understand your lab results and facilitate conversations with your healthcare provider. It is not a substitute for professional medical advice, diagnosis, or treatment. Always consult with a qualified health professional for any health concerns or before making any decisions related to your health or treatment.
                </p>
            </div>
        </div>

    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    if (document.getElementById('printDate')) {
        document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
    }
});

function calculateEAG() {
    const hba1cInput = document.getElementById('hba1c').value.trim();
    const diabetesStatus = document.getElementById('diabetes') ? document.getElementById('diabetes').value : null;

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    // Reset states
    errorBox.classList.add("hidden");
    placeholder.classList.add("hidden");
    resultValue.classList.add("hidden");

    // Validation: Required input
    if (!hba1cInput) {
        errorMessage.innerHTML = "üëâ Please enter your HbA1c value.";
        errorBox.classList.remove("hidden");
        return;
    }

    const hba1cValue = parseFloat(hba1cInput);

    // Validation: Numeric & Physiological Range (2.5% ‚Äì 20%)
    if (isNaN(hba1cValue) || hba1cValue < 2.5 || hba1cValue > 20) {
        errorMessage.innerHTML = "‚ùå HbA1c must be between 2.5% and 20%.";
        errorBox.classList.remove("hidden");
        return;
    }

    // Formula: eAG (mg/dL) = (28.7 √ó HbA1c) - 46.7
    const eAG = parseFloat((28.7 * hba1cValue - 46.7).toFixed(1));

    // Interpretation thresholds
    let feedback = "";
    let meterWidth = "0%";
    let meterColor = "#2ecc71";

    if (hba1cValue < 5.7) {
        meterWidth = '33%';
        meterColor = '#2ecc71';
        feedback = "<strong>Normal Range:</strong> Your average blood glucose is within the healthy range. Keep up your lifestyle habits.";
    } else if (hba1cValue < 6.5) {
        meterWidth = '66%';
        meterColor = '#f1c40f';
        feedback = "<strong>Prediabetes Range:</strong> Your blood glucose is higher than normal. Consider lifestyle changes to prevent type 2 diabetes.";
    } else {
        meterWidth = '95%';
        meterColor = '#e74c3c';
        feedback = "<strong>Diabetes Range:</strong> Your blood glucose is in the diabetic range. Consult a healthcare provider.";
    }

    // Cross-field consistency check (optional dropdown exists)
    if (hba1cValue >= 6.5 && diabetesStatus === "no") {
        feedback += "<br>‚ö†Ô∏è Inconsistency detected: HbA1c suggests diabetes, but 'No' was selected.";
    }

    // Update UI with results
    document.getElementById('rateValue').textContent = eAG.toFixed(0);
    document.getElementById('hba1cValue').textContent = `From HbA1c: ${hba1cValue.toFixed(1)}%`;
    document.getElementById('feedbackContent').innerHTML = feedback;

    const meterFill = document.getElementById('meterFill');
    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;

    resultValue.classList.remove('hidden');
}

function printReport() {
    const now = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    if (document.getElementById('printDate')) {
        document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
    }
    window.print();
}
    </script>

</body>
</html>
{% endblock %}

<!-- 
1. Input Validation Rules (Real-World Compliance Approach)

Just like QEHS safety metrics (e.g., incident rate, exposure limits), HbA1c and eAG must follow strict input and reporting validation:

Field	Expected Range	Units	Validation Rules	Compliance Rationale
HbA1c (%)	2.5 ‚Äì 20.0	%	Must be a decimal number, up to 1 decimal place, not zero, not negative.	Human physiological limits. Prevents false results (like -1%, 100%).
Diabetes Status	yes / no (required field)	N/A	Must be selected, cannot be blank.	Consistency check for interpretation vs. user declaration.
Cross-field Check	If HbA1c ‚â• 6.5 but Diabetes = "No" ‚Üí warn	N/A	Flag potential inconsistency.	Similar to QEHS audits flagging when KPI contradicts reported status.
2. Output Validation Logic & Thresholds

Using the ADA (American Diabetes Association) standards (like NFPA thresholds in fire safety), we set medically recognized cutoffs:

Normal: HbA1c < 5.7% ‚Üí eAG < 117 mg/dL

Prediabetes: HbA1c 5.7‚Äì6.4% ‚Üí eAG ~ 117‚Äì137 mg/dL

Diabetes: HbA1c ‚â• 6.5% ‚Üí eAG ‚â• 137 mg/dL

‚û°Ô∏è Output should not only display numbers but also provide category, color-coded feedback, and a compliance disclaimer (‚Äúfor awareness only, not diagnostic‚Äù).

3. Edge Case Validations

Empty input ‚Üí Block calculation, show error.

Non-numeric / special characters ‚Üí Reject.

HbA1c = 0, <2.5, or >20 ‚Üí Show error: ‚ÄúOut of physiological range.‚Äù

Division by zero ‚Üí Not applicable here, but validation ensures formula safety.

Cross-field inconsistency: e.g., HbA1c = 12% but Diabetes = "No" ‚Üí Show a ‚ö†Ô∏è warning.

Extreme outlier HbA1c (e.g., 50%) ‚Üí Reject; aligns with safety audits rejecting impossible exposure values.
-->