{% extends 'base.html' %}
{% block title %}MAP & Pulse Pressure Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAP & Pulse Pressure Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }
        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }
        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px; /* Fixed height to match reference */
            overflow-y: auto;
            justify-content: center;
        }
        .calc-card:hover {
            transform: translateY(-5px);
        }
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }
        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }
        /* Result Card */
        .result-placeholder {
            text-align: center;
            margin: auto;
        }
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: baseline;
            justify-content: center;
        }
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
        }
        .rate-label {
            color: #2980b9;
            font-weight: bold;
            font-size: 20px;
        }
        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0 10px;
            overflow: hidden;
        }
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out, background-color 1s ease-in-out;
            border-radius: 6px;
        }
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feedback-content {
            color: #34495e;
        }
        /* Notes Section */
        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }
        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        .note-list { margin: 0; padding-left: 18px; }
        /* Error Message */
        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px; padding: 20px;
            text-align: left; gap: 12px; margin-top: 20px;
        }
        .error-icon { font-size: 76px; flex-shrink: 0; text-align: center; }
        .error-message { font-size: 24px; line-height: 1.6; }
        .hidden { display: none; }
        .btn-container { display: flex; justify-content: center; margin: 30px 0; }
        .back-btn {
            background: linear-gradient(#1560bd,#000040); color: #ffffff; border: 2px solid #1560bd;
            padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 8px;
            text-decoration: none; transition: all 0.3s ease; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'healthcategory_calculators'%}" class="back-btn">Back To Health Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>MAP & Pulse Pressure Calculator</h1>
            <p>Calculate Mean Arterial Pressure and Pulse Pressure from BP readings.</p>
        </div>

        <div class="calc-content">
            <div class="calc-card">
                <h2>Blood Pressure Readings</h2>
                <div class="form-group">
                    <label for="systolicBP">Systolic Blood Pressure (SBP)</label>
                    <input type="number" id="systolicBP" class="form-input" placeholder="Enter top number (mmHg)">
                </div>
                <div class="form-group">
                    <label for="diastolicBP">Diastolic Blood Pressure (DBP)</label>
                    <input type="number" id="diastolicBP" class="form-input" placeholder="Enter bottom number (mmHg)">
                </div>
                <button class="calculate-btn" onclick="calculateAndDisplay()">Calculate</button>
            </div>

            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="{% static 'images/resultimage.png' %}" alt="Health illustration">
                    <p>Enter your blood pressure readings to calculate MAP and Pulse Pressure.</p>
                </div>
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                <div id="resultValue" class="hidden" style="text-align: center;">
                    <h2>Mean Arterial Pressure (MAP)</h2>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0</div>
                        <div class="rate-label">mmHg</div>
                    </div>
                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low</span>
                        <span>Normal (70-100)</span>
                        <span>High</span>
                    </div>
                    <div class="result-feedback">
                        <div class="feedback-title">Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <div class="note-card">
                <h3>üîé About This Calculator
</h3>
                <p>
                    <strong>Mean Arterial Pressure (MAP)</strong> gives an overall idea of the average pressure in a person‚Äôs
                    arteries throughout one heartbeat cycle.
                    Rather than focusing only on the highest (systolic) or lowest (diastolic) pressures, MAP provides a more
                    balanced view that reflects how well blood is flowing to vital organs.
                    It gives more weight to the diastolic phase, as the heart spends more time relaxing between beats than it
                    does contracting.
                </p>
                <p>
                    MAP is considered a better indicator of organ perfusion than systolic blood pressure (SBP) alone. A MAP of
                    at least <strong>60 mmHg</strong> is generally required to perfuse the coronary arteries, brain, and
                    kidneys.
                </p>
                <h3>About Pulse Pressure (PP)</h3>
                <p>
                    <strong>Pulse Pressure (PP)</strong> is the difference between the two blood pressure numbers ‚Äî the peak
                    pressure during heart contraction and the minimum pressure when the heart rests.
                    It reflects the flexibility and health of arteries. A larger gap can indicate stiffer arteries, while a
                    narrow gap may occur in cases of low heart output or blood loss.
                </p>
            </div>
        
            <div class="note-card">
                <h3>‚ùìParameters used</h3>
                <ul class="note-list">
                    <li><strong>Systolic Blood Pressure (SBP):</strong> The pressure in your arteries when your heart contracts
                        and pumps blood.</li>
                    <li><strong>Diastolic Blood Pressure (DBP):</strong> The pressure when your heart is at rest between beats.
                    </li>
                    <li><strong>MAP:</strong> Estimated by giving more weight to diastolic pressure because the heart remains
                        relaxed longer than contracted. It‚Äôs important in assessing whether tissues are getting enough blood
                        supply.</li>
                    <li><strong>PP:</strong> Indicates the force your heart generates with each beat and how flexible your blood
                        vessels are in handling that force.</li>
                </ul>
            </div>
        
            <!-- üìå Note Section for Input Validations -->
            <div class="note-card">
                <h3>‚úÖ Input Validations</h3>
                <ul class="note-list">
                    <li><strong>Systolic BP (SBP):</strong> Must be between <b>70 and 250 mmHg</b>. Values below 70 or above 250 are
                        considered unrealistic in normal practice.</li>
                    <li><strong>Diastolic BP (DBP):</strong> Must be between <b>40 and 150 mmHg</b>. Values outside this range are
                        flagged as invalid.</li>
                    <li><strong>SBP vs DBP:</strong> SBP must always be <b>greater than</b> DBP. If not, the reading is invalid.
                    </li>
                    <li><strong>Pulse Pressure (PP):</strong> PP = SBP ‚àí DBP must be at least <b>10 mmHg</b> (narrow pulse pressure
                        indicates poor cardiac output) and not exceed <b>120 mmHg</b> (very wide pressure is unrealistic).</li>
                    <li><strong>Decimals:</strong> Inputs should have at most <b>1 decimal place</b>. Example: <code>120.5</code> is
                        valid, but <code>120.55</code> is not.</li>
                    <li><strong>Required Fields:</strong> Both SBP and DBP are mandatory. Leaving them blank will show an error.
                    </li>
                </ul>
            </div>
            <div class="note-card">
    <h3>‚úÖ Output Validations</h3>
    <ul class="note-list">
            <ul>
                <li><b>Low MAP (&lt; 70 mmHg):</b> MAP is low, which may indicate insufficient organ perfusion.</li>
                <li><b>Normal MAP (70‚Äì100 mmHg):</b>MAP is within the normal range.</li>
                <li><b>High MAP (&gt; 100 mmHg):</b> MAP is high, which may indicate increased cardiovascular risk.</li>
            </ul>
        </li>
        <li><strong>Pulse Pressure (PP):</strong>
            <ul>
                <li><b>Narrow PP (&lt; 30 mmHg):</b>Pulse Pressure is low (narrow), which may indicate reduced cardiac output.</li>
                <li><b>Normal PP (30‚Äì50 mmHg):</b> Pulse Pressure is within the normal range.</li>
                <li><b>Wide PP (&gt; 60 mmHg):</b>Pulse Pressure is high (wide), which can be a risk factor for arterial stiffness or cardiovascular disease.</li>
            </ul>
        </li>
    </ul>
</div>


    

            <div class="note-card">
    <h3>üìê Governing Principle</h3>
    <p>
        A MAP and PP calculator is not of one single standard but uses formulas like the "standard" Gauer formula (MAP = DBP + 1/3 PP) from 1960, which is still widely used for estimation, and the "standard" definition of Pulse Pressure (PP = SBP - DBP), according to sources like National Institutes of Health (NIH) and Nature. There are also alternative formulas and various classifications (like those from the American Heart Association or International Hypertension Guidelines) for interpreting the calculated MAP values, depending on the specific clinical or research context.
    </p>

    <h3 style="margin-top:12px; color:#1976d2;">Standard Formulas</h3>
    <ul class="note-list">
        <li><b>Pulse Pressure (PP):</b> The standard definition is simply the difference between systolic and diastolic pressure: PP = SBP - DBP.</li>
        <li><b>Mean Arterial Pressure (MAP):</b> The most common and widely used formula to estimate MAP from non-invasive readings is the Gauer formula from 1960: MAP = DBP + ‚Öì PP. This formula is often preferred for its simplicity in clinical settings.</li>
    </ul>

    <h3 style="margin-top:12px; color:#1976d2;">Contextual Standards and Interpretations</h3>
    <ul class="note-list">
        <li><b>Clinical Interpretation:</b> The calculated MAP value is then interpreted against established guidelines, which can vary. For example, the American Heart Association (AHA) and the International Hypertension Guidelines (IHG-IV) have their own categories for defining MAP.</li>
        <li><b>Alternative Formulas:</b> Researchers have developed other formulas that incorporate factors like heart rate or use different weighting for the diastolic pressure.</li>
        <li><b>On-Device Measurement:</b> Modern automatic blood pressure devices may use proprietary algorithms and measure MAP directly (rather than calculating it), potentially yielding different results than the standard formula.</li>
    </ul>

    <p>
        In summary: When using a MAP and PP calculator, understand that the calculations are based on standard formulas, but the interpretation of the result will depend on the specific guidelines and context being used.
    </p>
</div>
<div class="note-card">
<h3>ü©∫ Conclusion</h3>
    <p>
        A healthy cardiovascular system typically maintains a <b>MAP of 70‚Äì100 mmHg</b> and a <b>Pulse Pressure of 30‚Äì50 mmHg</b>. 
        Persistent deviation from these ranges may suggest underlying issues such as hypotension, hypertension, or reduced cardiac efficiency. 
        These calculations are screening tools ‚Äî always consult a healthcare professional for clinical diagnosis and treatment.
    </p>
</div>

        </div>

    </div>

    <script>
        function calculateAndDisplay() {
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValueBox = document.getElementById('resultValue');

            // Reset UI
            errorBox.classList.add('hidden');
            resultValueBox.classList.add('hidden');
            placeholder.classList.remove('hidden');

            let errors = [];

            // Validation helper
            function getVal(id, label, opts = {}) {
                const el = document.getElementById(id);
                const raw = el.value?.toString().trim();

                if (!raw) {
                    errors.push(`üëâ ${label} is required.`);
                    return null;
                }
                const num = parseFloat(raw);

                if (isNaN(num) || num <= 0) {
                    errors.push(`üëâ Enter a valid positive number for ${label}.`);
                    return null;
                }
                if (opts.min !== undefined && num < opts.min) {
                    errors.push(`üëâ ${label} must be ‚â• ${opts.min} mmHg.`);
                }
                if (opts.max !== undefined && num > opts.max) {
                    errors.push(`üëâ ${label} must be ‚â§ ${opts.max} mmHg.`);
                }

                // Restrict decimals to max 1 place
                if (raw.includes('.') && raw.split('.')[1].length > 1) {
                    errors.push(`üëâ ${label} should not have more than 1 decimal place.`);
                }

                return num;
            }

            // Input ranges based on clinical safety
            const sbp = getVal('systolicBP', 'Systolic BP', { min: 70, max: 250 });
            const dbp = getVal('diastolicBP', 'Diastolic BP', { min: 40, max: 150 });

            // Cross-field logical validations
            if (sbp && dbp) {
                if (sbp <= dbp) {
                    errors.push('üëâ Systolic BP must be greater than Diastolic BP.');
                }
                if (sbp - dbp < 10) {
                    errors.push('üëâ Difference between SBP and DBP (Pulse Pressure) is unusually narrow.');
                }
                if (sbp - dbp > 120) {
                    errors.push('üëâ Pulse Pressure is extremely wide ‚Äî input may be unrealistic.');
                }
            }

            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add('hidden');
                return;
            }

            // Formula (validated version)
            const map = ((2 * dbp) + sbp) / 3;   // Standard MAP formula
            const pp = sbp - dbp;

            placeholder.classList.add('hidden');
            resultValueBox.classList.remove('hidden');

            document.getElementById('rateValue').textContent = map.toFixed(1);

            // Meter calculation
            const meterFill = document.getElementById('meterFill');
            const minMAP = 50;
            const maxMAP = 120;
            let pct = ((map - minMAP) / (maxMAP - minMAP)) * 100;
            pct = Math.max(0, Math.min(100, pct));
            meterFill.style.width = pct + '%';

            // MAP interpretation
            let mapInterpretation;
            if (map < 70) {
                meterFill.style.backgroundColor = '#e67e22'; // Orange
                mapInterpretation = 'MAP is low, which may indicate insufficient organ perfusion.';
            } else if (map > 100) {
                meterFill.style.backgroundColor = '#e74c3c'; // Red
                mapInterpretation = 'MAP is high, which may indicate increased cardiovascular risk.';
            } else {
                meterFill.style.backgroundColor = '#2ecc71'; // Green
                mapInterpretation = 'MAP is within the normal range.';
            }

            // PP interpretation
            let ppInterpretation;
            if (pp > 60) {
                ppInterpretation = 'Pulse Pressure is high (wide), which can be a risk factor for arterial stiffness or cardiovascular disease.';
            } else if (pp < 30) {
                ppInterpretation = 'Pulse Pressure is low (narrow), which may indicate reduced cardiac output.';
            } else {
                ppInterpretation = 'Pulse Pressure is within the normal range.';
            }

            document.getElementById('feedbackContent').innerHTML = `
                <strong>Pulse Pressure: ${pp.toFixed(1)} mmHg</strong><br>
                <em>${mapInterpretation} ${ppInterpretation}</em>
            `;
        }

        function printReport() {
            window.print();
        }
    </script>

</body>
</html>
{% endblock %}

<!-- 
1. Input Validation Rules (Real-world Standards)
Systolic BP (SBP):

Acceptable range: 50‚Äì300 mmHg

Must be an integer (decimals not expected in clinical recording).

Must always be greater than DBP (logical consistency).

Values >250 mmHg should trigger a critical outlier alert.

Diastolic BP (DBP):

Acceptable range: 30‚Äì200 mmHg

Must be an integer.

Cannot be greater than or equal to SBP.

DBP <40 mmHg indicates possible shock/organ perfusion risk.

Cross-field Dependency:

SBP > DBP is mandatory.

Pulse Pressure (PP = SBP ‚àí DBP) should be 20‚Äì60 mmHg in normal physiology. Values outside this must raise alerts.

General Rules:

Empty Fields: No calculation until both SBP and DBP are filled.

Zero/Negative Values: Invalid.

Outliers: SBP <50 or >300, DBP <30 or >200 ‚Üí flagged as unrealistic.

Units: All inputs must be in mmHg.

2. Output Validation & Thresholds
Mean Arterial Pressure (MAP):

Formula:

ùëÄ
ùê¥
ùëÉ
=
ùëÜ
ùêµ
ùëÉ
+
2
(
ùê∑
ùêµ
ùëÉ
)
3
MAP=
3
SBP+2(DBP)
	‚Äã


<60 mmHg: ‚ö†Ô∏è Risk of hypoperfusion (shock, sepsis).

60‚Äì100 mmHg: ‚úÖ Normal.

>100 mmHg: ‚ö†Ô∏è May indicate hypertension, cardiovascular strain.

Pulse Pressure (PP):

Formula:

ùëÉ
ùëÉ
=
ùëÜ
ùêµ
ùëÉ
‚àí
ùê∑
ùêµ
ùëÉ
PP=SBP‚àíDBP

<20 mmHg: ‚ö†Ô∏è Narrow PP ‚Üí possible shock, heart failure.

20‚Äì60 mmHg: ‚úÖ Normal.

>60 mmHg: ‚ö†Ô∏è Wide PP ‚Üí possible arterial stiffness, CVD risk.

3. Edge Case Validations

SBP = DBP ‚Üí PP = 0: physiologically impossible ‚Üí show error.

SBP < DBP: invalid input.

Extremely high SBP with low DBP (e.g., 250/40): possible measurement error or critical condition ‚Üí flagged.

Decimals: If user enters decimals, round to nearest integer.

Division by Zero: Not directly applicable here, but MAP denominator check ensures no invalid computation.
-->