{% extends 'base.html' %}
{% block title %}Homogeneous-Vessel Venting Temperature Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accident Rate Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
         @media (max-width: 768px) {
    .rate-value {
        font-size: 28px; /* smaller font for tablets/mobiles */
    }
}

@media (max-width: 480px) {
    .rate-value {
        font-size: 24px; /* even smaller for phones */
    }
}
    </style>
</head>
<body>
   <div class="btn-container">
    <a href="{% url 'firecategory_calculators' %}" class="back-btn">Back To Fire Calculators</a>
</div>

<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}

    <div class="calculator-header">
        <h1>Homogeneous-Vessel Venting Temperature Calculator</h1>
        <p>Predict the temperature history during venting, considering heat release, specific heat, latent heat, and vessel emptying time.</p>
    </div>

    <div class="calc-content">
        <!-- Input Card -->
        <div class="calc-card">
            <h2>Enter Data</h2>
            <div class="form-group">
                <label for="setTemperature">Set Temperature (Tr)</label>
                <input type="number" id="setTemperature" class="form-input" placeholder="Enter Tr">
            </div>
            <div class="form-group">
                <label for="heatReleaseRate">Heat Release Rate (q)</label>
                <input type="number" id="heatReleaseRate" class="form-input" placeholder="Enter q">
            </div>
            <div class="form-group">
                <label for="time">Time (t)</label>
                <input type="number" id="time" class="form-input" placeholder="Enter t">
            </div>
            <div class="form-group">
                <label for="specificHeat">Specific Heat (Cv)</label>
                <input type="number" id="specificHeat" class="form-input" placeholder="Enter Cv">
            </div>
            <div class="form-group">
                <label for="volume">Volume (V)</label>
                <input type="number" id="volume" class="form-input" placeholder="Enter V">
            </div>
            <div class="form-group">
                <label for="latentHeat">Latent Heat (hfa)</label>
                <input type="number" id="latentHeat" class="form-input" placeholder="Enter hfa">
            </div>
            <div class="form-group">
                <label for="initialMass">Initial Mass (mo)</label>
                <input type="number" id="initialMass" class="form-input" placeholder="Enter mo">
            </div>
            <div class="form-group">
                <label for="specificVolume">Specific Volume (vfa)</label>
                <input type="number" id="specificVolume" class="form-input" placeholder="Enter vfa">
            </div>
            <div class="form-group">
                <label for="emptyingTime">Emptying Time (tr)</label>
                <input type="number" id="emptyingTime" class="form-input" placeholder="Enter tr">
            </div>
            <button class="calculate-btn" onclick="calculateTemperature()">Calculate Temperature</button>
        </div>

        <!-- Result Card -->
        <div class="result-card">
            <!-- Placeholder -->
            <div class="result-placeholder" id="placeholder">
                <img src="{% static 'images/temp.jpg' %}" alt="Temperature Illustration">
                <p>This tool will calculate the <strong>Temperature History</strong>. Enter your data to see results and insights here.</p>
            </div>

            <!-- Error -->
            <div class="result-error hidden" id="resultError" style="font-size: 22px;"></div>

            <!-- Result -->
            <div class="result-value hidden" id="resultValue">
                <div class="rate-value">Calculated Temperature</div>
                <div class="rate-value" id="temperatureValue">0.00</div>
                <div class="rate-label" style="font-size:16px; font-weight:bold;">¬∞C</div>
                <div class="result-feedback" id="feedbackContent"></div>
                <div class="btn-wrapper">
                    <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                </div>
            </div>
        </div>
    </div>

<!-- Notes Section -->
<div class="note-section">

    <!-- About -->
    <div class="note-card">
        <h3>üìò About This Calculator</h3>
        <p>
            This calculator estimates the <strong>temperature evolution</strong> of a homogeneous vessel 
            during venting. It balances <em>heat input</em> against <em>cooling by vaporization</em> 
            to show how temperature changes over time. This is critical in 
            <strong>fire safety, emergency relief design, and process hazard analysis</strong>, 
            where uncontrolled heating or cooling can compromise vessel integrity or cause 
            secondary hazards.
        </p>
    </div>

    <!-- Parameters -->
    <div class="note-card">
        <h3>‚öô Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Tr (Set/Initial Temperature, ¬∞C):</strong> Starting vessel temperature.</li>
            <li><strong>q (Heat Release Rate, W or kJ/s):</strong> Energy input driving temperature rise.</li>
            <li><strong>t (Time, s):</strong> Elapsed time since venting began.</li>
            <li><strong>Cv (Specific Heat Capacity, J/kg¬∑K):</strong> Heat required to raise 1 kg by 1 K.</li>
            <li><strong>V (Vessel Volume, m¬≥):</strong> Enclosure size where the substance is stored.</li>
            <li><strong>hfa (Latent Heat of Vaporization, J/kg):</strong> Heat absorbed during phase change.</li>
            <li><strong>mo (Initial Mass, kg):</strong> Starting mass of material in vessel.</li>
            <li><strong>vfa (Specific Volume, m¬≥/kg):</strong> Expansion volume per unit mass of fluid.</li>
            <li><strong>tr (Emptying Time, s):</strong> Time required to completely vent contents.</li>
        </ul>
    </div>

    <!-- Input Validations -->
    <div class="note-card">
        <h3>‚úÖ Input Validation Rules</h3>
        <ul class="note-list">
            <li><strong>All fields mandatory:</strong> Prevents incomplete safety evaluation.</li>
            <li><strong>Tr (Temperature):</strong> Must be between -50 ¬∞C and 1500 ¬∞C.</li>
            <li><strong>q (Heat Release):</strong> > 0. Above <code>10‚Å∂ W</code> requires review.</li>
            <li><strong>t (Time):</strong> Positive and less than emptying time <code>tr</code>.</li>
            <li><strong>Cv (Specific Heat):</strong> 500 ‚Äì 10,000 J/kg¬∑K typical range.</li>
            <li><strong>V (Vessel Volume):</strong> 0.001 ‚Äì 100,000 m¬≥.</li>
            <li><strong>hfa (Latent Heat):</strong> 1√ó10‚Åµ ‚Äì 3√ó10‚Å∂ J/kg.</li>
            <li><strong>mo (Mass):</strong> 0.001 ‚Äì 1,000,000 kg.</li>
            <li><strong>vfa (Specific Volume):</strong> > 0; typical 0.001 ‚Äì 100 m¬≥/kg.</li>
            <li><strong>tr (Emptying Time):</strong> Must be > t. If <code>tr - t</code> is too small, flagged unstable.</li>
            <li><strong>Cross-field checks:</strong> Ensure denominators never zero (mo¬∑Cv, tr‚àít, etc.).</li>
        </ul>
    </div>

    <!-- Output Validations -->
    <div class="note-card">
        <h3>üìä Output Validations</h3>
        <ul class="note-list">
            <li><strong>T ‚â§ Tr:</strong> ‚úÖ No net temperature rise (safe condition).</li>
            <li><strong>0 < ŒîT ‚â§ 10 ¬∞C:</strong> ‚ÑπÔ∏è Minor increase. Monitor process and ventilation.</li>
            <li><strong>10 < ŒîT ‚â§ 50 ¬∞C:</strong> ‚ö†Ô∏è Moderate increase. Investigate mitigation.</li>
            <li><strong>50 < ŒîT ‚â§ 200 ¬∞C:</strong> üö® High rise. Immediate engineering controls needed.</li>
            <li><strong>ŒîT > 200 ¬∞C or T > 2000 ¬∞C:</strong> üî¥ Extreme hazard. Emergency response + specialist modeling required.</li>
            <li><strong>Invalid results:</strong> T ‚â§ -273.15 ¬∞C, NaN, or ‚àû ‚Üí ‚ùå Calculation error, inputs must be corrected.</li>
            <li><strong>Feedback linkage:</strong> The same safety assessment displayed next to the calculated result is echoed here for audit traceability.</li>
        </ul>
    </div>

    <!-- Governing Principle -->
    <div class="note-card">
        <h3>üìê Governing Principle</h3>
        <p>
            This model applies the <strong>energy balance principle</strong> for a homogeneous venting vessel, 
            considering both sensible heating and latent heat effects.  
            It aligns with international best practices, particularly 
            <strong>API Standard 521 ‚Äì Pressure-relieving and Depressuring Systems</strong>, 
            which governs emergency venting, depressurization, and thermal hazard evaluations.
        </p>
    </div>

    <!-- Conclusion -->
    <div class="note-card">
        <h3>üèÅ Conclusion</h3>
        <p>
            The Homogeneous-Vessel Venting Temperature Calculator helps engineers predict 
            temperature trends during emergency venting events. By combining input validations, 
            output thresholds, and compliance with <strong>API 521</strong>, the calculator ensures 
            results are both technically meaningful and auditable for <strong>QEHS, OSHA, ISO 45001, and NFPA</strong> compliance.  
            Results flagged as high or extreme must always be followed by a detailed 
            <strong>engineering review, HAZOP, and process safety verification</strong>.
        </p>
    </div>

</div>


<script>
function calculateTemperature() {
    // --- Configuration / thresholds ---
    const EPSILON_TR_MINUS_T = 0.1;     // minimum allowed (tr - t) in seconds for stable calc
    const MAX_TEMPERATURE_WARN = 2000; // ¬∞C: very large -> require specialist review
    const MIN_TEMPERATURE_PHYS = -273.15; // absolute zero check

    // Helper to show result error (hides placeholder, shows error in result box)
    function showError(message, color = "red") {
        const resultError = document.getElementById("resultError");
        const placeholder = document.getElementById("placeholder");
        const resultValue = document.getElementById("resultValue");
        // hide other blocks
        resultValue.classList.add("hidden");
        if (placeholder) placeholder.classList.add("hidden");
        resultError.innerHTML = message;
        resultError.style.color = color;
        resultError.classList.remove("hidden");
    }

    // Collect and parse inputs
    const read = id => document.getElementById(id)?.value?.trim();
    const Tr_raw = read("setTemperature");
    const q_raw = read("heatReleaseRate");
    const t_raw = read("time");
    const Cv_raw = read("specificHeat");
    const V_raw = read("volume");
    const hfa_raw = read("latentHeat");
    const mo_raw = read("initialMass");
    const vfa_raw = read("specificVolume");
    const tr_raw = read("emptyingTime");

    // Convert to numbers
    const Tr = parseFloat(Tr_raw);
    const q = parseFloat(q_raw);
    const t = parseFloat(t_raw);
    const Cv = parseFloat(Cv_raw);
    const V = parseFloat(V_raw);
    const hfa = parseFloat(hfa_raw);
    const mo = parseFloat(mo_raw);
    const vfa = parseFloat(vfa_raw);
    const tr = parseFloat(tr_raw);

    // reset UI
    const resultError = document.getElementById("resultError");
    const resultValue = document.getElementById("resultValue");
    const placeholder = document.getElementById("placeholder");
    const feedbackContent = document.getElementById("feedbackContent");
    resultError.classList.add("hidden");
    resultError.innerHTML = "";
    resultValue.classList.add("hidden");
    feedbackContent.innerHTML = "";
    if (placeholder) placeholder.classList.add("hidden");

    // Basic presence check
    const rawInputs = { Tr_raw,q_raw,t_raw,Cv_raw,V_raw,hfa_raw,mo_raw,vfa_raw,tr_raw };
    const missing = Object.entries(rawInputs)
        .filter(([k,v]) => v === undefined || v === null || v === "")
        .map(([k]) => k.replace("_raw",""));
    if (missing.length > 0) {
        showError("‚ö†Ô∏è Please fill in all required fields. Missing: " + missing.join(", "), "orange");
        return;
    }

    // Validate numeric and ranges - collect messages
    const msgs = [];

    // Tr (¬∞C): allow modest negative for cryogenic systems, otherwise reasonable upper bound
    if (!isFinite(Tr)) msgs.push("Tr (Set Temperature) must be a finite number.");
    else if (Tr < -50 || Tr > 1500) msgs.push("Tr: expected between -50 ¬∞C and 1500 ¬∞C for typical use. (Got: " + Tr + ")");

    // q: heat release rate - require positive
    if (!isFinite(q) || q <= 0) msgs.push("q (Heat release rate) must be > 0 and finite (units: e.g., kW).");

    // t: time (s)
    if (!isFinite(t) || t <= 0) msgs.push("t (Time) must be > 0 seconds.");
    else if (t > 1e7) msgs.push("t: extremely large (>1e7 s). Verify units.");

    // Cv
    if (!isFinite(Cv) || Cv <= 0) msgs.push("Cv (Specific heat) must be > 0 (units: kJ/kg¬∑¬∞C or J/kg¬∑K).");

    // V
    if (!isFinite(V) || V <= 0) msgs.push("V (Volume) must be > 0 m¬≥.");

    // hfa
    if (!isFinite(hfa) || hfa <= 0) msgs.push("hfa (Latent heat) must be > 0 (kJ/kg).");

    // mo
    if (!isFinite(mo) || mo <= 0) msgs.push("mo (Initial mass) must be > 0 kg.");
    else if (mo > 1e6) msgs.push("mo unusually large (>1,000,000 kg). Verify.");

    // vfa
    if (!isFinite(vfa) || vfa <= 0) msgs.push("vfa (Specific volume) must be > 0 m¬≥/kg.");

    // tr
    if (!isFinite(tr) || tr <= 0) msgs.push("tr (Emptying time) must be > 0 seconds.");
    else if (tr > 1e7) msgs.push("tr unusually large (>1e7 s). Verify units.");

    // Cross-field checks
    if (isFinite(t) && isFinite(tr) && tr <= t) msgs.push("Emptying time (tr) must be GREATER than elapsed time (t).");
    if (isFinite(tr) && isFinite(t) && (tr - t) < EPSILON_TR_MINUS_T) {
        msgs.push(`tr - t must be >= ${EPSILON_TR_MINUS_T} s to avoid numerical instability.`);
    }

    // Check denominator mo * Cv
    if (isFinite(mo) && isFinite(Cv) && Math.abs(mo * Cv) < 1e-9) {
        msgs.push("Product (mo √ó Cv) is too small and will produce unstable results. Verify mo and Cv.");
    }

    // If any messages, show them in result box
    if (msgs.length > 0) {
        showError("<strong>Validation errors:</strong><br>" + msgs.join("<br>"), "orange");
        return;
    }

    // Optional: unit consistency hint (non-blocking)
    // e.g., if q is very small but Cv in different units, user might have unit mismatch.
    // We do not block for units but show hint if values look incompatible:
    if (q > 0 && Cv > 0) {
        // simple heuristic: if q (kJ/s) and Cv (J/kg¬∑K) mismatch -> huge numbers. Hard to detect reliably without unit selector.
        // Provide a gentle hint only when extremes found:
        if ((q > 1e6 && Cv < 0.1) || (q < 0.01 && Cv > 1000)) {
            const hint = "Unit check: review q, Cv, and hfa units ‚Äî ensure q is in kJ/s (kW) if Cv/hfa are kJ/kg.";
            // show hint as non-blocking orange line (we will show later)
            // store in variable
            var unitHint = hint;
        }
    }

    // Now compute safely
    try {
        const heatInputTerm = (q * t) / (mo * Cv); // units consistent if q & Cv match
        const denom = mo * Cv * vfa * (tr - t);
        if (!isFinite(denom) || Math.abs(denom) < 1e-12) {
            showError("Computation error: denominator in cooling term is too small or non-finite.", "red");
            return;
        }
        const coolingEffectTerm = (V * hfa * t) / denom;
        const temperature = Tr + heatInputTerm - coolingEffectTerm;

        // Validate resulting temperature
        if (!isFinite(temperature) || Number.isNaN(temperature)) {
            showError("Computation produced an invalid temperature (NaN or Infinity). Check inputs.", "red");
            return;
        }
        if (temperature <= MIN_TEMPERATURE_PHYS) {
            showError("Calculated temperature below physical limit (<= -273.15 ¬∞C). Check inputs.", "red");
            return;
        }

        // Show result (hide error)
        resultError.classList.add("hidden");
        const temperatureValueElt = document.getElementById("temperatureValue");
        temperatureValueElt.innerText = temperature.toFixed(2);
        resultValue.classList.remove("hidden");

        // Build feedback
        const feedbackLines = [];
        if (typeof unitHint !== "undefined") feedbackLines.push("‚ö†Ô∏è Unit hint: " + unitHint);
        const dT = temperature - Tr;
        if (dT <= 0) {
            feedbackLines.push("‚úÖ Temperature is at or below set temperature (no net rise).");
        } else if (dT <= 10) {
            feedbackLines.push("‚ÑπÔ∏è Small rise (<=10 ¬∞C). Monitor process and ventilation.");
        } else if (dT <= 50) {
            feedbackLines.push("‚ö†Ô∏è Moderate rise (10‚Äì50 ¬∞C). Investigate mitigation.");
        } else if (dT <= 200) {
            feedbackLines.push("üö® High rise (50‚Äì200 ¬∞C). Immediate engineering action recommended.");
        } else {
            feedbackLines.push("üî¥ Extreme rise (>200 ¬∞C). Emergency response and specialist analysis required.");
        }

        if (temperature > MAX_TEMPERATURE_WARN) {
            feedbackLines.push("üî¥ Extremely high temperature (> " + MAX_TEMPERATURE_WARN + " ¬∞C). Use specialist modeling.");
        }

        // If cooling effect larger than heat input (i.e. temperature pulled down a lot) we can note potential condensation or energy accounting issue
        if (Math.abs(coolingEffectTerm) > Math.abs(heatInputTerm) * 10) {
            feedbackLines.push("‚ö†Ô∏è Cooling term >> heating term ‚Äî verify latent heat (hfa) and specific volume (vfa); results may indicate phase-change dominated behavior.");
        }

        // Show assembled feedback
        feedbackContent.innerHTML = feedbackLines.join("<br>");
        feedbackContent.style.color = (dT <= 0 ? "green" : (dT <= 50 ? "orange" : "red"));

        return;
    } catch (err) {
        showError("Unexpected error during calculation: " + (err && err.message ? err.message : String(err)), "red");
    }
}
</script>



    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


<!-- 1) Quick summary of inputs, outputs & formula (QEHS lens)

Inputs (from your UI)

Tr ‚Äî set / initial temperature (¬∞C)

q ‚Äî heat release rate (energy/time) ‚Äî (units must be documented; e.g., kW or kJ/s)

t ‚Äî elapsed time (s)

Cv ‚Äî specific heat at constant volume (kJ/kg¬∑¬∞C or J/kg¬∑K ‚Äî must match q units)

V ‚Äî vessel volume (m¬≥)

hfa ‚Äî latent heat of vaporization (kJ/kg)

mo ‚Äî initial mass (kg)

vfa ‚Äî specific volume (m¬≥/kg)

tr ‚Äî emptying/empty time (s)

Output

Temperature T (¬∞C) at time t, computed as:

T = Tr + (q * t) / (mo * Cv)  -  (V * hfa * t) / (mo * Cv * vfa * (tr - t))


QEHS comment: formula balances heat input (first term) against cooling by vaporization (second term). Units must be consistent or results will be meaningless. The emptying-time denominator (tr - t) is a common source of instability / singularity and must be guarded.

2) Comprehensive validation rules (recommended)

Global rules

All inputs must be numeric and finite. Show all errors inside the result box (consistent with your UI).

Document units clearly on the page. (Example suggested units: q in kW (kJ/s), Cv & hfa in kJ/kg¬∑¬∞C or J/kg¬∑K ‚Äî make them consistent).

Per-field ranges, precision & rationale

Tr (Set / Initial Temperature)

Units: ¬∞C.

Acceptable range (recommended): -50 ¬∞C to 1,500 ¬∞C. (Most industrial systems sit inside these bounds; extreme high temps require specialist models.)

Precision: up to 2 decimals.

Rationale: avoid physically impossible T and keep audit-friendly ranges.

q (Heat release rate)

Units: kW (kJ/s) or specify your choice ‚Äî must match Cv/hfa units.

Acceptable range: 0.001 to 1e8 kW (1e-3 to 1e8 kJ/s) ‚Äî allow very small lab releases up to very large catastrophic rates; values beyond require specialist modeling.

Precision: up to 3 decimals.

Rationale: ensures heat term is meaningful and avoids zeros.

t (Time elapsed)

Units: seconds (s).

Acceptable range: 0 < t < 1e7 s (~115 days). Typical industrial transient times are seconds to hours.

Precision: 2 decimals.

Rationale: must be < tr (see below).

Cv (Specific heat at constant volume)

Units: kJ/kg¬∑¬∞C (or J/kg¬∑K if you choose ‚Äî be consistent).

Acceptable range: 0.01 to 10,000 kJ/kg¬∑¬∞C (0.01 for light gases up to large numbers if user inputs in J/kg¬∑K ‚Äî again consistency needed).

Precision: 3‚Äì4 decimals.

Rationale: prevents division by near-zero.

V (Volume)

Units: m¬≥.

Acceptable range: 1e-6 to 1e7 m¬≥ (from lab vessels to very large enclosures).

Precision: 3 decimals.

hfa (Latent heat of vaporization)

Units: kJ/kg.

Acceptable range: 1 to 1e6 kJ/kg (typical liquids ~100‚Äì2500 kJ/kg; allow broader range but flag extremes).

Precision: 2‚Äì3 decimals.

mo (Initial mass)

Units: kg.

Acceptable range: 0.001 to 1,000,000 kg.

Precision: 3 decimals.

vfa (Specific volume)

Units: m¬≥/kg.

Acceptable range: 1e-6 to 100 m¬≥/kg (liquids ~1e-3 to 1e-1; gases much higher).

Precision: 4 decimals.

tr (Emptying time)

Units: s.

Acceptable range: t + Œµ < tr ‚â§ 1e7 s (we require tr strictly greater than t; Œµ = small threshold, see below).

Precision: 2 decimals.

Rationale: emptying time smaller than or equal to t causes division by zero or negative denominator.

Cross-field dependencies & logical checks

Units consistency check: If you ask users to select units (kJ vs J), validate Cv/hfa/q unit groupings. If no unit selection, place a prominent note and validation hint.

tr > t (strict) ‚Äî required. Enforce a safety margin: tr - t must be >= 0.1 s (or a configurable epsilon). If tr - t is very small (< 1 s), warn about numerical instability.

mo must be large enough so denominators mo * Cv are not tiny (e.g., mo * Cv > 1e-6). If mo * Cv is extremely small, warn and block.

Dimensionless combined checks: ensure q * t / (mo * Cv) and (V * hfa * t) / (mo * Cv * vfa * (tr - t)) are finite and not NaN/Infinity.

3) Edge-case validations (must handle these explicitly)

Division by zero / near-zero

tr - t <= epsilon ‚Üí error. Use epsilon = 1e-6 or better 0.1 s for physical realism.

mo <= tiny or Cv <= tiny ‚Üí error (tiny e.g., 1e-9).

Square/singular blow-up

If tr - t is very small the cooling term may become huge (numerical blow-up). Warn/stop if (tr - t) < 0.1 s or if cooling term magnitude exceeds, say, 1e8 ¬∞C.

Unrealistic combinations

Very large q with tiny mo, Cv or tiny vfa ‚Üí enormous temperature. Flag with ‚Äúengineering review required.‚Äù

Very large V with tiny hfa can produce negative huge cooling term ‚Üí unexpected negative T; flag.

Units mismatch

If user enters q in kW but Cv is in J/kg¬∑K, results will be off by 1000√ó. If possible require or present a unit-pairing dropdown, otherwise show a warning ‚ÄúEnsure units are consistent: q in kJ/s (kW) and Cv/hfa in kJ/kg¬∑¬∞C.‚Äù

Physical realism

If computed T < -273.15 ¬∞C ‚Üí invalid (physics breaks), error.

If computed T > 2000 ¬∞C ‚Üí warn: extreme temperature, require high-fidelity modeling.

4) Output validation logic & threshold explanation (how to interpret T in audits)

Invalid result (block):

NaN, Infinity, T <= -273.15 or very large magnitude (abs > 1e6) ‚Üí block and request input correction.

Warning levels (audit-friendly):

T <= Tr ‚Üí OK (no net heating) ‚Äî show green success message.

Tr < T <= Tr + 10 ¬∞C ‚Üí minor increase ‚Äî show yellow/orange: ‚ÄúMonitor, check ventilation and controls.‚Äù

Tr + 10 ¬∞C < T <= Tr + 50 ¬∞C ‚Üí moderate ‚Äî orange: ‚ÄúInvestigate mitigation (venting, cooling).‚Äù

Tr + 50 ¬∞C < T <= Tr + 200 ¬∞C ‚Üí high ‚Äî red: ‚ÄúHigh thermal risk. Immediate engineering action recommended.‚Äù

T > Tr + 200 ¬∞C or T > 1000 ¬∞C ‚Üí critical ‚Äî red/dark: ‚ÄúExtreme thermal hazard. Emergency procedures and specialist analysis required.‚Äù

Rationale: thresholds are conservative and meant to prompt proper engineering follow-up rather than be final design criteria. Include these interpretations in notes so audits can see the reasoning. -->