{% extends 'base.html' %}
{% block title %}Temperature History Equation (External Heating) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accident Rate Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 480px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
    justify-content:center;
    align-items: center;
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease;
    height: 480px;
    overflow-y: auto;
    text-align: center;
}

        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
         @media (max-width: 768px) {
    .rate-value {
        font-size: 28px; /* smaller font for tablets/mobiles */
    }
}

@media (max-width: 480px) {
    .rate-value {
        font-size: 24px; /* even smaller for phones */
    }
}
.warning-text {
    font-size: 13px;
    color: orange;
    margin-top: 2px;
}

    </style>
</head>
<body>
   <div class="btn-container">
    <a href="{% url 'firecategory_calculators' %}" class="back-btn">Back To Fire Calculators</a>
</div>

<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}

    <!-- Header -->
    <div class="calculator-header">
        <h1>Temperature History Equation (External Heating) Calculator</h1>
        <p>
            Estimate the temperature history during homogeneous-vessel venting with constant external heat input. 
            Useful for analyzing scenarios such as fire exposure and external heating hazards.
        </p>
    </div>

    <div class="calc-content">
        <!-- Input Card -->
        <div class="calc-card">
            <h2>Enter Data</h2>

            <div class="form-group">
                <label for="Tr">Set Temperature (T<sub>r</sub>)</label>
                <input type="number" step="any" id="Tr" class="form-input" placeholder="Enter Set Temperature">
            </div>

            <div class="form-group">
                <label for="QT">Heat Input (Q<sub>T</sub>)</label>
                <input type="number" step="any" id="QT" class="form-input" placeholder="Enter Heat Input">
            </div>

            <div class="form-group">
                <label for="G">Gas Flow Rate (G)</label>
                <input type="number" step="any" id="G" class="form-input" placeholder="Enter Gas Flow Rate">
            </div>

            <div class="form-group">
                <label for="A">Surface Area (A)</label>
                <input type="number" step="any" id="A" class="form-input" placeholder="Enter Surface Area">
            </div>

            <div class="form-group">
                <label for="Cv">Specific Heat Capacity (C<sub>v</sub>)</label>
                <input type="number" step="any" id="Cv" class="form-input" placeholder="Enter Specific Heat Capacity">
            </div>

            <div class="form-group">
                <label for="V">Volume (V)</label>
                <input type="number" step="any" id="V" class="form-input" placeholder="Enter Volume">
            </div>

            <div class="form-group">
                <label for="mo">Mass (m<sub>o</sub>)</label>
                <input type="number" step="any" id="mo" class="form-input" placeholder="Enter Mass">
            </div>

            <div class="form-group">
                <label for="hfa">Heat Transfer Coefficient (h<sub>fa</sub>)</label>
                <input type="number" step="any" id="hfa" class="form-input" placeholder="Enter Heat Transfer Coefficient">
            </div>

            <div class="form-group">
                <label for="vfa">Flow Rate Factor (v<sub>fa</sub>)</label>
                <input type="number" step="any" id="vfa" class="form-input" placeholder="Enter Flow Rate Factor">
            </div>

            <div class="form-group">
                <label for="t">Time (t)</label>
                <input type="number" step="any" id="t" class="form-input" placeholder="Enter Time">
            </div>

            <div class="form-group">
                <label for="tr">Reference Time (t<sub>r</sub>)</label>
                <input type="number" step="any" id="tr" class="form-input" placeholder="Enter Reference Time">

            </div>

            <button class="calculate-btn" onclick="calculateTemperature()">Calculate Temperature</button>
        </div>

        <!-- Result Card -->
        <div class="result-card">
            <!-- Placeholder -->
            <div class="result-placeholder" id="placeholder">
                <img src="{% static 'images/temp.jpg' %}" alt="Temperature Illustration">
                <p>This tool will calculate the <strong>Temperature History</strong>. Enter your data to see results and insights here.</p>
            </div>

            <!-- Error -->
            <div class="result-error hidden" id="resultError" style="font-size: 20px;"></div>


            <!-- Result -->
            <div class="result-value hidden" id="resultValue">
                    <div class="field-error" id="error-Tr"></div>

                <div class="rate-value">Temperature</div>
                <div class="rate-value" id="temperatureValue">0.0000</div>
                <div class="rate-label" style="font-size:16px; font-weight:bold;">°C</div>
                <div class="result-feedback" id="feedbackContent"></div>
                <div class="btn-wrapper">
                    <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Section -->
    <div class="note-section">
        <div class="note-card">
            <h3>📘 About This Calculator</h3>
               <p>This calculator estimates the temperature history during homogeneous-vessel venting when there is a constant external heat input. It considers the effects of heat addition, vaporization, and the venting process. This is crucial for analyzing scenarios with external heating sources, such as fire exposure. This formula assumes homogeneous conditions within the vessel, meaning the temperature and composition are uniform throughout. Also, this formula assumes that the liquid is vaporizing. If there is no liquid left, then the formula is no longer valid.</p>

        </div>

        <div class="note-card">
    <h3>⚙️ Parameters</h3>
    <ul class="note-list">
        <li>
            <strong>T<sub>r</sub> (Initial Temperature):</strong> 
            The starting or reference temperature of the system before external heating begins, usually measured in Kelvin (K) or degrees Celsius (°C).
        </li>
        <li>
            <strong>Q<sub>T</sub> (Total External Heat Input):</strong> 
            The constant amount of heat energy supplied to the system from outside sources (e.g., fire, ambient heating), typically expressed in Joules (J) or Watts (W).
        </li>
        <li>
            <strong>G (Gas Flow Rate):</strong> 
            The rate at which gas escapes or is vented from the vessel, usually expressed in kilograms per second (kg/s) or standard liters per minute (SLPM).
        </li>
        <li>
            <strong>A (Vent Surface Area):</strong> 
            The effective cross-sectional area of the vent or relief opening through which the gas exits, typically measured in square meters (m²).
        </li>
        <li>
            <strong>C<sub>v</sub> (Specific Heat at Constant Volume):</strong> 
            The amount of heat required to raise the temperature of a unit mass of gas by one degree at constant volume, measured in Joules per kilogram-Kelvin (J/kg·K).
        </li>
        <li>
            <strong>V (Vessel Volume):</strong> 
            The internal capacity of the vessel or container holding the gas or liquid, usually given in cubic meters (m³).
        </li>
        <li>
            <strong>m<sub>o</sub> (Initial Mass):</strong> 
            The starting mass of the substance (gas or liquid) present in the vessel before venting begins, typically measured in kilograms (kg).
        </li>
        <li>
            <strong>h<sub>fa</sub> (Heat Transfer Coefficient / Latent Heat of Vaporization):</strong> 
            Represents either the rate of heat transfer between the fluid and vessel walls or the energy required to convert unit mass of liquid into vapor, expressed in Joules per kilogram (J/kg) or W/m²·K depending on context.
        </li>
        <li>
            <strong>v<sub>fa</sub> (Specific Volume / Flow Rate Factor):</strong> 
            The volume occupied by a unit mass of the substance at given conditions, typically measured in cubic meters per kilogram (m³/kg). It influences venting flow calculations.
        </li>
        <li>
            <strong>t (Elapsed Time):</strong> 
            The time that has passed since venting or external heating started, usually expressed in seconds (s).
        </li>
        <li>
            <strong>t<sub>r</sub> (Reference Emptying Time):</strong> 
            The characteristic or reference time required to empty the vessel under standard or assumed conditions, typically expressed in seconds (s).
        </li>
    </ul>
</div>


       <div class="note-card">
    <h3>💡 Interpretation</h3>
    <ul class="note-list">
        <li>
            ✅ <strong>Stable Temperature Rise (&lt; 100 °C):</strong> 
            Below the boiling point of water and most process liquids. 
            System is within safe operating limits. 
            <em>Reason:</em> At this stage, pressure buildup is minimal and standard vessel design can handle it.
        </li>
        <li>
            ⚠️ <strong>Moderate Rise (100 – 200 °C):</strong> 
            Temperatures above boiling point but below structural concern levels. 
            <em>Reason:</em> Many flammable liquids and polymers begin to degrade; fire watch is required. 
            <em>Action:</em> Apply cooling, increase monitoring, and check relief devices.
        </li>
        <li>
            🚨 <strong>High Temperature Rise (200 – 400 °C):</strong> 
            Dangerous range where vessel steel strength decreases significantly. 
            <em>Reason:</em> ASME/NFPA data shows yield strength of carbon steel reduces ~50% by 400 °C. 
            <em>Action:</em> Activate suppression systems, evacuate non-essential personnel.
        </li>
        <li>
            🔴 <strong>Extreme Heating (&gt; 400 °C):</strong> 
            Emergency condition. 
            <em>Reason:</em> Beyond this, vessel rupture, BLEVE (Boiling Liquid Expanding Vapor Explosion), or runaway reaction is highly probable. 
            <em>Action:</em> Trigger full emergency plan (alarms, fire brigade, plant shutdown).
        </li>
    </ul>
</div>

<div class="note-card">
    <h3>🛡️ Input Validations</h3>
    <ul class="note-list">
        <li><strong>All fields mandatory:</strong> Missing data creates unsafe assumptions.</li>
        <li><strong>Numeric & positive only:</strong> Negative or text values are invalid for physical quantities.</li>
        <li><strong>Recommended Engineering Ranges:</strong></li>
        <ul>
            <li><strong>Temperature (T<sub>r</sub>):</strong> 0 – 2000 °C. 
                <em>Below 0 °C</em> → unrealistic unless cryogenic system. 
                <em>Above 2000 °C</em> → warning: beyond design of standard process vessels.
            </li>
            <li><strong>Heat Input (Q<sub>T</sub>):</strong> 1 W – 10⁹ W. 
                <em>Reason:</em> Below 1 W insignificant, above 10⁹ W exceeds fire exposure assumptions.
            </li>
            <li><strong>Gas Flow Rate (G):</strong> 0.001 – 1000 kg/s. 
                <em>Reason:</em> Below 0.001 unrealistic, above 1000 exceeds relief device design.
            </li>
            <li><strong>Surface Area (A):</strong> 0.001 – 100 m². 
                <em>Reason:</em> Smaller is non-physical, larger is industrial storage tank scale.
            </li>
            <li><strong>Specific Heat (C<sub>v</sub>):</strong> 500 – 5000 J/kg·K. 
                <em>Reason:</em> Most gases/liquids fall here; outside indicates input error.
            </li>
            <li><strong>Volume (V):</strong> 0.001 – 1000 m³. 
                <em>Reason:</em> Range covers lab vessels to large tanks.
            </li>
            <li><strong>Mass (m<sub>o</sub>):</strong> 0.1 – 100,000 kg. 
                <em>Reason:</em> Below 0.1 impractical, above 100,000 → warning for extreme storage.
            </li>
            <li><strong>Heat Transfer Coefficient (h<sub>fa</sub>):</strong> 10 – 50,000 W/m²·K. 
                <em>Reason:</em> Typical convection to forced boiling conditions.
            </li>
            <li><strong>Flow Rate Factor (v<sub>fa</sub>):</strong> 0.001 – 100 m³/kg. 
                <em>Reason:</em> Gas/liquid densities mapped to this range.
            </li>
            <li><strong>Time (t):</strong> ≥ 0 and strictly less than t<sub>r</sub>. 
                <em>Reason:</em> Negative time is meaningless; t ≥ t<sub>r</sub> causes division by zero.
            </li>
            <li><strong>Reference Time (t<sub>r</sub>):</strong> 1 – 100,000 s. 
                <em>Reason:</em> Below 1 s → unrealistic, above 100,000 s → long-term degradation cases only.
            </li>
        </ul>
        <li><strong>Warnings:</strong> If user enters a value outside the range, calculator will:
            <ul>
                <li>⚠️ Show a yellow warning — "Value outside typical engineering range, check input."</li>
                <li>❌ Block calculation if physically impossible (negative, zero, division by zero).</li>
            </ul>
        </li>
    </ul>
</div>

        <div class="note-card">
            <p>
                Click <strong>"Calculate Temperature"</strong> to view the temperature profile. 
                This is vital for <strong>fire safety, hazard analysis, and relief system design</strong>.
            </p>
        </div>
    </div>
</div>

<script>
function calculateTemperature() {
    // Read raw inputs
    const parse = (id) => {
        const v = document.getElementById(id).value;
        return v === "" ? NaN : Number(v);
    };

    const Tr = parse("Tr");     // °C
    const QT = parse("QT");     // W
    const G = parse("G");       // kg/s
    const A = parse("A");       // m^2
    const Cv = parse("Cv");     // J/(kg·K)
    const V = parse("V");       // m^3
    const mo = parse("mo");     // kg
    const hfa = parse("hfa");   // J/kg (latent heat)
    const vfa = parse("vfa");   // m^3/kg (specific volume)
    const t = parse("t");       // s
    const tr = parse("tr");     // s

    const resultValue = document.getElementById("resultValue");
    const placeholder = document.getElementById("placeholder");
    const feedbackContent = document.getElementById("feedbackContent");
    const resultError = document.getElementById("resultError");

    // UI reset
    resultError.classList.add("hidden");
    resultValue.classList.add("hidden");
    placeholder.classList.add("hidden");
    resultError.innerHTML = "";
    feedbackContent.innerHTML = "";

    // Helper to show error and return
    function showError(msg, color = "red") {
        resultError.innerHTML = msg;
        resultError.style.color = color;
        resultError.classList.remove("hidden");
    }

    // Basic NaN check
    const inputs = {Tr, QT, G, A, Cv, V, mo, hfa, vfa, t, tr};
    const missing = Object.keys(inputs).filter(k => !isFinite(inputs[k]));
    if (missing.length > 0) {
        showError("⚠️ Please fill in all required fields with numeric values. Missing/invalid: " + missing.join(", "), "orange");
        return;
    }

    // Basic positive checks (fields that must be strictly > 0)
    const strictlyPositive = ["QT","G","A","Cv","V","mo","hfa","vfa","t","tr"];
    const nonPositive = strictlyPositive.filter(k => inputs[k] <= 0);
    if (nonPositive.length > 0) {
        showError("❌ The following inputs must be > 0: " + nonPositive.join(", "), "red");
        return;
    }

    // Physical/realistic bounds (conservative)
    if (!(Tr > -273.15 && Tr <= 2000)) {
        showError("❌ Set Temperature (Tr) out of allowed range (-273.15 to 2000 °C).", "red");
        return;
    }
    if (!(QT > 0 && QT <= 1e9)) {
        showError("❌ Heat Input (QT) out of allowed range (0 < QT ≤ 1e9 W).", "red");
        return;
    }
    if (!(G > 1e-9 && G <= 1e6)) {
        showError("❌ Gas flow (G) out of allowed range (1e-9 < G ≤ 1e6 kg/s).", "red");
        return;
    }
    if (!(A >= 1e-6 && A <= 1e4)) {
        showError("❌ Vent area (A) out of allowed range (1e-6 ≤ A ≤ 1e4 m²).", "red");
        return;
    }
    if (!(Cv >= 1 && Cv <= 1e5)) {
        showError("❌ Specific heat (Cv) out of allowed range (1 ≤ Cv ≤ 1e5 J/(kg·K)).", "red");
        return;
    }
    if (!(V >= 1e-6 && V <= 1e7)) {
        showError("❌ Vessel volume (V) out of allowed range (1e-6 ≤ V ≤ 1e7 m³).", "red");
        return;
    }
    if (!(mo >= 1e-6 && mo <= 1e8)) {
        showError("❌ Initial mass (mo) out of allowed range (1e-6 ≤ mo ≤ 1e8 kg).", "red");
        return;
    }
    if (!(hfa >= 1 && hfa <= 1e8)) {
        showError("❌ Latent heat (hfa) out of allowed range (1 ≤ hfa ≤ 1e8 J/kg).", "red");
        return;
    }
    if (!(vfa >= 1e-6 && vfa <= 1e3)) {
        showError("❌ Specific volume (vfa) out of allowed range (1e-6 ≤ vfa ≤ 1e3 m³/kg).", "red");
        return;
    }
    if (!(tr > 0 && tr <= 1e8)) {
        showError("❌ Reference time (tr) out of allowed range (0 < tr ≤ 1e8 s).", "red");
        return;
    }
    if (!(t > 0 && t < tr)) {
        showError("❌ Time (t) must be > 0 and strictly less than reference time (tr).", "red");
        return;
    }

    // Cross-field logical checks
    // Density check
    // Initialize warning array
const warnings = [];

// Density check
const density = mo / V; // kg/m^3
if (!(density >= 0.01 && density <= 6e4)) {
    warnings.push(`Density (${density.toExponential(3)} kg/m³) is outside common ranges — check units (mo, V).`);
}

// Specific volume vs V and mass check (vfa * mo ~ V)
const volFromSpecific = vfa * mo;
if (V > 0 && Math.abs((volFromSpecific - V) / Math.max(1, V)) > 0.5) {
    warnings.push(`Specific volume * mass (${volFromSpecific.toExponential(3)} m³) differs from vessel volume (${V.toExponential(3)} m³). Check vfa, mo, and V units.`);
}

// Display all warnings in modern card style
if (warnings.length > 0) {
    resultError.innerHTML = warnings.map(w => `
        <div style="
            background-color: #fff4e5; 
            border-left: 5px solid #ff914d; 
            padding: 10px 15px; 
            margin: 5px 0; 
            border-radius: 6px; 
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        ">
            <span style="font-weight:bold; color:#ff914d;">⚠️</span>
            <span>${w}</span>
        </div>
    `).join("");
    resultError.classList.remove("hidden");
}


    // Avoid extremely small denominator in firstTerm: G * A * Cv
    const denom1 = G * A * Cv;
    if (!(Math.abs(denom1) >= 1e-12)) {
        showError("❌ G * A * Cv is too small; division would be unstable. Check G, A, Cv values.", "red");
        return;
    }

    // Numerical stability for log: require t/(tr - t) be well away from 0 or Infinity
    const frac = t / tr;
    const minFrac = 1e-6;
    const maxFrac = 1 - 1e-6;
    if (frac <= minFrac) {
        showError("⚠️ t is extremely small relative to tr (t/tr ≤ " + minFrac + "). Results may be numerically unstable. Increase t or reduce precision requirement.", "orange");
        return;
    }
    if (frac >= maxFrac) {
        showError("⚠️ t is extremely close to tr (t/tr ≥ " + maxFrac + "). The log term will blow up; results will be unreliable.", "orange");
        return;
    }

    // Compute terms safely
    let firstTerm, secondTerm, T;
    try {
        const logArg = t / (tr - t);
        if (!(isFinite(logArg) && logArg > 0)) {
            showError("❌ Invalid log argument (t / (tr - t)). Ensure 0 < t < tr and values are finite.", "red");
            return;
        }
        firstTerm = (QT / denom1) * Math.log(logArg);

        // second term denominator check
        const denom2 = Cv * vfa;
        if (!(Math.abs(denom2) >= 1e-12)) {
            showError("❌ Cv * vfa is too small; division would be unstable. Check Cv and vfa values.", "red");
            return;
        }
        secondTerm = (V / mo) * (hfa / denom2) * (t / (tr - t));

        T = Tr + firstTerm - secondTerm;

        if (!isFinite(T) || Number.isNaN(T)) {
            showError("❌ Computation resulted in non-finite temperature. Check inputs for unrealistic combinations.", "red");
            return;
        }

        // Physical output checks
        if (T <= -273.15) {
            showError("❌ Calculated temperature <= absolute zero (check units/inputs).", "red");
            return;
        }

        // Add additional warnings for very large/sudden temperature changes
       // Modern warning display
const relativeChange = Math.abs(T - Tr) / Math.max(1, Math.abs(Tr));
const warnings = [];
if (relativeChange > 10) warnings.push("Large change relative to Tr (>10×). Verify inputs.");
if (T >= 1200) warnings.push("Extremely high temperature (≥ 1200°C). Possible fire/exposure conditions or numerical instability.");

const resultError = document.getElementById("resultError");
if (warnings.length > 0) {
    // Use card-style warnings
    resultError.innerHTML = warnings.map(w => `
        <div style="
            background-color: #fff4e5; 
            border-left: 5px solid #ff914d; 
            padding: 10px 15px; 
            margin: 5px 0; 
            border-radius: 6px; 
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        ">
            <span style="font-weight:bold; color:#ff914d;">⚠️</span>
            <span>${w}</span>
        </div>
    `).join("");
    resultError.classList.remove("hidden");
}

    } catch (err) {
        showError("❌ Unexpected calculation error: " + err.message, "red");
        return;
    }

    // Display result (rounded)
    document.getElementById("temperatureValue").innerText = T.toFixed(4);
    resultValue.classList.remove("hidden");

    // Feedback categories (same as before but slightly adjusted)
    let feedback = "";
    if (T < 100) {
        feedback = "✅ Stable Temperature Rise: System within safe operating conditions (check assumptions).";
        feedbackContent.style.color = "green";
    } else if (T <= 200) {
        feedback = "⚠️ Moderate Rise: Monitor system and consider cooling/ventilation.";
        feedbackContent.style.color = "orange";
    } else if (T <= 400) {
        feedback = "🚨 High Temperature Rise: Implement immediate safety measures; follow emergency response.";
        feedbackContent.style.color = "red";
    } else {
        feedback = "🔴 Extreme Heating: Emergency condition—possible fire, structural risk, or thermal runaway — evacuate/act.";
        feedbackContent.style.color = "darkred";
    }
    feedbackContent.innerHTML = feedback;
}

</script>



    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


<!-- 1) Expert analysis (real-world QEHS / fire safety perspective)

What the calculator models

The formula aims to estimate temperature T(t) inside a homogeneous vessel during venting with a constant external heat input. The model combines a heat addition term (firstTerm) and a cooling/vaporization term (secondTerm) and adds them to a reference temperature Tr.

This is used in fire exposure / thermal hazard assessments, relief device sizing and thermal run-away analyses. In audits, such outputs must be physically plausible, traceable (units, assumptions) and include uncertainty/warnings.

Key practical concerns

Units and consistency: Many variables can be provided in different units. A single mismatch (e.g., QT in kW vs. W, time in minutes vs. seconds) will break results. The calculator must enforce and show expected units.

Physical realism: Output temperatures must be within physically realistic ranges and flagged when model assumptions are violated (no liquid left, vessel not homogeneous, t→tr, etc.).

Numerical stability: The log term ln(t/(tr - t)) goes to -∞ as t → 0+ and to +∞ as t → tr-. Must prevent tiny denominators or arguments ≤ 0.

Auditability: Inputs should be validated, units recorded, and any warnings prominent for reports.

2) Recommended validation rules (comprehensive)

Assumed unit system for this calculator (must be stated and used):

Temperature: °C (Tr, T output). If you prefer Kelvin, user must convert before input.

Heat Input: W (J/s) (QT). If user has kW, multiply by 1000.

Mass flow (G): kg/s (mass flux leaving per second).

Area (A): m².

Specific heat (Cv): J / (kg·K).

Volume (V): m³.

Mass (mo): kg (initial mass in vessel).

Latent heat (hfa): J / kg (latent heat of vaporization). Important: use latent heat (J/kg), not surface heat transfer coefficient, because formula uses an energy per mass in secondTerm.

Specific volume (vfa): m³ / kg.

Time (t, tr): seconds (s).

If you want to accept alternate units (kW, minutes, etc.), provide explicit conversion helpers. For now require the units above.

Per-field allowed ranges & details

(These ranges are conservative, for industrial safety apps — adjust if you have special conditions.)

Tr (Initial Temperature)

Units: °C

Allowed: -273.15 < Tr <= 2000

Rationale: absolute zero check; 2000°C extreme cap for industrial/thermal fire cases. Typical process range: -40 to 400°C.

QT (Total External Heat Input)

Units: W (J/s)

Allowed: 0 < QT <= 1e9 (1 GW)

Decimals: up to 6 significant decimals OK

Rationale: allows small heaters through very large fire heat fluxes; >1e9 is unrealistic for vessel scale.

G (Gas flow rate / mass flux)

Units: kg/s

Allowed: 1e-9 < G <= 1e6 (very small to very large)

Rationale: avoid zero (denominator), allow gas vents from micro to plant scale.

A (Vent surface area)

Units: m²

Allowed: 1e-6 <= A <= 1e4 (from tiny orifice to very large openings)

Rationale: nonzero; extremely large areas (>1e4 m²) are unrealistic for a single vessel.

Cv (Specific heat at const volume)

Units: J/(kg·K)

Allowed: 1 <= Cv <= 1e5

Typical gas Cv: ~100 – 2000 J/kg·K. Liquid values may differ; keep wide limits.

V (Vessel Volume)

Units: m³

Allowed: 1e-6 <= V <= 1e7

Rationale: small lab vessels to huge storage tanks.

mo (Initial mass)

Units: kg

Allowed: 1e-6 <= mo <= 1e8

Rationale: prevents zero mass; ensures density checks pass.

hfa (Latent heat / heat per mass)

Units: J/kg

Allowed: 1 <= hfa <= 1e8

Typical: water ~2.26e6 J/kg; hydrocarbons lower (~2e5–6e5 J/kg). Broad bounds allow many substances.

vfa (Specific volume)

Units: m³/kg

Allowed: 1e-6 <= vfa <= 1e3

Typical: liquids 1e-3–1e-2, gases can be much higher. Avoid zero.

t (elapsed time)

Units: seconds

Allowed: 0 < t < tr AND t >= tr * minFraction where minFraction prevents t=0; see numerical stability

Rationale: t must be positive and strictly less than tr.

tr (reference emptying time)

Units: seconds

Allowed: t < tr <= 1e8 (e.g., up to a few years in seconds if needed)

Rationale: tr must be > t

Cross-field logical checks

G * A * Cv must not be extremely small (set minimum product, e.g. >= 1e-12) to avoid division by extremely small numbers.

Density check: rho = mo / V must be in physically plausible range: 0.01 <= rho <= 60000 kg/m³ (very conservative). If outside, warn: probable wrong units or swapped V/mo.

Latent heat vs Cv: hfa should normally be > Cv * (some ΔT) — i.e., hfa large compared to sensible heat per unit mass. Warn if hfa < Cv * 1 (very small latent heat).

Specific volume vfa * mo should produce volume comparable to V: compare vfa * mo to V (liquid mass * specific volume ≈ liquid volume). If abs((vfa*mo - V)/V) > 0.5 warn of mismatch ( >50% difference).

Time fraction safety: require t/tr in (minFrac, 1 - minFrac) where minFrac = 1e-6 (or 1e-4) to avoid log blowups. If t/tr very small or very close to 1, warn and clip.

Allowed decimal precision

Accept decimals. Display and store outputs to 4–6 significant digits. Validate that inputs are finite numbers (no NaN or ±Infinity).

3) Edge case validations and handling

Division by zero

G, A, Cv, vfa, mo, tr - t must not be zero. Check before calculation.

Log argument ≤ 0

Check arg = t / (tr - t). Must be arg > 0. Because both t>0 and (tr - t)>0 guarantee >0. Still check and require t > 0 and tr > t.

t very small or very close to tr

If t/tr < 1e-6 → warn: “t too small; results numerically unstable” and optionally set t = max(t, tr*1e-6).

If (tr - t)/tr < 1e-6 → warn: “t extremely close to tr; log term grows large and T may be unbounded.”

Unrealistic input combos

Density (mo / V) outside plausible range suggests swapped V/mo or units mismatch. Warn.

QT extremely large compared to G*A*Cv may lead to extremely large firstTerm — show warning.

hfa extremely small relative to Cv * vfa will make secondTerm small — warn if suspicious.

Numeric overflow / NaN

After computing T, check isFinite(T) and not NaN. If not finite: show error and suggest which inputs likely caused it.

Sign of results

Very negative T may be physically impossible (below absolute zero); if T < -273.15°C, mark as invalid.

4) Output validation logic and threshold explanations

Output: T (°C) at time t.

Meaningful & audit-ready output rules

Units label: Always show °C and the units used for each input in the report.

Numerical plausibility checks:

If T < -50°C (for process plants) or T < -273.15°C (absolute zero), display error.

If T > 1200°C — flag as Very High Temperature (likely fire exposure or numerical explosion): show prominent warning; require secondary verification.

If T changed by orders of magnitude compared to Tr (e.g., |T - Tr| / max(1,|Tr|) > 10), flag “Large change — verify inputs and assumptions”.

Categorization (for safety actions) — use rational thresholds for alerts (you already used them). Use these conservative thresholds (adjust per plant policy):

T < 100°C — stable / low escalation (green)

100°C ≤ T < 200°C — moderate (yellow/orange) — investigates cooling

200°C ≤ T < 400°C — high (red) — immediate measures

T ≥ 400°C — extreme (dark red) — emergency level (possible structural threat / fire)

Report text: For audits, accompany the number with: assumptions (homogeneous, liquid present), units, and warnings triggered. -->