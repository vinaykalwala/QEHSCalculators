{% extends 'base.html' %}
{% block title %}Fire Safety Occupancy Calculator For Assembly and Recreation Limit{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accident Rate Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.3rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 480px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
         @media (max-width: 768px) {
    .rate-value {
        font-size: 28px; /* smaller font for tablets/mobiles */
    }
}

@media (max-width: 480px) {
    .rate-value {
        font-size: 24px; /* even smaller for phones */
    }
}
    </style>
</head>
<body>
   <div class="btn-container">
    <a href="{% url 'firecategory_calculators' %}" class="back-btn">Back To Fire Calculators</a>
</div>

<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}

    <!-- Header -->
    <div class="calculator-header">
        <h1>Fire Safety Occupancy Calculator For Assembly and Recreation Limit</h1>
        <p>
            Calculate the maximum safe occupancy for assembly and recreation spaces 
            based on floor area, activity type, exits, and travel distance.
        </p>
    </div>

    <div class="calc-content">
        <!-- Input Card -->
        <div class="calc-card">
            <h2>Enter Data</h2>

            <div id="area-container">
                <div class="input-row area-group">
                    <div class="form-group">
                        <label>Usable Floor Area (m²)</label>
                        <input type="number" class="area-input form-input" placeholder="Enter area in m²">
                    </div>
                    <div class="form-group">
                        <label>Type of Use</label>
                        <select class="useType form-input">
                            <option value="fixedSeating">Fixed Seating (0.5 m²/person)</option>
                            <option value="standingArea">Standing Area (0.3 m²/person)</option>
                            <option value="sportsHalls">Sports Halls (0.5 m²/person)</option>
                            <option value="exhibitionHalls">Exhibition Halls (0.5 m²/person)</option>
                            <option value="diningAreas">Dining Areas (1.0 m²/person)</option>
                            <option value="dancingAreas">Dancing Areas (0.3 m²/person)</option>
                            <option value="functionRooms">Function Rooms (1.0 m²/person)</option>
                        </select>
                    </div>
                </div>
            </div>

            <button onclick="addArea()" class="calculate-btn" style="margin-bottom: 10px;">Add Another Area</button>

            <div class="form-group">
                <label>Risk Level</label>
                <select id="riskLevel" class="form-input">
                    <option value="low">Low Risk (45 m)</option>
                    <option value="high">High Risk (18 m)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Max Travel Distance (m)</label>
                <input type="number" id="maxTravelDistance" class="form-input" placeholder="Enter distance">
            </div>

            <div class="form-group">
                <label>Number of Exits</label>
                <input type="number" id="numExits" class="form-input" placeholder="Enter number" oninput="generateExitFields()">
            </div>

            <div id="exit-width-container"></div>

            <button class="calculate-btn" onclick="calculateOccupancyLimit()">Calculate Occupancy</button>
        </div>

        <!-- Result Card -->
        <div class="result-card">
            <!-- Placeholder -->
            <div class="result-placeholder" id="placeholder">
                <img src="{% static 'images/assembly.jpg' %}" alt="Occupancy Illustration">
                <p>
                    This tool will calculate the <strong>Occupancy Limit</strong>. 
                    Enter your data to see results and safety insights here.
                </p>
            </div>

            <!-- Error -->
            <div class="result-error hidden" id="resultError" style="font-size: 20px;"></div>

            <!-- Result -->
            <div class="result-value hidden" id="resultValue">
                <div class="rate-value">Occupancy Results</div>
                <div id="resultDetails"></div>
                <div class="btn-wrapper">
                    <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Section -->
    <div class="note-section">
        <div class="note-card">
            <h3>📘 About This Calculator</h3>
            <p>
                This calculator estimates the maximum safe occupancy for assembly and recreation spaces, 
                considering floor area, activity type, exits, and travel distance to ensure compliance 
                with fire safety regulations.
            </p>
        </div>

       <div class="note-card">
    <h3>⚙️ Parameters</h3>
    <ul class="note-list">
        <li>
            <strong>Usable Floor Area (m²):</strong> 
            The total floor space available for occupants, excluding walls, furniture, or other obstructions.
            <ul>
                <li>Measured in square meters (m²).</li>
                <li>Larger areas allow more occupants, smaller areas limit capacity.</li>
                <li>Essential for calculating maximum safe occupancy based on activity type.</li>
            </ul>
        </li>

        <li>
            <strong>Type of Use:</strong> 
            The intended purpose of the space, which determines how much area each person needs.
            <ul>
                <li>Fixed Seating: Each person requires ~0.5 m².</li>
                <li>Standing Areas: Crowded spaces allow ~0.3 m²/person.</li>
                <li>Sports & Exhibition Halls: Moderate density, ~0.5 m²/person.</li>
                <li>Dining/Function Rooms: People need more room (~1.0 m²/person) for tables/chairs.</li>
                <li>Dancing Areas: Open movement spaces require ~0.3 m²/person.</li>
                <li>The space type affects occupancy density and evacuation safety.</li>
            </ul>
        </li>

        <li>
            <strong>Exits:</strong> 
            Number and width of exits determine how quickly people can evacuate in an emergency.
            <ul>
                <li>More exits reduce congestion and evacuation time.</li>
                <li>Each exit has a width (usually in mm) – total width contributes to safe egress.</li>
                <li>Insufficient exit width can create bottlenecks and increase risk during emergencies.</li>
            </ul>
        </li>

        <li>
            <strong>Risk Level:</strong> 
            Indicates the hazard associated with the activity and affects the maximum allowable travel distance to exits.
            <ul>
                <li>Low Risk: Spaces like auditoriums or sports halls; max travel distance up to 45 meters.</li>
                <li>High Risk: Spaces with vulnerable occupants or rapid fire potential; max travel distance limited to 18 meters.</li>
                <li>Helps ensure occupants can evacuate safely within a reasonable distance.</li>
            </ul>
        </li>

        <li>
            <strong>Maximum Travel Distance:</strong> 
            The distance an occupant must walk to reach the nearest exit.
            <ul>
                <li>Must comply with the risk level of the space.</li>
                <li>Longer distances in high-risk areas are unsafe and require additional exits or layout changes.</li>
            </ul>
        </li>
    </ul>
</div>


        <div class="note-card">
    <h3>🛡️ Input Validation Rules</h3>
    <ul class="note-list">
        <li><strong>All fields are mandatory:</strong> Ensure no input is left blank; incomplete data can result in unsafe occupancy calculations.</li>
        <li><strong>Usable Floor Area:</strong> Must be a positive number between 5 m² and 100,000 m². Zero, negative, or unrealistically large areas are invalid.</li>
        <li><strong>Type of Use:</strong> Must be selected from the predefined categories. Each type defines a specific occupancy factor.</li>
        <li><strong>Number of Exits:</strong> Must be a positive integer (minimum 1, maximum 50). Zero or excessively large numbers are not allowed.</li>
        <li><strong>Exit Widths:</strong> Each exit must be ≥ 750 mm and ≤ 10,000 mm. Ensures compliance with NFPA/ILO standards for safe egress.</li>
        <li><strong>Risk Level:</strong> Must be selected as either "Low Risk" or "High Risk". Determines maximum allowable travel distance.</li>
        <li><strong>Maximum Travel Distance:</strong> Must be positive and ≤ 45 m for low-risk spaces or ≤ 18 m for high-risk spaces.</li>
        <li><strong>Logical consistency:</strong> Total exit width should be sufficient for calculated occupancy; travel distance should be consistent with floor area and risk level.</li>
        <li><strong>Decimals:</strong> Floor area and exit widths can have up to 2 decimal places; number of exits must be integer.</li>
        <li><strong>Edge cases:</strong> Zero or negative values, missing fields, travel distances exceeding risk limits, and total exit width insufficient for occupancy will trigger errors or warnings.</li>
    </ul>
</div>

    </div>
</div>

<script>
function addArea() {
    let container = document.getElementById("area-container");
    let areaGroup = document.createElement("div");
    areaGroup.classList.add("input-row", "area-group");
    areaGroup.innerHTML = `
        <div class="form-group">
            <label>Usable Floor Area (m²)</label>
            <input type="number" class="area-input form-input" placeholder="Enter area in m²">
        </div>
        <div class="form-group">
            <label>Type of Use</label>
            <select class="useType form-input">
                <option value="fixedSeating">Fixed Seating (0.5 m²/person)</option>
                <option value="standingArea">Standing Area (0.3 m²/person)</option>
                <option value="sportsHalls">Sports Halls (0.5 m²/person)</option>
                <option value="exhibitionHalls">Exhibition Halls (0.5 m²/person)</option>
                <option value="diningAreas">Dining Areas (1.0 m²/person)</option>
                <option value="dancingAreas">Dancing Areas (0.3 m²/person)</option>
                <option value="functionRooms">Function Rooms (1.0 m²/person)</option>
            </select>
        </div>`;
    container.appendChild(areaGroup);
}

function generateExitFields() {
    let numExits = parseInt(document.getElementById("numExits").value) || 0;
    let container = document.getElementById("exit-width-container");
    container.innerHTML = "";
    for (let i = 1; i <= numExits; i++) {
        let exitDiv = document.createElement("div");
        exitDiv.classList.add("form-group");
        exitDiv.innerHTML = `
            <label>Width of Exit ${i} (mm)</label>
            <input type="number" class="exit-width form-input" placeholder="Enter width in mm">`;
        container.appendChild(exitDiv);
    }
}

function calculateOccupancyLimit() {
    const resultValue = document.getElementById('resultValue');
    const placeholder = document.getElementById('placeholder');
    const resultError = document.getElementById('resultError');
    const resultDetails = document.getElementById('resultDetails');

    // Reset display
    resultError.classList.add('hidden');
    resultValue.classList.add('hidden');
    placeholder.classList.add('hidden');
    resultError.innerHTML = "";
    resultDetails.innerHTML = "";

    let areas = document.querySelectorAll(".area-group");
    if (areas.length === 0) {
        resultError.innerHTML = "❌ Please add at least one area.";
        resultError.style.color = "red";
        resultError.classList.remove('hidden');
        return;
    }

    const occupancyFactors = {
        fixedSeating: 0.5,
        standingArea: 0.3,
        sportsHalls: 0.5,
        exhibitionHalls: 0.5,
        diningAreas: 1.0,
        dancingAreas: 0.3,
        functionRooms: 1.0
    };

    let totalOccupancy = 0;

    for (let areaGroup of areas) {
        let area = parseFloat(areaGroup.querySelector(".area-input").value);
        let useType = areaGroup.querySelector(".useType").value;

        if (isNaN(area) || area <= 0 || area > 100000) {
            resultError.innerHTML = "❌ Floor area must be positive and less than 100,000 m².";
            resultError.style.color = "red";
            resultError.classList.remove('hidden');
            return;
        }

        if (!occupancyFactors.hasOwnProperty(useType)) {
            resultError.innerHTML = "❌ Invalid type of use selected.";
            resultError.style.color = "red";
            resultError.classList.remove('hidden');
            return;
        }

        totalOccupancy += area / occupancyFactors[useType];
    }

    let numExits = parseInt(document.getElementById("numExits").value);
    if (isNaN(numExits) || numExits <= 0 || numExits > 50) {
        resultError.innerHTML = "❌ Number of exits must be a positive integer (max 50).";
        resultError.style.color = "red";
        resultError.classList.remove('hidden');
        return;
    }

    let maxTravelDistance = parseFloat(document.getElementById("maxTravelDistance").value);
    let riskLevel = document.getElementById("riskLevel").value;

    if (isNaN(maxTravelDistance) || maxTravelDistance <= 0) {
        resultError.innerHTML = "❌ Travel distance must be a positive number.";
        resultError.style.color = "red";
        resultError.classList.remove('hidden');
        return;
    }

    if ((riskLevel === "low" && maxTravelDistance > 45) || (riskLevel === "high" && maxTravelDistance > 18)) {
        resultError.innerHTML = `⚠️ Travel distance exceeds the safe limit for ${riskLevel === "low" ? 'Low' : 'High'} Risk.`;
        resultError.style.color = "orange";
        resultError.classList.remove('hidden');
        return;
    }

    let exitWidths = document.querySelectorAll(".exit-width");
    let totalExitWidth = 0;
    for (let exit of exitWidths) {
        let w = parseFloat(exit.value);
        if (isNaN(w) || w < 750 || w > 10000) {
            resultError.innerHTML = "❌ Each exit width must be between 750 mm and 10,000 mm.";
            resultError.style.color = "red";
            resultError.classList.remove('hidden');
            return;
        }
        totalExitWidth += w;
    }

    // Minimum required exit width per person
    const minWidthPerPerson = 0.5 * 1000; // 0.5 m per person in mm for seated assembly
    if (totalOccupancy * 0.5 * 1000 > totalExitWidth) {
        resultError.innerHTML = "⚠️ Total exit width may be insufficient for calculated occupancy. Verify exits.";
        resultError.style.color = "orange";
        resultError.classList.remove('hidden');
    }

    // Display results
    resultDetails.innerHTML = `
        <p><strong>Maximum Occupancy Limit:</strong> ${Math.floor(totalOccupancy)} people</p>
        <p><strong>Number of Exits:</strong> ${numExits}</p>
        <p><strong>Total Exit Width Provided:</strong> ${(totalExitWidth/1000).toFixed(2)} m</p>
        <p><strong>Maximum Travel Distance:</strong> ${maxTravelDistance} m</p>`;
    resultValue.classList.remove('hidden');
}


function printReport() {
    window.print();
}
</script>


    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


<!-- 1. Input Validation Rules (QEHS & Fire Safety Perspective)
Input	Rules	Units / Range	QEHS Justification
Usable Floor Area	Mandatory, positive, realistic range	5 – 100,000 m², allow decimals up to 2 places	Floor area determines maximum occupancy; too small or negative is illogical, too large may indicate mis-entry.
Type of Use	Mandatory, must match pre-defined categories	Enum: fixedSeating, standingArea, sportsHalls, exhibitionHalls, diningAreas, dancingAreas, functionRooms	Each use type has a regulatory occupancy factor; ensures proper density calculation per NFPA/ILO/ISO 45001.
Number of Exits	Mandatory, integer, ≥1	1 – 50 (practical max)	Minimum 1 exit required for evacuation; exceeding practical limits triggers warning.
Exit Width (per exit)	Mandatory if exit exists, positive, ≥750 mm	0.75 – 10,000 mm	NFPA & ILO standards specify minimum widths per exit (750 mm typical). Too small is unsafe; too large may indicate error.
Risk Level	Mandatory	Enum: low, high	Determines max travel distance according to ISO/NFPA.
Max Travel Distance	Mandatory, positive, ≤ 45 m for low risk, ≤ 18 m for high risk	0.1 – 45 m (low risk), 0.1 – 18 m (high risk)	Ensures evacuation is possible within safe limits; exceeding triggers a warning.

Additional cross-field checks:

Sum of exit widths vs total occupancy should meet safe egress thresholds.

Max travel distance should logically correspond to space size; e.g., a 20 m² room cannot have a travel distance of 50 m.

Occupancy should not exceed NFPA occupancy limits for the given exit width.

2. Output Validation Logic & Thresholds

Maximum Occupancy Limit:

Must be positive, integer (round down).

If exceeds practical thresholds (>10,000 in a single room), show warning.

Compare against total exit width to ensure compliance:

NFPA 101: 0.2 m per person for standing, 0.5 m per person for seated in assembly areas.

If totalExitWidth / occupancy < required width per person, warn user.

Total Exit Width Provided:

Sum of exit widths; should meet minimum safe egress per person.

If total width < minimum required, warn user.

Maximum Travel Distance:

Must not exceed risk-based limit.

If exceeded, highlight as non-compliant.

3. Edge Case Handling
Edge Case	Handling
Floor area = 0 or negative	Show error "Floor area must be positive"
Exit width = 0 or negative	Show error "Exit widths must be positive"
No exits	Show error "At least one exit is required"
Max travel distance exceeds risk threshold	Show warning "Travel distance exceeds safe limit"
Unrealistic occupancy (e.g., >10,000 people)	Show warning "Occupancy unusually high; verify inputs"
Decimal or fractional exit widths	Allow up to 1 decimal place for realism
Missing any mandatory field	Prevent calculation; show error


5. Edge Cases Handled

Zero or negative areas, exits, widths, travel distance → error.

Too large floor area (>100,000 m²) → error.

Travel distance > risk-based limit → warning.

Exit width < 750 mm → error.

Total exit width insufficient for occupancy → warning.

Unknown activity type → error.

No area added → error.

Exits number exceeding practical limit (50) → error.

6. Why Each Validation is Essential (Compliance Perspective)
Validation	Reason
Positive floor area	Cannot have zero or negative usable space; NFPA mandates actual usable area.
Realistic floor area (<100,000 m²)	Prevents unrealistic data entry; ensures calculations reflect real buildings.
Positive exits / widths ≥ 750 mm	NFPA & ILO specify minimum exit width to ensure safe egress.
Travel distance limit	ISO, NFPA, and local fire codes limit travel distance depending on risk level.
Total exit width vs occupancy	Ensures egress capacity is sufficient; avoids bottlenecks in emergencies.
Valid activity type	Different activities have standard density factors; prevents miscalculation.
Mandatory inputs	Prevents partial data which would yield unsafe results. -->