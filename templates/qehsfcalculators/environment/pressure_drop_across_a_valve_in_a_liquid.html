{% extends 'base.html' %}
{% block title %}Pressure Drop Across a Valve In A Liquid Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pressure Drop Across a Valve In A Liquid Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background: linear-gradient(#1560bd, #000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center;
            flex-wrap: wrap;
        }

        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        .rate-label { 
            color: #7f8c8d;
            font-size: 20px;
            font-weight: bold;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .rate-value {
                font-size: 38px;
            }
            .rate-label {
                font-size: 18px;
            }
        }
        
        @media (max-width: 992px) {
            .rate-value {
                font-size: 34px;
            }
            .rate-label {
                font-size: 17px;
            }
        }
        
        @media (max-width: 768px) {
            .rate-value {
                font-size: 30px;
                margin-bottom: 8px;
            }
            .rate-label {
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .rate-value {
                font-size: 28px;
                margin-bottom: 6px;
            }
            .rate-label {
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .rate-display {
                flex-direction: column;
                gap: 2px;
                text-align: center;
            }
            .rate-value {
                font-size: 24px;
                margin-bottom: 4px;
            }
            .rate-label {
                font-size: 14px;
            }
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>

    <div class="btn-container">
        <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
    </div>


<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}


<div class="calculator-header">
    <h1>Pressure Drop Across a Valve In A Liquid Calculator</h1>
    <p>
        Estimate the pressure drop across a control valve in liquid systems 
        to ensure correct valve sizing, pump selection, and energy efficiency.
    </p>
</div>

    <div class="calc-content">
        <!-- Calculator -->
        <div class="calc-card">
            <h2>Enter Data</h2>

            <div class="form-group">
                <label for="specificGravity">Specific Gravity (G)</label>
                <input type="number" id="specificGravity" class="form-input" min="0.01" step="any" placeholder="e.g., 1.0">
            </div>

            <div class="form-group">
                <label for="flowrate">Flowrate (V̇) [m³/h]</label>
                <input type="number" id="flowrate" class="form-input" min="0.001" step="any" placeholder="e.g., 10">
            </div>

            <div class="form-group">
                <label for="Kv">Valve Flow Coefficient (Kᵥ) [m³/h per bar]</label>
                <input type="number" id="Kv" class="form-input" min="0.000001" step="any" placeholder="e.g., 5.6">
            </div>

            <button class="calculate-btn" onclick="calculatePressureDrop()">Calculate Pressure Drop</button>
        </div>

        <!-- Result Section -->
        <div class="result-card">
            <div class="result-placeholder" id="placeholder">
                <img src="/static/images/mlc_environment_result.png" alt="Valve flow illustration">
                <p>This tool calculates the <strong>Pressure Drop (ΔP)</strong> across a valve for liquid flow.</p>
            </div>

            <div class="result-error hidden" id="resultError">
                <div class="error-icon">❌</div>
                <div class="error-message" id="errorMessage"></div>
            </div>

            <div class="result-value hidden" id="resultValue">
                <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                    <h2>Pressure Drop</h2>
                </div>

                <div class="rate-display">
                    <div class="rate-value" id="rateValue">0.0000</div>
                    <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">bar</div>
                </div>

                <div class="result-feedback">
                    <div class="feedback-title">Assessment</div>
                    <div class="feedback-content" id="feedbackContent"></div>
                </div>
                <div class="btn-wrapper">
                    <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                </div>
            </div>
        </div>
    </div>

<div class="note-section">
    <div class="note-card">
        <h3>📘 About This Calculator</h3>
        <p>
            This calculator estimates the steady-state pressure drop across a valve for liquids using a commonly
            used engineering relationship based on the valve flow coefficient K<sub>v</sub>, volumetric flow, and
            fluid specific gravity. It is intended as a screening/engineering tool (not CFD) for valve sizing and system design.
        </p>
    </div>

    <div class="note-card">
        <h3>⚙ Parameters Used</h3>
        <ul class="note-list">
            <li>Specific Gravity (G): Dimensionless ratio of fluid density relative to water</li>
            <li>Flowrate (V̇) [m³/h]: Volumetric flow through the valve</li>
            <li>Valve coefficient (K<sub>v</sub>): Metric flow coefficient (m³/h per bar) representing valve capacity</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>✅ Input Validation Rules</h3>
        <ul class="note-list">
            <li>G numeric &gt; 0; typical 0.5–1.8; error if ≤0 or &gt;3</li>
            <li>V̇ numeric &gt; 0; typical 0.001–1e5 m³/h; error if ≤0 or &gt;1e6</li>
            <li>K<sub>v</sub> numeric &gt; 0; typical 0.01–1e4 m³/h·bar⁻¹; error if ≤0 or &gt;1e6</li>
            <li>Decimals &gt;6 → precision warning</li>
            <li>Cross-check: very small K<sub>v</sub> relative to flow (V̇/K<sub>v</sub> &gt; 1e5) triggers a warning</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>✅ Output Validations & Assessment</h3>
        <ul class="note-list">
            <li>Computed pressure drop (ΔP) must be finite, positive, and within plausible engineering ranges.</li>
            <li>Feedback/assessment displayed along with result:
                <ul>
                    <li>ΔP &lt; 0.1 bar → Minimal pressure drop; generally acceptable</li>
                    <li>0.1 ≤ ΔP &lt; 1.5 bar → Moderate pressure drop; check pump/system head</li>
                    <li>ΔP ≥ 1.5 bar → High pressure drop; consider larger valve/K<sub>v</sub> or higher pump head</li>
                </ul>
            </li>
            <li>Warnings for input decimals, V̇/K<sub>v</sub> ratio, G, and extreme ΔP are displayed as guidance.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>📚 Governing Principle</h3>
        <p>
            A "Pressure Drop Across a Valve Calculator" is often based on the Cv or K<sub>v</sub> flow coefficient standards, 
            which are industry standards for measuring fluid flow rate through a valve at a specific pressure drop. 
            Cv is used in the imperial system, defining flow in US gallons per minute, while K<sub>v</sub> is the metric equivalent, 
            defining flow in cubic meters per hour, as established by standards such as DIN EN 60 534 and VDE/VDI 2173.
        </p>
        <p>
            <strong>Key Concepts:</strong>
            <ul>
                <li><strong>Purpose:</strong> Standardized metrics for comparing flow capacity of different valves to select the correct valve.</li>
                <li><strong>Definition:</strong> Higher Cv/K<sub>v</sub> indicates a valve can pass greater fluid volume for a given pressure drop.</li>
                <li><strong>Standardization:</strong> Cv: 1 US gallon/min with 1 psi ΔP; K<sub>v</sub>: 1 m³/h with 1 bar ΔP, metric equivalent (European standards).</li>
                <li><strong>Application:</strong> Liquid calculators use these coefficients to determine proper valve sizing by relating flow rate to ΔP.</li>
            </ul>
        </p>
        <p>
            Engineers rely on these standards to ensure valves handle required flow under operating conditions safely and efficiently.
        </p>
    </div>

    <div class="note-card">
        <h3>🏁 Conclusion</h3>
        <p>
            The calculator provides engineers with a reliable estimate of pressure drop across valves for liquids, 
            supporting valve selection, system optimization, and operational safety. 
            Feedback classification and warnings help ensure proper sizing and highlight potential unit or input errors.
        </p>
    </div>
</div>


<script>
/* Show error messages (preserves original behavior and classes) */
function showErrors(errors) {
  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");

  errorMessage.innerHTML = errors.join("<br>");
  errorBox.classList.remove("hidden");
  placeholder.classList.add("hidden");
  resultValue.classList.add("hidden");
}

/* decimal count helper for warnings */
function countDecimals(rawStr) {
  if (typeof rawStr !== 'string') rawStr = String(rawStr || '');
  if (!rawStr.includes('.')) return 0;
  let decPart = rawStr.split('.')[1].split(/e|E/)[0];
  decPart = decPart.replace(/[^0-9]/g, '');
  return decPart.length;
}

/* Main calculation and validations */
function calculatePressureDrop() {
  // Read raw strings for precision checks
  const rawG = (document.getElementById("specificGravity")?.value || "").trim();
  const rawV = (document.getElementById("flowrate")?.value || "").trim();
  const rawKv = (document.getElementById("Kv")?.value || "").trim();

  const placeholder = document.getElementById("placeholder");
  const errorBox = document.getElementById("resultError");
  const resultValue = document.getElementById("resultValue");
  const displayEl = document.getElementById("rateValue");
  const feedbackEl = document.getElementById("feedbackContent");

  // reset UI
  errorBox.classList.add("hidden");
  feedbackEl.innerHTML = "";

  const errors = [];
  const warnings = [];

  // presence checks
  if (rawG === "") errors.push("👉 Specific gravity (G) is required.");
  if (rawV === "") errors.push("👉 Flowrate (V̇) is required.");
  if (rawKv === "") errors.push("👉 Valve coefficient (Kᵥ) is required.");
  if (errors.length) return showErrors(errors);

  // parse
  const G = parseFloat(rawG);
  const V = parseFloat(rawV);
  const Kv = parseFloat(rawKv);

  // numeric & range validation (conservative, engineering-oriented)
  if (!Number.isFinite(G) || G <= 0 || G > 3) errors.push("👉 G must be a finite positive number (typical range 0.5–1.8).");
  if (!Number.isFinite(V) || V <= 0 || V > 1e6) errors.push("👉 V̇ must be a finite positive number in m³/h (allowed up to 1e6).");
  if (!Number.isFinite(Kv) || Kv <= 0 || Kv > 1e6) errors.push("👉 Kᵥ must be a finite positive number (avoid zero; allowed up to 1e6).");
  if (errors.length) return showErrors(errors);

  // decimal warnings
  if (countDecimals(rawG) > 6 || countDecimals(rawV) > 6 || countDecimals(rawKv) > 6) {
    warnings.push("⚠️ Some inputs have >6 decimal places — round for reporting.");
  }

  // plausibility and cross-field checks
  const ratio = V / Kv; // used inside formula
  if (!Number.isFinite(ratio)) {
    return showErrors(["❌ Computation failed (division error). Check Kv is not zero."]);
  }
  if (ratio > 1e5) {
    warnings.push("⚠️ Very large V̇/Kᵥ ratio — this implies a very large ΔP; verify units and inputs.");
  }
  if (Kv < 0.01 && V > 1000) {
    warnings.push("⚠️ Very small Kᵥ with large flowrate — valve likely undersized.");
  }
  if (G < 0.5 || G > 2) warnings.push("⚠️ G outside typical ranges for many liquids — verify fluid identity.");

  // compute deltaP (bar) using internal formula
  const deltaP = G * Math.pow(ratio, 2); // ΔP = G * (V / Kv)^2  (bar)

  if (!Number.isFinite(deltaP) || isNaN(deltaP)) {
    return showErrors(["❌ Computation failed — check input magnitudes and units."]);
  }

  // sanity check results
  if (deltaP <= 0) return showErrors(["❌ Computed pressure drop is non-positive — check inputs."]);
  if (deltaP > 1e7) return showErrors(["❌ Computed ΔP is unphysically large (>1e7 bar) — check units."]);

  // unit conversions & classifications
  const deltaP_psi = deltaP * 14.503773773; // 1 bar = 14.503773773 psi

  let classification = "";
  let advice = "";
  if (deltaP < 0.1) {
    classification = "Minimal pressure drop";
    advice = "Valve causes small loss — generally acceptable for most systems.";
  } else if (deltaP < 1.5) {
    classification = "Moderate pressure drop";
    advice = "Check pump capacity and system head; typically acceptable.";
  } else {
    classification = "High pressure drop";
    advice = "Consider larger valve/Kᵥ or higher pump head; high ΔP can cause inefficiencies or cavitation.";
  }
  if (deltaP > 50) warnings.push("⚠️ Extremely high ΔP (>50 bar) — likely unit mismatch or severe undersizing.");

  // Build feedback (NO input echoing here)
  let details = `<div><b>Pressure Drop (ΔP):</b> <b>${deltaP.toFixed(4)}</b> bar</div>`;
  details += `<div style="margin-top:6px;"><b>Pressure Drop:</b> <b>${deltaP_psi.toFixed(2)}</b> psi</div>`;
  details += `<div style="margin-top:6px;"><b>Classification:</b> ${classification}</div>`;
  details += `<div style="margin-top:6px;">Advice: ${advice}</div>`;
  if (warnings.length) details += `<div style="margin-top:8px; color:#b35d00;">${warnings.join(" | ")}</div>`;

  // update UI
  displayEl.textContent = deltaP.toFixed(4);
  feedbackEl.innerHTML = details;

  placeholder.classList.add("hidden");
  resultValue.classList.remove("hidden");
  errorBox.classList.add("hidden");
}

/* print helper (preserves original behavior) */
function printReport() {
  const el = document.getElementById('printDate');
  if (el) {
    el.textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  }
  window.print();
}
</script>


    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


<!--
  🔹 Pressure Drop Across a Valve (ΔP) Calculator - Formula & Validations

  1️⃣ Formula:
      ΔP = G × (V / Kᵥ)²         (bar)
      ΔP₍psi₎ = ΔP × 14.5038     (psi)

      where:
        • G = Specific Gravity (dimensionless)
        • V = Flowrate [m³/h]
        • Kᵥ = Valve Flow Coefficient [m³/h per bar]

  2️⃣ Inputs:
      - Specific Gravity (G): > 0, typical 0.5–1.8 (error if ≤0 or >3)
      - Flowrate (V̇): > 0, up to 1e6 m³/h (warning if unrealistic)
      - Valve Coefficient (Kᵥ): > 0, up to 1e6 (warning if too small for large flow)

  3️⃣ Outputs & Validations:
      - Pressure Drop ΔP in bar (to 4 decimals)
      - Conversion to psi (to 2 decimals)
      - Must be finite, positive, and ≤ 1e7 bar
      - Classification:
          • ΔP < 0.1 → Minimal pressure drop
          • 0.1 ≤ ΔP < 1.5 → Moderate pressure drop
          • ΔP ≥ 1.5 → High pressure drop
      - Warnings:
          • Inputs with > 6 decimals → suggest rounding
          • V/Kᵥ > 1e5 → very large ΔP, verify sizing/units
          • Kᵥ < 0.01 with V > 1000 → valve likely undersized
          • G < 0.5 or > 2 → outside typical range for liquids
          • ΔP > 50 bar → extreme, likely unit mismatch
-->
