{% extends 'base.html' %}
{% block title %}Entering Coil Conditions (Ventilation Airflow) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entering Coil Conditions (Ventilation Airflow) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background: linear-gradient(#1560bd, #000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center;
            flex-wrap: wrap;
        }

        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        .rate-label { 
            color: #7f8c8d;
            font-size: 20px;
            font-weight: bold;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .rate-value {
                font-size: 38px;
            }
            .rate-label {
                font-size: 18px;
            }
        }
        
        @media (max-width: 992px) {
            .rate-value {
                font-size: 34px;
            }
            .rate-label {
                font-size: 17px;
            }
        }
        
        @media (max-width: 768px) {
            .rate-value {
                font-size: 30px;
                margin-bottom: 8px;
            }
            .rate-label {
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .rate-value {
                font-size: 28px;
                margin-bottom: 6px;
            }
            .rate-label {
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .rate-display {
                flex-direction: column;
                gap: 2px;
                text-align: center;
            }
            .rate-value {
                font-size: 24px;
                margin-bottom: 4px;
            }
            .rate-label {
                font-size: 14px;
            }
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>

<div class="btn-container">
        <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
</div>

<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}

<div class="calculator-header">
  <h1>Entering Coil Conditions (Ventilation Airflow) Calculator</h1>
  <p>
    Estimate the fraction of outdoor (fresh) air entering at the coil conditions versus total supply airflow.
    Useful for IAQ compliance reviews, energy checks, and QEHS/ESG reporting.
  </p>
</div>

<div class="calc-content">
  <!-- Calculator -->
  <div class="calc-card">
    <h2>Enter Data</h2>

    <div class="form-group">
      <label for="ventFlow">Outdoor (Ventilation) Airflow (V) <span>[m³/s]</span></label>
      <input type="number" id="ventFlow" class="form-input" min="0.001" step="0.001" placeholder="e.g., 2.500">
    </div>

    <div class="form-group">
      <label for="totalFlow">Total Supply Airflow (T) <span>[m³/s]</span></label>
      <input type="number" id="totalFlow" class="form-input" min="0.001" step="0.001" placeholder="e.g., 12.000">
    </div>

    <button class="calculate-btn" onclick="calculateOutdoorAir()">Calculate Outdoor Air %</button>
  </div>

  <!-- Result Section -->
  <div class="result-card">
    <div class="result-placeholder" id="placeholder">
      <img src="/static/images/mlc_environment_result.png" alt="Ventilation illustration">
      <p>This tool calculates <strong>Outdoor Air Percentage</strong> at entering coil conditions.</p>
    </div>

    <div class="result-error hidden" id="resultError">
      <div class="error-icon">❌</div>
      <div class="error-message" id="errorMessage"></div>
    </div>

    <div class="result-value hidden" id="resultValue">
      <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
        <h2>Calculated Outdoor Air %</h2>
      </div>

      <div class="rate-display">
        <div class="rate-value" id="rateValue">0.00</div>
        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">% outdoor air (at coil entry)</div>
      </div>

      <div class="result-feedback">
        <div class="feedback-title">Assessment</div>
        <div class="feedback-content" id="feedbackContent"></div>
      </div>
      <div class="btn-wrapper">
        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
      </div>
    </div>
  </div>
</div>

<!-- Notes Section -->
<div class="note-section">
  <div class="note-card">
    <h3>📘 About This Calculator</h3>
    <p>
      Estimates the percent of outdoor (fresh) air mixed with recirculated air at the AHU coil entering conditions.
      Use it to benchmark IAQ programs, economizer operation, and energy impacts during audits and management reviews.
    </p>
  </div>

  <div class="note-card">
    <h3>🛡️ QEHS & Fire Safety Perspective</h3>
    <ul class="note-list">
      <li>Supports indoor air quality targets, contaminant dilution, and odor/smoke clearance plans.</li>
      <li>Helps check minimum outdoor air settings during drills, shelter-in-place, purge, or post-incident clearance.</li>
      <li>High outdoor air can increase heating/cooling and dehumidification load—watch coil freeze and humidity risks.</li>
      <li>Pair with airflow balancing data, damper positions, and CO<sub>2</sub>/TVOC monitoring for verification.</li>
    </ul>
  </div>

  <div class="note-card">
    <h3>📊 Interpretation (Guidance)</h3>
    <ul class="note-list">
      <li><span class="bad">&lt; 10%</span> → Very low; review design basis and IAQ requirements.</li>
      <li><span class="average">10–50%</span> → Typical for mixed-air systems; confirm occupancy & pollutant load.</li>
      <li><span class="average">50–80%</span> → High; verify energy penalties and coil capacity.</li>
      <li><span class="good">≈100%</span> → 100% OA (economizer/DOAS/purge); ensure freeze and humidity controls.</li>
    </ul>
    <p style="font-size:0.9em;color:#555;">(Calibrate to your codes, climate, occupancy, and risk profile.)</p>
  </div>

  <div class="note-card">
    <h3>⚠️ Input Validations</h3>
    <ul>
      <li>✔️ <strong>V, T (m³/s)</strong>: required, &gt; 0, allowed 0.001–500 (typical single AHU: 0.1–50).</li>
      <li>✔️ Decimals allowed; reporting precision ≤ 0.001 m³/s recommended.</li>
      <li>✔️ Cross-field: V ≤ T. Recirculated flow = T − V (must be ≥ 0).</li>
      <li>✔️ Output shown as percent outdoor air; 0–100% expected.</li>
      <li>❌ Zeros, negatives, non-numeric values rejected.</li>
      <li>⚠️ Very small T (&lt; 0.05 m³/s) or very large (&gt; 100 m³/s): verify units (m³/s vs L/s or CFM).</li>
    </ul>
  </div>

  <div class="note-card">
    <h3>🌍 Applications</h3>
    <ul class="note-list">
      <li>IAQ compliance checks and audit evidence.</li>
      <li>Economizer commissioning and seasonal changeover.</li>
      <li>Purge/flush strategies after maintenance or incidents.</li>
      <li>Energy management and dehumidification risk reviews.</li>
    </ul>
  </div>
</div>

<script>
/* Reusable error display */
function showErrors(errors) {
  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");

  errorMessage.innerHTML = errors.join("<br>");
  errorBox.classList.remove("hidden");
  placeholder.classList.add("hidden");
  resultValue.classList.add("hidden");
}

/* Outdoor Air % with robust, domain-aware validations */
function calculateOutdoorAir() {
  const Vraw = (document.getElementById("ventFlow").value || "").trim();
  const Traw = (document.getElementById("totalFlow").value || "").trim();

  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");
  const rateEl = document.getElementById("rateValue");
  const feedbackEl = document.getElementById("feedbackContent");

  // reset UI
  errorBox.classList.add("hidden");
  errorMessage.innerHTML = "";
  feedbackEl.innerHTML = "";

  const errors = [];
  const warnings = [];

  // presence
  if (!Vraw) errors.push("👉 Please enter Outdoor (Ventilation) Airflow (V) in m³/s.");
  if (!Traw) errors.push("👉 Please enter Total Supply Airflow (T) in m³/s.");
  if (errors.length) return showErrors(errors);

  // parse
  const V = Number(Vraw);
  const T = Number(Traw);

  // numeric checks
  if (!Number.isFinite(V)) errors.push("👉 V must be a valid number (m³/s).");
  if (!Number.isFinite(T)) errors.push("👉 T must be a valid number (m³/s).");
  if (errors.length) return showErrors(errors);

  // hard ranges (physical & practical)
  const MIN = 1e-3;   // 0.001 m³/s
  const MAX = 500;    // very large industrial upper cap
  if (V <= 0 || V < MIN || V > MAX) {
    errors.push(`👉 V must be > 0 and within ${MIN} to ${MAX} m³/s.`);
  }
  if (T <= 0 || T < MIN || T > MAX) {
    errors.push(`👉 T must be > 0 and within ${MIN} to ${MAX} m³/s.`);
  }
  if (errors.length) return showErrors(errors);

  // cross-field logic
  if (V > T) {
    return showErrors(["👉 Outdoor airflow (V) cannot exceed total supply airflow (T)."]);
  }

  // precision advisories
  const decimals = (s) => (String(s).split(".")[1] || "").length;
  if (decimals(Vraw) > 3) warnings.push("⚠️ V has more than 3 decimals – consider rounding for reporting.");
  if (decimals(Traw) > 3) warnings.push("⚠️ T has more than 3 decimals – consider rounding for reporting.");

  // sanity advisories
  if (T < 0.05) warnings.push("⚠️ Total supply airflow is very small – verify units (m³/s vs L/s or CFM).");
  if (T > 100) warnings.push("⚠️ Total supply airflow is very large – verify scale and units.");
  if (V === 0) warnings.push("⚠️ No outdoor air indicated – verify damper position and measurement method.");

  // compute % outdoor air
  const frac = V / T;
  if (!Number.isFinite(frac) || frac < 0) {
    return showErrors(["⚠️ Computation invalid. Check inputs."]);
  }
  const pct = frac * 100;

  // interpretation
  let statusMsg = "";
  if (frac === 0) {
    statusMsg = "❌ 0% OA — recirculation only; check IAQ requirements.";
  } else if (frac < 0.10) {
    statusMsg = "🟡 Very low OA — review design basis and risk/IAQ targets.";
  } else if (frac <= 0.50) {
    statusMsg = "🟢 Typical mixed-air range — confirm occupancy and contaminant loads.";
  } else if (frac < 1.0) {
    statusMsg = "🟡 High OA — verify energy, coil capacity, and humidity controls.";
  } else { // exactly 100%
    statusMsg = "✅ 100% OA (economizer/DOAS/purge) — ensure freeze/humidity protections.";
  }

  // derived values
  const recirc = T - V;

  // formatted outputs
  const fmt = (n, d=3) => Number(n).toLocaleString(undefined,{minimumFractionDigits:d, maximumFractionDigits:d});
  const fmtPct = (n, d=2) => Number(n).toLocaleString(undefined,{minimumFractionDigits:d, maximumFractionDigits:d});

  let details = `<div>Outdoor air: <b>${fmt(V,3)}</b> m³/s</div>`;
  details += `<div>Total supply: <b>${fmt(T,3)}</b> m³/s</div>`;
  details += `<div>Recirculated air: <b>${fmt(recirc,3)}</b> m³/s</div>`;
  if (warnings.length) {
    details += `<div style="margin-top:6px; color:#b35d00; font-size:0.95em;">${warnings.join(" | ")}</div>`;
  }

  // update UI
  rateEl.textContent = fmtPct(pct, 2);
  document.querySelector(".rate-label").textContent = "% outdoor air (at coil entry)";
  feedbackEl.innerHTML = `<div>${statusMsg}</div>${details}`;

  document.getElementById("placeholder").classList.add("hidden");
  resultValue.classList.remove("hidden");
  errorBox.classList.add("hidden");
}

function printReport() {
  const el = document.getElementById('printDate');
  if (el) {
    const now = new Date();
    el.textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  }
  window.print();
}
</script>


    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}



<!-- 
=============================================
📘 Outdoor Air Percentage Calculator
=============================================

📌 Formula:
-----------
%OA = ( V / T ) × 100

Where:
- V = Outdoor (ventilation) airflow [m³/s]
- T = Total supply airflow [m³/s]
- Recirculated air = T − V

---

✅ Input Validations:
---------------------
1. Presence:
   • Both V (outdoor airflow) and T (total supply airflow) are required.

2. Data type:
   • V and T must be valid numeric values.

3. Ranges:
   • 0.001 ≤ V ≤ 500 m³/s  
   • 0.001 ≤ T ≤ 500 m³/s  

4. Cross-field logic:
   • V must not exceed T (outdoor air cannot be greater than total supply).

---

⚠️ Warnings / Advisories:
--------------------------
• More than 3 decimals entered → consider rounding for reporting.  
• T < 0.05 → Very small supply airflow, verify units (m³/s vs L/s or CFM).  
• T > 100 → Very large supply airflow, verify scale and units.  
• V = 0 → No outdoor air, check damper position/measurement.  

---

📊 Outputs:
-----------
• % Outdoor air (%OA) at coil entry.  
• Outdoor airflow V (m³/s).  
• Total supply airflow T (m³/s).  
• Recirculated airflow (T − V).  
• Status message based on OA fraction:
   - 0% → Recirculation only  
   - <10% → Very low OA  
   - 10–50% → Typical mixed-air range  
   - 50–100% → High OA (energy/humidity check)  
   - 100% → 100% OA (economizer/DOAS/purge mode)  

=============================================
-->
