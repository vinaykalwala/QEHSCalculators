{% extends 'base.html' %}
{% block title %}Energy Balance between Steam and Fluid of a Flow-Type Application Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Balance between Steam and Fluid of a Flow-Type Application Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
<style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
             /* display: flex;  */
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
            /* overflow-y: auto;  */
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Input rows for better organization */
        .input-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .input-row .form-group {
            flex: 1;
        }
        
        @media (max-width: 600px) {
            .input-row {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }

                .rate-display {
                display: flex;
                gap: 20px;
                justify-content: center;
                align-items: center;
                flex-wrap: wrap; /* responsive */
                text-align: center;
            }

            .rate-block {
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 120px; /* keeps blocks same width */
            }

            .rate-label {
                font-weight: bold;
                font-size: 16px;
                color: #444;
                margin-bottom: 5px;
            }

            .rate-value {
                font-size: 40px;
                font-weight: 700;
                color: #2980b9;
                line-height: 1.2;
            }

            .rate-unit {
                font-size: 14px;
                color: #777;
                margin-top: 4px;
            }

            /* Responsive */
            @media (max-width: 768px) {
                .rate-value { font-size: 32px; }
            }

            @media (max-width: 480px) {
                .rate-value { font-size: 26px; }
                
                .rate-unit { font-size: 12px; }
                
            }



        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
                .result-feedback {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 18px 20px;
    border-left: 4px solid #3498db;
    text-align: left;
    max-width: 800px; /* keeps it readable on large screens */
    margin: 0 auto;   /* centers it */
}

.feedback-title {
    font-weight: 600;
    margin-bottom: 8px;
    color: #2c3e50;
    font-size: 18px;
}

.feedback-content { 
    color: #34495e; 
    font-size: 16px;
    line-height: 1.5;
}

/* Responsive breakpoints */
@media (max-width: 768px) {
    .result-feedback {
        padding: 15px;
        font-size: 15px;
    }

    .feedback-title {
        font-size: 16px;
    }

    .feedback-content {
        font-size: 14px;
    }
}

@media (max-width: 480px) {
    .result-feedback {
        padding: 12px;
        border-left-width: 3px;
    }

    .feedback-title {
        font-size: 15px;
    }

    .feedback-content {
        font-size: 13px;
    }
}

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .formula-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 6px solid #0d47a1;
        }
        
        .formula-card code {
            display: inline-block;
            background: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #0d47a1;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>

<div class="btn-container">
        <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
</div>
<div class="calculator-container printable" id="printArea">


{% include "includes/print_header_footer.html" %}



<div class="calculator-header">
  <h1>Energy Balance between Steam and Fluid of a Flow-Type Application Calculator</h1>
 <p>
  This calculator estimates the heat supplied by condensing steam and, if fluid data are entered, compares it with the heat absorbed by a secondary fluid to check the overall energy balance. The result is displayed in kilowatts (kW).
</p>

</div>

<div class="calc-content">
  <!-- Calculator -->
  <div class="calc-card">
    <h2>Enter Parameters</h2>

    <!-- Steam side (required) -->
    <div class="input-row">
      <div class="form-group">
        <label for="ms">Mean Steam Rate (ṁₛ, kg/s)</label>
        <input type="number" id="ms" class="form-input" step="0.0001" min="0.0001" placeholder="e.g., 0.35" aria-label="Steam mass flowrate">
      </div>
      <div class="form-group">
        <label for="hfg">Latent Heat (h<sub>fg</sub>, kJ/kg)</label>
        <input type="number" id="hfg" class="form-input" step="0.1" min="1000" max="2600" placeholder="e.g., 2257" aria-label="Latent heat of evaporation">
      </div>
    </div>

    <div class="input-row">
            
        <div class="form-group">
            <label for="m_dot">Secondary Fluid ṁ (kg/s) — optional</label>
            <input type="number" id="m_dot" class="form-input" step="0.0001" min="0.0001" placeholder="e.g., 2.00" aria-label="Secondary fluid mass flow">
        </div>

        <div class="form-group">
            <label for="cp">Specific Heat c<sub>p</sub> (kJ/kg·°C) — optional</label>
            <input type="number" id="cp" class="form-input" step="0.01" min="0.1" max="8" placeholder="e.g., 4.18" aria-label="Specific heat capacity">
        </div>
    </div>

        <div class="form-group">
            <label for="dT">ΔT of Fluid (°C) — optional (must be &gt; 0 for heating)</label>
            <input type="number" id="dT" class="form-input" step="0.1" min="0.1" max="200" placeholder="e.g., 20" aria-label="Fluid temperature rise">
        </div>

    <button class="calculate-btn" onclick="calculateHeadLoss()">Calculate Heat Duty</button>
  </div>

  <!-- Result Section -->
  <div class="result-card">
    <div class="result-placeholder" id="placeholder">
      <img src="/static/images/mlc_environment_result.png" alt="Heat exchange illustration">
      <p>This tool computes steam heat duty (kW) and optionally performs an energy balance against the fluid side.</p>
    </div>

    <div class="result-error hidden" id="resultError" role="alert" aria-live="polite">
      <div class="error-icon">❌</div>
      <div class="error-message" id="errorMessage"></div>
    </div>

    <div class="result-value hidden" id="resultValue" aria-live="polite">
      <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
        <h2>Heat Duty</h2>
      </div>

      <div class="rate-display" style="gap:12px; align-items:center; justify-content:center;">
        <div class="rate-value" id="headLoss">0.00</div>
        <div class="rate-label" style="font-size:16px; color: #2980b9;">kW</div>
      </div>

      <div class="result-feedback">
        <div class="feedback-title">Assessment</div>
        <div class="feedback-content" id="feedbackContent"></div>
      </div>

      <div class="btn-wrapper">
        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
      </div>
    </div>
  </div>
</div>

<!-- Notes Section -->
<div class="note-section">
  <!-- About -->
  <div class="note-card">
    <h3>📘 About This Calculator</h3>
    <p>
      This calculator estimates the heat supplied by condensing steam and, when secondary fluid data are entered, compares it with the heat absorbed by the fluid. 
      It is designed to help assess energy balance in steam heating and cooling applications, ensuring that supplied and absorbed heat values are consistent with safe and efficient system operation. 
      The tool provides immediate feedback on duty classification and energy balance assessment for decision support.
    </p>
  </div>

  <!-- Parameters Used -->
  <div class="note-card">
    <h3>⚙ Parameters Used</h3>
    <ul class="note-list">
      <li><strong>Steam-side:</strong> Mass flow rate ṁₛ (kg/s), Latent heat h<sub>fg</sub> (kJ/kg), Dryness fraction x (dimensionless, 0 &lt; x ≤ 1, defaults to 1 if blank)</li>
      <li><strong>Optional Fluid-side:</strong> Mass flow ṁ (kg/s), Specific heat c<sub>p</sub> (kJ/kg·°C), Temperature rise ΔT (°C)</li>
    </ul>
  </div>

  <!-- Input Validation Rules -->
  <div class="note-card">
    <h3>✅ Input Validation Rules</h3>
    <ul class="note-list">
      <li><strong>Steam side (required):</strong> ṁₛ: 0.0001–200 kg/s, h<sub>fg</sub>: 1000–2600 kJ/kg, x: 0 &lt; x ≤ 1</li>
      <li><strong>Fluid side (optional, all-or-none):</strong> ṁ: 0.0001–200 kg/s, c<sub>p</sub>: 0.1–8 kJ/kg·°C, ΔT: 0.1–200 °C and &gt;0 for heating</li>
      <li>Cross-field check: if any one of (ṁ, c<sub>p</sub>, ΔT) is entered, all must be provided</li>
      <li>All inputs must be numeric and finite</li>
    </ul>
  </div>

  <!-- Output Validations -->
  <div class="note-card">
    <h3>📊 Output Validations & Assessment</h3>
    <ul class="note-list">
      <li>Steam-side heat duty Q̇<sub>steam</sub> must be >0 and finite; optional fluid-side duty Q̇<sub>fluid</sub> must also be >0 and finite</li>
      <li>Extremely high duties flagged: Q̇<sub>steam</sub> &gt;10 MW (very high), &gt;100 MW (extreme)</li>
      <li>Energy balance assessment: Δ = |Q̇<sub>steam</sub> – Q̇<sub>fluid</sub>|, Tolerance = max(5 kW, 5% of larger duty).  
          ✔ Within tolerance → Energy balance achieved.  
          ⚠ Steam duty &gt; fluid absorption → check insulation & losses.  
          ⚠ Fluid absorption &gt; steam duty → verify inputs and assumptions.
      </li>
      <li>Classification by magnitude: Small &lt;50 kW, Moderate 50–500 kW, High 500–5000 kW, Very High &gt;5000 kW</li>
    </ul>
  </div>

  <!-- Governing Principle -->
  <div class="note-card">
    <h3>📚 Governing Principle</h3>
    <p>
      The standard for an energy balance calculator in flow-type applications, especially those involving steam, is not a single specific standard but rather relies on fundamental principles of thermodynamics, primarily the First Law of Thermodynamics (conservation of energy). While no universal calculator standard exists, industry-specific standards like those from the Bureau of Energy Efficiency (BEE) in India and international organizations like the International Organization for Standardization (ISO) provide guidelines for energy assessment, boiler efficiency testing, and fluid flow measurement, which underpin such calculators.
    </p>
    <p>
      <strong>Fundamental Principles:</strong> Energy balance calculations are based on the principle of energy conservation, which states that energy cannot be created or destroyed but only transformed from one form to another. Thermodynamic properties, such as enthalpy and specific heat, are used to quantify energy inputs and outputs, often derived from steam tables.
    </p>
    <p>
      <strong>Industry and International Standards:</strong> Boiler efficiency standards (e.g., BS845:1987) describe methods for testing boiler efficiency. ISO 5167 provides guidelines for accurate flow measurement using devices like orifice plates. Organizations like BEE and the National Statistical Office (NSO) provide frameworks for material and energy balances in industrial contexts.
    </p>
    <p>
      This calculator adheres to these principles and frameworks, using them to provide assessment feedback and duty classification as described in the Output Validations section.
    </p>
  </div>

  <!-- Conclusion -->
  <div class="note-card">
    <h3>🔚 Conclusion</h3>
    <p>
      This tool provides a reliable estimate of steam heat duty and, optionally, fluid-side energy absorption, helping engineers and operators assess energy balance. It flags unusually high or low values, verifies input consistency, and classifies duty magnitude to aid operational decision-making and safety reviews. While assumptions like saturated steam and bulk fluid properties are used, it gives a practical overview of energy transfer and system performance in flow-type applications.
    </p>
  </div>
</div>


<script>
/* Reuse your error UI */
function showErrors(errors) {
  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");

  errorMessage.innerHTML = errors.join("<br>");
  errorBox.classList.remove("hidden");
  placeholder.classList.add("hidden");
  resultValue.classList.add("hidden");
}

/* Drop-in replacement:
   - Computes Q_steam = ms * x * hfg (kW)
   - Optional Q_fluid = m_dot * cp * dT (kW)
   - Strong validations + warnings
   - Reuses #headLoss for numeric result and #feedbackContent for details
*/
function calculateHeadLoss() {
  const get = id => document.getElementById(id)?.value?.trim();

  const headLossEl = document.getElementById("headLoss");      // shows kW
  const feedbackEl  = document.getElementById("feedbackContent");
  const placeholder = document.getElementById("placeholder");
  const resultBox   = document.getElementById("resultValue");
  const errBox      = document.getElementById("resultError");

  // reset UI
  errBox.classList.add("hidden");
  feedbackEl.innerHTML = "";

  // parse inputs
  const ms   = parseFloat(get("ms"));
  const hfg  = parseFloat(get("hfg"));
  const xRaw = get("x");
  const x    = (xRaw === "" || xRaw == null) ? 1 : parseFloat(xRaw);

  const m_dotRaw = get("m_dot");
  const cpRaw    = get("cp");
  const dTRaw    = get("dT");

  const anyFluid = [m_dotRaw, cpRaw, dTRaw].some(v => v !== "" && v != null);
  const allFluid = [m_dotRaw, cpRaw, dTRaw].every(v => v !== "" && v != null);

  const errors = [];
  const warnings = [];

  const isNum = v => Number.isFinite(v);
  const decimals = v => {
    const s = String(v);
    return s.includes(".") ? (s.length - s.indexOf(".") - 1) : 0;
  };

  // -------- Required steam-side validation --------
  if (!isNum(ms) || !isNum(hfg) || !isNum(x)) {
    errors.push("👉 Steam inputs (ṁₛ, h_fg, x) must be numeric. x defaults to 1.00 if left blank.");
  }
  if (isNum(ms) && (ms < 0.0001 || ms > 200)) {
    errors.push("👉 Steam rate ṁₛ must be within 0.0001–200 kg/s.");
  } else if (isNum(ms)) {
    if (ms > 50) warnings.push("⚠️ Very large steam rate — verify line sizing, trap capacity, relief/LOPA.");
    else if (ms > 10) warnings.push("⚠️ High steam rate — check trap and condensate return capacity.");
  }

  if (isNum(hfg) && (hfg < 1000 || hfg > 2600)) {
    errors.push("👉 Latent heat h_fg must be within 1000–2600 kJ/kg.");
  } else if (isNum(hfg)) {
    if (hfg < 2000 || hfg > 2400) warnings.push("⚠️ h_fg outside typical 1–10 bar range — confirm steam tables.");
  }

  if (isNum(x) && (x <= 0 || x > 1)) {
    errors.push("👉 Dryness fraction x must be in (0, 1].");
  } else if (isNum(x) && x < 0.9) {
    warnings.push("⚠️ Wet steam (x < 0.9) — increased water hammer/erosion risk.");
  }

  // Precision hints (non-blocking)
  if (isNum(ms) && decimals(ms) > 4) warnings.push("ℹ️ ṁₛ reported with >4 decimals — may exceed instrument precision.");
  if (isNum(hfg) && decimals(hfg) > 1) warnings.push("ℹ️ h_fg reported with >1 decimal — consider rounding to nearest 0.1.");
  if (isNum(x) && decimals(x) > 2) warnings.push("ℹ️ x reported with >2 decimals — consider rounding.");

  // -------- Optional fluid-side validation (all-or-none) --------
  let m_dot, cp, dT;
  if (anyFluid && !allFluid) {
    errors.push("👉 Provide all fluid-side fields together (ṁ, c_p, ΔT) or leave all blank.");
  } else if (allFluid) {
    m_dot = parseFloat(m_dotRaw);
    cp    = parseFloat(cpRaw);
    dT    = parseFloat(dTRaw);

    if (!isNum(m_dot) || !isNum(cp) || !isNum(dT)) {
      errors.push("👉 Fluid-side inputs must be numeric.");
    }
    if (isNum(m_dot) && (m_dot < 0.0001 || m_dot > 200)) {
      errors.push("👉 Fluid mass flow ṁ must be within 0.0001–200 kg/s.");
    } else if (isNum(m_dot) && m_dot > 50) {
      warnings.push("⚠️ Very large fluid flow — check pump and line sizing.");
    }

    if (isNum(cp) && (cp < 0.1 || cp > 8)) {
      errors.push("👉 Specific heat c_p must be within 0.1–8 kJ/kg·°C.");
    } else if (isNum(cp) && (cp < 1 || cp > 5)) {
      warnings.push("⚠️ c_p is unusual for common liquids — confirm fluid properties.");
    }

    if (isNum(dT) && (dT <= 0 || dT < 0.1 || dT > 200)) {
      errors.push("👉 ΔT must be >0 and within 0.1–200 °C for steam heating.");
    }
  }

  // If any blocking error -> show and return
  if (errors.length) return showErrors(errors);

  // -------- Calculations --------
  // Q_steam in kW (kJ/s)
  const Qsteam = ms * x * hfg;

  // sanity checks
  if (!isNum(Qsteam) || Qsteam <= 0 || !isFinite(Qsteam)) {
    return showErrors(["⚠️ Computed heat duty is invalid. Check inputs."]);
  }
  if (Qsteam > 1e5) {
    warnings.push("⚠️ Extremely high heat duty (>100 MW) — verify plausibility.");
  } else if (Qsteam > 1e4) {
    warnings.push("⚠️ Very high heat duty (>10 MW) — ensure relief, condensate capacity, and insulation are adequate.");
  }

  // Optional fluid side comparison
  let details = "";
  let classification = "";
  let suggestion = "";

  // Classification by magnitude
  if (Qsteam < 50) {
    classification = "Small Duty";
    suggestion = "✅ Suitable for small coils/labs; verify control valve turndown.";
  } else if (Qsteam < 500) {
    classification = "Moderate Duty";
    suggestion = "ℹ️ Typical unit operation; check trap sizing and condensate return.";
  } else if (Qsteam < 5000) {
    classification = "High Duty";
    suggestion = "⚠️ Review exchanger sizing, insulation, and condensate backpressure.";
  } else {
    classification = "Very High Duty";
    suggestion = "❗ Plant-scale load; conduct relief/LOPA review and thermal stress checks.";
  }

  // Build details
  details += `<div>Q̇<sub>steam</sub> = <b>${Qsteam.toFixed(2)}</b> kW</div>`;
  details += `<div>Classification: <b>${classification}</b></div>`;
  details += `<div style="margin-top:6px;">${suggestion}</div>`;

  if (allFluid) {
    const Qfluid = m_dot * cp * dT;
    if (!isNum(Qfluid) || !isFinite(Qfluid) || Qfluid <= 0) {
      return showErrors(["⚠️ Computed fluid-side duty is invalid. Check ṁ, c_p, and ΔT."]);
    }

    const larger = Math.max(Qsteam, Qfluid);
    const tol = Math.max(5, 0.05 * larger); // kW
    const diff = Math.abs(Qsteam - Qfluid);
    const pct = (diff / larger) * 100;

    let balanceMsg = "";
    if (diff <= tol) {
      balanceMsg = "✔ Energy balance achieved (within tolerance).";
    } else if (Qsteam > Qfluid) {
      balanceMsg = "⚠ Imbalance: steam duty exceeds fluid absorption — check insulation & losses.";
    } else {
      balanceMsg = "⚠ Imbalance: fluid absorption exceeds steam duty — verify inputs & assumptions.";
    }

    details += `<div style="margin-top:8px;">Q̇<sub>fluid</sub> = <b>${Qfluid.toFixed(2)}</b> kW</div>`;
    details += `<div>Δ = ${diff.toFixed(2)} kW (${pct.toFixed(1)}%) | Tolerance ≈ ${tol.toFixed(2)} kW</div>`;
    details += `<div style="margin-top:6px;">${balanceMsg}</div>`;

    // Additional plausibility warnings
    if (Qfluid > 1.2 * Qsteam) {
      warnings.push("⚠️ Fluid-side duty substantially exceeds steam-side duty — reevaluate ΔT/c_p/ṁ.");
    }
    if (dT > 120) {
      warnings.push("⚠️ Large ΔT — validate material limits and scaling/coking risks.");
    }
  }

  // Append warnings
  if (warnings.length) {
    details += `<div style="margin-top:8px; color:#b35d00;">${warnings.join(" | ")}</div>`;
  }

  // Push to UI
  document.getElementById("placeholder").classList.add("hidden");
  document.getElementById("resultError").classList.add("hidden");
  document.getElementById("resultValue").classList.remove("hidden");

  headLossEl.textContent = Qsteam.toFixed(2); // numeric display
  feedbackEl.innerHTML = details;
}

function printReport() {
  const el = document.getElementById('printDate');
  if (el) {
    el.textContent = new Date().toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
  }
  window.print();
}
</script>

<script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


<!-- /*
==========================================================
📌 Steam & Fluid Heat Duty Calculator
==========================================================

🔹 Formulas:
1. Steam-side heat duty:
      Q̇_steam = ṁₛ × x × h_fg
      where:
        ṁₛ   = steam mass flow rate [kg/s]
        h_fg = latent heat of vaporization [kJ/kg]
        x    = dryness fraction (dimensionless, 0 < x ≤ 1)

   (Units: kW since kJ/s = kW)

2. Optional fluid-side heat duty:
      Q̇_fluid = ṁ × c_p × ΔT
      where:
        ṁ   = fluid mass flow rate [kg/s]
        c_p = specific heat [kJ/kg·°C]
        ΔT  = temperature rise [°C]

3. Energy balance check:
      Δ = |Q̇_steam – Q̇_fluid|
      Tolerance = max(5 kW, 5% of larger duty)
      ✔ If Δ ≤ tolerance → Energy balance achieved.

----------------------------------------------------------
🔹 Input Validations:

1. Steam side (required):
   - ṁₛ: 0.0001 ≤ ṁₛ ≤ 200 kg/s
   - h_fg: 1000 ≤ h_fg ≤ 2600 kJ/kg
   - x: 0 < x ≤ 1 (defaults to 1 if left blank)

2. Fluid side (optional, all-or-none):
   - ṁ: 0.0001 ≤ ṁ ≤ 200 kg/s
   - c_p: 0.1 ≤ c_p ≤ 8 kJ/kg·°C
   - ΔT: 0.1 ≤ ΔT ≤ 200 °C, must be >0

3. Cross-field validation:
   - If any one of (ṁ, c_p, ΔT) is given, all must be provided.
   - All inputs must be numeric and finite.

----------------------------------------------------------
🔹 Output Validations:
- Q̇_steam must be >0, finite, and valid.
- If Q̇_fluid is provided, must also be >0 and finite.
- Extremely high duties flagged:
   • Q̇_steam > 100 MW → extreme
   • Q̇_steam > 10 MW → very high

----------------------------------------------------------
🔹 Warnings:
- High steam rate: ṁₛ > 10 kg/s (trap/return capacity).
- Very high steam rate: ṁₛ > 50 kg/s (line sizing/LOPA).
- h_fg outside 2000–2400 kJ/kg → unusual (check steam tables).
- Wet steam (x < 0.9) → water hammer / erosion risk.
- Precision warnings: too many decimals in inputs.
- Fluid c_p < 1 or > 5 → unusual for common liquids.
- ΔT > 120 °C → check material limits / scaling risks.
- Fluid duty > 1.2 × steam duty → suspect inputs.

----------------------------------------------------------
🔹 Classification by Steam Duty (Q̇_steam):
- < 50 kW   → Small Duty (lab/small coils).
- 50–500 kW → Moderate Duty (typical units).
- 500–5000 kW → High Duty (large exchangers).
- > 5000 kW → Very High Duty (plant-scale).

==========================================================
*/ -->








