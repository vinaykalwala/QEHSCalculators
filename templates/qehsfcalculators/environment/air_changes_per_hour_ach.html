{% extends 'base.html' %}
{% block title %}Air Changes per Hour (ACH) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Changes per Hour (ACH) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background: linear-gradient(#1560bd, #000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center;
            flex-wrap: wrap;
        }

        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        .rate-label { 
            color: #7f8c8d;
            font-size: 20px;
            font-weight: bold;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .rate-value {
                font-size: 38px;
            }
            .rate-label {
                font-size: 18px;
            }
        }
        
        @media (max-width: 992px) {
            .rate-value {
                font-size: 34px;
            }
            .rate-label {
                font-size: 17px;
            }
        }
        
        @media (max-width: 768px) {
            .rate-value {
                font-size: 30px;
                margin-bottom: 8px;
            }
            .rate-label {
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .rate-value {
                font-size: 28px;
                margin-bottom: 6px;
            }
            .rate-label {
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .rate-display {
                flex-direction: column;
                gap: 2px;
                text-align: center;
            }
            .rate-value {
                font-size: 24px;
                margin-bottom: 4px;
            }
            .rate-label {
                font-size: 14px;
            }
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>

        <div class="btn-container">
        <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">

    {% include "includes/print_header_footer.html" %}

    <div class="calculator-header">
        <h1>Air Changes per Hour (ACH) Calculator</h1>
        <p>Calculate how many times the air in a space is replaced per hour using airflow rate and room volume.</p>
    </div>

    <div class="calc-content">
        <!-- Calculator -->
        <div class="calc-card">
            <h2>Enter Data</h2>

            <div class="form-group">
                <label for="airflowRate">Airflow Rate (m¬≥/min)</label>
                <input type="number" id="airflowRate" class="form-input" min="0.1" step="any" placeholder="e.g., 500">
            </div>

            <div class="form-group">
                <label for="volume">Volume of Space (m¬≥)</label>
                <input type="number" id="volume" class="form-input" min="1" step="any" placeholder="e.g., 3000">
            </div>
            
            <button class="calculate-btn" onclick="calculateACH()">Calculate ACH</button>
        </div>

        <!-- Result Section -->
        <div class="result-card">
            <div class="result-placeholder" id="placeholder">
                <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Air flow illustration">
                <p>This tool will calculate the <strong>Air Changes per Hour (ACH)</strong>.</p>
            </div>
            
            <div class="result-error hidden" id="resultError">
                <div class="error-icon">‚ùå</div>
                <div class="error-message" id="errorMessage"></div>
            </div>
             
            <div class="result-value hidden" id="resultValue">
                <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                    <h2>Calculated ACH</h2>
                </div>

                <div class="rate-display">
                <div class="rate-value" id="rateValue">0.00</div>
                <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Air Changes/hour</div>
                </div>
                
                <div class="result-feedback">
                    <div class="feedback-title">Assessment</div>
                    <div class="feedback-content" id="feedbackContent"></div>
                </div>
                <div class="btn-wrapper">
                    <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Section -->
    <div class="note-section">
        <div class="note-card">
            <h3>üìò About This Calculator</h3>
            <p>
                The <strong>ACH Calculator</strong> determines the number of times per hour that the total volume of air 
                in a space is replaced, based on the airflow rate and the space‚Äôs volume.
            </p>
        </div>
        
        

        <div class="note-card">
            <h3>üìä Interpretation</h3>
            <ul class="note-list">
                <li><span class="good">ACH ‚â• 6</span> ‚Üí üåü Excellent ventilation.</li>
                <li><span class="average">ACH 4‚Äì6</span> ‚Üí ‚úÖ Good ventilation.</li>
                <li><span class="average">ACH 2‚Äì4</span> ‚Üí üü¢ Fair ventilation.</li>
                <li><span class="bad">ACH &lt; 2</span> ‚Üí üî¥ Poor ventilation.</li>
            </ul>
        </div>

        <div class="note-card">
            <h3>‚ö†Ô∏è Limitations</h3>
            <p>
                While ACH is a useful measure of ventilation effectiveness, it does not directly account for airflow 
                distribution, filtration efficiency, or pollutant sources inside the space. Always combine ACH values 
                with other indoor air quality assessments for accurate evaluation.
            </p>
        </div>

        <div class="note-card">
            <h3>üåç Key Applications</h3>
            <ul class="note-list">
                <li><strong>Hospitals:</strong> Infection control through air replacement.</li>
                <li><strong>Laboratories & Cleanrooms:</strong> Ensuring contamination-free environments.</li>
                <li><strong>Commercial & Residential Spaces:</strong> Maintaining healthy indoor air quality.</li>
            </ul>
        </div>
    </div>

</div>

<script>
/* Helper to show error box consistently */
function showErrors(errors) {
  const errorBox = document.getElementById('resultError');
  const errorMessage = document.getElementById('errorMessage');
  const placeholder = document.getElementById('placeholder');
  const resultValue = document.getElementById('resultValue');

  if (errorMessage) errorMessage.innerHTML = errors.join('<br>');
  if (errorBox) errorBox.classList.remove('hidden');
  if (placeholder) placeholder.classList.add('hidden');
  if (resultValue) resultValue.classList.add('hidden');
}

/* Main ACH calculator with robust validations */
function calculateACH() {
  // safe reads
  const airflowRaw = document.getElementById('airflowRate')?.value.trim() ?? "";
  const volumeRaw  = document.getElementById('volume')?.value.trim() ?? "";

  const errorBox = document.getElementById('resultError');
  const errorMessage = document.getElementById('errorMessage');
  const placeholder = document.getElementById('placeholder');
  const resultValue = document.getElementById('resultValue');
  const rateEl = document.getElementById('rateValue');
  const feedbackEl = document.getElementById('feedbackContent');

  // reset UI
  if (errorBox) errorBox.classList.add('hidden');
  if (errorMessage) errorMessage.innerHTML = "";
  if (feedbackEl) feedbackEl.innerHTML = "";

  const errors = [];
  const warnings = [];

  // required checks
  if (airflowRaw === "") errors.push("üëâ Please enter the Airflow Rate (m¬≥/min).");
  if (volumeRaw === "") errors.push("üëâ Please enter the Volume (m¬≥).");
  if (errors.length > 0) {
    showErrors(errors);
    return;
  }

  // parse
  const airflowRate = parseFloat(airflowRaw);
  const volume = parseFloat(volumeRaw);

  if (!Number.isFinite(airflowRate) || !Number.isFinite(volume)) {
    showErrors(["‚ö†Ô∏è Enter valid numeric values for airflow rate and volume."]);
    return;
  }

  // logical / physical checks
  if (airflowRate <= 0) errors.push("üëâ Airflow Rate must be greater than 0 (m¬≥/min).");
  if (volume <= 0) errors.push("üëâ Volume must be greater than 0 (m¬≥).");

  if (errors.length > 0) {
    showErrors(errors);
    return;
  }

  // non-blocking sanity warnings (detect likely unit or entry mistakes)
  // thresholds are heuristic ‚Äî adjust to your domain if needed
  if (airflowRate > 1e5) warnings.push("‚ö†Ô∏è Very large airflow rate ‚Äî check units (maybe input was m¬≥/h or L/min?).");
  if (airflowRate < 0.001) warnings.push("‚ö†Ô∏è Very small airflow rate ‚Äî check units (m¬≥/min) or sensor reading.");
  if (volume > 1e6) warnings.push("‚ö†Ô∏è Very large room volume ‚Äî verify units (m¬≥) or data entry.");
  if (volume < 0.01) warnings.push("‚ö†Ô∏è Very small volume ‚Äî verify units (m¬≥).");

  // core formula: ACH = (Q √ó 60) / V, where Q in m^3/min, V in m^3 -> ACH in 1/h
  const ach = (airflowRate * 60) / volume;

  if (!Number.isFinite(ach) || ach < 0) {
    showErrors(["‚ö†Ô∏è Calculation produced invalid result. Check input values."]);
    return;
  }

  // feedback categories (generic). You can adapt thresholds per building type.
  let feedback;
  if (ach >= 6) {
    feedback = "üåü Excellent ventilation! Great air exchange (‚â• 6 ACH).";
  } else if (ach >= 4) {
    feedback = "‚úÖ Good ventilation (4‚Äì6 ACH).";
  } else if (ach >= 2) {
    feedback = "üü¢ Fair ventilation (2‚Äì4 ACH). Consider improvements for sensitive uses.";
  } else {
    feedback = "üî¥ Poor ventilation (<2 ACH). Air circulation is likely inadequate.";
  }

  // show numeric + details (include warnings if any)
  if (rateEl) rateEl.textContent = ach.toFixed(2);
  let details = `<div>Calculated ACH: <b>${ach.toFixed(2)} per hour</b></div>`;
  if (warnings.length) {
    details += `<div style="margin-top:6px; color:#b35d00; font-size:0.95em;">Note: ${warnings.join(' | ')}</div>`;
  }
  if (feedbackEl) feedbackEl.innerHTML = `<div>${feedback}</div>${details}`;

  // toggle UI
  if (placeholder) placeholder.classList.add('hidden');
  if (resultValue) resultValue.classList.remove('hidden');
  if (errorBox) errorBox.classList.add('hidden');
}

/* safe print guard */
function printReport() {
  const el = document.getElementById('printDate');
  if (el) {
    const now = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    el.textContent = now.toLocaleDateString('en-US', options);
  }
  window.print();
}
</script>

<script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}
