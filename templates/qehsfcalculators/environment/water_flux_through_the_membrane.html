{% extends 'base.html' %}
{% block title %}Water Flux Through Membrane Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Flux Through Membrane Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
<style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
             /* display: flex;  */
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
            /* overflow-y: auto;  */
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Input rows for better organization */
        .input-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .input-row .form-group {
            flex: 1;
        }
        
        @media (max-width: 600px) {
            .input-row {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }

                .rate-display {
                display: flex;
                gap: 20px;
                justify-content: center;
                align-items: center;
                flex-wrap: wrap; /* responsive */
                text-align: center;
            }

            .rate-block {
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 120px; /* keeps blocks same width */
            }

            .rate-label {
                font-weight: bold;
                font-size: 16px;
                color: #444;
                margin-bottom: 5px;
            }

            .rate-value {
                font-size: 40px;
                font-weight: 700;
                color: #2980b9;
                line-height: 1.2;
            }

            .rate-unit {
                font-size: 14px;
                color: #777;
                margin-top: 4px;
            }

            /* Responsive */
            @media (max-width: 768px) {
                .rate-value { font-size: 32px; }
            }

            @media (max-width: 480px) {
                .rate-value { font-size: 26px; }
                
                .rate-unit { font-size: 12px; }
                
            }



        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
                .result-feedback {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 18px 20px;
    border-left: 4px solid #3498db;
    text-align: left;
    max-width: 800px; /* keeps it readable on large screens */
    margin: 0 auto;   /* centers it */
}

.feedback-title {
    font-weight: 600;
    margin-bottom: 8px;
    color: #2c3e50;
    font-size: 18px;
}

.feedback-content { 
    color: #34495e; 
    font-size: 16px;
    line-height: 1.5;
}

/* Responsive breakpoints */
@media (max-width: 768px) {
    .result-feedback {
        padding: 15px;
        font-size: 15px;
    }

    .feedback-title {
        font-size: 16px;
    }

    .feedback-content {
        font-size: 14px;
    }
}

@media (max-width: 480px) {
    .result-feedback {
        padding: 12px;
        border-left-width: 3px;
    }

    .feedback-title {
        font-size: 15px;
    }

    .feedback-content {
        font-size: 13px;
    }
}

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .formula-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 6px solid #0d47a1;
        }
        
        .formula-card code {
            display: inline-block;
            background: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #0d47a1;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>

<div class="btn-container">
        <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
    </div>
<div class="calculator-container printable" id="printArea">

{% include "includes/print_header_footer.html" %}

<div class="calculator-header">
    <h1>Water Flux Through Membrane Calculator</h1>
    <p>Calculate water flux across a membrane using the standard formula (result shown in kmol/(m²·s)).</p>
</div>

<div class="calc-content">
    <!-- Calculator -->
    <div class="calc-card">
        <h2>Enter Parameters</h2>

        <div class="input-row">
            <div class="form-group">
                <label for="permeability">Water Permeability Coefficient (W<sub>p</sub>, kmol/(m²·s·Pa))</label>
                <input type="number" id="permeability" class="form-input" step="any" min="0" placeholder="e.g., 1.5e-8" aria-label="Water permeability coefficient">
            </div>

            <div class="form-group">
                <label for="pressureIn">Pressure at Inlet (P<sub>in</sub>, Pa)</label>
                <input type="number" id="pressureIn" class="form-input" step="any" min="0" placeholder="e.g., 500000" aria-label="Pressure at inlet">
            </div>
        </div>

        <div class="input-row">
            <div class="form-group">
                <label for="pressureOut">Pressure at Outlet (P<sub>out</sub>, Pa)</label>
                <input type="number" id="pressureOut" class="form-input" step="any" min="0" placeholder="e.g., 100000" aria-label="Pressure at outlet">
            </div>

            <div class="form-group">
                <label for="osmoticIn">Osmotic Pressure at Inlet (π<sub>in</sub>, Pa)</label>
                <input type="number" id="osmoticIn" class="form-input" step="any" min="0" placeholder="e.g., 250000" aria-label="Osmotic pressure at inlet">
            </div>
        </div>

        <div class="input-row">
            <div class="form-group">
                <label for="osmoticOut">Osmotic Pressure at Outlet (π<sub>out</sub>, Pa)</label>
                <input type="number" id="osmoticOut" class="form-input" step="any" min="0" placeholder="e.g., 50000" aria-label="Osmotic pressure at outlet">
            </div>
        </div>

        <button class="calculate-btn" onclick="calculateWaterFlux()">Calculate Water Flux</button>
    </div>

    <!-- Result Section -->
    <div class="result-card">
        <div class="result-placeholder" id="placeholder">
            <img src="/static/images/mlc_environment_result.png" alt="Membrane illustration">
            <p>This tool calculates water flux across a membrane using the standard formula.</p>
        </div>

        <div class="result-error hidden" id="resultError" role="alert" aria-live="polite">
            <div class="error-icon">❌</div>
            <div class="error-message" id="errorMessage"></div>
        </div>

        <div class="result-value hidden" id="resultValue" aria-live="polite">
            <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                <h2>Water Flux</h2>
            </div>

            <div class="rate-display" style="gap:12px; align-items:center; justify-content:center;">
                <div class="rate-value" id="waterFlux">0.00</div>
                <div class="rate-unit">kmol/(m²·s)</div>
            </div>

            <div class="result-feedback">
                <div class="feedback-title">Membrane Performance Assessment</div>
                <div class="feedback-content" id="feedbackContent"></div>
            </div>

            <div class="btn-wrapper">
                <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
            </div>
        </div>
    </div>
</div>

<!-- Notes Section -->
<div class="note-section">
    <div class="note-card">
        <h3>📘 About This Calculator</h3>
        <p>
            This calculator determines the water flux across a membrane, a crucial parameter in separation processes like reverse osmosis, nanofiltration, and other membrane-based separation technologies. It calculates the flow rate of water per unit membrane area, which is essential for designing efficient membrane systems and selecting appropriate operating conditions.
        </p>
    </div>

<div class="note-card">
    <h3>⚙️ Parameters</h3>
    <ul class="note-list">
        <li><strong>W<sub>p</sub>:</strong> Water permeability coefficient (kmol/(m²·s·Pa)).</li>
        <li><strong>P<sub>in</sub>:</strong> Inlet pressure (Pa).</li>
        <li><strong>P<sub>out</sub>:</strong> Outlet pressure (Pa).</li>
        <li><strong>π<sub>in</sub>:</strong> Osmotic pressure at inlet (Pa).</li>
        <li><strong>π<sub>out</sub>:</strong> Osmotic pressure at outlet (Pa).</li>
        <li><strong>J<sub>w</sub>:</strong> Calculated water flux (kmol/(m²·s)).</li>
    </ul>
</div>

<div class="note-card">
    <h3>✅ Input Validations</h3>
    <ul class="note-list">
        <li><strong>W<sub>p</sub>:</strong> Must be > 0 and ≤ 1×10⁻⁴ (check units if too high).</li>
        <li><strong>P<sub>in</sub>:</strong> Must be > 0 and > P<sub>out</sub>. Typically ≤ 1×10⁷ Pa.</li>
        <li><strong>P<sub>out</sub>:</strong> Must be ≥ 0 and less than P<sub>in</sub>.</li>
        <li><strong>π<sub>in</sub>, π<sub>out</sub>:</strong> Must be ≥ 0. Typical ≤ 3×10⁶ Pa for seawater.</li>
        <li><strong>Net Driving Pressure:</strong> (P<sub>in</sub> - P<sub>out</sub>) must be greater than (π<sub>in</sub> - π<sub>out</sub>) → otherwise no flux.</li>
    </ul>
</div>

<div class="note-card">
    <h3>🔎 Output Validations</h3>
    <ul class="note-list">
        <li><strong>J<sub>w</sub> ≥ 0:</strong> Flux cannot be negative.</li>
        <li><strong>J<sub>w</sub> > 0.01:</strong> ⚠️ High water flux detected:This value is unusually high and may indicate membrane damage, incorrect operating conditions, or measurement errors. Verify all input values and check membrane integrity.</li>
        <li><strong>0.001 ≤ J<sub>w</sub> ≤ 0.01:</strong> ✅ Optimal water flux: The calculated flux falls within the typical range for efficient membrane operation. This suggests good membrane performance and appropriate operating conditions.</li>
        <li><strong>0.0001 ≤ J<sub>w</sub> < 0.001:</strong> 🔹 Moderate water flux:The flux is lower than optimal, which may indicate early stages of membrane fouling, scaling, or suboptimal operating conditions. Consider monitoring and maintenance.</li>
        <li><strong>J<sub>w</sub> < 0.0001:</strong> ❌Low water flux:This value is significantly lower than expected for normal operation. Possible causes include severe membrane fouling, incorrect pressure settings, or membrane compaction. Immediate inspection and maintenance are recommended.</li>
        <li><strong>Result must be finite:</strong> No NaN or Infinity (δP ≠ δπ, W<sub>p</sub> ≠ 0).</li>
    </ul>
</div>

<div class="note-card">
    <h3>📏 Standards & Compliance</h3>
    <ul class="note-list">
        <li>Based on <strong>solution–diffusion model</strong> for membrane transport.</li>
        <li>Aligned with <strong>ASTM D4516</strong> for reverse osmosis testing.</li>
        <li>Referenced in <strong>ISO 20760</strong> (water reuse via RO) and <strong>WHO guidelines</strong> for safe water treatment.</li>
        <li>Results are approximate → verify with lab/field testing.</li>
    </ul>
</div>

<div class="note-card">
    <h3>📌 Conclusion</h3>
    <p>
        The <strong>Water Flux Through Membrane Calculator</strong> estimates water transport 
        across membranes using permeability and pressure differences. 
        By validating inputs and classifying results (optimal, moderate, low, or high), 
        it helps <strong>engineers and operators</strong> ensure proper system design, detect 
        fouling or damage, and optimize safe and efficient membrane performance.
    </p>
</div>

</div>

<script>
    function calculateWaterFlux() {
        // Get input values
        const W_p = parseFloat(document.getElementById("permeability").value);
        const P_in = parseFloat(document.getElementById("pressureIn").value);
        const P_out = parseFloat(document.getElementById("pressureOut").value);
        const pi_in = parseFloat(document.getElementById("osmoticIn").value);
        const pi_out = parseFloat(document.getElementById("osmoticOut").value);
        
        // Get result elements
        const placeholder = document.getElementById("placeholder");
        const resultError = document.getElementById("resultError");
        const resultValue = document.getElementById("resultValue");
        const waterFluxElement = document.getElementById("waterFlux");
        const feedbackContent = document.getElementById("feedbackContent");
        const errorMessage = document.getElementById("errorMessage");
        
        // Reset display
        placeholder.classList.add("hidden");
        resultError.classList.add("hidden");
        resultValue.classList.add("hidden");
        
        // Validate inputs
        let errorMessages = [];
        
        // Check if all fields are filled
        if (isNaN(W_p) || isNaN(P_in) || isNaN(P_out) || isNaN(pi_in) || isNaN(pi_out)) {
            errorMessages.push("All fields must contain valid numbers.");
        }
        
        // Check for positive values where required
        if (W_p <= 0) {
            errorMessages.push("Water permeability coefficient must be greater than zero.");
        }
        
        if (P_in <= 0) {
            errorMessages.push("Inlet pressure must be greater than zero.");
        }
        
        if (P_out < 0) {
            errorMessages.push("Outlet pressure cannot be negative.");
        }
        
        if (pi_in < 0) {
            errorMessages.push("Inlet osmotic pressure cannot be negative.");
        }
        
        if (pi_out < 0) {
            errorMessages.push("Outlet osmotic pressure cannot be negative.");
        }
        
        // Check pressure relationships
        if (P_in <= P_out) {
            errorMessages.push("Inlet pressure must be greater than outlet pressure.");
        }
        
        // Check for realistic values
        if (W_p > 1e-4) {
            errorMessages.push("Water permeability coefficient appears too high. Please check units (expected kmol/(m²·s·Pa)).");
        }
        
        if (P_in > 1e7) {
            errorMessages.push("Inlet pressure appears too high. Please check units (expected Pa).");
        }
        
        // If there are validation errors, show them
        if (errorMessages.length > 0) {
            errorMessage.innerHTML = "<strong>Validation Error:</strong><br>" + errorMessages.join("<br>");
            resultError.classList.remove("hidden");
            return;
        }
        
        // Calculate pressure differentials
        const deltaP = P_in - P_out;
        const deltaPi = pi_in - pi_out;
        
        // Check if net driving pressure is positive
        if (deltaP <= deltaPi) {
            errorMessages.push("Net driving pressure (ΔP - Δπ) must be positive for water flux. Current value: " + (deltaP - deltaPi).toExponential(2) + " Pa");
            errorMessage.innerHTML = "<strong>Calculation Error:</strong><br>" + errorMessages.join("<br>");
            resultError.classList.remove("hidden");
            return;
        }
        
        // Calculate Water Flux (J_w)
        const J_w = W_p * (deltaP - deltaPi);
        
        // Display result with appropriate formatting
        if (J_w < 1e-6) {
            waterFluxElement.textContent = J_w.toExponential(4);
        } else {
            waterFluxElement.textContent = J_w.toFixed(6);
        }
        
        // Provide feedback based on result
        let feedbackText = "";
        let feedbackClass = "";
        
        if (J_w > 0.01) {
            feedbackText = "⚠️ <strong>High water flux detected:</strong> This value is unusually high and may indicate membrane damage, incorrect operating conditions, or measurement errors. Verify all input values and check membrane integrity.";
        } else if (J_w > 0.001) {
            feedbackText = "✅ <strong>Optimal water flux:</strong> The calculated flux falls within the typical range for efficient membrane operation. This suggests good membrane performance and appropriate operating conditions.";
        } else if (J_w > 0.0001) {
            feedbackText = "🔹 <strong>Moderate water flux:</strong> The flux is lower than optimal, which may indicate early stages of membrane fouling, scaling, or suboptimal operating conditions. Consider monitoring and maintenance.";
        } else {
            feedbackText = "❌ <strong>Low water flux:</strong> This value is significantly lower than expected for normal operation. Possible causes include severe membrane fouling, incorrect pressure settings, or membrane compaction. Immediate inspection and maintenance are recommended.";
        }
        
        feedbackContent.innerHTML = feedbackText;
        resultValue.classList.remove("hidden");
    }
    
    function printReport() {
        window.print();
    }
</script>
  <script src="{% static 'js/print.js' %}"></script>

</body>
</html>
{% endblock %}
<!--
============================================================
Comprehensive Validation Rules
Based on industry standards for membrane processes:

Parameter	Validation Rules	Typical Range	Units
Water Permeability Coefficient (W<sub>p</sub>)	> 0, ≤ 1×10⁻⁴	1×10⁻¹⁰ to 1×10⁻⁶	kmol/(m²·s·Pa)
Pressure at Inlet (P<sub>in</sub>)	> P<sub>out</sub>, ≤ 8×10⁶	1×10⁵ to 8×10⁶	Pa
Pressure at Outlet (P<sub>out</sub>)	≥ 0, < P<sub>in</sub>	0 to 7.9×10⁶	Pa
Osmotic Pressure at Inlet (π<sub>in</sub>)	≥ 0, ≤ 3×10⁶	0 to 3×10⁶	Pa
Osmotic Pressure at Outlet (π<sub>out</sub>)	≥ 0, ≤ π<sub>in</sub>	0 to 3×10⁶	Pa
Cross-field dependencies:

(P<sub>in</sub> - P<sub>out</sub>) must be > (π<sub>in</sub> - π<sub>out</sub>)

π<sub>out</sub> should not exceed π<sub>in</sub> in normal operation

=============Edge Case Validations=====================
Negative values for any parameter (except osmotic pressure differences)

P<sub>out</sub> > P<sub>in</sub> (reverse pressure scenario)

π<sub>out</sub> > π<sub>in</sub> (unrealistic osmotic relationship)

Net driving pressure ≤ 0 (no flux condition)

Extremely high values suggesting unit conversion errors

Zero permeability coefficient (membrane completely impermeable)

==========Meaningful Outputs for Audits and Safety Reports=============
The calculator should provide:

Clear water flux value with proper units

Classification of flux rate (optimal, moderate, low, critical)

Warning if values approach operational limits

Indication of potential membrane issues

Suggestion for corrective actions if needed
===================================================
FORMULA:
 <p>The water flux (J<sub>w</sub>) is calculated using the following equation:</p>
        <p><code>J<sub>w</sub> = W<sub>p</sub> × [(P<sub>in</sub> - P<sub>out</sub>) - (π<sub>in</sub> - π<sub>out</sub>)]</code></p>
        


-->