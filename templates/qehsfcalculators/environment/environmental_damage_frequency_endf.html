{% extends 'base.html' %}
{% block title %}Environmental Damage Frequency (ENDF) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environmental Damage Frequency (ENDF) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background: linear-gradient(#1560bd, #000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            height: 420px;
            overflow-y: auto;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center;
            flex-wrap: wrap;
        }

        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        .rate-label { 
            color: #7f8c8d;
            font-size: 20px;
            font-weight: bold;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .rate-value {
                font-size: 38px;
            }
            .rate-label {
                font-size: 18px;
            }
        }
        
        @media (max-width: 992px) {
            .rate-value {
                font-size: 34px;
            }
            .rate-label {
                font-size: 17px;
            }
        }
        
        @media (max-width: 768px) {
            .rate-value {
                font-size: 30px;
                margin-bottom: 8px;
            }
            .rate-label {
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .rate-value {
                font-size: 28px;
                margin-bottom: 6px;
            }
            .rate-label {
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .rate-display {
                flex-direction: column;
                gap: 2px;
                text-align: center;
            }
            .rate-value {
                font-size: 24px;
                margin-bottom: 4px;
            }
            .rate-label {
                font-size: 14px;
            }
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>

<div class="btn-container">
        <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
</div>

<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}

<div class="calculator-header">
  <h1>Environmental Damage Frequency (ENDF) Calculator</h1>
  <p>
    Assess environmental performance by calculating incident frequency per one million work hours. 
    Useful for audits, KPI dashboards, and management reviews.
  </p>
</div>

<div class="calc-content">
  <!-- Calculator -->
  <div class="calc-card">
    <h2>Enter Data</h2>

    <div class="form-group">
      <label for="envIncidents">Total Environmental Incidents (count)</label>
      <input type="number" id="envIncidents" class="form-input" min="0" step="1" placeholder="e.g., 3">
    </div>

    <div class="form-group">
      <label for="totalHoursWorked">Total Work Hours (hours)</label>
      <input type="number" id="totalHoursWorked" class="form-input" min="1" step="0.01" placeholder="e.g., 250000">
    </div>

    <button class="calculate-btn" onclick="calculateENDF()">Calculate ENDF</button>
  </div>

  <!-- Result Section -->
  <div class="result-card">
    <div class="result-placeholder" id="placeholder">
      <img src="/static/images/mlc_environment_result.png" alt="ENDF illustration">
      <p>This tool calculates <strong>Environmental Damage Frequency (ENDF)</strong> per one million work hours.</p>
    </div>

    <div class="result-error hidden" id="resultError">
      <div class="error-icon">‚ùå</div>
      <div class="error-message" id="errorMessage"></div>
    </div>

    <div class="result-value hidden" id="resultValue">
      <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd; margin-top:40px;">
        <h2>Calculated ENDF</h2>
      </div>

      <div class="rate-display">
        <div class="rate-value" id="rateValue">0.00</div>
        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">incidents / million hours</div>
      </div>

      <div class="result-feedback">
        <div class="feedback-title">Assessment</div>
        <div class="feedback-content" id="feedbackContent"></div>
      </div>
      <div class="btn-wrapper">
        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
      </div>
    </div>
  </div>
</div>

<!-- Notes Section -->
<div class="note-section">

  <!-- About -->
  <div class="note-card">
    <h3>üìò About This Calculator</h3>
    <p>
      <strong>ENDF</strong> expresses how often environmental incidents occur, normalized per one million work hours. 
      This calculator helps organizations assess environmental performance, supports trend analysis, benchmarking, audits, KPI dashboards, and regulatory/ESG reporting. 
      Operators and managers can use it to monitor environmental risk and take proactive measures.
    </p>
  </div>

  <!-- Parameters -->
  <div class="note-card">
    <h3>‚öô Parameters Used</h3>
    <ul>
      <li><strong>Total Environmental Incidents:</strong> The count of incidents in the reporting period (spills, emissions, waste violations, etc.).</li>
      <li><strong>Total Work Hours:</strong> The total number of hours worked during the same period.</li>
      <li><strong>Normalization Base:</strong> Standardized to 1,000,000 work hours for comparability.</li>
    </ul>
  </div>

  <!-- Input Validations -->
  <div class="note-card">
    <h3>‚úÖ Input Validation Rules</h3>
    <ul>
      <li>‚úîÔ∏è Incidents: required, whole number, 0‚Äì100,000 (typical 0‚Äì1,000).</li>
      <li>‚úîÔ∏è Work Hours: required, >0, ‚â§1,000,000,000 (typical 10,000‚Äì10,000,000).</li>
      <li>‚úîÔ∏è ENDF is normalized per <strong>1,000,000 hours</strong>.</li>
      <li>‚ùå Decimals in incidents are not allowed.</li>
      <li>‚ùå Zero or negative hours are invalid (prevents divide-by-zero).</li>
      <li>‚ö†Ô∏è Very small hours (&lt;10,000) ‚Üí statistical instability warning.</li>
      <li>‚ö†Ô∏è Extremely high ENDF (&gt;10) ‚Üí verify reporting accuracy.</li>
    </ul>
  </div>

  <!-- Output Validations & Assessment -->
  <div class="note-card">
    <h3>üîé Output Validation & Assessment</h3>
    <ul>
      <li>ENDF is displayed as incidents per 1,000,000 hours (0‚Äì‚àû).</li>
      <li>Status feedback is displayed with the result for clarity:</li>
      <ul>
        <li>ENDF = 0 ‚Üí ‚úÖ Perfect: No reportable incidents in the period.</li>
        <li>0 &lt; ENDF &lt; 0.5 ‚Üí ‚úÖ Excellent performance.</li>
        <li>0.5 ‚â§ ENDF ‚â§ 1.5 ‚Üí üü¢ Good performance ‚Äì maintain controls.</li>
        <li>1.5 &lt; ENDF ‚â§ 3.0 ‚Üí üü° Needs improvement ‚Äì review controls/training.</li>
        <li>ENDF &gt; 3.0 ‚Üí üî¥ High risk ‚Äì investigate and implement corrective actions.</li>
      </ul>
      <li>Warnings are appended for small hours, unusually high incident counts, or very high ENDF (>10).</li>
      <li>Input values (incidents, work hours, normalization base) are displayed alongside ENDF.</li>
    </ul>
  </div>

  <!-- Governing Principle -->
  <div class="note-card">
    <h3>üìê Governing Principle</h3>
    <p>
      An "Environmental Damage Frequency (ENDF) Calculator" is not a recognized specific tool but rather a concept related to environmental risk assessment. 
      The calculation of such frequency is typically based on principles outlined in international and national standards for risk assessment and environmental management, such as ISO 14040 series for Life Cycle Assessment (LCA) and frameworks like the Polluter Pays Principle.
      <br><br>
      <strong>ISO 14040 Series (Life Cycle Assessment):</strong> Provides a framework for quantitatively assessing environmental aspects and impacts of products, processes, or services throughout their life cycle. While not directly a frequency calculator, methods in these standards can inform damage frequency estimation.
      <br><br>
      <strong>Polluter Pays Principle:</strong> States that those responsible for pollution bear the cost of mitigation. Guidelines and regulations under this principle inform assessment of potential environmental damages.
      <br><br>
      <strong>Risk-Based Inspection (RBI) Standards:</strong> Standards like API 581 provide methodologies for calculating generic failure frequencies and damage factors over time, helping quantify likelihood of environmental incidents.
      <br><br>
      <strong>National Guidelines:</strong> For example, CPCB guidelines on Environmental Damage Compensation (EDC) and air/water quality assessments provide a framework for calculating and understanding potential environmental damage and its frequency.
      <br><br>
      <strong>Engineering Principle:</strong> ENDF quantifies incident occurrence per standardized work hours, helping organizations proactively monitor risk, take preventive actions, and comply with environmental regulations.
    </p>
  </div>

  <!-- Conclusion -->
  <div class="note-card">
    <h3>‚úÖ Conclusion</h3>
    <p>
      This calculator provides actionable insights into environmental performance by computing ENDF. 
      By following input and output validations and considering the feedback assessment displayed with the result, organizations can ensure accurate reporting, identify areas for improvement, and maintain compliance with environmental standards and corporate ESG objectives.
    </p>
  </div>

</div>

<script>
/* Reusable error display */
function showErrors(errors) {
  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");

  errorMessage.innerHTML = errors.join("<br>");
  errorBox.classList.remove("hidden");
  placeholder.classList.add("hidden");
  resultValue.classList.add("hidden");
}

/* ENDF calculation with robust validations */
function calculateENDF() {
  const incidentsRaw = (document.getElementById("envIncidents").value || "").trim();
  const hoursRaw = (document.getElementById("totalHoursWorked").value || "").trim();

  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");
  const rateEl = document.getElementById("rateValue");
  const feedbackEl = document.getElementById("feedbackContent");

  // reset UI
  errorBox.classList.add("hidden");
  errorMessage.innerHTML = "";
  feedbackEl.innerHTML = "";

  const errors = [];
  const warnings = [];

  // presence
  if (!incidentsRaw) errors.push("üëâ Please enter Total Environmental Incidents (whole number).");
  if (!hoursRaw) errors.push("üëâ Please enter Total Work Hours.");
  if (errors.length) return showErrors(errors);

  // parse
  const incidents = Number(incidentsRaw);
  const hours = Number(hoursRaw);

  // numeric checks
  if (!Number.isFinite(incidents)) errors.push("üëâ Incidents must be a valid number.");
  if (!Number.isFinite(hours)) errors.push("üëâ Work hours must be a valid number.");
  if (errors.length) return showErrors(errors);

  // integer-only for incidents
  if (!Number.isInteger(incidents))
    errors.push("üëâ Incidents must be a whole number (no decimals).");

  // range checks (hard)
  if (incidents < 0 || incidents > 100000)
    errors.push("üëâ Incidents must be between 0 and 100,000.");
  if (hours <= 0 || hours > 1000000000)
    errors.push("üëâ Work hours must be > 0 and ‚â§ 1,000,000,000.");

  if (errors.length) return showErrors(errors);

  // advisories / best-practice warnings
  if (hours < 10000)
    warnings.push("‚ö†Ô∏è Very small hours ‚Äì ENDF may be statistically unstable.");
  if (incidents > 1000)
    warnings.push("‚ö†Ô∏è Unusually high incident count ‚Äì verify classification and duplicates.");
  if (incidents === 0 && hours < 20000)
    warnings.push("‚ö†Ô∏è Zero incidents with very small hours ‚Äì confirm observation period and reporting scope.");

  // compute ENDF (incidents per 1,000,000 hours)
  const NORMALIZER = 1000000;
  const endf = (incidents * NORMALIZER) / hours;

  if (!Number.isFinite(endf) || endf < 0) {
    return showErrors(["‚ö†Ô∏è Computed ENDF is invalid. Check inputs."]);
  }

  // classification
  let statusMsg = "";
  if (endf === 0) {
    statusMsg = "‚úÖ Perfect: No reportable incidents in the period.";
  } else if (endf < 0.5) {
    statusMsg = "‚úÖ Excellent performance.";
  } else if (endf <= 1.5) {
    statusMsg = "üü¢ Good performance ‚Äì maintain controls.";
  } else if (endf <= 3.0) {
    statusMsg = "üü° Needs improvement ‚Äì review controls and training.";
  } else {
    statusMsg = "üî¥ High risk ‚Äì investigate and implement corrective actions.";
  }

  if (endf > 10) warnings.push("‚ö†Ô∏è Extremely high ENDF ‚Äì immediate management review recommended.");

  // details (formatted numbers)
  const fmt = (n, d=0) => Number(n).toLocaleString(undefined, {maximumFractionDigits: d});
  const fmtFixed = (n, d=2) => Number(n).toLocaleString(undefined, {minimumFractionDigits: d, maximumFractionDigits: d});

  let details = `<div>ENDF: <b>${fmtFixed(endf, 2)}</b> incidents per million hours</div>`;

  if (warnings.length) {
    details += `<div style="margin-top:6px; color:#b35d00; font-size:0.95em;">${warnings.join(" | ")}</div>`;
  }

  // update UI
  rateEl.textContent = fmtFixed(endf, 2);
  document.querySelector(".rate-label").textContent = "incidents / million hours";
  feedbackEl.innerHTML = `<div>${statusMsg}</div>${details}`;

  placeholder.classList.add("hidden");
  resultValue.classList.remove("hidden");
  errorBox.classList.add("hidden");
}

function printReport() {
  const el = document.getElementById('printDate');
  if (el) {
    const now = new Date();
    el.textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  }
  window.print();
}
</script>

    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


<!-- /*
==========================================================
üìå Environmental Nonconformance Frequency (ENDF) Calculator
==========================================================

üîπ Formula:
    ENDF = (Total Environmental Incidents √ó 1,000,000) / Total Work Hours

    - Units: incidents per 1,000,000 hours

----------------------------------------------------------
üîπ Input Validations:

1. Total Environmental Incidents (required):
   - Must be provided
   - Must be an integer (whole number, no decimals)
   - Range: 0 ‚â§ incidents ‚â§ 100,000

2. Total Work Hours (required):
   - Must be provided
   - Must be numeric
   - Range: 0 < hours ‚â§ 1,000,000,000

----------------------------------------------------------
üîπ Cross-field / Advisories:
- If hours < 10,000 ‚Üí warn: "Very small hours ‚Äì ENDF may be statistically unstable."
- If incidents > 1,000 ‚Üí warn: "Unusually high incident count ‚Äì verify classification."
- If incidents = 0 AND hours < 20,000 ‚Üí warn: "Zero incidents with very small hours ‚Äì confirm reporting scope."

----------------------------------------------------------
üîπ Output Validations:
- Computed ENDF must be finite and ‚â• 0
- If invalid ‚Üí throw error

----------------------------------------------------------
üîπ Classification by ENDF:
- ENDF = 0       ‚Üí ‚úÖ Perfect: No reportable incidents
- ENDF < 0.5     ‚Üí ‚úÖ Excellent performance
- ENDF ‚â§ 1.5     ‚Üí üü¢ Good performance ‚Äì maintain controls
- ENDF ‚â§ 3.0     ‚Üí üü° Needs improvement ‚Äì review controls/training
- ENDF > 3.0     ‚Üí üî¥ High risk ‚Äì investigate and act
- ENDF > 10.0    ‚Üí ‚ö†Ô∏è Extremely high ‚Äì immediate management review

----------------------------------------------------------
üîπ Output Details:
- ENDF (to 2 decimals)
- Total Incidents (formatted integer)
- Total Work Hours (formatted integer)
- Normalization Base = 1,000,000 hours
- Warnings appended if applicable

==========================================================
*/ -->
