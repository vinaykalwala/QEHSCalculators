{% extends 'base.html' %}
{% block title %}Chick’s Law: Microbial Disinfection Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chick’s Law: Microbial Disinfection Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background: linear-gradient(#1560bd, #000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 480px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center;
            flex-wrap: wrap;
        }

        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        .rate-label { 
            color: #7f8c8d;
            font-size: 20px;
            font-weight: bold;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .rate-value {
                font-size: 38px;
            }
            .rate-label {
                font-size: 18px;
            }
        }
        
        @media (max-width: 992px) {
            .rate-value {
                font-size: 34px;
            }
            .rate-label {
                font-size: 17px;
            }
        }
        
        @media (max-width: 768px) {
            .rate-value {
                font-size: 30px;
                margin-bottom: 8px;
            }
            .rate-label {
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .rate-value {
                font-size: 28px;
                margin-bottom: 6px;
            }
            .rate-label {
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .rate-display {
                flex-direction: column;
                gap: 2px;
                text-align: center;
            }
            .rate-value {
                font-size: 24px;
                margin-bottom: 4px;
            }
            .rate-label {
                font-size: 14px;
            }
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>

    <div class="btn-container">
        <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
    </div>


<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}


<!-- Chick's Law: Microbial Disinfection Calculator (single-file snippet) -->
<div class="calculator-header">
  <h1>Chick’s Law: Microbial Disinfection Calculator</h1>
  <p>Estimate remaining microorganisms after disinfection. Inputs are counts and rate/time values (units for k and t must match).</p>
</div>

<div class="calc-content">
  <div class="calc-card">
    <h2>Enter Parameters</h2>

    <div class="form-group">
      <label for="N0">Initial Microorganisms (N₀)</label>
      <input type="number" id="N0" class="form-input" min="1" step="any" placeholder="e.g., 1e6">
    </div>

    <div class="form-group">
      <label for="k">Disinfection Constant (k) — per unit time</label>
      <input type="number" id="k" class="form-input" min="0" step="any" placeholder="e.g., 0.23">
    </div>

    <div class="form-group">
      <label for="t">Contact Time (t) — same time unit as k</label>
      <input type="number" id="t" class="form-input" min="0" step="any" placeholder="e.g., 10">
    </div>

    <button class="calculate-btn" onclick="calculateDisinfection()">Calculate</button>
  </div>

  <div class="result-card">
    <div class="result-placeholder" id="placeholder">
      <img src="/static/images/mlc_environment_result.png" alt="Disinfection illustration">
      <p>This tool estimates remaining microorganisms after a disinfection step.</p>
    </div>

    <div class="result-error hidden" id="resultError" role="alert" aria-live="polite">
      <div class="error-icon">❌</div>
      <div class="error-message" id="errorMessage"></div>
    </div>

    <div class="result-value hidden" id="resultValue" aria-live="polite">
      <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
        <h2>Disinfection Result</h2>
      </div>

      <div class="rate-display" style="gap:12px; align-items:center; justify-content:center;">
        <div class="rate-value" id="remainingN">0</div>
        <div class="rate-label" style="font-size:16px; color: #2980b9;">organisms</div>
      </div>

      <div class="result-feedback">
        <div class="feedback-title">Assessment</div>
        <div class="feedback-content" id="feedbackContent"></div>
      </div>

      <div class="btn-wrapper">
        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
      </div>
    </div>
  </div>
</div>

<div class="note-section">
  <!-- About -->
  <div class="note-card">
    <h3>📘 About This Calculator</h3>
    <p>
      Predicts the remaining number of viable microorganisms after a single disinfection step.
      Use results as part of risk assessments and compliance checks.
    </p>
  </div>

  <!-- Parameters -->
  <div class="note-card">
    <h3>⚙ Parameters Used</h3>
    <ul class="note-list">
      <li><strong>N₀</strong>: Initial microorganism count (organisms)</li>
      <li><strong>k</strong>: Disinfection rate constant (per unit time) — user must ensure time unit consistency</li>
      <li><strong>t</strong>: Contact time (same unit as k)</li>
    </ul>
  </div>

    <!-- Input Validations -->
  <div class="note-card">
    <h3>✅ Input Validation Rules</h3>
    <ul class="note-list">
      <li><strong>Initial Microorganisms (N₀):</strong> Required, numeric, ≥ 1 and ≤ 1000000000000. Fractional inputs will be rounded with a warning.</li>
      <li><strong>Disinfection Constant (k):</strong> Required, numeric, > 0. Recommended range: 0.00000001 to 100 (per time unit). Precision ≤ 6 decimals.</li>
      <li><strong>Contact Time (t):</strong> Required, numeric, ≥ 0. Reasonable upper bound: 10000000 (user unit dependent).</li>
      <li><strong>Units:</strong> Time units for k and t must match.</li>
      <li><strong>Cross-checks:</strong> If k·t is extremely small → negligible inactivation. If very large → result effectively zero.</li>
    </ul>
  </div>

  <!-- Output Validations & Assessment -->
  <div class="note-card">
    <h3>🔎 Output Validations & Assessment</h3>
    <ul class="note-list">
      <li><strong>Remaining microorganisms (N)</strong> are reported in organisms, rounded unless very small, then displayed as a decimal number with up to 12 places.</li>
      <li>Metrics reported include <strong>Remaining microorganisms</strong>, <strong>Percent reduction</strong>, and <strong>Log reduction</strong>.</li>
      <li>Feedback/assessment is displayed along with the result to guide operational decisions.</li>
      <li>Classification levels:</li>
      <ul>
        <li><strong>Highly Effective (≥6-log):</strong> Excellent inactivation — acceptable for critical disinfection tasks.</li>
        <li><strong>Effective (3–6 log):</strong> Strong inactivation; confirm with process control data.</li>
        <li><strong>Moderately Effective (1–3 log):</strong> Partial inactivation; consider increasing contact time or dose.</li>
        <li><strong>Ineffective (&lt;1 log):</strong> Insufficient — review disinfectant, dosage, and time.</li>
      </ul>
      <li>Warnings for extreme values or unit mismatches are displayed inline.</li>
    </ul>
  </div>

  <!-- Governing Principle -->
  <div class="note-card">
    <h3>📜 Governing Principle</h3>
   <p>Chick's Law and the associated microbial inactivation models, like the Chick-Watson model, are not tied to a single 
    "standard" but are foundational principles of environmental engineering and disinfection kinetics, adopted and adapted by 
    regulatory bodies such as the U.S. Environmental Protection Agency (USEPA) for practical applications like the Safe Drinking 
    Water Act's treatment technique guidance, which uses CT values. These models help quantify the rate at which microorganisms 
    are inactivated under varying disinfectant concentrations and contact times. They are widely used in designing water and 
    wastewater treatment systems, optimizing disinfection processes, and ensuring public health protection. Additionally, 
    they serve as key educational tools for 
    understanding microbial kinetics and for validating treatment performance in both research and operational settings.
</p>

  </div>

  <!-- Conclusion -->
  <div class="note-card">
    <h3>🔚 Conclusion</h3>
    <p>
      Use the results together with process validation data, operational monitoring, and sample testing.
      This tool provides screening-level estimates to guide QEHS decisions.
    </p>
  </div>
</div>

<script>
/* Helper to count decimals (string input) */
function countDecimalsFromStr(s) {
  if (!s || s.indexOf('.') === -1) return 0;
  const part = s.split('.')[1] || '';
  return part.length;
}

/* Show errors in UI */
function showErrors(errors) {
  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");

  errorMessage.innerHTML = errors.join("<br>");
  errorBox.classList.remove("hidden");
  placeholder.classList.add("hidden");
  resultValue.classList.add("hidden");
}

/* Main calculation with validations */
function calculateDisinfection() {
  const N0Raw = document.getElementById("N0")?.value.trim();
  const kRaw  = document.getElementById("k")?.value.trim();
  const tRaw  = document.getElementById("t")?.value.trim();

  const errors = [];
  const warnings = [];

  // Basic presence
  if (N0Raw === '') errors.push("👉 Enter Initial Microorganisms (N₀).");
  if (kRaw === '')  errors.push("👉 Enter Disinfection constant (k).");
  if (tRaw === '')  errors.push("👉 Enter Contact time (t).");
  if (errors.length) return showErrors(errors);

  // Parse values
  const N0f = parseFloat(N0Raw);
  const kf  = parseFloat(kRaw);
  const tf  = parseFloat(tRaw);

  // Numeric checks
  if (!Number.isFinite(N0f) || N0f < 1) errors.push("👉 N₀ must be a number ≥ 1 (organisms).");
  if (!Number.isFinite(kf)  || kf <= 0)  errors.push("👉 k must be numeric and > 0 (per unit time).");
  if (!Number.isFinite(tf)  || tf < 0)  errors.push("👉 t must be numeric and ≥ 0 (time unit matches k).");

  if (errors.length) return showErrors(errors);

  // Ranges & precision
  if (N0f > 1e12) warnings.push("⚠️ N₀ is very large (>1×10¹²). Verify units/source.");
  if (countDecimalsFromStr(N0Raw) > 0) warnings.push("⚠️ N₀ will be rounded to nearest whole organism.");
  if (countDecimalsFromStr(kRaw) > 6) warnings.push("⚠️ k has >6 decimal places — round for practical reporting.");
  if (kf < 1e-8) warnings.push("⚠️ k is very small — check units (k may be per second vs per minute mismatch).");
  if (kf > 100) warnings.push("⚠️ k is unusually large (>100). Verify units/time.");
  if (tf > 1e7) warnings.push("⚠️ t is very large (>1×10⁷). Verify units.");

  // Round initial organism to integer (counts)
  const N0 = Math.round(N0f);

  // Logical checks
  if (!(kf > 0)) return showErrors(["👉 k must be greater than 0."]);
  if (N0 <= 0) return showErrors(["👉 N₀ must be ≥ 1 organism."]);

  // Check product k*t for practical under/over flow
  const kt = kf * tf;
  if (kt <= 1e-9) warnings.push("⚠️ k·t is very small — negligible inactivation expected.");
  if (kt > 50) warnings.push("⚠️ k·t is large — result will be effectively zero (below detection); log reduction will be reported as '≥'. (This is expected for very strong disinfection.)");

  // Compute remaining organisms (do not display formula anywhere)
  const remainingRaw = N0 * Math.exp(-kf * tf); // internal computation
  // If underflow to 0, JS will return 0
  const threshold = 1e-12; // threshold below which we'll treat as 0 for reporting
  let remaining = remainingRaw;
  if (!Number.isFinite(remaining) || remaining < 0) {
    return showErrors(["⚠️ Computed remaining organisms invalid. Check inputs."]);
  }

  // Prepare display values
  const remainingDisplay = (remaining === 0 || remaining < threshold) ? remaining : Math.round(remaining);
  const reductionRatio = (N0 === 0) ? NaN : (1 - (remaining / N0));
  const percentReduction = Number.isFinite(reductionRatio) ? (reductionRatio * 100) : NaN;

  // Log-reduction handling
  let logReductionDisplay = "";
  if (remaining === 0 || remaining < threshold) {
    // report as "≥ X-log" where X is approximated by -log10(threshold / N0)
    const approx = -Math.log10(threshold / N0);
    logReductionDisplay = `≥ ${approx.toFixed(2)} (approx)`;
  } else {
    const logR = -Math.log10(remaining / N0);
    logReductionDisplay = `${logR.toFixed(2)} log₁₀`;
  }

  // Classification (audit-friendly)
  let classification = "";
  let recommendation = "";
  // derive numeric log reduction for thresholds (if computable)
  let numericLog = null;
  if (!(remaining === 0 || remaining < threshold)) numericLog = -Math.log10(remaining / N0);

  if (numericLog !== null && numericLog >= 6) {
    classification = "Highly Effective (≥6-log)";
    recommendation = "Excellent inactivation — acceptable for critical disinfection tasks.";
  } else if (numericLog !== null && numericLog >= 3) {
    classification = "Effective (3–6 log)";
    recommendation = "Strong inactivation; confirm with process control data.";
  } else if (numericLog !== null && numericLog >= 1) {
    classification = "Moderately Effective (1–3 log)";
    recommendation = "Partial inactivation; consider increasing contact time or dose.";
  } else if (numericLog !== null) {
    classification = "Ineffective (<1 log)";
    recommendation = "Insufficient inactivation — review disinfectant, dosage and contact time.";
  } else {
    // when remaining effectively 0, use 'Highly Effective'
    classification = "Highly Effective";
    recommendation = "Remaining organisms below detection threshold; report as 'no detectable organisms'.";
  }

  // Build details for feedback
  let details = `<div><strong>Remaining microorganisms (N):</strong> ${ (remaining === 0 || remaining < threshold) ? remaining.toExponential(3) : remainingDisplay.toLocaleString() } organisms</div>`;
  details += `<div><strong>Percent reduction:</strong> ${ Number.isFinite(percentReduction) ? percentReduction.toFixed(3) + '%' : 'N/A' }</div>`;
  details += `<div><strong>Log reduction:</strong> ${ logReductionDisplay }</div>`;
  details += `<div style="margin-top:6px;"><strong>Classification:</strong> ${ classification }</div>`;
  details += `<div style="margin-top:4px;">${ recommendation }</div>`;
  if (warnings.length) details += `<div style="margin-top:8px; color:#b35d00;">${warnings.join(' | ')}</div>`;

  // Update UI
  document.getElementById("remainingN").textContent = (remaining === 0 || remaining < threshold) ? remaining.toExponential(3) : remainingDisplay.toLocaleString();
  document.getElementById("feedbackContent").innerHTML = details;

  // Show result area
  document.getElementById("placeholder").classList.add("hidden");
  document.getElementById("resultValue").classList.remove("hidden");
  document.getElementById("resultError").classList.add("hidden");
}

/* Print helper */
function printReport() {
  const el = document.getElementById('printDate');
  if (el) {
    el.textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  }
  window.print();
}
</script>

    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


<!-- 
📌 Microbial Disinfection Calculator (Essentials)

🔹 Formula (internal, not displayed to user):
    • N = N₀ × e^(−k·t)
      - N  = Remaining microorganisms [count]
      - N₀ = Initial microorganisms [count]
      - k  = Disinfection constant [per unit time]
      - t  = Contact time [same unit as k]

    • Log reduction = −log₁₀(N / N₀)
    • Percent reduction = (1 − N / N₀) × 100%

🔹 Input Validations:
    • N₀ (Initial microorganisms):
        - Required, numeric
        - Must be ≥ 1
        - Rounded to nearest whole number
    • k (Disinfection constant):
        - Required, numeric
        - Must be > 0
    • t (Contact time):
        - Required, numeric
        - Must be ≥ 0
    • All inputs must be numeric and non-empty.

🔹 Warnings:
    • N₀ > 1×10¹² → ⚠️ Very large population — verify units/source
    • N₀ with decimals → ⚠️ Rounded to integer (organisms are counts)
    • k with >6 decimals → ⚠️ Round for reporting
    • k < 1e−8 → ⚠️ Very small constant — possible unit mismatch
    • k > 100 → ⚠️ Very large constant — check units
    • t > 1×10⁷ → ⚠️ Excessively large contact time — verify units
    • k·t very small (≤ 1e−9) → ⚠️ Negligible inactivation
    • k·t > 50 → ⚠️ Result effectively zero (below detection); log reduction reported as "≥"

🔹 Output Validations & Feedback:
    • Remaining microorganisms (N):
        - Rounded to integer if ≥ threshold
        - Reported in scientific notation if below threshold (1e−12)
    • Percent reduction (%) reported if valid
    • Log reduction:
        - If N > threshold → exact log reduction value
        - If N ≤ threshold → reported as ≥ value (approximate)
    • Classification:
        - ≥6 log → Highly Effective
        - 3–6 log → Effective
        - 1–3 log → Moderately Effective
        - <1 log → Ineffective
        - Remaining < threshold → Highly Effective (below detection limit)
    • Recommendation message provided for each classification
    • Warnings shown inline if triggered
-->
