{% extends 'base.html' %}
{% block title %}Electrostatic Precipitator Efficiency Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electrostatic Precipitator Efficiency Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background: linear-gradient(#1560bd, #000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center;
            flex-wrap: wrap;
        }

        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        .rate-label { 
            color: #7f8c8d;
            font-size: 20px;
            font-weight: bold;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .rate-value {
                font-size: 38px;
            }
            .rate-label {
                font-size: 18px;
            }
        }
        
        @media (max-width: 992px) {
            .rate-value {
                font-size: 34px;
            }
            .rate-label {
                font-size: 17px;
            }
        }
        
        @media (max-width: 768px) {
            .rate-value {
                font-size: 30px;
                margin-bottom: 8px;
            }
            .rate-label {
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .rate-value {
                font-size: 28px;
                margin-bottom: 6px;
            }
            .rate-label {
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .rate-display {
                flex-direction: column;
                gap: 2px;
                text-align: center;
            }
            .rate-value {
                font-size: 24px;
                margin-bottom: 4px;
            }
            .rate-label {
                font-size: 14px;
            }
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>

<div class="btn-container">
        <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
</div>

<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}

<div class="calculator-header">
  <h1>Electrostatic Precipitator Efficiency Calculator</h1>
  <p>
    Estimate ESP collection efficiency for particulate control using plant-scale inputs.
  </p>
</div>

<div class="calc-content">
  <!-- Calculator -->
  <div class="calc-card">
    <h2>Enter Data</h2>

    <div class="form-group">
      <label for="driftVelocity">Terminal Drift / Migration Velocity (W) <span>[m/s]</span></label>
      <input type="number" id="driftVelocity" class="form-input" min="0.001" step="0.001" placeholder="e.g., 0.15">
    </div>

    <div class="form-group">
      <label for="collectionArea">Total Collection Area (A) <span>[m²]</span></label>
      <input type="number" id="collectionArea" class="form-input" min="1" step="1" placeholder="e.g., 25000">
    </div>

    <div class="form-group">
      <label for="gasFlowRate">Volumetric Gas Flow Rate (Q) <span>[m³/s]</span></label>
      <input type="number" id="gasFlowRate" class="form-input" min="0.001" step="0.001" placeholder="e.g., 300">
    </div>

    <button class="calculate-btn" onclick="calculateESPEfficiency()">Calculate Efficiency</button>
  </div>

  <!-- Result Section -->
  <div class="result-card">
    <div class="result-placeholder" id="placeholder">
      <img src="/static/images/mlc_environment_result.png" alt="ESP illustration">
      <p>This tool calculates <strong>ESP Collection Efficiency</strong> from W, A, and Q.</p>
    </div>

    <div class="result-error hidden" id="resultError">
      <div class="error-icon">❌</div>
      <div class="error-message" id="errorMessage"></div>
    </div>

    <div class="result-value hidden" id="resultValue">
      <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
        <h2>Calculated ESP Efficiency</h2>
      </div>

      <div class="rate-display">
        <div class="rate-value" id="rateValue">0.00</div>
        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">% collection efficiency</div>
      </div>

      <div class="result-feedback">
        <div class="feedback-title">Assessment</div>
        <div class="feedback-content" id="feedbackContent"></div>
      </div>
      <div class="btn-wrapper">
        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
      </div>
    </div>
  </div>
</div>

<!-- Notes Section -->
<div class="note-section">
  <div class="note-card">
    <h3>📘 About This Calculator</h3>
    <p>
      This calculator estimates the collection efficiency of an electrostatic precipitator (ESP) using
      the Deutsch–Anderson relationship, which relates drift (migration) velocity, collection area, and gas flow.
      It helps compare design options, assess compliance risk, and monitor performance degradation (e.g., fouling, power changes).
    </p>
  </div>

  <div class="note-card">
    <h3>⚙ Parameters Used</h3>
    <ul class="note-list">
      <li><strong>W (m/s):</strong> Terminal drift/migration velocity of particles.</li>
      <li><strong>A (m²):</strong> Total collection area of the ESP plates.</li>
      <li><strong>Q (m³/s):</strong> Volumetric gas flow rate through the ESP.</li>
    </ul>
  </div>

  <div class="note-card">
    <h3>✅ Input Validation Rules</h3>
    <ul class="note-list">
      <li><strong>W (m/s):</strong> Required, > 0, allowed 0.001–5.000 (typical: 0.05–0.3). Step ≤ 0.001.</li>
      <li><strong>A (m²):</strong> Required, > 0, allowed 1–1,000,000 (typical: 100–100,000). Integer acceptable.</li>
      <li><strong>Q (m³/s):</strong> Required, > 0, allowed 0.001–10,000 (typical: 10–1,000). Step ≤ 0.001.</li>
      <li><strong>Cross-field:</strong> Compute design parameter K = (W·A)/Q (dimensionless). Reasonable design often has K ≈ 0.5–5.</li>
      <li><strong>Constraints:</strong> Zeros, negatives, or non-numeric values are invalid (prevents division by zero / non-physical results).</li>
      <li><strong>Advisories:</strong>
        <ul>
          <li>Specific Collection Area (SCA = A/Q) < 50 m²/(m³/s): likely undersized; > 300: likely oversized.</li>
          <li>W < 0.03 m/s or > 0.60 m/s: outside common operating envelope – verify dust/field conditions.</li>
          <li>K > 20: result ~100% – check inputs for overestimation; K < 0.01: near 0% capture – check sizing.</li>
        </ul>
      </li>
    </ul>
  </div>

  <div class="note-card">
    <h3>📏 Output Validations</h3>
    <ul class="note-list">
      <li><strong>ESP Efficiency (η):</strong> Displayed as percentage with 2 decimals.</li>
      <li><strong>Assessment:</strong>
        <ul>
          <li>η < 50%: Poor capture — Review sizing, power supply, rapping, and gas conditions.</li>
          <li>50% ≤ η < 90%: Moderate — Improvement recommended (optimize fields/plates and maintenance).</li>
          <li>90% ≤ η < 99%: Good — Typical for coarse dust control; verify compliance margins.</li>
          <li>η ≥ 99%: Excellent — High capture efficiency; continue monitoring and maintenance.</li>
        </ul>
      </li>
      <li>Warnings are triggered for extreme conditions: low/high SCA, unusual W, or extreme K values.</li>
    </ul>
  </div>

  <div class="note-card">
    <h3>📖 Governing Principle</h3>
    <p>
      An electrostatic precipitator (ESP) efficiency calculator is generally based on the Deutsch-Anderson equation, a standard model for predicting collection efficiency in an ESP by relating it to particle migration velocity, collecting plate area, and gas flow rate. While the core principle comes from this widely accepted equation, practical calculators may incorporate modifications and consider other factors like particle size, gas properties, and electrical conditions to provide more accurate results for various applications.
    </p>
  </div>

  <div class="note-card">
    <h3>🔚 Conclusion</h3>
    <p>
      This calculator provides reliable estimates of ESP collection efficiency using the Deutsch-Anderson equation, supporting <strong>air quality compliance</strong>, <strong>emission control</strong>, and <strong>maintenance planning</strong>. Ensure input values (W, A, Q) are accurate and validate with stack testing or CEMS data for critical applications to ensure compliance and optimal performance.
    </p>
  </div>
</div>
</div>
<script>
/* Reusable error display */
function showErrors(errors) {
  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");

  errorMessage.innerHTML = errors.join("<br>");
  errorBox.classList.remove("hidden");
  placeholder.classList.add("hidden");
  resultValue.classList.add("hidden");
}

/* ESP efficiency (Deutsch–Anderson) with robust validations */
function calculateESPEfficiency() {
  const Wraw = (document.getElementById("driftVelocity").value || "").trim();
  const Araw = (document.getElementById("collectionArea").value || "").trim();
  const Qraw = (document.getElementById("gasFlowRate").value || "").trim();

  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");
  const rateEl = document.getElementById("rateValue");
  const feedbackEl = document.getElementById("feedbackContent");

  // reset UI
  errorBox.classList.add("hidden");
  errorMessage.innerHTML = "";
  feedbackEl.innerHTML = "";

  const errors = [];
  const warnings = [];

  // presence
  if (!Wraw) errors.push("👉 Please enter Terminal Drift / Migration Velocity (W) in m/s.");
  if (!Araw) errors.push("👉 Please enter Total Collection Area (A) in m².");
  if (!Qraw) errors.push("👉 Please enter Volumetric Gas Flow Rate (Q) in m³/s.");
  if (errors.length) return showErrors(errors);

  // parse
  const W = Number(Wraw);
  const A = Number(Araw);
  const Q = Number(Qraw);

  // numeric checks
  if (!Number.isFinite(W)) errors.push("👉 W must be a valid number.");
  if (!Number.isFinite(A)) errors.push("👉 A must be a valid number.");
  if (!Number.isFinite(Q)) errors.push("👉 Q must be a valid number.");
  if (errors.length) return showErrors(errors);

  // hard ranges to prevent non-physical inputs
  if (W <= 0 || W < 0.001 || W > 5) {
    errors.push("👉 W must be > 0 and within 0.001 to 5.000 m/s (typical 0.05–0.30).");
  }
  if (A <= 0 || A < 1 || A > 1000000) {
    errors.push("👉 A must be > 0 and within 1 to 1,000,000 m².");
  }
  if (Q <= 0 || Q < 0.001 || Q > 10000) {
    errors.push("👉 Q must be > 0 and within 0.001 to 10,000 m³/s.");
  }
  if (errors.length) return showErrors(errors);

  // precision advisories (avoid false precision in reporting)
  const decimals = (s) => (String(s).split(".")[1] || "").length;
  if (decimals(Wraw) > 3) warnings.push("⚠️ W has more than 3 decimals – consider rounding for KPI reporting.");
  if (decimals(Qraw) > 3) warnings.push("⚠️ Q has more than 3 decimals – consider rounding for KPI reporting.");

  // cross-field derived checks
  const SCA = A / Q; // m² per (m³/s)
  const K = (W * A) / Q; // dimensionless exponent term magnitude

  if (W < 0.03 || W > 0.60) {
    warnings.push("⚠️ W is outside common operating envelope (0.03–0.60 m/s) – verify conditions.");
  }
  if (SCA < 50) {
    warnings.push("⚠️ Specific Collection Area (A/Q) < 50 m²/(m³/s) – likely undersized for high capture.");
  } else if (SCA > 300) {
    warnings.push("⚠️ Specific Collection Area (A/Q) > 300 m²/(m³/s) – may indicate oversizing.");
  }
  if (K < 0.01) {
    warnings.push("⚠️ Very low design parameter (W·A/Q) – efficiency will be near zero.");
  } else if (K > 20) {
    warnings.push("⚠️ Very high design parameter (W·A/Q) – efficiency will be ~100%; check inputs for overestimation.");
  }

  // compute η = 1 - exp(-(W*A)/Q)
  const exponent = -(W * A) / Q;
  const eta = 1 - Math.exp(exponent);

  if (!Number.isFinite(eta) || eta < 0 || eta > 1) {
    return showErrors(["⚠️ Computed efficiency is invalid. Check inputs."]);
  }

  // classification
  const etaPct = eta * 100;
  let statusMsg = "";
  if (etaPct < 50) {
    statusMsg = "❌ Poor capture – review sizing, power supply, rapping, and gas conditions.";
  } else if (etaPct < 90) {
    statusMsg = "🟡 Moderate – improvement recommended (optimize fields/plates and maintenance).";
  } else if (etaPct < 99) {
    statusMsg = "🟢 Good – typical for coarse dust control; verify compliance margins.";
  } else {
    statusMsg = "✅ Excellent – high capture efficiency; continue monitoring and maintenance.";
  }

  // details (formatted numbers)
  const fmt = (n, d=0) => Number(n).toLocaleString(undefined, {maximumFractionDigits: d});
  const fmtFixed = (n, d=2) => Number(n).toLocaleString(undefined, {minimumFractionDigits: d, maximumFractionDigits: d});

  let details = `<div>ESP Efficiency (η): <b>${fmtFixed(etaPct, 2)}%</b></div>`;
  details += `<div>W: <b>${fmtFixed(W, 3)}</b> m/s</div>`;
  details += `<div>A: <b>${fmt(A)}</b> m²</div>`;
  details += `<div>Q: <b>${fmtFixed(Q, 3)}</b> m³/s</div>`;
  details += `<div>Specific Collection Area (A/Q): <b>${fmtFixed(SCA, 2)}</b> m² per (m³/s)</div>`;
  details += `<div>Design Parameter (W·A/Q): <b>${fmtFixed(K, 3)}</b> (dimensionless)</div>`;

  if (warnings.length) {
    details += `<div style="margin-top:6px; color:#b35d00; font-size:0.95em;">${warnings.join(" | ")}</div>`;
  }

  // update UI
  rateEl.textContent = fmtFixed(etaPct, 2);
  document.querySelector(".rate-label").textContent = "% collection efficiency";
  feedbackEl.innerHTML = `<div>${statusMsg}</div>${details}`;

  document.getElementById("placeholder").classList.add("hidden");
  resultValue.classList.remove("hidden");
  errorBox.classList.add("hidden");
}

function printReport() {
  const el = document.getElementById('printDate');
  if (el) {
    const now = new Date();
    el.textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  }
  window.print();
}
</script>



    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


<!-- /*
==========================================================
📌 Electrostatic Precipitator (ESP) Efficiency Calculator
    (Deutsch–Anderson Equation)
==========================================================

🔹 Formula:
    η = 1 − exp(−(W × A) / Q)

    Where:
    - η = Collection efficiency (0–1, reported as %)
    - W = Terminal drift/migration velocity (m/s)
    - A = Total collection area (m²)
    - Q = Volumetric gas flow rate (m³/s)

----------------------------------------------------------
🔹 Input Validations:

1. Drift / Migration Velocity (W):
   - Required
   - Must be numeric
   - Range: 0.001 ≤ W ≤ 5.000 m/s
   - Typical range: 0.05 – 0.30 m/s
   - >3 decimals → warning (rounding suggested)

2. Collection Area (A):
   - Required
   - Must be numeric
   - Range: 1 ≤ A ≤ 1,000,000 m²

3. Volumetric Gas Flow Rate (Q):
   - Required
   - Must be numeric
   - Range: 0.001 ≤ Q ≤ 10,000 m³/s
   - >3 decimals → warning (rounding suggested)

----------------------------------------------------------
🔹 Derived Parameters & Advisories:

- Specific Collection Area (SCA = A/Q):
    • < 50 m²/(m³/s) → warn: undersized
    • > 300 m²/(m³/s) → warn: oversized

- Design Parameter (K = (W·A)/Q):
    • K < 0.01 → warn: very low, efficiency ≈ 0
    • K > 20   → warn: very high, efficiency ≈ 100%, check inputs

- Drift Velocity (W):
    • Outside 0.03–0.60 m/s → warn: atypical, verify conditions

----------------------------------------------------------
🔹 Output Validations:

- Efficiency (η) must be finite, 0 ≤ η ≤ 1
- If invalid → throw error
- Report efficiency as percentage (%), 2 decimals

----------------------------------------------------------
🔹 Classification by Efficiency (η × 100%):

- < 50%     → ❌ Poor capture – review sizing, power, rapping, gas conditions
- 50%–90%  → 🟡 Moderate – improvement recommended
- 90%–99%  → 🟢 Good – typical for coarse dust; verify compliance
- ≥ 99%    → ✅ Excellent – high capture; maintain monitoring

----------------------------------------------------------
🔹 Output Details:

- ESP Efficiency (%) to 2 decimals
- W (m/s), A (m²), Q (m³/s)
- Specific Collection Area (A/Q) in m²/(m³/s)
- Design Parameter (W·A/Q) (dimensionless)
- Warnings appended if applicable

==========================================================
*/ -->
