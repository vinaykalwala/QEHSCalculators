{% extends 'base.html' %}
{% block title %}Electrostatic Precipitator Efficiency Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electrostatic Precipitator Efficiency Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background: linear-gradient(#1560bd, #000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center;
            flex-wrap: wrap;
        }

        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        .rate-label { 
            color: #7f8c8d;
            font-size: 20px;
            font-weight: bold;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .rate-value {
                font-size: 38px;
            }
            .rate-label {
                font-size: 18px;
            }
        }
        
        @media (max-width: 992px) {
            .rate-value {
                font-size: 34px;
            }
            .rate-label {
                font-size: 17px;
            }
        }
        
        @media (max-width: 768px) {
            .rate-value {
                font-size: 30px;
                margin-bottom: 8px;
            }
            .rate-label {
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .rate-value {
                font-size: 28px;
                margin-bottom: 6px;
            }
            .rate-label {
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .rate-display {
                flex-direction: column;
                gap: 2px;
                text-align: center;
            }
            .rate-value {
                font-size: 24px;
                margin-bottom: 4px;
            }
            .rate-label {
                font-size: 14px;
            }
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>

<div class="btn-container">
        <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
</div>

<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}

<div class="calculator-header">
  <h1>Electrostatic Precipitator Efficiency Calculator</h1>
  <p>
    Estimate ESP collection efficiency for particulate control using plant-scale inputs.
  </p>
</div>

<div class="calc-content">
  <!-- Calculator -->
  <div class="calc-card">
    <h2>Enter Data</h2>

    <div class="form-group">
      <label for="driftVelocity">Terminal Drift / Migration Velocity (W) <span>[m/s]</span></label>
      <input type="number" id="driftVelocity" class="form-input" min="0.001" step="0.001" placeholder="e.g., 0.15">
    </div>

    <div class="form-group">
      <label for="collectionArea">Total Collection Area (A) <span>[m²]</span></label>
      <input type="number" id="collectionArea" class="form-input" min="1" step="1" placeholder="e.g., 25000">
    </div>

    <div class="form-group">
      <label for="gasFlowRate">Volumetric Gas Flow Rate (Q) <span>[m³/s]</span></label>
      <input type="number" id="gasFlowRate" class="form-input" min="0.001" step="0.001" placeholder="e.g., 300">
    </div>

    <button class="calculate-btn" onclick="calculateESPEfficiency()">Calculate Efficiency</button>
  </div>

  <!-- Result Section -->
  <div class="result-card">
    <div class="result-placeholder" id="placeholder">
      <img src="/static/images/mlc_environment_result.png" alt="ESP illustration">
      <p>This tool calculates <strong>ESP Collection Efficiency</strong> from W, A, and Q.</p>
    </div>

    <div class="result-error hidden" id="resultError">
      <div class="error-icon">❌</div>
      <div class="error-message" id="errorMessage"></div>
    </div>

    <div class="result-value hidden" id="resultValue">
      <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
        <h2>Calculated ESP Efficiency</h2>
      </div>

      <div class="rate-display">
        <div class="rate-value" id="rateValue">0.00</div>
        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">% collection efficiency</div>
      </div>

      <div class="result-feedback">
        <div class="feedback-title">Assessment</div>
        <div class="feedback-content" id="feedbackContent"></div>
      </div>
      <div class="btn-wrapper">
        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
      </div>
    </div>
  </div>
</div>

<!-- Notes Section -->
<div class="note-section">

  <div class="note-card">
    <h3>📘 About This Calculator</h3>
    <p>
      This calculator estimates the collection efficiency of an electrostatic precipitator (ESP) using
      the Deutsch–Anderson relationship, which relates drift (migration) velocity, collection area, and gas flow.
      It helps compare design options, assess compliance risk, and monitor performance degradation (e.g., fouling, power changes).
    </p>
  </div>

  <div class="note-card">
    <h3>⚙ Parameters Used</h3>
    <ul class="note-list">
      <li><strong>W</strong>: Terminal drift / migration velocity of particles [m/s]</li>
      <li><strong>A</strong>: Total collection area of ESP [m²]</li>
      <li><strong>Q</strong>: Volumetric gas flow rate through ESP [m³/s]</li>
      <li><strong>SCA</strong>: Specific Collection Area = A / Q [m² per (m³/s)]</li>
      <li><strong>K</strong>: Design parameter = W·A / Q (dimensionless)</li>
    </ul>
  </div>

  <div class="note-card">
    <h3>✅ Input Validation Rules</h3>
    <ul class="note-list">
      <li>✔️ W must be numeric, 0.001 – 5.0 m/s (typical 0.05–0.3)</li>
      <li>✔️ A must be numeric, 1 – 1,000,000 m²</li>
      <li>✔️ Q must be numeric, 0.001 – 10,000 m³/s</li>
      <li>✔️ Zeros, negatives, or non-numeric inputs are invalid</li>
      <li>⚠️ Values outside common ranges (W <0.03 or >0.60, SCA <50 or >300, K <0.01 or >20) trigger warnings</li>
    </ul>
  </div>

  <div class="note-card">
    <h3>🔎 Output & Validation</h3>
    <ul class="note-list">
      <li>Computed <strong>ESP Efficiency (η%)</strong> must be finite and between 0–100%.</li>
      <li>Assessment / Feedback is displayed along with results:
        <ul>
          <li>η &lt; 50% → ❌ Poor capture – review ESP design or operation.</li>
          <li>50% ≤ η &lt; 90% → 🟡 Moderate – improvement recommended.</li>
          <li>η ≥ 90% → ✅ Good – typical for coarse dust control.</li>
        </ul>
      </li>
      <li>Warnings are shown if inputs are outside typical ranges (SCA, K, W).</li>
    </ul>
  </div>

  <div class="note-card">
    <h3>📐 Governing Principle</h3>
    <p>
      An electrostatic precipitator (ESP) efficiency calculator is generally based on the Deutsch-Anderson equation, a standard model for predicting collection efficiency in an ESP by relating it to particle migration velocity, collecting plate area, and gas flow rate. While the core principle comes from this widely accepted equation, practical calculators may incorporate modifications and consider other factors like particle size, gas properties, and electrical conditions to provide more accurate results for various applications.
    </p>
  </div>

  <div class="note-card">
    <h3>📝 Conclusion</h3>
    <p>
      This ESP efficiency calculator provides a reliable estimate of collection efficiency based on W, A, and Q. By following proper input validation, users can ensure realistic predictions and interpret the assessment/feedback for performance monitoring, maintenance, and compliance purposes.
    </p>
  </div>

</div>

<script>
/* Reusable error display */
function showErrors(errors) {
  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");

  errorMessage.innerHTML = errors.join("<br>");
  errorBox.classList.remove("hidden");
  placeholder.classList.add("hidden");
  resultValue.classList.add("hidden");
}

/* ESP efficiency (Deutsch–Anderson) with robust validations */
function calculateESPEfficiency() {
  const Wraw = (document.getElementById("driftVelocity").value || "").trim();
  const Araw = (document.getElementById("collectionArea").value || "").trim();
  const Qraw = (document.getElementById("gasFlowRate").value || "").trim();

  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");
  const rateEl = document.getElementById("rateValue");
  const feedbackEl = document.getElementById("feedbackContent");

  // reset UI
  errorBox.classList.add("hidden");
  errorMessage.innerHTML = "";
  feedbackEl.innerHTML = "";

  const errors = [];
  const warnings = [];

  // presence
  if (!Wraw) errors.push("👉 Please enter Terminal Drift / Migration Velocity (W) in m/s.");
  if (!Araw) errors.push("👉 Please enter Total Collection Area (A) in m².");
  if (!Qraw) errors.push("👉 Please enter Volumetric Gas Flow Rate (Q) in m³/s.");
  if (errors.length) return showErrors(errors);

  // parse
  const W = Number(Wraw);
  const A = Number(Araw);
  const Q = Number(Qraw);

  // numeric checks
  if (!Number.isFinite(W)) errors.push("👉 W must be a valid number.");
  if (!Number.isFinite(A)) errors.push("👉 A must be a valid number.");
  if (!Number.isFinite(Q)) errors.push("👉 Q must be a valid number.");
  if (errors.length) return showErrors(errors);

  // hard ranges to prevent non-physical inputs
  if (W <= 0 || W < 0.001 || W > 5) errors.push("👉 W must be > 0 and within 0.001 to 5.000 m/s.");
  if (A <= 0 || A < 1 || A > 1000000) errors.push("👉 A must be > 0 and within 1 to 1,000,000 m².");
  if (Q <= 0 || Q < 0.001 || Q > 10000) errors.push("👉 Q must be > 0 and within 0.001 to 10,000 m³/s.");
  if (errors.length) return showErrors(errors);

  // compute η = 1 - exp(-(W*A)/Q)
  const eta = 1 - Math.exp(-(W * A) / Q);

  if (!Number.isFinite(eta) || eta < 0 || eta > 1) {
    return showErrors(["⚠️ Computed efficiency is invalid. Check inputs."]);
  }

  // convert to %
  const etaPct = eta * 100;

  // status message
  let statusMsg = "";
  if (etaPct < 50) {
    statusMsg = "❌ Poor capture – review ESP design or operation.";
  } else if (etaPct < 90) {
    statusMsg = "🟡 Moderate – improvement recommended.";
  } else {
    statusMsg = "✅ Good – typical for coarse dust control.";
  }

  // update UI with only efficiency
  rateEl.textContent = etaPct.toFixed(2);
  document.querySelector(".rate-label").textContent = "% collection efficiency";
  feedbackEl.innerHTML = `<div>${statusMsg}</div><div>ESP Efficiency (η): <b>${etaPct.toFixed(2)}%</b></div>`;

  placeholder.classList.add("hidden");
  resultValue.classList.remove("hidden");
  errorBox.classList.add("hidden");
}

function printReport() {
  const el = document.getElementById('printDate');
  if (el) {
    const now = new Date();
    el.textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  }
  window.print();
}
</script>




    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


<!-- /*
==========================================================
📌 Electrostatic Precipitator (ESP) Efficiency Calculator
    (Deutsch–Anderson Equation)
==========================================================

🔹 Formula:
    η = 1 − exp(−(W × A) / Q)

    Where:
    - η = Collection efficiency (0–1, reported as %)
    - W = Terminal drift/migration velocity (m/s)
    - A = Total collection area (m²)
    - Q = Volumetric gas flow rate (m³/s)

----------------------------------------------------------
🔹 Input Validations:

1. Drift / Migration Velocity (W):
   - Required
   - Must be numeric
   - Range: 0.001 ≤ W ≤ 5.000 m/s
   - Typical range: 0.05 – 0.30 m/s
   - >3 decimals → warning (rounding suggested)

2. Collection Area (A):
   - Required
   - Must be numeric
   - Range: 1 ≤ A ≤ 1,000,000 m²

3. Volumetric Gas Flow Rate (Q):
   - Required
   - Must be numeric
   - Range: 0.001 ≤ Q ≤ 10,000 m³/s
   - >3 decimals → warning (rounding suggested)

----------------------------------------------------------
🔹 Derived Parameters & Advisories:

- Specific Collection Area (SCA = A/Q):
    • < 50 m²/(m³/s) → warn: undersized
    • > 300 m²/(m³/s) → warn: oversized

- Design Parameter (K = (W·A)/Q):
    • K < 0.01 → warn: very low, efficiency ≈ 0
    • K > 20   → warn: very high, efficiency ≈ 100%, check inputs

- Drift Velocity (W):
    • Outside 0.03–0.60 m/s → warn: atypical, verify conditions

----------------------------------------------------------
🔹 Output Validations:

- Efficiency (η) must be finite, 0 ≤ η ≤ 1
- If invalid → throw error
- Report efficiency as percentage (%), 2 decimals

----------------------------------------------------------
🔹 Classification by Efficiency (η × 100%):

- < 50%     → ❌ Poor capture – review sizing, power, rapping, gas conditions
- 50%–90%  → 🟡 Moderate – improvement recommended
- 90%–99%  → 🟢 Good – typical for coarse dust; verify compliance
- ≥ 99%    → ✅ Excellent – high capture; maintain monitoring

----------------------------------------------------------
🔹 Output Details:

- ESP Efficiency (%) to 2 decimals
- W (m/s), A (m²), Q (m³/s)
- Specific Collection Area (A/Q) in m²/(m³/s)
- Design Parameter (W·A/Q) (dimensionless)
- Warnings appended if applicable

==========================================================
*/ -->
