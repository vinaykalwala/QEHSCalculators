{% extends 'base.html' %}
{% block title %}Equal Percentage Valve Lift Calculator Based on Relative Flow{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equal Percentage Valve Lift Calculator Based on Relative Flow</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background: linear-gradient(#1560bd, #000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            height: 420px;
            overflow-y: auto;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center;
            flex-wrap: wrap;
        }

        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        .rate-label { 
            color: #7f8c8d;
            font-size: 20px;
            font-weight: bold;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .rate-value {
                font-size: 38px;
            }
            .rate-label {
                font-size: 18px;
            }
        }
        
        @media (max-width: 992px) {
            .rate-value {
                font-size: 34px;
            }
            .rate-label {
                font-size: 17px;
            }
        }
        
        @media (max-width: 768px) {
            .rate-value {
                font-size: 30px;
                margin-bottom: 8px;
            }
            .rate-label {
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .rate-value {
                font-size: 28px;
                margin-bottom: 6px;
            }
            .rate-label {
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .rate-display {
                flex-direction: column;
                gap: 2px;
                text-align: center;
            }
            .rate-value {
                font-size: 24px;
                margin-bottom: 4px;
            }
            .rate-label {
                font-size: 14px;
            }
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>

<div class="btn-container">
        <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
</div>

<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}

<div class="calculator-header">
  <h1>Equal Percentage Valve Lift Calculator Based on Relative Flow</h1>
  <p>
     This helps assess valve performance and controllability in industrial systems.
  </p>
</div>

<div class="calc-content">
  <!-- Calculator -->
  <div class="calc-card">
    <h2>Enter Data</h2>

    <div class="form-group">
      <label for="flow">Flow (V) [m³/h]</label>
      <input type="number" id="flow" class="form-input" min="0.001" step="0.001" placeholder="e.g., 50">
    </div>

    <div class="form-group">
      <label for="maxFlow">Max Flow (Vmax) [m³/h]</label>
      <input type="number" id="maxFlow" class="form-input" min="0.01" step="0.001" placeholder="e.g., 500">
    </div>

    <div class="form-group">
      <label for="rangeability">Rangeability (τ)</label>
      <input type="number" id="rangeability" class="form-input" min="1.01" step="0.01" placeholder="e.g., 50">
    </div>

    <button class="calculate-btn" onclick="calculateValveLift()">Calculate Lift</button>
  </div>

  <!-- Result Section -->
  <div class="result-card">
    <div class="result-placeholder" id="placeholder">
      <img src="/static/images/mlc_environment_result.png" alt="Valve illustration">
      <p>This tool will calculate the <strong>Valve Lift Percentage (H%)</strong>.</p>
    </div>

    <div class="result-error hidden" id="resultError">
      <div class="error-icon">❌</div>
      <div class="error-message" id="errorMessage"></div>
    </div>

    <div class="result-value hidden" id="resultValue">
      <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;margin-top:50px;">
        <h2>Calculated Valve Lift</h2>
      </div>

      <div class="rate-display">
        <div class="rate-value" id="rateValue">0.00</div>
        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">%</div>
      </div>

      <div class="result-feedback">
        <div class="feedback-title">Assessment</div>
        <div class="feedback-content" id="feedbackContent"></div>
      </div>
      <div class="btn-wrapper">
        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
      </div>
    </div>
  </div>
</div>

<!-- Notes Section -->
<div class="note-section">

  <div class="note-card">
    <h3>📘 About This Calculator</h3>
    <p>
      The <strong>Equal Percentage Valve Lift Calculator</strong> determines the percentage lift (H%) required to achieve a specific flow in valves with an equal-percentage characteristic. 
      This ensures accurate control of fluids in industrial, HVAC, water treatment, and energy systems, providing stable and predictable control over a wide range of flows.
    </p>
  </div>

  <div class="note-card">
    <h3>⚙ Parameters Used</h3>
    <ul class="note-list">
      <li><strong>Flow (V)</strong>: Current process flow through the valve [m³/h]</li>
      <li><strong>Maximum Flow (Vmax)</strong>: Maximum rated flow for the valve [m³/h]</li>
      <li><strong>Rangeability (τ)</strong>: Ratio of maximum to minimum controllable flow (dimensionless)</li>
      <li><strong>Minimum Controllable Flow (Vmin)</strong>: Calculated as Vmax/τ</li>
    </ul>
  </div>

  <div class="note-card">
    <h3>✅ Input Validation Rules</h3>
    <ul class="note-list">
      <li>✔️ Flow (V) must be numeric, 0.001 – 20,000 m³/h.</li>
      <li>✔️ Max Flow (Vmax) must be numeric, 0.01 – 50,000 m³/h.</li>
      <li>✔️ Rangeability (τ) must be numeric, &gt;1.01 and ≤1000.</li>
      <li>✔️ Flow must not exceed Max Flow.</li>
      <li>✔️ Flow must be ≥ Vmax/τ (minimum controllable flow).</li>
      <li>❌ Zeros, negatives, or τ ≤ 1 are invalid.</li>
      <li>⚠️ Very low or very high values trigger warnings (may indicate poor valve sizing).</li>
    </ul>
  </div>

  <div class="note-card">
    <h3>🔎 Output & Validation</h3>
    <ul class="note-list">
      <li>Computed <strong>Valve Lift (H%)</strong> must be finite and between 0–100%.</li>
      <li>Assessment / Feedback is displayed with results: 
          <ul>
            <li>H% &lt; 5% → ⚠️ Valve nearly shut (unstable control region).</li>
            <li>5% ≤ H% ≤ 90% → ✅ Normal controllable operating range.</li>
            <li>H% &gt; 90% → ⚠️ Valve near wide-open, reduced controllability.</li>
          </ul>
      </li>
      <li>Warnings: τ outside 10–100, V close to Vmin or Vmax, very low/high flows.</li>
    </ul>
  </div>

  <div class="note-card">
    <h3>📐 Governing Principle</h3>
    <p>
      An "equal percentage valve lift calculator based on relative flow" does not directly correspond to a single international standard but follows common engineering practice and industry standards for control valves, primarily outlined by organizations like ISA (International Society of Automation). 
      <br><br>
      The principle is that the valve's flow increases by a fixed percentage for every equal incremental change in stem position (lift), ensuring consistent responsiveness across the flow range and compensating for decreasing pressure drop in process systems.
      <br><br>
      <p><strong style="color:#1976d2;">Key aspects:</strong></p>
      <ul>
        <li><strong>Industry Standard Principle:</strong> Equal percentage is widely accepted for process control valves.</li>
        <li><strong>ISA Standards:</strong> Valve design and performance are detailed in ISA standards for sizing and selection.</li>
        <li><strong>Mathematical Basis:</strong> Flow-lift relationship can be represented as Q = Q₀ * e^(bY), where Q is flow, Q₀ initial flow, Y valve opening %, and b a rangeability constant.</li>
        <li><strong>Goal:</strong> Achieve a stable and predictable control loop, avoiding sudden jumps or loss of controllability.</li>
      </ul>
    </p>
  </div>

  <div class="note-card">
    <h3>📝 Conclusion</h3>
    <p>
      This calculator provides a reliable estimate of valve lift for a given flow using equal percentage characteristics. By following proper input validation and interpreting the assessment feedback, engineers can ensure optimal valve performance, maintain process stability, and avoid issues such as unstable control near fully closed or fully open positions.
    </p>
  </div>

</div>


<script>
/* Show error messages */
function showErrors(errors) {
  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");

  errorMessage.innerHTML = errors.join("<br>");
  errorBox.classList.remove("hidden");
  placeholder.classList.add("hidden");
  resultValue.classList.add("hidden");
}

function calculateValveLift() {
  const flowRaw = (document.getElementById("flow").value || "").trim();
  const maxFlowRaw = (document.getElementById("maxFlow").value || "").trim();
  const tauRaw = (document.getElementById("rangeability").value || "").trim();

  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");
  const rateEl = document.getElementById("rateValue");
  const feedbackEl = document.getElementById("feedbackContent");

  errorBox.classList.add("hidden");
  errorMessage.innerHTML = "";
  feedbackEl.innerHTML = "";

  const errors = [];
  const warnings = [];

  // Required input validation
  if (!flowRaw) errors.push("👉 Please enter Flow (V).");
  if (!maxFlowRaw) errors.push("👉 Please enter Max Flow (Vmax).");
  if (!tauRaw) errors.push("👉 Please enter Rangeability (τ).");
  if (errors.length) return showErrors(errors);

  const V = parseFloat(flowRaw);
  const Vmax = parseFloat(maxFlowRaw);
  const tau = parseFloat(tauRaw);

  if (!Number.isFinite(V) || V < 0.001 || V > 20000)
    errors.push("👉 Flow (V) must be between 0.001 and 20,000 m³/h.");
  if (!Number.isFinite(Vmax) || Vmax < 0.01 || Vmax > 50000)
    errors.push("👉 Max Flow (Vmax) must be between 0.01 and 50,000 m³/h.");
  if (!Number.isFinite(tau) || tau <= 1.01 || tau > 1000)
    errors.push("👉 Rangeability (τ) must be > 1.01 and ≤ 1000.");

  if (errors.length) return showErrors(errors);

  // Cross-field validations
  if (V > Vmax) errors.push("👉 Flow (V) cannot exceed Max Flow (Vmax).");

  const Vmin = Vmax / tau;
  if (V < Vmin) {
    warnings.push(`⚠️ Flow is below minimum controllable limit (${Vmin.toFixed(3)} m³/h). Valve is effectively closed.`);
  }

  if (errors.length) return showErrors(errors);

  // Compute Lift % using extracted formula
  const Hpercent = 100 * (Math.log(V / Vmax) / Math.log(tau));

  if (!Number.isFinite(Hpercent)) {
    return showErrors(["⚠️ Computed valve lift is invalid. Check inputs."]);
  }

  // Warnings
  if (tau < 10 || tau > 100) warnings.push("⚠️ Rangeability is outside typical range (10–100).");
  if (V < Vmin * 1.05) warnings.push("⚠️ Flow is very close to minimum controllable limit.");
  if (V > Vmax * 0.95) warnings.push("⚠️ Flow is very close to maximum capacity.");

  // Status interpretation
  let statusMsg = "";
  if (Hpercent < 0) {
    statusMsg = "⚠️ Valve effectively closed – flow below controllable limit.";
  } else if (Hpercent < 5) {
    statusMsg = "⚠️ Valve nearly shut – control may be unstable.";
  } else if (Hpercent <= 90) {
    statusMsg = "✅ Normal controllable operating range.";
  } else {
    statusMsg = "⚠️ Valve near wide-open – reduced controllability.";
  }

  let details = `<div>Valve Lift: <b>${Hpercent.toFixed(2)}%</b></div>`;
  if (warnings.length) {
    details += `<div style="margin-top:6px; color:#b35d00; font-size:0.95em;">${warnings.join(" | ")}</div>`;
  }

  rateEl.textContent = Hpercent.toFixed(2);
  feedbackEl.innerHTML = `<div>${statusMsg}</div>${details}`;

  placeholder.classList.add("hidden");
  resultValue.classList.remove("hidden");
  errorBox.classList.add("hidden");
}

function printReport() {
  const el = document.getElementById('printDate');
  if (el) {
    const now = new Date();
    el.textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  }
  window.print();
}
</script>


    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


<!-- /*
==============================================
📌 Equal Percentage Valve Lift Calculator
==============================================

🔹 Formula:
    Valve Lift % (H%) = 100 * (1 + log(V / Vmax) / log(τ))

    where:
      V     = Flow [m³/h]
      Vmax  = Maximum Flow [m³/h]
      τ     = Rangeability (dimensionless)
      Vmin  = Vmax / τ (minimum controllable flow)

----------------------------------------------
🔹 Input Validations:
1. Flow (V):
   - Required
   - Must be numeric
   - Range: 0.001 ≤ V ≤ 20,000 m³/h

2. Maximum Flow (Vmax):
   - Required
   - Must be numeric
   - Range: 0.01 ≤ Vmax ≤ 50,000 m³/h

3. Rangeability (τ):
   - Required
   - Must be numeric
   - Range: 1.01 < τ ≤ 1000

----------------------------------------------
🔹 Cross-field Validations:
1. Flow (V) ≤ Max Flow (Vmax)
2. Flow (V) ≥ Vmin ( = Vmax / τ )
   - Otherwise: "Flow is too low for proper control."

----------------------------------------------
🔹 Output Validation:
- Computed Valve Lift (H%) must be finite.
- Must fall within 0% ≤ H% ≤ 100%.
- If invalid → show error.

----------------------------------------------
🔹 Warnings:
- τ outside typical range (10–100).
- V close to Vmin (≤ 5% above limit).
- V close to Vmax (≥ 95% of capacity).

----------------------------------------------
🔹 Status Interpretation:
- H% < 5%   → ⚠️ Valve nearly shut (unstable control).
- 5% ≤ H% ≤ 90% → ✅ Normal controllable operating range.
- H% > 90%  → ⚠️ Valve near wide open (reduced controllability).

==============================================
*/ -->
