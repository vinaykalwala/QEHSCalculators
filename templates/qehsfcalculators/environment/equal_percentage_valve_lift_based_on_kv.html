{% extends 'base.html' %}
{% block title %}Equal percentage valve lift calculator based on kv{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equal percentage valve lift calculator based on kv</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background: linear-gradient(#1560bd, #000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center;
            flex-wrap: wrap;
        }

        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        .rate-label { 
            color: #7f8c8d;
            font-size: 20px;
            font-weight: bold;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .rate-value {
                font-size: 38px;
            }
            .rate-label {
                font-size: 18px;
            }
        }
        
        @media (max-width: 992px) {
            .rate-value {
                font-size: 34px;
            }
            .rate-label {
                font-size: 17px;
            }
        }
        
        @media (max-width: 768px) {
            .rate-value {
                font-size: 30px;
                margin-bottom: 8px;
            }
            .rate-label {
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .rate-value {
                font-size: 28px;
                margin-bottom: 6px;
            }
            .rate-label {
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .rate-display {
                flex-direction: column;
                gap: 2px;
                text-align: center;
            }
            .rate-value {
                font-size: 24px;
                margin-bottom: 4px;
            }
            .rate-label {
                font-size: 14px;
            }
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>

<div class="btn-container">
        <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
</div>

<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}

<div class="calculator-header">
  <h1>Equal percentage valve lift calculator based on kv</h1>
  <p>
     Calculates valve lift percentage (H%) for equal-percentage valves to ensure safe and controllable operation.
  </p>
</div>

<div class="calc-content">
  <div class="calc-card">
    <h2>Enter Data</h2>

    <div class="form-group">
      <label for="kvr">Required Flow Coefficient (Kvr) [m³/h·bar]</label>
      <input type="number" id="kvr" class="form-input" min="0.001" step="0.001" placeholder="e.g., 50">
    </div>

    <div class="form-group">
      <label for="kvs">Full-Open Valve Coefficient (Kvs) [m³/h·bar]</label>
      <input type="number" id="kvs" class="form-input" min="0.001" step="0.001" placeholder="e.g., 500">
    </div>

    <div class="form-group">
      <label for="rangeability">Valve Rangeability (τ)</label>
      <input type="number" id="rangeability" class="form-input" min="1.01" step="0.01" placeholder="e.g., 50">
    </div>

    <button class="calculate-btn" onclick="calculateValveLift()">Calculate Lift</button>
  </div>

  <!-- Result Section -->
  <div class="result-card">
    <div class="result-placeholder" id="placeholder">
      <img src="/static/images/mlc_environment_result.png" alt="Valve illustration">
      <p>This tool calculates the <strong>Valve Lift Percentage (H%)</strong>.</p>
    </div>

    <div class="result-error hidden" id="resultError">
      <div class="error-icon">❌</div>
      <div class="error-message" id="errorMessage"></div>
    </div>

    <div class="result-value hidden" id="resultValue">
      <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
        <h2>Calculated Valve Lift</h2>
      </div>

      <div class="rate-display">
        <div class="rate-value" id="rateValue">0.00</div>
        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">%</div>
      </div>

      <div class="result-feedback">
        <div class="feedback-title">Assessment</div>
        <div class="feedback-content" id="feedbackContent"></div>
      </div>
      <div class="btn-wrapper">
        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
      </div>
    </div>
  </div>
</div>

<!-- Notes Section -->
<div class="note-section">

  <!-- About -->
  <div class="note-card">
    <h3>📘 About This Calculator</h3>
    <p>
      This calculator determines the valve lift percentage (H%) for an equal-percentage valve based on the flow coefficient (Kvr) relative to its full-open value (Kvs). 
      It ensures safe, controllable, and efficient flow regulation in industrial processes, HVAC systems, water treatment plants, and energy applications. 
      By using Kv coefficients, operators can accurately assess the required valve position for a given flow demand.
    </p>
  </div>

  <!-- Parameters -->
  <div class="note-card">
    <h3>⚙ Parameters Used</h3>
    <ul>
      <li><strong>Kvr:</strong> Flow coefficient required at a specific valve lift [m³/h·bar]</li>
      <li><strong>Kvs:</strong> Maximum flow coefficient of the fully open valve [m³/h·bar]</li>
      <li><strong>τ (Rangeability):</strong> Ratio of maximum to minimum controllable flow, unitless</li>
    </ul>
  </div>

  <!-- Input Validations -->
  <div class="note-card">
    <h3>✅ Input Validation Rules</h3>
    <ul>
      <li>Kvr: numeric, 0.001 – 50,000 m³/h·bar, must be ≤ Kvs</li>
      <li>Kvs: numeric, 0.001 – 50,000 m³/h·bar, must be ≥ Kvr</li>
      <li>τ (Rangeability): numeric, >1 and ≤1000</li>
      <li>All inputs must be positive, physically meaningful, and consistent</li>
      <li>Cross-field check: Kvr ≤ Kvs prevents illogical results</li>
      <li>Prevents division by zero or negative logarithms</li>
    </ul>
  </div>

  <!-- Output Validations & Assessment -->
  <div class="note-card">
    <h3>🔎 Output Validation & Assessment</h3>
    <ul>
      <li>Valve lift (H%) is displayed as a percentage (0–100%).</li>
      <li>Status feedback is displayed with the result for clarity and operational safety:</li>
      <ul>
        <li>Valve lift (H%) < 5 → ⚠️ Valve nearly shut – unstable control region.</li>
        <li>Valve lift (H%) 5–90 → ✅ Normal controllable operating range.</li>
        <li>Valve lift (H%) > 90 → ⚠️ Valve near wide-open – reduced controllability.</li>
      </ul>
      <li>Warnings triggered for extreme Kvr/Kvs ratios or unusual rangeability values (τ &lt;10 or τ&gt;100).</li>
      <li>Input values (Kvr, Kvs, τ) are displayed alongside H% for clarity.</li>
    </ul>
  </div>

  <!-- Governing Principle -->
  <div class="note-card">
    <h3>📐 Governing Principle</h3>
    <p>
      An Equal Percentage valve lift calculator based on the Kv coefficient follows IEC 60534 or the related DIN EN 60534 standard, which specifies procedures for determining and using Kv values to quantify valve flow capacity for control valve sizing and characteristics. 
      <br><br>
      <strong>IEC 60534:</strong> This international standard covers industrial process control valves, including sizing, characteristics, and testing. It provides a structured framework for calculating Kv coefficients and determining valve flow characteristics.
      <br><br>
      <strong>DIN EN 60534:</strong> The European adoption of IEC 60534, often with national annexes such as DIN, defines the measurement procedure for Kv values, typically using water at a defined pressure drop (~1 bar) and temperature range (5–30°C). 
      <br><br>
      <strong>Engineering Principle:</strong> The valve flow increases by a fixed percentage for each incremental change in stem lift, ensuring consistent responsiveness across the flow range and maintaining controllable operation even at very low or very high flows. This principle allows accurate prediction of H% for any given Kvr relative to Kvs.
    </p>
  </div>

  <!-- Conclusion -->
  <div class="note-card">
    <h3>✅ Conclusion</h3>
    <p>
      This calculator provides actionable guidance for setting the valve lift in equal-percentage valves using Kv coefficients. By adhering to input and output validation rules and considering assessment feedback, operators can ensure valves operate safely within controllable ranges, maintaining process stability and compliance with industrial and QEHS standards.
    </p>
  </div>

</div>



<script>
function showErrors(errors) {
  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");

  errorMessage.innerHTML = errors.join("<br>");
  errorBox.classList.remove("hidden");
  placeholder.classList.add("hidden");
  resultValue.classList.add("hidden");
}

function calculateValveLift() {
  const kvrRaw = (document.getElementById("kvr").value || "").trim();
  const kvsRaw = (document.getElementById("kvs").value || "").trim();
  const tauRaw = (document.getElementById("rangeability").value || "").trim();

  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");
  const rateEl = document.getElementById("rateValue");
  const feedbackEl = document.getElementById("feedbackContent");

  errorBox.classList.add("hidden");
  errorMessage.innerHTML = "";
  feedbackEl.innerHTML = "";

  const errors = [];
  const warnings = [];

  // Required input validation
  if (!kvrRaw) errors.push("👉 Please enter Kvr.");
  if (!kvsRaw) errors.push("👉 Please enter Kvs.");
  if (!tauRaw) errors.push("👉 Please enter Rangeability (τ).");
  if (errors.length) return showErrors(errors);

  const Kvr = parseFloat(kvrRaw);
  const Kvs = parseFloat(kvsRaw);
  const tau = parseFloat(tauRaw);

  // Numeric & range validations
  if (!Number.isFinite(Kvr) || Kvr < 0.001 || Kvr > 50000)
    errors.push("👉 Kvr must be between 0.001 and 50,000 m³/h·bar.");
  if (!Number.isFinite(Kvs) || Kvs < 0.001 || Kvs > 50000)
    errors.push("👉 Kvs must be between 0.001 and 50,000 m³/h·bar.");
  if (Kvr > Kvs) errors.push("👉 Kvr cannot exceed Kvs.");
  if (!Number.isFinite(tau) || tau <= 1 || tau > 1000)
    errors.push("👉 Rangeability (τ) must be >1 and ≤1000.");

  if (errors.length) return showErrors(errors);

  // Compute H% using updated formula
  const Hpercent = 100 * Math.log(tau * Kvr / Kvs) / Math.log(tau);

  // Output validations
  if (!Number.isFinite(Hpercent) || Hpercent < 0 || Hpercent > 100) {
    return showErrors(["⚠️ Computed valve lift is invalid. Check input values."]);
  }

  // Warnings / edge cases
  if (tau < 10 || tau > 100) warnings.push("⚠️ Rangeability is outside typical industrial range (10–100).");
  if (Hpercent < 5) warnings.push("⚠️ Valve nearly shut – control may be unstable.");
  if (Hpercent > 90) warnings.push("⚠️ Valve near wide-open – controllability reduced.");

  // Status message
  let statusMsg = "";
  if (Hpercent < 5) statusMsg = "⚠️ Valve nearly shut – unstable control region.";
  else if (Hpercent <= 90) statusMsg = "✅ Normal controllable operating range.";
  else statusMsg = "⚠️ Valve near wide-open – reduced controllability.";

  // Display result
  let details = `<div>Valve Lift: <b>${Hpercent.toFixed(2)}%</b></div>`;
  if (warnings.length) {
    details += `<div style="margin-top:6px; color:#b35d00; font-size:0.95em;">${warnings.join(" | ")}</div>`;
  }

  rateEl.textContent = Hpercent.toFixed(2);
  feedbackEl.innerHTML = `<div>${statusMsg}</div>${details}`;

  placeholder.classList.add("hidden");
  resultValue.classList.remove("hidden");
  errorBox.classList.add("hidden");
}

function printReport() {
  const el = document.getElementById('printDate');
  if (el) {
    const now = new Date();
    el.textContent = now.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
  }
  window.print();
}
</script>


    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}


<!-- 
📌 Valve Lift Calculator (Essentials)

🔹 Formula (internal, not displayed to user):
    • H% = 100 × ln(τ × Kvr / Kvs) / ln(τ)
      - H%     = Valve lift percentage
      - Kvr    = Flow coefficient at rated valve position [m³/h·bar]
      - Kvs    = Maximum flow coefficient [m³/h·bar]
      - τ      = Rangeability (unitless)

🔹 Input Validations:
    • Kvr (Rated Flow Coefficient):
        - Required, numeric
        - Range: 0.001 – 50,000 m³/h·bar
        - Cannot exceed Kvs
    • Kvs (Maximum Flow Coefficient):
        - Required, numeric
        - Range: 0.001 – 50,000 m³/h·bar
    • τ (Rangeability):
        - Required, numeric
        - Range: >1 and ≤1000

🔹 Warnings / Edge Cases:
    • τ < 10 or τ > 100 → ⚠️ Rangeability outside typical industrial range
    • H% < 5 → ⚠️ Valve nearly shut – control may be unstable
    • H% > 90 → ⚠️ Valve near wide-open – controllability reduced

🔹 Output Validations & Feedback:
    • Valve lift (H%) displayed as percentage
    • Status messages:
        - H% < 5 → ⚠️ Unstable control region
        - H% 5–90 → ✅ Normal controllable operating range
        - H% > 90 → ⚠️ Reduced controllability at wide-open
    • Input values Kvr, Kvs, and τ displayed alongside H%
    • Warnings displayed inline if triggered
-->

