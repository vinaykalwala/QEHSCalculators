{% extends 'base.html' %}
{% block title %}Chemical Equilibrium Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chemical Equilibrium Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
<style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }
        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
             /* display: flex;  */
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
            /* overflow-y: auto;  */
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Input rows for better organization */
        .input-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .input-row .form-group {
            flex: 1;
        }
        
        @media (max-width: 600px) {
            .input-row {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }

                .rate-display {
                display: flex;
                gap: 20px;
                justify-content: center;
                align-items: center;
                flex-wrap: wrap; /* responsive */
                text-align: center;
            }

            .rate-block {
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 120px; /* keeps blocks same width */
            }

            .rate-label {
                font-weight: bold;
                font-size: 16px;
                color: #444;
                margin-bottom: 5px;
            }

            .rate-value {
                font-size: 40px;
                font-weight: 700;
                color: #2980b9;
                line-height: 1.2;
            }

            .rate-unit {
                font-size: 14px;
                color: #777;
                margin-top: 4px;
            }

            /* Responsive */
            @media (max-width: 768px) {
                .rate-value { font-size: 32px; }
            }

            @media (max-width: 480px) {
                .rate-value { font-size: 26px; }
                
                .rate-unit { font-size: 12px; }
                
            }



        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
                .result-feedback {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 18px 20px;
    border-left: 4px solid #3498db;
    text-align: left;
    max-width: 800px; /* keeps it readable on large screens */
    margin: 0 auto;   /* centers it */
}

.feedback-title {
    font-weight: 600;
    margin-bottom: 8px;
    color: #2c3e50;
    font-size: 18px;
}

.feedback-content { 
    color: #34495e; 
    font-size: 16px;
    line-height: 1.5;
}

/* Responsive breakpoints */
@media (max-width: 768px) {
    .result-feedback {
        padding: 15px;
        font-size: 15px;
    }

    .feedback-title {
        font-size: 16px;
    }

    .feedback-content {
        font-size: 14px;
    }
}

@media (max-width: 480px) {
    .result-feedback {
        padding: 12px;
        border-left-width: 3px;
    }

    .feedback-title {
        font-size: 15px;
    }

    .feedback-content {
        font-size: 13px;
    }
}

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .formula-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 6px solid #0d47a1;
        }
        
        .formula-card code {
            display: inline-block;
            background: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #0d47a1;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>


    <div class="btn-container">
        <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
    </div>
    
<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}


    <div class="calculator-header">
        <h1>Chemical Equilibrium Calculator</h1>
        <p>Compute the equilibrium constant for a reaction using concentrations (K<sub>c</sub>) or convert to K<sub>p</sub> for gas-phase reactions. Inputs must be provided in consistent units.</p>
    </div>

    <div class="calc-content">
        <!-- Calculator -->
        <div class="calc-card">
            <h2>Enter Data</h2>

                <div class="input-row">
            <div class="form-group">
                <label for="reactantA">Reactant A concentration / partial pressure (A)</label>
                <input type="number" id="reactantA" class="form-input" step="any" min="0" placeholder="e.g., 0.1" aria-label="[A] or pA">
            </div>

            <div class="form-group">
                <label for="reactantB">Reactant B concentration / partial pressure (B)</label>
                <input type="number" id="reactantB" class="form-input" step="any" min="0" placeholder="e.g., 0.2" aria-label="[B] or pB">
            </div>
            </div>

            <div class="input-row">

            <div class="form-group">
                <label for="productC">Product C concentration / partial pressure (C)</label>
                <input type="number" id="productC" class="form-input" step="any" min="0" placeholder="e.g., 0.05" aria-label="[C] or pC">
            </div>

            <div class="form-group">
                <label for="productD">Product D concentration / partial pressure (D)</label>
                <input type="number" id="productD" class="form-input" step="any" min="0" placeholder="e.g., 0.01" aria-label="[D] or pD">
            </div>
            </div>

            <div class="input-row">
            <div class="form-group">
                <label for="stoichA">Stoichiometric coefficient a (A)</label>
                <input type="number" id="stoichA" class="form-input" step="1" min="1" placeholder="e.g., 1">
            </div>

            <div class="form-group">
                <label for="stoichB">Stoichiometric coefficient b (B)</label>
                <input type="number" id="stoichB" class="form-input" step="1" min="1" placeholder="e.g., 1">
            </div>
            </div>

            <div class="input-row">
            <div class="form-group">
                <label for="stoichC">Stoichiometric coefficient c (C)</label>
                <input type="number" id="stoichC" class="form-input" step="1" min="1" placeholder="e.g., 1">
            </div>

            <div class="form-group">
                <label for="stoichD">Stoichiometric coefficient d (D)</label>
                <input type="number" id="stoichD" class="form-input" step="1" min="1" placeholder="e.g., 1">
            </div>
            </div>

            <div class="input-row">
            <div class="form-group" style="margin-top:8px;">
                <label>Phase</label>
                <div style="display:flex;gap:12px;align-items:center;">
                    <label><input type="radio" name="phase" id="solutionPhase" value="solution" checked onchange="toggleTemp()"> Solution (Kc)</label>
                    <label><input type="radio" name="phase" id="gasPhase" value="gas" onchange="toggleTemp()"> Gas (Kp)</label>
                </div>
            </div>

            <div class="form-group" id="temperatureField" style="display:none;">
                <label for="temperature">Temperature (K)</label>
                <input type="number" id="temperature" class="form-input" step="any" min="0.1" placeholder="e.g., 298">
            </div>
            </div>
            <button class="calculate-btn" onclick="calculateEquilibrium()">Calculate Equilibrium Constant</button>
        </div>

        <!-- Result Section -->
        <div class="result-card">
            <div class="result-placeholder" id="placeholder">
                <img src="/static/images/mlc_environment_result.png" alt="Equilibrium illustration" style="max-width:140px;">
                <p>Enter equilibrium concentrations or partial pressures and stoichiometry, then choose phase to compute K<sub>c</sub> (and K<sub>p</sub> if applicable).</p>
            </div>

            <div class="result-error hidden" id="resultError" role="alert" aria-live="assertive">
                <div class="error-icon">❌</div>
                <div class="error-message" id="errorMessage"></div>
            </div>

            <div class="result-value hidden" id="resultValue" aria-live="polite">
                <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:6px; color:#1560bd;">
                    <h2>Equilibrium Result</h2>
                </div>

                <div style="display:flex;gap:12px;align-items:baseline;flex-wrap:wrap; justify-content:center;">
                    <div class="rate-value" id="equilibriumValue" style="font-size:28px;font-weight:700;color:#2c3e50;">0.00</div>
                    <div class="rate-label" id="equilibriumUnit" style="font-size:16px;color:#2980b9;">Kc (dimensionless)</div>
                </div>

                <div style="margin-top:8px;" id="detailsContent"></div>

                <div class="result-feedback" style="margin-top:12px;">
                    <div class="feedback-title">Summary</div>
                    <div class="feedback-content" id="feedbackContent"></div>
                </div>

                <div class="btn-wrapper" style="margin-top:12px;">
                    <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                </div>
            </div>
        </div>
    </div>

<div class="note-section">

  <!-- About This Calculator -->
  <div class="note-card">
    <h3>📘 About This Calculator</h3>
    <p>
      This calculator evaluates the equilibrium constant for a balanced chemical reaction of the form aA + bB ⇌ cC + dD. 
      It supports both solution-phase (Kc) and gas-phase (Kp) calculations, where concentrations or partial pressures are entered. 
      Gas-phase computations also require temperature input. The tool is designed for educational and practical chemistry purposes, 
      helping users understand chemical equilibrium trends and relative favorability of reactants or products.
    </p>
  </div>

  <!-- Parameters Used -->
  <div class="note-card">
    <h3>⚙ Parameters Used</h3>
    <ul class="note-list">
      <li><strong>[A], [B], [C], [D]</strong>: Equilibrium concentrations (mol·L⁻¹) or partial pressures (atm)</li>
      <li><strong>a, b, c, d</strong>: Stoichiometric coefficients from balanced equation (integers)</li>
      <li><strong>Temperature</strong>: Required for gas-phase Kp (Kelvin)</li>
    </ul>
  </div>

  <!-- Input Validation Rules -->
  <div class="note-card">
    <h3>✅ Input Validation Rules</h3>
    <ul class="note-list">
      <li>All inputs must be numeric and finite.</li>
      <li>Reactants (A, B) must be > 0; products (C, D) ≥ 0.</li>
      <li>Stoichiometric coefficients must be integers ≥ 1.</li>
      <li>Temperature must be > 0 K for gas-phase calculations.</li>
      <li>Checks include extremely high or low values to warn about unit inconsistencies.</li>
    </ul>
  </div>

  <!-- Output Validations -->
<!-- Output Validations -->
<div class="note-card">
  <h3>🧮 Output Validations</h3>
  <ul class="note-list">
    <li>Calculation is rejected if denominator is zero, negative, or non-finite.</li>
    <li>Computed Kc/Kp must be finite and non-negative.</li>
    <li>Warnings appear if decimals exceed 6 places, or values are extremely large/small.</li>
    <li>For gas-phase, temperature must be >0 K; very low or very high temperatures trigger warnings.</li>
    <li>Assessment/feedback about favorability of products vs reactants is displayed along with results.</li>
    <li>Cross-field logic: if both products are zero, or product/reactant scale differs by >12 orders of magnitude, warnings appear.</li>
  </ul>
</div>


  <!-- Governing Principle -->
 <div class="note-card">
  <h3>📜 Governing Principle</h3>
  <p>A Chemical Equilibrium Calculator is not from one single standard, but rather is based on principles of thermodynamics and 
    the law of mass action, which describe the equilibrium constant (K) and the relationship between standard Gibbs free energy 
    (ΔG°) and K through the equation ΔG° = -RTlnK. These principles are applied in various computational tools, 
    such as those that use physical property databases like the NIST database, for calculating equilibrium compositions. 
Such calculators allow engineers and chemists to predict concentrations of reactants and products under given conditions. 
They are used in chemical process design, reaction optimization, and educational simulations to illustrate equilibrium concepts. Additionally, 
they provide a reliable framework for 
comparing theoretical predictions with experimental data and for sensitivity analysis in chemical systems.</p>
</div>


  <!-- Conclusion -->
  <div class="note-card">
    <h3>🏁 Conclusion</h3>
    <p>
      This tool allows rapid evaluation of chemical equilibria using user-provided concentrations or pressures.  
      By enforcing input validations and presenting clear feedback, it ensures meaningful and reliable results.  
      Users can interpret favorability, compare conditions, and apply the insights in educational, research, or industrial contexts.
    </p>
  </div>

</div>


<script>
function showErrors(errors) {
  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");
  if (errorMessage) errorMessage.innerHTML = errors.join("<br>");
  if (errorBox) errorBox.classList.remove("hidden");
  if (placeholder) placeholder.classList.add("hidden");
  if (resultValue) resultValue.classList.add("hidden");
}

function toggleTemp() {
  const tempField = document.getElementById("temperatureField");
  const isGas = document.getElementById("gasPhase").checked;
  tempField.style.display = isGas ? "block" : "none";
}

/* ===== NEW: unified validator ===== */
function validateAndParse() {
  const isGas = document.getElementById("gasPhase").checked;

  const fields = {
    A: document.getElementById("reactantA")?.value?.trim() ?? "",
    B: document.getElementById("reactantB")?.value?.trim() ?? "",
    C: document.getElementById("productC")?.value?.trim() ?? "",
    D: document.getElementById("productD")?.value?.trim() ?? "",
    a: document.getElementById("stoichA")?.value?.trim() ?? "",
    b: document.getElementById("stoichB")?.value?.trim() ?? "",
    c: document.getElementById("stoichC")?.value?.trim() ?? "",
    d: document.getElementById("stoichD")?.value?.trim() ?? "",
    T: isGas ? (document.getElementById("temperature")?.value?.trim() ?? "") : ""
  };

  const errors = [];
  const warnings = [];

  // Required checks
  Object.entries(fields).forEach(([k, v]) => {
    if (v === "" && (k !== "T" || isGas)) {
      const labelMap = {A:"Reactant A",B:"Reactant B",C:"Product C",D:"Product D",a:"stoichiometric coefficient a",b:"stoichiometric coefficient b",c:"stoichiometric coefficient c",d:"stoichiometric coefficient d",T:"Temperature (K)"};
      errors.push(`👉 Enter ${labelMap[k]}.`);
    }
  });
  if (errors.length) return { ok:false, errors, warnings };

  // Parse numbers
  const A = Number(fields.A), B = Number(fields.B), C = Number(fields.C), D = Number(fields.D);
  const a = Number(fields.a), b = Number(fields.b), c = Number(fields.c), d = Number(fields.d);
  const T = isGas ? Number(fields.T) : null;

  const finiteCheck = (val, name) => { if (!Number.isFinite(val)) errors.push(`👉 ${name} must be a finite number.`); };
  finiteCheck(A, "Reactant A");
  finiteCheck(B, "Reactant B");
  finiteCheck(C, "Product C");
  finiteCheck(D, "Product D");
  finiteCheck(a, "Stoichiometric coefficient a");
  finiteCheck(b, "Stoichiometric coefficient b");
  finiteCheck(c, "Stoichiometric coefficient c");
  finiteCheck(d, "Stoichiometric coefficient d");
  if (isGas) finiteCheck(T, "Temperature");
  if (errors.length) return { ok:false, errors, warnings };

  // Integers for stoichiometry with range 1–12
  const intCheck = (val, name) => {
    if (!Number.isInteger(val) || val < 1 || val > 12) {
      errors.push(`👉 ${name} must be an integer between 1 and 12.`);
    }
  };
  intCheck(a, "a"); intCheck(b, "b"); intCheck(c, "c"); intCheck(d, "d");
  if (errors.length) return { ok:false, errors, warnings };

  // Signs / domain
  if (!(A > 0)) errors.push("👉 Reactant A must be > 0 (avoids division by zero and ensures reactant present).");
  if (!(B > 0)) errors.push("👉 Reactant B must be > 0 (avoids division by zero and ensures reactant present).");
  if (!(C >= 0)) errors.push("👉 Product C must be ≥ 0.");
  if (!(D >= 0)) errors.push("👉 Product D must be ≥ 0.");
  if (isGas && !(T > 0)) errors.push("👉 Temperature must be > 0 K for gas-phase calculations.");
  if (errors.length) return { ok:false, errors, warnings };

  // Decimal places (soft)
  const dp = s => {
    const m = (s.match(/\.(\d+)/)?.[1]?.length) || 0;
    return m;
  };
  const dpMap = [
    ["Reactant A", fields.A], ["Reactant B", fields.B], ["Product C", fields.C], ["Product D", fields.D]
  ];
  dpMap.forEach(([label, str]) => { if (dp(str) > 6) warnings.push(`ℹ️ ${label} has >6 decimals. Value will be rounded for display.`); });

  // Range & plausibility by phase
  if (!isGas) {
    // Solution-phase mol·L⁻¹ ranges
    const softLow = 1e-9, softHigh = 20, hardLow = 0, hardHigh = 1e6;
    const checkRange = (val, label) => {
      if (val < hardLow) errors.push(`👉 ${label} cannot be negative.`);
      if (val > hardHigh) warnings.push(`⚠️ ${label} is extremely large; check units (mol/L vs mmol/L).`);
      if (val > softHigh || val < softLow) warnings.push(`⚠️ ${label} is outside typical ranges for solution chemistry (${softLow}–${softHigh} mol·L⁻¹). Verify units.`);
    };
    checkRange(A,"[A]"); checkRange(B,"[B]"); checkRange(C,"[C]"); checkRange(D,"[D]");
  } else {
    // Gas-phase atm ranges
    const softLow = 1e-9, softHigh = 100, hardHigh = 1000;
    const checkP = (val, label, allowZero) => {
      if (val < 0) errors.push(`👉 ${label} cannot be negative.`);
      if (!allowZero && val === 0) errors.push(`👉 ${label} must be >0 for reactants in gas phase.`);
      if (val > hardHigh) errors.push(`👉 ${label} >1000 atm is not supported (likely wrong units such as kPa/Pa).`);
      if (val > softHigh || (val > 50 && label.includes("Reactant"))) warnings.push(`⚠️ ${label} is very high; verify units (atm).`);
      if (val < softLow && val > 0) warnings.push(`⚠️ ${label} is extremely low; verify detection limit/units.`);
    };
    checkP(A,"Reactant A (atm)", false);
    checkP(B,"Reactant B (atm)", false);
    checkP(C,"Product C (atm)", true);
    checkP(D,"Product D (atm)", true);

    // Temperature plausibility
    if (T < 50 || T > 4000) warnings.push("⚠️ Temperature K is far outside common ranges; confirm units.");
    else if (T < 150 || T > 2000) warnings.push("ℹ️ Temperature is uncommon for many processes; verify.");
    if (T >= 1 && T <= 80) warnings.push("💡 Temperature is very low in K; did you mean ~298 K (~25 °C)?");
  }

  // Cross-field logic
  if (C === 0 && D === 0) {
    warnings.push("ℹ️ Both products are zero; K will be 0. Are these truly equilibrium values?");
  }
  const productScale = Math.max(C, D);
  const reactantScale = Math.max(A, B);
  if (reactantScale > 0 && productScale > 0) {
    const ratio = productScale / reactantScale;
    if (ratio > 1e12 || ratio < 1e-12) {
      warnings.push("⚠️ Product/Reactant scale differs by >12 orders of magnitude. Check instruments/units/equilibrium status.");
    }
  }

  const deltaN = (c + d) - (a + b);

  return {
    ok: true,
    errors,
    warnings,
    parsed: { A, B, C, D, a, b, c, d, T, isGas, deltaN }
  };
}

/* ===== Updated calculation uses validator ===== */
function calculateEquilibrium() {
  const errorBox = document.getElementById("resultError");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");
  const eqValEl = document.getElementById("equilibriumValue");
  const eqUnitEl = document.getElementById("equilibriumUnit");
  const detailsEl = document.getElementById("detailsContent");
  const feedbackEl = document.getElementById("feedbackContent");

  // reset UI
  if (errorBox) errorBox.classList.add("hidden");
  if (detailsEl) detailsEl.innerHTML = "";
  if (feedbackEl) feedbackEl.innerHTML = "";
  if (eqValEl) eqValEl.textContent = "0.00";

  const v = validateAndParse();
  if (!v.ok) { showErrors(v.errors); return; }

  const {A,B,C,D,a,b,c,d,T,isGas,deltaN} = v.parsed;
  if (eqUnitEl) eqUnitEl.textContent = isGas ? "Kp (dimensionless)" : "Kc (dimensionless)";

  try {
    // Compute Kc
    const numerator = Math.pow(C, c) * Math.pow(D, d);
    const denominator = Math.pow(A, a) * Math.pow(B, b);

    if (denominator === 0 || !Number.isFinite(denominator) || denominator < 0) {
      showErrors(["⚠️ Denominator is invalid (zero/overflow). Check reactant values."]);
      return;
    }

    let Kc = numerator / denominator;
    if (!Number.isFinite(Kc) || Kc < 0) {
      showErrors(["⚠️ Computed Kc is invalid. Check inputs/units."]);
      return;
    }

    let displayValue = Kc;
    let outputLabel = "Kc";

    // Gas phase: convert to Kp
    const R = 0.082057; // L·atm·mol⁻1·K⁻1
    if (isGas) {
      const factor = Math.pow(R * T, deltaN);
      if (!Number.isFinite(factor) || factor === 0) {
        showErrors(["⚠️ (RT)^{Δn} produced a non-finite value. Check T and stoichiometry."]);
        return;
      }
      const Kp = Kc * factor;
      if (!Number.isFinite(Kp) || Kp < 0) {
        showErrors(["⚠️ Computed Kp is invalid. Check inputs/units."]);
        return;
      }
      displayValue = Kp;
      outputLabel = `Kp (Δn = ${deltaN})`;
      detailsEl.innerHTML = `<div>Δn = (c + d) − (a + b) = <b>${deltaN}</b></div>
                             <div style="margin-top:4px;">Conversion: Kp = Kc × (R·T)<sup>Δn</sup>, R=0.082057 L·atm·mol⁻¹·K⁻¹</div>
                             <div style="margin-top:4px;color:#8a5400;">Assumes all species are gases and ideal behavior.</div>`;
    }

    // Format number
    const absVal = Math.abs(displayValue);
    let formatted = "";
    if (absVal !== 0 && (absVal < 1e-4 || absVal > 1e6)) {
      formatted = displayValue.toExponential(4);
    } else {
      formatted = Number(displayValue).toPrecision(6).replace(/(?:\.0+|(\.\d+?)0+)$/, "$1");
    }

    // Interpretive summary
    let summary = "";
    if (displayValue > 1.1) summary = "Products favored (K > 1).";
    else if (displayValue < 0.9) summary = "Reactants favored (K < 1).";
    else summary = "Neither side strongly favored (K ≈ 1).";

    // Warnings from validator
    if (v.warnings?.length) {
      detailsEl.innerHTML += `<div style="margin-top:6px; color:#b35d00;">Note: ${v.warnings.join(" | ")}</div>`;
    }

    // Update UI
    document.getElementById("placeholder")?.classList.add("hidden");
    resultValue?.classList.remove("hidden");
    errorBox?.classList.add("hidden");
    document.getElementById("equilibriumValue").textContent = formatted;
    document.getElementById("equilibriumUnit").textContent = `${outputLabel} (dimensionless)`;

    const A_disp = Number(A.toFixed(6)), B_disp = Number(B.toFixed(6)),
          C_disp = Number(C.toFixed(6)), D_disp = Number(D.toFixed(6));
    const unitText = isGas ? "atm" : "mol·L⁻¹";
    document.getElementById("feedbackContent").innerHTML =
      `<div style="font-weight:600;">${summary}</div>
       <div style="margin-top:8px;">Inputs (${unitText}): [A]=<b>${A_disp}</b>, [B]=<b>${B_disp}</b>, [C]=<b>${C_disp}</b>, [D]=<b>${D_disp}</b>${isGas?`, T=<b>${Number(T.toFixed(2))} K</b>`:""}</div>`;

  } catch (err) {
    console.error(err);
    showErrors(["⚠️ Unexpected error during calculation."]);
  }
}

function printReport() {
  let el = document.getElementById('printDate');
  if (!el) {
    el = document.createElement('span');
    el.id = 'printDate';
    el.style.display = 'none';
    document.body.appendChild(el);
  }
  const now = new Date();
  el.textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  window.print();
}
</script>

<script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}

<!--
====================================================
⚖️ Chemical Equilibrium Calculator – Documentation
====================================================

📌 Core Formulas:
-----------------
1. **Equilibrium Constant (Concentration basis)**  
   Kc = ([C]^c · [D]^d) / ([A]^a · [B]^b)  

   where:
     • [A], [B], [C], [D] = equilibrium concentrations (mol·L⁻¹) or partial pressures (atm)  
     • a, b, c, d = stoichiometric coefficients (integers, 1–12)

2. **Conversion (Gas Phase only):**  
   Kp = Kc × (R·T)^Δn  

   with:
     • Δn = (c + d) − (a + b)  
     • R = 0.082057 L·atm·mol⁻¹·K⁻¹  
     • T = temperature (K, > 0)

📥 Input Validations:
---------------------
**General Requirements**
- All species values required (except T if solution-phase).
- Stoichiometric coefficients a, b, c, d must be integers between 1 and 12.
- Values must be numeric and finite.

**Concentrations / Pressures**
- Reactants [A], [B] > 0 (cannot be zero or negative).  
- Products [C], [D] ≥ 0.  
- For solution phase: typical range 10⁻⁹ – 20 mol·L⁻¹ (warnings outside).  
- For gas phase: typical range 10⁻⁹ – 100 atm (errors >1000 atm).  

**Temperature (Gas Phase)**
- Must be > 0 K.  
- Warnings if <50 K or >4000 K.  
- Soft hints if T ~1–80 K (likely unit error).

**Decimal Precision**
- Warn if >6 decimal places (values will be rounded for display).

**Cross-field Checks**
- If both [C] and [D] = 0 → warning: K = 0 (possible non-equilibrium).  
- If product/reactant ratio differs by >12 orders of magnitude → warning: check units/data.

📤 Output Validations:
----------------------
- Reject calculation if denominator invalid (0, negative, non-finite).  
- Reject if computed Kc/Kp is non-finite or negative.  
- Formatting:
  • Use exponential form if <1×10⁻⁴ or >1×10⁶.  
  • Otherwise, precision limited to 6 significant figures.  

**Interpretation**
- K > 1 → Products favored.  
- K < 1 → Reactants favored.  
- K ≈ 1 → Neither side strongly favored.

====================================================
-->
