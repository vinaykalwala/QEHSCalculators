{% extends 'base.html' %}
{% block title %}Threshold Limit Value (TLV) Calculator for Silica Dust{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Threshold Limit Value (TLV) Calculator for Silica Dust</title>

  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/print.css' %}">

  <style>
           /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background: linear-gradient(#1560bd, #000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        
.result-card::-webkit-scrollbar {
    width: 8px;
}

.result-card::-webkit-scrollbar-thumb {
    background: #1560bd;
    border-radius: 6px;
}

.result-card::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.result-card {
    justify-content: flex-start; /* align from top */
    align-items: stretch;
    min-height: 420px;
    text-align: center;
    overflow-y: auto;       /* Enable vertical scrolling */
    max-height: 450px;      /* Set max height to control output size */
    padding: 20px;          /* keep spacing */
}

        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center;
            flex-wrap: wrap;
        }

        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        .rate-label { 
            color: #7f8c8d;
            font-size: 20px;
            font-weight: bold;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .rate-value {
                font-size: 38px;
            }
            .rate-label {
                font-size: 18px;
            }
        }
        
        @media (max-width: 992px) {
            .rate-value {
                font-size: 34px;
            }
            .rate-label {
                font-size: 17px;
            }
        }
        
        @media (max-width: 768px) {
            .rate-value {
                font-size: 30px;
                margin-bottom: 8px;
            }
            .rate-label {
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .rate-value {
                font-size: 28px;
                margin-bottom: 6px;
            }
            .rate-label {
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .rate-display {
                flex-direction: column;
                gap: 2px;
                text-align: center;
            }
            .rate-value {
                font-size: 24px;
                margin-bottom: 4px;
            }
            .rate-label {
                font-size: 14px;
            }
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
  </style>
</head>
<body>

  <div class="btn-container">
    <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
  </div>

  <div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}

    <div class="calculator-header">
      <h1>Threshold Limit Value (TLV) Calculator for Silica Dust</h1>
      <p>Calculate the <strong>TLV (mg/m³)</strong> for silica dust exposure using the mix of Quartz, Cristobalite and Tridymite.</p>
    </div>

    <div class="calc-content">
      <!-- Calculator -->
      <div class="calc-card">
        <h2>Enter Dust Composition (%)</h2>

        <div class="form-group">
          <label for="quartz">Quartz Dust (%Q)</label>
          <input type="number" id="quartz" class="form-input" min="0" max="100" step="any" placeholder="e.g., 40">
        </div>

        <div class="form-group">
          <label for="cristobalite">Cristobalite Dust (%C)</label>
          <input type="number" id="cristobalite" class="form-input" min="0" max="100" step="any" placeholder="e.g., 20">
        </div>

        <div class="form-group">
          <label for="tridymite">Tridymite Dust (%T)</label>
          <input type="number" id="tridymite" class="form-input" min="0" max="100" step="any" placeholder="e.g., 10">
        </div>

        <button class="calculate-btn" onclick="calculateTLV()">Calculate TLV</button>
      </div>

      <!-- Result Section -->
      <div class="result-card">
        <div class="result-placeholder" id="placeholder">
          <img src="/static/images/mlc_environment_result.png" alt="TLV illustration">
          <p>This tool will calculate the <strong>Threshold Limit Value (mg/m³)</strong> for the provided dust composition.</p>
        </div>

        <div class="result-error hidden" id="resultError">
          <div class="error-icon">❌</div>
          <div class="error-message" id="errorMessage"></div>
        </div>

        <div class="result-value hidden" id="resultValue">
          <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
            <h2>Calculated TLV</h2>
          </div>

          <div class="rate-display">
            <div class="rate-value" id="rateValue">0.000</div>
            <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">mg/m³</div>
          </div>

          <div class="result-feedback">
            <div class="feedback-title">Assessment</div>
            <div class="feedback-content" id="feedbackContent"></div>
          </div>

          <div class="btn-wrapper">
            <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notes -->
    <div class="note-section">

    <div class="note-card">
        <h3>📘 About This Calculator</h3>
        <p>
          TLV is estimated from the mixture of silica dust forms.
          Cristobalite and Tridymite are treated as twice as hazardous as Quartz in this model.
        </p>
    </div>

    <div class="note-card">
        <h3>📐 Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Quartz (Q):</strong> % composition of quartz dust (0–100%).</li>
            <li><strong>Cristobalite (C):</strong> % composition of cristobalite dust (0–100%).</li>
            <li><strong>Tridymite (T):</strong> % composition of tridymite dust (0–100%).</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>⚠️ Input Validation Rules</h3>
        <ul class="note-list">
            <li>✔️ All values must be numeric and between <strong>0 and 100%</strong>.</li>
            <li>❌ The sum (Q + C + T) must not exceed <strong>100%</strong>.</li>
            <li>❌ All zeros (Q=C=T=0) are invalid for practical exposure assessment.</li>
            <li>⚠️ Very small TLV &lt; 0.1 mg/m³ signals hazardous mixture — immediate control measures recommended.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>📊 Output Validations</h3>
        <ul class="note-list">
            <li>TLV &lt; 0.1 mg/m³</span>  🔴 Hazardous exposure — immediate control measures required.</li>
            <li>0.1 ≤ TLV ≤ 0.5 mg/m³</span>  ⚠️ Borderline safe — implement controls and regular monitoring.</li>
            <li>TLV &gt; 0.5 mg/m³</span>  ✅ Acceptable exposure level (lower immediate risk).</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>📏 Governing Principle</h3>
        <p>
            A Threshold Limit Value (TLV) Calculator for silica dust is based on the guidelines set by the American Conference of Governmental Industrial Hygienists (ACGIH). 
            The TLVs are recommended guidelines for occupational exposure and are not legally enforceable limits like those set by regulatory bodies such as the U.S. Occupational Safety and Health Administration (OSHA).
        </p>
        <p><strong>The ACGIH TLV for silica dust</strong></p>
        <ul class="note-list">
            <li>The current ACGIH TLV for respirable crystalline silica (specifically alpha-quartz and cristobalite) is 0.025 mg/m³.</li>
            <li>This is a Time-Weighted Average (TWA) intended for a conventional 8-hour workday and 40-hour workweek.</li>
            <li>The TLV is a health-based recommendation meant to protect most workers from experiencing adverse health effects over a working lifetime.</li>
        </ul>
        <p><strong>How the calculator works</strong></p>
        <ul class="note-list">
            <li>A TLV calculator for silica dust uses the ACGIH standard to assess whether a worker's exposure is within the recommended limits.</li>
            <li>It would typically use the TLV-TWA of 0.025 mg/m³ as the threshold for comparison.</li>
            <li>Compare a worker's average airborne silica concentration (often measured over an 8-hour shift) to this standard.</li>
            <li>Determine if the exposure is above or below the recommended level.</li>
        </ul>
        <p><strong>TLVs vs. PELs</strong></p>
        <ul class="note-list">
            <li>ACGIH TLVs are recommendations based on health-focused research and are used by industrial hygienists to create safer workplaces.</li>
            <li>OSHA PELs are legal standards enforced by the government. In many cases, the OSHA PELs for silica are less stringent and have not been updated as frequently as the ACGIH recommendations.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>✅ Conclusion</h3>
        <p>
            The <strong>TLV Calculator for Silica Dust</strong> estimates worker exposure risk from mixed quartz, cristobalite, and tridymite dusts. 
            It follows <b>ACGIH, OSHA, and NIOSH</b> standards to align with recognized occupational safety thresholds. 
            Lower TLV values indicate higher hazard and the need for immediate engineering controls, PPE, or monitoring. 
            Always confirm results with <b>air sampling data</b>, <b>industrial hygiene assessments</b>, and <b>local regulatory limits</b> before applying in workplace safety programs.
        </p>
    </div>

</div>

  <script>
    /***************************************************************
     * TLV calculator logic & validations (keeps UI flow intact)
     * Formula: TLV = 10 / (Q + 2C + 2T + 2)
     ***************************************************************/

    function showErrors(errors) {
      const errorBox = document.getElementById("resultError");
      const errorMessage = document.getElementById("errorMessage");
      const placeholder = document.getElementById("placeholder");
      const resultValue = document.getElementById("resultValue");

      errorMessage.innerHTML = errors.join("<br>");
      errorBox.classList.remove("hidden");
      placeholder.classList.add("hidden");
      resultValue.classList.add("hidden");
    }

    function calculateTLV() {
      // Read raw strings (preserve user formatting)
      const quartzRaw = document.getElementById("quartz").value.trim();
      const cristobaliteRaw = document.getElementById("cristobalite").value.trim();
      const tridymiteRaw = document.getElementById("tridymite").value.trim();

      const errorBox = document.getElementById("resultError");
      const placeholder = document.getElementById("placeholder");
      const resultValue = document.getElementById("resultValue");
      const rateEl = document.getElementById("rateValue");
      const feedbackEl = document.getElementById("feedbackContent");
      const errorMessageEl = document.getElementById("errorMessage");

      // Reset UI
      errorBox.classList.add("hidden");
      errorMessageEl.innerHTML = "";
      feedbackEl.innerHTML = "";

      const errors = [];
      const warnings = [];

      // Required presence check
      if (quartzRaw === "" || cristobaliteRaw === "" || tridymiteRaw === "") {
        return showErrors(["👉 Please enter all three dust percentages: Quartz (Q), Cristobalite (C), and Tridymite (T)."]);
      }

      // Parse floats
      const Q = parseFloat(quartzRaw);
      const C = parseFloat(cristobaliteRaw);
      const T = parseFloat(tridymiteRaw);

      // Basic numeric validations
      if (!Number.isFinite(Q)) errors.push("👉 Quartz (Q) must be a numeric value.");
      if (!Number.isFinite(C)) errors.push("👉 Cristobalite (C) must be a numeric value.");
      if (!Number.isFinite(T)) errors.push("👉 Tridymite (T) must be a numeric value.");

      if (Number.isFinite(Q) && (Q < 0 || Q > 100)) errors.push("👉 Quartz (Q) must be between 0 and 100%.");
      if (Number.isFinite(C) && (C < 0 || C > 100)) errors.push("👉 Cristobalite (C) must be between 0 and 100%.");
      if (Number.isFinite(T) && (T < 0 || T > 100)) errors.push("👉 Tridymite (T) must be between 0 and 100%.");

      // Stop early if numeric/form errors
      if (errors.length) return showErrors(errors);

      // Cross-field logical checks
      const sum = Q + C + T;
      if (sum > 100 + 1e-9) errors.push("👉 Total composition (Q + C + T) cannot exceed 100%.");
      if (Q === 0 && C === 0 && T === 0) errors.push("👉 All values are zero — no dust composition provided (invalid for TLV assessment).");

      if (errors.length) return showErrors(errors);

      // Edge warnings for unrealistic mixes
      if (sum < 0.0001) errors.push("👉 Composition sum is effectively zero — check inputs.");
      if (sum < 1 && sum > 0) warnings.push("⚠️ Total composition < 1% — small sample, TLV may not reflect field conditions.");
      if (Q > 99.9 && (C + T) < 0.001) warnings.push("⚠️ Composition ~100% Quartz — TLV driven predominantly by Quartz.");
      if ((C + T) > 80) warnings.push("⚠️ High Cristobalite/Tridymite fraction (>80%) — increased hazard expected.");

      // Denominator safety check
      // formula denominator = Q + 2*C + 2*T + 2
      const denominator = Q + 2 * C + 2 * T + 2;
      if (!Number.isFinite(denominator) || denominator <= 0) {
        return showErrors(["👉 Invalid denominator computed. Check input values."]);
      }

      // Compute TLV (mg/m³)
      const tlv = 10 / denominator;

      if (!Number.isFinite(tlv) || tlv <= 0) {
        return showErrors(["⚠️ Computed TLV is invalid or non-positive."]);
      }

      // Output classification (practical guidance)
      let statusMsg = "";
      // These thresholds are guidance only; can be adjusted to align with local regulations.
      if (tlv < 0.1) {
        statusMsg = "🔴 Hazardous exposure — immediate control measures required (TLV &lt; 0.1 mg/m³).";
      } else if (tlv <= 0.5) {
        statusMsg = "⚠️ Borderline safe — implement controls and regular monitoring (0.1 ≤ TLV ≤ 0.5 mg/m³).";
      } else {
        statusMsg = "✅ Acceptable exposure level (TLV &gt; 0.5 mg/m³).";
      }

      // Add warnings based on TLV extremes
      if (tlv < 0.05) warnings.push("⚠️ Very low TLV (&lt; 0.05 mg/m³) — often indicates a highly hazardous mix; confirm lab analysis.");
      if (tlv > 2) warnings.push("⚠️ High TLV (&gt; 2 mg/m³) — implies low hazard from silica forms but check other contaminants.");

      // Compose feedback details
      let details = `<div style="margin-bottom:6px;"><b>${statusMsg}</b></div>`;
      details += `<div>TLV = <b>${tlv.toFixed(3)} mg/m³</b> (calculated)</div>`;
      details += `<div style="margin-top:8px;">Composition: Quartz <b>${Q.toFixed(2)}%</b> | Cristobalite <b>${C.toFixed(2)}%</b> | Tridymite <b>${T.toFixed(2)}%</b></div>`;
      

      if (warnings.length) {
        details += `<div style="margin-top:10px; color:#b35d00; font-size:0.95em;">${warnings.join(" | ")}</div>`;
      }

      // Display results
      rateEl.textContent = tlv.toFixed(3);
      feedbackEl.innerHTML = details;

      placeholder.classList.add("hidden");
      resultValue.classList.remove("hidden");
      errorBox.classList.add("hidden");
    }

    // Simple print helper (keeps original workflow)
    function printReport() {
      // Use the printable area as before
      const printArea = document.getElementById('printArea');
      if (!printArea) return window.print();
      const original = document.body.innerHTML;
      const content = printArea.innerHTML;
      document.body.innerHTML = content;
      window.print();
      document.body.innerHTML = original;
      window.location.reload(); // reload to restore JS bindings; acceptable for print workflow
    }
  </script>

  <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}
<!--
-------------------------------------------------------------------
Input Validations

Quartz Dust (Q)

Must be numeric.

Range: 0 ≤ Q ≤ 100 (%).

Blank or negative values → ❌ Invalid.

Cristobalite Dust (C)

Must be numeric.

Range: 0 ≤ C ≤ 100 (%).

Blank or negative values → ❌ Invalid.

Tridymite Dust (T)

Must be numeric.

Range: 0 ≤ T ≤ 100 (%).

Blank or negative values → ❌ Invalid.

Cross-field validation

Total (Q + C + T) must not exceed 100%.

All three values cannot be zero.
-----------------------------------------------------------------------------
🔹 Output Validations

TLV must be finite, positive, and > 0.

TLV calculation is valid only if denominator: (Q + 2C + 2T + 2) > 0.

Result Classification:

TLV < 0.1 mg/m³ → 🔴 Hazardous (unacceptable).

0.1 ≤ TLV ≤ 0.5 mg/m³ → ⚠️ Borderline safe (monitor & control).

TLV > 0.5 mg/m³ → ✅ Acceptable.
-----------------------------------------------------------------------------------------
🔹 Edge Case Validations

Blank inputs → Show error.

Negative numbers → Show error.

Q + C + T > 100% → Show error.

Q = C = T = 0 → Show error.

Denominator = 0 or non-finite → Show error.

Extremely low TLV (< 0.05 mg/m³) → Warning (high hazard, confirm analysis).

Extremely high TLV (> 2 mg/m³) → Warning (implies low hazard from silica, verify other contaminants).

Very small total composition (<1%) → Warning (sample may not reflect real workplace conditions).

Cristobalite + Tridymite > 80% → Warning (highly hazardous mix).

-->