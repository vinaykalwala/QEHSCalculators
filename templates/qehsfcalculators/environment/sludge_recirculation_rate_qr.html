{% extends 'base.html' %}
{% block title %}Sludge Recirculation Rate (Qr) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sludge Recirculation Rate (Qr) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background: linear-gradient(#1560bd, #000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center;
            flex-wrap: wrap;
        }

        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        .rate-label { 
            color: #7f8c8d;
            font-size: 20px;
            font-weight: bold;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .rate-value {
                font-size: 38px;
            }
            .rate-label {
                font-size: 18px;
            }
        }
        
        @media (max-width: 992px) {
            .rate-value {
                font-size: 34px;
            }
            .rate-label {
                font-size: 17px;
            }
        }
        
        @media (max-width: 768px) {
            .rate-value {
                font-size: 30px;
                margin-bottom: 8px;
            }
            .rate-label {
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .rate-value {
                font-size: 28px;
                margin-bottom: 6px;
            }
            .rate-label {
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .rate-display {
                flex-direction: column;
                gap: 2px;
                text-align: center;
            }
            .rate-value {
                font-size: 24px;
                margin-bottom: 4px;
            }
            .rate-label {
                font-size: 14px;
            }
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>

<div class="btn-container">
    <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
</div>

<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}

    <div class="calculator-header">
        <h1>Sludge Recirculation Rate (Qr) Calculator</h1>
        <p>Calculate the sludge recirculation rate for activated sludge wastewater treatment systems.</p>
    </div>

    <div class="calc-content">
        <!-- Input Card -->
        <div class="calc-card">
            <h2>Enter Parameters</h2>

            
                <div class="form-group">
                    <label for="flow_rate">Influent Flow Rate (Q, m¬≥/day)</label>
                    <input type="number" id="flow_rate" class="form-input" step="any" min="0" placeholder="e.g., 10000">
                </div>
                <div class="form-group">
                    <label for="mlss">MLSS Concentration (X, g/m¬≥)</label>
                    <input type="number" id="mlss" class="form-input" step="any" min="0" placeholder="e.g., 2500">
                </div>
            

            
                <div class="form-group">
                    <label for="return_biomass">Return Sludge Concentration (Xr, g/m¬≥)</label>
                    <input type="number" id="return_biomass" class="form-input" step="any" min="0" placeholder="e.g., 8000">
                </div>
        

            <button class="calculate-btn" onclick="calculateRecirculationRate()">Calculate Qr</button>
        </div>

        <!-- Result Card -->
        <div class="result-card">
            <div class="result-placeholder" id="placeholder">
                <img src="/static/images/mlc_environment_result.png" alt="Wastewater treatment illustration">
                <p>This tool calculates sludge recirculation rate for wastewater treatment optimization.</p>
            </div>

            <div class="result-error hidden" id="resultError">
                <div class="error-icon">‚ùå</div>
                <div class="error-message" id="errorMessage"></div>
            </div>

            <div class="result-value hidden" id="resultValue">
                <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                    <h2>Sludge Recirculation Rate (Qr)</h2>
                </div>

                <div class="rate-display">
                    <div class="rate-value" id="qrValue">0.000</div>
                    <div class="rate-unit">m¬≥/day</div>
                </div>

                <div class="result-feedback">
                    <div class="feedback-title"> Assessment</div>
                    <div class="feedback-content" id="feedbackContent"></div>
                </div>

                <div class="btn-wrapper">
                    <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes -->
    <div class="note-section">

    <div class="note-card">
        <h3>üìò About This Calculator</h3>
        <p>
            The <strong>Sludge Recirculation Rate (Qr) Calculator</strong> determines the optimal rate for returning activated sludge 
            from the clarifier back to the aeration tank in wastewater treatment plants. Proper recirculation is essential 
            for maintaining adequate biomass concentration, ensuring efficient organic matter removal, and achieving 
            regulatory compliance for effluent quality.
        </p>
    </div>

    <div class="note-card">
        <h3>‚öô Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Q (Influent Flow Rate):</strong> Daily wastewater flow entering the treatment plant (m¬≥/day).</li>
            <li><strong>X (MLSS Concentration):</strong> Mixed Liquor Suspended Solids concentration in the aeration tank (g/m¬≥).</li>
            <li><strong>Xr (Return Sludge Concentration):</strong> Biomass concentration in the return sludge stream (g/m¬≥).</li>
        </ul>
    </div>


    <div class="note-card">
        <h3>‚úÖ Input Validation Rules</h3>
        <ul class="note-list">
            <li><strong>Influent Flow Rate (Q):</strong> Must be > 0 m¬≥/day (typical range: 100-1,000,000 m¬≥/day).</li>
            <li><strong>MLSS Concentration (X):</strong> Must be > 0 g/m¬≥ (typical range: 1500-5000 g/m¬≥).</li>
            <li><strong>Return Sludge Concentration (Xr):</strong> Must be > X g/m¬≥ (typical range: 4000-15000 g/m¬≥).</li>
            <li><strong>Xr Maximum:</strong> Should not exceed 20,000 g/m¬≥ without special thickening.</li>
            <li><strong>Unit Consistency:</strong> All concentrations must be in g/m¬≥ and flow in m¬≥/day.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>üîé Output Validations</h3>
        <ul class="note-list">
            <li><strong>Qr must be finite:</strong> If result is NaN or Infinity ‚Üí ‚ùå Invalid result, check inputs.</li>
            <li><strong>Qr > Q √ó 1.5:</strong> ‚ö†Ô∏è High recirculation ‚Üí Check for possible excessive sludge return.</li>
            <li><strong>Q √ó 0.3 ‚â§ Qr ‚â§ Q √ó 1.5:</strong> ‚úÖ Optimal recirculation ‚ÜíSludge return rate is within typical operational range.</li>
            <li><strong>Qr < Q √ó 0.3:</strong> ‚ö†Ô∏è Low recirculation ‚Üí May not maintain sufficient biomass in aeration tank.</li>
            <li><strong>Qr = 0:</strong> ‚ÑπÔ∏è No recirculation needed (theoretical case when Xr = X).</li>
            <li><strong>Negative Qr:</strong> ‚ùå Impossible scenario ‚Üí Xr must be greater than X.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>üìèStandards & Compliance </h3>
        <ul class="note-list">
            <li>‚úîÔ∏è Design parameters follow <strong>WEF MOP 8</strong> standards for wastewater treatment.</li>
            <li>‚úîÔ∏è Concentration ranges align with <strong>EPA guidelines</strong> for activated sludge processes.</li>
            <li>‚úîÔ∏è All values use <strong>standard wastewater engineering units</strong> (m¬≥/day, g/m¬≥).</li>
            <li>‚úîÔ∏è Calculations support <strong>environmental compliance</strong> for effluent discharge standards.</li>
            <li>‚úîÔ∏è Validations based on <strong>industry best practices</strong> for process control and optimization.</li>
        </ul>
    </div>

</div>
<script>
function showErrors(errors) {
    const errorBox = document.getElementById("resultError");
    const errorMessage = document.getElementById("errorMessage");
    const placeholder = document.getElementById("placeholder");
    const resultValue = document.getElementById("resultValue");

    errorMessage.innerHTML = errors.join("<br>");
    errorBox.classList.remove("hidden");
    placeholder.classList.add("hidden");
    resultValue.classList.add("hidden");
}

function calculateRecirculationRate() {
    // Read values
    const Q = parseFloat(document.getElementById("flow_rate").value);
    const X = parseFloat(document.getElementById("mlss").value);
    const Xr = parseFloat(document.getElementById("return_biomass").value);

    const qrValueEl = document.getElementById("qrValue");
    const feedbackEl = document.getElementById("feedbackContent");
    document.getElementById("resultError").classList.add("hidden");
    feedbackEl.innerHTML = "";

    const errors = [];
    const warnings = [];

    // Validation
    if (![Q, X, Xr].every(Number.isFinite)) {
        return showErrors(["üëâ Please enter all values (numeric)."]);
    }
    
    if (Q <= 0) errors.push("üëâ Influent flow rate (Q) must be > 0 m¬≥/day.");
    if (X <= 0) errors.push("üëâ MLSS concentration (X) must be > 0 g/m¬≥.");
    if (Xr <= 0) errors.push("üëâ Return sludge concentration (Xr) must be > 0 g/m¬≥.");
    if (Xr <= X) errors.push("üëâ Return sludge concentration (Xr) must be greater than MLSS concentration (X).");
    
    // Warning for unusual values
    if (Q > 1000000) warnings.push("‚ö†Ô∏è Influent flow rate unusually high (>1,000,000 m¬≥/day).");
    if (X < 1000 || X > 6000) warnings.push("‚ö†Ô∏è MLSS concentration outside typical range (1000-6000 g/m¬≥).");
    if (Xr > 20000) warnings.push("‚ö†Ô∏è Return sludge concentration unusually high (>20,000 g/m¬≥).");
    if (Xr < 3000) warnings.push("‚ö†Ô∏è Return sludge concentration unusually low (<3,000 g/m¬≥).");

    if (errors.length) return showErrors(errors);

    // Formula: Qr = (Q √ó X) / (Xr - X)
    const Qr = (Q * X) / (Xr - X);

    if (!Number.isFinite(Qr)) {
        return showErrors(["‚ö†Ô∏è Computed recirculation rate is invalid (possible division error)."]);
    }

    if (Qr < 0) {
        return showErrors(["‚ùå Negative recirculation rate calculated. Xr must be greater than X."]);
    }

    // Classification
    let classification, suggestion, color;
    if (Qr > Q * 1.5) {
        classification = "High Recirculation";
        suggestion = "‚ö†Ô∏è Check for possible excessive sludge return or low Xr concentration.";
        color = "#e65100";
    } else if (Qr >= Q * 0.3) {
        classification = "Optimal Recirculation";
        suggestion = "‚úÖ Sludge return rate is within typical operational range.";
        color = "#2e7d32";
    } else {
        classification = "Low Recirculation";
        suggestion = "‚ö†Ô∏è May not maintain sufficient biomass in aeration tank.";
        color = "#c62828";
    }

    // Calculate recirculation ratio
    const recirculationRatio = (Qr / Q).toFixed(2);

    // Display result
    qrValueEl.textContent = Qr.toFixed(2);
    feedbackEl.innerHTML = `
        <div>Q<sub>r</sub> = <b>${Qr.toFixed(2)}</b> m¬≥/day</div>
        <div>Recirculation Ratio (Qr/Q): <b>${recirculationRatio}</b></div>
        <div>Classification: <b style="color:${color};">${classification}</b></div>
        <div style="margin-top:6px;">${suggestion}</div>
        ${warnings.length ? `<div style="margin-top:8px; color:#b35d00;">${warnings.join(" | ")}</div>` : ""}
    `;

    document.getElementById("placeholder").classList.add("hidden");
    document.getElementById("resultValue").classList.remove("hidden");
}

function printReport() {
    const el = document.getElementById('printDate');
    if (el) el.textContent = new Date().toLocaleDateString();
    window.print();
}
</script>
<script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}
<!--

Input Validations:
Influent Flow Rate (Q): Must be > 0 m¬≥/day (typical range: 100-1,000,000 m¬≥/day)

MLSS Concentration (X): Must be > 0 g/m¬≥ (typical range: 1500-5000 g/m¬≥)

Return Sludge Concentration (Xr): Must be > X g/m¬≥ (typical range: 4000-15000 g/m¬≥)

Xr Maximum: Should not exceed 20,000 g/m¬≥ without special thickening

Unit Consistency: All concentrations in g/m¬≥, flow in m¬≥/day
---------------------------------------------------------------------------------------
Output Validations:
Qr must be finite: NaN or Infinity indicates invalid inputs

Qr > Q √ó 1.5: High recirculation (warning)

Q √ó 0.3 ‚â§ Qr ‚â§ Q √ó 1.5: Optimal recirculation range

Qr < Q √ó 0.3: Low recirculation (warning)

Qr = 0: No recirculation needed (theoretical)

Negative Qr: Impossible scenario (error)
--------------------------------------------------------------------------------------
Edge Cases:
Xr very close to X: Results in extremely high Qr values

Very high X values: Near maximum practical concentrations

Very low X values: Below typical operational range

Extremely high flow rates: Large municipal plants

Division by zero prevention: Xr must be greater than X

----------------------------------------------------------------------------------------
The code calculates the Sludge Recirculation Rate (Qr) for activated sludge wastewater treatment systems using a mass balance approach:

Formula
text
Qr = (Q √ó X) / (Xr - X)
Variables
Q = Influent flow rate (m¬≥/day)

X = Mixed Liquor Suspended Solids (MLSS) concentration in aeration tank (g/m¬≥)

Xr = Return sludge concentration (g/m¬≥)

Qr = Sludge recirculation rate (m¬≥/day)




-->