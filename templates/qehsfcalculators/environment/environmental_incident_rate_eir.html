{% extends 'base.html' %}
{% block title %}Environmental Incident rate (EIR) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environmental Incident rate (EIR) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0px 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background: linear-gradient(#1560bd, #000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center;
            flex-wrap: wrap;
        }

        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        .rate-label { 
            color: #7f8c8d;
            font-size: 20px;
            font-weight: bold;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .rate-value {
                font-size: 38px;
            }
            .rate-label {
                font-size: 18px;
            }
        }
        
        @media (max-width: 992px) {
            .rate-value {
                font-size: 34px;
            }
            .rate-label {
                font-size: 17px;
            }
        }
        
        @media (max-width: 768px) {
            .rate-value {
                font-size: 30px;
                margin-bottom: 8px;
            }
            .rate-label {
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .rate-value {
                font-size: 28px;
                margin-bottom: 6px;
            }
            .rate-label {
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .rate-display {
                flex-direction: column;
                gap: 2px;
                text-align: center;
            }
            .rate-value {
                font-size: 24px;
                margin-bottom: 4px;
            }
            .rate-label {
                font-size: 14px;
            }
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>

<div class="btn-container">
        <a href="{% url 'environmentcategory_calculators' %}" class="back-btn">Back To Environment Calculators</a>
</div>

<div class="calculator-container printable" id="printArea">
    {% include "includes/print_header_footer.html" %}

<div class="calculator-header">
  <h1>Environmental Incident Rate (EIR) Calculator</h1>
  <p>
    Assess environmental performance by calculating incident frequency per <strong>1,000 units of production</strong>.
    Useful for QEHS/ESG audits, KPI dashboards, and management reviews.
  </p>
</div>

<div class="calc-content">
  <!-- Calculator -->
  <div class="calc-card">
    <h2>Enter Data</h2>

    <div class="form-group">
      <label for="environmentalIncidents">Total Environmental Incidents (count)</label>
      <input type="number" id="environmentalIncidents" class="form-input" min="0" step="1" placeholder="e.g., 3">
    </div>

    <div class="form-group">
      <label for="productionOutput">Total Production Output (units)</label>
      <input type="number" id="productionOutput" class="form-input" min="0.001" step="0.001" placeholder="e.g., 250000 (barrels / tons / units)">
    </div>

    <button class="calculate-btn" onclick="calculateEIR()">Calculate EIR</button>
  </div>

  <!-- Result Section -->
  <div class="result-card">
    <div class="result-placeholder" id="placeholder">
      <img src="/static/images/mlc_environment_result.png" alt="EIR illustration">
      <p>This tool calculates <strong>Environmental Incident Rate (EIR)</strong> per <strong>1,000 production units</strong>.</p>
    </div>

    <div class="result-error hidden" id="resultError">
      <div class="error-icon">❌</div>
      <div class="error-message" id="errorMessage"></div>
    </div>

    <div class="result-value hidden" id="resultValue">
      <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
        <h2>Calculated EIR</h2>
      </div>

      <div class="rate-display">
        <div class="rate-value" id="rateValue">0.00</div>
        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">incidents / 1,000 units</div>
      </div>

      <div class="result-feedback">
        <div class="feedback-title">Assessment</div>
        <div class="feedback-content" id="feedbackContent"></div>
      </div>
      <div class="btn-wrapper">
        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
      </div>
    </div>
  </div>
</div>

<!-- Notes Section -->
<div class="note-section">

  <!-- 1. About This Calculator -->
  <div class="note-card">
    <h3>📘 About This Calculator</h3>
    <p>
      This <strong>Environmental Incident Rate (EIR) Calculator</strong> expresses how often environmental incidents occur relative to output,
      normalized per <strong>1,000 production units</strong>. It is useful for trend analysis, benchmarking,
      and regulatory/ESG reporting across sites with different volumes.
    </p>
  </div>

  <!-- 2. Parameters Used -->
  <div class="note-card">
    <h3>⚙ Parameters Used</h3>
    <ul class="note-list">
      <li><strong>Total Environmental Incidents:</strong> number of reportable environmental incidents.</li>
      <li><strong>Production Output:</strong> total units produced in the same period.</li>
      <li><strong>Normalization Base:</strong> 1,000 units (EIR = incidents per 1,000 units).</li>
    </ul>
  </div>

  <!-- 3. Input Validation Rules -->
  <div class="note-card">
    <h3>✅ Input Validation Rules</h3>
    <ul>
      <li>✔️ Incidents: required, whole number, 0–100,000.</li>
      <li>✔️ Production Output: required, &gt; 0, ≤ 1,000,000,000 units.</li>
      <li>❌ Decimals in incident count are not allowed.</li>
      <li>❌ Zero or negative production output is invalid (prevents divide-by-zero).</li>
      <li>⚠️ Very small output (&lt; 1,000 units) → statistical instability warning.</li>
      <li>⚠️ Extremely high EIR (&gt; 10 per 1,000) → verify incident classification and duplicates.</li>
    </ul>
  </div>

  <!-- 4. Output Validations / Assessment -->
  <div class="note-card">
    <h3>✅ Output Validations</h3>
    <ul>
      <li>EIR must be finite and ≥ 0.</li>
      <li>Warning if EIR &gt; 10 per 1,000 units (extremely high, verify inputs).</li>
      <li><strong>Environmental Impact Assessment:</strong>
        <ul>
          <li>Very Low (&lt; 0.10 per 1,000 units): ✅ Excellent environmental performance.</li>
          <li>Low (0.10–0.50 per 1,000 units): ✅ Good performance – maintain controls.</li>
          <li>Moderate (0.50–1.50 per 1,000 units): ⚠️ Needs improvement – review controls and training.</li>
          <li>High (&gt; 1.50 per 1,000 units): ❌ High risk – investigate and implement corrective actions.</li>
        </ul>
      </li>
      <li>Warnings related to input/output consistency are also displayed here.</li>
    </ul>
  </div>

  <!-- 5. Governing Principle -->
  <div class="note-card">
    <h3>📖 Governing Principle</h3>
    <p>
      An Environmental Incident Rate (EIR) Calculator isn't tied to a single universal standard like the OSHA Incident Rate or Indian Standard IS 3786 for industrial injuries, 
      as "EIR" is not a standardized term. Instead, EIRs are calculated based on specific organizational needs and regulatory frameworks, 
      such as those outlined by the European Medicines Agency (EMA) for environmental risk assessments, 
      or through the definition of custom "Environmental Incident" metrics.
    </p>
  </div>

  <!-- 6. Conclusion -->
  <div class="note-card">
    <h3>📝 Conclusion</h3>
    <p>
      The EIR provides a simple, normalized measure of environmental performance that can highlight areas for improvement, 
      track trends over time, and support decision-making for incident prevention and compliance.
    </p>
  </div>

</div>


<script>
/* Reusable error display */
function showErrors(errors) {
  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");

  errorMessage.innerHTML = errors.join("<br>");
  errorBox.classList.remove("hidden");
  placeholder.classList.add("hidden");
  resultValue.classList.add("hidden");
}

/* EIR calculation with robust validations (per 1,000 units) */
function calculateEIR() {
  const incidentsRaw = (document.getElementById("environmentalIncidents").value || "").trim();
  const outputRaw = (document.getElementById("productionOutput").value || "").trim();

  const errorBox = document.getElementById("resultError");
  const errorMessage = document.getElementById("errorMessage");
  const placeholder = document.getElementById("placeholder");
  const resultValue = document.getElementById("resultValue");
  const rateEl = document.getElementById("rateValue");
  const feedbackEl = document.getElementById("feedbackContent");

  // reset UI
  errorBox.classList.add("hidden");
  errorMessage.innerHTML = "";
  feedbackEl.innerHTML = "";

  const errors = [];
  const warnings = [];

  // presence
  if (!incidentsRaw) errors.push("👉 Please enter Total Environmental Incidents (whole number).");
  if (!outputRaw) errors.push("👉 Please enter Total Production Output (units).");
  if (errors.length) return showErrors(errors);

  // parse
  const incidents = Number(incidentsRaw);
  const output = Number(outputRaw);

  // numeric checks
  if (!Number.isFinite(incidents)) errors.push("👉 Incidents must be a valid number.");
  if (!Number.isFinite(output)) errors.push("👉 Production output must be a valid number.");
  if (errors.length) return showErrors(errors);

  // integer-only for incidents
  if (!Number.isInteger(incidents)) {
    errors.push("👉 Incidents must be a whole number (no decimals).");
  }

  // range checks (hard)
  if (incidents < 0 || incidents > 100000) {
    errors.push("👉 Incidents must be between 0 and 100,000.");
  }
  if (output <= 0 || output > 1000000000) {
    errors.push("👉 Production output must be > 0 and ≤ 1,000,000,000 units.");
  }

  // optional precision check for output (avoid false precision)
  const outputDecimals = (outputRaw.split(".")[1] || "").length;
  if (outputDecimals > 3) {
    warnings.push("⚠️ Production output has more than 3 decimal places – rounding may be appropriate for KPI reporting.");
  }

  if (errors.length) return showErrors(errors);

  // advisories / best-practice warnings
  if (output < 1000) {
    warnings.push("⚠️ Very small output – EIR may be statistically unstable.");
  }
  if (incidents > 1000) {
    warnings.push("⚠️ Unusually high incident count – verify classification and deduplication.");
  }
  if (incidents === 0 && output < 5000) {
    warnings.push("⚠️ Zero incidents with very small output – confirm observation period and reporting scope.");
  }

  // compute EIR (incidents per 1,000 units)
  const NORMALIZER = 1000;
  const eir = (incidents * NORMALIZER) / output;

  if (!Number.isFinite(eir) || eir < 0) {
    return showErrors(["⚠️ Computed EIR is invalid. Check inputs."]);
  }

  // classification
  let statusMsg = "";
  if (eir === 0) {
    statusMsg = "✅ Perfect: No reportable incidents in the period.";
  } else if (eir < 0.10) {
    statusMsg = "✅ Excellent performance.";
  } else if (eir < 0.50) {
    statusMsg = "🟢 Good performance – maintain controls.";
  } else if (eir < 1.50) {
    statusMsg = "🟡 Needs improvement – review controls and training.";
  } else {
    statusMsg = "🔴 High risk – investigate and implement corrective actions.";
  }

  if (eir > 10) warnings.push("⚠️ Extremely high EIR – immediate management review recommended.");

  // details (formatted numbers)
  const fmt = (n, d=0) => Number(n).toLocaleString(undefined, {maximumFractionDigits: d});
  const fmtFixed = (n, d=2) => Number(n).toLocaleString(undefined, {minimumFractionDigits: d, maximumFractionDigits: d});

  let details = `<div>EIR: <b>${fmtFixed(eir, 2)}</b> incidents per 1,000 units</div>`;

  if (warnings.length) {
    details += `<div style="margin-top:6px; color:#b35d00; font-size:0.95em;">${warnings.join(" | ")}</div>`;
  }

  // update UI
  rateEl.textContent = fmtFixed(eir, 2);
  document.querySelector(".rate-label").textContent = "incidents / 1,000 units";
  feedbackEl.innerHTML = `<div>${statusMsg}</div>${details}`;

  placeholder.classList.add("hidden");
  resultValue.classList.remove("hidden");
  errorBox.classList.add("hidden");
}

function printReport() {
  const el = document.getElementById('printDate');
  if (el) {
    const now = new Date();
    el.textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  }
  window.print();
}
</script>


    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}

<!-- /*
==========================================================
📌 Environmental Incident Rate (EIR) Calculator
==========================================================

🔹 Formula:
    EIR = (Total Environmental Incidents × 1,000) / Total Production Output

    - Units: incidents per 1,000 production units
    - Normalization base: 1,000 units

----------------------------------------------------------
🔹 Input Validations:

1. Total Environmental Incidents (required):
   - Must be provided
   - Must be an integer (whole number, no decimals)
   - Range: 0 ≤ incidents ≤ 100,000

2. Total Production Output (required):
   - Must be provided
   - Must be numeric
   - Range: 0 < output ≤ 1,000,000,000 units
   - Decimal precision > 3 places → warning (avoid false precision)

----------------------------------------------------------
🔹 Cross-field / Advisories:
- Output < 1,000 → warn: "Very small output – EIR may be statistically unstable."
- Incidents > 1,000 → warn: "Unusually high incident count – verify classification/deduplication."
- Incidents = 0 AND output < 5,000 → warn: "Zero incidents with very small output – confirm reporting scope."

----------------------------------------------------------
🔹 Output Validations:
- Computed EIR must be finite and ≥ 0
- If invalid → throw error
- EIR > 10 → warning: "Extremely high – immediate management review needed"

----------------------------------------------------------
🔹 Classification by EIR:
- EIR = 0        → ✅ Perfect: No reportable incidents
- EIR < 0.10     → ✅ Excellent performance
- EIR < 0.50     → 🟢 Good performance – maintain controls
- EIR < 1.50     → 🟡 Needs improvement – review controls/training
- EIR ≥ 1.50     → 🔴 High risk – investigate and act

----------------------------------------------------------
🔹 Output Details:
- EIR (to 2 decimals)
- Total Incidents (formatted integer)
- Total Production Output (formatted up to 3 decimals)
- Normalization Base = 1,000 units
- Warnings appended if applicable

==========================================================
*/ -->
