{% extends 'base.html' %}
{% block title %}Process Capability (Cp, Cpk) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Capability (Cp, Cpk) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
                
.result-card::-webkit-scrollbar {
    width: 8px;
}

.result-card::-webkit-scrollbar-thumb {
    background: #1560bd;
    border-radius: 6px;
}

.result-card::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.result-card {
    justify-content: flex-start; /* align from top */
    align-items: stretch;
    min-height: 420px;
    text-align: center;
    overflow-y: auto;       /* Enable vertical scrolling */
    max-height: 450px;      /* Set max height to control output size */
    padding: 20px;          /* keep spacing */
}

        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .formula-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 6px solid #0d47a1;
        }
        
        .formula-card code {
            display: inline-block;
            background: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #0d47a1;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }

        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }
        
        /* Cp/Cpk specific styles */
        .cp-results {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .cp-result-item {
            background: linear-gradient(135deg, #1560bd, #000040);
            color: white;
            padding: 20px;
            border-radius: 12px;
            min-width: 120px;
        }
        
        .cp-result-item h3 {
            margin: 0 0 10px;
            font-size: 18px;
        }
        
        .cp-result-value {
            font-size: 32px;
            font-weight: 700;
        }
        
        .feedback-alert {
            background: #e3f2fd;
            border-left: 4px solid #1976d2;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'qualitycategory_calculators' %}" class="back-btn">Back To Quality Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Process Capability (Cp, Cpk) Calculator</h1>
            <p>Calculates the process capability indices Cp and Cpk to evaluate how well a process meets specification limits</p>
        </div>

        <div class="calc-content">
            <!-- Calculator Input Card -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="usl">Upper Specification Limit (USL)</label>
                    <input type="number" id="usl" class="form-input" step="0.01" placeholder="Enter USL">
                </div>

                <div class="form-group">
                    <label for="lsl">Lower Specification Limit (LSL)</label>
                    <input type="number" id="lsl" class="form-input" step="0.01" placeholder="Enter LSL">
                </div>

                <div class="form-group">
                    <label for="mean">Process Mean (μ)</label>
                    <input type="number" id="mean" class="form-input" step="0.01" placeholder="Enter process mean">
                </div>

                <div class="form-group">
                    <label for="sigma">Standard Deviation (σ)</label>
                    <input type="number" id="sigma" class="form-input" step="0.01" min="0.01" placeholder="Enter standard deviation">
                </div>

                <button class="calculate-btn" onclick="calculateCpCpk()">Calculate Cp and Cpk</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Quality control illustration">
                    <p>This tool calculates the <strong>process capability indices Cp and Cpk</strong>. Enter your specification limits, process mean, and standard deviation to see results.</p>
                </div>

                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>

                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" style="font-weight:bold; font-size:16px; margin-bottom:15px; color:#1560bd;">
                        <h2>Process Capability Results</h2>
                    </div>
                    
                    <div class="cp-results">
                        <div class="cp-result-item">
                            <h3>Cp</h3>
                            <div class="cp-result-value" id="cpValue">0.00</div>
                        </div>
                        <div class="cp-result-item">
                            <h3>Cpk</h3>
                            <div class="cp-result-value" id="cpkValue">0.00</div>
                        </div>
                    </div>
                    
                    <div class="result-feedback">
                        <div class="feedback-title">Process Capability Interpretation</div>
                        <div class="feedback-content" id="capabilityFeedback"></div>
                    </div>
                    
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>🔎 About This Calculator</h3>
                <p>
                    The <strong>Process Capability Calculator</strong> evaluates how well a process can produce outputs within specified limits by calculating Cp (potential capability) and Cpk (actual capability) indices. These metrics are critical for quality control and process improvement in manufacturing and service industries.
                </p> 
            </div>
            
            <div class="note-card">
                <h3>📌 Input Validations</h3>
                <ul class="note-list">
                    <li><strong>Upper Specification Limit (USL):</strong> Required, must be greater than LSL</li>
                    <li><strong>Lower Specification Limit (LSL):</strong> Required, must be less than USL</li>
                    <li><strong>Process Mean (μ):</strong> Required, must be between LSL and USL for meaningful results</li>
                    <li><strong>Standard Deviation (σ):</strong> Required, must be > 0</li>
                </ul>
            </div>

            <div class="note-card">
                <h3>❓ Explanation of Parameters</h3>
                <ul class="note-list">
                    <li><strong>Upper Specification Limit (USL):</strong> The maximum acceptable value for the process output.</li>
                    <li><strong>Lower Specification Limit (LSL):</strong> The minimum acceptable value for the process output.</li>
                    <li><strong>Process Mean (μ):</strong> The average value of the process output.</li>
                    <li><strong>Standard Deviation (σ):</strong> A measure of the variability in the process output.</li>
                    <li><strong>Cp (Process Capability):</strong> Measures the potential capability by comparing process spread to specification limits.</li>
                    <li><strong>Cpk (Process Capability Index):</strong> Considers both variability and how centered the process is between limits.</li>
                </ul>
            </div>
            

            <div class="note-card">
                <h3>📊 Interpretation Guidelines</h3>
                <ul class="note-list">
                    <li><strong>Cp/Cpk < 1.0:</strong> Process is not capable - outputs frequently exceed specification limits</li>
                    <li><strong>Cp/Cpk = 1.0-1.33:</strong> Process is marginally capable but requires close monitoring</li>
                    <li><strong>Cp/Cpk > 1.33:</strong> Process is capable and meets quality standards</li>
                    <li><strong>Cp/Cpk > 2.0:</strong> Process is considered excellent (Six Sigma quality)</li>
                    <li><strong>Cp > Cpk:</strong> Process is capable but not centered between specification limits</li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>📈 Real-Life Applications</h3>
                <ul class="note-list">
                    <li><strong>Manufacturing Quality Control:</strong> Monitor production processes to ensure consistent output quality.</li>
                    <li><strong>Supplier Evaluation:</strong> Assess capability of suppliers to meet specification requirements.</li>
                    <li><strong>Process Improvement:</strong> Identify opportunities to reduce variation and improve centering.</li>
                    <li><strong>New Process Validation:</strong> Verify that new processes meet capability requirements before full implementation.</li>
                </ul>
            </div>
            
            <div class="note-card">
                <h3>💡 Conclusion</h3>
                <p>Process capability analysis is essential for maintaining and improving quality in any organization. By regularly calculating and monitoring Cp and Cpk values, businesses can identify processes that need improvement, reduce defects, and ensure customer satisfaction. A capable process (Cpk ≥ 1.33) not only produces fewer defects but also operates more efficiently and predictably.</p>
            </div>
        </div>
    </div>

    <script>
        function calculateCpCpk() {
            // Get input values
            const usl = document.getElementById("usl").value.trim();
            const lsl = document.getElementById("lsl").value.trim();
            const mean = document.getElementById("mean").value.trim();
            const sigma = document.getElementById("sigma").value.trim();

            // Get DOM elements for results and errors
            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValue = document.getElementById('resultValue');
            const cpValue = document.getElementById('cpValue');
            const cpkValue = document.getElementById('cpkValue');
            const feedbackBox = document.getElementById('capabilityFeedback'); 

            let errors = [];
            let warnings = [];

            // Validate inputs
            if (usl === "") errors.push("👉 Please enter the Upper Specification Limit (USL).");
            else if (isNaN(usl)) errors.push("👉 USL must be a number.");
            
            if (lsl === "") errors.push("👉 Please enter the Lower Specification Limit (LSL).");
            else if (isNaN(lsl)) errors.push("👉 LSL must be a number.");
            
            if (mean === "") errors.push("👉 Please enter the Process Mean (μ).");
            else if (isNaN(mean)) errors.push("👉 Process Mean must be a number.");
            
            if (sigma === "") errors.push("👉 Please enter the Standard Deviation (σ).");
            else if (isNaN(sigma)) errors.push("👉 Standard Deviation must be a number.");
            else if (parseFloat(sigma) <= 0) errors.push("👉 Standard Deviation must be greater than 0.");

            // Check if all inputs are valid numbers
            if (errors.length === 0) {
                const uslNum = parseFloat(usl);
                const lslNum = parseFloat(lsl);
                const meanNum = parseFloat(mean);
                const sigmaNum = parseFloat(sigma);
                
                // Additional validation
                if (uslNum <= lslNum) {
                    errors.push("👉 USL must be greater than LSL.");
                }
                
                if (meanNum < lslNum || meanNum > uslNum) {
                    warnings.push("⚠️ Process mean is outside specification limits. This indicates a high defect rate.");
                }
            }

            // Show errors if any
            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValue.classList.add("hidden");
                return;
            } else {
                errorBox.classList.add("hidden");
            }

            // Calculate Cp and Cpk
            const uslNum = parseFloat(usl);
            const lslNum = parseFloat(lsl);
            const meanNum = parseFloat(mean);
            const sigmaNum = parseFloat(sigma);
            
            const Cp = (uslNum - lslNum) / (6 * sigmaNum);
            const Cpu = (uslNum - meanNum) / (3 * sigmaNum);
            const Cpl = (meanNum - lslNum) / (3 * sigmaNum);
            const Cpk = Math.min(Cpu, Cpl);

            // Update result display
            cpValue.textContent = Cp.toFixed(4);
            cpkValue.textContent = Cpk.toFixed(4);

            // Generate feedback
            let feedback = "";
            
            if (Cp < 1) {
                feedback += `<div class="feedback-alert">The process is not capable (Cp < 1). High variation causes outputs to exceed specification limits, resulting in defects.</div>`;
            }
            
            if (Cpk < 1) {
                feedback += `<div class="feedback-alert">The process is not centered or is too variable (Cpk < 1). Outputs frequently exceed specification limits.</div>`;
            }
            
            if (Cp >= 1.33 && Cpk >= 1.33) {
                feedback += `<div class="feedback-alert" style="background: #e8f5e9; border-left-color: #4caf50;">The process is capable and centered (Cp ≥ 1.33 and Cpk ≥ 1.33).</div>`;
            } else if (Cp >= 1.33 && Cpk < 1.33) {
                feedback += `<div class="feedback-alert">The process is capable but not centered (Cp ≥ 1.33 and Cpk < 1.33). Consider adjusting the process mean.</div>`;
            }
            
            if (Cp > 2 && Cpk > 2) {
                feedback += `<div class="feedback-alert" style="background: #e8f5e9; border-left-color: #4caf50;">Excellent process capability (Six Sigma quality level).</div>`;
            }
            
            // Add warnings if any
            if (warnings.length > 0) {
                warnings.forEach(warning => {
                    feedback += `<div class="feedback-alert" style="background: #fff3e0; border-left-color: #ff9800;">${warning}</div>`;
                });
            }
            
            feedbackBox.innerHTML = feedback;

            // Show results
            placeholder.classList.add('hidden');
            resultValue.classList.remove('hidden');
        }
        
        function printReport() {
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}
<!--

Input Validation Rules:
Upper Specification Limit (USL)

Required field

Must be a valid number

Must be greater than LSL (USL > LSL)

Realistic range: Based on your process (e.g., 0.1 to 1000 for most manufacturing)

Decimal precision: Allow up to 6 decimal places for precision processes

Lower Specification Limit (LSL)

Required field

Must be a valid number

Must be less than USL (LSL < USL)

Realistic range: Context-dependent, but typically LSL ≥ 0 for physical measurements

Decimal precision: Allow up to 6 decimal places

Process Mean (μ)

Required field

Must be a valid number

Should ideally be between LSL and USL (though mathematically can be outside)

Decimal precision: Allow up to 6 decimal places

Standard Deviation (σ)

Required field

Must be a valid number > 0 (σ > 0)

Typically σ > 0.001 for most measurable processes

Maximum reasonable value: (USL - LSL)/2 (beyond this, process is extremely variable)

Decimal precision: Allow up to 6 decimal places

Cross-Field Dependencies:
USL must be greater than LSL

Process mean should ideally be between LSL and USL for a capable process

Standard deviation should be less than (USL - LSL)/6 for Cp > 1

Edge Cases:
Division by zero if σ = 0

USL = LSL (no tolerance range)

Extremely large or small values that don't represent real processes

Negative values for σ (mathematically impossible)

Output Validation & Interpretation
From a QEHS perspective, Cp and Cpk values should be interpreted as:

Cp/Cpk < 1.0: Process not capable - immediate corrective action required

Cp/Cpk = 1.0-1.33: Marginal capability - process requires close monitoring

Cp/Cpk > 1.33: Process is capable (industry standard)

Cp/Cpk > 2.0: Excellent capability (Six Sigma level)

-->
