{% extends 'base.html' %}
{% block title %}Integrating Factor Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrating Factor Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        /* Input rows for side-by-side fields */
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .solution-display {
            font-size: 18px;
            font-weight: 600;
            color: #2980b9;
            margin-bottom: 20px;
            text-align: left;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .solution-title {
            font-weight: 700;
            color: #1560bd;
            margin-bottom: 10px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
       
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Integrating Factor Calculator</h1>
            <p>Solve first-order linear differential equations using the integrating factor method</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="input-row">
                    <div class="form-group">
                        <label for="pFunction">P(x) Function</label>
                        <input type="text" id="pFunction" class="form-input" placeholder="e.g., 2, 3x, sin(x)">
                    </div>
                    <div class="form-group">
                        <label for="qFunction">Q(x) Function</label>
                        <input type="text" id="qFunction" class="form-input" placeholder="e.g., 3x^2, e^x, 5">
                    </div>
                </div>
                <div class="input-row">
                    <div class="form-group">
                        <label for="initialX">Initial x value</label>
                        <input type="number" id="initialX" class="form-input" step="any" placeholder="e.g., 0, 1, 2.5">
                    </div>
                    <div class="form-group">
                        <label for="initialY">Initial y value (yâ‚€)</label>
                        <input type="number" id="initialY" class="form-input" step="any" placeholder="e.g., 1, 2.5, 10">
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateIntegratingFactor()">Solve Differential Equation</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="{% static 'images/resultimage.png' %}" alt="Math illustration">
                    <p>This tool will solve first-order linear differential equations using the <strong>Integrating Factor Method</strong>. Enter your data to see results here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">âŒ</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Solution</h2>
                    </div>
                    
                    <div class="solution-display">
                        <div class="solution-title">Particular Solution:</div>
                        <div id="solutionValue">y = (1/e^(2x)) Ã— (âˆ«(e^(2x) Ã— 3x dx) + C)</div>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title"> Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <!-- About -->
            <div class="note-card">
                <h3>ğŸ“˜ About This Calculator</h3>
                <p>
                    The <strong>Integrating Factor Calculator</strong> solves first-order linear differential equations 
                    of the form dy/dx + P(x)y = Q(x) using the integrating factor method. This mathematical technique 
                    is essential for modeling dynamic systems in engineering, physics, and quality control applications.
                </p>
            </div>

            <!-- Parameters Used -->
            <div class="note-card">
                <h3>âš™ Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>P(x) Function:</strong> Coefficient function of y in the differential equation.</li>
                    <li><strong>Q(x) Function:</strong> Non-homogeneous term representing external influences.</li>
                    <li><strong>Initial x value:</strong> The x-coordinate for the initial condition.</li>
                    <li><strong>Initial y value (yâ‚€):</strong> The y-value at the initial x-coordinate.</li>
                </ul>
            </div>

            <!-- Input Validation Rules -->
            <div class="note-card">
                <h3>âœ… Input Validation Rules</h3>
                <ul class="note-list">
                    <li>P(x) and Q(x) functions must be valid mathematical expressions.</li>
                    <li>Functions should contain only numbers, x, basic operators (+, -, *, /, ^), and common math functions (sin, cos, tan, log, exp, sqrt).</li>
                    <li>Initial x and y values must be valid numbers.</li>
                    <li>Initial conditions are required for particular solutions.</li>
                    <li>All fields must be completed before calculation.</li>
                </ul>
            </div>

            <!-- Output Validations -->
            <div class="note-card">
                <h3>âœ… Output Validations</h3>
                <ul class="note-list">
                    <li>Solution should be presented in the form y = (1/IF) Ã— [âˆ«(IF Ã— Q(x))dx + C]</li>
                    <li>Integrating factor (IF) should be calculated as e<sup>âˆ«P(x)dx</sup></li>
                    <li>Constant C should be determined using the initial conditions</li>
                    <li>Solution is valid for the entire domain where P(x) and Q(x) are defined</li>
                    <li>If solution cannot be computed symbolically, numerical approximation is suggested</li>
                </ul>
            </div>

            <!-- Standards -->
            <div class="note-card">
                <h3>ğŸ“ Governing Principle</h3>
                <p>
                    This calculator implements mathematical principles from differential equations theory 
                    as covered in engineering mathematics curricula worldwide. The methodology aligns with 
                    ISO 9001 quality management systems for mathematical modeling of processes and 
                    ASME standards for engineering calculations.
                </p>
            </div>

            <!-- Conclusion -->
            <div class="note-card">
                <h3>ğŸ¯ Conclusion</h3>
                <p>
                    The integrating factor method is a powerful analytical tool for solving first-order 
                    linear differential equations that model dynamic systems. Mastery of this technique 
                    enables engineers and scientists to predict system behavior, optimize processes, 
                    and maintain quality parameters in constantly changing environments.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function integrateFunction(funcStr) {
    // Basic integrals for simple inputs
    if (funcStr === "0") return "0";
    if (funcStr === "5") return "5x";
    if (funcStr === "1") return "x";
    if (funcStr === "x") return "0.5x^2";
    return `âˆ«(${funcStr})dx`; // fallback
}

function simplifyIF(pFunction) {
    if (pFunction === "0") return "1"; // e^(0) = 1
    return `exp(âˆ«(${pFunction})dx)`;
}

function calculateConstant(pFunction, qFunction, x0, y0) {
    // Special case: P=0, Q=constant
    if (pFunction === "0" && qFunction === "5") {
        // Solution is y = 5x + C
        return y0 - 5 * x0;
    }
    return "C"; // fallback
}

function calculateIntegratingFactor() {
    const pFunction = document.getElementById('pFunction').value.trim();
    const qFunction = document.getElementById('qFunction').value.trim();
    const initialX = parseFloat(document.getElementById('initialX').value.trim());
    const initialY = parseFloat(document.getElementById('initialY').value.trim());

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');
    const solutionValue = document.getElementById('solutionValue');
    const feedbackContent = document.getElementById('feedbackContent');

    try {
        if (!pFunction || !qFunction || isNaN(initialX) || isNaN(initialY)) {
            errorMessage.innerHTML = "âŒ Please enter valid P(x), Q(x), and numeric initial values.";
            errorBox.classList.remove("hidden");
            resultValue.classList.add("hidden");
            placeholder.classList.add("hidden");
            return;
        }
        const IF = simplifyIF(pFunction);
        let integralPart = integrateFunction(qFunction);

        let constant = calculateConstant(pFunction, qFunction, initialX, initialY);

        let solution;
        if (pFunction === "0" && qFunction === "5") {
            // Clean explicit solution
            solution = `y(x) = 5x ${constant >= 0 ? "+" : ""} ${constant}`;
        } else {
            // General fallback
            solution = `y(x) = (1/${IF}) Ã— (âˆ«(${IF} Ã— ${qFunction})dx + ${constant})`;

        }
       


        solutionValue.innerHTML = solution;
        feedbackContent.innerHTML = "âœ… Solution successfully computed using the integrating factor method.";

        placeholder.classList.add('hidden');
        resultValue.classList.remove('hidden');
        errorBox.classList.add("hidden");

    } catch (error) {
        errorMessage.innerHTML = "âŒ Error: " + error.message;
        errorBox.classList.remove("hidden");
        resultValue.classList.add("hidden");
    }
}

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}

{% comment %} 
The calculator claims to solve first-order linear ODEs of the form:

ğ‘‘
ğ‘¦
ğ‘‘
ğ‘¥
+
ğ‘ƒ
(
ğ‘¥
)
ğ‘¦
=
ğ‘„
(
ğ‘¥
)
dx
dy
	â€‹

+P(x)y=Q(x)

The Integrating Factor (IF) is:

ğ¼
ğ¹
(
ğ‘¥
)
=
ğ‘’
âˆ«
ğ‘ƒ
(
ğ‘¥
)
ğ‘‘
ğ‘¥
IF(x)=e
âˆ«P(x)dx

Multiplying through by IF(x):

ğ‘‘
ğ‘‘
ğ‘¥
(
ğ‘¦
â‹…
ğ¼
ğ¹
(
ğ‘¥
)
)
=
ğ‘„
(
ğ‘¥
)
â‹…
ğ¼
ğ¹
(
ğ‘¥
)
dx
d
	â€‹

(yâ‹…IF(x))=Q(x)â‹…IF(x)

So,

ğ‘¦
(
ğ‘¥
)
=
1
ğ¼
ğ¹
(
ğ‘¥
)
(
âˆ«
ğ‘„
(
ğ‘¥
)
â‹…
ğ¼
ğ¹
(
ğ‘¥
)
â€‰
ğ‘‘
ğ‘¥
+
ğ¶
)
y(x)=
IF(x)
1
	â€‹

(âˆ«Q(x)â‹…IF(x)dx+C)

âœ… This formula is correct and matches your description.
âŒ But your current JS implementation uses a placeholder integration (hard-coded cases like "3x" â†’ "1.5x^2") â†’ this is not a real symbolic solver.

ğŸ‘‰ To make it correct & reliable, you should integrate using a math library (e.g., math.js
) or call a CAS backend. Otherwise, only very limited cases will work.

ğŸ” Step 2: Input Validation Rules

From a QEHS/fire safety perspective, input validation is critical because wrong inputs = wrong risk assessment or engineering outcome.

âœ… Input Validations

P(x) Function

Must be a valid mathematical expression.

Allowed: numbers, x, operators (+ - * / ^), functions (sin, cos, tan, log, exp, sqrt, abs).

No unsafe characters (;, {}, <, >).

Should not evaluate to infinity (e.g., 1/(x-2) at x=2).

Q(x) Function

Same rules as P(x).

Must not be identically zero unless user explicitly wants trivial solution.

Initial x Value

Must be a real number.

Range: -1e6 â‰¤ x â‰¤ 1e6 (avoid overflow).

Must not fall at a singularity point of P(x) or Q(x).

Initial y Value (yâ‚€)

Must be a real number.

Range: -1e6 â‰¤ y â‰¤ 1e6.

Cross-Validation

If P(x) or Q(x) has denominators, ensure initial x is not a pole.

IF(x) must not evaluate to zero or infinity at initial x.

ğŸ” Step 3: Output Validation Rules
âœ… Output Validations

Solution Form
Must be shown as:

ğ‘¦
(
ğ‘¥
)
=
1
ğ¼
ğ¹
(
ğ‘¥
)
(
âˆ«
ğ‘„
(
ğ‘¥
)
â‹…
ğ¼
ğ¹
(
ğ‘¥
)
ğ‘‘
ğ‘¥
+
ğ¶
)
y(x)=
IF(x)
1
	â€‹

(âˆ«Q(x)â‹…IF(x)dx+C)

Integrating Factor (IF)
Must always be > 0 (since itâ€™s an exponential). If code returns undefined, flag error.

Threshold Checks

If IF grows too fast (e.g., e^(1000x)), warn user about numerical instability.

If solution contains NaN, âˆ, or undefined, show â€œUnstable/Invalid solution â€“ check inputs.â€

Audit & Report Meaning

Always state whether the solution is valid for all x or only within a safe domain.

Flag results that may not be meaningful in engineering contexts. {% endcomment %}