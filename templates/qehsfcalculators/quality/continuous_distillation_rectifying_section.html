{% extends 'base.html' %}
{% block title %}Continuous Distillation (Rectifying Section) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Continuous Distillation (Rectifying Section) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background: linear-gradient(#1560bd, #000040);
            /* Dark navy background */
            color: #ffffff;
            /* White text */
            border: 2px solid #1560bd;
            /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
            /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }

        @media (max-width: 900px) {
            .calc-content {
                flex-direction: column;
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }

        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
        }

        .calc-card:hover {
            transform: translateY(-5px);
        }

        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Input rows for side-by-side fields */
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }

        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }

        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd, #000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }

        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }

        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }

        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: center;
        }

        .result-value {
            width: 100%;
        }

        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }

        .rate-label {
            color: #7f8c8d;
        }

        /* Meter */
        .safety-meter {
            width: 100%;
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }

        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }

        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }

        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .feedback-content {
            color: #34495e;
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .note-card:hover {
            transform: translateY(-2px);
        }

        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }

        .note-card p,
        .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }

        .note-list {
            margin: 0;
            padding-left: 18px;
        }

        .good {
            color: #2e7d32;
            font-weight: 600;
        }

        .average {
            color: #f9a825;
            font-weight: 600;
        }

        .bad {
            color: #c62828;
            font-weight: 600;
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }

        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }

        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden {
            display: none;
        }



        /* Reflux value display (new element) */
        .reflux-row {
            display: flex;
            gap: 10px;
            align-items: center;
            text-align: center;
            margin-top: 6px;
            font-size: 14px;
        }

        .reflux-label {
            font-weight: 600;
            color: #0b5aa6;
        }

        /* Meter (visual bar) */
        .safety-meter {
            width: 100%;
            height: 14px;
            background: linear-gradient(90deg, #eee 0%, #eee 100%);
            border-radius: 8px;
            overflow: hidden;
            margin: 10px 0;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        #meterFill {
            height: 100%;
            width: 0%;
            transition: width 450ms ease, background-color 250ms;
            border-radius: 8px;
        }

        /* Table styling for Output Validations section */
        .note-card table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        .note-card table th,
        .note-card table td {
            padding: 8px 10px;
            border: 1px solid #e6eef8;
            text-align: center;
        }

        .note-card table thead th {
            background: #1560bd;
            color: #fff;
            font-weight: 700;
            letter-spacing: 0.2px;
        }

        .note-card table tbody tr:nth-child(even) {
            background: #fbfdff;
        }

        /* Responsive small screens */
        @media (max-width: 720px) {
            .calc-content {
                flex-direction: column;
            }

            .rate-value {
                font-size: 22px;
            }
        }

        @media (max-width: 370px) {
            .note-card table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            .note-card table thead th,
            .note-card table tbody td {
                min-width: 100px;
            }

            .rate-value {
                font-size: 22px;
            }
        }
    </style>
</head>

<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Continuous Distillation (Rectifying Section) Calculator</h1>
            <p>Calculate vapor composition in the rectifying section of a distillation column</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="input-row">
                    <div class="form-group">
                        <label for="liquidFlow">Liquid Flow Rate (L<sub>n</sub>) [mol/h]</label>
                        <input type="number" id="liquidFlow" class="form-input" min="0" step="any"
                            placeholder="e.g., 100">
                    </div>
                    <div class="form-group">
                        <label for="distillateFlow">Distillate Flow Rate (D) [mol/h]</label>
                        <input type="number" id="distillateFlow" class="form-input" min="0.0001" step="any"
                            placeholder="e.g., 50">
                    </div>
                </div>
                <div class="input-row">
                    <div class="form-group">
                        <label for="liquidComposition">Liquid Composition (x<sub>n</sub>) [mole fraction]</label>
                        <input type="number" id="liquidComposition" class="form-input" min="0" max="1" step="0.001"
                            placeholder="e.g., 0.4">
                    </div>
                    <div class="form-group">
                        <label for="distillateComposition">Distillate Composition (x<sub>D</sub>) [mole
                            fraction]</label>
                        <input type="number" id="distillateComposition" class="form-input" min="0" max="1" step="0.001"
                            placeholder="e.g., 0.9">
                    </div>
                </div>

                <button class="calculate-btn" onclick="calculateRectifying()">Calculate Vapor Composition</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="{% static 'images/resultimage.png' %}" alt="Distillation illustration">
                    <p>This tool will calculate the <strong>Vapor Composition</strong> in the rectifying section. Enter
                        your data to see results and insights here.</p>
                </div>

                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>

                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType"
                        style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Vapor Composition</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.0000</div>
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Mole Fraction
                            (y‚Çô‚Çä‚ÇÅ)</div>
                    </div>
                    <!-- inside resultValue, after rate-display -->
                    <div class="reflux-row">
                        <div class="reflux-label">Reflux Ratio (R = L‚Çô / D):</div>
                        <div id="refluxValue">‚Äî</div>
                    </div>


                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low Purity</span><span>Moderate</span><span>Good</span><span>High Purity</span><span>Very
                            High</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title"> Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <!-- About -->
            <div class="note-card">
                <h3>üìò About This Calculator</h3>
                <p>
                    The <strong>Continuous Distillation (Rectifying Section) Calculator</strong> determines the vapor
                    composition
                    in the enriching section of a distillation column. This calculation is essential for designing and
                    analyzing
                    fractionation processes to ensure proper separation efficiency and product purity in chemical
                    manufacturing.
                </p>
            </div>

            <!-- Parameters Used -->
            <div class="note-card">
                <h3>‚öô Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>L<sub>n</sub> (Liquid Flow Rate):</strong> Flow rate of liquid returning from the
                        condenser [mol/h]</li>
                    <li><strong>D (Distillate Flow Rate):</strong> Product flow rate from the top of the column [mol/h]
                    </li>
                    <li><strong>x<sub>n</sub> (Liquid Composition):</strong> Mole fraction of more volatile component in
                        liquid (0-1)</li>
                    <li><strong>x<sub>D</sub> (Distillate Composition):</strong> Desired purity of the distillate
                        product (0-1)</li>
                </ul>
            </div>

            <!-- Input Validation Rules -->
            <div class="note-card">
                <h3>‚úÖ Input Validation Rules</h3>
                <ul class="note-list">
                    <li>Liquid Flow Rate (L<sub>n</sub>) must be ‚â• 0 mol/h</li>
                    <li>Distillate Flow Rate (D) must be > 0 mol/h</li>
                    <li>Liquid Composition (x<sub>n</sub>) must be between 0 and 1</li>
                    <li>Distillate Composition (x<sub>D</sub>) must be between 0 and 1</li>
                    <li>x<sub>D</sub> must be greater than x<sub>n</sub> for effective separation</li>
                    <li>Decimals up to 3 places allowed for accuracy</li>
                </ul>
            </div>

            <!-- Output Validations -->
            <!-- Output Validations -->
            <div class="note-card">
                <h3>‚úÖ Output Validations</h3>
                <p>The reflux ratio (R = L<sub>n</sub> / D) determines the separation quality. Use the guide below:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Reflux Ratio (R)</th>
                            <th>Category</th>
                            <th>Assessment</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>R &lt; 1</td>
                            <td style="color:#e74c3c;"><b>Low</b></td>
                            <td>Separation may be insufficient (Low Purity)</td>
                        </tr>
                        <tr>
                            <td>1 ‚â§ R &lt; 2</td>
                            <td style="color:#f39c12;"><b>Moderate</b></td>
                            <td>Acceptable for some operations (Moderate Purity)</td>
                        </tr>
                        <tr>
                            <td>2 ‚â§ R &lt; 3</td>
                            <td style="color:#f1c40f;"><b>Good</b></td>
                            <td>Balanced operation, reasonable energy use (Good Purity)</td>
                        </tr>
                        <tr>
                            <td>3 ‚â§ R &lt; 5</td>
                            <td style="color:#27ae60;"><b>High</b></td>
                            <td>High separation efficiency (High Purity)</td>
                        </tr>
                        <tr>
                            <td>R ‚â• 5</td>
                            <td style="color:#2ecc71;"><b>Very High</b></td>
                            <td>Maximum purity but very energy intensive (Very High)</td>
                        </tr>
                    </tbody>
                </table>
                <p style="margin-top:8px;"><i>‚ö†Ô∏è Note: Vapor composition (y‚Çô‚Çä‚ÇÅ) is separate from reflux ratio (R). Both
                        values must be interpreted together.</i></p>
            </div>


            <!-- Standards -->
            <div class="note-card">
                <h3>üìè Governing Principle</h3>
                <p>
                    This calculator is based on fundamental distillation principles and aligns with
                    <strong>API 12J</strong> (Specification for Oil and Gas Separators),
                    <strong>ASTM D2892</strong> (Standard Test Method for Distillation of Crude Petroleum),
                    and <strong>ISO 3405</strong> (Petroleum products - Determination of distillation characteristics).
                </p>
            </div>

            <!-- Conclusion -->
            <div class="note-card">
                <h3>üìù Conclusion</h3>
                <p>
                    The rectifying section equation is fundamental for chemical engineers designing continuous
                    distillation processes.
                    Understanding these relationships allows for better process control, higher product quality, and
                    more efficient
                    operation of fractionation columns in industrial applications including petroleum refining, chemical
                    manufacturing,
                    pharmaceuticals, and alcohol production.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function () {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateRectifying() {
            // Get input values
            const Ln = document.getElementById('liquidFlow').value.trim();
            const D = document.getElementById('distillateFlow').value.trim();
            const xn = document.getElementById('liquidComposition').value.trim();
            const xD = document.getElementById('distillateComposition').value.trim();

            const errorBox = document.getElementById('resultError');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholder');
            const resultValue = document.getElementById('resultValue');

            let errors = [];

            // Liquid Flow Rate validation
            if (Ln === "" || isNaN(Ln) || parseFloat(Ln) < 0) {
                errors.push("üëâ Liquid Flow Rate must be ‚â• 0. Negative flow isn't physically valid.");
            }

            // Distillate Flow Rate validation
            if (D === "" || isNaN(D) || parseFloat(D) <= 0) {
                errors.push("üëâ Distillate Flow Rate must be > 0. A flow of zero means no distillate is collected.");
            }

            // Liquid Composition validation
            if (xn === "" || isNaN(xn) || parseFloat(xn) < 0 || parseFloat(xn) > 1) {
                errors.push("üëâ Liquid Composition (x‚Çô) must be between 0 and 1 as it represents a mole fraction.");
            }

            // Distillate Composition validation
            if (xD === "" || isNaN(xD) || parseFloat(xD) < 0 || parseFloat(xD) > 1) {
                errors.push("üëâ Distillate Composition (x<sub>D</sub>) must be between 0 and 1 as it represents a mole fraction.");
            }

            // Check if xD > xn for effective separation
            if (!isNaN(parseFloat(xn)) && !isNaN(parseFloat(xD)) && parseFloat(xD) <= parseFloat(xn)) {
                errors.push("üëâ Distillate Composition must be greater than Liquid Composition to ensure actual separation.");
            }

            if (errors.length > 0) {
                errorMessage.innerHTML = errors.join("<br>");
                errorBox.classList.remove("hidden");
                placeholder.classList.add("hidden");
                resultValue.classList.add("hidden");
                return;
            } else {
                errorBox.classList.add("hidden");
            }

            // Perform calculation
            const Ln_val = parseFloat(Ln);
            const D_val = parseFloat(D);
            const xn_val = parseFloat(xn);
            const xD_val = parseFloat(xD);

            const denominator = Ln_val + D_val;
            const y_n1 = (Ln_val / denominator) * xn_val + (D_val / denominator) * xD_val;

            if (!isFinite(y_n1) || isNaN(y_n1)) {
                errorMessage.innerHTML = "üëâ Calculation error: check inputs.";
                errorBox.classList.remove("hidden");
                resultValue.classList.add("hidden");
                return;
            }

            document.getElementById('rateValue').textContent = y_n1.toFixed(4);

            // Calculate reflux ratio and provide feedback
            // Calculate reflux ratio and provide feedback
            const refluxRatio = Ln_val / D_val;
            document.getElementById('refluxValue').textContent = refluxRatio.toFixed(3) + " (L‚Çô/D)";

            const meterFill = document.getElementById('meterFill');
            let meterWidth, meterColor, feedback;

            // categories aligned with the table:
            // R <1, 1‚â§R<2, 2‚â§R<3, 3‚â§R<5, R‚â•5
            if (refluxRatio < 1) {
                meterWidth = '12%';
                meterColor = '#e74c3c';
                feedback = '‚ö†Ô∏è Low reflux ratio: Separation may be insufficient (Low Purity).';
            } else if (refluxRatio < 2) {
                meterWidth = '32%';
                meterColor = '#f39c12';
                feedback = '‚ö†Ô∏è Moderate reflux ratio: Acceptable for some operations (Moderate Purity).';
            } else if (refluxRatio < 3) {
                meterWidth = '52%';
                meterColor = '#f1c40f';
                feedback = '‚ÑπÔ∏è Good reflux ratio: Balanced operation with reasonable energy use (Good Purity).';
            } else if (refluxRatio < 5) {
                meterWidth = '78%';
                meterColor = '#27ae60';
                feedback = '‚úÖ High reflux ratio: High separation efficiency (High Purity).';
            } else {
                meterWidth = '100%';
                meterColor = '#2ecc71';
                feedback = 'üåü Very High reflux ratio: Maximum purity achieved but very energy intensive (Very High).';
            }

            meterFill.style.width = meterWidth;
            meterFill.style.backgroundColor = meterColor;
            document.getElementById('feedbackContent').textContent = feedback;


            placeholder.classList.add('hidden');
            resultValue.classList.remove('hidden');
        }

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);

            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>

</html>
{% endblock %}

{% comment %}
/*
=====================================================
Validation Rules (QEHS + Fire Safety)
-----------------------------------------------------
- Ln ‚â• 0 and ‚â§ 1e6 mol/h
- D > 0 and ‚â§ 1e6 mol/h
- 0 ‚â§ xn ‚â§ 1 (mole fraction, 3 decimals)
- 0 ‚â§ xD ‚â§ 1 (mole fraction, 3 decimals)
- xD > xn (for separation to occur)
- Reflux Ratio (R = Ln / D):
R < 1 ‚Üí Low separation 1‚Äì3 ‚Üí Normal operation 3‚Äì10 ‚Üí High purity, energy intensive>10 ‚Üí Impractical, review inputs
    - Output vapor composition (y‚Çô‚Çä‚ÇÅ) must be 0‚Äì1
    =====================================================
    */ {% endcomment %}