{% extends 'base.html' %}
{% block title %}Continuous Distillation (Stripping Section) Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Continuous Distillation (Stripping Section) Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        /* Input rows for side-by-side fields */
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
        /* Ratio Table Styling */
.ratio-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 14px;
    text-align: center;
}
.ratio-table th {
    background: #1560bd;
    color: #fff;
    padding: 8px;
}
.ratio-table td {
    border: 1px solid #ddd;
    padding: 6px;
}
.ratio-table .low { color: #e74c3c; font-weight: bold; }
.ratio-table .moderate { color: #f39c12; font-weight: bold; }
.ratio-table .high { color: #27ae60; font-weight: bold; }
.ratio-table .very-high { color: #2ecc71; font-weight: bold; }

/* Safety Meter */
.safety-meter {
    width: 100%;
    height: 18px;
    background: #ecf0f1;
    border-radius: 8px;
    margin: 15px 0 5px;
    overflow: hidden;
}
.meter-fill {
    height: 100%;
    width: 0;
    border-radius: 8px;
    transition: width 0.6s ease, background-color 0.6s ease;
}
.meter-labels {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #555;
    margin-top: 3px;
}
@media (max-width: 370px) {
  .ratio-table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
  }
  
  .ratio-table th,
  .ratio-table td {
    min-width: 100px;
  }
  
  .rate-value { 
    font-size: 22px; 
  }
}
       
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Continuous Distillation (Stripping Section) Calculator</h1>
            <p>Calculate vapor composition in the stripping section of a distillation column</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="input-row">
                    <div class="form-group">
                        <label for="liquidFlow">Liquid Flow Rate (L<sub>m</sub>) [mol/h]</label>
                        <input type="number" id="liquidFlow" class="form-input" min="0.0001" step="any" placeholder="e.g., 1000">
                    </div>
                    <div class="form-group">
                        <label for="bottomsFlow">Bottoms Flow Rate (B) [mol/h]</label>
                        <input type="number" id="bottomsFlow" class="form-input" min="0.0001" step="any" placeholder="e.g., 200">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="form-group">
                        <label for="liquidComposition">Liquid Composition (x<sub>m</sub>) [mole fraction]</label>
                        <input type="number" id="liquidComposition" class="form-input" min="0" max="1" step="0.001" placeholder="e.g., 0.5">
                    </div>
                    <div class="form-group">
                        <label for="bottomsComposition">Bottoms Composition (x<sub>B</sub>) [mole fraction]</label>
                        <input type="number" id="bottomsComposition" class="form-input" min="0" max="1" step="0.001" placeholder="e.g., 0.1">
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateStripping()">Calculate Vapor Composition</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Distillation illustration">
                    <p>This tool will calculate the <strong>Vapor Composition</strong> in the stripping section. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Vapor Composition</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.0000</div>
                       
                        <div class="rate-label" style="color:#2980b9; font-size:20px; font-weight:bold;">Mole Fraction (yₘ₊₁)</div>
                    </div>
                     <div id="ratioDisplay" style="margin-top:10px; font-size:16px; color:#1560bd;"></div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low</span><span>Moderate</span><span>Optimal</span><span>High</span><span>Very High</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Reboiler Ratio Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <!-- About -->
            <div class="note-card">
                <h3>📘 About This Calculator</h3>
                <p>
                    The <strong>Continuous Distillation (Stripping Section) Calculator</strong> determines the vapor composition 
                    in the lower section of a distillation column. This calculation is essential for controlling bottoms product 
                    purity and optimizing reboiler operation in chemical processes.
                </p>
            </div>

            <!-- Parameters Used -->
            <div class="note-card">
                <h3>⚙ Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>L<sub>m</sub> (Liquid Flow Rate):</strong> Flow rate of liquid entering the stripping section [mol/h]. Must be > bottoms flow rate.</li>
                    <li><strong>B (Bottoms Flow Rate):</strong> Product flow rate from the column bottom [mol/h].</li>
                    <li><strong>x<sub>m</sub> (Liquid Composition):</strong> Mole fraction of more volatile component in liquid (0-1).</li>
                    <li><strong>x<sub>B</sub> (Bottoms Composition):</strong> Target purity of the bottoms product (0-1).</li>
                </ul>
            </div>

            <!-- Input Validation Rules -->
            <div class="note-card">
                <h3>✅ Input Validation Rules</h3>
                <ul class="note-list">
                    <li>Liquid Flow Rate (L<sub>m</sub>) must be > 0 and greater than Bottoms Flow Rate.</li>
                    <li>Bottoms Flow Rate (B) must be > 0.</li>
                    <li>Liquid Composition (x<sub>m</sub>) must be between 0 and 1.</li>
                    <li>Bottoms Composition (x<sub>B</sub>) must be between 0 and 1.</li>
                    <li>Bottoms composition must be less than liquid composition for separation to occur.</li>
                    <li>Decimals up to 3 places allowed for accuracy.</li>
                </ul>
            </div>

            <!-- Output Validations -->
            <div class="note-card">
    <h3>✅ Output Validations</h3>
    <p>The <strong>Reboiler Ratio (V/B)</strong> determines vapor generation efficiency. Reference guide:</p>
    <table class="ratio-table">
        <thead>
            <tr>
                <th>Reboiler Ratio (V/B)</th>
                <th>Category</th>
                <th>Assessment</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>R &lt; 0.5</td>
                <td class="low">Low</td>
                <td>Inefficient stripping, low purity</td>
            </tr>
            <tr>
                <td>0.5 ≤ R &lt; 2</td>
                <td class="moderate">Moderate</td>
                <td>Typical operation range</td>
            </tr>
            <tr>
                <td>2 ≤ R &lt; 5</td>
                <td class="high">High</td>
                <td>Good separation, higher energy use</td>
            </tr>
            <tr>
                <td>R ≥ 5</td>
                <td class="very-high">Very High</td>
                <td>Maximum purity, very energy intensive</td>
            </tr>
        </tbody>
    </table>
</div>


            <!-- Standards -->
            <div class="note-card">
                <h3>📏 Standards</h3>
                <p>
                    This calculator is based on standard distillation principles and aligns with industry practices 
                    including <strong>API 12J</strong> (Specification for Oil and Gas Separators), 
                    <strong>ASTM D2892</strong> (Standard Test Method for Distillation of Crude Petroleum), 
                    and <strong>ISO 3405</strong> (Petroleum products - Determination of distillation characteristics).
                </p>
            </div>

            <!-- Conclusion -->
            <div class="note-card">
                <h3>📝 Conclusion</h3>
                <p>
                    The stripping section equation is fundamental for chemical engineers to design and operate 
                    the lower portion of distillation columns effectively. Proper implementation ensures optimal 
                    separation of heavy components while maintaining energy efficiency and product quality standards.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateStripping() {
    const Lm = document.getElementById('liquidFlow').value.trim();
    const B = document.getElementById('bottomsFlow').value.trim();
    const xm = document.getElementById('liquidComposition').value.trim();
    const xB = document.getElementById('bottomsComposition').value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];

    // Basic Validations
    if (Lm === "" || isNaN(Lm) || parseFloat(Lm) <= 0) {
        errors.push("👉 Liquid Flow Rate (Lₘ) must be a positive number.");
    }
    if (B === "" || isNaN(B) || parseFloat(B) <= 0) {
        errors.push("👉 Bottoms Flow Rate (B) must be a positive number.");
    }
    if (xm === "" || isNaN(xm) || parseFloat(xm) < 0 || parseFloat(xm) > 1) {
        errors.push("👉 Liquid Composition (xₘ) must be between 0 and 1.");
    }
    if (xB === "" || isNaN(xB) || parseFloat(xB) < 0 || parseFloat(xB) > 1) {
        errors.push("👉 Bottoms Composition (xB) must be between 0 and 1.");
    }

    if (errors.length === 0) {
        const Lm_val = parseFloat(Lm);
        const B_val = parseFloat(B);
        const xm_val = parseFloat(xm);
        const xB_val = parseFloat(xB);

        if (Lm_val <= B_val) {
            errors.push("👉 Liquid Flow Rate (Lₘ) must be greater than Bottoms Flow Rate (B).");
        }
        if (xB_val >= xm_val) {
            errors.push("👉 Bottoms Composition (xB) must be less than Liquid Composition (xₘ) for separation to occur.");
        }
    }

    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // ✅ Perform Calculation
    const Lm_val = parseFloat(Lm);
    const B_val = parseFloat(B);
    const xm_val = parseFloat(xm);
    const xB_val = parseFloat(xB);

    const denominator = Lm_val - B_val;
    const y_m1 = (Lm_val / denominator) * xm_val - (B_val / denominator) * xB_val;

    const reboilerRatio = denominator / B_val; // V/B

    if (!isFinite(y_m1) || isNaN(y_m1)) {
        errorMessage.innerHTML = "👉 Calculation error: check inputs.";
        errorBox.classList.remove("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // Show vapor composition
    document.getElementById('rateValue').textContent = y_m1.toFixed(4);

    // ✅ Show reboiler ratio explicitly
    const ratioDisplay = document.getElementById('ratioDisplay');
    ratioDisplay.innerHTML = `<b>Reboiler Ratio (V/B) = ${reboilerRatio.toFixed(2)}</b>`;

    // Meter & Feedback
    const meterFill = document.getElementById('meterFill');
    let meterWidth, meterColor, feedback;

    if (reboilerRatio < 0.5) {
        meterWidth = '20%'; meterColor = '#e74c3c';
        feedback = '⚠️ Low reboiler ratio: Stripping may be inefficient (Low Purity).';
    } else if (reboilerRatio < 2) {
        meterWidth = '60%'; meterColor = '#f39c12';
        feedback = 'ℹ️ Moderate reboiler ratio: Typical operation range (Moderate Purity).';
    } else if (reboilerRatio < 5) {
        meterWidth = '85%'; meterColor = '#27ae60';
        feedback = '✅ High reboiler ratio: Good separation with higher energy use (High Purity).';
    } else {
        meterWidth = '100%'; meterColor = '#2ecc71';
        feedback = '🌟 Very High reboiler ratio: Maximum purity but very energy intensive (Very High).';
    }

    meterFill.style.width = meterWidth;
    meterFill.style.backgroundColor = meterColor;
    document.getElementById('feedbackContent').textContent = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}