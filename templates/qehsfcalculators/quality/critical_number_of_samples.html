{% extends 'base.html' %}
{% block title %}Critical Number of Samples Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Critical Number of Samples Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .formula-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 6px solid #0d47a1;
        }
        
        .formula-card code {
            display: inline-block;
            background: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #0d47a1;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }

        .btn-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040);
            color: #ffffff;
            border: 2px solid #1560bd;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd;
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
     <div class="btn-container">
        <a href="{% url 'qualitycategory_calculators' %}" class="back-btn">Back To Quality Calculators</a>
    </div>

   <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Critical Number of Samples Calculator</h1>
            <p>Determines the minimum number of samples required to ensure accuracy and confidence in measurement results</p>
        </div>

        <div class="calc-content">
            <!-- Calculator Input Card -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="zScore">Z-Score (Confidence Level)</label>
                    <input type="number" id="zScore" class="form-input" step="0.01" placeholder="Enter Z-Score (e.g., 1.96)">
                </div>

                <div class="form-group">
                    <label for="cva">Analytical Coefficient of Variation - CVA (%)</label>
                    <input type="number" id="cva" class="form-input" step="0.01" placeholder="Enter CVA (%)">
                </div>

                <div class="form-group">
                    <label for="cvi">Within-Subject Biological Variation - CVI (%)</label>
                    <input type="number" id="cvi" class="form-input" step="0.01" placeholder="Enter CVI (%)">
                </div>

                <div class="form-group">
                    <label for="d">Acceptable Deviation - D (%)</label>
                    <input type="number" id="d" class="form-input" step="0.01" placeholder="Enter Deviation (%)">
                </div>

                <button class="calculate-btn" onclick="calculateSamples()">Calculate Samples</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="{% static 'images/resultimage.png' %}" alt="Sample calculation illustration">
                    <p>This tool calculates the <strong>minimum number of samples</strong> required. Enter your parameters to see results.</p>
                </div>

                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>

                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Required Number of Samples</h2>
                    </div>
                    <div class="rate-value" id="samplesValue">0.00</div>
                    <div class="rate-label"><strong>samples</strong></div>
                    
                    <div class="result-feedback">
                        <div class="feedback-title">Assessment</div>
                        <div class="feedback-content" id="samplesFeedback"></div>
                    </div>
                    
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
            <div class="note-card">
                <h3>🔎 About This Calculator</h3>
                <p>
                    The <strong>Critical Number of Samples Calculator</strong> determines the minimum number of samples required to ensure a specified level of accuracy and confidence in measurement results. It is especially useful for laboratory quality control, clinical diagnostics, and statistical sampling.
                </p> 
            </div>
           <div class="note-card">
    <h3>⚙️ Parameters Used</h3>
    <ul class="note-list">
        <li><strong>Z-Score (Standard Score):</strong> Represents the statistical confidence level (e.g., 1.96 = 95% confidence, 2.58 = 99% confidence).</li>
        <li><strong>Analytical Coefficient of Variation (CVA %):</strong> Measures the precision of the analytical method or instrument; higher values indicate lower precision.</li>
        <li><strong>Within-Subject Biological Variation (CVI %):</strong> Reflects natural variability in measurements for the same subject over time.</li>
        <li><strong>Acceptable Deviation (D %):</strong> The maximum allowable error percentage from the true value, usually maintained within 5–10% for compliance.</li>
    </ul>
</div>

           <div class="note-card">
    <h3>📌 Input Validation Rules</h3>
    <ul class="note-list">
        <li><strong>Z-Score (Confidence Level):</strong> Determines the statistical confidence in your measurement.
            <ul>
                <li>Required, must be > 0 and ≤ 5.</li>
                <li>Typical values: 1.64 → 90%, 1.96 → 95%, 2.58 → 99%.</li>
                <li>Values ≤ 0 are invalid; values > 5 trigger a warning (unrealistic confidence).</li>
                <li>High Z-scores (>5) are rarely used in quality/safety statistics.</li>
            </ul>
        </li>
        <li><strong>Analytical Coefficient of Variation (CVA %):</strong> Measures test method precision.
            <ul>
                <li>Required, must be > 0 and ≤ 30.</li>
                <li>High CVA indicates poor instrument/method stability.</li>
                <li>Values > 30% trigger a warning (check method precision).</li>
            </ul>
        </li>
        <li><strong>Within-Subject Biological Variation (CVI %):</strong> Reflects natural fluctuation within an individual.
            <ul>
                <li>Required, must be > 0 and ≤ 50.</li>
                <li>Values > 50% are rare and trigger a warning (check biological variation data).</li>
            </ul>
        </li>
        <li><strong>Acceptable Deviation (D %):</strong> Maximum allowable error percentage from the true value.
            <ul>
                <li>Required, must be > 0 and ≤ 20.</li>
                <li>Deviation > 20% triggers a warning (beyond typical QA limits).</li>
            </ul>
        </li>
    </ul>
</div>





         <div class="note-card">
    <h3>📊 Output Validations</h3>
    <ul class="note-list">
        <li><strong>Number of Samples ≤ 2:</strong> ✅ Small sample size → low variability, suitable for routine tests.</li>
        <li><strong>Number of Samples 3 – 5:</strong> ⚠️ Moderate sample size required due to moderate variability or stricter accuracy.</li>
        <li><strong>Number of Samples 6 – 30:</strong> 📊 Large sample size needed → reflects significant variability or high confidence needs.</li>
        <li><strong>Number of Samples > 30:</strong> 🚨 Extremely high sample size. Review inputs — may be impractical in real-world audits.</li>
    </ul>
</div>



            <div class="note-card">
    <h3>📐 Governing Principle</h3>
    <p>
        A <strong>Critical Number of Samples Calculator</strong> is not tied to a single standard. It is a concept applied across different fields, including:
    </p>
    <ul class="note-list">
        <li>Statistical quality control – using standards like <strong>ISO 2859</strong> to determine sample sizes for inspection and quality assessment.</li>
        <li>Laboratory medicine – for example, the <strong>Westgard.com</strong> calculator to ensure measurement accuracy and reliability.</li>
    </ul>
    <p>
        The specific standard or methodology depends on the application and the desired confidence level or quality requirement.
    </p>
</div>

            <div class="note-card">
                <h3>💡 Conclusion</h3>
                <p>This calculation is essential for ensuring statistical reliability in measurements across various fields. By determining the appropriate sample size, professionals can achieve the desired confidence level while accounting for both analytical and biological variations, leading to more accurate and trustworthy results.</p>
            </div>
        </div>
    </div>

    <script>
       function calculateSamples() {
    const zScore = document.getElementById("zScore").value.trim();
    const cva = document.getElementById("cva").value.trim();
    const cvi = document.getElementById("cvi").value.trim();
    const d = document.getElementById("d").value.trim();

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');
    const outputValue = document.getElementById('samplesValue');
    const feedbackBox = document.getElementById('samplesFeedback'); 

    let errors = [];
    let warnings = [];

    // ✅ Validate Z-Score
    if (zScore === "" || isNaN(zScore)) {
        errors.push("👉 Z-Score is required and must be numeric.");
    } else if (parseFloat(zScore) <= 0) {
        errors.push("👉 Z-Score must be greater than 0.");
    } else if (parseFloat(zScore) > 5) {
        warnings.push("⚠️ Z-Score unusually high (>5). Typical range: 1.64–2.58.");
    }

    // ✅ Validate CVA
    if (cva === "" || isNaN(cva)) {
        errors.push("👉 CVA is required and must be numeric.");
    } else if (parseFloat(cva) <= 0) {
        errors.push("👉 CVA must be greater than 0.");
    } else if (parseFloat(cva) > 30) {
        warnings.push("⚠️ CVA above 30% is unrealistic. Check method precision.");
    }

    // ✅ Validate CVI
    if (cvi === "" || isNaN(cvi)) {
        errors.push("👉 CVI is required and must be numeric.");
    } else if (parseFloat(cvi) <= 0) {
        errors.push("👉 CVI must be greater than 0.");
    } else if (parseFloat(cvi) > 50) {
        warnings.push("⚠️ CVI above 50% is rare. Check biological variation data.");
    }

    // ✅ Validate Acceptable Deviation
    if (d === "" || isNaN(d)) {
        errors.push("👉 Acceptable Deviation (D) is required and must be numeric.");
    } else if (parseFloat(d) <= 0) {
        errors.push("👉 Acceptable Deviation must be greater than 0.");
    } else if (parseFloat(d) > 20) {
        warnings.push("⚠️ Deviation >20% is beyond typical QA limits. Verify inputs.");
    }

    // ✅ Show errors if any
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // Convert to numbers
    const zNum = parseFloat(zScore);
    const cvaNum = parseFloat(cva);
    const cviNum = parseFloat(cvi);
    const dNum = parseFloat(d);

    // ✅ Prevent division by zero
    if (dNum === 0) {
        errorMessage.innerHTML = "❌ Division by zero error: Acceptable Deviation cannot be 0.";
        errorBox.classList.remove("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // ✅ Compute number of samples
    let n = Math.pow((zNum * Math.sqrt(Math.pow(cvaNum/100, 2) + Math.pow(cviNum/100, 2))) / (dNum/100), 2);

    if (n < 1) n = 1; // Minimum 1 sample required
    outputValue.textContent = n.toFixed(2);

    // ✅ Interpretation
    let feedback = "";
    if (n <= 2) {
        feedback = "✅ Small sample size → low variability, suitable for routine tests.";
    } else if (n > 2 && n <= 5) {
        feedback = "⚠️ Moderate sample size required due to moderate variability or stricter accuracy.";
    } else if (n > 5 && n <= 30) {
        feedback = "📊 Large sample size needed → reflects significant variability or high confidence needs.";
    } else {
        feedback = "🚨 Extremely high sample size. Review inputs — may be impractical in real-world audits.";
    }

    if (warnings.length > 0) {
        feedback += "<br><br>" + warnings.join("<br>");
    }

    feedbackBox.innerHTML = feedback;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}

    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}
<!--

============Input Validation Rules========================
Z-Score (Confidence Level)
Acceptable Range: > 0 and ≤ 5

Typical values:

1.64 → 90%

1.96 → 95%

2.58 → 99%

Decimals: Up to 2 decimals (step = 0.01)

Validation Logic: Reject ≤ 0, warn if > 5 (unrealistic confidence level).

Reason (Compliance): Confidence levels above 99.9% are rarely used in quality/safety statistics.

Required field
-------------------------------------------------------
Analytical Coefficient of Variation - CVA (%)
Acceptable Range: 0 < CVA ≤ 30% (typical lab precision is < 10%, rarely exceeds 20%).

Decimals: Up to 2 decimals.

Validation Logic: Reject ≤ 0, warn if > 30.

Reason (Compliance): ISO 15189 and CLSI standards state high CVA suggests instrument/method instability → must be flagged.

Required field
------------------------------------------------
Within-Subject Biological Variation - CVI (%)
Acceptable Range: 0 < CVI ≤ 50% (most biological variations are between 5–30%).

Decimals: Up to 2 decimals.

Validation Logic: Reject ≤ 0, warn if > 50.

Reason (Compliance): Extremely high biological variation may imply wrong test population or poor quality study design.
Required field
--------------------------------------
Acceptable Deviation - D (%)
Acceptable Range: 0 < D ≤ 20% (per CLSI guidelines, most lab tests accept 5–10%; critical safety processes may only allow 2–5%).

Decimals: Up to 2 decimals.

Validation Logic: Reject ≤ 0, warn if > 20.

Reason (Compliance): Allowing >20% deviation can invalidate quality/safety audits.
Required field

====================Output Validation & Interpretation=====================
Formula: n = [Z × √(CVA² + CVI²) / D]²
n must always be ≥ 1. If formula returns < 1, force it to 1 (minimum 1 sample required).

If n > 500, warn user: "Sample size is extremely high — review inputs for feasibility."

Round to 2 decimals for reporting, but keep raw value internally for audit traceability.

Compliance Justification: Large n indicates very strict accuracy requirement or excessive variability — should be flagged in audit reports (ISO 9001 & ISO 45001 require justification of extreme data requirements).
=====================Edge Cases============================
Division by zero (D = 0)
Division by zero → If D = 0, show error.

Negative inputs → Block (invalid in statistics).

Extremely large Z (>5) → Warning, but allow calculation.

CVA = 0 & CVI = 0 → Warn: “Zero variability → unrealistic in real-world measurements.”

n < 1 → Force minimum sample = 1.

n > 500 → Warn: “Sample size impractical for QEHS compliance — review input parameters.”



-->