{% extends 'base.html' %}
{% block title %}Rayleigh Differential Distillation Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rayleigh Differential Distillation Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding:0 20px;
            border-radius: 12px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        /* Input rows for side-by-side fields */
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        @media (min-width: 480px) {
            .input-row {
                flex-direction: row;
            }
        }
        
        .input-row .form-group {
            flex: 1;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: auto;
            text-align: center;
            margin-top: 20px;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .rate-display {
            display: flex;
            gap: 6px;
            align-items: center;  
            justify-content: center; 
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
            font-size: 20px;
            font-weight: bold;
        }

        /* Meter */
        .safety-meter {
            width: 100%; 
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 1s ease-in-out;
            border-radius: 6px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .good { 
            color: #2e7d32; 
            font-weight: 600; 
        }
        
        .average { 
            color: #f9a825; 
            font-weight: 600; 
        }
        
        .bad { 
            color: #c62828; 
            font-weight: 600; 
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }
       
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'safetycategory_calculators' %}" class="back-btn">Back To Safety Calculators</a>
    </div>
    
    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Rayleigh Differential Distillation Calculator</h1>
            <p>Calculate theoretical stages needed for batch distillation processes</p>
        </div>

        <div class="calc-content">
            <!-- Calculator -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="input-row">
                    <div class="form-group">
                        <label for="initialMass">Initial Mass (W₀) [kg]</label>
                        <input type="number" id="initialMass" class="form-input" min="0.0001" step="any" placeholder="e.g., 100">
                    </div>
                    <div class="form-group">
                        <label for="finalMass">Final Mass (W) [kg]</label>
                        <input type="number" id="finalMass" class="form-input" min="0.0001" step="any" placeholder="e.g., 50">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="form-group">
                        <label for="initialComposition">Initial Composition (x₀) [mole fraction]</label>
                        <input type="number" id="initialComposition" class="form-input" min="0" max="1" step="0.001" value="0.5" placeholder="e.g., 0.5">
                    </div>
                    <div class="form-group">
                        <label for="finalComposition">Final Composition (x) [mole fraction]</label>
                        <input type="number" id="finalComposition" class="form-input" min="0" max="1" step="0.001" value="0.1" placeholder="e.g., 0.1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="vaporComposition">Vapor Composition (y) [mole fraction]</label>
                    <input type="number" id="vaporComposition" class="form-input" min="0" max="1" step="0.001" value="0.7" placeholder="e.g., 0.7">
                </div>
                
                <button class="calculate-btn" onclick="calculateDistillation()">Calculate Distillation Parameters</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="https://cdn-icons-png.flaticon.com/512/2942/2942789.png" alt="Diffusion illustration">
                    <p>This tool will calculate the <strong>Theoretical Stages</strong> needed for Rayleigh differential distillation. Enter your data to see results and insights here.</p>
                </div>
                
                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
                 
                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Theoretical Stages</h2>
                    </div>
                    <div class="rate-display">
                        <div class="rate-value" id="rateValue">0.00</div>
                        <div class="rate-label">Stages</div>
                    </div>

                    <div class="safety-meter">
                        <div class="meter-fill" id="meterFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Easy</span><span>Moderate</span><span>Difficult</span>
                    </div>

                    <div class="result-feedback">
                        <div class="feedback-title">Separation Assessment</div>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="note-section">
            <!-- About -->
            <div class="note-card">
                <h3>📘 About This Calculator</h3>
                <p>
                    The <strong>Rayleigh Differential Distillation Calculator</strong> determines the theoretical stages 
                    needed for batch distillation processes. This equation describes the relationship between 
                    remaining liquid quantity and composition during simple batch distillation, which is fundamental 
                    for understanding separation processes where components have different volatilities.
                </p>
            </div>

            <!-- Parameters Used -->
            <div class="note-card">
                <h3>⚙ Parameters Used</h3>
                <ul class="note-list">
                    <li><strong>W₀ (Initial Mass):</strong> Starting mass of the liquid mixture in kg.</li>
                    <li><strong>W (Final Mass):</strong> Remaining mass of liquid after distillation in kg.</li>
                    <li><strong>x₀ (Initial Composition):</strong> Mole fraction of the more volatile component in the initial mixture (0-1).</li>
                    <li><strong>x (Final Composition):</strong> Mole fraction of the more volatile component in the remaining liquid (0-1).</li>
                    <li><strong>y (Vapor Composition):</strong> Mole fraction of the more volatile component in the vapor phase (0-1).</li>
                </ul>
            </div>

            <!-- Input Validation Rules -->
            <div class="note-card">
  <h3>✅ Input Validation Rules</h3>
  <ul class="note-list">
    <li><strong>Initial Mass (W₀):</strong> Must be &gt; 0.0001 kg. (Zero mass → no process).</li>
    <li><strong>Final Mass (W):</strong> Must be &gt; 0.0001 kg and ≤ W₀. (Ensures material balance).</li>
    <li><strong>Initial Composition (x₀):</strong> Between 0 and 1 (fraction). (Represents valid concentration).</li>
    <li><strong>Final Composition (x):</strong> Between 0 and 1, and strictly &lt; x₀. (Distillation lowers concentration).</li>
    <li><strong>Vapor Composition (y):</strong> Between 0 and 1, and strictly &gt; x. (Vapor must be richer than liquid).</li>
    <li><strong>Decimal Precision:</strong> Accept up to 4 decimals for compositions, 2–3 for mass.</li>
    <li><strong>Cross-Field Dependency:</strong> W must ≤ W₀; x must &lt; x₀; y must &gt; x.</li>
  </ul>
</div>


            <!-- Output Validations -->
            <div class="note-card">
  <h3>✅ Output Validation Rules</h3>
  <ul class="note-list">
    <li><strong>N &lt; 5:</strong> Easy separation – efficient, minimal stages needed.</li>
    <li><strong>5 ≤ N ≤ 15:</strong> Moderate separation – multiple stages, still feasible.</li>
    <li><strong>N &gt; 15:</strong> Difficult separation – may need high energy or alternative method.</li>
    <li><strong>N &gt; 50:</strong> Unusually high – verify inputs, process may be unrealistic.</li>
    <li><strong>N Negative/NaN:</strong> Invalid – input error, division by zero, or unrealistic values.</li>
  </ul>
  <p><i>Review required for extreme/unrealistic outputs – ensures process feasibility and compliance.</i></p>
</div>


            <!-- Standards -->
            <div class="note-card">
                <h3>📏 Standards</h3>
                <p>
                    This calculator is based on the <strong>Rayleigh Distillation Equation</strong> which is fundamental 
                    for separation processes. It aligns with industry standards including 
                    <strong>ASTM D2892</strong> (Standard Test Method for Distillation of Crude Petroleum), 
                    <strong>USP &lt;467&gt;</strong> (Residual Solvents), and <strong>ICH Q3C</strong> 
                    (Impurities: Guideline for Residual Solvents).
                </p>
            </div>

            <!-- Conclusion -->
            <div class="note-card">
                <h3>📝 Conclusion</h3>
                <p>
                    The Rayleigh distillation equation is fundamental for quality engineers and chemists 
                    designing separation processes. Understanding these relationships allows for better 
                    process control, higher product quality, and more efficient use of raw materials in 
                    distillation applications across pharmaceuticals, petroleum refining, and chemical manufacturing.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Set current date for print header
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        });

        function calculateDistillation() {
    const W0 = parseFloat(document.getElementById('initialMass').value.trim());
    const W  = parseFloat(document.getElementById('finalMass').value.trim());
    const x0 = parseFloat(document.getElementById('initialComposition').value.trim());
    const x  = parseFloat(document.getElementById('finalComposition').value.trim());
    const y  = parseFloat(document.getElementById('vaporComposition').value.trim());

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');

    let errors = [];
    let warnings = [];

    // --- INPUT VALIDATIONS ---
    // Mass checks
    if (isNaN(W0) || W0 <= 0.0001) {
        errors.push("👉 Initial mass (W₀) must be greater than 0.0001 kg.");
    }
    if (isNaN(W) || W <= 0.0001) {
        errors.push("👉 Final mass (W) must be greater than 0.0001 kg.");
    } else if (W > W0) {
        errors.push("👉 Final mass (W) cannot exceed initial mass (W₀).");
    }

    // Composition checks
    if (isNaN(x0) || x0 <= 0 || x0 >= 1) {
        errors.push("👉 Initial composition (x₀) must be between 0 and 1 (exclusive).");
    }
    if (isNaN(x) || x <= 0 || x >= 1) {
        errors.push("👉 Final composition (x) must be between 0 and 1 (exclusive).");
    } else if (x >= x0) {
        errors.push("👉 Final composition (x) must be less than initial composition (x₀).");
    }
    if (isNaN(y) || y <= 0 || y >= 1) {
        errors.push("👉 Vapor composition (y) must be between 0 and 1 (exclusive).");
    } else if (y <= x) {
        errors.push("👉 Vapor composition (y) must be greater than final liquid composition (x).");
    }

    // Show errors
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // --- CALCULATION ---
    const relativeVolatility = (y / (1 - y)) / (x / (1 - x));
    const theoreticalStages = Math.log((W0 * x0) / (W * x)) / Math.log(relativeVolatility);

    if (!isFinite(theoreticalStages) || isNaN(theoreticalStages)) {
        errorMessage.innerHTML = "👉 Invalid calculation – check values for consistency.";
        errorBox.classList.remove("hidden");
        resultValue.classList.add("hidden");
        return;
    }

    // --- OUTPUT VALIDATIONS ---
    if (theoreticalStages < 0) {
        warnings.push("⚠️ Negative stages – unrealistic, check inputs.");
    } else if (theoreticalStages > 50) {
        warnings.push("⚠️ Very high stages – process may be impractical.");
    }

    document.getElementById('rateValue').textContent = theoreticalStages.toFixed(2);

    const meterFill = document.getElementById('meterFill');
    let feedback = "";

    if (theoreticalStages < 5) {
        meterFill.style.width = "20%"; meterFill.style.backgroundColor = "#2ecc71";
        feedback = "Easy separation – Efficient distillation expected.";
    } else if (theoreticalStages <= 15) {
        meterFill.style.width = "50%"; meterFill.style.backgroundColor = "#f39c12";
        feedback = "Moderate separation – Multiple stages required.";
    } else {
        meterFill.style.width = "90%"; meterFill.style.backgroundColor = "#e74c3c";
        feedback = "Difficult separation – May require many stages or alternative process.";
    }

    document.getElementById('feedbackContent').textContent = feedback + (warnings.length ? " " + warnings.join(" ") : "");

    placeholder.classList.add("hidden");
    resultValue.classList.remove("hidden");
}

        function printReport() {
            // Update date just before printing
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
            
            window.print();
        }
    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}
{% comment %} 
/*
Rayleigh Differential Distillation Formula:

Relative Volatility (α) = (y / (1 - y)) ÷ (x / (1 - x))

Theoretical Stages (N) = ln((W0 * x0) / (W * x)) ÷ ln(α)

Where:
W0 = Initial mass (kg)
W  = Final mass (kg)
x0 = Initial mole fraction (0–1)
x  = Final mole fraction (0–1, must be < x0)
y  = Vapor mole fraction (0–1, must be > x)
*/ {% endcomment %}