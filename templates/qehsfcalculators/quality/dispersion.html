{% extends 'base.html' %}
{% block title %}Dispersion Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispersion Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .formula-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 6px solid #0d47a1;
        }
        
        .formula-card code {
            display: inline-block;
            background: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #0d47a1;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }

        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }
    </style>
</head>
<body>
     <div class="btn-container">
    <a href="{% url 'qualitycategory_calculators' %}" class="back-btn">Back To Quality Calculators</a>
</div>
   <div class="calculator-container printable" id="printArea">

    <!-- Include header/footer for print -->
    {% include "includes/print_header_footer.html" %}

        
        <div class="calculator-header">
            <h1>Dispersion Calculator</h1>
            <p>Calculates the dispersion of a result based on the number of replicate assays (nA), patient samples (nS), and other statistical variables</p>
        </div>

        <div class="calc-content">
            <!-- Calculator Input Card -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="zScore">Z-Score (Confidence Level)</label>
                    <input type="number" id="zScore" class="form-input" step="0.01" placeholder="Enter Z-Score (e.g., 1.96 for 95%)">
                </div>

                <div class="form-group">
                    <label for="cva">Analytical Coefficient of Variation (CVA %)</label>
                    <input type="number" id="cva" class="form-input" step="0.01" placeholder="Enter CVA (%)">
                </div>

                <div class="form-group">
                    <label for="cvi">Within-Subject Biological Variation (CVI %)</label>
                    <input type="number" id="cvi" class="form-input" step="0.01" placeholder="Enter CVI (%)">
                </div>

                <div class="form-group">
                    <label for="nA">Number of Replicate Measurements (nA)</label>
                    <input type="number" id="nA" class="form-input" min="1" step="1" placeholder="Enter nA (e.g., 1 for single assay)">
                </div>

                <div class="form-group">
                    <label for="nS">Number of Patient Samples (nS)</label>
                    <input type="number" id="nS" class="form-input" min="1" step="1" placeholder="Enter nS (e.g., 1 for single sample)">
                </div>

                <button class="calculate-btn" onclick="calculateDispersion()">Calculate Dispersion</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="/static/images/resultimage.png" alt="Dispersion illustration">
                    <p>This tool calculates the <strong>dispersion percentage</strong>. Enter your values to see results.</p>
                </div>

                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>

                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Dispersion Result</h2>
                    </div>
                    <div class="rate-value" id="dispersionValue">0.00</div>
                    <div class="rate-label"><strong>%</strong></div>
                    
                    <div class="result-feedback">
                        <div class="feedback-title">Dispersion Interpretation</div>
                        <div class="feedback-content" id="dispersionFeedback"></div>
                    </div>
                    
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">
    <div class="note-card">
        <h3>📘 About This Calculator</h3>
        <p>
            The <strong>Dispersion Calculator</strong> estimates the variability of results based on replicate assays (nA), patient samples (nS), and statistical confidence factors. It helps quantify how precision and biological variation influence the reliability of outcomes.
        </p> 
    </div>

    <div class="note-card">
        <h3>⚙ Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Z-Score (Z):</strong> Confidence multiplier (e.g., 1.96 for 95% confidence).</li>
            <li><strong>CVA (%):</strong> Analytical coefficient of variation representing measurement precision.</li>
            <li><strong>CVI (%):</strong> Within-subject biological variation percentage.</li>
            <li><strong>nA:</strong> Replicate assays per sample.</li>
            <li><strong>nS:</strong> Number of distinct patient samples.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>✅ Input Validation Rules</h3>
        <ul class="note-list">
            <li><strong>Z-Score:</strong> Required, numeric, > 0 and ≤ 5 (max 2 decimals).</li>
            <li><strong>CVA, CVI (%):</strong> Required, numeric, 0–100 (max 2 decimals).</li>
            <li><strong>nA, nS:</strong> Required, integers 1–100.</li>
            <li><strong>Cross-checks:</strong> CVA and CVI cannot both be zero. High CVA with single replicate or high CVI with single sample triggers warnings.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>📊 Output Validations</h3>
        <ul class="note-list">
            <li><strong>&lt; 0.1%:</strong> Very low dispersion — check units.</li>
            <li><strong>&lt; 5%:</strong> Excellent — high confidence.</li>
            <li><strong>5–10%:</strong> Good — acceptable for most work.</li>
            <li><strong>10–15%:</strong> Moderate — consider improving precision or replication.</li>
            <li><strong>15–20%:</strong> High — review method design.</li>
            <li><strong>&gt; 20%:</strong> Very high — results unreliable for compliance.</li>
            <li><strong>&gt; 100%:</strong> Extreme — inputs unrealistic.</li>
        </ul>
        <p>
            The calculator provides not only the computed dispersion value but also an interpretive <strong>assessment/feedback message</strong> based on these thresholds.
        </p>
    </div>

    <div class="note-card">
        <h3>📐 Governing Principle</h3>
        <p>
            A <strong>Dispersion Calculator</strong> does not originate from a single standard but calculates statistical measures of data spread such as <em>standard deviation</em>, <em>variance</em>, <em>range</em>, and <em>coefficient of dispersion</em>. These are foundational statistical concepts developed by leading mathematicians and applied universally in quality control, laboratory sciences, and engineering.
        </p>
        <p>
            Relevant standards and guidelines often referenced for statistical analysis and laboratory quality include:
        </p>
        <ul class="note-list">
            <li><strong>ISO 3534-1:</strong> Statistics — Vocabulary and symbols.</li>
            <li><strong>ISO 5725:</strong> Accuracy (trueness and precision) of measurement methods and results.</li>
            <li><strong>ISO 17025:</strong> General requirements for the competence of testing and calibration laboratories.</li>
            <li><strong>CLSI Guidelines (EP15, EP28):</strong> Statistical approaches for laboratory method validation.</li>
            <li><strong>ISO 9001:</strong> Quality management systems framework.</li>
        </ul>
    </div>

    <div class="note-card">
        <h3>📝 Conclusion</h3>
        <p>
            This calculator integrates statistical principles with practical validation rules to ensure accurate interpretation of assay variability. By combining analytical precision (CVA), biological variation (CVI), and replicates (nA, nS), it supports evidence-based decision-making in laboratory and clinical contexts.
        </p>
    </div>
</div>


    <script>
  function calculateDispersion() {
  const zScoreRaw = document.getElementById("zScore").value.trim();
  const cvaRaw = document.getElementById("cva").value.trim();
  const cviRaw = document.getElementById("cvi").value.trim();
  const nARaw = document.getElementById("nA").value.trim();
  const nSRaw = document.getElementById("nS").value.trim();

  const errorBox = document.getElementById('resultError');
  const errorMessage = document.getElementById('errorMessage');
  const resultValue = document.getElementById('resultValue');
  const placeholder = document.getElementById('placeholder');
  const feedbackBox = document.getElementById('dispersionFeedback');

  // Reset
  errorBox.classList.add('hidden');
  resultValue.classList.add('hidden');
  errorMessage.innerHTML = "";
  feedbackBox.textContent = "";

  const errors = [];
  const warnings = [];

  const z = parseFloat(zScoreRaw);
  const cva = parseFloat(cvaRaw);
  const cvi = parseFloat(cviRaw);
  const nA = parseFloat(nARaw);
  const nS = parseFloat(nSRaw);

  // ---- Validation ----
  if (!isProvided(zScoreRaw)) errors.push("Enter Z-Score (e.g., 1.96).");
  else if (!isFinite(z) || z <= 0 || z > 5) errors.push("Z-Score must be between 0–5.");
  else if (!hasMaxDecimals(zScoreRaw, 2)) errors.push("Z-Score: max 2 decimals.");

  if (!isProvided(cvaRaw)) errors.push("Enter Analytical CV (CVA%).");
  else if (!isFinite(cva) || cva < 0 || cva > 100) errors.push("CVA must be 0–100%.");
  else if (!hasMaxDecimals(cvaRaw, 2)) errors.push("CVA: max 2 decimals.");

  if (!isProvided(cviRaw)) errors.push("Enter Biological CV (CVI%).");
  else if (!isFinite(cvi) || cvi < 0 || cvi > 100) errors.push("CVI must be 0–100%.");
  else if (!hasMaxDecimals(cviRaw, 2)) errors.push("CVI: max 2 decimals.");

  if (!isProvided(nARaw)) errors.push("Enter number of replicates (nA).");
  else if (!isFinite(nA) || !Number.isInteger(Number(nARaw)) || nA < 1 || nA > 100) {
    errors.push("nA must be an integer 1–100.");
  }

  if (!isProvided(nSRaw)) errors.push("Enter number of patient samples (nS).");
  else if (!isFinite(nS) || !Number.isInteger(Number(nSRaw)) || nS < 1 || nS > 100) {
    errors.push("nS must be an integer 1–100.");
  }

  // Cross-field checks
  if (cva === 0 && cvi === 0) errors.push("CVA and CVI cannot both be zero.");
  if (cva > 20 && nA === 1) warnings.push("High CVA (>20%) with nA=1 increases risk.");
  if (cvi > 30 && nS === 1) warnings.push("High CVI (>30%) with nS=1 lowers reliability.");

  if (errors.length > 0) {
    errorMessage.innerHTML = errors.join("<br>");
    errorBox.classList.remove('hidden');
    return;
  }

  // ---- Calculation ----
  const inner = (cva * cva) / nA + (cvi * cvi) / nS;
  const dispersion = z * Math.sqrt(inner);

  if (!isFinite(dispersion)) {
    errorMessage.innerHTML = "Invalid calculation. Check inputs.";
    errorBox.classList.remove('hidden');
    return;
  }

  // ---- Output ----
  const resultText = dispersion.toFixed(2);
  document.getElementById('dispersionValue').textContent = resultText;

  let feedback = "";
  if (dispersion < 0.1) feedback = "Very low dispersion (<0.1%) – check units.";
  else if (dispersion < 5) feedback = "Excellent dispersion (<5%) – high confidence.";
  else if (dispersion < 10) feedback = "Good dispersion (5–10%) – acceptable.";
  else if (dispersion < 15) feedback = "Moderate (10–15%) – consider improving precision.";
  else if (dispersion < 20) feedback = "High (15–20%) – review method.";
  else if (dispersion <= 100) feedback = "Very high (>20%) – unreliable for compliance.";
  else feedback = "Extreme (>100%) – inputs unrealistic.";

  const warningBlock = warnings.length ? ("⚠ " + warnings.join(" ")) : "";
  feedbackBox.textContent = [warningBlock, feedback].filter(Boolean).join(" ");

  placeholder.classList.add('hidden');
  resultValue.classList.remove('hidden');
}

// Helpers
function isProvided(v) { return v !== null && v !== undefined && v !== ""; }
function hasMaxDecimals(raw, maxDec) {
  if (/e|E/.test(raw)) return true;
  const parts = String(raw).split(".");
  return parts.length < 2 || parts[1].length <= maxDec;
}

</script>

    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}
<!--


Input validation rules (QEHS / fire-safety perspective)

Units & Meaning

Z-Score (Z) — unitless; confidence multiplier (typical: 1.645=90%, 1.96=95%, 2.576=99%).

CVA (%) — Analytical coefficient of variation in percent (method precision).

CVI (%) — Within-subject biological variation in percent.

nA — Replicate assays per sample (integer count).

nS — Number of distinct samples (integer count).

Hard bounds (block calculation if violated)

Z-Score: required, numeric, > 0 and ≤ 5.0 (values above 5 are not meaningful in routine QC and lead to extreme intervals).

CVA, CVI: required, numeric, ≥ 0 and ≤ 100 (percent).

At least one of CVA or CVI must be > 0 (both 0 → meaningless model).

nA, nS: required, numeric integers, ≥ 1 and ≤ 100 (practical upper cap to prevent unrealistic designs and abuse).

Decimals:

Z: up to 2 decimals acceptable.

CVA/CVI: up to 2 decimals (reporting precision in QC).

nA/nS: no decimals (must be integers).

Cross-field / logical checks

If nA=1 but CVA>20%, flag as warning (poor precision increases dispersion risk).

If nS=1 but CVI>30%, flag as warning (high bio-variability with single sample reduces reliability).

If CVA=0 and nA>1, warn that replicates won’t reduce analytical noise (already zero).

If CVI=0 and nS>1, warn that multiple samples won’t reduce biological noise (already zero).

Numerical safety

Reject NaN/Infinity, and any intermediate result that is not finite.

Prevent division by zero (handled by bounds on nA and nS).

2) Output validation logic & thresholds (with rationale)

You compute

Dispersion (%)=Z * √ CV A^2/ n A + CV1^2/nS
Inputs are %, output is % (consistent with common QC practice).

Result sanity checks

If result < 0.1%, show: “Mathematically valid but unusually low—recheck inputs/units.”

If result > 100%, show: “Extremely high dispersion—measurement design likely unsuitable.”

Interpretive bands (practical QC guidance)

< 5% → ✅ Excellent — very low variability.

5–10% → 📊 Good — acceptable for most routine work.

10–15% → ⚠️ Moderate — consider more replicates/samples or lower CVA.

15–20% → 🔶 High — significant variability; review method & sampling plan.

> 20% → ❌ Very high — results may be unreliable for compliance decisions.

(These bands mirror common assay precision expectations: tighter for critical measurements, looser for exploratory; they’re defensible in internal SOPs and audit narratives.)

Edge cases & how they’re handled

Z ≤ 0 or Z > 5 → Error (non-physical or impractical confidence multiplier).

CVA < 0 or > 100; CVI < 0 or > 100 → Error (percent bounds).

CVA = 0 & CVI = 0 → Error (model carries no uncertainty; not credible).

nA or nS not integers, <1, or >100 → Error (counts must be realistic whole numbers).

Extremely small result (<0.1%) → Info (check units/assumptions).

Extremely large result (>100%) → Critical warning (design or inputs unrealistic).

NaN/Infinity anywhere → Error (invalid math).

High CV with single replicate/sample → Warning (risk to reliability).

-->