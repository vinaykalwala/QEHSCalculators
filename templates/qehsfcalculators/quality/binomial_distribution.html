{% extends 'base.html' %}
{% block title %}Binomial Distribution Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binomial Distribution Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        .result-card {
            justify-content: center;
            align-items: center;
            min-height: 420px;
            text-align: center;
        }
        
        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .formula-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 6px solid #0d47a1;
        }
        
        .formula-card code {
            display: inline-block;
            background: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #0d47a1;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }

        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'qualitycategory_calculators' %}" class="back-btn">Back To Quality Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Binomial Distribution Calculator</h1>
            <p>Calculates the probability of obtaining exactly x successes in n independent trials with probability p</p>
        </div>

        <div class="calc-content">
            <!-- Calculator Input Card -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="sampleSize">Sample Size (n)</label>
                    <input type="number" id="sampleSize" class="form-input" min="1" placeholder="Enter sample size">
                </div>

                <div class="form-group">
                    <label for="itemInterest">Item of Interest (x)</label>
                    <input type="number" id="itemInterest" class="form-input" min="0" placeholder="Enter item of interest">
                </div>

                <div class="form-group">
                    <label for="probability">Probability of Success (p)</label>
                    <input type="number" id="probability" class="form-input" min="0" max="1" step="0.01" placeholder="Enter probability (0-1)">
                </div>

                <button class="calculate-btn" onclick="calculateBinomial()">Calculate Probability</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                    <img src="{% static 'images/resultimage.png' %}" alt="Probability illustration">
                    <p>This tool calculates the <strong>probability</strong> of exactly x successes in n trials. Enter your values to see results.</p>
                </div>

                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>

                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Probability Result</h2>
                    </div>
                    <div class="rate-value" id="probabilityValue">0.00</div>
                    <div class="rate-label"><strong>P(X = x)</strong></div>
                    
                    <div class="result-feedback">
                        <div class="feedback-title">Assessment</div>
                        <div class="feedback-content" id="probabilityFeedback"></div>
                    </div>
                    
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
       <div class="note-section">
    <div class="note-card">
        <h3>🔎 About This Calculator</h3>
        <p>
            The <strong>Binomial Distribution Calculator</strong> calculates the probability of obtaining exactly x successes in n independent trials, where each trial has the same probability of success p. 
            This tool is widely used for quality control, research, and risk assessment to evaluate binary outcomes in a structured and auditable manner.
        </p>
    </div>

    <div class="note-card">
            <h3>⚙️ Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Sample Size (n):</strong> The total number of independent trials or experiments.</li>
            <li><strong>Item of Interest (x):</strong> The number of successes for which probability is being calculated.</li>
            <li><strong>Probability of Success (p):</strong> The probability that a single trial results in success.</li>
        </ul>
    </div>

   <div class="note-card">
    <h3>📌 Input Validation Rules</h3>
    <ul class="note-list">
        <li><strong>Sample Size (n)</strong>
            <ul>
                <li>Type: Positive integer</li>
                <li>Minimum: n ≥ 1 (at least one trial)</li>
                <li>Maximum: Practical upper limit ~1,000,000 to avoid computational overflow</li>
                <li>Audit/Compliance Reference: In manufacturing inspection (ISO 2859, ANSI/ASQ Z1.4), typical lots rarely exceed 10,000</li>
                <li>Compliance Justification: Fractional or oversized n can distort probability calculations and lead to invalid risk conclusions</li>
            </ul>
        </li>

        <li><strong>Item of Interest (x)</strong>
            <ul>
                <li>Type: Integer</li>
                <li>Range: 0 ≤ x ≤ n</li>
                <li>Cross-field dependency: x cannot exceed n</li>
                <li>Compliance Justification: More successes than trials is mathematically impossible and invalidates the probability model</li>
            </ul>
        </li>

        <li><strong>Probability of Success (p)</strong>
            <ul>
                <li>Type: Decimal</li>
                <li>Range: 0 ≤ p ≤ 1</li>
                <li>Precision: Allow up to 4–6 decimal places (step=0.0001) to ensure accurate risk evaluation</li>
                <li>Compliance Justification: Probabilities outside [0,1] are mathematically invalid; too few decimals may mask meaningful differences in risk</li>
            </ul>
        </li>
    </ul>
     <ul class="note-list">
        <li>Probability results must always be between 0 and 1. Values outside this range indicate numerical instability and should be treated as errors.</li>
        <li>Display results with 10 decimal places for calculation accuracy, but round to 4 decimals in compliance or audit reports to maintain clarity.</li>
        <li>Floating-point underflow: Extremely small probabilities (less than 1e-15) should be capped to 0 to avoid misleading outputs.</li>
        <li>Edge case x = 0: Must return valid probability (e.g., probability of no successes).</li>
        <li>Edge case x = n: Must return valid probability (e.g., probability of all successes).</li>
        <li>Edge case p = 0 or p = 1: Must return exactly 0 or 1, respectively, without floating-point artifacts.</li>
        <li>Large sample sizes with extreme probabilities (e.g., very small p with very large n) should trigger a warning if the computation is impractical or may produce unreliable results.</li>
        <li>All outputs should be numerically stable and consistent with the binomial distribution mathematical model to ensure audit traceability and compliance with quality standards.</li>
    </ul>
</div>

<div class="note-card">
    <h3>📊 Output Validation</h3>
    <ul class="note-list">
        <li><strong>probability === 0:</strong> ❌ Impossible: The event cannot occur under these conditions.</li>
        <li><strong>probability &lt;= 0.2:</strong> ⚠️ Unlikely: Low chance of occurrence.</li>
        <li><strong>probability &lt;= 0.5:</strong> 🔶 Moderate: Medium chance of occurrence.</li>
        <li><strong>probability &lt;= 0.8:</strong> 🔷 Likely: High chance of occurrence.</li>
        <li><strong>probability &lt; 1:</strong> ✅ Very Likely: Strong probability of occurrence.</li>
        <li><strong>probability === 1:</strong> ✅ Certain: Guaranteed occurrence.</li>
    </ul>
</div>

    <div class="note-card">
        <h3>📐 Governance Principles</h3>
        <p>
            This calculator is based on the mathematical standard of the <strong>Binomial Distribution</strong>, a fundamental concept in statistics and probability used to model outcomes of binary events. 
            Its use aligns with quality management methodologies such as <strong>Six Sigma</strong>, where the binomial distribution is applied to analyze processes with pass/fail or success/failure results. 
            By standardizing probability calculations according to this distribution, engineers and analysts can perform traceable, audit-friendly evaluations of process performance.
        </p>
    </div>

    <div class="note-card">
        <h3>💡 Conclusion</h3>
        <p>
            Using this calculator, users can accurately assess the likelihood of specific outcomes in processes or experiments. 
            It supports data-driven decision-making, risk assessment, and quality improvement initiatives by providing reliable, statistically sound probability estimates. 
            Always verify inputs for accuracy, maintain correct units, and consider computational limitations for extremely large sample sizes.
        </p>
    </div>
</div>

    </div>

    <script>
        // Logarithmic Factorial to Avoid Overflow
        function logFactorial(n) {
            if (n === 0 || n === 1) return 0;
            let logSum = 0;
            for (let i = 2; i <= n; i++) {
                logSum += Math.log(i);
            }
            return logSum;
        }

        function calculateBinomial() {
    const n = parseInt(document.getElementById("sampleSize").value);
    const x = parseInt(document.getElementById("itemInterest").value);
    const p = parseFloat(document.getElementById("probability").value);

    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');
    const outputValue = document.getElementById('probabilityValue');
    const feedbackBox = document.getElementById('probabilityFeedback'); 

    let errors = [];

    // ✅ Input Validations
    if (isNaN(n) || n < 1 || !Number.isInteger(n)) {
        errors.push("❌ Sample size (n) must be a whole number ≥ 1.");
    } else if (n > 1000000) {
        errors.push("❌ Sample size is too large for meaningful calculation (limit: 1,000,000).");
    }

    if (isNaN(x) || x < 0 || !Number.isInteger(x)) {
        errors.push("❌ Item of interest (x) must be a whole number ≥ 0.");
    } else if (x > n) {
        errors.push("❌ Item of interest (x) cannot exceed sample size (n).");
    }

    if (isNaN(p) || p < 0 || p > 1) {
        errors.push("❌ Probability (p) must be between 0 and 1.");
    } else if (!/^(\d+(\.\d{1,6})?)$/.test(p.toString())) {
        errors.push("❌ Probability (p) should be given to max 6 decimals for accuracy.");
    }

    // Show errors
    if (errors.length > 0) {
        errorMessage.innerHTML = errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    } else {
        errorBox.classList.add("hidden");
    }

    // ✅ Logarithmic Calculation
    const logCombination = logFactorial(n) - (logFactorial(x) + logFactorial(n - x));
    let probability = Math.exp(logCombination) * Math.pow(p, x) * Math.pow(1 - p, n - x);

    // Handle floating-point underflow
    if (probability < 1e-15) probability = 0;

    // ✅ Feedback Based on Probability
    let feedbackMessage = "";
    let feedbackColor = "black";

    if (probability === 0) {
        feedbackMessage = "❌ Impossible: The event cannot occur under these conditions.";
        feedbackColor = "red";
    } else if (probability <= 0.2) {
        feedbackMessage = "⚠️ Unlikely: Low chance of occurrence.";
        feedbackColor = "orange";
    } else if (probability <= 0.5) {
        feedbackMessage = "🔶 Moderate: Medium chance of occurrence.";
        feedbackColor = "#ff9900";
    } else if (probability <= 0.8) {
        feedbackMessage = "🔷 Likely: High chance of occurrence.";
        feedbackColor = "blue";
    } else if (probability < 1) {
        feedbackMessage = "✅ Very Likely: Strong probability of occurrence.";
        feedbackColor = "green";
    } else if (probability === 1) {
        feedbackMessage = "✅ Certain: Guaranteed occurrence.";
        feedbackColor = "green";
    }

    // Display results
    outputValue.textContent = probability.toFixed(10);
    outputValue.style.color = feedbackColor;
    feedbackBox.innerHTML = `<span style="color: ${feedbackColor}">${feedbackMessage}</span>`;

    placeholder.classList.add('hidden');
    resultValue.classList.remove('hidden');
}

    </script>
    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}
<!--
Sample Size (n)
-----------------------------------------------------------------
Type: Positive integer

Minimum: n ≥ 1 (at least one trial)

Maximum:

For QEHS audits, practical upper limit is ~1,000,000 (to avoid computational overflow and unrealistic sample sizes).

For manufacturing inspection (ISO 2859, ANSI/ASQ Z1.4), typical lots rarely exceed 10,000.

Compliance Justification: Oversized or fractional n could distort probability models and lead to wrong risk conclusions.
-----------------------------------------------------------------------------------------------------------------------------------------
Item of Interest (x)

Type: Integer

Range: 0 ≤ x ≤ n

Cross-field dependency: x cannot exceed n.

Compliance Justification: In real audits, you cannot have more successes than trials. Violating this would invalidate the probability model.
---------------------------------------------------------------------------------------------------------------------------------------------------------
Probability of Success (p)

Type: Decimal

Range: 0 ≤ p ≤ 1

Precision: Allow up to 4–6 decimals (step=0.0001) for precision in safety risk scenarios.

Compliance Justification: Probabilities outside [0,1] are mathematically invalid; too few decimal places can round off meaningful risk differences.

================Output Validation Logic=========================

Outputs should be checked before showing to users:

Probability Range: Must be between 0 and 1. If outside, treat as error (numerical instability).

Rounding: Display with 10 decimals (as you did), but round to 4 decimals in compliance reports (ISO & OSHA require clarity, not unnecessary precision).

Interpretation Thresholds (Risk Language):

0 → “Impossible Event”

0.0001–0.2 → “Unlikely” (acceptable rare risk under ISO 31000 risk matrix)

0.2–0.5 → “Moderate likelihood”

0.5–0.8 → “Likely”

0.8–0.9999 → “Very likely / almost certain”

1 → “Certain”

Compliance Justification: Risk classification ensures results can be mapped directly into safety audits and decision-making (aligning with NFPA, ISO 31000 risk matrices).

=========================Edge Case Validations============================

Division by zero: Already avoided using logarithmic factorial.
---------------------------------------------------------------------


x = 0: Must still be valid (probability of no defects).

x = n: Also valid (all successes/failures).

p = 0 or 1: Must return exactly 0 or 1 (no “floating point artifacts”).

Large n with small/large p: Risk of underflow → must cap very small values to 0 to avoid confusing results (<1e-15 considered 0).

Unrealistic inputs (e.g., n = 1,000,000 and p = 0.0000001) → Warn user about computational impracticality.

-->