{% extends 'base.html' %}
{% block title %}Relation Between Indicated and Actual Flowrate Calculator{% endblock %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relation Between Indicated and Actual Flowrate Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/print.css' %}">
    <style>
        /* Main container */
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            border-radius: 12px;
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .calculator-header h1 {
            color: #1560bd;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .calculator-header p {
            color: #7f8c8d;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .calc-content {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            align-items: stretch;
        }
        
        @media (max-width: 900px) {
            .calc-content { 
                flex-direction: column; 
            }
        }

        /* Cards */
        .result-card {
            flex: 1;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            border: 2px solid #1560bd;
        }
        
        .calc-card {
            flex: 1;
            background: linear-gradient(135deg, #1560bd, #1560bd, #000040);
            color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            height: 420px;
            overflow-y: auto;
        }
        
        .calc-card:hover { 
            transform: translateY(-5px); 
        }
        
        .calc-card h2 {
            color: #ffff;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Inputs */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #fff;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9fbfd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }

        /* Button */
        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        
        .calculate-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .print-btn {
            display: inline-block;
            background: linear-gradient(#1560bd,#000040);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: auto !important;
        }

        .print-btn:hover {
            background: #1560bd;
        }

        /* Result Card */
        



.result-card::-webkit-scrollbar {
    width: 8px;
}

.result-card::-webkit-scrollbar-thumb {
    background: #1560bd;
    border-radius: 6px;
}

.result-card::-webkit-scrollbar-track {
    background: #f1f1f1;
}







.result-card {
    justify-content: flex-start; /* align from top */
    align-items: stretch;
    min-height: 420px;
    text-align: center;
    overflow-y: auto;       /* Enable vertical scrolling */
    max-height: 450px;      /* Set max height to control output size */
    padding: 20px;          /* keep spacing */
}

        .result-placeholder img {
            max-width: 240px;
            margin-bottom: 20px;
            opacity: 0.85;
        }
        
        .result-placeholder p {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-value { 
            width: 100%; 
        }
        
        .rate-value {
            font-size: 42px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .rate-label { 
            color: #7f8c8d; 
        }

        /* Feedback */
        .result-feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            text-align: left;
            margin-top: 20px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .feedback-content { 
            color: #34495e; 
        }

        .note-section {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0faff;
            padding: 15px;
            margin-top: 60px;
            border-radius: 12px;
        }

        .note-card {
            background: #ffffff;
            border-left: 6px solid #1976d2;
            padding: 18px 22px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
        }
        
        .note-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1976d2;
        }
        
        .note-card p, .note-card li {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .note-list {
            margin: 0;
            padding-left: 18px;
        }
        
        .formula-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 6px solid #0d47a1;
        }
        
        .formula-card code {
            display: inline-block;
            background: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #0d47a1;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .result-error {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            gap: 12px;
            margin-top: 20px;
        }
        
        .error-icon {
            font-size: 76px;
            flex-shrink: 0;
            text-align: center;
        }
        
        .error-message {
            font-size: 24px;
            line-height: 1.6;
        }

        /* Toggle helper */
        .hidden { 
            display: none; 
        }

        .btn-container {
            display: flex;
            justify-content: center; /* Horizontally center */
            margin: 30px 0;
        }

        .back-btn {
            background:linear-gradient(#1560bd,#000040); /* Dark navy background */
            color: #ffffff; /* White text */
            border: 2px solid #1560bd; /* Highlight border */
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for link */
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #1560bd; /* Highlight on hover */
            color: #ffffff;
            border-color: #000040;
            transform: scale(1.05); /* Subtle hover effect */
        }
        
        .spc-result-card {
            background:linear-gradient(135deg, #1560bd, #1560bd, #000040);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .spc-result-card h3 {
            margin: 0 0 10px;
            font-size: 16px;
            color: white;
        }
        
        .spc-result-card p {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }
        
    </style>
</head>
<body>
    <div class="btn-container">
        <a href="{% url 'qualitycategory_calculators' %}" class="back-btn">Back To Quality Calculators</a>
    </div>

    <div class="calculator-container printable" id="printArea">
        <!-- Include header/footer for print -->
        {% include "includes/print_header_footer.html" %}

        <div class="calculator-header">
            <h1>Relation Between Indicated And Actual Flowrate Calculator</h1>
            <p>Calculates the relationship between indicated and actual flowrate based on dryness fraction variations and specific volume</p>
        </div>

        <div class="calc-content">
            <!-- Calculator Input Card -->
            <div class="calc-card">
                <h2>Enter Data</h2>
                <div class="form-group">
                    <label for="calibratedDryness">Calibrated Dryness Fraction (χ<sub>calibrated</sub>)</label>
                    <input type="number" id="calibratedDryness" class="form-input" min="0" max="1" step="0.01" placeholder="Enter calibrated dryness fraction (0 to 1)">
                </div>

                <div class="form-group">
                    <label for="actualDryness">Actual Dryness Fraction (χ<sub>actual</sub>)</label>
                    <input type="number" id="actualDryness" class="form-input" min="0" max="1" step="0.01" placeholder="Enter actual dryness fraction (0 to 1)">
                </div>

                <div class="form-group">
                    <label for="specificVolume">Specific Volume of Dry Steam (v<sub>g</sub>, m³/kg)</label>
                    <input type="number" id="specificVolume" class="form-input" min="0" step="0.01" placeholder="Enter specific volume">
                </div>

                <button class="calculate-btn" onclick="calculateFlowrateError()">Calculate Flowrate Error</button>
            </div>

            <!-- Result Section -->
            <div class="result-card">
                <div class="result-placeholder" id="placeholder">
                <img src="{% static 'images/resultimage.png' %}" alt="Orifice">
                    <p>This tool calculates the <strong>relationship between indicated and actual flowrate</strong>. Enter your dryness fractions and specific volume to see results.</p>
                </div>

                <div class="result-error hidden" id="resultError">
                    <div class="error-icon">❌</div>
                    <div class="error-message" id="errorMessage"></div>
                </div>

                <div class="result-value hidden" id="resultValue">
                    <div class="calculation-type" id="calculationType" style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#1560bd;">
                        <h2>Flowrate Analysis</h2>
                    </div>
                    
                    <div id="flowrateResultsContainer"></div>
                    
                    <div class="result-feedback">
                        <div class="feedback-title">Flowrate Error Interpretation</div>
                        <div class="feedback-content" id="flowrateFeedback"></div>
                    </div>
                    
                    <div class="btn-wrapper">
                        <button class="calculate-btn print-btn" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="note-section">

    <!-- About the Calculator -->
    <div class="note-card">
        <h3>🔎 About the Calculator</h3>
        <p>
            The <strong>Flowrate Relationship Calculator</strong> determines the approximate relationship between indicated and actual flowrate when there is a deviation in steam dryness fraction. 
            It is crucial for accurate steam flow measurement, ensuring process efficiency and safe operation.
        </p>
    </div>

    <!-- Parameters Used -->
    <div class="note-card">
        <h3>❓ Parameters Used</h3>
        <ul class="note-list">
            <li><strong>Calibrated Dryness Fraction (χ<sub>calibrated</sub>):</strong> Steam quality used during flowmeter calibration.</li>
            <li><strong>Actual Dryness Fraction (χ<sub>actual</sub>):</strong> Real-time steam quality during operation.</li>
            <li><strong>Specific Volume of Dry Steam (v<sub>g</sub>):</strong> Volume per kg of dry steam at given pressure.</li>
            <li><strong>Flowrate Ratio:</strong> √(ρ<sub>cal</sub>/ρ<sub>act</sub>), ratio of indicated to actual flowrate.</li>
        </ul>
    </div>

    <!-- Input Validation Rules -->
    <div class="note-card">
        <h3>📌 Input Validation Rules</h3>
        <ul class="note-list">
            <li>Calibrated Dryness Fraction: Required, numeric, 0 < χ ≤ 1 (typical 0.7–1.0)</li>
            <li>Actual Dryness Fraction: Required, numeric, 0 < χ ≤ 1 (typical 0.7–1.0)</li>
            <li>Specific Volume: Required, numeric, > 0 (typical 0.05–2.5 m³/kg)</li>
            <li>Significant deviations (>0.3) between calibrated and actual dryness trigger warnings.</li>
        </ul>
    </div>

    <!-- Output Validations -->
    <div class="note-card">
        <h3>📊 Output Validations</h3>
        <ul class="note-list">
            <li>Flowrate Ratio = 1 → Perfect calibration, indicated and actual flowrates match.</li>
            <li>0.98 ≤ Ratio ≤ 1.02 → Excellent calibration, within 2% error margin.</li>
            <li>0.95 ≤ Ratio ≤ 1.05 → Acceptable calibration, within 5% error margin.</li>
            <li>Ratio > 1.05 → Overestimation, indicated flowrate higher than actual; risk of system overloading.</li>
            <li>Ratio < 0.95 → Underestimation, indicated flowrate lower than actual; risk of energy waste.</li>
        </ul>
    </div>

    <!-- Governing Principle -->
    <div class="note-card">
        <h3>⚖️ Governing Principle</h3>
        <p>
            Flowrate deviation is primarily influenced by steam dryness fraction. The flowrate ratio is calculated using densities derived from specific volume and dryness fractions: 
            <strong>ρ = 1 / (v<sub>g</sub>·χ)</strong> and <strong>Flowrate Ratio = √(ρ<sub>cal</sub>/ρ<sub>act</sub>)</strong>.  
            This reflects the effect of steam quality on mass flow measurement.
        </p>
    </div>

    <!-- Conclusion -->
    <div class="note-card">
        <h3>💡 Conclusion</h3>
        <p>
            This calculator ensures accurate steam flowrate assessment by evaluating dryness fraction variations. It helps maintain measurement precision, optimize system efficiency, and prevent costly errors in industrial steam applications. 
            Regular monitoring and calibration maintain safe and reliable operation.
        </p>
    </div>

</div>

    </div>
    
    <script>
    function calculateFlowrateError() {
    const calibratedDryness = document.getElementById("calibratedDryness").value.trim();
    const actualDryness = document.getElementById("actualDryness").value.trim();
    const specificVolume = document.getElementById("specificVolume").value.trim();
    
    const errorBox = document.getElementById('resultError');
    const errorMessage = document.getElementById('errorMessage');
    const placeholder = document.getElementById('placeholder');
    const resultValue = document.getElementById('resultValue');
    const flowrateResultsContainer = document.getElementById('flowrateResultsContainer');
    const feedbackBox = document.getElementById('flowrateFeedback'); 
    
    // Reset sections
    errorBox.classList.add("hidden");
    errorMessage.innerHTML = "";
    feedbackBox.innerHTML = "";
    
    let errors = [];
    let warnings = [];
    
    // ✅ Input validation - Compliance with ISO 5167-1, ASME MFC-3M
    if (calibratedDryness === "" || isNaN(calibratedDryness)) {
        errors.push("Calibrated Dryness Fraction is required and must be a valid number (0-1).");
    } else {
        const cal = parseFloat(calibratedDryness);
        if (cal <= 0 || cal > 1) {
            errors.push("Calibrated Dryness Fraction must be between 0 (exclusive) and 1 (inclusive).");
        } else if (cal < 0.7) {
            warnings.push("Warning: Calibrated Dryness Fraction < 0.7. Wet steam can damage turbines and piping (per ASME Boiler Code).");
        } else if (cal < 0.9) {
            warnings.push("Note: Calibrated Dryness Fraction < 0.9. Consider steam separator installation for improved efficiency.");
        }
    }
    
    if (actualDryness === "" || isNaN(actualDryness)) {
        errors.push("Actual Dryness Fraction is required and must be a valid number (0-1).");
    } else {
        const act = parseFloat(actualDryness);
        if (act <= 0 || act > 1) {
            errors.push("Actual Dryness Fraction must be between 0 (exclusive) and 1 (inclusive).");
        } else if (act < 0.7) {
            warnings.push("Warning: Actual Dryness Fraction < 0.7. Immediate corrective action required per OSHA 1910.119.");
        } else if (act < 0.9) {
            warnings.push("Note: Actual Dryness Fraction < 0.9. Process efficiency may be compromised.");
        }
    }
    
    if (specificVolume === "" || isNaN(specificVolume)) {
        errors.push("Specific Volume is required and must be a valid number (>0).");
    } else {
        const vol = parseFloat(specificVolume);
        if (vol <= 0) {
            errors.push("Specific Volume must be greater than 0.");
        } else if (vol > 5) {
            warnings.push("Warning: Specific Volume > 5 m³/kg. Verify pressure inputs - extremely low pressure steam.");
        } else if (vol > 2.5) {
            warnings.push("Note: Specific Volume > 2.5 m³/kg. Low pressure steam detected.");
        } else if (vol < 0.05) {
            warnings.push("Note: Specific Volume < 0.05 m³/kg. Very high pressure steam detected.");
        }
    }
    
    // Cross-validation between calibrated and actual dryness
    if (calibratedDryness && actualDryness) {
        const cal = parseFloat(calibratedDryness);
        const act = parseFloat(actualDryness);
        
        if (Math.abs(cal - act) > 0.3) {
            warnings.push("Significant difference (>0.3) between calibrated and actual dryness. Verify meter calibration.");
        }
    }
    
    // ❌ Show errors if any
    if (errors.length > 0) {
        errorMessage.innerHTML = "<strong>Validation Errors:</strong><br>" + errors.join("<br>");
        errorBox.classList.remove("hidden");
        placeholder.classList.add("hidden");
        resultValue.classList.add("hidden");
        return;
    }
    
    // ✅ Parse numbers
    const cal = parseFloat(calibratedDryness);
    const act = parseFloat(actualDryness);
    const vol = parseFloat(specificVolume);
    
    // ✅ Calculate densities (ρ = 1/(v_g·χ))
    const rhoCal = 1 / (vol * cal);
    const rhoAct = 1 / (vol * act);
    
    // ✅ Calculate Flowrate Ratio = √(ρ_cal/ρ_act)
    const ratio = Math.sqrt(rhoCal / rhoAct);
    const percentError = ((ratio - 1) * 100).toFixed(2);
    
    // ✅ Display Results
    flowrateResultsContainer.innerHTML = `
        <div class="spc-result-card">
            <h3>Calibrated Density (ρ<sub>cal</sub>)</h3>
            <p><strong>${rhoCal.toFixed(4)} kg/m³</strong></p>
        </div>
        <div class="spc-result-card">
            <h3>Actual Density (ρ<sub>act</sub>)</h3>
            <p><strong>${rhoAct.toFixed(4)} kg/m³</strong></p>
        </div>
        <div class="spc-result-card">
            <h3>Flowrate Ratio</h3>
            <p><strong>${ratio.toFixed(4)}</strong> (${percentError}% error)</p>
        </div>
    `;
    
    // ✅ Compliance Feedback Message
    let feedbackMessage = "";
    let complianceLevel = "compliant";
    
    if (ratio === 1) {
        feedbackMessage = "✅ <strong>Perfect calibration:</strong> Indicated and actual flowrates match exactly.";
        complianceLevel = "optimal";
    } else if (ratio >= 0.98 && ratio <= 1.02) {
        feedbackMessage = "✅ <strong>Excellent calibration:</strong> Within 2% error margin (industry best practice).";
        complianceLevel = "optimal";
    } else if (ratio >= 0.95 && ratio <= 1.05) {
        feedbackMessage = "⚠️ <strong>Acceptable calibration:</strong> Within 5% error margin (ASME MFC-3M acceptable range).";
        complianceLevel = "acceptable";
    } else if (ratio > 1.05) {
        feedbackMessage = "❌ <strong>Overestimation:</strong> Indicated flowrate is >5% higher than actual. Risk of system overloading and safety valve activation.";
        complianceLevel = "non-compliant";
    } else if (ratio < 0.95) {
        feedbackMessage = "❌ <strong>Underestimation:</strong> Indicated flowrate is >5% lower than actual. Risk of energy waste and process inefficiency.";
        complianceLevel = "non-compliant";
    }
    
    // Add warnings if any
    if (warnings.length > 0) {
        feedbackMessage += "<br><br><strong>Additional Notes:</strong><br>" + warnings.join("<br>");
    }
    
    // Add compliance recommendation
    if (complianceLevel === "non-compliant") {
        feedbackMessage += "<br><br>🔧 <strong>Action Required:</strong> Recalibrate flowmeter and inspect steam quality per ISO 5167-1.";
    }
    
    feedbackBox.innerHTML = feedbackMessage;
    
    // Visual indication of compliance status
    if (complianceLevel === "non-compliant") {
        feedbackBox.style.borderLeftColor = "#e74c3c";
        feedbackBox.style.background = "#ffe6e6";
    } else if (complianceLevel === "acceptable") {
        feedbackBox.style.borderLeftColor = "#f39c12";
        feedbackBox.style.background = "#fff3cd";
    } else {
        feedbackBox.style.borderLeftColor = "#27ae60";
        feedbackBox.style.background = "#e6ffe6";
    }
    
    placeholder.classList.add("hidden");
    resultValue.classList.remove("hidden");
}
    </script>

    <script src="{% static 'js/print.js' %}"></script>
</body>
</html>
{% endblock %}
<!--
*-------------------Input Analysis & Real-World Perspective--------------------*
Calibrated Dryness Fraction (χ_calibrated)

Represents steam quality during meter calibration

Real boilers: should be 0.7–1.0 (below 0.7 means wet steam, which damages turbines)

Units: dimensionless (fraction)

Actual Dryness Fraction (χ_actual)

Real-time steam dryness during operation

Should also be 0.7–1.0 in safe operations

Units: dimensionless

Specific Volume of Dry Steam (v_g)

Volume per unit mass at given pressure

Normal range: 0.1–2.5 m³/kg depending on steam pressure

Very high (>5 m³/kg) indicates unrealistic conditions

Units: m³/kg

*----------------2. Validation Rules (Industry-Based)--------------------*

Input	Range	Allowed Decimals	Notes
χ_calibrated	0 < χ ≤ 1	2–3	OSHA/ISO recommend dryness ≥0.7 for safe turbine use
χ_actual	0 < χ ≤ 1	2–3	Must be similar logic as χ_calibrated
v_g	0 < v_g ≤ 5	2–3	Practical: 0.1–2.5 m³/kg for most steam pressures
Cross-field dependency:

If χ_actual ≈ χ_calibrated, flowrate ratio must ≈1

Division by zero must be blocked (χ=0 not allowed)

*---------------------3. Edge Case Validations--------------------*
χ = 0 → Division by zero → ❌ Invalid

χ very small (<0.5) → System is unsafe (extremely wet steam)

χ_calibrated = χ_actual → Ratio must be exactly 1

v_g very high (>5) → Likely wrong input (low-pressure steam miscalculated)

Negative inputs → Must be rejected

*------------4. Output Validation & Thresholds------------------*
The formula compares density ratio:

ρ = 1/(v_g·χ)

Flowrate Ratio = √(ρ_cal/ρ_act)

Interpretation thresholds (for audits & reports):

Flowrate Ratio	Interpretation	QEHS meaning
= 1	No error	System correctly calibrated
0.95–1.05	Minor deviation	Acceptable measurement error
<0.95	Underestimation	Risk of energy loss
>1.05	Overestimation	Risk of overloading turbine/metering error
Extreme (>1.2 or <0.8)	Critical	Likely unsafe steam quality or faulty calibration
*------------------------------------------------------------------------------------------*
            <div class="note-card formula-card">
                <h3>📐 Formulas</h3>
                <p>The flowrate relationship is calculated using:</p>
                <code>ρ = 1 / (v<sub>g</sub> × χ)</code><br>
                <code>Flowrate Ratio = √(ρ<sub>calibrated</sub> / ρ<sub>actual</sub>)</code>
                <p>Where:</p>
                <ul class="note-list">
                    <li><strong>ρ</strong> = Density of steam (kg/m³)</li>
                    <li><strong>v<sub>g</sub></strong> = Specific volume of dry steam (m³/kg)</li>
                    <li><strong>χ</strong> = Dryness fraction (0 to 1)</li>
                </ul>
            </div>

-->