{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payment - {{ plan.name }}</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0d6efd;
      --primary-dark: #0b5ed7;
      --secondary: #6c757d;
      --success: #198754;
      --light-blue: #e8f4fd;
      --white: #ffffff;
      --light: #f8f9fa;
      --dark: #212529;
      --border-radius: 16px;
      --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4eaf1 100%);
      font-family: 'Poppins', sans-serif;
      color: var(--dark);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .payment-wrapper {
      width: 100%;
      max-width: 1100px;
    }

    .payment-card {
      display: flex;
      flex-direction: row;
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      height: 90vh; /* fixed height for equal sides */
    }

    .image-side {
      flex: 1;
      background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-side img {
      max-width: 85%;
      height: auto;
      transition: transform 0.3s ease;
    }

    .image-side img:hover {
      transform: scale(1.05);
    }

    .info-side {
      flex: 1;
      padding: 2.5rem;
      display: flex;
      flex-direction: column;
      overflow-y: auto; /* âœ… scroll if content is too much */
    }

    .secure-heading {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .secure-badge {
      background: var(--success);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
    }

    .upgrade-info {
      background: var(--light-blue);
      border-left: 4px solid var(--primary);
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
    }

    .plan-card {
      background: rgba(13, 110, 253, 0.05);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(13, 110, 253, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .plan-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }

    .plan-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .plan-badge {
      background: var(--primary);
      color: white;
      padding: 0.35rem 0.75rem;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .price-breakdown {
      background: rgba(255, 255, 255, 0.7);
      padding: 1.25rem;
      border-radius: 10px;
      margin-top: 1.25rem;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .breakdown-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
    }

    .breakdown-total {
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--primary);
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 2px solid rgba(0, 0, 0, 0.1);
    }

    #rzp-button {
      background: linear-gradient(to right, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--white);
      border: none;
      border-radius: 12px;
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
      width: 100%;
    }

    #rzp-button:hover {
      background: linear-gradient(to right, var(--primary-dark) 0%, var(--primary) 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(13, 110, 253, 0.4);
    }

    .btn-outline-secondary {
      border-radius: 12px;
      padding: 0.9rem;
      font-weight: 500;
    }

    .security-note {
      background: var(--light);
      border-radius: 10px;
      padding: 1rem;
      display: flex;
      align-items: center;
      margin-top: 1.5rem;
      border: 1px dashed var(--secondary);
    }

    .security-icon {
      color: var(--success);
      font-size: 1.5rem;
      margin-right: 12px;
    }

  @media (max-width: 1000px) {
  .payment-card {
    flex-direction: column; /* stack vertically */
    height: auto !important;   /* override fixed height */
    min-height: auto !important;
  }

  .info-side {
    order: 1;
    width: 100%;
    padding: 1.5rem;
  }

  .image-side {
    order: 2;
    width: 100%;
    min-height: unset !important;  /* ðŸ”‘ reset min-height */
    padding: 1.5rem 0;             /* reduce gap */
  }
}

@media (max-width: 768px) {
  .payment-card {
    flex-direction: column;
    height: auto !important;
    min-height: auto !important;
  }

  .info-side {
    order: 1;
    width: 100%;
    padding: 1rem;
  }

  .image-side {
    order: 2;
    width: 100%;
    min-height: unset !important;  /* ðŸ”‘ reset min-height */
    padding: 1rem 0;               /* tighter spacing */
  }

  .image-side img {
    max-width: 70%;                /* shrink image a bit */
  }
}


  </style>
</head>
<body>
<div class="payment-wrapper">
  <div class="payment-card">
    <!-- Image Side -->
    <div class="image-side">
      <img id="payment-image" src="{% static 'images/payment.webp' %}" alt="Secure Payment">
    </div>

    <!-- Info Side -->
    <div class="info-side">
      <div class="secure-heading">
        <div class="secure-badge">
          <i class="fas fa-lock"></i>
        </div>
        <h2 class="mb-0">Secure Payment</h2>
      </div>

      {% if is_upgrade %}
      <div class="upgrade-info">
        <h5><i class="fas fa-arrow-up me-2 text-primary"></i>Plan Upgrade</h5>
        <p class="mb-0">Upgrading from <strong>{{ existing_plan.name }}</strong> to <strong>{{ plan.name }}</strong></p>
      </div>
      {% endif %}

      <div class="plan-card">
        <div class="plan-header">
          <h4 class="fw-bold mb-0">{{ plan.get_name_display }} Plan</h4>
          <span class="plan-badge">POPULAR</span>
        </div>
        
        <div class="plan-details">
          <p class="mb-2"><i class="fas fa-tag me-2 text-primary"></i>Regular Price: â‚¹{{ plan.price }}</p>
          <p class="mb-2"><i class="fas fa-laptop me-2 text-primary"></i>Device Limit: {{ plan.device_limit }}</p>

          {% if is_upgrade %}
            <p class="mb-0"><i class="fas fa-calendar me-2 text-primary"></i>Duration: <em>(Expires on previous plan end date)</em></p>
          {% else %}
            <p class="mb-0"><i class="fas fa-calendar me-2 text-primary"></i>Duration: {{ plan.duration_days }} days</p>
          {% endif %}
        </div>

        {% if is_upgrade %}
        <div class="price-breakdown">
          <h6 class="fw-bold mb-3">Payment Breakdown</h6>
          <div class="breakdown-item">
            <span>New plan price:</span>
            <span>â‚¹{{ plan.price }}</span>
          </div>
          <div class="breakdown-item">
            <span>Credit from current plan:</span>
            <span>-â‚¹{{ credit_amount|floatformat:2 }}</span>
          </div>
          <div class="breakdown-total">
            <span>Amount to pay:</span>
            <span>â‚¹{{ upgrade_amount|floatformat:2 }}</span>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="d-grid gap-3 mb-3">
        <button id="rzp-button">
          <i class="fas fa-credit-card me-2"></i>Pay Now â‚¹{{ upgrade_amount|floatformat:2 }}
        </button>
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
      </div>

      <div class="security-note">
        <div class="security-icon">
          <i class="fas fa-shield-alt"></i>
        </div>
        <div>
          <p class="mb-0 small"><strong>Secure Payment</strong><br>
          You'll be redirected to Razorpay's secure payment page to complete your transaction.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
 var options = {
            "key": "{{ razorpay_key_id }}",
            "amount": "{{ razorpay_order.amount }}",
            "currency": "{{ razorpay_order.currency }}",
            "name": "QEHS Calculators",
            "description": "{% if is_upgrade %}Upgrade{% else %}Subscription{% endif %} for {{ plan.name }} Plan",
            "order_id": "{{ razorpay_order.id }}",
            "handler": function (response){
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ callback_url }}';

                var orderIdInput = document.createElement('input');
                orderIdInput.type = 'hidden';
                orderIdInput.name = 'razorpay_order_id';
                orderIdInput.value = response.razorpay_order_id;

                var paymentIdInput = document.createElement('input');
                paymentIdInput.type = 'hidden';
                paymentIdInput.name = 'razorpay_payment_id';
                paymentIdInput.value = response.razorpay_payment_id;

                var signatureInput = document.createElement('input');
                signatureInput.type = 'hidden';
                signatureInput.name = 'razorpay_signature';
                signatureInput.value = response.razorpay_signature;

                var csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = '{{ csrf_token }}';

                form.appendChild(orderIdInput);
                form.appendChild(paymentIdInput);
                form.appendChild(signatureInput);
                form.appendChild(csrfInput);

                document.body.appendChild(form);
                form.submit();
            },
            "prefill": {
                "name": "{{ user.get_full_name }}",
                "email": "{{ user.email }}",
                "contact": "{{ user.phone }}"
            },
            "theme": {
                "color": "#F37254"
            },
            "modal": {
                "ondismiss": function(){
                    window.location.href = '{{ error_url }}';
                }
            }
        };

        var rzp1 = new Razorpay(options);

        document.getElementById('rzp-button').onclick = function(e){
            rzp1.open();
            e.preventDefault();
        }
</script>
</body>
</html>
